<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluaci√≥n del desempe√±o</title>
  <style>
    :root{
      --bg:#050a14;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --brand:#2f7bff;
      --brand2:#4aa3ff;
      --ok:#23c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;

      /* Print colors */
      --p-border:#e6e6e6;
      --p-gray:#f7f7f7;
      --p-ink:#111;
      --p-sub:#444;
      --p-hi:#dbeafe;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 700px at 30% -10%, rgba(47,123,255,.25), transparent 60%),
                  radial-gradient(900px 650px at 70% 20%, rgba(124,58,237,.18), transparent 55%),
                  linear-gradient(180deg, #040816, #02040b 60%);
      color:var(--text);
    }
    .wrap{max-width:1180px; margin:28px auto; padding:0 18px 80px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px; border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      position:sticky; top:12px; z-index:20;
      backdrop-filter: blur(10px);
      gap:14px;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px; height:46px; border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(47,123,255,.95), rgba(74,163,255,.85));
      font-weight:800;
      letter-spacing:.5px;
      flex:0 0 auto;
    }
    .titles h1{margin:0; font-size:20px}
    .titles p{margin:2px 0 0; font-size:13px; color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:10px; height:10px; border-radius:50%;}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:10px 16px;
      font-weight:650;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s opacity;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.09)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 26px rgba(47,123,255,.25);
    }
    .btn.ghost{background:transparent}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      margin-top:16px;
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      padding:18px;
    }
    .card h2{margin:0 0 6px; font-size:18px;}
    .card p{margin:0; color:var(--muted); font-size:13px}

    .form-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .form-grid{grid-template-columns: 1fr}
      .actions{justify-content:flex-end}
      .topbar{flex-wrap:wrap}
    }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      outline:none;
      color:var(--text);
      background: rgba(0,0,0,.25);
    }
    textarea{min-height:90px; resize:vertical}
    .section-title{display:flex; align-items:center; justify-content:space-between; margin:14px 0 8px;}
    .section-title h3{margin:0; font-size:16px}
    .muted{color:var(--muted)}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:16px 0;}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .warn{color:#ffd28b}
    .ok{color:#9dffb6}
    .err{color:#ffb4b4}

    /* ====== RESALTE: campos de b√∫squeda ====== */
    .search-wrap{
      border:1px dashed rgba(74,163,255,.45);
      background: rgba(74,163,255,.06);
      border-radius: 16px;
      padding: 10px 10px 12px;
    }
    .search-badge{
      display:inline-flex; gap:8px; align-items:center;
      font-size:12px; color:rgba(234,240,255,.82);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(74,163,255,.40);
      background: rgba(0,0,0,.25);
      margin-bottom:10px;
    }
    .key-input{
      border:1px solid rgba(74,163,255,.55) !important;
      box-shadow: 0 0 0 3px rgba(74,163,255,.10);
    }
    .key-label{
      color: rgba(234,240,255,.92) !important;
      font-weight: 800;
    }

    /* ===== Reporte (para impresi√≥n) ===== */
    .print-area{margin-top:20px; display:none;}
    .report{
      background:#fff;
      color:var(--p-ink);
      border-radius:18px;
      padding:20px;
      border:1px solid #e8e8e8;
    }
    .report-head{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      margin-bottom:10px;
    }
    .report-head h1{margin:0; font-size:32px; letter-spacing:.2px;}
    .report-head .small{font-size:12px; color:var(--p-sub); text-align:right;}
    .report-sub{margin:0 0 14px; color:var(--p-sub)}
    .report-kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .kv-row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .kv{
      border:1px solid var(--p-border);
      padding:10px 12px;
      border-radius:12px;
    }
    .kv .k{font-size:11px; color:#666; margin-bottom:3px}
    .kv .v{font-size:13px; font-weight:650}

    /* Tabla SOLO opci√≥n seleccionada (reporte) */
    .rubric-wrap{margin-top:14px;}
    .rubric-title{
      margin:0 0 6px;
      font-size:15px;
      color:var(--p-ink);
      font-weight:800;
    }
    .sel-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:1px solid var(--p-border);
    }
    .sel-table th, .sel-table td{
      border:1px solid var(--p-border);
      padding:8px 8px;
      vertical-align:top;
      font-size:11px;
      word-wrap:break-word;
    }
    .sel-table th{
      background:var(--p-gray);
      text-align:left;
      font-weight:800;
      font-size:11px;
    }
    .col-item{width:32%; font-weight:700;}
    .col-score{width:10%; text-align:center; font-weight:800;}
    .col-desc{width:auto;}
    .muted-print{color:#555}

    .block{margin-top:14px;}
    .block h2{margin:0 0 6px; font-size:15px;}
    .block .box{
      border:1px solid var(--p-border);
      border-radius:12px;
      padding:10px 12px;
      min-height:48px;
      font-size:12px;
      white-space:pre-wrap;
    }

    /* ===== Modal (tabla flotante: Recuperar) ===== */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.68);
      backdrop-filter: blur(4px);
      display:none;
      z-index:9999;
      padding: 26px 16px;
    }
    .modal-card{
      max-width: 1080px;
      margin: 0 auto;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: 18px;
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modal-head h3{
      margin:0;
      font-size: 16px;
      font-weight: 900;
    }
    .modal-head .sub{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(234,240,255,.75);
    }
    .modal-actions{
      display:flex; gap:10px; align-items:center;
    }
    .tag-ok{
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(35,197,94,.35);
      background: rgba(35,197,94,.10);
      font-size: 12px;
      color: rgba(234,240,255,.9);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .modal-body{
      max-height: 72vh;
      overflow:auto;
      padding: 14px 16px 16px;
    }
    .preview-table{
      width:100%;
      border-collapse: collapse;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:hidden;
      table-layout: fixed;
      background: rgba(0,0,0,.18);
    }
    .preview-table th, .preview-table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding: 10px 10px;
      vertical-align: top;
      font-size: 13px;
      word-wrap: break-word;
    }
    .preview-table th{
      width: 26%;
      color: rgba(234,240,255,.88);
      text-align:left;
      font-weight: 850;
      background: rgba(255,255,255,.04);
    }
    .preview-divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }
    .items-table{
      width:100%;
      border-collapse: collapse;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:hidden;
      table-layout: fixed;
      background: rgba(0,0,0,.18);
    }
    .items-table th, .items-table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding: 10px 10px;
      vertical-align: top;
      font-size: 12px;
      word-wrap: break-word;
    }
    .items-table th{
      text-align:left;
      font-weight: 900;
      background: rgba(255,255,255,.04);
      color: rgba(234,240,255,.88);
    }
    .items-col-item{width: 44%;}
    .items-col-score{width: 10%; text-align:center; font-weight:900;}
    .items-col-text{width: auto;}
    .sec-row{
      background: rgba(47,123,255,.10);
      font-weight: 900;
      color: rgba(234,240,255,.92);
    }

    @media print{
      body{background:#fff}
      .wrap{max-width:none; margin:0; padding:0}
      .topbar, .no-print{display:none !important}
      .print-area{display:block !important}
      .report{border:none; border-radius:0; padding:0}
      .modal{display:none !important}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar no-print">
      <div class="brand">
        <div class="logo">ED</div>
        <div class="titles">
          <h1 id="appTitle">Formulario de evaluaci√≥n del desempe√±o</h1>
          <p>Escala 1‚Äì5 ‚Ä¢ Guardado en Google Sheets ‚Ä¢ Reporte PDF (solo opci√≥n seleccionada)</p>
        </div>
      </div>
      <div class="actions">
        <div class="pill" title="Estado">
          <span class="dot" id="stateDot" style="background: var(--ok)"></span>
          <span id="stateText">Sin cambios</span>
        </div>

        <!-- ‚úÖ NUEVO: bot√≥n Nuevo fijo -->
        <button class="btn ghost" id="btnNew" type="button">Nuevo</button>

        <!-- ‚úÖ NUEVO: bot√≥n Recuperar fijo -->
        <button class="btn" id="btnRecover" type="button">Recuperar</button>

        <button class="btn primary" id="btnSave" type="button">Guardar</button>
        <button class="btn primary" id="btnGenerate" type="button">Generar</button>
        <button class="btn" id="btnPrint" type="button">Imprimir / Enviar a PDF</button>
      </div>
    </div>

    <div class="grid no-print">

      <div class="card">
        <h2>Tipo de formulario</h2>
        <p>Selecciona el tipo para mostrar/ocultar campos autom√°ticamente.</p>
        <div class="form-grid" style="grid-template-columns: 1fr;">
          <div>
            <label>Tipo</label>
            <select id="tipoFormulario">
              <option value="autoevaluacion">Formulario de autoevaluaci√≥n</option>
              <option value="desempeno" selected>Formulario de evaluaci√≥n del desempe√±o</option>
              <option value="clientes">Evaluaci√≥n de clientes</option>
            </select>
            <div class="hint">El guardado siempre va a Google Sheets (Web App de Apps Script).</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Datos del colaborador</h2>
        <p>Completa la informaci√≥n y selecciona una opci√≥n (1‚Äì5) para cada √≠tem.</p>

        <!-- ‚úÖ Resalte de campos de b√∫squeda -->
        <div class="search-wrap">
          <div class="search-badge">üîé Campos de b√∫squeda para <b>Recuperar</b>: <b>No. de personal</b>, <b>Periodo</b>, <b>Versi√≥n</b></div>

          <div class="form-grid">
            <div>
              <label class="key-label">No. de personal</label>
              <input id="noPersonal" class="key-input" placeholder="Ej. 1600" />
            </div>
            <div>
              <label>Nombre</label>
              <input id="nombre" placeholder="Ej. Carlos Paz" />
            </div>
            <div>
              <label>Posici√≥n</label>
              <input id="posicion" placeholder="Ej. Analista" />
            </div>
            <div>
              <label>Departamento</label>
              <input id="departamento" placeholder="Ej. Contabilidad" />
            </div>
            <div>
              <label class="key-label">Periodo</label>
              <input id="periodo" class="key-input" placeholder="Ej. 2025" />
            </div>
            <div>
              <label class="key-label">Versi√≥n</label>
              <input id="version" class="key-input" placeholder="Ej. 1" />
            </div>
            <div>
              <label>Fecha</label>
              <input id="fecha" type="date" />
            </div>
          </div>

          <div class="hint">
            Estado API: <span id="apiHint" class="warn">Listo para enviar</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <h3>Evaluaci√≥n (1‚Äì5)</h3>
          <span class="muted">Selecciona una opci√≥n por √≠tem</span>
        </div>

        <div id="itemsContainer"></div>

        <div id="autoComentariosBox" style="display:none; margin-top:14px;">
          <div class="divider"></div>
          <h3 style="margin:0 0 6px;">Comentarios del colaborador</h3>
          <p class="muted" style="margin:0 0 10px;">Incluye observaciones, ejemplos, mejoras o apoyo requerido.</p>
          <textarea id="comentariosColaborador" placeholder="Comentarios del colaborador..."></textarea>
        </div>
      </div>

      <div class="card" id="desempenoCamposBox" style="display:none;">
        <h2>Justificaci√≥n y comentarios</h2>
        <p>Completa los campos siguientes (seg√∫n formato).</p>

        <div style="margin-top:14px;">
          <label>Justificaci√≥n calificaciones (1 - 6)</label>
          <textarea id="justificacion" placeholder="Describe la justificaci√≥n de las calificaciones..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Comentarios del evaluador</label>
          <textarea id="comentariosEvaluador" placeholder="Comentarios del evaluador..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Fortalezas</label>
          <textarea id="fortalezas" placeholder="Fortalezas..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Oportunidades de mejora</label>
          <textarea id="oportunidades" placeholder="Oportunidades de mejora..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Proyecci√≥n y potencial de desarrollo</label>
          <textarea id="proyeccion" placeholder="Proyecci√≥n y potencial..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Comentarios del colaborador</label>
          <textarea id="comentariosColaborador2" placeholder="Comentarios del colaborador..."></textarea>
        </div>
      </div>

      <div class="card" id="clientesBox" style="display:none;">
        <h2>Evaluaci√≥n de clientes</h2>
        <p>Este modo puede reutilizar el mismo set de √≠tems o tener su propia lista.</p>
        <div class="hint">Si quieres, luego lo dejamos con su propio set de preguntas.</div>
      </div>

    </div>

    <div class="print-area" id="printArea">
      <div class="report" id="report">
        <div class="report-head">
          <div>
            <h1 id="rTitle">Evaluaci√≥n del desempe√±o</h1>
            <p class="report-sub">Generado autom√°ticamente desde el formulario.</p>
          </div>
          <div class="small">
            <div><b>Generado:</b> <span id="rGenerated"></span></div>
          </div>
        </div>

        <div class="report-kv">
          <div class="kv-row">
            <div class="kv"><div class="k">No. de personal</div><div class="v" id="rNoPersonal">‚Äî</div></div>
            <div class="kv"><div class="k">Nombre</div><div class="v" id="rNombre">‚Äî</div></div>
          </div>
          <div class="kv-row">
            <div class="kv"><div class="k">Posici√≥n</div><div class="v" id="rPosicion">‚Äî</div></div>
            <div class="kv"><div class="k">Departamento</div><div class="v" id="rDepartamento">‚Äî</div></div>
          </div>
          <div class="kv-row" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="kv"><div class="k">Periodo</div><div class="v" id="rPeriodo">‚Äî</div></div>
            <div class="kv"><div class="k">Versi√≥n</div><div class="v" id="rVersion">‚Äî</div></div>
            <div class="kv"><div class="k">Fecha</div><div class="v" id="rFecha">‚Äî</div></div>
          </div>
        </div>

        <div id="rRubricas"></div>

        <div class="block">
          <h2>Puntaje total</h2>
          <div class="box" id="rTotal">0.00</div>
        </div>

        <div class="block" id="rComentariosBlock" style="display:none;">
          <h2>Comentarios del colaborador</h2>
          <div class="box" id="rComentarios">‚Äî</div>
        </div>

        <div class="block" id="rJustifBlock" style="display:none;">
          <h2>Justificaci√≥n y comentarios (evaluaci√≥n del desempe√±o)</h2>
          <div class="box" id="rJustifAll">‚Äî</div>
        </div>
      </div>
    </div>

  </div>

  <!-- ‚úÖ MODAL: Vista r√°pida al Recuperar (tabla flotante) -->
  <div class="modal" id="recoverModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <h3 id="mTitle">Fila recuperada (vista r√°pida)</h3>
          <div class="sub" id="mSub">‚Äî</div>
        </div>
        <div class="modal-actions">
          <div class="tag-ok" id="mTag" style="display:none;">Registro encontrado ‚úÖ</div>
          <button class="btn" id="btnCloseModal" type="button">Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <table class="preview-table" id="mPreviewTable"></table>

        <div class="preview-divider"></div>

        <table class="items-table" id="mItemsTable"></table>
      </div>
    </div>
  </div>

<script>
  /************************************************************
   * 1) URL COMPLETA DEL APPS SCRIPT (/exec)
   ************************************************************/
  const API_URL = "https://script.google.com/macros/s/AKfycbyqZkk_cEaG40py3AW0Dd5LpWdKyp6Av7inF6lxjhSCE8FHr1_-ZYtyGBHUnJ0ZWDZ2nA/exec";

  /************************************************************
   * 1.1) JSONP helper (para recuperar sin CORS)
   ************************************************************/
  function jsonpRequest(url, params){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");

      const qs = new URLSearchParams({ ...params, callback: cbName }).toString();
      script.src = url + (url.includes("?") ? "&" : "?") + qs;

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout JSONP"));
      }, 12000);

      function cleanup(){
        clearTimeout(timeout);
        if(window[cbName]) delete window[cbName];
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      script.onerror = () => {
        cleanup();
        reject(new Error("Error de red (JSONP)."));
      };

      document.body.appendChild(script);
    });
  }

  /************************************************************
   * 2) √çtems + r√∫brica 1‚Äì5 (TODOS con r√∫brica)
   ************************************************************/
  const ITEMS = [
    {
      group: "1. Metas, productividad y eficiencia",
      items: [
        { key: "A_metas", label: "A. Cumplimiento de Metas. Grado de logro",
          rubric: [
            "No alcanza la mayor√≠a de las metas; cumple menos del 70 % de lo establecido. La falta de avance afecta los resultados esperados.",
            "Logra entre 70‚Äì89 % de las metas; presenta avances parciales o inconsistentes y requiere correcciones.",
            "Alcanza el 100 % de las metas planificadas con calidad y dentro del tiempo establecido.",
            "Supera el 100 % y llega hasta un 110 % de las metas; entrega resultados adicionales o mejores de lo esperado.",
            "Supera m√°s del 110 % de las metas de forma sostenida, con impacto significativo y calidad superior."
          ]
        },
        { key: "B_eficiencia", label: "B. Eficiencia en el uso del tiempo, costos y recursos",
          rubric: [
            "Usa el tiempo y los recursos con errores graves que afectan la eficiencia.",
            "Muestra uso inestable del tiempo y los recursos; requiere evaluaciones y correcciones frecuentes.",
            "Utiliza de manera adecuada el tiempo y los recursos, cumpliendo sin desperdicios significativos.",
            "Optimiza tiempo y recursos, generando mejoras o ahorros sin afectar la calidad del trabajo.",
            "Maximiza la eficiencia de forma sostenida, mejora procesos y logra resultados superiores sin comprometer la calidad."
          ]
        },
        { key: "C_seguridad", label: "C. Cumplimiento de normas de seguridad",
          rubric: [
            "Incumple normas de seguridad y genera riesgos constantes para s√≠ y el equipo.",
            "Cumple parcialmente las normas; requiere supervisi√≥n continua para evitar incidentes.",
            "Cumple todas las normas de seguridad y act√∫a de manera segura en su trabajo diario.",
            "Se anticipa a riesgos, propone acciones preventivas y act√∫a con autonom√≠a segura.",
            "Promueve una cultura de seguridad; motiva a otros y contribuye a mantener ambientes sin incidentes."
          ]
        },
        { key: "D_prioriza", label: "D. Prioriza y organiza tareas adecuadamente",
          rubric: [
            "Desorganiza las tareas; incumple plazos y afecta resultados importantes.",
            "Organiza parcialmente; presenta inconsistencias en prioridades y manejo del tiempo.",
            "Gestiona las tareas de forma adecuada, cumple tiempos y mantiene orden en su trabajo.",
            "Organiza y prioriza con eficiencia, anticipa necesidades y mejora sus tiempos de entrega.",
            "Es referente en organizaci√≥n; redistribuye recursos, optimiza procesos y eleva la productividad del equipo."
          ]
        }
      ]
    },
    {
      group: "2. Calidad del Trabajo",
      items: [
        { key: "A_exactitud", label: "A. Exactitud y atenci√≥n al detalle",
          rubric: [
            "Comete errores frecuentes y no identifica fallos evidentes; requiere supervisi√≥n constante para evitar errores mayores.",
            "Presenta errores recurrentes por falta de revisi√≥n; la exactitud es inconsistente y requiere correcciones frecuentes.",
            "Realiza su trabajo con un nivel adecuado de precisi√≥n; puede cometer errores menores que no afectan los resultados.",
            "Mantiene una atenci√≥n al detalle constante; comete pocos errores y revisa su trabajo de forma proactiva.",
            "Su trabajo es impecable; detecta errores propios y ajenos, propone mejoras y es referente en precisi√≥n."
          ]
        },
        { key: "B_estandares", label: "B. Cumple con est√°ndares de calidad",
          rubric: [
            "Menos del 70 % de los entregables cumplen los est√°ndares; los resultados son inaceptables.",
            "Entre 70‚Äì89 % de los entregables cumplen los est√°ndares; requiere ajustes frecuentes.",
            "El 100 % de los entregables cumplen los est√°ndares establecidos.",
            "Cumplimiento entre 101‚Äì110 %; entrega con calidad superior y consistente.",
            "M√°s del 110 % de cumplimiento; supera ampliamente los est√°ndares y produce resultados sobresalientes."
          ]
        },
        { key: "C_entregas", label: "C. Entregas a tiempo, cumple con plazos establecidos",
          rubric: [
            "Menos del 70 % de las entregas se cumplen a tiempo; los retrasos afectan el √°rea.",
            "Entre 70‚Äì89 % de las entregas se realizan a tiempo; desempe√±o irregular.",
            "El 100 % de las entregas se cumplen en los plazos pactados.",
            "Cumple entre 101‚Äì110 % de los tiempos; se anticipa en algunas entregas y mantiene calidad.",
            "Entrega m√°s del 110 % a tiempo; supera plazos, mantiene calidad y mejora la eficiencia general."
          ]
        },
        { key: "D_errores", label: "D. Manejo de errores y mejoras",
          rubric: [
            "No reconoce ni corrige errores; genera reincidencias graves.",
            "Corrige parcialmente, con retrasos o bajo nivel de supervisi√≥n; la mejora no es constante.",
            "Detecta y corrige errores b√°sicos cuando se le solicita; cumple lo necesario.",
            "Se anticipa a errores y propone soluciones preventivas que mejoran el proceso.",
            "Asegura procesos libres de errores, implementa mejoras continuas y es referente en calidad."
          ]
        }
      ]
    },
    {
      group: "3. Competencias y Habilidades",
      items: [
        { key: "A_conocimientos", label: "A. Conocimientos t√©cnicos del puesto",
          rubric: [
            "Conocimientos muy por debajo de lo esperado; no domina funciones b√°sicas del puesto.",
            "Gestiona parcialmente los conocimientos requeridos y necesita apoyo frecuente.",
            "Posee el conocimiento necesario y funcional para el puesto; desempe√±o adecuado.",
            "Aplica los conocimientos de manera confiable y constante.",
            "Domina los conocimientos, aplica t√©cnicas avanzadas y es referente t√©cnico en el √°rea."
          ]
        },
        { key: "B_clientes", label: "B. Convincente respuesta t√©cnica a clientes",
          rubric: [
            "Respuestas incorrectas o inconsistentes que generan desconfianza.",
            "Respuestas incompletas o poco claras que afectan la calidad del servicio.",
            "Responde de forma adecuada y funcional, brindando confianza.",
            "Respuestas claras, espec√≠ficas y confiables de manera constante.",
            "Respuestas sobresalientes y precisas, reconocidas como referente por clientes."
          ]
        },
        { key: "C_problemas", label: "C. Resoluci√≥n de problemas",
          rubric: [
            "No logra resolver problemas; afecta procesos y resultados.",
            "Resuelve parcialmente los problemas, requiriendo supervisi√≥n frecuente.",
            "Resuelve problemas b√°sicos de manera satisfactoria y funcional.",
            "Resuelve problemas complejos con autonom√≠a y confiabilidad.",
            "Anticipa problemas y desarrolla soluciones preventivas y estrat√©gicas."
          ]
        },
        { key: "D_iniciativa", label: "D. Iniciativa y creatividad",
          rubric: [
            "No genera ideas ni propone mejoras.",
            "Propone ideas poco √∫tiles o de aplicaci√≥n limitada.",
            "Propone ideas funcionales y aplicables cuando es necesario.",
            "Genera ideas pr√°cticas que optimizan procesos y agregan valor.",
            "Propone soluciones innovadoras con impacto positivo y sostenible en el √°rea."
          ]
        }
      ]
    },
    {
      group: "4. Actitud y Valores",
      items: [
        { key: "A_responsabilidad", label: "A. Responsabilidad y compromiso",
          rubric: [
            "Incumple compromisos y entrega resultados muy por debajo de lo esperado.",
            "Cumple compromisos de forma irregular y requiere seguimiento constante.",
            "Cumple con sus responsabilidades de manera adecuada y confiable.",
            "Cumple de forma consistente, genera seguridad y aporta valor.",
            "Inspira por su compromiso; es modelo de conducta para el equipo."
          ]
        },
        { key: "B_puntualidad", label: "B. Puntualidad y asistencia",
          rubric: [
            "Ausencias frecuentes e injustificadas; llegadas tard√≠as recurrentes sin aviso y sin intenci√≥n de mejora.",
            "Se presenta con frecuencia tarde o sin justificaci√≥n clara, afectando la operaci√≥n.",
            "Asiste regularmente y cumple horarios; puede presentar llegadas tarde o ausencias justificadas sin reincidencia.",
            "Es puntual y mantiene asistencia confiable; respeta horarios y comunica eventualidades oportunamente.",
            "Puntualidad y asistencia impecables; es referente para el equipo y se adapta a horarios especiales sin afectar el desempe√±o."
          ]
        },
        { key: "C_equipo", label: "C. Trabajo en equipo y cooperaci√≥n",
          rubric: [
            "No coopera; genera conflictos y dificulta el trabajo del equipo.",
            "Coopera parcialmente y de manera inestable, con resultados aceptables.",
            "Coopera cuando se le solicita, con resultados aceptables.",
            "Colabora activamente con el equipo y aporta de forma confiable.",
            "Es referente en trabajo en equipo; promueve colaboraci√≥n, comunicaci√≥n e influye positivamente en otros."
          ]
        },
        { key: "D_comunicacion", label: "D. Comunicaci√≥n efectiva",
          rubric: [
            "Comunicaci√≥n confusa; genera malentendidos graves.",
            "Comunicaci√≥n incompleta o poco clara; requiere supervisi√≥n para asegurar claridad.",
            "Comunica lo necesario de forma clara y suficiente.",
            "Comunicaci√≥n clara, precisa y constructiva; escucha activamente.",
            "Comunicaci√≥n influyente y estrat√©gica; facilita acuerdos y motiva a otros."
          ]
        }
      ]
    },
    {
      group: "5. Desarrollo y Potencial",
      items: [
        { key: "A_adaptacion", label: "A. Adaptaci√≥n al cambio",
          rubric: [
            "Se resiste activamente al cambio; afecta procesos y equipos.",
            "Se adapta parcialmente, con dificultad y resultados limitados.",
            "Se adapta lo necesario para mantener un desempe√±o adecuado.",
            "Se adapta de forma aut√≥noma y confiable a nuevas situaciones.",
            "Es referente en adaptaci√≥n; motiva y gu√≠a a otros en procesos de cambio."
          ]
        },
        { key: "B_aprender", label: "B. Disposici√≥n para aprender",
          rubric: [
            "No busca aprender; rechaza retroalimentaci√≥n y capacitaci√≥n.",
            "Aprende solo lo obligatorio y con m√≠nima aplicaci√≥n pr√°ctica.",
            "Aprende lo necesario para mantener un desempe√±o satisfactorio.",
            "Busca aprender constantemente y aplica lo aprendido en el trabajo.",
            "Se mantiene en aprendizaje continuo, comparte conocimientos y forma a otros."
          ]
        },
        { key: "C_liderazgo", label: "C. Liderazgo",
          rubric: [
            "No logra coordinar ni dirigir; genera desorden y afecta resultados.",
            "Lidera de forma d√©bil, con bajo impacto en el equipo.",
            "Lidera tareas b√°sicas con resultados adecuados y funcionales.",
            "Lidera con confianza, logrando resultados consistentes y estables.",
            "Inspira con visi√≥n clara; desarrolla a otros, fortalece la cohesi√≥n del equipo y se convierte en referente."
          ]
        }
      ]
    }
  ];

  const state = { dirty:false, generated:false, answers:{}, saving:false };
  const $ = (id) => document.getElementById(id);

  function setDirty(v){
    state.dirty = v;
    const dot = $("stateDot");
    const text = $("stateText");
    if(v){
      dot.style.background = "var(--warn)";
      text.textContent = "Cambios sin guardar";
    }else{
      dot.style.background = "var(--ok)";
      text.textContent = "Sin cambios";
    }
  }

  function setBusy(isBusy){
    state.saving = isBusy;
    $("btnSave").disabled = isBusy;
    $("btnGenerate").disabled = isBusy;
    $("btnPrint").disabled = isBusy;
    $("btnNew").disabled = isBusy;
    $("btnRecover").disabled = isBusy;
    $("tipoFormulario").disabled = isBusy;
  }

  function findItemByKey(key){
    for(const sec of ITEMS){
      for(const it of sec.items){
        if(it.key === key) return it;
      }
    }
    return null;
  }

  function getSelectedText(itKey){
    const found = findItemByKey(itKey);
    const v = state.answers[itKey];
    if(!found || typeof v !== "number") return "";
    const desc = (found.rubric && found.rubric[v-1]) ? found.rubric[v-1] : "";
    if(!desc) return "";
    return `${v} ‚Äî ${desc}`;
  }

  function renderItems(){
    const container = $("itemsContainer");
    container.innerHTML = "";

    ITEMS.forEach(section => {
      const sec = document.createElement("div");
      sec.className = "card";
      sec.style.background = "rgba(0,0,0,.10)";
      sec.style.border = "1px dashed rgba(255,255,255,.10)";
      sec.style.marginTop = "14px";

      const h = document.createElement("h3");
      h.textContent = section.group;
      h.style.margin = "0 0 10px";
      sec.appendChild(h);

      section.items.forEach(it => {
        const row = document.createElement("div");
        row.style.display = "grid";
        row.style.gridTemplateColumns = "1.3fr .9fr";
        row.style.gap = "12px";
        row.style.padding = "10px 0";
        row.style.borderTop = "1px solid rgba(255,255,255,.08)";

        const left = document.createElement("div");
        const title = document.createElement("div");
        title.style.fontWeight = "800";
        title.textContent = it.label;
        const sub = document.createElement("div");
        sub.className = "muted";
        sub.style.fontSize = "12px";
        sub.textContent = "Selecciona 1‚Äì5 seg√∫n la r√∫brica.";
        left.appendChild(title);
        left.appendChild(sub);

        const right = document.createElement("div");
        const lab = document.createElement("label");
        lab.textContent = "Puntaje (1‚Äì5)";

        const sel = document.createElement("select");
        sel.id = "ans_" + it.key;

        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Seleccionar...";
        sel.appendChild(opt0);

        for(let v=1; v<=5; v++){
          const o = document.createElement("option");
          o.value = String(v);
          const full = (it.rubric && it.rubric[v-1]) ? it.rubric[v-1] : "";
          o.textContent = full ? `${v} ‚Äî ${full}` : `${v}`;
          sel.appendChild(o);
        }

        sel.addEventListener("change", () => {
          state.answers[it.key] = sel.value ? Number(sel.value) : null;
          setDirty(true);
        });

        right.appendChild(lab);
        right.appendChild(sel);

        row.appendChild(left);
        row.appendChild(right);
        sec.appendChild(row);
      });

      container.appendChild(sec);
    });
  }

  function getHeaderData(){
    return {
      tipo: $("tipoFormulario").value,
      no_personal: $("noPersonal").value.trim(),
      nombre: $("nombre").value.trim(),
      posicion: $("posicion").value.trim(),
      departamento: $("departamento").value.trim(),
      periodo: $("periodo").value.trim(),
      version: $("version").value.trim(),
      fecha: $("fecha").value
    };
  }

  function getExtraFields(){
    const tipo = $("tipoFormulario").value;

    if(tipo === "autoevaluacion"){
      return { comentarios_colaborador: $("comentariosColaborador").value.trim() };
    }
    if(tipo === "desempeno"){
      return {
        justificacion: $("justificacion").value.trim(),
        comentarios_evaluador: $("comentariosEvaluador").value.trim(),
        fortalezas: $("fortalezas").value.trim(),
        oportunidades_mejora: $("oportunidades").value.trim(),
        proyeccion_potencial: $("proyeccion").value.trim(),
        comentarios_colaborador: $("comentariosColaborador2").value.trim()
      };
    }
    return {};
  }

  function computeTotal(){
    const vals = Object.values(state.answers).filter(v => typeof v === "number");
    if(!vals.length) return 0;
    const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
    return +(avg * 20).toFixed(2);
  }

  function formatDateES(yyyy_mm_dd){
    if(!yyyy_mm_dd) return "‚Äî";
    const [y,m,d] = yyyy_mm_dd.split("-").map(n=>parseInt(n,10));
    if(!y || !m || !d) return yyyy_mm_dd;
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString("es-HN");
  }

  function renderSeleccionEnReporte(){
    const host = $("rRubricas");
    host.innerHTML = "";

    ITEMS.forEach(sec => {
      const wrap = document.createElement("div");
      wrap.className = "rubric-wrap";

      const title = document.createElement("div");
      title.className = "rubric-title";
      title.textContent = sec.group;
      wrap.appendChild(title);

      const table = document.createElement("table");
      table.className = "sel-table";

      const thead = document.createElement("thead");
      const trh = document.createElement("tr");

      const thItem = document.createElement("th");
      thItem.className = "col-item";
      thItem.textContent = "√çtem";
      trh.appendChild(thItem);

      const thScore = document.createElement("th");
      thScore.className = "col-score";
      thScore.textContent = "Puntaje";
      trh.appendChild(thScore);

      const thDesc = document.createElement("th");
      thDesc.className = "col-desc";
      thDesc.textContent = "Opci√≥n seleccionada";
      trh.appendChild(thDesc);

      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      sec.items.forEach(it => {
        const v = state.answers[it.key];
        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        tdItem.className = "col-item";
        tdItem.textContent = it.label;
        tr.appendChild(tdItem);

        const tdScore = document.createElement("td");
        tdScore.className = "col-score";
        tdScore.textContent = (typeof v === "number") ? String(v) : "‚Äî";
        tr.appendChild(tdScore);

        const tdDesc = document.createElement("td");
        tdDesc.className = "col-desc";
        if(typeof v === "number" && it.rubric && it.rubric[v-1]){
          tdDesc.textContent = `${v} ‚Äî ${it.rubric[v-1]}`;
        }else{
          tdDesc.innerHTML = `<span class="muted-print">Sin selecci√≥n</span>`;
        }
        tr.appendChild(tdDesc);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrap.appendChild(table);

      host.appendChild(wrap);
    });
  }

  function buildReport(){
    const header = getHeaderData();
    const extra = getExtraFields();
    const total = computeTotal();

    $("rTitle").textContent =
      (header.tipo === "autoevaluacion")
        ? "Autoevaluaci√≥n del desempe√±o"
        : (header.tipo === "clientes")
          ? "Evaluaci√≥n de clientes"
          : "Evaluaci√≥n del desempe√±o";

    $("rGenerated").textContent = new Date().toLocaleString();

    $("rNoPersonal").textContent = header.no_personal || "‚Äî";
    $("rNombre").textContent = header.nombre || "‚Äî";
    $("rPosicion").textContent = header.posicion || "‚Äî";
    $("rDepartamento").textContent = header.departamento || "‚Äî";
    $("rPeriodo").textContent = header.periodo || "‚Äî";
    $("rVersion").textContent = header.version || "‚Äî";
    $("rFecha").textContent = formatDateES(header.fecha);

    renderSeleccionEnReporte();
    $("rTotal").textContent = String(total);

    const comentarioColab =
      (header.tipo === "autoevaluacion")
        ? (extra.comentarios_colaborador || "")
        : (header.tipo === "desempeno")
          ? (extra.comentarios_colaborador || "")
          : "";

    if(comentarioColab){
      $("rComentariosBlock").style.display = "block";
      $("rComentarios").textContent = comentarioColab;
    }else{
      $("rComentariosBlock").style.display = "none";
      $("rComentarios").textContent = "‚Äî";
    }

    if(header.tipo === "desempeno"){
      $("rJustifBlock").style.display = "block";
      const txt = [
        `Justificaci√≥n calificaciones (1-6): ${extra.justificacion || "‚Äî"}`,
        `Comentarios del evaluador: ${extra.comentarios_evaluador || "‚Äî"}`,
        `Fortalezas: ${extra.fortalezas || "‚Äî"}`,
        `Oportunidades de mejora: ${extra.oportunidades_mejora || "‚Äî"}`,
        `Proyecci√≥n y potencial: ${extra.proyeccion_potencial || "‚Äî"}`
      ].join("\n\n");
      $("rJustifAll").textContent = txt;
    }else{
      $("rJustifBlock").style.display = "none";
      $("rJustifAll").textContent = "‚Äî";
    }

    $("printArea").style.display = "block";
  }

  function parseScoreFromCell(val){
    const s = String(val || "").trim();
    if(!s) return null;
    const m = s.match(/^([1-5])\s*(?:[‚Äî-]|$)/);
    if(m) return Number(m[1]);
    const n = Number(s);
    if(Number.isFinite(n) && n>=1 && n<=5) return n;
    return null;
  }

  function setSelectValue(key, score){
    const el = $("ans_" + key);
    if(!el) return;
    el.value = (score>=1 && score<=5) ? String(score) : "";
    state.answers[key] = (score>=1 && score<=5) ? score : null;
  }

  // ===== MODAL (Vista r√°pida) =====
  function openModal(){
    $("recoverModal").style.display = "block";
    $("recoverModal").setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    $("recoverModal").style.display = "none";
    $("recoverModal").setAttribute("aria-hidden", "true");
  }

  // ‚úÖ Campos que S√ç van en vista r√°pida (se excluyen los que pediste)
  function renderRecoverPreview(row, keys){
    // Encabezado modal
    $("mTag").style.display = "flex";
    $("mSub").textContent = `No. Personal: ${keys.no_personal} ‚Ä¢ Periodo: ${keys.periodo} ‚Ä¢ Versi√≥n: ${keys.version}`;

    // Tabla de datos (sin Justificaci√≥n, Comentarios evaluador, Fortalezas, Oportunidades, Proyecci√≥n)
    const preview = $("mPreviewTable");
    preview.innerHTML = "";

    const rows = [
      ["Nombre", row.nombre || "‚Äî"],
      ["Posici√≥n", row.posicion || "‚Äî"],
      ["Departamento", row.departamento || "‚Äî"],
      ["Fecha", row.fecha || "‚Äî"],
      ["Comentarios colaborador", row.comentarios_colaborador || "‚Äî"]
    ];

    rows.forEach(([k,v])=>{
      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.textContent = k;
      const td = document.createElement("td");
      td.textContent = String(v ?? "").trim() || "‚Äî";
      tr.appendChild(th);
      tr.appendChild(td);
      preview.appendChild(tr);
    });

    // Tabla de √≠tems
    const itemsTable = $("mItemsTable");
    itemsTable.innerHTML = "";

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    const th1 = document.createElement("th"); th1.className="items-col-item"; th1.textContent="√çtem";
    const th2 = document.createElement("th"); th2.className="items-col-score"; th2.textContent="Puntaje";
    const th3 = document.createElement("th"); th3.className="items-col-text"; th3.textContent="Texto guardado (r√∫brica / opci√≥n)";
    trh.appendChild(th1); trh.appendChild(th2); trh.appendChild(th3);
    thead.appendChild(trh);
    itemsTable.appendChild(thead);

    const tbody = document.createElement("tbody");

    ITEMS.forEach(sec=>{
      // fila secci√≥n
      const trSec = document.createElement("tr");
      trSec.className = "sec-row";
      const tdSec = document.createElement("td");
      tdSec.colSpan = 3;
      tdSec.textContent = sec.group;
      trSec.appendChild(tdSec);
      tbody.appendChild(trSec);

      sec.items.forEach(it=>{
        const raw = row[it.key] || "";
        const score = parseScoreFromCell(raw);

        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        tdItem.className="items-col-item";
        tdItem.textContent = it.label;

        const tdScore = document.createElement("td");
        tdScore.className="items-col-score";
        tdScore.textContent = (typeof score==="number") ? String(score) : "‚Äî";

        const tdText = document.createElement("td");
        tdText.className="items-col-text";
        tdText.textContent = String(raw || "").trim() || "‚Äî";

        tr.appendChild(tdItem);
        tr.appendChild(tdScore);
        tr.appendChild(tdText);
        tbody.appendChild(tr);
      });
    });

    itemsTable.appendChild(tbody);
  }

  async function recoverRecord(){
    if(state.saving) return;

    const no_personal = $("noPersonal").value.trim();
    const periodo = $("periodo").value.trim();
    const version = $("version").value.trim();

    if(!no_personal || !periodo || !version){
      alert("Para recuperar, completa:\n\n‚Ä¢ No. de personal\n‚Ä¢ Periodo\n‚Ä¢ Versi√≥n");
      return;
    }

    try{
      setBusy(true);
      $("apiHint").className = "warn";
      $("apiHint").textContent = "Recuperando desde Google Sheets...";

      const data = await jsonpRequest(API_URL, {
        action: "recuperar",
        no_personal,
        periodo,
        version
      });

      if(!data || !data.found){
        $("apiHint").className = "warn";
        $("apiHint").textContent = "No se encontr√≥ registro con esos datos.";
        alert("No se encontr√≥ registro con ese No. de personal, Periodo y Versi√≥n.");
        return;
      }

      // ‚úÖ Compat: tomamos row (si viene) o rowParams
      const row = data.row || data.rowParams || {};

      // Autollenar campos generales
      $("nombre").value = row.nombre || $("nombre").value;
      $("posicion").value = row.posicion || $("posicion").value;
      $("departamento").value = row.departamento || $("departamento").value;
      $("fecha").value = row.fecha || $("fecha").value;

      // Autollenar campos desempe√±o (aunque NO se muestren en modal)
      $("justificacion").value = row.justificacion || $("justificacion").value;
      $("comentariosEvaluador").value = row.comentarios_evaluador || $("comentariosEvaluador").value;
      $("fortalezas").value = row.fortalezas || $("fortalezas").value;
      $("oportunidades").value = row.oportunidades_mejora || $("oportunidades").value;
      $("proyeccion").value = row.proyeccion_potencial || $("proyeccion").value;
      $("comentariosColaborador2").value = row.comentarios_colaborador || $("comentariosColaborador2").value;

      // Set selects por √≠tem
      ITEMS.forEach(sec => sec.items.forEach(it => {
        const raw = row[it.key];
        const score = parseScoreFromCell(raw);
        setSelectValue(it.key, score);
      }));

      $("apiHint").className = "ok";
      $("apiHint").textContent = "Registro recuperado ‚úÖ";
      setDirty(false);

      // ‚úÖ Mostrar modal (vista r√°pida) SIN campos excluidos
      renderRecoverPreview(row, { no_personal, periodo, version });
      openModal();

    }catch(err){
      console.error(err);
      $("apiHint").className = "err";
      $("apiHint").textContent = "No se pudo recuperar: " + (err.message || err);
      alert("No se pudo recuperar: " + (err.message || err));
    }finally{
      setBusy(false);
    }
  }

  function applyTipoUI(){
    const tipo = $("tipoFormulario").value;

    $("appTitle").textContent =
      tipo === "autoevaluacion" ? "Formulario de autoevaluaci√≥n del desempe√±o" :
      tipo === "clientes" ? "Formulario de evaluaci√≥n de clientes" :
      "Formulario de evaluaci√≥n del desempe√±o";

    $("autoComentariosBox").style.display = (tipo === "autoevaluacion") ? "block" : "none";
    $("desempenoCamposBox").style.display = (tipo === "desempeno") ? "block" : "none";
    $("clientesBox").style.display = (tipo === "clientes") ? "block" : "none";
  }

  function clearForm(){
    $("noPersonal").value = "";
    $("nombre").value = "";
    $("posicion").value = "";
    $("departamento").value = "";
    $("periodo").value = "";
    $("version").value = "";
    $("fecha").value = "";

    $("comentariosColaborador").value = "";
    $("justificacion").value = "";
    $("comentariosEvaluador").value = "";
    $("fortalezas").value = "";
    $("oportunidades").value = "";
    $("proyeccion").value = "";
    $("comentariosColaborador2").value = "";

    state.answers = {};
    ITEMS.forEach(sec=>sec.items.forEach(it=>{
      const el = $("ans_"+it.key);
      if(el) el.value = "";
    }));

    $("printArea").style.display = "none";
    state.generated = false;
    setDirty(false);
    $("apiHint").className = "warn";
    $("apiHint").textContent = "Listo para enviar";
  }

  function flattenAnswersSelectedText(){
    const out = {};
    ITEMS.forEach(sec=>sec.items.forEach(it=>{
      out[it.key] = getSelectedText(it.key) || "";
    }));
    return out;
  }

  function toFormUrlEncoded(obj){
    return Object.keys(obj)
      .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(obj[k] ?? ""))
      .join("&");
  }

  function buildComentariosParaSheet(tipo, extra){
    if(tipo === "autoevaluacion"){
      return extra.comentarios_colaborador || "";
    }
    if(tipo === "desempeno"){
      return [
        extra.comentarios_evaluador ? `Comentarios evaluador: ${extra.comentarios_evaluador}` : "",
        extra.fortalezas ? `Fortalezas: ${extra.fortalezas}` : "",
        extra.oportunidades_mejora ? `Oportunidades: ${extra.oportunidades_mejora}` : "",
        extra.proyeccion_potencial ? `Proyecci√≥n: ${extra.proyeccion_potencial}` : "",
        extra.comentarios_colaborador ? `Comentarios colaborador: ${extra.comentarios_colaborador}` : ""
      ].filter(Boolean).join("\n\n");
    }
    return "";
  }

  function validateAll(){
    const header = getHeaderData();
    const extra = getExtraFields();
    const tipo = header.tipo;

    const missing = [];

    if(!header.no_personal) missing.push("No. de personal");
    if(!header.nombre) missing.push("Nombre");
    if(!header.posicion) missing.push("Posici√≥n");
    if(!header.departamento) missing.push("Departamento");
    if(!header.periodo) missing.push("Periodo");
    if(!header.version) missing.push("Versi√≥n");
    if(!header.fecha) missing.push("Fecha");

    ITEMS.forEach(sec => sec.items.forEach(it => {
      const v = state.answers[it.key];
      if(!(typeof v === "number" && v >= 1 && v <= 5)){
        missing.push(it.label);
      }
    }));

    if(tipo === "autoevaluacion"){
      if(!extra.comentarios_colaborador) missing.push("Comentarios del colaborador");
    }
    if(tipo === "desempeno"){
      if(!extra.justificacion) missing.push("Justificaci√≥n calificaciones");
      if(!extra.comentarios_evaluador) missing.push("Comentarios del evaluador");
      if(!extra.fortalezas) missing.push("Fortalezas");
      if(!extra.oportunidades_mejora) missing.push("Oportunidades de mejora");
      if(!extra.proyeccion_potencial) missing.push("Proyecci√≥n y potencial");
      if(!extra.comentarios_colaborador) missing.push("Comentarios del colaborador");
    }

    return { ok: missing.length === 0, missing, header, extra };
  }

  async function saveToSheet(){
    if(state.saving) return;

    const v = validateAll();
    if(!v.ok){
      const unique = Array.from(new Set(v.missing));
      alert("Faltan campos/selecciones:\n\n‚Ä¢ " + unique.join("\n‚Ä¢ "));
      return;
    }

    const header = v.header;
    const extra = v.extra;

    const answersText = flattenAnswersSelectedText();
    const total = computeTotal();

    const respuestasJSON = JSON.stringify({
      header,
      answers: answersText,
      extra,
      puntaje_total: total,
      creado_en: new Date().toISOString()
    });

    const formPayload = {
      no_personal: header.no_personal,
      nombre: header.nombre,
      posicion: header.posicion,
      departamento: header.departamento,
      periodo: header.periodo,
      version: header.version,
      fecha: header.fecha,
      ...answersText,
      respuestas_json: respuestasJSON,
      comentarios: buildComentariosParaSheet(header.tipo, extra),

      // extras desempe√±o (para que queden como columnas si existen)
      justificacion: extra.justificacion || "",
      comentarios_evaluador: extra.comentarios_evaluador || "",
      fortalezas: extra.fortalezas || "",
      oportunidades_mejora: extra.oportunidades_mejora || "",
      proyeccion_potencial: extra.proyeccion_potencial || "",
      comentarios_colaborador: extra.comentarios_colaborador || ""
    };

    try{
      setBusy(true);
      $("apiHint").className = "warn";
      $("apiHint").textContent = "Enviando a Google Sheets...";

      const body = toFormUrlEncoded(formPayload);

      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body
      });

      $("apiHint").className = "ok";
      $("apiHint").textContent = "Enviado a Google Sheets ‚úÖ";
      setDirty(false);

    }catch(err){
      console.error(err);
      $("apiHint").className = "err";
      $("apiHint").textContent = "Error al guardar: " + (err.message || err);
      alert("Error al guardar en Google Sheets: " + (err.message || err));
    }finally{
      setBusy(false);
    }
  }

  function bind(){
    [
      "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
      "comentariosColaborador","justificacion","comentariosEvaluador","fortalezas",
      "oportunidades","proyeccion","comentariosColaborador2"
    ].forEach(id=>{
      $(id).addEventListener("input", ()=> setDirty(true));
      $(id).addEventListener("change", ()=> setDirty(true));
    });

    $("tipoFormulario").addEventListener("change", ()=>{
      applyTipoUI();
      setDirty(true);
    });

    // ‚úÖ Nuevo: limpia
    $("btnNew").addEventListener("click", ()=>{
      if(state.saving) return;
      if(state.dirty && !confirm("Hay cambios sin guardar. ¬øLimpiar el formulario de todas formas?")) return;
      clearForm();
    });

    // ‚úÖ Recuperar: siempre disponible
    $("btnRecover").addEventListener("click", ()=>{
      if(state.saving) return;
      recoverRecord();
    });

    $("btnSave").addEventListener("click", saveToSheet);

    $("btnGenerate").addEventListener("click", ()=>{
      if(state.saving) return;

      const v = validateAll();
      if(!v.ok){
        const unique = Array.from(new Set(v.missing));
        alert("Para generar el reporte, completa todo:\n\n‚Ä¢ " + unique.join("\n‚Ä¢ "));
        return;
      }

      buildReport();
      state.generated = true;
      setDirty(true);
    });

    $("btnPrint").addEventListener("click", ()=>{
      if(state.saving) return;

      const v = validateAll();
      if(!v.ok){
        const unique = Array.from(new Set(v.missing));
        alert("Para imprimir/enviar a PDF, completa todo:\n\n‚Ä¢ " + unique.join("\n‚Ä¢ "));
        return;
      }

      if(!state.generated){
        buildReport();
        state.generated = true;
      }
      window.print();
    });

    // Modal close
    $("btnCloseModal").addEventListener("click", closeModal);
    $("recoverModal").addEventListener("click", (ev)=>{
      if(ev.target && ev.target.id === "recoverModal") closeModal();
    });
    document.addEventListener("keydown",(ev)=>{
      if(ev.key === "Escape") closeModal();
    });
  }

  renderItems();
  applyTipoUI();
  bind();
  setDirty(false);
</script>
</body>
</html>
