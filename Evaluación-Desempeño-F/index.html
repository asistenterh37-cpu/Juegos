<script>
  /************************************************************
   * 1) URL COMPLETA DEL APPS SCRIPT (/exec) ✅ (LA NUEVA)
   ************************************************************/
  const API_URL = "https://script.google.com/macros/s/AKfycbxkY7Ieg9BZoHcZF-Uw0n3R8jn1kGv-10uyuL9T7OFZNFr5vZlsWnDaXAsukrOoRp28dQ/exec";

  /************************************************************
   * 2) Ítems + rúbrica 1–5
   ************************************************************/
  const ITEMS = [
    {
      group: "1. Metas, productividad y eficiencia",
      items: [
        {
          key: "A_metas",
          label: "A. Cumplimiento de Metas. Grado de logro",
          rubric: [
            "No alcanza la mayoría de las metas; cumple menos del 70 % de lo establecido. La falta de avance afecta los resultados esperados.",
            "Logra entre 70–89 % de las metas; presenta avances parciales o inconsistentes y requiere correcciones.",
            "Alcanza el 100 % de las metas planificadas con calidad y dentro del tiempo establecido.",
            "Supera el 100 % y llega hasta un 110 % de las metas; entrega resultados adicionales o mejores de lo esperado.",
            "Supera más del 110 % de las metas de forma sostenida, con impacto significativo y calidad superior."
          ]
        },
        {
          key: "B_eficiencia",
          label: "B. Eficiencia en el uso del tiempo, costos y recursos",
          rubric: [
            "Usa el tiempo y los recursos con errores graves que afectan la eficiencia.",
            "Muestra uso inestable del tiempo y los recursos; requiere evaluaciones y correcciones frecuentes.",
            "Utiliza de manera adecuada el tiempo y los recursos, cumpliendo sin desperdicios significativos.",
            "Optimiza tiempo y recursos, generando mejoras o ahorros sin afectar la calidad del trabajo.",
            "Maximiza la eficiencia de forma sostenida, mejora procesos y logra resultados superiores sin comprometer la calidad."
          ]
        },
        {
          key: "C_seguridad",
          label: "C. Cumplimiento de normas de seguridad",
          rubric: [
            "Incumple normas de seguridad y genera riesgos constantes para sí y el equipo.",
            "Cumple parcialmente las normas; requiere supervisión continua para evitar incidentes.",
            "Cumple todas las normas de seguridad y actúa de manera segura en su trabajo diario.",
            "Se anticipa a riesgos, propone acciones preventivas y actúa con autonomía segura.",
            "Promueve una cultura de seguridad; motiva a otros y contribuye a mantener ambientes sin incidentes."
          ]
        },
        {
          key: "D_prioriza",
          label: "D. Prioriza y organiza tareas adecuadamente",
          rubric: [
            "Desorganiza las tareas; incumple plazos y afecta resultados importantes.",
            "Organiza parcialmente; presenta inconsistencias en prioridades y manejo del tiempo.",
            "Gestiona las tareas de forma adecuada, cumple tiempos y mantiene orden en su trabajo.",
            "Organiza y prioriza con eficiencia, anticipa necesidades y mejora sus tiempos de entrega.",
            "Es referente en organización; redistribuye recursos, optimiza procesos y eleva la productividad del equipo."
          ]
        }
      ]
    },
    {
      group: "2. Calidad del Trabajo",
      items: [
        {
          key: "A_exactitud",
          label: "A. Exactitud y atención al detalle",
          rubric: [
            "Comete errores frecuentes y no identifica fallos evidentes; requiere supervisión constante para evitar errores mayores.",
            "Presenta errores recurrentes por falta de revisión; la exactitud es inconsistente y requiere correcciones frecuentes.",
            "Realiza su trabajo con un nivel adecuado de precisión; puede cometer errores menores que no afectan los resultados.",
            "Mantiene una atención al detalle constante; comete pocos errores y revisa su trabajo de forma proactiva.",
            "Su trabajo es impecable; detecta errores propios y ajenos, propone mejoras y es referente en precisión."
          ]
        },
        {
          key: "B_estandares",
          label: "B. Cumple con estándares de calidad",
          rubric: [
            "Menos del 70 % de los entregables cumplen los estándares; los resultados son inaceptables.",
            "Entre 70–89 % de los entregables cumplen los estándares; requiere ajustes frecuentes.",
            "El 100 % de los entregables cumplen los estándares establecidos.",
            "Cumplimiento entre 101–110 %; entrega con calidad superior y consistente.",
            "Más del 110 % de cumplimiento; supera ampliamente los estándares y produce resultados sobresalientes."
          ]
        },
        {
          key: "C_entregas",
          label: "C. Entregas a tiempo, cumple con plazos establecidos",
          rubric: [
            "Menos del 70 % de las entregas se cumplen a tiempo; los retrasos afectan el área.",
            "Entre 70–89 % de las entregas se realizan a tiempo; desempeño irregular.",
            "El 100 % de las entregas se cumplen en los plazos pactados.",
            "Cumple entre 101–110 % de los tiempos; se anticipa en algunas entregas y mantiene calidad.",
            "Entrega más del 110 % a tiempo; supera plazos, mantiene calidad y mejora la eficiencia general."
          ]
        },
        {
          key: "D_errores",
          label: "D. Manejo de errores y mejoras",
          rubric: [
            "No reconoce ni corrige errores; genera reincidencias graves.",
            "Corrige parcialmente, con retrasos o bajo nivel de supervisión; la mejora no es constante.",
            "Detecta y corrige errores básicos cuando se le solicita; cumple lo necesario.",
            "Se anticipa a errores y propone soluciones preventivas que mejoran el proceso.",
            "Asegura procesos libres de errores, implementa mejoras continuas y es referente en calidad."
          ]
        }
      ]
    },
    {
      group: "3. Competencias y Habilidades",
      items: [
        {
          key: "A_conocimientos",
          label: "A. Conocimientos técnicos del puesto",
          rubric: [
            "Conocimientos muy por debajo de lo esperado; no domina funciones básicas del puesto.",
            "Gestiona parcialmente los conocimientos requeridos y necesita apoyo frecuente.",
            "Posee el conocimiento necesario y funcional para el puesto; desempeño adecuado.",
            "Aplica los conocimientos de manera confiable y constante.",
            "Domina los conocimientos, aplica técnicas avanzadas y es referente técnico en el área."
          ]
        },
        {
          key: "B_clientes",
          label: "B. Convincente respuesta técnica a clientes",
          rubric: [
            "Respuestas incorrectas o inconsistentes que generan desconfianza.",
            "Respuestas incompletas o poco claras que afectan la calidad del servicio.",
            "Responde de forma adecuada y funcional, brindando confianza.",
            "Respuestas claras, específicas y confiables de manera constante.",
            "Respuestas sobresalientes y precisas, reconocidas como referente por clientes."
          ]
        },
        {
          key: "C_problemas",
          label: "C. Resolución de problemas",
          rubric: [
            "No logra resolver problemas; afecta procesos y resultados.",
            "Resuelve parcialmente los problemas, requiriendo supervisión frecuente.",
            "Resuelve problemas básicos de manera satisfactoria y funcional.",
            "Resuelve problemas complejos con autonomía y confiabilidad.",
            "Anticipa problemas y desarrolla soluciones preventivas y estratégicas."
          ]
        },
        {
          key: "D_iniciativa",
          label: "D. Iniciativa y creatividad",
          rubric: [
            "No genera ideas ni propone mejoras.",
            "Propone ideas poco útiles o de aplicación limitada.",
            "Propone ideas funcionales y aplicables cuando es necesario.",
            "Genera ideas prácticas que optimizan procesos y agregan valor.",
            "Propone soluciones innovadoras con impacto positivo y sostenible en el área."
          ]
        }
      ]
    },
    {
      group: "4. Actitud y Valores",
      items: [
        {
          key: "A_responsabilidad",
          label: "A. Responsabilidad y compromiso",
          rubric: [
            "Incumple compromisos y entrega resultados muy por debajo de lo esperado.",
            "Cumple compromisos de forma irregular y requiere seguimiento constante.",
            "Cumple con sus responsabilidades de manera adecuada y confiable.",
            "Cumple de forma consistente, genera seguridad y aporta valor.",
            "Inspira por su compromiso; es modelo de conducta para el equipo."
          ]
        },
        {
          key: "B_puntualidad",
          label: "B. Puntualidad y asistencia",
          rubric: [
            "Ausencias frecuentes e injustificadas; llegadas tardías recurrentes sin aviso y sin intención de mejora.",
            "Se presenta con frecuencia tarde o sin justificación clara, afectando la operación.",
            "Asiste regularmente y cumple horarios; puede presentar llegadas tarde o ausencias justificadas sin reincidencia.",
            "Es puntual y mantiene asistencia confiable; respeta horarios y comunica eventualidades oportunamente.",
            "Puntualidad y asistencia impecables; es referente para el equipo y se adapta a horarios especiales sin afectar el desempeño."
          ]
        },
        {
          key: "C_equipo",
          label: "C. Trabajo en equipo y cooperación",
          rubric: [
            "No coopera; genera conflictos y dificulta el trabajo del equipo.",
            "Coopera parcialmente y de manera inestable, con resultados aceptables.",
            "Coopera cuando se le solicita, con resultados aceptables.",
            "Colabora activamente con el equipo y aporta de forma confiable.",
            "Es referente en trabajo en equipo; promueve colaboración, comunicación e influye positivamente en otros."
          ]
        },
        {
          key: "D_comunicacion",
          label: "D. Comunicación efectiva",
          rubric: [
            "Comunicación confusa; genera malentendidos graves.",
            "Comunicación incompleta o poco clara; requiere supervisión para asegurar claridad.",
            "Comunica lo necesario de forma clara y suficiente.",
            "Comunicación clara, precisa y constructiva; escucha activamente.",
            "Comunicación influyente y estratégica; facilita acuerdos y motiva a otros."
          ]
        }
      ]
    },
    {
      group: "5. Desarrollo y Potencial",
      items: [
        {
          key: "A_adaptacion",
          label: "A. Adaptación al cambio",
          rubric: [
            "Se resiste activamente al cambio; afecta procesos y equipos.",
            "Se adapta parcialmente, con dificultad y resultados limitados.",
            "Se adapta lo necesario para mantener un desempeño adecuado.",
            "Se adapta de forma autónoma y confiable a nuevas situaciones.",
            "Es referente en adaptación; motiva y guía a otros en procesos de cambio."
          ]
        },
        {
          key: "B_aprender",
          label: "B. Disposición para aprender",
          rubric: [
            "No busca aprender; rechaza retroalimentación y capacitación.",
            "Aprende solo lo obligatorio y con mínima aplicación práctica.",
            "Aprende lo necesario para mantener un desempeño satisfactorio.",
            "Busca aprender constantemente y aplica lo aprendido en el trabajo.",
            "Se mantiene en aprendizaje continuo, comparte conocimientos y forma a otros."
          ]
        },
        {
          key: "C_liderazgo",
          label: "C. Liderazgo",
          rubric: [
            "No logra coordinar ni dirigir; genera desorden y afecta resultados.",
            "Lidera de forma débil, con bajo impacto en el equipo.",
            "Lidera tareas básicas con resultados adecuados y funcionales.",
            "Lidera con confianza, logrando resultados consistentes y estables.",
            "Inspira con visión clara; desarrolla a otros, fortalece la cohesión del equipo y se convierte en referente."
          ]
        }
      ]
    }
  ];

  /************************************************************
   * Estado UI
   ************************************************************/
  const state = { dirty:false, generated:false, answers:{} };
  const $ = (id) => document.getElementById(id);

  function setDirty(v){
    state.dirty = v;
    const dot = $("stateDot");
    const text = $("stateText");
    if(v){
      dot.style.background = "var(--warn)";
      text.textContent = "Cambios sin guardar";
    }else{
      dot.style.background = "var(--ok)";
      text.textContent = "Sin cambios";
    }
  }

  function renderItems(){
    const container = $("itemsContainer");
    container.innerHTML = "";

    ITEMS.forEach(section => {
      const sec = document.createElement("div");
      sec.className = "card";
      sec.style.background = "rgba(0,0,0,.10)";
      sec.style.border = "1px dashed rgba(255,255,255,.10)";
      sec.style.marginTop = "14px";

      const h = document.createElement("h3");
      h.textContent = section.group;
      h.style.margin = "0 0 10px";
      sec.appendChild(h);

      section.items.forEach(it => {
        const row = document.createElement("div");
        row.style.display = "grid";
        row.style.gridTemplateColumns = "1.3fr .9fr";
        row.style.gap = "12px";
        row.style.padding = "10px 0";
        row.style.borderTop = "1px solid rgba(255,255,255,.08)";

        const left = document.createElement("div");
        const title = document.createElement("div");
        title.style.fontWeight = "800";
        title.textContent = it.label;
        const sub = document.createElement("div");
        sub.className = "muted";
        sub.style.fontSize = "12px";
        sub.textContent = "Selecciona 1–5 según la rúbrica.";
        left.appendChild(title);
        left.appendChild(sub);

        const right = document.createElement("div");
        const lab = document.createElement("label");
        lab.textContent = "Puntaje (1–5)";

        const sel = document.createElement("select");
        sel.id = "ans_" + it.key;

        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Seleccionar...";
        sel.appendChild(opt0);

        for(let v=1; v<=5; v++){
          const o = document.createElement("option");
          o.value = String(v);
          const preview = (it.rubric && it.rubric[v-1]) ? it.rubric[v-1].split(".")[0] : "";
          o.textContent = `${v} — ${preview}`;
          sel.appendChild(o);
        }

        sel.addEventListener("change", () => {
          state.answers[it.key] = sel.value ? Number(sel.value) : "";
          setDirty(true);
        });

        right.appendChild(lab);
        right.appendChild(sel);

        row.appendChild(left);
        row.appendChild(right);
        sec.appendChild(row);
      });

      container.appendChild(sec);
    });
  }

  function getHeaderData(){
    return {
      tipo: $("tipoFormulario").value,
      no_personal: $("noPersonal").value.trim(),
      nombre: $("nombre").value.trim(),
      posicion: $("posicion").value.trim(),
      departamento: $("departamento").value.trim(),
      periodo: $("periodo").value.trim(),
      version: $("version").value.trim(),
      fecha: $("fecha").value
    };
  }

  function getExtraFields(){
    const tipo = $("tipoFormulario").value;

    if(tipo === "autoevaluacion"){
      return { comentarios_colaborador: $("comentariosColaborador").value.trim() };
    }
    if(tipo === "desempeno"){
      return {
        justificacion: $("justificacion").value.trim(),
        comentarios_evaluador: $("comentariosEvaluador").value.trim(),
        fortalezas: $("fortalezas").value.trim(),
        oportunidades_mejora: $("oportunidades").value.trim(),
        proyeccion_potencial: $("proyeccion").value.trim(),
        comentarios_colaborador: $("comentariosColaborador2").value.trim()
      };
    }
    return {};
  }

  function computeTotal(){
    const vals = Object.values(state.answers).filter(v => typeof v === "number");
    if(!vals.length) return 0;
    const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
    return +(avg * 20).toFixed(2);
  }

  function formatDateES(yyyy_mm_dd){
    if(!yyyy_mm_dd) return "—";
    const [y,m,d] = yyyy_mm_dd.split("-").map(n=>parseInt(n,10));
    if(!y || !m || !d) return yyyy_mm_dd;
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString("es-HN");
  }

  function renderSeleccionEnReporte(){
    const host = $("rRubricas");
    host.innerHTML = "";

    ITEMS.forEach(sec => {
      const wrap = document.createElement("div");
      wrap.className = "rubric-wrap";

      const title = document.createElement("div");
      title.className = "rubric-title";
      title.textContent = sec.group;
      wrap.appendChild(title);

      const table = document.createElement("table");
      table.className = "sel-table";

      const thead = document.createElement("thead");
      const trh = document.createElement("tr");

      const thItem = document.createElement("th");
      thItem.className = "col-item";
      thItem.textContent = "Ítem";
      trh.appendChild(thItem);

      const thScore = document.createElement("th");
      thScore.className = "col-score";
      thScore.textContent = "Puntaje";
      trh.appendChild(thScore);

      const thDesc = document.createElement("th");
      thDesc.className = "col-desc";
      thDesc.textContent = "Opción seleccionada";
      trh.appendChild(thDesc);

      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      sec.items.forEach(it => {
        const v = state.answers[it.key];
        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        tdItem.className = "col-item";
        tdItem.textContent = it.label;
        tr.appendChild(tdItem);

        const tdScore = document.createElement("td");
        tdScore.className = "col-score";
        tdScore.textContent = (typeof v === "number") ? String(v) : (v ? String(v) : "—");
        tr.appendChild(tdScore);

        const tdDesc = document.createElement("td");
        tdDesc.className = "col-desc";
        if(typeof v === "number" && it.rubric && it.rubric[v-1]){
          tdDesc.textContent = it.rubric[v-1];
        }else{
          tdDesc.innerHTML = `<span class="muted-print">Sin selección</span>`;
        }
        tr.appendChild(tdDesc);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrap.appendChild(table);

      host.appendChild(wrap);
    });
  }

  function buildReport(){
    const header = getHeaderData();
    const extra = getExtraFields();
    const total = computeTotal();

    $("rTitle").textContent =
      (header.tipo === "autoevaluacion")
        ? "Autoevaluación del desempeño"
        : (header.tipo === "clientes")
          ? "Evaluación de clientes"
          : "Evaluación del desempeño";

    $("rGenerated").textContent = new Date().toLocaleString();

    $("rNoPersonal").textContent = header.no_personal || "—";
    $("rNombre").textContent = header.nombre || "—";
    $("rPosicion").textContent = header.posicion || "—";
    $("rDepartamento").textContent = header.departamento || "—";
    $("rPeriodo").textContent = header.periodo || "—";
    $("rVersion").textContent = header.version || "—";
    $("rFecha").textContent = formatDateES(header.fecha);

    renderSeleccionEnReporte();
    $("rTotal").textContent = String(total);

    const comentarioColab =
      (header.tipo === "autoevaluacion")
        ? (extra.comentarios_colaborador || "")
        : (header.tipo === "desempeno")
          ? (extra.comentarios_colaborador || "")
          : "";

    if(comentarioColab){
      $("rComentariosBlock").style.display = "block";
      $("rComentarios").textContent = comentarioColab;
    }else{
      $("rComentariosBlock").style.display = "none";
      $("rComentarios").textContent = "—";
    }

    if(header.tipo === "desempeno"){
      $("rJustifBlock").style.display = "block";
      const txt = [
        `Justificación calificaciones (1-6): ${extra.justificacion || "—"}`,
        `Comentarios del evaluador: ${extra.comentarios_evaluador || "—"}`,
        `Fortalezas: ${extra.fortalezas || "—"}`,
        `Oportunidades de mejora: ${extra.oportunidades_mejora || "—"}`,
        `Proyección y potencial: ${extra.proyeccion_potencial || "—"}`
      ].join("\n\n");
      $("rJustifAll").textContent = txt;
    }else{
      $("rJustifBlock").style.display = "none";
      $("rJustifAll").textContent = "—";
    }

    $("printArea").style.display = "block";
  }

  function applyTipoUI(){
    const tipo = $("tipoFormulario").value;

    $("appTitle").textContent =
      tipo === "autoevaluacion" ? "Formulario de autoevaluación del desempeño" :
      tipo === "clientes" ? "Formulario de evaluación de clientes" :
      "Formulario de evaluación del desempeño";

    $("autoComentariosBox").style.display = (tipo === "autoevaluacion") ? "block" : "none";
    $("desempenoCamposBox").style.display = (tipo === "desempeno") ? "block" : "none";
    $("clientesBox").style.display = (tipo === "clientes") ? "block" : "none";
  }

  function clearForm(){
    $("noPersonal").value = "";
    $("nombre").value = "";
    $("posicion").value = "";
    $("departamento").value = "";
    $("periodo").value = "";
    $("version").value = "";
    $("fecha").value = "";

    $("comentariosColaborador").value = "";
    $("justificacion").value = "";
    $("comentariosEvaluador").value = "";
    $("fortalezas").value = "";
    $("oportunidades").value = "";
    $("proyeccion").value = "";
    $("comentariosColaborador2").value = "";

    state.answers = {};
    ITEMS.forEach(sec=>sec.items.forEach(it=>{
      const el = $("ans_"+it.key);
      if(el) el.value = "";
    }));

    $("printArea").style.display = "none";
    state.generated = false;
    setDirty(false);
  }

  function flattenAnswers(){
    const out = {};
    ITEMS.forEach(sec=>sec.items.forEach(it=>{
      out[it.key] = (typeof state.answers[it.key] === "number") ? state.answers[it.key] : (state.answers[it.key] || "");
    }));
    return out;
  }

  /************************************************************
   * ✅ form-urlencoded (evita CORS desde GitHub Pages)
   ************************************************************/
  function toFormUrlEncoded(obj){
    return Object.keys(obj)
      .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(obj[k] ?? ""))
      .join("&");
  }

  function buildComentariosParaSheet(tipo, extra){
    if(tipo === "autoevaluacion"){
      return extra.comentarios_colaborador || "";
    }
    if(tipo === "desempeno"){
      // Si en tu sheet SOLO tienes "Comentarios del colaborador", acá mandamos un resumen único
      return [
        extra.comentarios_evaluador ? `Comentarios evaluador: ${extra.comentarios_evaluador}` : "",
        extra.fortalezas ? `Fortalezas: ${extra.fortalezas}` : "",
        extra.oportunidades_mejora ? `Oportunidades: ${extra.oportunidades_mejora}` : "",
        extra.proyeccion_potencial ? `Proyección: ${extra.proyeccion_potencial}` : "",
        extra.comentarios_colaborador ? `Comentarios colaborador: ${extra.comentarios_colaborador}` : ""
      ].filter(Boolean).join("\n\n");
    }
    return "";
  }

  /************************************************************
   * ✅ CLAVE: construir payload con campos planos por columna
   *     (esto es lo que hace que "sí llene" la hoja)
   ************************************************************/
  function buildFlatPayload(header, answers, extra, total){
    const payload = {
      // Datos base (típicos en Apps Script)
      no_personal: header.no_personal,
      nombre: header.nombre,
      posicion: header.posicion,
      departamento: header.departamento,
      periodo: header.periodo,
      version: header.version,
      fecha: header.fecha,

      // Comentarios (columna final en tu sheet)
      comentarios: buildComentariosParaSheet(header.tipo, extra),

      // Total por si lo quieres guardar (si tu script lo ignora, no pasa nada)
      puntaje_total: total
    };

    // Puntajes por columna (A_metas, B_eficiencia, etc.)
    Object.keys(answers).forEach(k => {
      payload[k] = answers[k] ?? "";
    });

    // Respaldo completo en JSON (si tu Apps Script tiene columna respuestas_json)
    payload.respuestas_json = JSON.stringify({
      header,
      answers,
      extra,
      puntaje_total: total,
      creado_en: new Date().toISOString()
    });

    return payload;
  }

  async function saveToSheet(){
    const header = getHeaderData();
    if(!header.no_personal || !header.nombre){
      alert("Completa al menos No. de personal y Nombre.");
      return;
    }

    const extra = getExtraFields();
    const answers = flattenAnswers();
    const total = computeTotal();

    const formPayload = buildFlatPayload(header, answers, extra, total);

    // Debug (F12 -> Console)
    console.log("Enviando a Apps Script (payload):", formPayload);

    try{
      $("apiHint").className = "warn";
      $("apiHint").textContent = "Enviando a Google Sheets...";

      const body = toFormUrlEncoded(formPayload);

      // En GitHub Pages, lo más estable es no-cors (igual guarda)
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body
      });

      $("apiHint").className = "ok";
      $("apiHint").textContent = "Enviado a Google Sheets ✅ (revisa la fila en tu hoja)";
      setDirty(false);

    }catch(err){
      console.error(err);
      $("apiHint").className = "err";
      $("apiHint").textContent = "Error al guardar: " + (err.message || err);
      alert("Error al guardar en Google Sheets: " + (err.message || err));
    }
  }

  function bind(){
    [
      "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
      "comentariosColaborador","justificacion","comentariosEvaluador","fortalezas",
      "oportunidades","proyeccion","comentariosColaborador2"
    ].forEach(id=>{
      $(id).addEventListener("input", ()=> setDirty(true));
      $(id).addEventListener("change", ()=> setDirty(true));
    });

    $("tipoFormulario").addEventListener("change", ()=>{
      applyTipoUI();
      setDirty(true);
    });

    $("btnNew").addEventListener("click", ()=>{
      if(state.dirty && !confirm("Hay cambios sin guardar. ¿Crear nuevo de todas formas?")) return;
      clearForm();
    });

    $("btnSave").addEventListener("click", saveToSheet);

    $("btnGenerate").addEventListener("click", ()=>{
      buildReport();
      state.generated = true;
      setDirty(true);
    });

    $("btnPrint").addEventListener("click", ()=>{
      if(!state.generated){
        buildReport();
        state.generated = true;
      }
      window.print();
    });
  }

  // Init
  renderItems();
  applyTipoUI();
  bind();
  setDirty(false);
</script>
