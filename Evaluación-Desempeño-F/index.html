<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluaci√≥n del desempe√±o</title>
  <style>
    :root{
      --bg:#050a14;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --brand:#2f7bff;
      --brand2:#4aa3ff;
      --ok:#23c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 700px at 30% -10%, rgba(47,123,255,.25), transparent 60%),
                  radial-gradient(900px 650px at 70% 20%, rgba(124,58,237,.18), transparent 55%),
                  linear-gradient(180deg, #040816, #02040b 60%);
      color:var(--text);
    }
    .wrap{max-width:1180px; margin:28px auto; padding:0 18px 80px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px; border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      position:sticky; top:12px; z-index:20;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px; height:46px; border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(47,123,255,.95), rgba(74,163,255,.85));
      font-weight:800;
      letter-spacing:.5px;
    }
    .titles h1{margin:0; font-size:20px}
    .titles p{margin:2px 0 0; font-size:13px; color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:10px; height:10px; border-radius:50%;}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:10px 16px;
      font-weight:650;
      cursor:pointer;
      transition:.15s transform, .15s background;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.09)}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 26px rgba(47,123,255,.25);
    }
    .btn.ghost{background:transparent}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      margin-top:16px;
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      padding:18px;
    }
    .card h2{margin:0 0 6px; font-size:18px;}
    .card p{margin:0; color:var(--muted); font-size:13px}
    .form-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .form-grid{grid-template-columns: 1fr}
      .actions{justify-content:flex-end}
    }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      outline:none;
      color:var(--text);
      background: rgba(0,0,0,.25);
    }
    textarea{min-height:90px; resize:vertical}
    .section-title{
      display:flex; align-items:center; justify-content:space-between;
      margin:14px 0 8px;
    }
    .section-title h3{margin:0; font-size:16px}
    .muted{color:var(--muted)}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:16px 0;}

    /* ===== Reporte (para impresi√≥n) ===== */
    .print-area{margin-top:20px; display:none;}
    .report{
      background:#fff;
      color:#111;
      border-radius:18px;
      padding:20px;
      border:1px solid #e8e8e8;
    }
    .report-head{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      margin-bottom:10px;
    }
    .report-head h1{margin:0; font-size:34px; letter-spacing:.2px;}
    .report-head .small{font-size:12px; color:#444; text-align:right;}
    .report-sub{margin:0 0 14px; color:#444}
    .report-kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .kv-row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .kv{
      border:1px solid #e6e6e6;
      padding:10px 12px;
      border-radius:12px;
    }
    .kv .k{font-size:11px; color:#666; margin-bottom:3px}
    .kv .v{font-size:13px; font-weight:650}

    .rubric{
      width:100%;
      border-collapse:collapse;
      margin:12px 0 18px;
      table-layout:fixed;
    }
    .rubric th, .rubric td{
      border:1px solid #e6e6e6;
      padding:8px 8px;
      vertical-align:top;
      font-size:11px;
      word-wrap:break-word;
      white-space:pre-wrap;
    }
    .rubric th{background:#f7f7f7; text-align:left}
    .rubric .col-item{width:22%;}
    .rubric .col-score{width:12%;}
    .rubric .picked{
      outline:2px solid #2f7bff;
      outline-offset:-2px;
      background:#eef5ff;
      font-weight:700;
    }
    .rubric .selBadge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#111;
      color:#fff;
      font-size:11px;
      font-weight:700;
    }

    .block{margin-top:14px;}
    .block h2{margin:0 0 6px; font-size:15px;}
    .block .box{
      border:1px solid #e6e6e6;
      border-radius:12px;
      padding:10px 12px;
      min-height:48px;
      font-size:12px;
      white-space:pre-wrap;
    }

    @media print{
      body{background:#fff}
      .wrap{max-width:none; margin:0; padding:0}
      .topbar, .no-print{display:none !important}
      .print-area{display:block !important}
      .report{border:none; border-radius:0; padding:0}
    }

    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .warn{color:#ffd28b}
    .ok{color:#9dffb6}
    .err{color:#ffb4b4}

    /* Fecha con bot√≥n de calendario */
    .date-wrap{display:flex; gap:10px; align-items:center;}
    .date-wrap input{flex:1}
    .date-btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      font-weight:650;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar no-print">
      <div class="brand">
        <div class="logo">ED</div>
        <div class="titles">
          <h1 id="appTitle">Formulario de evaluaci√≥n del desempe√±o</h1>
          <p>Escala 1‚Äì5 ‚Ä¢ C√°lculo interno ‚Ä¢ Guardado en Google Sheets ‚Ä¢ Reporte listo para PDF</p>
        </div>
      </div>
      <div class="actions">
        <div class="pill" title="Estado">
          <span class="dot" id="stateDot" style="background: var(--ok)"></span>
          <span id="stateText">Sin cambios</span>
        </div>
        <button class="btn ghost" id="btnNew" type="button">Nuevo</button>
        <button class="btn primary" id="btnSave" type="button">Guardar</button>
        <button class="btn primary" id="btnGenerate" type="button">Generar</button>
        <button class="btn" id="btnPrint" type="button">Imprimir / Enviar a PDF</button>
      </div>
    </div>

    <div class="grid no-print">

      <!-- Tipo de formulario -->
      <div class="card">
        <h2>Tipo de formulario</h2>
        <p>Selecciona el tipo para mostrar/ocultar campos autom√°ticamente.</p>
        <div class="form-grid" style="grid-template-columns: 1fr;">
          <div>
            <label>Tipo</label>
            <select id="tipoFormulario">
              <option value="autoevaluacion">Formulario de autoevaluaci√≥n</option>
              <option value="desempeno" selected>Formulario de evaluaci√≥n del desempe√±o</option>
              <option value="clientes">Evaluaci√≥n de clientes</option>
            </select>
            <div class="hint">Tip: esto solo cambia qu√© campos aparecen. El guardado siempre va a Google Sheets.</div>
          </div>
        </div>
      </div>

      <!-- Datos del colaborador -->
      <div class="card">
        <h2>Datos del colaborador</h2>
        <p>Completa la informaci√≥n y selecciona una opci√≥n (1‚Äì5) para cada √≠tem.</p>

        <div class="form-grid">
          <div>
            <label>No. de personal</label>
            <input id="noPersonal" placeholder="Ej. 1600" />
          </div>
          <div>
            <label>Nombre</label>
            <input id="nombre" placeholder="Ej. Carlos Paz" />
          </div>
          <div>
            <label>Posici√≥n</label>
            <input id="posicion" placeholder="Ej. Analista" />
          </div>
          <div>
            <label>Departamento</label>
            <input id="departamento" placeholder="Ej. Contabilidad" />
          </div>
          <div>
            <label>Periodo</label>
            <input id="periodo" placeholder="Ej. 2025" />
          </div>
          <div>
            <label>Versi√≥n</label>
            <input id="version" placeholder="Ej. 1" />
          </div>

          <!-- FECHA: calendario real -->
          <div>
            <label>Fecha</label>
            <div class="date-wrap">
              <input id="fecha" type="date" />
              <button class="date-btn" id="btnPickDate" type="button">üìÖ</button>
            </div>
          </div>
        </div>

        <div class="hint">
          Estado API: <span id="apiHint" class="warn">No configurada (pega la URL del Apps Script en el c√≥digo)</span>
        </div>
      </div>

      <!-- Evaluaci√≥n -->
      <div class="card">
        <div class="section-title">
          <h3>Evaluaci√≥n (Factores 1‚Äì5)</h3>
          <span class="muted">Selecciona una opci√≥n por √≠tem</span>
        </div>

        <div id="itemsContainer"></div>

        <!-- Campo SOLO para autoevaluaci√≥n -->
        <div id="autoComentariosBox" style="display:none; margin-top:14px;">
          <div class="divider"></div>
          <h3 style="margin:0 0 6px;">Comentarios del colaborador</h3>
          <p class="muted" style="margin:0 0 10px;">Incluye observaciones, ejemplos, mejoras o apoyo requerido.</p>
          <textarea id="comentariosColaborador" placeholder="Comentarios del colaborador..."></textarea>
        </div>
      </div>

      <!-- Justificaci√≥n y comentarios (SOLO evaluaci√≥n del desempe√±o) -->
      <div class="card" id="desempenoCamposBox" style="display:none;">
        <h2>Justificaci√≥n y comentarios</h2>
        <p>Completa los campos siguientes (seg√∫n formato).</p>

        <div style="margin-top:14px;">
          <label>Justificaci√≥n calificaciones (1 - 6)</label>
          <textarea id="justificacion" placeholder="Describe la justificaci√≥n de las calificaciones..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Comentarios del evaluador</label>
          <textarea id="comentariosEvaluador" placeholder="Comentarios del evaluador..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Fortalezas</label>
          <textarea id="fortalezas" placeholder="Fortalezas..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Oportunidades de mejora</label>
          <textarea id="oportunidades" placeholder="Oportunidades de mejora..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Proyecci√≥n y potencial de desarrollo</label>
          <textarea id="proyeccion" placeholder="Proyecci√≥n y potencial..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <label>Comentarios del colaborador</label>
          <textarea id="comentariosColaborador2" placeholder="Comentarios del colaborador..."></textarea>
        </div>
      </div>

      <!-- Clientes (placeholder) -->
      <div class="card" id="clientesBox" style="display:none;">
        <h2>Evaluaci√≥n de clientes</h2>
        <p>Este modo puede reutilizar el mismo motor de √≠tems o tener su propia lista.</p>
        <div class="hint">Si quieres, luego lo dejamos con su propio set de preguntas.</div>
      </div>

    </div>

    <!-- Reporte (solo aparece al imprimir) -->
    <div class="print-area" id="printArea">
      <div class="report" id="report">
        <div class="report-head">
          <div>
            <h1 id="rTitle">Evaluaci√≥n del desempe√±o</h1>
            <p class="report-sub">Generado autom√°ticamente desde el formulario.</p>
          </div>
          <div class="small">
            <div><b>Generado:</b> <span id="rGenerated"></span></div>
          </div>
        </div>

        <!-- Layout solicitado -->
        <div class="report-kv">
          <div class="kv-row">
            <div class="kv"><div class="k">No. de personal</div><div class="v" id="rNoPersonal">‚Äî</div></div>
            <div class="kv"><div class="k">Nombre</div><div class="v" id="rNombre">‚Äî</div></div>
          </div>
          <div class="kv-row">
            <div class="kv"><div class="k">Posici√≥n</div><div class="v" id="rPosicion">‚Äî</div></div>
            <div class="kv"><div class="k">Departamento</div><div class="v" id="rDepartamento">‚Äî</div></div>
          </div>
          <div class="kv-row" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="kv"><div class="k">Periodo</div><div class="v" id="rPeriodo">‚Äî</div></div>
            <div class="kv"><div class="k">Versi√≥n</div><div class="v" id="rVersion">‚Äî</div></div>
            <div class="kv"><div class="k">Fecha</div><div class="v" id="rFecha">‚Äî</div></div>
          </div>
        </div>

        <!-- Aqu√≠ va la tabla tipo r√∫brica (como tus fotos) -->
        <div id="rRubrics"></div>

        <div class="block">
          <h2>Puntaje total</h2>
          <div class="box" id="rTotal">0.00</div>
        </div>

        <div class="block">
          <h2>Resumen de opciones elegidas</h2>
          <div class="box" id="rResumen">‚Äî</div>
        </div>

        <div class="block">
          <h2>Conclusiones</h2>
          <div class="box" id="rConclusiones">‚Äî</div>
        </div>

        <div class="block">
          <h2>Plan de capacitaci√≥n</h2>
          <div class="box" id="rCapacitacion">‚Äî</div>
        </div>

        <div class="block">
          <h2>Plan de carrera</h2>
          <div class="box" id="rCarrera">‚Äî</div>
        </div>

        <div class="block" id="rComentariosBlock" style="display:none;">
          <h2>Comentarios del colaborador</h2>
          <div class="box" id="rComentarios">‚Äî</div>
        </div>

        <div class="block" id="rJustifBlock" style="display:none;">
          <h2>Justificaci√≥n y comentarios (evaluaci√≥n del desempe√±o)</h2>
          <div class="box" id="rJustifAll">‚Äî</div>
        </div>
      </div>
    </div>

  </div>

<script>
  /************************************************************
   * 1) PEGA AQU√ç TU URL COMPLETA DEL APPS SCRIPT (/exec)
   *    Ejemplo:
   *    https://script.google.com/macros/s/AKfycb.../exec
   ************************************************************/
  const API_URL = "https://script.google.com/macros/s/PEGA_AQUI_TU_ID/exec";

  /************************************************************
   * 2) Cat√°logo de √≠tems + r√∫brica 1‚Äì5 (estructura tipo Excel)
   *    IMPORTANTE: aqu√≠ dej√© textos cortos para cada nivel.
   *    Si quieres, luego te los lleno EXACTO con tus descripciones completas.
   ************************************************************/
  const RUBRIC_DEFAULT = {
    1: "No cumple / Muy por debajo",
    2: "Bajo / Requiere mejora",
    3: "Aceptable / Cumple lo b√°sico",
    4: "Bueno / Supera expectativas",
    5: "Excelente / Referente"
  };

  const ITEMS = [
    {
      group: "1. Metas, productividad y eficiencia",
      items: [
        { key: "A_metas", label: "A. Cumplimiento de Metas. Grado de logro", rubric: {...RUBRIC_DEFAULT} },
        { key: "B_eficiencia", label: "B. Eficiencia en el uso del tiempo, costos y recursos", rubric: {...RUBRIC_DEFAULT} },
        { key: "C_seguridad", label: "C. Cumplimiento de normas de seguridad", rubric: {...RUBRIC_DEFAULT} },
        { key: "D_prioriza", label: "D. Prioriza y organiza tareas adecuadamente", rubric: {...RUBRIC_DEFAULT} },
        { key: "E_exactitud", label: "E. Exactitud y atenci√≥n al detalle", rubric: {...RUBRIC_DEFAULT} }
      ]
    },
    {
      group: "2. Calidad y mejora continua",
      items: [
        { key: "A_calidad", label: "A. Cumple con est√°ndares de calidad", rubric: {...RUBRIC_DEFAULT} },
        { key: "B_entregas", label: "B. Entregas a tiempo; cumple plazos establecidos", rubric: {...RUBRIC_DEFAULT} },
        { key: "C_mejora", label: "C. Manejo de errores y mejoras", rubric: {...RUBRIC_DEFAULT} }
      ]
    },
    {
      group: "3. Competencias y habilidades",
      items: [
        { key: "A_conocimientos", label: "A. Conocimientos t√©cnicos del puesto", rubric: {...RUBRIC_DEFAULT} },
        { key: "B_clientes", label: "B. Convincente respuesta t√©cnica a clientes", rubric: {...RUBRIC_DEFAULT} },
        { key: "C_problemas", label: "C. Resoluci√≥n de problemas", rubric: {...RUBRIC_DEFAULT} },
        { key: "D_iniciativa", label: "D. Iniciativa y creatividad", rubric: {...RUBRIC_DEFAULT} }
      ]
    },
    {
      group: "4. Actitud y valores",
      items: [
        { key: "A_responsabilidad", label: "A. Responsabilidad y compromiso", rubric: {...RUBRIC_DEFAULT} },
        { key: "B_puntualidad", label: "B. Puntualidad y asistencia", rubric: {...RUBRIC_DEFAULT} },
        { key: "C_trabajo", label: "C. Trabajo en equipo y cooperaci√≥n", rubric: {...RUBRIC_DEFAULT} },
        { key: "D_comunicacion", label: "D. Comunicaci√≥n efectiva", rubric: {...RUBRIC_DEFAULT} }
      ]
    },
    {
      group: "5. Desarrollo y potencial",
      items: [
        { key: "A_adaptacion", label: "A. Adaptaci√≥n al cambio", rubric: {...RUBRIC_DEFAULT} },
        { key: "B_aprender", label: "B. Disposici√≥n para aprender", rubric: {...RUBRIC_DEFAULT} },
        { key: "C_liderazgo", label: "C. Liderazgo", rubric: {...RUBRIC_DEFAULT} }
      ]
    }
  ];

  const SCALE = [
    { v: 1, t: "1 - No cumple / Muy por debajo" },
    { v: 2, t: "2 - Bajo / Requiere mejora" },
    { v: 3, t: "3 - Aceptable / Cumple lo b√°sico" },
    { v: 4, t: "4 - Bueno / Supera expectativas" },
    { v: 5, t: "5 - Excelente / Referente" }
  ];

  /************************************************************
   * 3) Estado UI
   ************************************************************/
  const state = { dirty:false, generated:false, answers:{} };
  const $ = (id) => document.getElementById(id);

  function setDirty(v){
    state.dirty = v;
    const dot = $("stateDot");
    const text = $("stateText");
    if(v){ dot.style.background = "var(--warn)"; text.textContent = "Cambios sin guardar"; }
    else{ dot.style.background = "var(--ok)"; text.textContent = "Sin cambios"; }
  }

  function apiConfigured(){
    return API_URL && API_URL.startsWith("https://script.google.com/macros/s/") && API_URL.endsWith("/exec");
  }

  function renderItems(){
    const container = $("itemsContainer");
    container.innerHTML = "";

    ITEMS.forEach(section => {
      const sec = document.createElement("div");
      sec.className = "card";
      sec.style.background = "rgba(0,0,0,.10)";
      sec.style.border = "1px dashed rgba(255,255,255,.10)";
      sec.style.marginTop = "14px";

      const h = document.createElement("h3");
      h.textContent = section.group;
      h.style.margin = "0 0 10px";
      sec.appendChild(h);

      section.items.forEach(it => {
        const row = document.createElement("div");
        row.style.display = "grid";
        row.style.gridTemplateColumns = "1.3fr .9fr";
        row.style.gap = "12px";
        row.style.padding = "10px 0";
        row.style.borderTop = "1px solid rgba(255,255,255,.08)";

        const left = document.createElement("div");
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = it.label;
        const sub = document.createElement("div");
        sub.className = "muted";
        sub.style.fontSize = "12px";
        sub.textContent = "Elige la descripci√≥n que mejor refleje el desempe√±o.";
        left.appendChild(title);
        left.appendChild(sub);

        const right = document.createElement("div");
        const lab = document.createElement("label");
        lab.textContent = "Respuesta";
        const sel = document.createElement("select");
        sel.id = "ans_" + it.key;

        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Seleccionar...";
        sel.appendChild(opt0);

        SCALE.forEach(s => {
          const o = document.createElement("option");
          o.value = String(s.v);
          o.textContent = s.t;
          sel.appendChild(o);
        });

        sel.addEventListener("change", () => {
          state.answers[it.key] = sel.value ? Number(sel.value) : null;
          setDirty(true);
        });

        right.appendChild(lab);
        right.appendChild(sel);

        row.appendChild(left);
        row.appendChild(right);
        sec.appendChild(row);
      });

      container.appendChild(sec);
    });
  }

  function getHeaderData(){
    return {
      tipo: $("tipoFormulario").value,
      no_personal: $("noPersonal").value.trim(),
      nombre: $("nombre").value.trim(),
      posicion: $("posicion").value.trim(),
      departamento: $("departamento").value.trim(),
      periodo: $("periodo").value.trim(),
      version: $("version").value.trim(),
      fecha: $("fecha").value
    };
  }

  function getExtraFields(){
    const tipo = $("tipoFormulario").value;

    if(tipo === "autoevaluacion"){
      return { comentarios_colaborador: $("comentariosColaborador").value.trim() };
    }

    if(tipo === "desempeno"){
      return {
        justificacion: $("justificacion").value.trim(),
        comentarios_evaluador: $("comentariosEvaluador").value.trim(),
        fortalezas: $("fortalezas").value.trim(),
        oportunidades_mejora: $("oportunidades").value.trim(),
        proyeccion_potencial: $("proyeccion").value.trim(),
        comentarios_colaborador: $("comentariosColaborador2").value.trim()
      };
    }

    return {};
  }

  function computeTotal(){
    const vals = Object.values(state.answers).filter(v => typeof v === "number");
    if(!vals.length) return 0;
    const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
    return +(avg * 20).toFixed(2);
  }

  function buildResumen(){
    const counts = {1:0,2:0,3:0,4:0,5:0};
    Object.values(state.answers).forEach(v=>{ if(typeof v === "number") counts[v]++; });
    const total = Object.values(counts).reduce((a,b)=>a+b,0);
    if(!total) return "‚Äî";
    return `Distribuci√≥n de puntajes: 1=${counts[1]}, 2=${counts[2]}, 3=${counts[3]}, 4=${counts[4]}, 5=${counts[5]}.`;
  }

  function autoConclusionsAndPlans(total){
    let conclusiones="", capacitacion="", carrera="";
    if(total >= 85){
      conclusiones="Desempe√±o sobresaliente. Mantener pr√°cticas actuales y asignar retos estrat√©gicos.";
      capacitacion="Capacitaci√≥n avanzada y certificaciones (especialidad del puesto). Mentoring a otros.";
      carrera="Plan de carrera acelerado: proyectos l√≠deres, rol senior o l√≠der de c√©lula seg√∫n vacantes.";
    } else if(total >= 70){
      conclusiones="Desempe√±o s√≥lido. Se observan oportunidades puntuales de mejora.";
      capacitacion="Capacitaci√≥n focalizada en brechas detectadas + seguimiento mensual.";
      carrera="Plan de carrera: objetivos por trimestre y rotaci√≥n en tareas clave.";
    } else if(total >= 55){
      conclusiones="Desempe√±o aceptable con brechas relevantes. Requiere plan de mejora estructurado.";
      capacitacion="Capacitaci√≥n b√°sica/intermedia + coaching del jefe + metas quincenales.";
      carrera="Plan de carrera conservador: consolidar base del puesto antes de crecer.";
    } else {
      conclusiones="Desempe√±o bajo. Se recomienda plan correctivo y acompa√±amiento cercano.";
      capacitacion="Entrenamiento esencial del puesto + refuerzo de h√°bitos (tiempo, calidad, comunicaci√≥n).";
      carrera="Plan de carrera en pausa hasta evidenciar mejora sostenida (60‚Äì90 d√≠as).";
    }
    return { conclusiones, capacitacion, carrera };
  }

  function renderRubricsToReport(){
    const host = $("rRubrics");
    host.innerHTML = "";

    ITEMS.forEach(sec => {
      const h = document.createElement("h2");
      h.style.margin = "18px 0 8px";
      h.style.fontSize = "15px";
      h.textContent = sec.group;
      host.appendChild(h);

      const table = document.createElement("table");
      table.className = "rubric";

      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      const thItem = document.createElement("th"); thItem.className="col-item"; thItem.textContent="√çtem";
      trh.appendChild(thItem);
      [1,2,3,4,5].forEach(n=>{
        const th=document.createElement("th"); th.className="col-score"; th.textContent=String(n);
        trh.appendChild(th);
      });
      const thSel=document.createElement("th"); thSel.style.width="10%"; thSel.textContent="Selecci√≥n";
      trh.appendChild(thSel);
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      sec.items.forEach(it=>{
        const v = state.answers[it.key];
        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        tdItem.textContent = it.label;
        tr.appendChild(tdItem);

        [1,2,3,4,5].forEach(n=>{
          const td=document.createElement("td");
          td.textContent = (it.rubric && it.rubric[n]) ? it.rubric[n] : "";
          if(typeof v === "number" && v === n) td.classList.add("picked");
          tr.appendChild(td);
        });

        const tdSel=document.createElement("td");
        tdSel.innerHTML = (typeof v === "number")
          ? `<span class="selBadge">${v}</span>`
          : "‚Äî";
        tr.appendChild(tdSel);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      host.appendChild(table);
    });
  }

  function buildReport(){
    const header = getHeaderData();
    const extra = getExtraFields();
    const total = computeTotal();
    const resumen = buildResumen();
    const plans = autoConclusionsAndPlans(total);

    $("rTitle").textContent =
      header.tipo === "autoevaluacion" ? "Autoevaluaci√≥n del desempe√±o" :
      header.tipo === "clientes" ? "Evaluaci√≥n de clientes" :
      "Evaluaci√≥n del desempe√±o";

    $("rGenerated").textContent = new Date().toLocaleString();

    $("rNoPersonal").textContent = header.no_personal || "‚Äî";
    $("rNombre").textContent = header.nombre || "‚Äî";
    $("rPosicion").textContent = header.posicion || "‚Äî";
    $("rDepartamento").textContent = header.departamento || "‚Äî";
    $("rPeriodo").textContent = header.periodo || "‚Äî";
    $("rVersion").textContent = header.version || "‚Äî";
    $("rFecha").textContent = header.fecha || "‚Äî";

    // Tabla tipo r√∫brica (como tus fotos)
    renderRubricsToReport();

    $("rTotal").textContent = String(total);
    $("rResumen").textContent = resumen;

    $("rConclusiones").textContent = plans.conclusiones;
    $("rCapacitacion").textContent = plans.capacitacion;
    $("rCarrera").textContent = plans.carrera;

    // ‚úÖ Comentarios del colaborador SIEMPRE seg√∫n el tipo
    let comentarioColab = "";
    if(header.tipo === "autoevaluacion") comentarioColab = (extra.comentarios_colaborador || "").trim();
    if(header.tipo === "desempeno") comentarioColab = (extra.comentarios_colaborador || "").trim();

    if(comentarioColab){
      $("rComentariosBlock").style.display = "block";
      $("rComentarios").textContent = comentarioColab;
    }else{
      $("rComentariosBlock").style.display = "none";
      $("rComentarios").textContent = "‚Äî";
    }

    // Bloque justificaci√≥n (solo desempe√±o)
    if(header.tipo === "desempeno"){
      $("rJustifBlock").style.display = "block";
      const txt = [
        `Justificaci√≥n calificaciones (1-6): ${extra.justificacion || "‚Äî"}`,
        `Comentarios del evaluador: ${extra.comentarios_evaluador || "‚Äî"}`,
        `Fortalezas: ${extra.fortalezas || "‚Äî"}`,
        `Oportunidades de mejora: ${extra.oportunidades_mejora || "‚Äî"}`,
        `Proyecci√≥n y potencial: ${extra.proyeccion_potencial || "‚Äî"}`,
        `Comentarios del colaborador: ${extra.comentarios_colaborador || "‚Äî"}`
      ].join("\n\n");
      $("rJustifAll").textContent = txt;
    }else{
      $("rJustifBlock").style.display = "none";
      $("rJustifAll").textContent = "‚Äî";
    }

    $("printArea").style.display = "block";
  }

  function applyTipoUI(){
    const tipo = $("tipoFormulario").value;

    $("appTitle").textContent =
      tipo === "autoevaluacion" ? "Formulario de autoevaluaci√≥n del desempe√±o" :
      tipo === "clientes" ? "Formulario de evaluaci√≥n de clientes" :
      "Formulario de evaluaci√≥n del desempe√±o";

    $("autoComentariosBox").style.display = (tipo === "autoevaluacion") ? "block" : "none";
    $("desempenoCamposBox").style.display = (tipo === "desempeno") ? "block" : "none";
    $("clientesBox").style.display = (tipo === "clientes") ? "block" : "none";
  }

  function clearForm(){
    $("noPersonal").value = "";
    $("nombre").value = "";
    $("posicion").value = "";
    $("departamento").value = "";
    $("periodo").value = "";
    $("version").value = "";
    $("fecha").value = "";

    $("comentariosColaborador").value = "";
    $("justificacion").value = "";
    $("comentariosEvaluador").value = "";
    $("fortalezas").value = "";
    $("oportunidades").value = "";
    $("proyeccion").value = "";
    $("comentariosColaborador2").value = "";

    state.answers = {};
    ITEMS.forEach(sec=>sec.items.forEach(it=>{
      const el = $("ans_"+it.key);
      if(el) el.value = "";
    }));

    $("printArea").style.display = "none";
    state.generated = false;
    setDirty(false);
  }

  function flattenAnswers(){
    const out = {};
    ITEMS.forEach(sec=>sec.items.forEach(it=>{
      out[it.key] = (typeof state.answers[it.key] === "number") ? state.answers[it.key] : "";
    }));
    return out;
  }

  async function saveToSheet(){
    if(!apiConfigured()){
      alert("Falta configurar la API_URL. Pega la URL completa del Apps Script (/exec) en el c√≥digo.");
      return;
    }

    const header = getHeaderData();
    if(!header.no_personal || !header.nombre){
      alert("Completa al menos No. de personal y Nombre.");
      return;
    }

    const payload = {
      ...header,
      ...flattenAnswers(),
      ...getExtraFields(),
      puntaje_total: computeTotal(),
      creado_en: new Date().toISOString()
    };

    try{
      $("apiHint").className = "ok";
      $("apiHint").textContent = "Enviando a Google Sheets...";

      const res = await fetch(API_URL, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=> ({}));
      if(!res.ok){
        throw new Error((data && data.error) ? data.error : ("HTTP " + res.status));
      }

      $("apiHint").className = "ok";
      $("apiHint").textContent = "Enviado a Google Sheets ‚úÖ (si no ves fila, revisa permisos del Web App)";
      setDirty(false);
      return data;
    }catch(err){
      console.error(err);
      $("apiHint").className = "err";
      $("apiHint").textContent = "Error al guardar: " + err.message;
      alert("Error al guardar en Google Sheets: " + err.message);
    }
  }

  function bind(){
    // API hint
    if(apiConfigured()){
      $("apiHint").className = "ok";
      $("apiHint").textContent = "API configurada ‚úÖ";
    }

    // Fecha: abrir calendario
    $("btnPickDate").addEventListener("click", ()=>{
      const el = $("fecha");
      if (el.showPicker) el.showPicker();  // Chrome/Edge
      else el.focus();                     // fallback
      setDirty(true);
    });

    // inputs dirty
    [
      "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
      "comentariosColaborador","justificacion","comentariosEvaluador","fortalezas",
      "oportunidades","proyeccion","comentariosColaborador2"
    ].forEach(id=>{
      $(id).addEventListener("input", ()=> setDirty(true));
      $(id).addEventListener("change", ()=> setDirty(true));
    });

    $("tipoFormulario").addEventListener("change", ()=>{
      applyTipoUI();
      setDirty(true);
    });

    $("btnNew").addEventListener("click", ()=>{
      if(state.dirty && !confirm("Hay cambios sin guardar. ¬øCrear nuevo de todas formas?")) return;
      clearForm();
    });

    $("btnSave").addEventListener("click", saveToSheet);

    $("btnGenerate").addEventListener("click", ()=>{
      buildReport();
      state.generated = true;
      setDirty(true);
    });

    $("btnPrint").addEventListener("click", ()=>{
      if(!state.generated){
        buildReport();
        state.generated = true;
      }
      window.print();
    });
  }

  // Init
  renderItems();
  applyTipoUI();
  bind();
  setDirty(false);
</script>
</body>
</html>
