<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluaci√≥n del desempe√±o</title>
  <style>
    :root{
      --bg:#050a14;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --brand:#2f7bff;
      --brand2:#4aa3ff;
      --ok:#23c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;

      --p-border:#e6e6e6;
      --p-gray:#f7f7f7;
      --p-ink:#111;
      --p-sub:#444;
      --p-hi:#dbeafe;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px 700px at 30% -10%, rgba(47,123,255,.25), transparent 60%),
        radial-gradient(900px 650px at 70% 20%, rgba(124,58,237,.18), transparent 55%),
        linear-gradient(180deg, #040816, #02040b 60%);
      color:var(--text);
      font-size: 14px;   /* üëà baja tama√±o general */
      line-height: 1.35; /* mantiene legible */
    }
    .wrap{max-width:1180px; margin:28px auto; padding:0 18px 80px}
     .wrap{ font-size: 1rem; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px; border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      position:sticky; top:12px; z-index:20; backdrop-filter: blur(10px);
      gap:14px;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px; height:46px; border-radius:14px; display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(47,123,255,.95), rgba(74,163,255,.85));
      font-weight:800; letter-spacing:.5px; flex:0 0 auto;
    }
    .titles h1{margin:0; font-size:20px}
    .titles p{margin:2px 0 0; font-size:13px; color:var(--muted)}
    /* ‚úÖ Header fijo (identidad del programa) */
.programTitle{
  margin:0;
  font-size:24px;
  font-weight:950;
  letter-spacing:.2px;
  line-height:1.15;
}

.programMeta{
  margin:6px 0 0;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  font-size:18px;
  color:rgba(234,240,255,.92);
  font-weight:850;
}

.metaPill{
  display:inline-flex;
  gap:8px;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(74,163,255,.35);
  background: rgba(74,163,255,.14);
  color: rgba(234,240,255,.95);
  font-weight:900;
  white-space:nowrap;
}
.metaPill .dot{
  width:9px; height:9px; border-radius:50%;
  background: var(--warn);
}   
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid var(--stroke);
      background:rgba(0,0,0,.22); color:var(--muted); font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:10px; height:10px; border-radius:50%;}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:10px 16px;
      font-weight:650;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s opacity;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.09)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 26px rgba(47,123,255,.25);
    }
    .btn.ghost{background:transparent}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px;}
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      padding:18px;
    }
    .card h2{margin:0 0 6px; font-size:18px;}
    .card p{margin:0; color:var(--muted); font-size:13px}
    .form-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-top:14px;
    }
    /* ‚úÖ Alineaci√≥n consistente de campos (Datos del colaborador) */
.form-grid{ align-items:start; }
.form-grid > div{
  display:flex;
  flex-direction:column;
  gap:6px;                 /* mismo ‚Äúritmo‚Äù vertical */
  min-width:0;
}

/* Labels consistentes (evita que el input ‚Äúbaje‚Äù en algunos campos) */
.form-grid label{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  min-height:22px;
}

/* Reservar un alto m√≠nimo para helpers (no ‚Äúempuja‚Äù unos s√≠ y otros no) */
.keyHelper{ min-height:16px; }

/* ‚úÖ Layout escritorio (4 columnas) */
@media (min-width: 981px){
  #fldNoPersonal  { grid-column: 1; }
  #fldNombre      { grid-column: 2 / span 2; }
  #fldPosicion    { grid-column: 4; }

  #fldDepartamento{ grid-column: 1; }
  #fldPeriodo     { grid-column: 2; }
  #fldVersion     { grid-column: 3; }
  #fldFecha       { grid-column: 4; }
}   
    @media (max-width: 980px){
      .form-grid{grid-template-columns: 1fr}
      .actions{justify-content:flex-end}
      .topbar{flex-wrap:wrap}
    }

    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(74,163,255,.55);
      box-shadow: 0 0 0 2px rgba(47,123,255,.18), 0 12px 30px rgba(47,123,255,.10);
      outline:none;
      color:var(--text);
      background: rgba(0,0,0,.25);
      font-size: 17px;       /* sube letra dentro de campos */
      line-height: 1.25;
    }

    /* ‚úÖ Realzar flecha del SELECT (Tipo de formulario) */
    /* ‚úÖ Realzar flecha del SELECT (Tipo de formulario) + c√≠rculo alrededor */
select{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  padding-right:62px; /* m√°s espacio para c√≠rculo + flecha */

  /* 2 fondos: 1) c√≠rculo (abajo) 2) flecha (arriba) */
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='34' height='34' viewBox='0 0 36 36'%3E%3Ccircle cx='18' cy='18' r='14.5' fill='rgba(0,0,0,0.25)' stroke='rgba(74,163,255,0.95)' stroke-width='2'/%3E%3C/svg%3E"),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%234aa3ff' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");

  background-repeat:no-repeat, no-repeat;

  /* ambos a la derecha, centrados verticalmente */
  background-position:
    right 12px center,
    right 20px center;

  /* tama√±o del c√≠rculo y de la flecha */
  background-size:
    32px 32px,
    18px 18px;
}

/* (Opcional pero bonito) al enfocar, que el c√≠rculo ‚Äúbrille‚Äù un poco */
select:focus{
  box-shadow: 0 0 0 3px rgba(74,163,255,.22), 0 12px 30px rgba(47,123,255,.12);
}

    textarea{min-height:90px; resize:vertical;}
    .section-title{display:flex; align-items:center; justify-content:space-between; margin:14px 0 8px;}
    .section-title h3{margin:0; font-size:16px}
    .muted{color:var(--muted)}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:16px 0;}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .warn{color:#ffd28b}
    .ok{color:#9dffb6}
    .err{color:#ffb4b4}

    .searchField label{ color: rgba(234,240,255,.92); font-weight: 800; letter-spacing: .2px; }
    .searchField input{
      border:1px solid rgba(74,163,255,.55);
      box-shadow: 0 0 0 2px rgba(47,123,255,.15), 0 12px 30px rgba(47,123,255,.10);
    }
/* ‚úÖ KEY FIELDS (Llaves para Recuperar) */
.keyLookupField{
  position: relative;
  padding: 12px;
  border-radius: 16px;
  border: 1px solid rgba(74,163,255,.40);
  background: linear-gradient(180deg, rgba(47,123,255,.12), rgba(0,0,0,.08));
  box-shadow: 0 0 0 2px rgba(74,163,255,.12), 0 18px 45px rgba(47,123,255,.10);
}

.keyLookupField::before{
  content:"";
  position:absolute;
  left:10px; top:12px; bottom:12px;
  width:4px;
  border-radius:999px;
  background: linear-gradient(180deg, rgba(74,163,255,.95), rgba(47,123,255,.35));
  opacity:.9;
}

.keyLookupField label{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-weight: 950;
  color: rgba(234,240,255,.96);
  letter-spacing: .2px;
}

.keyTag{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(74,163,255,.35);
  background: rgba(74,163,255,.14);
  color: rgba(234,240,255,.92);
  font-size: 11px;
  font-weight: 900;
  white-space: nowrap;
}

.keyLookupField input{
  border:1px solid rgba(74,163,255,.78) !important;
  box-shadow: 0 0 0 3px rgba(74,163,255,.20), 0 18px 45px rgba(47,123,255,.14) !important;
}

.keyHelper{
  margin-top:8px;
  font-size:12px;
  color: rgba(234,240,255,.72);
}
    
    .searchBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(47,123,255,.18);
      border:1px solid rgba(74,163,255,.35);
      color:rgba(234,240,255,.90);
      font-size:12px; font-weight:750;
    }
    .searchBadge .dot{background: rgba(74,163,255,.95);}

    /* ‚úÖ Realce de campos solicitados */
    .highlightField label{ color: rgba(234,240,255,.96); font-weight: 900; letter-spacing: .15px; }
    .highlightField textarea, .highlightField input{
      border:1px solid rgba(74,163,255,.70);
      box-shadow: 0 0 0 2px rgba(47,123,255,.18), 0 12px 30px rgba(47,123,255,.12);
    }
    .highlightBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(74,163,255,.14);
      border:1px solid rgba(74,163,255,.30);
      color:rgba(234,240,255,.92);
      font-size:12px; font-weight:900;
      margin-top:10px;
    }
    .highlightBadge .dot{background: rgba(74,163,255,.95);}

    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center; justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .modal{
      width:min(1100px, 96vw);
      max-height: min(86vh, 900px);
      overflow:auto;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
    }
    .modal-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:16px 16px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.05));
      backdrop-filter: blur(10px);
      z-index:2;
    }
    .modal-title{ margin:0; font-size:16px; font-weight:900; }
    .modal-sub{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .modal-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .tag-ok{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: rgba(234,240,255,.90);
      font-size:12px; font-weight:800;
    }
    .tag-ok .dot{background: var(--ok);}

    .modal-body{padding:14px 16px 18px;}
    .mini-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .mini-table th, .mini-table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      vertical-align:top;
      font-size:13px;
      word-wrap:break-word;
    }
    .mini-table th{
      background: rgba(0,0,0,.20);
      text-align:left;
      font-weight:900;
      font-size:12px;
      color: rgba(234,240,255,.85);
    }
    .mini-table tr:last-child td{border-bottom:none;}
    .col-k{width:34%; font-weight:800;}
    .col-v{width:auto;}

    .items-table{
      margin-top:14px;
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .items-table th, .items-table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      font-size:12px;
      vertical-align:top;
      word-wrap:break-word;
    }
    .items-table th{
      background: rgba(0,0,0,.20);
      font-weight:900;
      color: rgba(234,240,255,.85);
      text-align:left;
    }
    .items-table tr:last-child td{border-bottom:none;}
    .it-col1{width:26%;}
    .it-col2{width:30%;}
    .it-col3{width:10%; text-align:center; font-weight:900;}
    .it-col4{width:auto;}
    .group-row td{
      background: rgba(255,255,255,.06);
      font-weight:950;
      color: rgba(234,240,255,.92);
    }

    .lookup-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px; }
    @media (max-width: 980px){ .lookup-grid{grid-template-columns: 1fr} }
    .lookup-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    .small-muted{font-size:12px; color:var(--muted)}
    .results-wrap{margin-top:14px;}
    .results-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .results-table th,.results-table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      font-size:12px;
      vertical-align:top;
      word-wrap:break-word;
    }
    .results-table th{
      background: rgba(0,0,0,.20);
      font-weight:900;
      color: rgba(234,240,255,.85);
      text-align:left;
    }
    .results-table tr:last-child td{border-bottom:none;}
    .r-col-act{width:190px; text-align:center;}
    .r-col-row{width:90px; text-align:center; font-weight:900;}
    .r-col-np{width:130px;}
    .r-col-per{width:110px;}
    .r-col-ver{width:90px; text-align:center;}
    .r-col-fecha{width:130px;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: rgba(234,240,255,.88);
      font-weight:750;
    }

    .print-area{margin-top:20px; display:none;}
    .report{
      background:#fff;
      color:var(--p-ink);
      border-radius:18px;
      padding:20px;
      border:1px solid #e8e8e8;
    }
    .report-head{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      margin-bottom:10px;
    }
    .report-head h1{margin:0; font-size:32px; letter-spacing:.2px;}
    .report-head .small{font-size:12px; color:var(--p-sub); text-align:right;}
    .report-sub{margin:0 0 14px; color:var(--p-sub)}
    .report-kv{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;}
    .kv-row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .kv{border:1px solid var(--p-border); padding:10px 12px; border-radius:12px;}
    .kv .k{font-size:11px; color:#666; margin-bottom:3px}
    .kv .v{font-size:13px; font-weight:650}

    .rubric-wrap{margin-top:14px;}
    .rubric-title{margin:0 0 6px; font-size:15px; color:var(--p-ink); font-weight:800;}
    .sel-table{width:100%; border-collapse:collapse; table-layout:fixed; border:1px solid var(--p-border);}
    .sel-table th, .sel-table td{border:1px solid var(--p-border); padding:8px 8px; vertical-align:top; font-size:11px; word-wrap:break-word;}
    .sel-table th{background:var(--p-gray); text-align:left; font-weight:800; font-size:11px;}
    .col-item{width:32%; font-weight:700;}
    .col-score{width:10%; text-align:center; font-weight:800;}
    .col-desc{width:auto;}
    .muted-print{color:#555

          .preview-list{
      margin:10px 0 0;
      padding-left:18px;
      color: rgba(234,240,255,.88);
    }
    .preview-title{
      margin:12px 0 6px;
      font-weight:950;
      color: rgba(234,240,255,.95);
    }
    .preview-note{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
    }

    .block{margin-top:14px;}
    .block h2{margin:0 0 6px; font-size:15px;}
    .block .box{
      border:1px solid var(--p-border);
      border-radius:12px;
      padding:10px 12px;
      min-height:48px;
      font-size:12px;
      white-space:pre-wrap;
    }

    @media print{
      body{background:#fff}
      .wrap{max-width:none; margin:0; padding:0}
      .topbar, .no-print, .modal-backdrop{display:none !important}
      .print-area{display:block !important}
      .report{border:none; border-radius:0; padding:0}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar no-print">
      <div class="brand">
        <div class="logo">ED</div>
        <div class="titles">
  <h1 class="programTitle">Proceso de evaluaci√≥n del desempe√±o</h1>
  <div class="programMeta">
    <span class="metaPill">
      <span class="dot"></span>
      Empresa: <b>No Implementado</b>
    </span>

    <span class="metaPill" style="background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12);">
      Versi√≥n: <b>Prueba</b>
    </span>
  </div>
</div>
      </div>

      <div class="actions">
        <div class="pill" title="Estado">
          <span class="dot" id="stateDot" style="background: var(--ok)"></span>
          <span id="stateText">Sin cambios</span>
        </div>
        <button class="btn primary" id="btnNew" type="button">Nuevo</button>

        <!-- ‚úÖ Recuperar SOLO existe en Desempe√±o -->
        <button class="btn primary" id="btnRecover" type="button" style="display:none;">Recuperar</button>

        <button class="btn primary" id="btnGenerate" type="button">Generar</button>
        <button class="btn primary" id="btnSave" type="button">Guardar</button>
        <button class="btn" id="btnPrint" type="button">Imprimir / Enviar a PDF</button>
      </div>
    </div>

    <div class="grid no-print">
      
      <div class="card">
        <h2>Tipo de formulario</h2>
        <p>Selecciona el tipo para mostrar/ocultar campos autom√°ticamente.</p>

        <div class="form-grid" style="grid-template-columns: 1fr;">
          <div>
            <label>Fase</label>
            <select id="tipoFormulario">
            <option value="autoevaluacion" selected>Formulario de autoevaluaci√≥n</option>
            <option value="clientes">Formulario evaluaci√≥n clientes</option>
            <option value="desempeno">Formulario de evaluaci√≥n del desempe√±o</option>
            <option value="resumen_ia">Resumen IA (Reporte ejecutivo)</option>
            </select>

            <div class="hint">El guardado siempre va a Google Sheets (Web App de Apps Script).</div>
          </div>
        </div>
      </div>
      <div class="card" id="formPreviewCard">
        <h2>Campos e √≠tems del formulario</h2>
        <p>Vista r√°pida de lo que se solicita seg√∫n el tipo seleccionado.</p>
        <div id="formPreview"></div>
        <div class="hint">Tip: esto es solo visualizaci√≥n; la validaci√≥n real sigue en ‚ÄúGuardar‚Äù.</div>
      </div>
      
      <div class="card">
        <h2>Datos del colaborador</h2>
        <p>
          Completa la informaci√≥n y selecciona una opci√≥n (1‚Äì5) para cada √≠tem.
          &nbsp;&nbsp;
          <span id="searchBadgeWrap" style="display:none;">
            <span class="searchBadge"><span class="dot"></span>Campos de b√∫squeda: No. personal ‚Ä¢ Periodo ‚Ä¢ Versi√≥n</span>
          </span>
        </p>
        <div class="form-grid">
         <div id="fldNoPersonal">
         <label>No. de personal</label>
         <input id="noPersonal" placeholder="Ej. 1600" />
        </div>

         <div id="fldNombre">
            <label>Nombre</label>
          <input id="nombre" placeholder="Ej. Carlos Paz" />
          </div>
           <div id="fldPosicion">
           <label>Posici√≥n</label>
          <input id="posicion" placeholder="Ej. Analista" />
          </div>
          <div id="fldDepartamento">
           <label>Departamento</label>
            <input id="departamento" placeholder="Ej. Contabilidad" />
            </div>
          <div id="fldPeriodo">
          <label>Periodo</label>
           <input id="periodo" placeholder="Ej. 2025" />
           </div>
          <div id="fldVersion">
           <label>Versi√≥n</label>
            <input id="version" placeholder="Ej. 1" />
            </div>
          <div id="fldFecha">
         <label>Fecha</label>
          <input id="fecha" type="date" />
          </div>
        </div>

        <div class="hint">Estado API: <span id="apiHint" class="warn">Verificando conexi√≥n‚Ä¶</span></div>
      </div>

      <div class="card" id="evalCard">
        <div class="section-title">
          <h3>Evaluaci√≥n (1‚Äì5)</h3>
          <span class="muted">Selecciona una opci√≥n por √≠tem</span>
        </div>
        <div id="itemsContainer"></div>

        <div id="autoComentariosBox" style="display:none; margin-top:14px;">
          <div class="divider"></div>
          <h3 style="margin:0 0 6px;">Comentarios del colaborador</h3>
          <p class="muted" style="margin:0 0 10px;">Incluye observaciones, ejemplos, mejoras o apoyo requerido.</p>
          <textarea id="comentariosColaborador" placeholder="Comentarios del colaborador..."></textarea>
        </div>
      </div>

    <div class="card" id="desempenoCamposBox" style="display:none;">
  <h2>Justificaci√≥n y comentarios</h2>
  <p>Completa los campos siguientes (seg√∫n formato).</p>

  <div class="highlightBadge">
    <span class="dot"></span>
    Campos realzados: Justificaci√≥n ‚Ä¢ Comentarios ‚Ä¢ Fortalezas ‚Ä¢ Oportunidades ‚Ä¢ Proyecci√≥n ‚Ä¢ Evaluaci√≥n clientes ‚Ä¢ Necesidades de capacitaci√≥n ‚Ä¢ Nombre del evaluador ‚Ä¢ Mail1 ‚Ä¢ Mail2
  </div>

  <div style="margin-top:14px;" class="highlightField">
    <label>Justificaci√≥n calificaciones (1 - 5)</label>
    <textarea id="justificacion" placeholder="Describe la justificaci√≥n de las calificaciones..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Comentarios del evaluador</label>
    <textarea id="comentariosEvaluador" placeholder="Comentarios del evaluador..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Fortalezas</label>
    <textarea id="fortalezas" placeholder="Fortalezas..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Oportunidades de mejora</label>
    <textarea id="oportunidades" placeholder="Oportunidades de mejora..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Proyecci√≥n y potencial de desarrollo</label>
    <textarea id="proyeccion" placeholder="Proyecci√≥n y potencial..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Necesidades de capacitaci√≥n</label>
    <textarea id="necesidadesCapacitacion" placeholder="Necesidades de capacitaci√≥n..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Comentarios del colaborador</label>
    <textarea id="comentariosColaborador2" placeholder="Comentarios del colaborador..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Evaluaci√≥n clientes (autollenado desde hoja Clientes)</label>
    <textarea id="evaluacionClientes" placeholder="Evaluaci√≥n clientes..."></textarea>
    <div class="hint">Al recuperar (desempe√±o), se autocompleta con retroalimentaci√≥n y nombre del evaluador (si existe).</div>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Nombre del evaluador</label>
    <input id="nombreEvaluadorDesempeno" type="text" placeholder="Ej. Daniel Coello" />
  </div>

  <!-- ‚úÖ NUEVO: Mail1 / Mail2 (ya los est√°s leyendo en JS, aqu√≠ los hacemos visibles) -->
  <div style="margin-top:12px;" class="highlightField">
    <label>Mail1 (Evaluador)</label>
    <input id="mail1" type="email" placeholder="ej. evaluador@empresa.com" />
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Mail2 (Evaluado)</label>
    <input id="mail2" type="email" placeholder="ej. rrhh@empresa.com" />
  </div>
</div>
    </div>

  <div class="lookup-actions" style="margin-top:12px;">
    <button class="btn primary" id="btnResumenIA" type="button">Generar Resumen IA</button>
    <span class="small-muted" id="iaStatus">Listo.</span>
  </div>

  <div style="margin-top:14px;" class="highlightField">
    <label>Puntaje (desde Evaluaciones Resultados)</label>
    <input id="iaPuntaje" type="text" placeholder="Se autocompleta..." />
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Resumen</label>
    <textarea id="iaResumen" placeholder="Se generar√° autom√°ticamente..."></textarea>
  </div>
<div class="card" id="resumenIaBox" style="display:none;">
  <h2>Resumen IA (Reporte ejecutivo)</h2>

  <p>
    En esta fase el sistema genera un reporte ejecutivo autom√°ticamente
    utilizando √∫nicamente las llaves del colaborador:
    <b>No. de personal</b>, <b>Periodo</b> y <b>Versi√≥n</b>.
  </p>

  <div class="lookup-actions" style="margin-top:12px;">
    <button class="btn primary" id="btnResumenIA" type="button">
      Generar Resumen IA
    </button>
    <span class="small-muted" id="iaStatus">Listo.</span>
  </div>

  <!-- =====================================================
       CAMPOS IA INTERNOS (NO VISIBLES)
       - Se llenan desde Apps Script
       - Se usan para reporte flotante / PDF
       - NO se muestran en la UI
       ===================================================== -->
  <div style="display:none;">
    <input id="iaPuntaje" type="text" />

    <textarea id="iaResumen"></textarea>
    <textarea id="iaPlanCapacitacion"></textarea>
    <textarea id="iaPlanDesarrollo"></textarea>
    <textarea id="iaConclusiones"></textarea>
    <textarea id="iaRecomendaciones"></textarea>
  </div>
</div>


    
  <div style="margin-top:12px;" class="highlightField">
    <label>Plan de capacitaci√≥n</label>
    <textarea id="iaPlanCapacitacion" placeholder="Se generar√° autom√°ticamente..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Plan de desarrollo</label>
    <textarea id="iaPlanDesarrollo" placeholder="Se generar√° autom√°ticamente..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Conclusiones</label>
    <textarea id="iaConclusiones" placeholder="Se generar√° autom√°ticamente..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Recomendaciones</label>
    <textarea id="iaRecomendaciones" placeholder="Se generar√° autom√°ticamente..."></textarea>
  </div>
</div>
    
    <!-- ‚úÖ Modal Recuperar (queda, pero ahora Recuperar por llaves usa el modal de detalle) -->
    <div class="modal-backdrop" id="lookupBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lookupTitle">
        <div class="modal-head">
          <div>
            <div class="modal-title" id="lookupTitle">Recuperar registros (Desempe√±o)</div>
            <div class="modal-sub" id="lookupSub">Busca por No. personal / Nombre / Periodo / Versi√≥n y selecciona una fila para ver detalles.</div>
          </div>
          <div class="modal-actions">
            <button class="btn" id="btnCloseLookup" type="button">Cerrar</button>
          </div>
        </div>

        <div class="modal-body">
          <div class="card" style="padding:14px; background:rgba(0,0,0,.14)">
            <div class="lookup-grid">
              <div>
                <label>No. de personal</label>
                <input id="qNoPersonal" placeholder="Ej. 1600" />
              </div>
              <div>
                <label>Nombre (contiene)</label>
                <input id="qNombre" placeholder="Ej. Carlos" />
              </div>
              <div>
                <label>Periodo</label>
                <input id="qPeriodo" placeholder="Ej. 2025" />
              </div>
              <div>
                <label>Versi√≥n</label>
                <input id="qVersion" placeholder="Ej. 1" />
              </div>
            </div>

            <div class="lookup-actions">
              <button class="btn primary" id="btnSearch" type="button">Buscar</button>
              <button class="btn" id="btnClearSearch" type="button">Limpiar</button>
              <span class="small-muted" id="lookupStatus">Listo para buscar.</span>
            </div>

            <div class="hint">
              Tip: si llenas No. personal + Periodo + Versi√≥n, la b√∫squeda queda ‚Äúquir√∫rgica‚Äù.
              Si no, te devuelve una lista (m√°x. 50).
            </div>
          </div>

          <div class="results-wrap">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;">
              <div class="chip" id="chipCount">0 resultados</div>
              <div class="small-muted" id="chipNote"></div>
            </div>

            <table class="results-table" style="margin-top:10px;">
              <thead>
                <tr>
                  <th class="r-col-act">Acci√≥n</th>
                  <th class="r-col-row">Fila</th>
                  <th class="r-col-np">No. personal</th>
                  <th>Nombre</th>
                  <th class="r-col-per">Periodo</th>
                  <th class="r-col-ver">Versi√≥n</th>
                  <th class="r-col-fecha">Fecha</th>
                  <th>Departamento</th>

                  <!-- ‚úÖ SIEMPRE incluir Clientes -->
                  <th>Retroalimentaci√≥n (Clientes)</th>
                  <th>Evaluador (Clientes)</th>
                </tr>
              </thead>
              <tbody id="lookupResultsBody">
                <tr><td colspan="10" class="small-muted">Sin resultados a√∫n.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  <!-- ‚úÖ Modal Detalle Recuperado (Autollenar / Cerrar) -->
<div class="modal-backdrop" id="recoverBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="recoverTitle">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="recoverTitle">Registro encontrado</div>
        <div class="modal-sub" id="recoverSub">‚Äî</div>
      </div>

      <div class="modal-actions">
        <div class="tag-ok"><span class="dot"></span>Registro</div>

        <!-- ‚úÖ Solo 1 opci√≥n de Autollenar -->
        <button class="btn primary" id="btnApplyRecovered" type="button">Autollenar todo</button>

        <!-- ‚úÖ Cerrar en azul (igual que Autollenar) -->
        <button class="btn primary" id="btnCloseRecovered" type="button">Cerrar</button>
      </div>
    </div>

    <div class="modal-body">
      <div id="recoverKeyReport" style="margin-bottom:12px;"></div>

      <!-- ‚úÖ Tabla completa Encabezado/Valor -->
      <div id="recoverAllCols" style="margin-bottom:12px;"></div>

      <div id="recoverGeneral"></div>
      <div id="recoverItems"></div>
    </div>
  </div>
</div>

    <!-- ‚úÖ Modal Lookup (Lista de coincidencias / duplicados) -->
    <!-- ‚ö†Ô∏è FIX: este segundo modal ten√≠a IDs DUPLICADOS que romp√≠an Recuperar/Buscar.
         NO se elimina, solo se renombra para evitar colisi√≥n. -->
    <div class="modal-backdrop" id="lookupBackdrop2" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lookupTitle2">
        <div class="modal-head">
          <div>
            <div class="modal-title" id="lookupTitle2">Buscar registros (Autollenar desde Autoevaluaci√≥n)</div>
            <div class="modal-sub">Si hay duplicados, selecciona la fila correcta y luego Autollenar.</div>
          </div>
          <div class="modal-actions">
            <span class="pill" id="lookupStatus2">Listo para buscar.</span>
            <button class="btn" id="btnCloseLookup2" type="button">Cerrar</button>
          </div>
        </div>

        <div class="modal-body">
          <div class="grid2" style="margin-bottom:12px;">
            <div class="field">
              <label>No. personal</label>
              <input id="qNoPersonal2" type="text" placeholder="Ej: 1234" />
            </div>
            <div class="field">
              <label>Nombre</label>
              <input id="qNombre2" type="text" placeholder="Ej: Juan P√©rez" />
            </div>
            <div class="field">
              <label>Periodo</label>
              <input id="qPeriodo2" type="text" placeholder="Ej: 2025" />
            </div>
            <div class="field">
              <label>Versi√≥n</label>
              <input id="qVersion2" type="text" placeholder="Ej: V1" />
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
            <button class="btn primary" id="btnSearch2" type="button">Buscar</button>
            <button class="btn" id="btnClearSearch2" type="button">Limpiar</button>
            <div class="chip" id="chipCount2" style="margin-left:auto;">0 resultados</div>
          </div>

          <div class="small-muted" id="chipNote2" style="margin-bottom:10px;"></div>

          <table class="results-table" style="width:100%;">
            <thead>
              <tr>
                <th class="r-col-act">Acci√≥n</th>
                <th class="r-col-row">Fila</th>
                <th class="r-col-np">No. personal</th>
                <th>Nombre</th>
                <th class="r-col-per">Periodo</th>
                <th class="r-col-ver">Versi√≥n</th>
                <th class="r-col-fecha">Fecha</th>
                <th>Departamento</th>

                <!-- ‚úÖ SIEMPRE incluir Clientes -->
                <th>Retroalimentaci√≥n (Clientes)</th>
                <th>Evaluador (Clientes)</th>
              </tr>
            </thead>
            <tbody id="lookupResultsBody2">
              <tr><td colspan="10" class="small-muted">Sin resultados a√∫n.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚úÖ Modal Reporte Flotante -->
    <div class="modal-backdrop" id="reportBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reportTitleModal">
        <div class="modal-head">
          <div>
            <div class="modal-title" id="reportTitleModal">Reporte (vista previa)</div>
            <div class="modal-sub">Este reporte es flotante. Puedes imprimir / enviar a PDF.</div>
          </div>
          <div class="modal-actions">
            <button class="btn" id="btnCloseReport" type="button">Cerrar</button>
            <button class="btn primary" id="btnPrintFromModal" type="button">Imprimir / Enviar a PDF</button>
          </div>
        </div>

        <div class="modal-body">
          <div id="reportHost"></div>
        </div>
      </div>
    </div>

    <div class="print-area" id="printArea">
      <div class="report" id="report">
        <div class="report-head">
          <div>
            <h1 id="rTitle">Evaluaci√≥n del desempe√±o</h1>
            <p class="report-sub">Generado autom√°ticamente desde el formulario.</p>
          </div>
          <div class="small">
            <div><b>Generado:</b> <span id="rGenerated"></span></div>
          </div>
        </div>

        <div class="report-kv">
          <div class="kv-row">
            <div class="kv"><div class="k">No. de personal</div><div class="v" id="rNoPersonal">‚Äî</div></div>
            <div class="kv"><div class="k">Nombre</div><div class="v" id="rNombre">‚Äî</div></div>
          </div>
          <div class="kv-row">
            <div class="kv"><div class="k">Posici√≥n</div><div class="v" id="rPosicion">‚Äî</div></div>
            <div class="kv"><div class="k">Departamento</div><div class="v" id="rDepartamento">‚Äî</div></div>
          </div>
          <div class="kv-row" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="kv"><div class="k">Periodo</div><div class="v" id="rPeriodo">‚Äî</div></div>
            <div class="kv"><div class="k">Versi√≥n</div><div class="v" id="rVersion">‚Äî</div></div>
            <div class="kv"><div class="k">Fecha</div><div class="v" id="rFecha">‚Äî</div></div>
          </div>
        </div>

        <div id="rRubricas"></div>

        <div class="block">
          <h2>Puntaje total</h2>
          <div class="box" id="rTotal">0.00</div>
        </div>

        <div class="block" id="rComentariosBlock" style="display:none;">
          <h2>Comentarios del colaborador</h2>
          <div class="box" id="rComentarios">‚Äî</div>
        </div>

        <div class="block" id="rEvalClientesBlock" style="display:none;">
          <h2>Evaluaci√≥n clientes</h2>
          <div class="box" id="rEvalClientes">‚Äî</div>
        </div>

        <div class="block" id="rNombreEvalBlock" style="display:none;">
          <h2>Nombre del evaluador</h2>
          <div class="box" id="rNombreEvaluadorDesempeno">‚Äî</div>
        </div>

        <div class="block" id="rJustifBlock" style="display:none;">
          <h2>Justificaci√≥n y comentarios</h2>
          <div class="box" id="rJustifAll">‚Äî</div>
         </div>
        <div class="block" id="rResumenIaBlock" style="display:none;">
        <h2>Resumen IA (Reporte ejecutivo)</h2>
        <div class="box" id="rResumenIaAll">‚Äî</div>
        </div>
      </div>
    </div>

  </div>
<script>
/************************************************************
 * ‚úÖ FIX CR√çTICO:
 * - Eliminado <script> anidado (ten√≠as <script> dentro de otro <script>)
 * - Eliminado comentario HTML <!-- ... --> dentro del script
 *   (eso tambi√©n puede romper el JS)
 ************************************************************/

/************************************************************
 * 1) URL COMPLETA DEL APPS SCRIPT (/exec)
 ************************************************************/
const API_URL = "https://script.google.com/macros/s/AKfycbynufRRbwl1VMhkHPcwkUUK2XHBAqqGYqyzZSTuf-ZhphbB6mF7Bk3uD07noDuUhGeIeQ/exec";

function normalizeApiUrl(u){
  let x = String(u || "").trim();
  if(!x) return "";
  x = x.replace(/\/dev(\b|$)/i, "/exec");
  x = x.replace(/\s+/g, "");
  return x;
}
function assertApiUrl(){
  const u = normalizeApiUrl(API_URL);
  if(!u || !/^https?:\/\//i.test(u) || !/\/exec(\?|$)/i.test(u)){
    throw new Error("API_URL inv√°lida. Debe iniciar con https:// y terminar en /exec");
  }
}
function getApiCandidates(){
  const base = normalizeApiUrl(API_URL);
  const out = [];
  if(base) out.push(base);
  if(base && base.includes("?")) out.push(base.split("?")[0]);
  if(base && !base.includes("?")) out.push(base);
  return Array.from(new Set(out));
}
function makeCallbackName(){
  return "cb_" + Math.random().toString(36).slice(2);
}
function jsonpRequest(url, params){
  return new Promise((resolve, reject) => {
    const cbName = makeCallbackName();
    const script = document.createElement("script");
    script.async = true;

    const qs = new URLSearchParams({ ...params, callback: cbName, _ts: Date.now().toString() }).toString();
    const src = url + (url.includes("?") ? "&" : "?") + qs;
    script.src = src;

    let done = false;
    const timeout = setTimeout(() => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Timeout JSONP (no lleg√≥ callback). WebApp no p√∫blica (Anyone) o respuesta no ejecutable."));
    }, 25000);

    function cleanup(){
      clearTimeout(timeout);
      try{ delete window[cbName]; }catch(_){}
      if(script && script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = (data) => {
      if(done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    script.onerror = () => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Error de red (JSONP). Bloqueador/Firewall/DNS o endpoint inaccesible."));
    };

    document.body.appendChild(script);
  });
}

/* ‚úÖ NUEVO: fallback por fetch (si JSONP es bloqueado).
   - Intenta leer JSON directo
   - Si viene ‚Äúenvuelto‚Äù tipo callback(...), lo desenvuelve */
async function fetchRequest(url, params){
  const qs = new URLSearchParams({ ...params, _ts: Date.now().toString() }).toString();
  const full = url + (url.includes("?") ? "&" : "?") + qs;

  const res = await fetch(full, {
    method: "GET",
    mode: "cors",
    credentials: "omit",
    redirect: "follow",
    cache: "no-store"
  });

  const txt = await res.text();

  // Intento JSON puro
  try{
    return JSON.parse(txt);
  }catch(_e){}

  // Intento ‚Äúdesenvolver‚Äù JSONP: algoComoCallback( {...} )
  const m = txt.match(/^[a-zA-Z_$][\w$]*\s*\(\s*([\s\S]*)\s*\)\s*;?\s*$/);
  if(m && m[1]){
    const inner = m[1];
    try{ return JSON.parse(inner); }catch(_e2){}
  }

  // Si no, devolvemos error con el contenido para depurar
  throw new Error("Respuesta no-JSON (fetch). Revisa doGet para JSON/JSONP. Contenido: " + txt.slice(0, 180));
}

async function apiRequestWithFallback(params){
  assertApiUrl();
  const candidates = getApiCandidates();
  let lastErr = null;

  // 1) JSONP primero
  for(const u of candidates){
    try{ return await jsonpRequest(u, params); }
    catch(e){ lastErr = e; }
  }

  // 2) Si JSONP falla, intentar fetch
  for(const u of candidates){
    try{ return await fetchRequest(u, params); }
    catch(e){ lastErr = e; }
  }

  throw lastErr || new Error("No se pudo conectar (JSONP+fetch) en ning√∫n endpoint.");
}

async function apiPing(){
  try{
    const r = await apiRequestWithFallback({ action:"ping" });
    if(r && r.ok){
      $("apiHint").className = "ok";
      $("apiHint").textContent = "Conectado ‚úÖ";
      return true;
    }
    $("apiHint").className = "warn";
    $("apiHint").textContent = "API respondi√≥, pero sin OK (revisa deploy).";
    return false;
  }catch(e){
    $("apiHint").className = "err";
    $("apiHint").textContent = "Sin conexi√≥n al WebApp (bloqueo o deploy).";
    return false;
  }
}

function setIaStatus(txt, kind){
  const el = $("iaStatus");
  if(!el) return;
  el.textContent = txt;
  el.className = "small-muted " + (kind || "");
}

async function generarResumenIA(){
  const tipo = $("tipoFormulario")?.value || "";
  if(tipo !== "resumen_ia"){
    alert("Cambia el tipo de formulario a: Resumen IA.");
    return;
  }

  const no_personal = ($("noPersonal")?.value || "").trim();
  const periodo     = ($("periodo")?.value || "").trim();
  const version     = ($("version")?.value || "").trim();

  if(!no_personal || !periodo || !version){
    alert("Para generar el Resumen IA, llena: No. personal + Periodo + Versi√≥n.");
    return;
  }

  try{
    setBusy(true);
    setIaStatus("Generando con IA‚Ä¶", "warn");

    const resp = await apiRequestWithFallback({
      action: "resumen_ia",
      no_personal,
      periodo,
      version
    });

    if(!resp || resp.ok === false){
      throw new Error(resp?.error || "Respuesta inv√°lida en resumen_ia");
    }

    // Esperado desde Apps Script:
    // { ok:true, puntaje:"..", resumen:"..", plan_capacitacion:"..", plan_desarrollo:"..", conclusiones:"..", recomendaciones:".." }

    if($("iaPuntaje")) $("iaPuntaje").value = resp.puntaje ?? "";
    if($("iaResumen")) $("iaResumen").value = resp.resumen ?? "";
    if($("iaPlanCapacitacion")) $("iaPlanCapacitacion").value = resp.plan_capacitacion ?? "";
    if($("iaPlanDesarrollo")) $("iaPlanDesarrollo").value = resp.plan_desarrollo ?? "";
    if($("iaConclusiones")) $("iaConclusiones").value = resp.conclusiones ?? "";
    if($("iaRecomendaciones")) $("iaRecomendaciones").value = resp.recomendaciones ?? "";

   setIaStatus("Listo ‚úÖ", "ok");
    setDirty(true);
    updateSaveEnabled();

     openReportModal(); // ‚Üê NUEVO: abre el reporte flotante para imprimir / PDF
  }catch(e){
    console.error(e);
    setIaStatus("Error: " + (e.message || e), "err");
    alert("No se pudo generar Resumen IA.\n\n" + (e.message || e));
  }finally{
    setBusy(false);
  }
}
  
/************************************************************
 * ‚úÖ ITEMS COMPLETO (19 √≠tems) ‚Äî KEYS = Look.gs
 ************************************************************/
const ITEMS = [
  { group: "1. Cumplimiento y Productividad", items: [
    { key: "A_metas", label: "A. Cumplimiento de Metas. Grado de logro", rubric: [
      "Cumple menos del 70% de lo establecido; la falta de avance afecta los resultados esperados.",
      "Cumple 70‚Äì89% de lo establecido; presenta avances parciales o inconsistentes y requiere correcciones.",
      "Cumple 90‚Äì100% de las metas planificadas con calidad y dentro del tiempo establecido.",
      "Cumple 101‚Äì110% de las metas; entrega resultados adicionales o mejores de lo esperado.",
      "Cumple m√°s del 110% de forma sostenida; impacto significativo y calidad superior."
    ]},
    { key: "B_eficiencia", label: "B. Eficiencia en el uso del tiempo, costos y recursos", rubric: [
      "Usa tiempo y recursos con errores graves que afectan la eficiencia.",
      "Muestra uso inestable del tiempo y recursos; requiere evaluaciones y correcciones frecuentes.",
      "Utiliza de manera adecuada el tiempo y los recursos, cumpliendo sin desperdicios significativos.",
      "Optimiza tiempo y recursos, generando mejoras sin afectar la calidad del trabajo.",
      "Maximiza la eficiencia de forma sostenida; mejora procesos y logra resultados superiores sin comprometer la calidad."
    ]},
    { key: "C_seguridad", label: "C. Cumplimiento de normas de seguridad", rubric: [
      "Incumple normas de seguridad y genera riesgos constantes para s√≠ y el equipo.",
      "Cumple parcialmente las normas; requiere supervisi√≥n continua para evitar incidentes.",
      "Cumple todas las normas y act√∫a de manera segura en su trabajo diario.",
      "Se anticipa a riesgos, propone acciones preventivas y act√∫a con autonom√≠a segura.",
      "Promueve cultura de seguridad; motiva a otros y contribuye a mantener ambientes sin incidentes."
    ]},
    { key: "D_prioriza", label: "D. Prioriza y organiza tareas adecuadamente", rubric: [
      "Desorganiza tareas; incumple plazos y afecta resultados importantes.",
      "Organiza parcialmente; inconsistencias en prioridades y manejo del tiempo.",
      "Gestiona tareas adecuadamente, cumple tiempos y mantiene orden en su trabajo.",
      "Organiza y prioriza con eficiencia; anticipa necesidades y mejora tiempos de entrega.",
      "Es referente en organizaci√≥n; redistribuye recursos, optimiza procesos y eleva la productividad del equipo."
    ]}
  ]},
  { group: "2. Calidad del Trabajo", items: [
    { key: "A_exactitud", label: "A. Exactitud y atenci√≥n al detalle", rubric: [
      "Comete errores frecuentes y no identifica fallos evidentes; requiere supervisi√≥n constante.",
      "Presenta errores recurrentes por falta de revisi√≥n; exactitud inconsistente y requiere correcciones frecuentes.",
      "Realiza su trabajo con un nivel adecuado de precisi√≥n; puede cometer errores menores que no afectan resultados.",
      "Mantiene atenci√≥n al detalle constante; comete pocos errores y revisa su trabajo de forma proactiva.",
      "Trabajo impecable; detecta errores propios y ajenos, propone mejoras y es referente en precisi√≥n."
    ]},
    { key: "B_estandares", label: "B. Cumple con est√°ndares de calidad", rubric: [
      "Menos del 70% de entregables cumplen est√°ndares; resultados inaceptables.",
      "70‚Äì89% cumplen est√°ndares; requiere ajustes frecuentes.",
      "100% de entregables cumplen est√°ndares establecidos.",
      "101‚Äì110%: entrega con calidad superior y consistente.",
      "M√°s del 110%: supera ampliamente est√°ndares y produce resultados sobresalientes."
    ]},
    { key: "C_entregas", label: "C. Entregas a Tiempo (cumple con plazos establecidos)", rubric: [
      "Menos del 70% de entregas a tiempo; retrasos afectan el √°rea.",
      "70‚Äì89% a tiempo; desempe√±o irregular.",
      "100% de entregas en plazos pactados.",
      "101‚Äì110%: se anticipa, cumple tiempos y mantiene calidad.",
      "M√°s del 110%: entrega antes, supera plazos con calidad y mejora eficiencia general."
    ]},
    { key: "D_errores", label: "D. Manejo de errores y mejoras", rubric: [
      "No reconoce ni corrige errores; genera reincidencias graves.",
      "Corrige parcialmente; mejora no constante, requiere supervisi√≥n.",
      "Detecta y corrige errores b√°sicos cuando se le solicita; cumple lo necesario.",
      "Se anticipa a errores y propone soluciones preventivas que mejoran el proceso.",
      "Asegura procesos libres de errores; implementa mejoras continuas y es referente en calidad."
    ]}
  ]},
  { group: "3. Competencias y Habilidades", items: [
    { key: "A_conocimientos", label: "A. Conocimientos t√©cnicos del puesto", rubric: [
      "Conocimientos por debajo de lo esperado; no domina funciones b√°sicas.",
      "Gestiona parcialmente conocimientos; requiere apoyo frecuente.",
      "Posee conocimiento t√©cnico y funcional adecuado para el puesto.",
      "Aplica conocimientos de manera confiable y constante.",
      "Domina conocimientos avanzados y es referente t√©cnico en el √°rea."
    ]},
    { key: "B_clientes", label: "B. Convincente respuesta t√©cnica a clientes", rubric: [
      "Respuestas incorrectas/inconsistentes que generan desconfianza.",
      "Respuestas incompletas o poco claras; afecta calidad del servicio.",
      "Responde de forma adecuada y funcional, brindando confianza.",
      "Respuestas claras, espec√≠ficas y confiables de manera constante.",
      "Respuestas sobresalientes y precisas; reconocido como referente por clientes y equipo."
    ]},
    { key: "C_problemas", label: "C. Resoluci√≥n de problemas", rubric: [
      "No logra resolver problemas; afecta procesos y resultados.",
      "Resuelve parcialmente; requiere supervisi√≥n frecuente.",
      "Resuelve problemas b√°sicos de manera satisfactoria y funcional.",
      "Resuelve problemas complejos con autonom√≠a y confiabilidad.",
      "Anticipa problemas y desarrolla soluciones preventivas y estrat√©gicas."
    ]},
    { key: "D_iniciativa", label: "D. Iniciativa y creatividad", rubric: [
      "No genera ideas ni propone mejoras.",
      "Propone ideas poco √∫tiles o de aplicaci√≥n limitada.",
      "Propone ideas funcionales y aplicables cuando es necesario.",
      "Genera ideas pr√°cticas que optimizan procesos y agregan valor.",
      "Propone soluciones innovadoras con impacto positivo y sostenible."
    ]}
  ]},
  { group: "4. Actitud y Valores", items: [
    { key: "A_responsabilidad", label: "A. Responsabilidad y compromiso", rubric: [
      "Incumple compromisos y entrega resultados muy por debajo de lo esperado.",
      "Cumple de forma irregular; requiere seguimiento constante.",
      "Cumple responsabilidades de manera adecuada y confiable.",
      "Cumple consistentemente; genera seguridad y aporta valor.",
      "Inspira por su compromiso; es modelo de conducta para el equipo."
    ]},
    { key: "B_puntualidad", label: "B. Puntualidad y asistencia", rubric: [
      "Ausencias injustificadas frecuentes; llegadas tard√≠as recurrentes sin aviso.",
      "Frecuencia de tardanza sin justificaci√≥n clara; afecta la operaci√≥n.",
      "Asiste regularmente y cumple horarios; tardanzas justificadas sin reincidencia.",
      "Puntual y asistencia confiable; comunica eventualidades oportunamente.",
      "Puntualidad impecable; referente y se adapta a horarios especiales sin afectar desempe√±o."
    ]},
    { key: "C_equipo", label: "C. Trabajo en equipo y cooperaci√≥n", rubric: [
      "No coopera; genera conflictos y dificulta el trabajo del equipo.",
      "Coopera parcialmente; actitud inestable.",
      "Coopera cuando se le solicita, con resultados aceptables.",
      "Colabora activamente y aporta de forma confiable.",
      "Referente en equipo; promueve colaboraci√≥n, sinergia y apoya a otros."
    ]},
    { key: "D_comunicacion", label: "D. Comunicaci√≥n efectiva", rubric: [
      "Comunicaci√≥n confusa; genera malentendidos graves.",
      "Comunicaci√≥n incompleta/poco clara; requiere supervisi√≥n para asegurar entendimiento.",
      "Comunica lo necesario de forma clara y suficiente.",
      "Comunicaci√≥n clara, precisa y constructiva; escucha activamente.",
      "Comunicaci√≥n influyente y estrat√©gica; facilita acuerdos y motiva a otros."
    ]}
  ]},
  { group: "5. Desarrollo y Potencial", items: [
    { key: "A_adaptacion", label: "A. Adaptaci√≥n al cambio", rubric: [
      "Resiste activamente al cambio; afecta procesos y equipos.",
      "Se adapta parcialmente; con dificultad y resultados limitados.",
      "Se adapta lo necesario para mantener desempe√±o adecuado.",
      "Se adapta de forma aut√≥noma y confiable a nuevas situaciones.",
      "Referente en adaptaci√≥n; motiva y gu√≠a a otros en procesos de cambio."
    ]},
    { key: "B_aprender", label: "B. Disposici√≥n para aprender", rubric: [
      "No busca aprender; rechaza retroalimentaci√≥n y capacitaci√≥n.",
      "Aprende solo lo obligatorio; m√≠nima aplicaci√≥n pr√°ctica.",
      "Aprende lo necesario para mantener desempe√±o satisfactorio.",
      "Busca aprender constantemente y aplica lo aprendido en el trabajo.",
      "Aprendizaje continuo; comparte conocimientos y forma a otros."
    ]},
    { key: "C_liderazgo", label: "C. Liderazgo", rubric: [
      "No coordina ni dirige; genera desorden y afecta resultados.",
      "Lidera d√©bilmente; bajo impacto en el equipo.",
      "Lidera tareas b√°sicas con resultados adecuados y funcionales.",
      "Lidera con confianza, logrando resultados consistentes y estables.",
      "Inspira con visi√≥n clara; desarrolla a otros, fortalece cohesi√≥n y se convierte en referente."
    ]}
  ]}
];

/************************************************************
 * ‚úÖ TABLA DE PESOS (seg√∫n Excel) ‚Äî Total = 100
 * F√≥rmula: (score / 5) * peso
 ************************************************************/
const WEIGHTS = {
  // 1. Cumplimiento y Productividad
  A_metas: 15,
  B_eficiencia: 10,
  C_seguridad: 2.5,
  D_prioriza: 2.5,

  // 2. Calidad del Trabajo
  A_exactitud: 2.5,
  B_estandares: 5,
  C_entregas: 10,
  D_errores: 2.5,

  // 3. Competencias y Habilidades
  A_conocimientos: 10,
  B_clientes: 5,
  C_problemas: 2.5,
  D_iniciativa: 2.5,

  // 4. Actitud y Valores
  A_responsabilidad: 2.5,
  B_puntualidad: 2.5,
  C_equipo: 5,
  D_comunicacion: 5,

  // 5. Desarrollo y Potencial
  A_adaptacion: 2.5,
  B_aprender: 2.5,
  C_liderazgo: 10
};
  
const state = { dirty:false, generated:false, answers:{}, saving:false };
const $ = (id) => document.getElementById(id);

function todayYMDLocal(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`; // formato que espera input[type="date"]
}

function setFechaHoyDefault(force=false){
  const f = $("fecha");
  if(!f) return;

  // Si force=true: siempre pisa con hoy
  // Si force=false: solo lo pone si est√° vac√≠o
  if(force || !String(f.value || "").trim()){
    f.value = todayYMDLocal();
  }
}
  
function setDirty(v){
  state.dirty = v;
  const dot = $("stateDot");
  const text = $("stateText");
  if(v){
    dot.style.background = "var(--warn)";
    text.textContent = "Cambios sin guardar";
  }else{
    dot.style.background = "var(--ok)";
    text.textContent = "Sin cambios";
  }
}
function setBusy(isBusy){
  state.saving = isBusy;
  $("btnSave").disabled = isBusy;
  $("btnGenerate").disabled = isBusy;
  $("btnPrint").disabled = isBusy;
  $("btnNew").disabled = isBusy;
  $("btnRecover").disabled = isBusy;
  $("tipoFormulario").disabled = isBusy;
}

function renderItems(){
  const container = $("itemsContainer");
  if(!container) return;

  container.innerHTML = "";

  ITEMS.forEach(section => {
    const sec = document.createElement("div");
    sec.className = "card";
    sec.style.background = "rgba(0,0,0,.10)";
    sec.style.border = "1px dashed rgba(255,255,255,.10)";
    sec.style.marginTop = "14px";

    const h = document.createElement("h3");
    h.textContent = section.group;
    h.style.margin = "0 0 10px";
    sec.appendChild(h);

    section.items.forEach(it => {
      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1.3fr .9fr";
      row.style.gap = "12px";
      row.style.padding = "10px 0";
      row.style.borderTop = "1px solid rgba(255,255,255,.08)";

      const left = document.createElement("div");
      const title = document.createElement("div");
      title.style.fontWeight = "800";
      title.textContent = it.label;

      const sub = document.createElement("div");
      sub.className = "muted";
      sub.style.fontSize = "12px";
      sub.textContent = "Selecciona 1‚Äì5 seg√∫n la r√∫brica.";

      left.appendChild(title);
      left.appendChild(sub);

      const right = document.createElement("div");
      const lab = document.createElement("label");
      lab.textContent = "Puntaje (1‚Äì5)";

      const sel = document.createElement("select");
      sel.id = "ans_" + it.key;

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Seleccionar...";
      sel.appendChild(opt0);

      for(let v=1; v<=5; v++){
        const o = document.createElement("option");
        o.value = String(v);
        const full = (it.rubric && it.rubric[v-1]) ? it.rubric[v-1] : "";
        o.textContent = full ? `${v} ‚Äî ${full}` : `${v}`;
        sel.appendChild(o);
      }

      const saved = state.answers[it.key];
      if(typeof saved === "number" && saved >= 1 && saved <= 5){
        sel.value = String(saved);
      }

      sel.addEventListener("change", () => {
      state.answers[it.key] = sel.value ? Number(sel.value) : null;
      setDirty(true);
      updateSaveEnabled();
      });
      
      right.appendChild(lab);
      right.appendChild(sel);

      row.appendChild(left);
      row.appendChild(right);
      sec.appendChild(row);
    });

    container.appendChild(sec);
  });
}

function ensureItemsVisibleIfNeeded(){
  const tipo = $("tipoFormulario")?.value || "autoevaluacion";
  const evalCard = $("evalCard");
  const container = $("itemsContainer");

  if(tipo === "clientes"){
    if(evalCard) evalCard.style.display = "none";
    return;
  }

  if(evalCard) evalCard.style.display = "block";
  if(!container) return;

  if(container.children.length === 0){
    renderItems();
  }
}

function getHeaderData(){
  return {
    tipo: $("tipoFormulario").value,
    no_personal: $("noPersonal").value.trim(),
    nombre: $("nombre").value.trim(),
    posicion: $("posicion").value.trim(),
    departamento: $("departamento").value.trim(),
    periodo: $("periodo").value.trim(),
    version: $("version").value.trim(),
    fecha: $("fecha").value
  };
}

/* =========================
   FIX: NO anidar <script> aqu√≠.
   (Solo c√≥digo JS normal dentro del mismo <script> principal)
   ========================= */
function getExtraFields(){
  const tipo = $("tipoFormulario")?.value || "autoevaluacion";

  if(tipo === "autoevaluacion"){
  const c = ($("comentariosColaborador")?.value || "").trim();
  return {
    comentarios_colaborador: c, // compat
    comentarios: c              // ‚úÖ CLAVE: mapea directo a columna "Comentarios"
  };
}

  if(tipo === "clientes"){
    return {
      retroalimentacion: ($("retroalimentacion")?.value || "").trim(),
      nombre_evaluador: ($("nombreEvaluador")?.value || "").trim()
    };
  }

  if(tipo === "desempeno"){
    return {
      justificacion: ($("justificacion")?.value || "").trim(),
      comentarios_evaluador: ($("comentariosEvaluador")?.value || "").trim(),
      nombre_evaluador: ($("nombreEvaluadorDesempeno")?.value || "").trim(),

      mail1: ($("mail1")?.value || "").trim(),
      mail2: ($("mail2")?.value || "").trim(),

      fortalezas: ($("fortalezas")?.value || "").trim(),
      oportunidades_mejora: ($("oportunidades")?.value || "").trim(),
      proyeccion_potencial: ($("proyeccion")?.value || "").trim(),
      necesidades_capacitacion: ($("necesidadesCapacitacion")?.value || "").trim(),
      comentarios_colaborador: ($("comentariosColaborador2")?.value || "").trim(),
      evaluacion_clientes: ($("evaluacionClientes")?.value || "").trim()
    };
  }

  return {};
}

function getScoreFromDOM(itKey){
  const el = document.getElementById("ans_" + itKey);
  if(!el) return null;
  const v = String(el.value || "").trim();
  if(!v) return null;
  const n = Number(v);
  return (Number.isFinite(n) && n >= 1 && n <= 5) ? n : null;
}

function computeTotal(){
  // Puntaje total = SUMA( (score/5) * peso )
  let total = 0;

  ITEMS.forEach(sec => sec.items.forEach(it => {
    const score = getScoreFromDOM(it.key);        // 1..5 o null
    const weight = Number(WEIGHTS[it.key] ?? 0);  // peso del Excel

    if(typeof score === "number" && score >= 1 && score <= 5 && weight > 0){
      total += (score / 5) * weight;
    }
  }));

  return +total.toFixed(2); // Ej: 87.50
}

function flattenAnswersSelectedText(){
  const out = {};
  ITEMS.forEach(sec => sec.items.forEach(it => {
    const n = getScoreFromDOM(it.key);
    if(typeof n === "number"){
      const desc = (it.rubric && it.rubric[n-1]) ? it.rubric[n-1] : "";
      out[it.key] = desc ? `${n} ‚Äî ${desc}` : String(n);
      state.answers[it.key] = n;
    }else{
      out[it.key] = "";
      state.answers[it.key] = null;
    }
  }));
  return out;
}

function formatDateES(yyyy_mm_dd){
  if(!yyyy_mm_dd) return "‚Äî";
  const [y,m,d] = yyyy_mm_dd.split("-").map(n=>parseInt(n,10));
  if(!y || !m || !d) return yyyy_mm_dd;
  const dt = new Date(y, m-1, d);
  return dt.toLocaleDateString("es-HN");
}

function renderSeleccionEnReporte(){
  const host = $("rRubricas");
  host.innerHTML = "";
  ITEMS.forEach(sec => {
    const wrap = document.createElement("div");
    wrap.className = "rubric-wrap";
    const title = document.createElement("div");
    title.className = "rubric-title";
    title.textContent = sec.group;
    wrap.appendChild(title);

    const table = document.createElement("table");
    table.className = "sel-table";

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    trh.innerHTML = `<th class="col-item">√çtem</th><th class="col-score">Puntaje</th><th class="col-desc">Opci√≥n seleccionada</th>`;
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    sec.items.forEach(it => {
      const v = state.answers[it.key];
      const tr = document.createElement("tr");

      const tdItem = document.createElement("td");
      tdItem.className = "col-item";
      tdItem.textContent = it.label;

      const tdScore = document.createElement("td");
      tdScore.className = "col-score";
      tdScore.textContent = (typeof v === "number") ? String(v) : "‚Äî";

      const tdDesc = document.createElement("td");
      tdDesc.className = "col-desc";
      if(typeof v === "number" && it.rubric && it.rubric[v-1]){
        tdDesc.textContent = `${v} ‚Äî ${it.rubric[v-1]}`;
      }else{
        tdDesc.innerHTML = `<span class="muted-print">Sin selecci√≥n</span>`;
      }

      tr.appendChild(tdItem);
      tr.appendChild(tdScore);
      tr.appendChild(tdDesc);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrap.appendChild(table);
    host.appendChild(wrap);
  });
}

function openReportModal(){
  const backdrop = $("reportBackdrop");
  const host = $("reportHost");
  if(!backdrop || !host) return;

  const tipo = $("tipoFormulario")?.value || "";
  if(tipo !== "clientes") ensureItemsVisibleIfNeeded();

  buildReport();

  const reportEl = document.getElementById("report");
  if(reportEl){
    const clone = reportEl.cloneNode(true);
    clone.removeAttribute("id");
    clone.querySelectorAll("[id]").forEach(n=>n.removeAttribute("id"));
    host.innerHTML = "";
    host.appendChild(clone);
  }else{
    host.textContent = "No se pudo generar el reporte (#report no existe).";
  }

  pruneEmptyFields(host);

  backdrop.style.display = "flex";
  backdrop.setAttribute("aria-hidden", "false");
}

function closeReportModal(){
  const backdrop = $("reportBackdrop");
  if(!backdrop) return;
  backdrop.style.display = "none";
  backdrop.setAttribute("aria-hidden", "true");
}

function buildReport(){
  const header = getHeaderData();
  const extra = getExtraFields();
  const total = computeTotal();

  $("rTitle").textContent =
    (header.tipo === "autoevaluacion") ? "Autoevaluaci√≥n del desempe√±o" :
    (header.tipo === "clientes") ? "Formulario evaluaci√≥n clientes" :
    "Evaluaci√≥n del desempe√±o";

  $("rGenerated").textContent = new Date().toLocaleString();
  $("rNoPersonal").textContent = header.no_personal || "‚Äî";
  $("rNombre").textContent = header.nombre || "‚Äî";
  $("rPosicion").textContent = header.posicion || "‚Äî";
  $("rDepartamento").textContent = header.departamento || "‚Äî";
  $("rPeriodo").textContent = header.periodo || "‚Äî";
  $("rVersion").textContent = header.version || "‚Äî";
  $("rFecha").textContent = formatDateES(header.fecha);

  const isRIA = (header.tipo === "resumen_ia");

  const kvNombre = $("rNombre")?.closest(".kv-row");
  const kvPosDep = $("rPosicion")?.closest(".kv-row");
  const kvPerVerF = $("rPeriodo")?.closest(".kv-row");

  if(isRIA){
    if(kvNombre){
      const nombreKv = $("rNombre")?.closest(".kv");
      if(nombreKv) nombreKv.style.display = "none";
    }

    if(kvPosDep) kvPosDep.style.display = "none";

    if(kvPerVerF){
      const fechaKv = $("rFecha")?.closest(".kv");
      if(fechaKv) fechaKv.style.display = "none";
      kvPerVerF.style.gridTemplateColumns = "1fr 1fr";
    }
  }else{
    if(kvNombre){
      const nombreKv = $("rNombre")?.closest(".kv");
      if(nombreKv) nombreKv.style.display = "";
    }
    if(kvPosDep) kvPosDep.style.display = "";
    if(kvPerVerF){
      const fechaKv = $("rFecha")?.closest(".kv");
      if(fechaKv) fechaKv.style.display = "";
      kvPerVerF.style.gridTemplateColumns = "1fr 1fr 1fr";
    }
  }
  
  // ‚úÖ √çtems/r√∫bricas SOLO en autoevaluaci√≥n y desempe√±o
  if(header.tipo !== "clientes"){
    renderSeleccionEnReporte();
  }else{
    // Si ven√≠a algo de antes, lo vaciamos
    const host = $("rRubricas");
    if(host) host.innerHTML = "";
  }

  $("rTotal").textContent = String((header.tipo === "clientes") ? 0 : total);

  // ‚úÖ Comentarios del colaborador SOLO si aplica (autoevaluaci√≥n o desempe√±o)
  const comentarioColab =
    (header.tipo === "autoevaluacion") ? (extra.comentarios_colaborador || "") :
    (header.tipo === "desempeno") ? (extra.comentarios_colaborador || "") : "";

  if(comentarioColab){
    $("rComentariosBlock").style.display = "block";
    $("rComentarios").textContent = comentarioColab;
  }else{
    $("rComentariosBlock").style.display = "none";
    $("rComentarios").textContent = "‚Äî";
  }

  // ‚úÖ Bloques exclusivos de desempe√±o
  if((header.tipo === "desempeno") && extra.evaluacion_clientes){
    $("rEvalClientesBlock").style.display = "block";
    $("rEvalClientes").textContent = extra.evaluacion_clientes;
  }else{
    $("rEvalClientesBlock").style.display = "none";
    $("rEvalClientes").textContent = "‚Äî";
  }

  if(header.tipo === "desempeno" && extra.nombre_evaluador){
    $("rNombreEvalBlock").style.display = "block";
    $("rNombreEvaluadorDesempeno").textContent = extra.nombre_evaluador;
  }else{
    $("rNombreEvalBlock").style.display = "none";
    $("rNombreEvaluadorDesempeno").textContent = "‚Äî";
  }

  if(header.tipo === "desempeno"){
    const hasAny = (extra.justificacion || extra.comentarios_evaluador || extra.fortalezas || extra.oportunidades_mejora || extra.proyeccion_potencial || extra.necesidades_capacitacion);
    if(hasAny){
      $("rJustifBlock").style.display = "block";
      const txt = [
        `Justificaci√≥n calificaciones (1-5): ${extra.justificacion || "‚Äî"}`,
        `Comentarios del evaluador: ${extra.comentarios_evaluador || "‚Äî"}`,
        `Fortalezas: ${extra.fortalezas || "‚Äî"}`,
        `Oportunidades de mejora: ${extra.oportunidades_mejora || "‚Äî"}`,
        `Proyecci√≥n y potencial: ${extra.proyeccion_potencial || "‚Äî"}`,
        `Necesidades de capacitaci√≥n: ${extra.necesidades_capacitacion || "‚Äî"}`
      ].join("\n\n");
      $("rJustifAll").textContent = txt;
    }else{
      $("rJustifBlock").style.display = "none";
      $("rJustifAll").textContent = "‚Äî";
    }
  }else{
    $("rJustifBlock").style.display = "none";
    $("rJustifAll").textContent = "‚Äî";
  }
// ‚úÖ Resumen IA (solo si tipo = resumen_ia)
if(header.tipo === "resumen_ia"){
  const p = ($("iaPuntaje")?.value || "").trim();
  const rs = ($("iaResumen")?.value || "").trim();
  const pc = ($("iaPlanCapacitacion")?.value || "").trim();
  const pd = ($("iaPlanDesarrollo")?.value || "").trim();
  const cc = ($("iaConclusiones")?.value || "").trim();
  const rr = ($("iaRecomendaciones")?.value || "").trim();

  const hasAnyIA = (p || rs || pc || pd || cc || rr);

  if(hasAnyIA){
    $("rResumenIaBlock").style.display = "block";
    $("rResumenIaAll").textContent = [
      `Puntaje: ${p || "‚Äî"}`,
      `Resumen: ${rs || "‚Äî"}`,
      `Plan de capacitaci√≥n: ${pc || "‚Äî"}`,
      `Plan de desarrollo: ${pd || "‚Äî"}`,
      `Conclusiones: ${cc || "‚Äî"}`,
      `Recomendaciones: ${rr || "‚Äî"}`
    ].join("\n\n");
  }else{
    $("rResumenIaBlock").style.display = "none";
    $("rResumenIaAll").textContent = "‚Äî";
  }

  // Puntaje total del reporte = el de IA (si existe), si no 0
  $("rTotal").textContent = p || "0";
}else{
  // si no es Resumen IA, escondemos ese bloque
  $("rResumenIaBlock").style.display = "none";
  $("rResumenIaAll").textContent = "‚Äî";
}
  $("printArea").style.display = "block";
}

function parseScoreFromCell(val){
  const s = String(val || "").trim();
  if(!s) return null;
  const m = s.match(/^([1-5])\s*(?:[‚Äî-]|$)/);
  if(m) return Number(m[1]);
  const n = Number(s);
  if(Number.isFinite(n) && n>=1 && n<=5) return n;
  return null;
}

function setSelectValue(key, score){
  const el = $("ans_" + key);
  if(!el) return;
  el.value = (score>=1 && score<=5) ? String(score) : "";
  state.answers[key] = (score>=1 && score<=5) ? score : null;
}

/************************************************************
 * ‚úÖ MODALES / RECUPERACI√ìN
 ************************************************************/
let lastRecovered = null;

function openRecoverModal(){
 const b = $("recoverBackdrop");
  if(!b) return;
  b.style.display = "flex";
  b.setAttribute("aria-hidden", "false");
}
function closeRecoverModal(){
  const b = $("recoverBackdrop");
  if(!b) return;
  b.style.display = "none";
  b.setAttribute("aria-hidden", "true");
}
function openLookupModal(){
  $("lookupBackdrop").style.display = "flex";
  $("lookupBackdrop").setAttribute("aria-hidden", "false");
}
function closeLookupModal(){
  $("lookupBackdrop").style.display = "none";
  $("lookupBackdrop").setAttribute("aria-hidden", "true");
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function clientesToText_(clientesInfo){
  // Soporta:
  // - clientesInfo = {found:true, retroalimentacion, nombre_evaluador} (1 fila)
  // - clientesInfo = {found:true, rows:[{retroalimentacion, nombre_evaluador, rowNumber}, ...]} (muchas filas)
  if(!clientesInfo) return "";

  // Caso muchas filas
  if(Array.isArray(clientesInfo.rows) && clientesInfo.rows.length){
    return clientesInfo.rows
      .map(r => {
        const retro = String(r.retroalimentacion || "").trim();
        const evalNom = String(r.nombre_evaluador || "").trim();
        const head = evalNom ? `(${evalNom}) ` : "";
        return `${head}${retro}`.trim();
      })
      .filter(Boolean)
      .join("\n\n");
  }

  // Caso una fila (tu comportamiento actual)
  if(clientesInfo.found){
    const retro = String(clientesInfo.retroalimentacion || "").trim();
    const evalNom = String(clientesInfo.nombre_evaluador || "").trim();
    const head = evalNom ? `(${evalNom}) ` : "";
    return `${head}${retro}`.trim();
  }

  return "";
}

function renderKeyReport(no_personal, periodo, version, sourceHint){
  const box = document.createElement("div");
  box.className = "card";
  box.style.padding = "12px";
  box.style.background = "rgba(0,0,0,.14)";
  box.innerHTML = `
    <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
      <div class="chip"><b>Reporte (llaves)</b></div>
      <div class="small-muted">${escapeHtml(sourceHint || "")}</div>
    </div>
    <table class="mini-table" style="margin-top:10px;">
      <thead><tr><th class="col-k">&nbsp;</th><th class="col-v">&nbsp;</th></tr></thead>
      <tbody>
        <tr><td class="col-k">No. personal</td><td class="col-v">${escapeHtml(no_personal || "‚Äî")}</td></tr>
        <tr><td class="col-k">Periodo</td><td class="col-v">${escapeHtml(periodo || "‚Äî")}</td></tr>
        <tr><td class="col-k">Versi√≥n</td><td class="col-v">${escapeHtml(version || "‚Äî")}</td></tr>
      </tbody>
    </table>
  `;
  const host = $("recoverKeyReport");
  host.innerHTML = "";
  host.appendChild(box);
}

function renderAllColumnsTable(allColumns){
  const host = $("recoverAllCols");
  host.innerHTML = "";
  const arr = Array.isArray(allColumns) ? allColumns : [];
  if(!arr.length){
    host.innerHTML = `<div class="small-muted">Sin datos de columnas para mostrar.</div>`;
    return;
  }
  const box = document.createElement("div");
  box.className = "card";
  box.style.padding = "12px";
  box.style.background = "rgba(0,0,0,.14)";
  box.innerHTML = `
    <div class="chip"><b>Datos recuperados (Encabezado / Valor)</b></div>
    <table class="mini-table" style="margin-top:10px;">
      <thead><tr><th class="col-k">&nbsp;</th><th class="col-v">&nbsp;</th></tr></thead>
      <tbody>
        ${arr.map(x => `
          <tr>
            <td class="col-k">${escapeHtml(String(x.header ?? ""))}</td>
            <td class="col-v">${escapeHtml(String(x.value ?? ""))}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  host.appendChild(box);
}

/* =========================================================
   ‚úÖ FIX PRINCIPAL: NO HAY <script> ANIDADO AQU√ç
   - buildRecoverModal queda dentro del mismo script
   ========================================================= */
function buildRecoverModal(rowParams, meta, clientesInfo, allColumns){
  function showDash(v){
    const s = String(v ?? "").trim();
    return s ? s : "‚Äî";
  }
  function normKey(s){
    return String(s ?? "")
      .toLowerCase()
      .trim()
      .replace(/\s+/g, " ");
  }
  function pushUnique(rows, label, value){
    const k = normKey(label);
    if(!k) return;
    if(rows.some(([lbl]) => normKey(lbl) === k)) return;
    rows.push([label, value]);
  }

  lastRecovered = { rowParams, meta, clientesInfo, allColumns };

  $("recoverTitle").textContent = "Registro encontrado";
  $("recoverSub").textContent =
    `Keys: ${meta.no_personal || "‚Äî"} / ${meta.periodo || "‚Äî"} / ${meta.version || "‚Äî"} ‚Ä¢ Fila: ${meta.rowNumber || "‚Äî"}`;

  const hint = (clientesInfo && clientesInfo.found)
    ? `Autoevaluaciones + Clientes (fila Clientes: ${clientesInfo.rowNumber || "‚Äî"})`
    : `Autoevaluaciones (Clientes: sin registro)`;

  renderKeyReport(meta.no_personal, meta.periodo, meta.version, hint);

  // Debug opcional
  const SHOW_DEBUG_ALLCOLS = false;
  if(SHOW_DEBUG_ALLCOLS){
    renderAllColumnsTable(allColumns);
  }else{
    if($("recoverAllCols")) $("recoverAllCols").innerHTML = "";
  }

  // ---- Clientes (composici√≥n) ----
    let evalCli = String(rowParams.evaluacion_clientes || "").trim();

  const composedClientes = clientesToText_(clientesInfo);
  if(composedClientes){
    evalCli = composedClientes;
  }

 // ---- Resumen general ----
  const generalRows = [];
  pushUnique(generalRows, "Nombre", showDash(rowParams.nombre));
  pushUnique(generalRows, "Posici√≥n", showDash(rowParams.posicion));
  pushUnique(generalRows, "Departamento", showDash(rowParams.departamento));
  pushUnique(generalRows, "Fecha", showDash(rowParams.fecha));

  pushUnique(generalRows, "Comentarios del colaborador", showDash(rowParams.comentarios_colaborador ?? rowParams.comentarios));
  // ‚ùå No incluir en la tabla del modal:
  // pushUnique(generalRows, "Justificaci√≥n", showDash(rowParams.justificacion));
  // pushUnique(generalRows, "Fortalezas", showDash(rowParams.fortalezas));
  // pushUnique(generalRows, "Oportunidades", showDash(rowParams.oportunidades_mejora));
  // pushUnique(generalRows, "Proyecci√≥n", showDash(rowParams.proyeccion_potencial));
  // pushUnique(generalRows, "Necesidades de capacitaci√≥n", showDash(rowParams.necesidades_capacitacion));
  pushUnique(generalRows, "Evaluaci√≥n clientes (desempe√±o)", showDash(evalCli));

  const gen = document.createElement("table");
  gen.className = "mini-table";
  gen.innerHTML = `
    <thead>
      <tr><th class="col-k">&nbsp;</th><th class="col-v">&nbsp;</th></tr>
    </thead>
    <tbody>
      ${generalRows.map(([k,v]) => `
        <tr>
          <td class="col-k">${escapeHtml(k)}</td>
          <td class="col-v">${escapeHtml(String(v ?? ""))}</td>
        </tr>
      `).join("")}
    </tbody>
  `;
  $("recoverGeneral").innerHTML = "";
  $("recoverGeneral").appendChild(gen);

  // ---- Items ----
  const it = document.createElement("table");
  it.className = "items-table";
  it.innerHTML = `
    <thead>
      <tr>
        <th class="it-col1">Grupo</th>
        <th class="it-col2">√çtem</th>
        <th class="it-col3">Puntaje</th>
        <th class="it-col4">Texto guardado (r√∫brica / opci√≥n)</th>
      </tr>
    </thead>
    <tbody id="recoverItemsBody"></tbody>
  `;

  const tbody = it.querySelector("#recoverItemsBody");
  ITEMS.forEach(sec => {
    const trg = document.createElement("tr");
    trg.className = "group-row";
    trg.innerHTML = `<td colspan="4">${escapeHtml(sec.group)}</td>`;
    tbody.appendChild(trg);

    sec.items.forEach(item => {
      const raw = rowParams[item.key] ?? "";
      const score = parseScoreFromCell(raw);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="it-col1">${escapeHtml(sec.group)}</td>
        <td class="it-col2">${escapeHtml(item.label)}</td>
        <td class="it-col3">${score ? String(score) : "‚Äî"}</td>
        <td class="it-col4">${escapeHtml(raw)}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  $("recoverItems").innerHTML = "";
  $("recoverItems").appendChild(it);

  openRecoverModal();
}

function applyRecoveredToForm(rowParams, clientesInfo){
  $("noPersonal").value = rowParams.no_personal || $("noPersonal").value;
  $("periodo").value = rowParams.periodo || $("periodo").value;
  $("version").value = rowParams.version || $("version").value;
  $("nombre").value = rowParams.nombre || $("nombre").value;
  $("posicion").value = rowParams.posicion || $("posicion").value;
  $("departamento").value = rowParams.departamento || $("departamento").value;
  $("fecha").value = rowParams.fecha || $("fecha").value;

  $("tipoFormulario").value = "desempeno";
  applyTipoUI();

  if(rowParams.justificacion) $("justificacion").value = rowParams.justificacion;
  if($("comentariosEvaluador")) $("comentariosEvaluador").value = "";
  if($("nombreEvaluadorDesempeno")) $("nombreEvaluadorDesempeno").value = "";

  /* ‚úÖ NUEVO: recuperar mail1/mail2 si vienen */
  if(rowParams.mail1 && $("mail1")) $("mail1").value = rowParams.mail1;
  if(rowParams.mail2 && $("mail2")) $("mail2").value = rowParams.mail2;

  if(rowParams.fortalezas) $("fortalezas").value = rowParams.fortalezas;
  if(rowParams.oportunidades_mejora) $("oportunidades").value = rowParams.oportunidades_mejora;
  if(rowParams.proyeccion_potencial) $("proyeccion").value = rowParams.proyeccion_potencial;
  if(rowParams.necesidades_capacitacion) $("necesidadesCapacitacion").value = rowParams.necesidades_capacitacion;
  
  // ‚úÖ NUEVO: comentarios del colaborador (desempe√±o)
  if($("comentariosColaborador2")){
    $("comentariosColaborador2").value =
      (rowParams.comentarios_colaborador ?? rowParams.comentarios ?? "");
  }

let evalCli = String(rowParams.evaluacion_clientes || "").trim();

  const composedClientes = clientesToText_(clientesInfo);
  if(composedClientes){
    evalCli = composedClientes;

    // Si hay muchas filas, no ‚Äúforzamos‚Äù un solo nombre de evaluador.
    // Si es una sola fila, mantenemos el comportamiento.
    if(!Array.isArray(clientesInfo?.rows) && clientesInfo?.nombre_evaluador){
      if(!$("nombreEvaluadorDesempeno").value){
        $("nombreEvaluadorDesempeno").value = clientesInfo.nombre_evaluador;
      }
    }
  }
 if(evalCli) $("evaluacionClientes").value = evalCli;
  
  ensureItemsVisibleIfNeeded();
  ITEMS.forEach(sec => sec.items.forEach(it => {
    const raw = String(rowParams[it.key] ?? "").trim();
    const score = parseScoreFromCell(raw);
    setSelectValue(it.key, score);
  }));

  $("printArea").style.display = "none";
  state.generated = false;
  setDirty(false);
  updateSaveEnabled();
}

function applyRecoveredTextsOnly(rowParams, clientesInfo){
  $("tipoFormulario").value = "desempeno";
  applyTipoUI();

  if(rowParams.no_personal) $("noPersonal").value = rowParams.no_personal;
  if(rowParams.periodo) $("periodo").value = rowParams.periodo;
  if(rowParams.version) $("version").value = rowParams.version;
  if(rowParams.nombre) $("nombre").value = rowParams.nombre;
  if(rowParams.posicion) $("posicion").value = rowParams.posicion;
  if(rowParams.departamento) $("departamento").value = rowParams.departamento;
  if(rowParams.fecha) $("fecha").value = rowParams.fecha;

  if(rowParams.justificacion) $("justificacion").value = rowParams.justificacion;
  if(rowParams.comentarios_evaluador) $("comentariosEvaluador").value = rowParams.comentarios_evaluador;
  if(rowParams.fortalezas) $("fortalezas").value = rowParams.fortalezas;
  if(rowParams.oportunidades_mejora) $("oportunidades").value = rowParams.oportunidades_mejora;
  if(rowParams.proyeccion_potencial) $("proyeccion").value = rowParams.proyeccion_potencial;
  if(rowParams.necesidades_capacitacion) $("necesidadesCapacitacion").value = rowParams.necesidades_capacitacion;

// ‚úÖ NUEVO: comentarios del colaborador (desempe√±o)
  if($("comentariosColaborador2")){
    $("comentariosColaborador2").value =
      (rowParams.comentarios_colaborador ?? rowParams.comentarios ?? "");
  }
  if($("nombreEvaluadorDesempeno")) $("nombreEvaluadorDesempeno").value = "";

  /* ‚úÖ NUEVO: recuperar mail1/mail2 si vienen */
  if(rowParams.mail1 && $("mail1")) $("mail1").value = rowParams.mail1;
  if(rowParams.mail2 && $("mail2")) $("mail2").value = rowParams.mail2;

  let evalCli = String(rowParams.evaluacion_clientes || "").trim();
  if(clientesInfo && clientesInfo.found){
    const head = clientesInfo.nombre_evaluador ? `(${clientesInfo.nombre_evaluador}) ` : "";
    const composed = `${head}${clientesInfo.retroalimentacion || ""}`.trim();
    if(composed) evalCli = composed;
    if(!$("nombreEvaluadorDesempeno").value && clientesInfo.nombre_evaluador){
      $("nombreEvaluadorDesempeno").value = clientesInfo.nombre_evaluador;
    }
  }
  if(evalCli) $("evaluacionClientes").value = evalCli;

  $("printArea").style.display = "none";
  state.generated = false;
  setDirty(false);
}

/************************************************************
 * ‚úÖ LOOKUP MODAL (LISTA) ‚Äî incluye Clientes SIEMPRE
 ************************************************************/
let lastLookupResults = [];
function setLookupStatus(txt, kind){
  const el = $("lookupStatus");
  el.textContent = txt;
  el.className = "small-muted " + (kind || "");
}

function renderLookupResults(rows, clientesInfo){
  const tbody = $("lookupResultsBody");
  if(!tbody) return;

  lastLookupResults = Array.isArray(rows) ? rows : [];

  const chipCount = $("chipCount");
  const chipNote  = $("chipNote");
  if(chipCount) chipCount.textContent = `${lastLookupResults.length} resultados`;
  if(chipNote)  chipNote.textContent  = lastLookupResults.length
    ? "Selecciona una fila para ver detalle y luego Autollenar."
    : "";

  const retro  = (clientesInfo && clientesInfo.found) ? String(clientesInfo.retroalimentacion || "") : "";
  const evalNom = (clientesInfo && clientesInfo.found) ? String(clientesInfo.nombre_evaluador || "") : "";

  const esc = (typeof escapeHtml === "function")
    ? escapeHtml
    : (s)=>String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  if(!lastLookupResults.length){
    tbody.innerHTML = `<tr><td colspan="10" class="small-muted">Sin resultados.</td></tr>`;
    return;
  }

  tbody.innerHTML = lastLookupResults.map((r, idx) => {
    const meta = r?.meta || {};
    const rp   = r?.rowParams || {};
    return `
      <tr>
        <td class="r-col-act">
          <button class="btn primary" type="button" data-pick="${idx}" style="padding:8px 12px;">Seleccionar</button>
        </td>
        <td class="r-col-row">${esc(String(meta.rowNumber ?? "‚Äî"))}</td>
        <td class="r-col-np">${esc(String(rp.no_personal ?? ""))}</td>
        <td>${esc(String(rp.nombre ?? ""))}</td>
        <td class="r-col-per">${esc(String(rp.periodo ?? ""))}</td>
        <td class="r-col-ver">${esc(String(rp.version ?? ""))}</td>
        <td class="r-col-fecha">${esc(String(rp.fecha ?? ""))}</td>
        <td>${esc(String(rp.departamento ?? ""))}</td>
        <td>${esc(retro)}</td>
        <td>${esc(evalNom)}</td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-pick]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const i = Number(btn.getAttribute("data-pick"));
      const pick = lastLookupResults[i];
      const rowNumber = pick?.meta?.rowNumber;
      if(!rowNumber) return;

      try{
        setLookupStatus("Cargando detalle‚Ä¶", "warn");

        const data = await apiRequestWithFallback({
          action: "recuperar_por_fila",
          tipo: "autoevaluacion",
          rowNumber: String(rowNumber)
        });

        if(!data || !data.found || !data.rowParams){
          setLookupStatus("No se pudo abrir detalle.", "err");
          return;
        }

        buildRecoverModal(
          data.rowParams,
          {
            no_personal: data.rowParams.no_personal || "",
            periodo: data.rowParams.periodo || "",
            version: data.rowParams.version || "",
            rowNumber: data.rowNumber || rowNumber || ""
          },
          data.clientes || null,
          data.allColumns || []
        );

        setLookupStatus("Detalle cargado.", "ok");
      }catch(e){
        console.error(e);
        setLookupStatus("Error: " + (e.message || e), "err");
        alert("No se pudo abrir detalle: " + (e.message || e));
      }
    });
  });
}

/* ‚úÖ Buscar (modal) */
async function searchRecords(){
  if(state.saving) return;

  const tipo = $("tipoFormulario")?.value || "";
  if(tipo !== "desempeno"){
    alert("Recuperar solo est√° disponible en el Formulario de evaluaci√≥n del desempe√±o.");
    return;
  }

  const no_personal = ($("qNoPersonal")?.value || "").trim();
  const nombre      = ($("qNombre")?.value || "").trim();
  const periodo     = ($("qPeriodo")?.value || "").trim();
  const version     = ($("qVersion")?.value || "").trim();

  try{
    assertApiUrl();
    setLookupStatus("Buscando en autoevaluaciones...", "warn");

    const data = await apiRequestWithFallback({
      action: "buscar",
      tipo: "autoevaluacion",
      no_personal,
      nombre,
      periodo,
      version,
      limit: "50"
    });

    if(!data || data.ok === false){
      const msg = (data && data.error) ? data.error : "Respuesta inv√°lida del servidor.";
      setLookupStatus("Error: " + msg, "err");
      renderLookupResults([], null);
      return;
    }

    const rows = data.rows || [];
    renderLookupResults(rows, data.clientes || null);

    setLookupStatus(
      rows.length ? `Listo. ${rows.length} resultado(s).` : "Sin resultados con esos filtros.",
      rows.length ? "ok" : "warn"
    );

  }catch(err){
    console.error(err);
    setLookupStatus("Error: " + (err.message || err), "err");
    renderLookupResults([], null);
    alert("No se pudo consultar.\n\n" + (err.message || err));
  }
}

/* ‚úÖ Recuperar (BOT√ìN) ‚Äî abre directo el detalle */
async function recoverByKeys(){
  if(state.saving) return;

  const tipoUI = $("tipoFormulario")?.value || "";
  if(tipoUI !== "desempeno"){
    alert("Recuperar solo est√° disponible en el Formulario de evaluaci√≥n del desempe√±o.");
    return;
  }

  const no_personal = ($("noPersonal")?.value || "").trim();
  const periodo     = ($("periodo")?.value || "").trim();
  const version     = ($("version")?.value || "").trim();

  if(!no_personal || !periodo || !version){
    alert("Para Recuperar, llena: No. de personal + Periodo + Versi√≥n.");
    return;
  }

  try{
    assertApiUrl();
    setBusy(true);
    $("apiHint").className = "warn";
    $("apiHint").textContent = "Recuperando‚Ä¶";

    try{ await apiPing(); }catch(_e){}

    const resp = await apiRequestWithFallback({
      action: "recuperar_desempeno_por_keys",
      no_personal,
      periodo,
      version
    });

    if(!resp || resp.ok === false){
      const msg = resp?.error || "Respuesta inv√°lida recuperando por llaves.";
      $("apiHint").className = "err";
      $("apiHint").textContent = msg;
      alert(msg);
      return;
    }

    // ‚úÖ Duplicados: mostrar el primero
    if(resp.multi && Array.isArray(resp.rows) && resp.rows.length){
      $("apiHint").className = "warn";
      $("apiHint").textContent = `Duplicados detectados (${resp.rows.length}). Mostrando el primero.`;

      const first = resp.rows[0] || {};

      if(first.rowParams){
        buildRecoverModal(
          first.rowParams,
          {
            no_personal: first.rowParams.no_personal || no_personal || "",
            periodo: first.rowParams.periodo || periodo || "",
            version: first.rowParams.version || version || "",
            rowNumber: first.meta?.rowNumber || first.rowNumber || resp.rowNumber || "‚Äî"
          },
          resp.clientes || first.clientes || null,
          resp.allColumns || first.allColumns || []
        );
        return;
      }

      const rowNumber = first.meta?.rowNumber || first.rowNumber;
      if(rowNumber){
        const data = await apiRequestWithFallback({
          action: "recuperar_por_fila",
          tipo: "autoevaluacion",
          rowNumber: String(rowNumber)
        });

        if(data && data.found && data.rowParams){
          buildRecoverModal(
            data.rowParams,
            {
              no_personal: data.rowParams.no_personal || no_personal || "",
              periodo: data.rowParams.periodo || periodo || "",
              version: data.rowParams.version || version || "",
              rowNumber: data.rowNumber || rowNumber || "‚Äî"
            },
            data.clientes || null,
            data.allColumns || []
          );
          return;
        }
      }

      $("apiHint").className = "err";
      $("apiHint").textContent = "Duplicados detectados, pero no se pudo abrir el detalle.";
      alert("Duplicados detectados, pero no se pudo abrir el detalle.");
      return;
    }

    // ‚úÖ √önico encontrado
    if(resp.found && resp.rowParams){
      buildRecoverModal(
        resp.rowParams,
        {
          no_personal: resp.rowParams.no_personal || no_personal || "",
          periodo: resp.rowParams.periodo || periodo || "",
          version: resp.rowParams.version || version || "",
          rowNumber: resp.rowNumber || "‚Äî"
        },
        resp.clientes || null,
        resp.allColumns || []
      );

      $("apiHint").className = "ok";
      $("apiHint").textContent = "Registro encontrado ‚úÖ";
      return;
    }

    $("apiHint").className = "warn";
    $("apiHint").textContent = "Sin registro con esas llaves.";
    alert("Sin registro con esas llaves.");

  }catch(err){
    console.error(err);
    $("apiHint").className = "err";
    $("apiHint").textContent = "No se pudo recuperar: " + (err.message || err);
    alert("No se pudo recuperar.\n\n" + (err.message || err));
  }finally{
    setBusy(false);
  }
}

function openLookupPrefilled(){
  $("qNoPersonal").value = ($("noPersonal")?.value || "").trim();
  $("qNombre").value     = ($("nombre")?.value || "").trim();
  $("qPeriodo").value    = ($("periodo")?.value || "").trim();
  $("qVersion").value    = ($("version")?.value || "").trim();

  const chipCount = $("chipCount");
  const chipNote  = $("chipNote");
  if(chipCount) chipCount.textContent = "0 resultados";
  if(chipNote)  chipNote.textContent  = "";

  const tbody = $("lookupResultsBody");
  if(tbody) tbody.innerHTML = `<tr><td colspan="10" class="small-muted">Sin resultados a√∫n.</td></tr>`;

  setLookupStatus("Listo para buscar.", "warn");
  openLookupModal();
}

/* ---------- UI tipo / acciones ---------- */
function applySearchUI(tipo){
  const isDes = (tipo === "desempeno");
  const badgeWrap = $("searchBadgeWrap");
  if(badgeWrap) badgeWrap.style.display = isDes ? "inline" : "none";

  ["fldNoPersonal","fldPeriodo","fldVersion"].forEach(id=>{
    const el = $(id);
    if(!el) return;

    if(isDes){
      el.classList.add("searchField");
      el.classList.add("keyLookupField");
    }else{
      el.classList.remove("searchField");
      el.classList.remove("keyLookupField");
    }
  });

  const btnRecover = $("btnRecover");
  if(btnRecover) btnRecover.style.display = isDes ? "" : "none";
}

function applyTopActionsUI(tipo){
  const btnSave = $("btnSave");
  if(btnSave){
    btnSave.style.display = "";
    btnSave.disabled = false;
  }

  const btnRecover = $("btnRecover");
  if(btnRecover){
    btnRecover.style.display = (tipo === "desempeno") ? "" : "none";
    btnRecover.disabled = (tipo !== "desempeno");
  }

  // ‚úÖ Generar: visible para autoevaluaci√≥n y desempe√±o (y si quieres, tambi√©n para clientes)
   // ‚úÖ Generar: SOLO visible en desempe√±o
    const btnGen = $("btnGenerate");
  if(btnGen){
    const allowGenerate = (tipo === "desempeno" || tipo === "resumen_ia");
    btnGen.style.display = allowGenerate ? "" : "none";
    btnGen.disabled = !allowGenerate;
  }
}

/* ---------- Clientes box ---------- */
function ensureClientesBox(){
  if(document.getElementById("clientesBox")) return;

  const grid = document.querySelector(".grid");
  if(!grid) return;

  const card = document.createElement("div");
  card.className = "card";
  card.id = "clientesBox";
  card.style.display = "none";

  card.innerHTML = `
    <h2>Evaluaci√≥n de clientes</h2>
    <p>Completa los 2 campos siguientes (seg√∫n formato).</p>

    <div class="highlightBadge">
      <span class="dot"></span>
      Campos realzados: Retroalimentaci√≥n ‚Ä¢ Nombre del evaluador
    </div>

    <div style="margin-top:14px;" class="highlightField">
      <label>Retroalimentaci√≥n (Clientes)</label>
      <textarea id="retroalimentacion" placeholder="Escribe la retroalimentaci√≥n del cliente..."></textarea>
    </div>

    <div style="margin-top:12px;" class="highlightField">
      <label>Nombre del evaluador</label>
      <input id="nombreEvaluador" type="text" placeholder="Ej. Ana L√≥pez" />
    </div>
  `;

  const cards = grid.querySelectorAll(".card");
  if(cards && cards.length >= 2 && cards[1].parentNode){
    cards[1].parentNode.insertBefore(card, cards[1].nextSibling);
  }else{
    grid.appendChild(card);
  }
}

function applyTipoUI(){
  const tipo = $("tipoFormulario")?.value || "autoevaluacion";

  ensureClientesBox();

  const appTitle = $("appTitle");
  if(appTitle){
    appTitle.textContent =
      (tipo === "autoevaluacion") ? "Formulario de autoevaluaci√≥n" :
      (tipo === "clientes") ? "Formulario evaluaci√≥n clientes" :
      "Formulario de evaluaci√≥n del desempe√±o";
  }

  const autoBox  = $("autoComentariosBox");
  const desBox   = $("desempenoCamposBox");
  const cliBox   = $("clientesBox");
  const evalCard = $("evalCard");
  const iaBox = $("resumenIaBox");

   if(autoBox)  autoBox.style.display  = (tipo === "autoevaluacion") ? "block" : "none";
   if(desBox)   desBox.style.display   = (tipo === "desempeno") ? "block" : "none";
   if(cliBox)   cliBox.style.display   = (tipo === "clientes") ? "block" : "none";
   if(iaBox)    iaBox.style.display    = (tipo === "resumen_ia") ? "block" : "none";

// En Resumen IA no mostramos la evaluaci√≥n por √≠tems (porque viene de la hoja)
if(evalCard) evalCard.style.display = (tipo === "clientes" || tipo === "resumen_ia") ? "none" : "block";
  // ‚úÖ Resumen IA: mostrar SOLO llaves (No. personal, Periodo, Versi√≥n) en una sola fila
  if(tipo === "resumen_ia"){
    ["fldNombre","fldPosicion","fldDepartamento","fldFecha"].forEach(id=>{
      const el = $(id);
      if(el) el.style.display = "none";
    });

    ["fldNoPersonal","fldPeriodo","fldVersion"].forEach(id=>{
      const el = $(id);
      if(el) el.style.display = "";
    });
  }else{
    // ‚úÖ Resto de formularios: volver a mostrar campos normales
    ["fldNombre","fldPosicion","fldDepartamento","fldFecha"].forEach(id=>{
      const el = $(id);
      if(el) el.style.display = "";
    });
  }

  if(typeof ensureItemsVisibleIfNeeded === "function") ensureItemsVisibleIfNeeded();
  if(typeof applySearchUI === "function") applySearchUI(tipo);
  if(typeof applyTopActionsUI === "function") applyTopActionsUI(tipo);
  updateSaveEnabled();
}

function clearForm(){
  [
    "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
    "comentariosColaborador","justificacion","comentariosEvaluador","fortalezas",
    "oportunidades","proyeccion","necesidadesCapacitacion","comentariosColaborador2",
    "evaluacionClientes","retroalimentacion","nombreEvaluador","nombreEvaluadorDesempeno",
    "mail1","mail2"
  ].forEach(id=>{ const el=$(id); if(el) el.value=""; });
   setFechaHoyDefault(true); // ‚úÖ fuerza HOY cuando limpias
  state.answers = {};
  ITEMS.forEach(sec => sec.items.forEach(it=>{
    const el = $("ans_"+it.key);
    if(el) el.value = "";
  }));

  $("printArea").style.display = "none";
  state.generated = false;
  setDirty(false);
  updateSaveEnabled();

  $("apiHint").className = "warn";
  $("apiHint").textContent = "Listo para enviar";
}

/* ---------- Reporte / impresi√≥n ---------- */
function _isEmptyValue(v){
  return v == null || String(v).trim() === "";
}

function pruneEmptyFields(root){
  if(!root) return;

  root.querySelectorAll("table").forEach(tbl=>{
    tbl.querySelectorAll("tr").forEach(tr=>{
      const tds = tr.querySelectorAll("td");
      if(tds && tds.length >= 2){
        const val = (tds[1].textContent || "").trim();
        if(_isEmptyValue(val)) tr.remove();
      }
    });
  });
}

function doPrint(){
  const host = $("reportHost");
  const hasSomething = host && host.textContent && host.textContent.trim().length > 0;

  if(!hasSomething){
    openReportModal();
  }
  if(host) pruneEmptyFields(host);

  window.print();
}

// ===============================
// ‚úÖ VALIDACI√ìN PARA GUARDAR
// ===============================
// ‚úÖ Campos obligatorios por formulario (por ID)
const REQUIRED_FIELDS = {
  autoevaluacion: [
    "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
    "comentariosColaborador"
  ],
  clientes: [
    "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
    "retroalimentacion","nombreEvaluador"
  ],
   desempeno: [
    "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
    "justificacion","comentariosEvaluador","fortalezas","oportunidades","proyeccion",
    "necesidadesCapacitacion","comentariosColaborador2","evaluacionClientes",
    "nombreEvaluadorDesempeno","mail1","mail2"
  ],

  // ‚úÖ NUEVO: Resumen IA solo usa llaves
  resumen_ia: [
    "noPersonal","periodo","version"
  ]
};

function renderFormPreview(){
  const tipo = $("tipoFormulario")?.value || "autoevaluacion";
  const host = $("formPreview");
  if(!host) return;

  const reqIds = REQUIRED_FIELDS[tipo] || [];

  const fieldNames = reqIds.map(id=>{
    const el = $(id);
    if(el) return fieldLabel(el);
    return id;
  });

  let html = "";

  // ‚úÖ En Resumen IA: SOLO Datos del colaborador (llaves)
  if(tipo === "resumen_ia"){
    html += `<div class="preview-title">Datos del colaborador</div>`;
    html += `<ul class="preview-list">` + fieldNames.map(x=>`<li>${escapeHtml(String(x))}</li>`).join("") + `</ul>`;
    host.innerHTML = html;
    return;
  }

  // ‚úÖ Resto de formularios (comportamiento normal)
  html += `<div class="preview-title">Campos requeridos</div>`;
  html += `<ul class="preview-list">` + fieldNames.map(x=>`<li>${escapeHtml(String(x))}</li>`).join("") + `</ul>`;

  // √çtems: solo aplican a autoevaluaci√≥n y desempe√±o
  if(tipo === "autoevaluacion" || tipo === "desempeno"){
    const flatItems = [];
    ITEMS.forEach(sec => sec.items.forEach(it => flatItems.push({ group: sec.group, label: it.label })));

    html += `<div class="preview-title">√çtems (1‚Äì5) a evaluar</div>`;
    html += `<div class="preview-note">${flatItems.length} √≠tems configurados.</div>`;
    html += `<ul class="preview-list">` + flatItems.map(x=>`<li><b>${escapeHtml(x.group)}:</b> ${escapeHtml(x.label)}</li>`).join("") + `</ul>`;
  }else{
    html += `<div class="preview-title">√çtems (1‚Äì5)</div>`;
    html += `<div class="preview-note">Este formulario no usa r√∫bricas por √≠tem (los datos se generan desde la hoja).</div>`;
  }

  host.innerHTML = html;
}

function isVisible(el){
  return !!(el && el.offsetParent !== null);
}

function fieldLabel(el){
  const wrap = el.closest("div");
  const lab = wrap ? wrap.querySelector("label") : null;
  return lab ? lab.textContent.trim() : (el.id || "Campo sin nombre");
}

function validateBeforeSave(){
  const tipo = $("tipoFormulario")?.value || "autoevaluacion";

  const missingFields = [];
  const missingItems  = [];

  // 1) Validar campos obligatorios por tipo (IDs)
  const required = REQUIRED_FIELDS[tipo] || [];
  required.forEach(id=>{
    const el = $(id);
    if(!el) { // si no existe, lo tratamos como faltante porque el formulario qued√≥ inconsistente
      missingFields.push(id);
      return;
    }

    // si est√° oculto, no lo exigimos (pero en tu UI, los requeridos normalmente est√°n visibles)
    if(!isVisible(el) || el.disabled) return;

    const val = String(el.value || "").trim();
    if(!val) missingFields.push(fieldLabel(el));
  });

// 2) Validar √≠tems 1‚Äì5 (solo autoevaluaci√≥n y desempe√±o)
  // ‚úÖ Resumen IA NO usa √≠tems
  if(tipo === "autoevaluacion" || tipo === "desempeno"){
    ensureItemsVisibleIfNeeded();

    // Busca TODOS los selects de √≠tems (ans_)
    const itemSelects = Array.from(document.querySelectorAll("select[id^='ans_']"))
      .filter(el => isVisible(el) && !el.disabled);

    itemSelects.forEach(sel=>{
      const v = String(sel.value || "").trim();
      if(!v){
        // tratar de sacar el t√≠tulo del √≠tem
        const row = sel.closest("div")?.parentElement;
        const itemTitle = row?.querySelector("div > div")?.textContent?.trim();
        missingItems.push(itemTitle || sel.id);
      }
    });
  }

  return {
    ok: missingFields.length === 0 && missingItems.length === 0,
    missingFields,
    missingItems
  };
}

function showSaveValidationErrors(v){
  const msgs = [];

  if(v.missingFields && v.missingFields.length){
    msgs.push("‚ùå Campos obligatorios sin llenar:\n- " + v.missingFields.join("\n- "));
  }
  if(v.missingItems && v.missingItems.length){
    msgs.push("‚ùå √çtems sin seleccionar (1‚Äì5):\n- " + v.missingItems.join("\n- "));
  }

  alert(
    "No se puede Guardar todav√≠a üòÖ\n\n" +
    msgs.join("\n\n") +
    "\n\nCompleta todo y vuelve a intentar."
  );
}

function updateSaveEnabled(){
  const btn = $("btnSave");
  if(!btn) return;

  if(state.saving){
    btn.disabled = true;
    return;
  }

  const v = validateBeforeSave();
  btn.disabled = !v.ok;
}
  
/* ---------- Guardar (btnSave) ---------- */
async function saveCurrent(){
  if(state.saving) return;
  // ‚úÖ VALIDACI√ìN FINAL (bloquea guardado real)
  const v = validateBeforeSave();
  if(!v.ok){
    showSaveValidationErrors(v);
 if(typeof renderFormPreview === "function") renderFormPreview();    
    updateSaveEnabled(); // recalcula por si algo cambi√≥
    return;
  }

  const header = getHeaderData();
  const extra  = getExtraFields();
  const answersText = flattenAnswersSelectedText();

  const payload = {
  action: "guardar",
  ...header,
  ...extra,
  ...answersText,

  // ‚úÖ CLAVE: esto mapea directo a la columna Puntaje
  puntaje: (header.tipo === "clientes") ? 0 : computeTotal(),

  // (Opcional) conservar "total" por compatibilidad, pero ya no dependes de √©l
  total: (header.tipo === "clientes") ? 0 : computeTotal()
};

  function _isEmpty(v){
    return v == null || (typeof v === "string" && v.trim() === "");
  }
  function _prunePayload(obj){
    const keep = new Set(["action","tipo","no_personal","periodo","version"]);
    Object.keys(obj).forEach(k=>{
      if(keep.has(k)) return;
      const v = obj[k];
      if(typeof v === "number"){
        if(!Number.isFinite(v)) delete obj[k];
        return;
      }
      if(typeof v === "boolean") return;
      if(_isEmpty(v)) delete obj[k];
    });
    return obj;
  }
  _prunePayload(payload);

  try{
    setBusy(true);
    $("apiHint").className = "warn";
    $("apiHint").textContent = "Guardando‚Ä¶";

    const body = new URLSearchParams(payload).toString();

    await fetch(API_URL, {
    method: "POST",
    mode: "no-cors",
    body
    });

      $("apiHint").className = "ok";
    $("apiHint").textContent = "Guardado enviado ‚úÖ (verifica en Google Sheets)";
    setDirty(false);

    // ‚úÖ NUEVO: al guardar, limpiar campos igual que "Nuevo"
    clearForm();
    applyTipoUI();

    // (Opcional) Volver a mostrar el mensaje de guardado
    $("apiHint").className = "ok";
    $("apiHint").textContent = "Guardado enviado ‚úÖ (verifica en Google Sheets)";

  }catch(e){
    console.error(e);
    $("apiHint").className = "err";
    $("apiHint").textContent = "Error guardando: " + (e.message || e);
    alert("No se pudo guardar.\n\n" + (e.message || e));
  }finally{
    setBusy(false);
  }
}

/* ---------- bind() (un solo sitio de listeners) ---------- */
function bind(){
  ensureClientesBox();

  [
    "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
    "comentariosColaborador","retroalimentacion","nombreEvaluador",
    "justificacion","comentariosEvaluador","fortalezas","oportunidades","proyeccion",
    "necesidadesCapacitacion","comentariosColaborador2","evaluacionClientes",
    "nombreEvaluadorDesempeno","mail1","mail2"
  ].forEach(id=>{
    const el = $(id);
    if(!el) return;
   el.addEventListener("input", ()=>{
  setDirty(true);
  updateSaveEnabled();
});
el.addEventListener("change", ()=>{
  setDirty(true);
  updateSaveEnabled();
});
  });

  const tipoSel = $("tipoFormulario");
  if(tipoSel){
 tipoSel.addEventListener("change", ()=>{
  applyTipoUI();
  setDirty(true);
  updateSaveEnabled();
});
  }

  $("btnNew")?.addEventListener("click", ()=>{
    if(state.saving) return;
    if(state.dirty && !confirm("Hay cambios sin guardar. ¬øLimpiar todo de todas formas?")) return;
    clearForm();
    applyTipoUI();
  });

  $("btnSave")?.addEventListener("click", async ()=>{
    if(state.saving) return;
    await saveCurrent();
  });

  $("btnRecover")?.addEventListener("click", async ()=>{
    if(state.saving) return;
    if($("tipoFormulario")?.value !== "desempeno"){
      alert("Recuperar solo est√° disponible en el Formulario de evaluaci√≥n del desempe√±o.");
      return;
    }
    await recoverByKeys();
  });

$("btnGenerate")?.addEventListener("click", ()=>{
  if(state.saving) return;
  const tipo = $("tipoFormulario")?.value || "";
  if(tipo === "resumen_ia"){
    generarResumenIA();
  }else{
    openReportModal();
  }
});

  $("btnPrint")?.addEventListener("click", ()=>{
    if(state.saving) return;
    doPrint();
  });

  $("btnPrintFromModal")?.addEventListener("click", ()=>{
    if(state.saving) return;
    doPrint();
  });

  $("btnCloseReport")?.addEventListener("click", closeReportModal);
  $("reportBackdrop")?.addEventListener("click", (e) => {
    if (e.target === $("reportBackdrop")) closeReportModal();
  });

  $("btnResumenIA")?.addEventListener("click", ()=>{
  if(state.saving) return;
  generarResumenIA();
});

  /* ======== FIX: Botones del modal "Registro encontrado" ======== */
  $("btnApplyRecovered")?.addEventListener("click", () => {
    if(!lastRecovered || !lastRecovered.rowParams){
      alert("No hay datos recuperados para autollenar.");
      return;
    }
    applyRecoveredToForm(lastRecovered.rowParams, lastRecovered.clientesInfo || null);
    closeRecoverModal();
  });

  $("btnCloseRecovered")?.addEventListener("click", () => {
    closeRecoverModal();
  });

  $("recoverBackdrop")?.addEventListener("click", (e) => {
    if (e.target === $("recoverBackdrop")) closeRecoverModal();
  });

  /* ‚úÖ IMPORTANTE: bind del modal de b√∫squeda (si est√°s usando el modal) */
  $("btnSearch")?.addEventListener("click", searchRecords);
  $("btnClearSearch")?.addEventListener("click", ()=>{
    $("qNoPersonal").value = "";
    $("qNombre").value = "";
    $("qPeriodo").value = "";
    $("qVersion").value = "";
    renderLookupResults([], null);
    setLookupStatus("Listo para buscar.", "warn");
  });
  $("btnCloseLookup")?.addEventListener("click", closeLookupModal);
} // <-- cierre de bind()

/* ‚úÖ INIT √öNICO: aqu√≠ estaba el ‚Äúmissing piece‚Äù */
document.addEventListener("DOMContentLoaded", async () => {
  try{
    bind();                 // activa listeners
    applyTipoUI();          // muestra/oculta secciones por tipo
    ensureItemsVisibleIfNeeded(); // renderiza √≠tems para autoevaluaci√≥n/desempe√±o
    setFechaHoyDefault(false); // ‚úÖ pone HOY solo si est√° vac√≠o
    await apiPing();        // opcional: estado API
    updateSaveEnabled();
  }catch(e){
    console.error(e);
  }
});

/* ESC cierra modal recuperado */
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    const rb = $("recoverBackdrop");
    if (rb && rb.style.display === "flex") closeRecoverModal();

    const rep = $("reportBackdrop");
    if (rep && rep.style.display === "flex") closeReportModal();

    const lk = $("lookupBackdrop");
    if (lk && lk.style.display === "flex") closeLookupModal();
  }
});
</script>
</body>
</html>
 
