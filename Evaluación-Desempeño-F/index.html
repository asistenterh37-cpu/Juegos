<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluación del desempeño</title>
  <style>
    :root{
      --bg:#050a14;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --brand:#2f7bff;
      --brand2:#4aa3ff;
      --ok:#23c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;

      --p-border:#e6e6e6;
      --p-gray:#f7f7f7;
      --p-ink:#111;
      --p-sub:#444;
      --p-hi:#dbeafe;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px 700px at 30% -10%, rgba(47,123,255,.25), transparent 60%),
        radial-gradient(900px 650px at 70% 20%, rgba(124,58,237,.18), transparent 55%),
        linear-gradient(180deg, #040816, #02040b 60%);
      color:var(--text);
    }
    .wrap{max-width:1180px; margin:28px auto; padding:0 18px 80px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px; border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      position:sticky; top:12px; z-index:20; backdrop-filter: blur(10px);
      gap:14px;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px; height:46px; border-radius:14px; display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(47,123,255,.95), rgba(74,163,255,.85));
      font-weight:800; letter-spacing:.5px; flex:0 0 auto;
    }
    .titles h1{margin:0; font-size:20px}
    .titles p{margin:2px 0 0; font-size:13px; color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid var(--stroke);
      background:rgba(0,0,0,.22); color:var(--muted); font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:10px; height:10px; border-radius:50%;}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:10px 16px;
      font-weight:650;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s opacity;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.09)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 26px rgba(47,123,255,.25);
    }
    .btn.ghost{background:transparent}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px;}
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      padding:18px;
    }
    .card h2{margin:0 0 6px; font-size:18px;}
    .card p{margin:0; color:var(--muted); font-size:13px}
    .form-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .form-grid{grid-template-columns: 1fr}
      .actions{justify-content:flex-end}
      .topbar{flex-wrap:wrap}
    }

    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(74,163,255,.55);
      box-shadow: 0 0 0 2px rgba(47,123,255,.18), 0 12px 30px rgba(47,123,255,.10);
      outline:none;
      color:var(--text);
      background: rgba(0,0,0,.25);
    }

    /* ✅ Realzar flecha del SELECT (Tipo de formulario) */
    /* ✅ Realzar flecha del SELECT (Tipo de formulario) + círculo alrededor */
select{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  padding-right:62px; /* más espacio para círculo + flecha */

  /* 2 fondos: 1) círculo (abajo) 2) flecha (arriba) */
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='34' height='34' viewBox='0 0 36 36'%3E%3Ccircle cx='18' cy='18' r='14.5' fill='rgba(0,0,0,0.25)' stroke='rgba(74,163,255,0.95)' stroke-width='2'/%3E%3C/svg%3E"),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%234aa3ff' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");

  background-repeat:no-repeat, no-repeat;

  /* ambos a la derecha, centrados verticalmente */
  background-position:
    right 12px center,
    right 20px center;

  /* tamaño del círculo y de la flecha */
  background-size:
    32px 32px,
    18px 18px;
}

/* (Opcional pero bonito) al enfocar, que el círculo “brille” un poco */
select:focus{
  box-shadow: 0 0 0 3px rgba(74,163,255,.22), 0 12px 30px rgba(47,123,255,.12);
}

    textarea{min-height:90px; resize:vertical;}
    .section-title{display:flex; align-items:center; justify-content:space-between; margin:14px 0 8px;}
    .section-title h3{margin:0; font-size:16px}
    .muted{color:var(--muted)}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:16px 0;}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .warn{color:#ffd28b}
    .ok{color:#9dffb6}
    .err{color:#ffb4b4}

    .searchField label{ color: rgba(234,240,255,.92); font-weight: 800; letter-spacing: .2px; }
    .searchField input{
      border:1px solid rgba(74,163,255,.55);
      box-shadow: 0 0 0 2px rgba(47,123,255,.15), 0 12px 30px rgba(47,123,255,.10);
    }
    .searchBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(47,123,255,.18);
      border:1px solid rgba(74,163,255,.35);
      color:rgba(234,240,255,.90);
      font-size:12px; font-weight:750;
    }
    .searchBadge .dot{background: rgba(74,163,255,.95);}

    /* ✅ Realce de campos solicitados */
    .highlightField label{ color: rgba(234,240,255,.96); font-weight: 900; letter-spacing: .15px; }
    .highlightField textarea, .highlightField input{
      border:1px solid rgba(74,163,255,.70);
      box-shadow: 0 0 0 2px rgba(47,123,255,.18), 0 12px 30px rgba(47,123,255,.12);
    }
    .highlightBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(74,163,255,.14);
      border:1px solid rgba(74,163,255,.30);
      color:rgba(234,240,255,.92);
      font-size:12px; font-weight:900;
      margin-top:10px;
    }
    .highlightBadge .dot{background: rgba(74,163,255,.95);}

    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center; justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .modal{
      width:min(1100px, 96vw);
      max-height: min(86vh, 900px);
      overflow:auto;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
    }
    .modal-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:16px 16px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.05));
      backdrop-filter: blur(10px);
      z-index:2;
    }
    .modal-title{ margin:0; font-size:16px; font-weight:900; }
    .modal-sub{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .modal-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .tag-ok{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: rgba(234,240,255,.90);
      font-size:12px; font-weight:800;
    }
    .tag-ok .dot{background: var(--ok);}

    .modal-body{padding:14px 16px 18px;}
    .mini-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .mini-table th, .mini-table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      vertical-align:top;
      font-size:13px;
      word-wrap:break-word;
    }
    .mini-table th{
      background: rgba(0,0,0,.20);
      text-align:left;
      font-weight:900;
      font-size:12px;
      color: rgba(234,240,255,.85);
    }
    .mini-table tr:last-child td{border-bottom:none;}
    .col-k{width:34%; font-weight:800;}
    .col-v{width:auto;}

    .items-table{
      margin-top:14px;
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .items-table th, .items-table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      font-size:12px;
      vertical-align:top;
      word-wrap:break-word;
    }
    .items-table th{
      background: rgba(0,0,0,.20);
      font-weight:900;
      color: rgba(234,240,255,.85);
      text-align:left;
    }
    .items-table tr:last-child td{border-bottom:none;}
    .it-col1{width:26%;}
    .it-col2{width:30%;}
    .it-col3{width:10%; text-align:center; font-weight:900;}
    .it-col4{width:auto;}
    .group-row td{
      background: rgba(255,255,255,.06);
      font-weight:950;
      color: rgba(234,240,255,.92);
    }

    .lookup-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px; }
    @media (max-width: 980px){ .lookup-grid{grid-template-columns: 1fr} }
    .lookup-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    .small-muted{font-size:12px; color:var(--muted)}
    .results-wrap{margin-top:14px;}
    .results-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
    }
    .results-table th,.results-table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      font-size:12px;
      vertical-align:top;
      word-wrap:break-word;
    }
    .results-table th{
      background: rgba(0,0,0,.20);
      font-weight:900;
      color: rgba(234,240,255,.85);
      text-align:left;
    }
    .results-table tr:last-child td{border-bottom:none;}
    .r-col-act{width:190px; text-align:center;}
    .r-col-row{width:90px; text-align:center; font-weight:900;}
    .r-col-np{width:130px;}
    .r-col-per{width:110px;}
    .r-col-ver{width:90px; text-align:center;}
    .r-col-fecha{width:130px;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: rgba(234,240,255,.88);
      font-weight:750;
    }

    .print-area{margin-top:20px; display:none;}
    .report{
      background:#fff;
      color:var(--p-ink);
      border-radius:18px;
      padding:20px;
      border:1px solid #e8e8e8;
    }
    .report-head{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      margin-bottom:10px;
    }
    .report-head h1{margin:0; font-size:32px; letter-spacing:.2px;}
    .report-head .small{font-size:12px; color:var(--p-sub); text-align:right;}
    .report-sub{margin:0 0 14px; color:var(--p-sub)}
    .report-kv{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;}
    .kv-row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .kv{border:1px solid var(--p-border); padding:10px 12px; border-radius:12px;}
    .kv .k{font-size:11px; color:#666; margin-bottom:3px}
    .kv .v{font-size:13px; font-weight:650}

    .rubric-wrap{margin-top:14px;}
    .rubric-title{margin:0 0 6px; font-size:15px; color:var(--p-ink); font-weight:800;}
    .sel-table{width:100%; border-collapse:collapse; table-layout:fixed; border:1px solid var(--p-border);}
    .sel-table th, .sel-table td{border:1px solid var(--p-border); padding:8px 8px; vertical-align:top; font-size:11px; word-wrap:break-word;}
    .sel-table th{background:var(--p-gray); text-align:left; font-weight:800; font-size:11px;}
    .col-item{width:32%; font-weight:700;}
    .col-score{width:10%; text-align:center; font-weight:800;}
    .col-desc{width:auto;}
    .muted-print{color:#555}

    .block{margin-top:14px;}
    .block h2{margin:0 0 6px; font-size:15px;}
    .block .box{
      border:1px solid var(--p-border);
      border-radius:12px;
      padding:10px 12px;
      min-height:48px;
      font-size:12px;
      white-space:pre-wrap;
    }

    @media print{
      body{background:#fff}
      .wrap{max-width:none; margin:0; padding:0}
      .topbar, .no-print, .modal-backdrop{display:none !important}
      .print-area{display:block !important}
      .report{border:none; border-radius:0; padding:0}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar no-print">
      <div class="brand">
        <div class="logo">ED</div>
        <div class="titles">
          <h1 id="appTitle">Formulario de evaluación del desempeño</h1>
          <p>Escala 1–5 • Guardado en Google Sheets • Reporte PDF (solo opción seleccionada)</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" title="Estado">
          <span class="dot" id="stateDot" style="background: var(--ok)"></span>
          <span id="stateText">Sin cambios</span>
        </div>
        <button class="btn primary" id="btnNew" type="button">Nuevo</button>

        <!-- ✅ Recuperar SOLO existe en Desempeño -->
        <button class="btn primary" id="btnRecover" type="button" style="display:none;">Recuperar</button>

        <button class="btn primary" id="btnGenerate" type="button">Generar</button>
        <button class="btn primary" id="btnSave" type="button">Guardar</button>
        <button class="btn" id="btnPrint" type="button">Imprimir / Enviar a PDF</button>
      </div>
    </div>

    <div class="grid no-print">

      <div class="card">
        <h2>Tipo de formulario</h2>
        <p>Selecciona el tipo para mostrar/ocultar campos automáticamente.</p>

        <div class="form-grid" style="grid-template-columns: 1fr;">
          <div>
            <label>Tipo</label>
            <select id="tipoFormulario">
              <option value="autoevaluacion" selected>Formulario de autoevaluación</option>
              <option value="clientes">Formulario evaluación clientes</option>
              <option value="desempeno">Formulario de evaluación del desempeño</option>
            </select>
            <div class="hint">El guardado siempre va a Google Sheets (Web App de Apps Script).</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Datos del colaborador</h2>
        <p>
          Completa la información y selecciona una opción (1–5) para cada ítem.
          &nbsp;&nbsp;
          <span id="searchBadgeWrap" style="display:none;">
            <span class="searchBadge"><span class="dot"></span>Campos de búsqueda: No. personal • Periodo • Versión</span>
          </span>
        </p>

        <div class="form-grid">
          <div id="fldNoPersonal">
            <label>No. de personal</label>
            <input id="noPersonal" placeholder="Ej. 1600" />
          </div>
          <div>
            <label>Nombre</label>
            <input id="nombre" placeholder="Ej. Carlos Paz" />
          </div>
          <div>
            <label>Posición</label>
            <input id="posicion" placeholder="Ej. Analista" />
          </div>
          <div>
            <label>Departamento</label>
            <input id="departamento" placeholder="Ej. Contabilidad" />
          </div>
          <div id="fldPeriodo">
            <label>Periodo</label>
            <input id="periodo" placeholder="Ej. 2025" />
          </div>
          <div id="fldVersion">
            <label>Versión</label>
            <input id="version" placeholder="Ej. 1" />
          </div>
          <div>
            <label>Fecha</label>
            <input id="fecha" type="date" />
          </div>
        </div>

        <div class="hint">Estado API: <span id="apiHint" class="warn">Verificando conexión…</span></div>
      </div>

      <div class="card" id="evalCard">
        <div class="section-title">
          <h3>Evaluación (1–5)</h3>
          <span class="muted">Selecciona una opción por ítem</span>
        </div>
        <div id="itemsContainer"></div>

        <div id="autoComentariosBox" style="display:none; margin-top:14px;">
          <div class="divider"></div>
          <h3 style="margin:0 0 6px;">Comentarios del colaborador</h3>
          <p class="muted" style="margin:0 0 10px;">Incluye observaciones, ejemplos, mejoras o apoyo requerido.</p>
          <textarea id="comentariosColaborador" placeholder="Comentarios del colaborador..."></textarea>
        </div>
      </div>

    <div class="card" id="desempenoCamposBox" style="display:none;">
  <h2>Justificación y comentarios</h2>
  <p>Completa los campos siguientes (según formato).</p>

  <div class="highlightBadge">
    <span class="dot"></span>
    Campos realzados: Justificación • Comentarios • Fortalezas • Oportunidades • Proyección • Evaluación clientes • Necesidades de capacitación • Nombre del evaluador • Mail1 • Mail2
  </div>

  <div style="margin-top:14px;" class="highlightField">
    <label>Justificación calificaciones (1 - 6)</label>
    <textarea id="justificacion" placeholder="Describe la justificación de las calificaciones..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Comentarios del evaluador</label>
    <textarea id="comentariosEvaluador" placeholder="Comentarios del evaluador..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Fortalezas</label>
    <textarea id="fortalezas" placeholder="Fortalezas..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Oportunidades de mejora</label>
    <textarea id="oportunidades" placeholder="Oportunidades de mejora..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Proyección y potencial de desarrollo</label>
    <textarea id="proyeccion" placeholder="Proyección y potencial..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Necesidades de capacitación</label>
    <textarea id="necesidadesCapacitacion" placeholder="Necesidades de capacitación..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Comentarios del colaborador</label>
    <textarea id="comentariosColaborador2" placeholder="Comentarios del colaborador..."></textarea>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Evaluación clientes (autollenado desde hoja Clientes)</label>
    <textarea id="evaluacionClientes" placeholder="Evaluación clientes..."></textarea>
    <div class="hint">Al recuperar (desempeño), se autocompleta con retroalimentación y nombre del evaluador (si existe).</div>
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Nombre del evaluador</label>
    <input id="nombreEvaluadorDesempeno" type="text" placeholder="Ej. Daniel Coello" />
  </div>

  <!-- ✅ NUEVO: Mail1 / Mail2 (ya los estás leyendo en JS, aquí los hacemos visibles) -->
  <div style="margin-top:12px;" class="highlightField">
    <label>Mail 1</label>
    <input id="mail1" type="email" placeholder="ej. evaluador@empresa.com" />
  </div>

  <div style="margin-top:12px;" class="highlightField">
    <label>Mail 2</label>
    <input id="mail2" type="email" placeholder="ej. rrhh@empresa.com" />
  </div>
</div>
    </div>

    <!-- ✅ Modal Recuperar (queda, pero ahora Recuperar por llaves usa el modal de detalle) -->
    <div class="modal-backdrop" id="lookupBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lookupTitle">
        <div class="modal-head">
          <div>
            <div class="modal-title" id="lookupTitle">Recuperar registros (Desempeño)</div>
            <div class="modal-sub" id="lookupSub">Busca por No. personal / Nombre / Periodo / Versión y selecciona una fila para ver detalles.</div>
          </div>
          <div class="modal-actions">
            <button class="btn" id="btnCloseLookup" type="button">Cerrar</button>
          </div>
        </div>

        <div class="modal-body">
          <div class="card" style="padding:14px; background:rgba(0,0,0,.14)">
            <div class="lookup-grid">
              <div>
                <label>No. de personal</label>
                <input id="qNoPersonal" placeholder="Ej. 1600" />
              </div>
              <div>
                <label>Nombre (contiene)</label>
                <input id="qNombre" placeholder="Ej. Carlos" />
              </div>
              <div>
                <label>Periodo</label>
                <input id="qPeriodo" placeholder="Ej. 2025" />
              </div>
              <div>
                <label>Versión</label>
                <input id="qVersion" placeholder="Ej. 1" />
              </div>
            </div>

            <div class="lookup-actions">
              <button class="btn primary" id="btnSearch" type="button">Buscar</button>
              <button class="btn" id="btnClearSearch" type="button">Limpiar</button>
              <span class="small-muted" id="lookupStatus">Listo para buscar.</span>
            </div>

            <div class="hint">
              Tip: si llenas No. personal + Periodo + Versión, la búsqueda queda “quirúrgica”.
              Si no, te devuelve una lista (máx. 50).
            </div>
          </div>

          <div class="results-wrap">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;">
              <div class="chip" id="chipCount">0 resultados</div>
              <div class="small-muted" id="chipNote"></div>
            </div>

            <table class="results-table" style="margin-top:10px;">
              <thead>
                <tr>
                  <th class="r-col-act">Acción</th>
                  <th class="r-col-row">Fila</th>
                  <th class="r-col-np">No. personal</th>
                  <th>Nombre</th>
                  <th class="r-col-per">Periodo</th>
                  <th class="r-col-ver">Versión</th>
                  <th class="r-col-fecha">Fecha</th>
                  <th>Departamento</th>

                  <!-- ✅ SIEMPRE incluir Clientes -->
                  <th>Retroalimentación (Clientes)</th>
                  <th>Evaluador (Clientes)</th>
                </tr>
              </thead>
              <tbody id="lookupResultsBody">
                <tr><td colspan="10" class="small-muted">Sin resultados aún.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  <!-- ✅ Modal Detalle Recuperado (Autollenar / Cerrar) -->
<div class="modal-backdrop" id="recoverBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="recoverTitle">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="recoverTitle">Registro encontrado</div>
        <div class="modal-sub" id="recoverSub">—</div>
      </div>

      <div class="modal-actions">
        <div class="tag-ok"><span class="dot"></span>Registro</div>

        <!-- ✅ Solo 1 opción de Autollenar -->
        <button class="btn primary" id="btnApplyRecovered" type="button">Autollenar todo</button>

        <!-- ✅ Cerrar en azul (igual que Autollenar) -->
        <button class="btn primary" id="btnCloseRecovered" type="button">Cerrar</button>
      </div>
    </div>

    <div class="modal-body">
      <div id="recoverKeyReport" style="margin-bottom:12px;"></div>

      <!-- ✅ Tabla completa Encabezado/Valor -->
      <div id="recoverAllCols" style="margin-bottom:12px;"></div>

      <div id="recoverGeneral"></div>
      <div id="recoverItems"></div>
    </div>
  </div>
</div>

    <!-- ✅ Modal Lookup (Lista de coincidencias / duplicados) -->
    <!-- ⚠️ FIX: este segundo modal tenía IDs DUPLICADOS que rompían Recuperar/Buscar.
         NO se elimina, solo se renombra para evitar colisión. -->
    <div class="modal-backdrop" id="lookupBackdrop2" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lookupTitle2">
        <div class="modal-head">
          <div>
            <div class="modal-title" id="lookupTitle2">Buscar registros (Autollenar desde Autoevaluación)</div>
            <div class="modal-sub">Si hay duplicados, selecciona la fila correcta y luego Autollenar.</div>
          </div>
          <div class="modal-actions">
            <span class="pill" id="lookupStatus2">Listo para buscar.</span>
            <button class="btn" id="btnCloseLookup2" type="button">Cerrar</button>
          </div>
        </div>

        <div class="modal-body">
          <div class="grid2" style="margin-bottom:12px;">
            <div class="field">
              <label>No. personal</label>
              <input id="qNoPersonal2" type="text" placeholder="Ej: 1234" />
            </div>
            <div class="field">
              <label>Nombre</label>
              <input id="qNombre2" type="text" placeholder="Ej: Juan Pérez" />
            </div>
            <div class="field">
              <label>Periodo</label>
              <input id="qPeriodo2" type="text" placeholder="Ej: 2025" />
            </div>
            <div class="field">
              <label>Versión</label>
              <input id="qVersion2" type="text" placeholder="Ej: V1" />
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
            <button class="btn primary" id="btnSearch2" type="button">Buscar</button>
            <button class="btn" id="btnClearSearch2" type="button">Limpiar</button>
            <div class="chip" id="chipCount2" style="margin-left:auto;">0 resultados</div>
          </div>

          <div class="small-muted" id="chipNote2" style="margin-bottom:10px;"></div>

          <table class="results-table" style="width:100%;">
            <thead>
              <tr>
                <th class="r-col-act">Acción</th>
                <th class="r-col-row">Fila</th>
                <th class="r-col-np">No. personal</th>
                <th>Nombre</th>
                <th class="r-col-per">Periodo</th>
                <th class="r-col-ver">Versión</th>
                <th class="r-col-fecha">Fecha</th>
                <th>Departamento</th>

                <!-- ✅ SIEMPRE incluir Clientes -->
                <th>Retroalimentación (Clientes)</th>
                <th>Evaluador (Clientes)</th>
              </tr>
            </thead>
            <tbody id="lookupResultsBody2">
              <tr><td colspan="10" class="small-muted">Sin resultados aún.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ✅ Modal Reporte Flotante -->
    <div class="modal-backdrop" id="reportBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reportTitleModal">
        <div class="modal-head">
          <div>
            <div class="modal-title" id="reportTitleModal">Reporte (vista previa)</div>
            <div class="modal-sub">Este reporte es flotante. Puedes imprimir / enviar a PDF.</div>
          </div>
          <div class="modal-actions">
            <button class="btn" id="btnCloseReport" type="button">Cerrar</button>
            <button class="btn primary" id="btnPrintFromModal" type="button">Imprimir / Enviar a PDF</button>
          </div>
        </div>

        <div class="modal-body">
          <div id="reportHost"></div>
        </div>
      </div>
    </div>

    <div class="print-area" id="printArea">
      <div class="report" id="report">
        <div class="report-head">
          <div>
            <h1 id="rTitle">Evaluación del desempeño</h1>
            <p class="report-sub">Generado automáticamente desde el formulario.</p>
          </div>
          <div class="small">
            <div><b>Generado:</b> <span id="rGenerated"></span></div>
          </div>
        </div>

        <div class="report-kv">
          <div class="kv-row">
            <div class="kv"><div class="k">No. de personal</div><div class="v" id="rNoPersonal">—</div></div>
            <div class="kv"><div class="k">Nombre</div><div class="v" id="rNombre">—</div></div>
          </div>
          <div class="kv-row">
            <div class="kv"><div class="k">Posición</div><div class="v" id="rPosicion">—</div></div>
            <div class="kv"><div class="k">Departamento</div><div class="v" id="rDepartamento">—</div></div>
          </div>
          <div class="kv-row" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="kv"><div class="k">Periodo</div><div class="v" id="rPeriodo">—</div></div>
            <div class="kv"><div class="k">Versión</div><div class="v" id="rVersion">—</div></div>
            <div class="kv"><div class="k">Fecha</div><div class="v" id="rFecha">—</div></div>
          </div>
        </div>

        <div id="rRubricas"></div>

        <div class="block">
          <h2>Puntaje total</h2>
          <div class="box" id="rTotal">0.00</div>
        </div>

        <div class="block" id="rComentariosBlock" style="display:none;">
          <h2>Comentarios del colaborador</h2>
          <div class="box" id="rComentarios">—</div>
        </div>

        <div class="block" id="rEvalClientesBlock" style="display:none;">
          <h2>Evaluación clientes</h2>
          <div class="box" id="rEvalClientes">—</div>
        </div>

        <div class="block" id="rNombreEvalBlock" style="display:none;">
          <h2>Nombre del evaluador</h2>
          <div class="box" id="rNombreEvaluadorDesempeno">—</div>
        </div>

        <div class="block" id="rJustifBlock" style="display:none;">
          <h2>Justificación y comentarios</h2>
          <div class="box" id="rJustifAll">—</div>
        </div>
      </div>
    </div>

  </div>
<script>
/************************************************************
 * ✅ FIX CRÍTICO:
 * - Eliminado <script> anidado (tenías <script> dentro de otro <script>)
 * - Eliminado comentario HTML <!-- ... --> dentro del script
 *   (eso también puede romper el JS)
 ************************************************************/

/************************************************************
 * 1) URL COMPLETA DEL APPS SCRIPT (/exec)
 ************************************************************/
const API_URL = "https://script.google.com/macros/s/AKfycbwvv2Ies3S8akO-vhoxCXbD3WEfETL1plyasdnsIQ3nOD26u1sTIpjiN3rj0AIFHcMaXQ/exec";

function normalizeApiUrl(u){
  let x = String(u || "").trim();
  if(!x) return "";
  x = x.replace(/\/dev(\b|$)/i, "/exec");
  x = x.replace(/\s+/g, "");
  return x;
}
function assertApiUrl(){
  const u = normalizeApiUrl(API_URL);
  if(!u || !/^https?:\/\//i.test(u) || !/\/exec(\?|$)/i.test(u)){
    throw new Error("API_URL inválida. Debe iniciar con https:// y terminar en /exec");
  }
}
function getApiCandidates(){
  const base = normalizeApiUrl(API_URL);
  const out = [];
  if(base) out.push(base);
  if(base && base.includes("?")) out.push(base.split("?")[0]);
  if(base && !base.includes("?")) out.push(base);
  return Array.from(new Set(out));
}
function makeCallbackName(){
  return "cb_" + Math.random().toString(36).slice(2);
}
function jsonpRequest(url, params){
  return new Promise((resolve, reject) => {
    const cbName = makeCallbackName();
    const script = document.createElement("script");
    script.async = true;

    const qs = new URLSearchParams({ ...params, callback: cbName, _ts: Date.now().toString() }).toString();
    const src = url + (url.includes("?") ? "&" : "?") + qs;
    script.src = src;

    let done = false;
    const timeout = setTimeout(() => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Timeout JSONP (no llegó callback). WebApp no pública (Anyone) o respuesta no ejecutable."));
    }, 25000);

    function cleanup(){
      clearTimeout(timeout);
      try{ delete window[cbName]; }catch(_){}
      if(script && script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = (data) => {
      if(done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    script.onerror = () => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Error de red (JSONP). Bloqueador/Firewall/DNS o endpoint inaccesible."));
    };

    document.body.appendChild(script);
  });
}

/* ✅ NUEVO: fallback por fetch (si JSONP es bloqueado).
   - Intenta leer JSON directo
   - Si viene “envuelto” tipo callback(...), lo desenvuelve */
async function fetchRequest(url, params){
  const qs = new URLSearchParams({ ...params, _ts: Date.now().toString() }).toString();
  const full = url + (url.includes("?") ? "&" : "?") + qs;

  const res = await fetch(full, {
    method: "GET",
    mode: "cors",
    credentials: "omit",
    redirect: "follow",
    cache: "no-store"
  });

  const txt = await res.text();

  // Intento JSON puro
  try{
    return JSON.parse(txt);
  }catch(_e){}

  // Intento “desenvolver” JSONP: algoComoCallback( {...} )
  const m = txt.match(/^[a-zA-Z_$][\w$]*\s*\(\s*([\s\S]*)\s*\)\s*;?\s*$/);
  if(m && m[1]){
    const inner = m[1];
    try{ return JSON.parse(inner); }catch(_e2){}
  }

  // Si no, devolvemos error con el contenido para depurar
  throw new Error("Respuesta no-JSON (fetch). Revisa doGet para JSON/JSONP. Contenido: " + txt.slice(0, 180));
}

async function apiRequestWithFallback(params){
  assertApiUrl();
  const candidates = getApiCandidates();
  let lastErr = null;

  // 1) JSONP primero
  for(const u of candidates){
    try{ return await jsonpRequest(u, params); }
    catch(e){ lastErr = e; }
  }

  // 2) Si JSONP falla, intentar fetch
  for(const u of candidates){
    try{ return await fetchRequest(u, params); }
    catch(e){ lastErr = e; }
  }

  throw lastErr || new Error("No se pudo conectar (JSONP+fetch) en ningún endpoint.");
}

async function apiPing(){
  try{
    const r = await apiRequestWithFallback({ action:"ping" });
    if(r && r.ok){
      $("apiHint").className = "ok";
      $("apiHint").textContent = "Conectado ✅";
      return true;
    }
    $("apiHint").className = "warn";
    $("apiHint").textContent = "API respondió, pero sin OK (revisa deploy).";
    return false;
  }catch(e){
    $("apiHint").className = "err";
    $("apiHint").textContent = "Sin conexión al WebApp (bloqueo o deploy).";
    return false;
  }
}

/************************************************************
 * ✅ ITEMS COMPLETO (19 ítems) — KEYS = Look.gs
 ************************************************************/
const ITEMS = [
  { group: "1. Cumplimiento y Productividad", items: [
    { key: "A_metas", label: "A. Cumplimiento de Metas. Grado de logro", rubric: [
      "Cumple menos del 70% de lo establecido; la falta de avance afecta los resultados esperados.",
      "Cumple 70–89% de lo establecido; presenta avances parciales o inconsistentes y requiere correcciones.",
      "Cumple 90–100% de las metas planificadas con calidad y dentro del tiempo establecido.",
      "Cumple 101–110% de las metas; entrega resultados adicionales o mejores de lo esperado.",
      "Cumple más del 110% de forma sostenida; impacto significativo y calidad superior."
    ]},
    { key: "B_eficiencia", label: "B. Eficiencia en el uso del tiempo, costos y recursos", rubric: [
      "Usa tiempo y recursos con errores graves que afectan la eficiencia.",
      "Muestra uso inestable del tiempo y recursos; requiere evaluaciones y correcciones frecuentes.",
      "Utiliza de manera adecuada el tiempo y los recursos, cumpliendo sin desperdicios significativos.",
      "Optimiza tiempo y recursos, generando mejoras sin afectar la calidad del trabajo.",
      "Maximiza la eficiencia de forma sostenida; mejora procesos y logra resultados superiores sin comprometer la calidad."
    ]},
    { key: "C_seguridad", label: "C. Cumplimiento de normas de seguridad", rubric: [
      "Incumple normas de seguridad y genera riesgos constantes para sí y el equipo.",
      "Cumple parcialmente las normas; requiere supervisión continua para evitar incidentes.",
      "Cumple todas las normas y actúa de manera segura en su trabajo diario.",
      "Se anticipa a riesgos, propone acciones preventivas y actúa con autonomía segura.",
      "Promueve cultura de seguridad; motiva a otros y contribuye a mantener ambientes sin incidentes."
    ]},
    { key: "D_prioriza", label: "D. Prioriza y organiza tareas adecuadamente", rubric: [
      "Desorganiza tareas; incumple plazos y afecta resultados importantes.",
      "Organiza parcialmente; inconsistencias en prioridades y manejo del tiempo.",
      "Gestiona tareas adecuadamente, cumple tiempos y mantiene orden en su trabajo.",
      "Organiza y prioriza con eficiencia; anticipa necesidades y mejora tiempos de entrega.",
      "Es referente en organización; redistribuye recursos, optimiza procesos y eleva la productividad del equipo."
    ]}
  ]},
  { group: "2. Calidad del Trabajo", items: [
    { key: "A_exactitud", label: "A. Exactitud y atención al detalle", rubric: [
      "Comete errores frecuentes y no identifica fallos evidentes; requiere supervisión constante.",
      "Presenta errores recurrentes por falta de revisión; exactitud inconsistente y requiere correcciones frecuentes.",
      "Realiza su trabajo con un nivel adecuado de precisión; puede cometer errores menores que no afectan resultados.",
      "Mantiene atención al detalle constante; comete pocos errores y revisa su trabajo de forma proactiva.",
      "Trabajo impecable; detecta errores propios y ajenos, propone mejoras y es referente en precisión."
    ]},
    { key: "B_estandares", label: "B. Cumple con estándares de calidad", rubric: [
      "Menos del 70% de entregables cumplen estándares; resultados inaceptables.",
      "70–89% cumplen estándares; requiere ajustes frecuentes.",
      "100% de entregables cumplen estándares establecidos.",
      "101–110%: entrega con calidad superior y consistente.",
      "Más del 110%: supera ampliamente estándares y produce resultados sobresalientes."
    ]},
    { key: "C_entregas", label: "C. Entregas a Tiempo (cumple con plazos establecidos)", rubric: [
      "Menos del 70% de entregas a tiempo; retrasos afectan el área.",
      "70–89% a tiempo; desempeño irregular.",
      "100% de entregas en plazos pactados.",
      "101–110%: se anticipa, cumple tiempos y mantiene calidad.",
      "Más del 110%: entrega antes, supera plazos con calidad y mejora eficiencia general."
    ]},
    { key: "D_errores", label: "D. Manejo de errores y mejoras", rubric: [
      "No reconoce ni corrige errores; genera reincidencias graves.",
      "Corrige parcialmente; mejora no constante, requiere supervisión.",
      "Detecta y corrige errores básicos cuando se le solicita; cumple lo necesario.",
      "Se anticipa a errores y propone soluciones preventivas que mejoran el proceso.",
      "Asegura procesos libres de errores; implementa mejoras continuas y es referente en calidad."
    ]}
  ]},
  { group: "3. Competencias y Habilidades", items: [
    { key: "A_conocimientos", label: "A. Conocimientos técnicos del puesto", rubric: [
      "Conocimientos por debajo de lo esperado; no domina funciones básicas.",
      "Gestiona parcialmente conocimientos; requiere apoyo frecuente.",
      "Posee conocimiento técnico y funcional adecuado para el puesto.",
      "Aplica conocimientos de manera confiable y constante.",
      "Domina conocimientos avanzados y es referente técnico en el área."
    ]},
    { key: "B_clientes", label: "B. Convincente respuesta técnica a clientes", rubric: [
      "Respuestas incorrectas/inconsistentes que generan desconfianza.",
      "Respuestas incompletas o poco claras; afecta calidad del servicio.",
      "Responde de forma adecuada y funcional, brindando confianza.",
      "Respuestas claras, específicas y confiables de manera constante.",
      "Respuestas sobresalientes y precisas; reconocido como referente por clientes y equipo."
    ]},
    { key: "C_problemas", label: "C. Resolución de problemas", rubric: [
      "No logra resolver problemas; afecta procesos y resultados.",
      "Resuelve parcialmente; requiere supervisión frecuente.",
      "Resuelve problemas básicos de manera satisfactoria y funcional.",
      "Resuelve problemas complejos con autonomía y confiabilidad.",
      "Anticipa problemas y desarrolla soluciones preventivas y estratégicas."
    ]},
    { key: "D_iniciativa", label: "D. Iniciativa y creatividad", rubric: [
      "No genera ideas ni propone mejoras.",
      "Propone ideas poco útiles o de aplicación limitada.",
      "Propone ideas funcionales y aplicables cuando es necesario.",
      "Genera ideas prácticas que optimizan procesos y agregan valor.",
      "Propone soluciones innovadoras con impacto positivo y sostenible."
    ]}
  ]},
  { group: "4. Actitud y Valores", items: [
    { key: "A_responsabilidad", label: "A. Responsabilidad y compromiso", rubric: [
      "Incumple compromisos y entrega resultados muy por debajo de lo esperado.",
      "Cumple de forma irregular; requiere seguimiento constante.",
      "Cumple responsabilidades de manera adecuada y confiable.",
      "Cumple consistentemente; genera seguridad y aporta valor.",
      "Inspira por su compromiso; es modelo de conducta para el equipo."
    ]},
    { key: "B_puntualidad", label: "B. Puntualidad y asistencia", rubric: [
      "Ausencias injustificadas frecuentes; llegadas tardías recurrentes sin aviso.",
      "Frecuencia de tardanza sin justificación clara; afecta la operación.",
      "Asiste regularmente y cumple horarios; tardanzas justificadas sin reincidencia.",
      "Puntual y asistencia confiable; comunica eventualidades oportunamente.",
      "Puntualidad impecable; referente y se adapta a horarios especiales sin afectar desempeño."
    ]},
    { key: "C_equipo", label: "C. Trabajo en equipo y cooperación", rubric: [
      "No coopera; genera conflictos y dificulta el trabajo del equipo.",
      "Coopera parcialmente; actitud inestable.",
      "Coopera cuando se le solicita, con resultados aceptables.",
      "Colabora activamente y aporta de forma confiable.",
      "Referente en equipo; promueve colaboración, sinergia y apoya a otros."
    ]},
    { key: "D_comunicacion", label: "D. Comunicación efectiva", rubric: [
      "Comunicación confusa; genera malentendidos graves.",
      "Comunicación incompleta/poco clara; requiere supervisión para asegurar entendimiento.",
      "Comunica lo necesario de forma clara y suficiente.",
      "Comunicación clara, precisa y constructiva; escucha activamente.",
      "Comunicación influyente y estratégica; facilita acuerdos y motiva a otros."
    ]}
  ]},
  { group: "5. Desarrollo y Potencial", items: [
    { key: "A_adaptacion", label: "A. Adaptación al cambio", rubric: [
      "Resiste activamente al cambio; afecta procesos y equipos.",
      "Se adapta parcialmente; con dificultad y resultados limitados.",
      "Se adapta lo necesario para mantener desempeño adecuado.",
      "Se adapta de forma autónoma y confiable a nuevas situaciones.",
      "Referente en adaptación; motiva y guía a otros en procesos de cambio."
    ]},
    { key: "B_aprender", label: "B. Disposición para aprender", rubric: [
      "No busca aprender; rechaza retroalimentación y capacitación.",
      "Aprende solo lo obligatorio; mínima aplicación práctica.",
      "Aprende lo necesario para mantener desempeño satisfactorio.",
      "Busca aprender constantemente y aplica lo aprendido en el trabajo.",
      "Aprendizaje continuo; comparte conocimientos y forma a otros."
    ]},
    { key: "C_liderazgo", label: "C. Liderazgo", rubric: [
      "No coordina ni dirige; genera desorden y afecta resultados.",
      "Lidera débilmente; bajo impacto en el equipo.",
      "Lidera tareas básicas con resultados adecuados y funcionales.",
      "Lidera con confianza, logrando resultados consistentes y estables.",
      "Inspira con visión clara; desarrolla a otros, fortalece cohesión y se convierte en referente."
    ]}
  ]}
];

const state = { dirty:false, generated:false, answers:{}, saving:false };
const $ = (id) => document.getElementById(id);

function setDirty(v){
  state.dirty = v;
  const dot = $("stateDot");
  const text = $("stateText");
  if(v){
    dot.style.background = "var(--warn)";
    text.textContent = "Cambios sin guardar";
  }else{
    dot.style.background = "var(--ok)";
    text.textContent = "Sin cambios";
  }
}
function setBusy(isBusy){
  state.saving = isBusy;
  $("btnSave").disabled = isBusy;
  $("btnGenerate").disabled = isBusy;
  $("btnPrint").disabled = isBusy;
  $("btnNew").disabled = isBusy;
  $("btnRecover").disabled = isBusy;
  $("tipoFormulario").disabled = isBusy;
}

function renderItems(){
  const container = $("itemsContainer");
  if(!container) return;
  container.innerHTML = "";

  ITEMS.forEach(section => {
    const sec = document.createElement("div");
    sec.className = "card";
    sec.style.background = "rgba(0,0,0,.10)";
    sec.style.border = "1px dashed rgba(255,255,255,.10)";
    sec.style.marginTop = "14px";

    const h = document.createElement("h3");
    h.textContent = section.group;
    h.style.margin = "0 0 10px";
    sec.appendChild(h);

    section.items.forEach(it => {
      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1.3fr .9fr";
      row.style.gap = "12px";
      row.style.padding = "10px 0";
      row.style.borderTop = "1px solid rgba(255,255,255,.08)";

      const left = document.createElement("div");
      const title = document.createElement("div");
      title.style.fontWeight = "800";
      title.textContent = it.label;
      const sub = document.createElement("div");
      sub.className = "muted";
      sub.style.fontSize = "12px";
      sub.textContent = "Selecciona 1–5 según la rúbrica.";
      left.appendChild(title);
      left.appendChild(sub);

      const right = document.createElement("div");
      const lab = document.createElement("label");
      lab.textContent = "Puntaje (1–5)";

      const sel = document.createElement("select");
      sel.id = "ans_" + it.key;

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Seleccionar...";
      sel.appendChild(opt0);

      for(let v=1; v<=5; v++){
        const o = document.createElement("option");
        o.value = String(v);
        const full = (it.rubric && it.rubric[v-1]) ? it.rubric[v-1] : "";
        o.textContent = full ? `${v} — ${full}` : `${v}`;
        sel.appendChild(o);
      }

      const saved = state.answers[it.key];
      if(typeof saved === "number" && saved >= 1 && saved <= 5){
        sel.value = String(saved);
      }

      sel.addEventListener("change", () => {
        state.answers[it.key] = sel.value ? Number(sel.value) : null;
        setDirty(true);
      });

      right.appendChild(lab);
      right.appendChild(sel);

      row.appendChild(left);
      row.appendChild(right);
      sec.appendChild(row);
    });

    container.appendChild(sec);
  });
}

function ensureItemsVisibleIfNeeded(){
  const tipoSel = $("tipoFormulario");
  const tipo = tipoSel ? tipoSel.value : "autoevaluacion";

  const container = $("itemsContainer");
  const evalCard = $("evalCard");

  // Si estamos en clientes, ocultamos la tarjeta completa y salimos
  if(tipo === "clientes"){
    if(evalCard) evalCard.style.display = "none";
    return;
  }

  // En autoevaluación y desempeño, la tarjeta debe estar visible
  if(evalCard) evalCard.style.display = "block";
  if(!container) return;

  // Render SIEMPRE si no hay nada (o si quedó vacío)
  if(container.children.length === 0){
    renderItems();
  }
}

function getHeaderData(){
  return {
    tipo: $("tipoFormulario").value,
    no_personal: $("noPersonal").value.trim(),
    nombre: $("nombre").value.trim(),
    posicion: $("posicion").value.trim(),
    departamento: $("departamento").value.trim(),
    periodo: $("periodo").value.trim(),
    version: $("version").value.trim(),
    fecha: $("fecha").value
  };
}

/* =========================
   FIX: NO anidar <script> aquí.
   (Solo código JS normal dentro del mismo <script> principal)
   ========================= */
function getExtraFields(){
  const tipo = $("tipoFormulario").value;

  // ✅ Autoevaluación: SOLO comentarios del colaborador
  if(tipo === "autoevaluacion"){
    return {
      comentarios_colaborador: ($("comentariosColaborador")?.value || "").trim()
    };
  }

  // ✅ Desempeño: campos extendidos (Justificación, capacitación, etc.)
  if(tipo === "desempeno"){
    return {
      justificacion: ($("justificacion")?.value || "").trim(),
      comentarios_evaluador: ($("comentariosEvaluador")?.value || "").trim(),
      nombre_evaluador: ($("nombreEvaluadorDesempeno")?.value || "").trim(),

      mail1: ($("mail1")?.value || "").trim(),
      mail2: ($("mail2")?.value || "").trim(),

      fortalezas: ($("fortalezas")?.value || "").trim(),
      oportunidades_mejora: ($("oportunidades")?.value || "").trim(),
      proyeccion_potencial: ($("proyeccion")?.value || "").trim(),
      necesidades_capacitacion: ($("necesidadesCapacitacion")?.value || "").trim(),
      comentarios_colaborador: ($("comentariosColaborador2")?.value || "").trim(),
      evaluacion_clientes: ($("evaluacionClientes")?.value || "").trim()
    };
  }

  // ✅ Clientes: SOLO retroalimentación + nombre evaluador
  if(tipo === "clientes"){
    return {
      retroalimentacion: ($("retroalimentacion")?.value || "").trim(),
      nombre_evaluador: ($("nombreEvaluador")?.value || "").trim()
    };
  }

  return {};
}

function getScoreFromDOM(itKey){
  const el = document.getElementById("ans_" + itKey);
  if(!el) return null;
  const v = String(el.value || "").trim();
  if(!v) return null;
  const n = Number(v);
  return (Number.isFinite(n) && n >= 1 && n <= 5) ? n : null;
}

function computeTotal(){
  const vals = [];
  ITEMS.forEach(sec => sec.items.forEach(it => {
    const n = getScoreFromDOM(it.key);
    if(typeof n === "number") vals.push(n);
  }));
  if(!vals.length) return 0;
  const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
  return +(avg * 20).toFixed(2);
}

function flattenAnswersSelectedText(){
  const out = {};
  ITEMS.forEach(sec => sec.items.forEach(it => {
    const n = getScoreFromDOM(it.key);
    if(typeof n === "number"){
      const desc = (it.rubric && it.rubric[n-1]) ? it.rubric[n-1] : "";
      out[it.key] = desc ? `${n} — ${desc}` : String(n);
      state.answers[it.key] = n;
    }else{
      out[it.key] = "";
      state.answers[it.key] = null;
    }
  }));
  return out;
}

function formatDateES(yyyy_mm_dd){
  if(!yyyy_mm_dd) return "—";
  const [y,m,d] = yyyy_mm_dd.split("-").map(n=>parseInt(n,10));
  if(!y || !m || !d) return yyyy_mm_dd;
  const dt = new Date(y, m-1, d);
  return dt.toLocaleDateString("es-HN");
}

function renderSeleccionEnReporte(){
  const host = $("rRubricas");
  host.innerHTML = "";
  ITEMS.forEach(sec => {
    const wrap = document.createElement("div");
    wrap.className = "rubric-wrap";
    const title = document.createElement("div");
    title.className = "rubric-title";
    title.textContent = sec.group;
    wrap.appendChild(title);

    const table = document.createElement("table");
    table.className = "sel-table";

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    trh.innerHTML = `<th class="col-item">Ítem</th><th class="col-score">Puntaje</th><th class="col-desc">Opción seleccionada</th>`;
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    sec.items.forEach(it => {
      const v = state.answers[it.key];
      const tr = document.createElement("tr");

      const tdItem = document.createElement("td");
      tdItem.className = "col-item";
      tdItem.textContent = it.label;

      const tdScore = document.createElement("td");
      tdScore.className = "col-score";
      tdScore.textContent = (typeof v === "number") ? String(v) : "—";

      const tdDesc = document.createElement("td");
      tdDesc.className = "col-desc";
      if(typeof v === "number" && it.rubric && it.rubric[v-1]){
        tdDesc.textContent = `${v} — ${it.rubric[v-1]}`;
      }else{
        tdDesc.innerHTML = `<span class="muted-print">Sin selección</span>`;
      }

      tr.appendChild(tdItem);
      tr.appendChild(tdScore);
      tr.appendChild(tdDesc);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrap.appendChild(table);
    host.appendChild(wrap);
  });
}

function openReportModal(){
  $("reportHost").innerHTML = $("report").outerHTML;
  $("reportBackdrop").style.display = "flex";
  $("reportBackdrop").setAttribute("aria-hidden", "false");
}
function closeReportModal(){
  $("reportBackdrop").style.display = "none";
  $("reportBackdrop").setAttribute("aria-hidden", "true");
}

function buildReport(){
  const header = getHeaderData();
  const extra = getExtraFields();
  const total = computeTotal();

  $("rTitle").textContent =
    (header.tipo === "autoevaluacion") ? "Autoevaluación del desempeño" :
    (header.tipo === "clientes") ? "Formulario evaluación clientes" :
    "Evaluación del desempeño";

  $("rGenerated").textContent = new Date().toLocaleString();
  $("rNoPersonal").textContent = header.no_personal || "—";
  $("rNombre").textContent = header.nombre || "—";
  $("rPosicion").textContent = header.posicion || "—";
  $("rDepartamento").textContent = header.departamento || "—";
  $("rPeriodo").textContent = header.periodo || "—";
  $("rVersion").textContent = header.version || "—";
  $("rFecha").textContent = formatDateES(header.fecha);

  // ✅ Ítems/rúbricas SOLO en autoevaluación y desempeño
  if(header.tipo !== "clientes"){
    renderSeleccionEnReporte();
  }else{
    // Si venía algo de antes, lo vaciamos
    const host = $("rRubricas");
    if(host) host.innerHTML = "";
  }

  $("rTotal").textContent = String((header.tipo === "clientes") ? 0 : total);

  // ✅ Comentarios del colaborador SOLO si aplica (autoevaluación o desempeño)
  const comentarioColab =
    (header.tipo === "autoevaluacion") ? (extra.comentarios_colaborador || "") :
    (header.tipo === "desempeno") ? (extra.comentarios_colaborador || "") : "";

  if(comentarioColab){
    $("rComentariosBlock").style.display = "block";
    $("rComentarios").textContent = comentarioColab;
  }else{
    $("rComentariosBlock").style.display = "none";
    $("rComentarios").textContent = "—";
  }

  // ✅ Bloques exclusivos de desempeño
  if((header.tipo === "desempeno") && extra.evaluacion_clientes){
    $("rEvalClientesBlock").style.display = "block";
    $("rEvalClientes").textContent = extra.evaluacion_clientes;
  }else{
    $("rEvalClientesBlock").style.display = "none";
    $("rEvalClientes").textContent = "—";
  }

  if(header.tipo === "desempeno" && extra.nombre_evaluador){
    $("rNombreEvalBlock").style.display = "block";
    $("rNombreEvaluadorDesempeno").textContent = extra.nombre_evaluador;
  }else{
    $("rNombreEvalBlock").style.display = "none";
    $("rNombreEvaluadorDesempeno").textContent = "—";
  }

  if(header.tipo === "desempeno"){
    const hasAny = (extra.justificacion || extra.comentarios_evaluador || extra.fortalezas || extra.oportunidades_mejora || extra.proyeccion_potencial || extra.necesidades_capacitacion);
    if(hasAny){
      $("rJustifBlock").style.display = "block";
      const txt = [
        `Justificación calificaciones (1-6): ${extra.justificacion || "—"}`,
        `Comentarios del evaluador: ${extra.comentarios_evaluador || "—"}`,
        `Fortalezas: ${extra.fortalezas || "—"}`,
        `Oportunidades de mejora: ${extra.oportunidades_mejora || "—"}`,
        `Proyección y potencial: ${extra.proyeccion_potencial || "—"}`,
        `Necesidades de capacitación: ${extra.necesidades_capacitacion || "—"}`
      ].join("\n\n");
      $("rJustifAll").textContent = txt;
    }else{
      $("rJustifBlock").style.display = "none";
      $("rJustifAll").textContent = "—";
    }
  }else{
    $("rJustifBlock").style.display = "none";
    $("rJustifAll").textContent = "—";
  }

  $("printArea").style.display = "block";
}

function parseScoreFromCell(val){
  const s = String(val || "").trim();
  if(!s) return null;
  const m = s.match(/^([1-5])\s*(?:[—-]|$)/);
  if(m) return Number(m[1]);
  const n = Number(s);
  if(Number.isFinite(n) && n>=1 && n<=5) return n;
  return null;
}

function setSelectValue(key, score){
  const el = $("ans_" + key);
  if(!el) return;
  el.value = (score>=1 && score<=5) ? String(score) : "";
  state.answers[key] = (score>=1 && score<=5) ? score : null;
}

/************************************************************
 * ✅ MODALES / RECUPERACIÓN
 ************************************************************/
let lastRecovered = null;

function openRecoverModal(){
  $("recoverBackdrop").style.display = "flex";
  $("recoverBackdrop").setAttribute("aria-hidden", "false");
}
function closeRecoverModal(){
  $("recoverBackdrop").style.display = "none";
  $("recoverBackdrop").setAttribute("aria-hidden", "true");
}
function openLookupModal(){
  $("lookupBackdrop").style.display = "flex";
  $("lookupBackdrop").setAttribute("aria-hidden", "false");
}
function closeLookupModal(){
  $("lookupBackdrop").style.display = "none";
  $("lookupBackdrop").setAttribute("aria-hidden", "true");
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderKeyReport(no_personal, periodo, version, sourceHint){
  const box = document.createElement("div");
  box.className = "card";
  box.style.padding = "12px";
  box.style.background = "rgba(0,0,0,.14)";
  box.innerHTML = `
    <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
      <div class="chip"><b>Reporte (llaves)</b></div>
      <div class="small-muted">${escapeHtml(sourceHint || "")}</div>
    </div>
    <table class="mini-table" style="margin-top:10px;">
      <thead><tr><th class="col-k">&nbsp;</th><th class="col-v">&nbsp;</th></tr></thead>
      <tbody>
        <tr><td class="col-k">No. personal</td><td class="col-v">${escapeHtml(no_personal || "—")}</td></tr>
        <tr><td class="col-k">Periodo</td><td class="col-v">${escapeHtml(periodo || "—")}</td></tr>
        <tr><td class="col-k">Versión</td><td class="col-v">${escapeHtml(version || "—")}</td></tr>
      </tbody>
    </table>
  `;
  const host = $("recoverKeyReport");
  host.innerHTML = "";
  host.appendChild(box);
}

function renderAllColumnsTable(allColumns){
  const host = $("recoverAllCols");
  host.innerHTML = "";
  const arr = Array.isArray(allColumns) ? allColumns : [];
  if(!arr.length){
    host.innerHTML = `<div class="small-muted">Sin datos de columnas para mostrar.</div>`;
    return;
  }
  const box = document.createElement("div");
  box.className = "card";
  box.style.padding = "12px";
  box.style.background = "rgba(0,0,0,.14)";
  box.innerHTML = `
    <div class="chip"><b>Datos recuperados (Encabezado / Valor)</b></div>
    <table class="mini-table" style="margin-top:10px;">
      <thead><tr><th class="col-k">&nbsp;</th><th class="col-v">&nbsp;</th></tr></thead>
      <tbody>
        ${arr.map(x => `
          <tr>
            <td class="col-k">${escapeHtml(String(x.header ?? ""))}</td>
            <td class="col-v">${escapeHtml(String(x.value ?? ""))}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  host.appendChild(box);
}

/* =========================================================
   ✅ FIX PRINCIPAL: NO HAY <script> ANIDADO AQUÍ
   - buildRecoverModal queda dentro del mismo script
   ========================================================= */
function buildRecoverModal(rowParams, meta, clientesInfo, allColumns){
  function showDash(v){
    const s = String(v ?? "").trim();
    return s ? s : "—";
  }
  function normKey(s){
    return String(s ?? "")
      .toLowerCase()
      .trim()
      .replace(/\s+/g, " ");
  }
  function pushUnique(rows, label, value){
    const k = normKey(label);
    if(!k) return;
    if(rows.some(([lbl]) => normKey(lbl) === k)) return;
    rows.push([label, value]);
  }

  lastRecovered = { rowParams, meta, clientesInfo, allColumns };

  $("recoverTitle").textContent = "Registro encontrado";
  $("recoverSub").textContent =
    `Keys: ${meta.no_personal || "—"} / ${meta.periodo || "—"} / ${meta.version || "—"} • Fila: ${meta.rowNumber || "—"}`;

  const hint = (clientesInfo && clientesInfo.found)
    ? `Autoevaluaciones + Clientes (fila Clientes: ${clientesInfo.rowNumber || "—"})`
    : `Autoevaluaciones (Clientes: sin registro)`;

  renderKeyReport(meta.no_personal, meta.periodo, meta.version, hint);

  // Debug opcional
  const SHOW_DEBUG_ALLCOLS = false;
  if(SHOW_DEBUG_ALLCOLS){
    renderAllColumnsTable(allColumns);
  }else{
    if($("recoverAllCols")) $("recoverAllCols").innerHTML = "";
  }

  // ---- Clientes (composición) ----
  const cliFound = !!(clientesInfo && clientesInfo.found);
  const cliRetro = cliFound ? String(clientesInfo.retroalimentacion || "").trim() : "";
  const cliEvalNom = cliFound ? String(clientesInfo.nombre_evaluador || "").trim() : "";

  let evalCli = String(rowParams.evaluacion_clientes || "").trim();
  if(cliFound){
    const head = cliEvalNom ? `(${cliEvalNom}) ` : "";
    const composed = `${head}${cliRetro}`.trim();
    if(composed) evalCli = composed;
  }

 // ---- Resumen general ----
  const generalRows = [];
  pushUnique(generalRows, "Nombre", showDash(rowParams.nombre));
  pushUnique(generalRows, "Posición", showDash(rowParams.posicion));
  pushUnique(generalRows, "Departamento", showDash(rowParams.departamento));
  pushUnique(generalRows, "Fecha", showDash(rowParams.fecha));

  pushUnique(generalRows, "Comentarios del colaborador", showDash(rowParams.comentarios_colaborador ?? rowParams.comentarios));
  // ❌ No incluir en la tabla del modal:
  // pushUnique(generalRows, "Justificación", showDash(rowParams.justificacion));
  pushUnique(generalRows, "Comentarios del evaluador", showDash(rowParams.comentarios_evaluador));
  pushUnique(generalRows, "Nombre del evaluador (desempeño)", showDash(rowParams.nombre_evaluador));
  // pushUnique(generalRows, "Fortalezas", showDash(rowParams.fortalezas));
  // pushUnique(generalRows, "Oportunidades", showDash(rowParams.oportunidades_mejora));
  // pushUnique(generalRows, "Proyección", showDash(rowParams.proyeccion_potencial));
  // pushUnique(generalRows, "Necesidades de capacitación", showDash(rowParams.necesidades_capacitacion));
  pushUnique(generalRows, "Evaluación clientes (desempeño)", showDash(evalCli));

  const gen = document.createElement("table");
  gen.className = "mini-table";
  gen.innerHTML = `
    <thead>
      <tr><th class="col-k">&nbsp;</th><th class="col-v">&nbsp;</th></tr>
    </thead>
    <tbody>
      ${generalRows.map(([k,v]) => `
        <tr>
          <td class="col-k">${escapeHtml(k)}</td>
          <td class="col-v">${escapeHtml(String(v ?? ""))}</td>
        </tr>
      `).join("")}
    </tbody>
  `;
  $("recoverGeneral").innerHTML = "";
  $("recoverGeneral").appendChild(gen);

  // ---- Items ----
  const it = document.createElement("table");
  it.className = "items-table";
  it.innerHTML = `
    <thead>
      <tr>
        <th class="it-col1">Grupo</th>
        <th class="it-col2">Ítem</th>
        <th class="it-col3">Puntaje</th>
        <th class="it-col4">Texto guardado (rúbrica / opción)</th>
      </tr>
    </thead>
    <tbody id="recoverItemsBody"></tbody>
  `;

  const tbody = it.querySelector("#recoverItemsBody");
  ITEMS.forEach(sec => {
    const trg = document.createElement("tr");
    trg.className = "group-row";
    trg.innerHTML = `<td colspan="4">${escapeHtml(sec.group)}</td>`;
    tbody.appendChild(trg);

    sec.items.forEach(item => {
      const raw = rowParams[item.key] ?? "";
      const score = parseScoreFromCell(raw);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="it-col1">${escapeHtml(sec.group)}</td>
        <td class="it-col2">${escapeHtml(item.label)}</td>
        <td class="it-col3">${score ? String(score) : "—"}</td>
        <td class="it-col4">${escapeHtml(raw)}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  $("recoverItems").innerHTML = "";
  $("recoverItems").appendChild(it);

  openRecoverModal();
}

function applyRecoveredToForm(rowParams, clientesInfo){
  $("noPersonal").value = rowParams.no_personal || $("noPersonal").value;
  $("periodo").value = rowParams.periodo || $("periodo").value;
  $("version").value = rowParams.version || $("version").value;
  $("nombre").value = rowParams.nombre || $("nombre").value;
  $("posicion").value = rowParams.posicion || $("posicion").value;
  $("departamento").value = rowParams.departamento || $("departamento").value;
  $("fecha").value = rowParams.fecha || $("fecha").value;

  $("tipoFormulario").value = "desempeno";
  applyTipoUI();

  if(rowParams.justificacion) $("justificacion").value = rowParams.justificacion;
  if(rowParams.comentarios_evaluador) $("comentariosEvaluador").value = rowParams.comentarios_evaluador;
  if(rowParams.nombre_evaluador && $("nombreEvaluadorDesempeno")) $("nombreEvaluadorDesempeno").value = rowParams.nombre_evaluador;

  /* ✅ NUEVO: recuperar mail1/mail2 si vienen */
  if(rowParams.mail1 && $("mail1")) $("mail1").value = rowParams.mail1;
  if(rowParams.mail2 && $("mail2")) $("mail2").value = rowParams.mail2;

  if(rowParams.fortalezas) $("fortalezas").value = rowParams.fortalezas;
  if(rowParams.oportunidades_mejora) $("oportunidades").value = rowParams.oportunidades_mejora;
  if(rowParams.proyeccion_potencial) $("proyeccion").value = rowParams.proyeccion_potencial;
  if(rowParams.necesidades_capacitacion) $("necesidadesCapacitacion").value = rowParams.necesidades_capacitacion;

  let evalCli = String(rowParams.evaluacion_clientes || "").trim();
  if(clientesInfo && clientesInfo.found){
    const head = clientesInfo.nombre_evaluador ? `(${clientesInfo.nombre_evaluador}) ` : "";
    const composed = `${head}${clientesInfo.retroalimentacion || ""}`.trim();
    if(composed) evalCli = composed;
    if(!$("nombreEvaluadorDesempeno").value && clientesInfo.nombre_evaluador){
      $("nombreEvaluadorDesempeno").value = clientesInfo.nombre_evaluador;
    }
  }
  if(evalCli) $("evaluacionClientes").value = evalCli;

  ensureItemsVisibleIfNeeded();
  ITEMS.forEach(sec => sec.items.forEach(it => {
    const raw = String(rowParams[it.key] ?? "").trim();
    const score = parseScoreFromCell(raw);
    setSelectValue(it.key, score);
  }));

  $("printArea").style.display = "none";
  state.generated = false;
  setDirty(false);
}

function applyRecoveredTextsOnly(rowParams, clientesInfo){
  $("tipoFormulario").value = "desempeno";
  applyTipoUI();

  if(rowParams.no_personal) $("noPersonal").value = rowParams.no_personal;
  if(rowParams.periodo) $("periodo").value = rowParams.periodo;
  if(rowParams.version) $("version").value = rowParams.version;
  if(rowParams.nombre) $("nombre").value = rowParams.nombre;
  if(rowParams.posicion) $("posicion").value = rowParams.posicion;
  if(rowParams.departamento) $("departamento").value = rowParams.departamento;
  if(rowParams.fecha) $("fecha").value = rowParams.fecha;

  if(rowParams.justificacion) $("justificacion").value = rowParams.justificacion;
  if(rowParams.comentarios_evaluador) $("comentariosEvaluador").value = rowParams.comentarios_evaluador;
  if(rowParams.fortalezas) $("fortalezas").value = rowParams.fortalezas;
  if(rowParams.oportunidades_mejora) $("oportunidades").value = rowParams.oportunidades_mejora;
  if(rowParams.proyeccion_potencial) $("proyeccion").value = rowParams.proyeccion_potencial;
  if(rowParams.necesidades_capacitacion) $("necesidadesCapacitacion").value = rowParams.necesidades_capacitacion;
  if(rowParams.nombre_evaluador && $("nombreEvaluadorDesempeno")) $("nombreEvaluadorDesempeno").value = rowParams.nombre_evaluador;

  /* ✅ NUEVO: recuperar mail1/mail2 si vienen */
  if(rowParams.mail1 && $("mail1")) $("mail1").value = rowParams.mail1;
  if(rowParams.mail2 && $("mail2")) $("mail2").value = rowParams.mail2;

  let evalCli = String(rowParams.evaluacion_clientes || "").trim();
  if(clientesInfo && clientesInfo.found){
    const head = clientesInfo.nombre_evaluador ? `(${clientesInfo.nombre_evaluador}) ` : "";
    const composed = `${head}${clientesInfo.retroalimentacion || ""}`.trim();
    if(composed) evalCli = composed;
    if(!$("nombreEvaluadorDesempeno").value && clientesInfo.nombre_evaluador){
      $("nombreEvaluadorDesempeno").value = clientesInfo.nombre_evaluador;
    }
  }
  if(evalCli) $("evaluacionClientes").value = evalCli;

  $("printArea").style.display = "none";
  state.generated = false;
  setDirty(false);
}

/************************************************************
 * ✅ LOOKUP MODAL (LISTA) — incluye Clientes SIEMPRE
 ************************************************************/
let lastLookupResults = [];
function setLookupStatus(txt, kind){
  const el = $("lookupStatus");
  el.textContent = txt;
  el.className = "small-muted " + (kind || "");
}

function renderLookupResults(rows, clientesInfo){
  const tbody = $("lookupResultsBody");
  lastLookupResults = Array.isArray(rows) ? rows : [];
  $("chipCount").textContent = `${lastLookupResults.length} resultados`;
  $("chipNote").textContent = lastLookupResults.length ? "Selecciona una fila para ver detalle y luego Autollenar." : "";

  const retro = (clientesInfo && clientesInfo.found) ? String(clientesInfo.retroalimentacion || "") : "";
  const evalNom = (clientesInfo && clientesInfo.found) ? String(clientesInfo.nombre_evaluador || "") : "";

  if(!lastLookupResults.length){
    tbody.innerHTML = `<tr><td colspan="10" class="small-muted">Sin resultados.</td></tr>`;
    return;
  }

  tbody.innerHTML = lastLookupResults.map((r, idx) => {
    const meta = r.meta || {};
    const rp = r.rowParams || {};
    return `
      <tr>
        <td class="r-col-act">
          <button class="btn primary" type="button" data-pick="${idx}" style="padding:8px 12px;">Seleccionar</button>
        </td>
        <td class="r-col-row">${escapeHtml(String(meta.rowNumber ?? "—"))}</td>
        <td class="r-col-np">${escapeHtml(String(rp.no_personal ?? ""))}</td>
        <td>${escapeHtml(String(rp.nombre ?? ""))}</td>
        <td class="r-col-per">${escapeHtml(String(rp.periodo ?? ""))}</td>
        <td class="r-col-ver">${escapeHtml(String(rp.version ?? ""))}</td>
        <td class="r-col-fecha">${escapeHtml(String(rp.fecha ?? ""))}</td>
        <td>${escapeHtml(String(rp.departamento ?? ""))}</td>
        <td>${escapeHtml(retro)}</td>
        <td>${escapeHtml(evalNom)}</td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-pick]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const i = Number(btn.getAttribute("data-pick"));
      const pick = lastLookupResults[i];
      if(!pick || !pick.meta || !pick.meta.rowNumber) return;

      try{
        setLookupStatus("Cargando detalle…", "warn");

        const data = await apiRequestWithFallback({
          action: "recuperar_por_fila",
          tipo: "autoevaluacion",
          rowNumber: String(pick.meta.rowNumber)
        });

        if(!data || !data.found || !data.rowParams){
          setLookupStatus("No se pudo abrir detalle.", "err");
          return;
        }

        buildRecoverModal(
          data.rowParams,
          {
            no_personal: data.rowParams.no_personal || "",
            periodo: data.rowParams.periodo || "",
            version: data.rowParams.version || "",
            rowNumber: data.rowNumber || pick.meta.rowNumber || ""
          },
          data.clientes || null,
          data.allColumns || []
        );

        setLookupStatus("Detalle cargado.", "ok");
      }catch(e){
        setLookupStatus("Error: " + (e.message || e), "err");
        alert("No se pudo abrir detalle: " + (e.message || e));
      }
    });
  });
}

/* ✅ Buscar (modal) */
async function searchRecords(){
  if(state.saving) return;
  const tipo = $("tipoFormulario").value;
  if(tipo !== "desempeno"){
    alert("Recuperar solo está disponible en el Formulario de evaluación del desempeño.");
    return;
  }

  const no_personal = $("qNoPersonal").value.trim();
  const nombre = $("qNombre").value.trim();
  const periodo = $("qPeriodo").value.trim();
  const version = $("qVersion").value.trim();

  try{
    assertApiUrl();
    setLookupStatus("Buscando en autoevaluaciones...", "warn");

    const data = await apiRequestWithFallback({
      action: "buscar",
      tipo: "autoevaluacion",
      no_personal,
      nombre,
      periodo,
      version,
      limit: "50"
    });

    if(!data || data.ok === false){
      const msg = (data && data.error) ? data.error : "Respuesta inválida del servidor.";
      setLookupStatus("Error: " + msg, "err");
      renderLookupResults([], null);
      return;
    }

    const rows = data.rows || [];
    renderLookupResults(rows, data.clientes || null);

    if(!rows.length){
      setLookupStatus("Sin resultados con esos filtros.", "warn");
    }else{
      setLookupStatus(`Listo. ${rows.length} resultado(s).`, "ok");
    }
  }catch(err){
    console.error(err);
    setLookupStatus("Error: " + (err.message || err), "err");
    renderLookupResults([], null);
    alert("No se pudo consultar.\n\n" + (err.message || err));
  }
}

/************************************************************
 * ✅ Recuperar (BOTÓN) — SIEMPRE MUESTRA TABLA
 ************************************************************/
  async function recoverByKeys(){
  if(state.saving) return;

  const tipoUI = $("tipoFormulario").value;
  if(tipoUI !== "desempeno"){
    alert("Recuperar solo está disponible en el Formulario de evaluación del desempeño.");
    return;
  }

  const no_personal = $("noPersonal").value.trim();
  const periodo = $("periodo").value.trim();
  const version = $("version").value.trim();

  if(!no_personal || !periodo || !version){
    alert("Para Recuperar, llena: No. de personal + Periodo + Versión.");
    return;
  }

  try{
    assertApiUrl();
    setBusy(true);
    $("apiHint").className = "warn";
    $("apiHint").textContent = "Recuperando…";

    try{ await apiPing(); }catch(_e){}

    const resp = await apiRequestWithFallback({
      action: "recuperar_desempeno_por_keys",
      no_personal,
      periodo,
      version
    });

    if(!resp || resp.ok === false){
      const msg = resp?.error || "Respuesta inválida recuperando por llaves.";
      $("apiHint").className = "err";
      $("apiHint").textContent = msg;
      alert(msg);
      return;
    }

    // ✅ Si hay duplicados: NO mostrar modal de "Recuperar registros"
    //    Abrimos directamente "Registro encontrado" con el PRIMER registro.
    if(resp.multi && Array.isArray(resp.rows) && resp.rows.length){
      $("apiHint").className = "warn";
      $("apiHint").textContent = `Duplicados detectados (${resp.rows.length}). Mostrando el primero.`;

      // Intento 1: si ya viene rowParams en la lista, usamos el primero
      const first = resp.rows[0] || {};
      if(first.rowParams){
        buildRecoverModal(
          first.rowParams,
          {
            no_personal: first.rowParams.no_personal || no_personal || "",
            periodo: first.rowParams.periodo || periodo || "",
            version: first.rowParams.version || version || "",
            rowNumber: first.meta?.rowNumber || first.rowNumber || resp.rowNumber || "—"
          },
          resp.clientes || first.clientes || null,
          resp.allColumns || first.allColumns || []
        );
        return;
      }

      // Intento 2: si solo viene rowNumber/meta, pedimos el detalle por fila
      const rowNumber = first.meta?.rowNumber || first.rowNumber;
      if(rowNumber){
        const data = await apiRequestWithFallback({
          action: "recuperar_por_fila",
          tipo: "autoevaluacion",
          rowNumber: String(rowNumber)
        });

        if(data && data.found && data.rowParams){
          buildRecoverModal(
            data.rowParams,
            {
              no_personal: data.rowParams.no_personal || no_personal || "",
              periodo: data.rowParams.periodo || periodo || "",
              version: data.rowParams.version || version || "",
              rowNumber: data.rowNumber || rowNumber || "—"
            },
            data.clientes || null,
            data.allColumns || []
          );
          return;
        }
      }

      // Si por alguna razón no pudimos abrir el detalle
      $("apiHint").className = "err";
      $("apiHint").textContent = "Duplicados detectados, pero no se pudo abrir el detalle.";
      alert("Duplicados detectados, pero no se pudo abrir el detalle.");
      return;
    }

    // ✅ Found único: NO mostrar modal de lista; abrir directamente el detalle
    if(resp.found && resp.rowParams){
      buildRecoverModal(
        resp.rowParams,
        {
          no_personal: resp.rowParams.no_personal || no_personal || "",
          periodo: resp.rowParams.periodo || periodo || "",
          version: resp.rowParams.version || version || "",
          rowNumber: resp.rowNumber || "—"
        },
        resp.clientes || null,
        resp.allColumns || []
      );

      $("apiHint").className = "ok";
      $("apiHint").textContent = "Registro encontrado ✅";
      return;
    }

    $("apiHint").className = "warn";
    $("apiHint").textContent = "Sin registro con esas llaves.";
    alert("Sin registro con esas llaves.");

  }catch(err){
    console.error(err);
    $("apiHint").className = "err";
    $("apiHint").textContent = "No se pudo recuperar: " + (err.message || err);
    alert("No se pudo recuperar.\n\n" + (err.message || err));
  }finally{
    setBusy(false);
  }
}

function openLookupPrefilled(){
  $("qNoPersonal").value = $("noPersonal").value.trim();
  $("qNombre").value = $("nombre").value.trim();
  $("qPeriodo").value = $("periodo").value.trim();
  $("qVersion").value = $("version").value.trim();
  $("chipCount").textContent = "0 resultados";
  $("chipNote").textContent = "";
  $("lookupResultsBody").innerHTML = `<tr><td colspan="10" class="small-muted">Sin resultados aún.</td></tr>`;
  setLookupStatus("Listo para buscar.", "warn");
  openLookupModal();
}

/************************************************************
 * ✅ UI: tipo / acciones
 ************************************************************/
function applySearchUI(tipo){
  const isDes = (tipo === "desempeno");
  const badgeWrap = $("searchBadgeWrap");
  if(badgeWrap) badgeWrap.style.display = isDes ? "inline" : "none";
  ["fldNoPersonal","fldPeriodo","fldVersion"].forEach(id=>{
    const el = $(id);
    if(!el) return;
    if(isDes) el.classList.add("searchField");
    else el.classList.remove("searchField");
  });
  const btnRecover = $("btnRecover");
  if(btnRecover) btnRecover.style.display = isDes ? "" : "none";
}
function applyTopActionsUI(tipo){
  // ✅ Guardar visible en Autoevaluación, Clientes y Desempeño
  const btnSave = $("btnSave");
  if(btnSave){
    btnSave.style.display = "";     // mostrar
    btnSave.disabled = false;       // habilitar (setBusy() lo bloqueará cuando toque)
  }

  // ✅ Recuperar SOLO en Desempeño
  const btnRecover = $("btnRecover");
  if(btnRecover){
    btnRecover.style.display = (tipo === "desempeno") ? "" : "none";
    btnRecover.disabled = (tipo !== "desempeno");
  }

  // ✅ Generar SOLO en Desempeño (si quieres que también exista en otros, me dices)
  const btnGen = $("btnGenerate");
  if(btnGen){
    btnGen.style.display = (tipo === "desempeno") ? "" : "none";
    btnGen.disabled = (tipo !== "desempeno");
  }
}

/* ✅ MODIFICADA: applyTipoUI() — ahora sí muestra el bloque Clientes siempre */
/* ✅ MODIFICADA: applyTipoUI() — asegura (Auto: ítems) (Clientes: 2 campos) (Desempeño: ítems + campos) */
/* ✅ NUEVO: crea el bloque Clientes si no existe (2 campos parametrizados) */
function ensureClientesBox(){
  // Si ya existe, no hacemos nada
  if(document.getElementById("clientesBox")) return;

  // Insertaremos el card justo después de evalCard (o al final del grid si no existe)
  const evalCard = document.getElementById("evalCard");
  const grid = evalCard?.closest(".grid") || document.querySelector(".grid");

  if(!grid) return; // por seguridad

  const card = document.createElement("div");
  card.className = "card";
  card.id = "clientesBox";
  card.style.display = "none";

  card.innerHTML = `
    <h2>Evaluación de clientes</h2>
    <p>Completa los 2 campos siguientes (según formato).</p>

    <div class="highlightBadge">
      <span class="dot"></span>
      Campos realzados: Retroalimentación • Nombre del evaluador
    </div>

    <div style="margin-top:14px;" class="highlightField">
      <label>Retroalimentación (Clientes)</label>
      <textarea id="retroalimentacion" placeholder="Escribe la retroalimentación del cliente..."></textarea>
    </div>

    <div style="margin-top:12px;" class="highlightField">
      <label>Nombre del evaluador</label>
      <input id="nombreEvaluador" type="text" placeholder="Ej. Ana López" />
    </div>
  `;

  // Insertar después de evalCard, para que quede en orden
  if(evalCard && evalCard.parentNode){
    evalCard.parentNode.insertBefore(card, evalCard.nextSibling);
  }else{
    grid.appendChild(card);
  }
}
  
  function applyTipoUI(){
  const tipoSel = $("tipoFormulario");
  const tipo = tipoSel ? tipoSel.value : "autoevaluacion";

  // ✅ Asegura que el card de Clientes exista antes de mostrar/ocultar
  if(typeof ensureClientesBox === "function") ensureClientesBox();

  // Título
  const appTitle = $("appTitle");
  if(appTitle){
    appTitle.textContent =
      (tipo === "autoevaluacion") ? "Formulario de autoevaluación" :
      (tipo === "clientes") ? "Formulario evaluación clientes" :
      "Formulario de evaluación del desempeño";
  }

  // Cajas
  const autoBox = $("autoComentariosBox");
  const desBox  = $("desempenoCamposBox");
  const cliBox  = $("clientesBox");
  const evalCard = $("evalCard");

  // ✅ Reglas de visibilidad
  // Autoevaluación: Ítems + comentarios colaborador
  if(autoBox) autoBox.style.display = (tipo === "autoevaluacion") ? "block" : "none";

  // Desempeño: Ítems + campos definidos
  if(desBox) desBox.style.display = (tipo === "desempeno") ? "block" : "none";

  // Clientes: SOLO 2 campos parametrizados (sin ítems / sin desempeño / sin comentarios auto)
  if(cliBox) cliBox.style.display = (tipo === "clientes") ? "block" : "none";

  // Ítems: se muestran en autoevaluación y desempeño; se ocultan solo en clientes
  if(evalCard) evalCard.style.display = (tipo === "clientes") ? "none" : "block";

  // ✅ Asegura ítems SIEMPRE donde corresponda
  if(tipo !== "clientes"){
    ensureItemsVisibleIfNeeded(); // renderiza si hace falta
  }

  // UI adicional
  if(typeof applySearchUI === "function") applySearchUI(tipo);
  if(typeof applyTopActionsUI === "function") applyTopActionsUI(tipo);
  if(typeof setDefaultToday === "function") setDefaultToday();
}

function clearForm(){
  ["noPersonal","nombre","posicion","departamento","periodo","version","fecha",
   "comentariosColaborador","justificacion","comentariosEvaluador","fortalezas",
   "oportunidades","proyeccion","necesidadesCapacitacion","comentariosColaborador2",
   "evaluacionClientes","retroalimentacion","nombreEvaluador","nombreEvaluadorDesempeno",

   /* ✅ NUEVO: limpiar mail1/mail2 */
   "mail1","mail2"
  ].forEach(id=>{ const el=$(id); if(el) el.value=""; });

  state.answers = {};
  ITEMS.forEach(sec => sec.items.forEach(it=>{
    const el = $("ans_"+it.key);
    if(el) el.value = "";
  }));

  $("printArea").style.display = "none";
  state.generated = false;
  setDirty(false);

  $("apiHint").className = "warn";
  $("apiHint").textContent = "Listo para enviar";
}

/* ✅ MODIFICADA: bind() — asegura que el bloque Clientes exista ANTES de poner listeners */
/* ✅ MODIFICADA: bind() — asegura que Clientes exista ANTES de listeners */
function bind(){
  // ✅ IMPORTANTÍSIMO: si no creas el ClientesBox antes, retroalimentacion/nombreEvaluador no existen
  if(typeof ensureClientesBox === "function") ensureClientesBox();

  [
    "noPersonal","nombre","posicion","departamento","periodo","version","fecha",
    "comentariosColaborador","justificacion","comentariosEvaluador","fortalezas",
    "oportunidades","proyeccion","necesidadesCapacitacion",
    "comentariosColaborador2","evaluacionClientes",
    "retroalimentacion","nombreEvaluador","nombreEvaluadorDesempeno",
    "mail1","mail2"
  ].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", ()=> setDirty(true));
    el.addEventListener("change", ()=> setDirty(true));
  });

  const tipoSel = $("tipoFormulario");
  if(tipoSel){
    tipoSel.addEventListener("change", ()=>{
      applyTipoUI();
      setDirty(true);
    });
  }

  const btnNew = $("btnNew");
  if(btnNew){
    btnNew.addEventListener("click", ()=>{
      if(state.saving) return;
      if(state.dirty && !confirm("Hay cambios sin guardar. ¿Limpiar todo de todas formas?")) return;
      clearForm();
      applyTipoUI();
    });
  }

  const btnRecover = $("btnRecover");
  if(btnRecover){
    btnRecover.addEventListener("click", async ()=>{
      if(state.saving) return;
      const tipo = $("tipoFormulario").value;
      if(tipo !== "desempeno"){
        alert("Recuperar solo está disponible en el Formulario de evaluación del desempeño.");
        return;
      }
      await recoverByKeys();
    });
  }

  const closeBtn = $("btnCloseRecovered");
  if(closeBtn) closeBtn.addEventListener("click", closeRecoverModal);

  const recoverBackdrop = $("recoverBackdrop");
  if(recoverBackdrop){
    recoverBackdrop.addEventListener("click", (e)=>{
      if(e.target === recoverBackdrop) closeRecoverModal();
    });
  }

  const btnApplyRecovered = $("btnApplyRecovered");
  if(btnApplyRecovered){
    btnApplyRecovered.addEventListener("click", ()=>{
      if(!lastRecovered || !lastRecovered.rowParams) return;
      applyRecoveredToForm(lastRecovered.rowParams, lastRecovered.clientesInfo || null);
      ensureItemsVisibleIfNeeded();
      $("apiHint").className = "ok";
      $("apiHint").textContent = "Autollenado aplicado ✅";
      closeRecoverModal();
    });
  }

  const btnCloseLookup = $("btnCloseLookup");
  if(btnCloseLookup) btnCloseLookup.addEventListener("click", closeLookupModal);

  const lookupBackdrop = $("lookupBackdrop");
  if(lookupBackdrop){
    lookupBackdrop.addEventListener("click", (e)=>{
      if(e.target === lookupBackdrop) closeLookupModal();
    });
  }

  const btnSearch = $("btnSearch");
  if(btnSearch) btnSearch.addEventListener("click", searchRecords);

  const btnClearSearch = $("btnClearSearch");
  if(btnClearSearch){
    btnClearSearch.addEventListener("click", ()=>{
      $("qNoPersonal").value = "";
      $("qNombre").value = "";
      $("qPeriodo").value = "";
      $("qVersion").value = "";
      renderLookupResults([], null);
      setLookupStatus("Listo para buscar.", "warn");
    });
  }

  ["qNoPersonal","qNombre","qPeriodo","qVersion"].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        searchRecords();
      }
    });
  });

  // Botones reporte / imprimir
  const btnGen = $("btnGenerate");
  if(btnGen){
    btnGen.addEventListener("click", ()=>{
      if(state.saving) return;
      openReportModal();
    });
  }

  const btnPrint = $("btnPrint");
  if(btnPrint){
    btnPrint.addEventListener("click", ()=>{
      if(state.saving) return;
      doPrint();
    });
  }

  const btnPrintFromModal = $("btnPrintFromModal");
  if(btnPrintFromModal){
    btnPrintFromModal.addEventListener("click", ()=>{
      if(state.saving) return;
      doPrint();
    });
  }

  const rb = $("reportBackdrop");
  if(rb){
    rb.addEventListener("click", (e)=>{
      if(e.target === rb) closeReportModal();
    });
  }
}

  (function bindExtraButtons(){
    const btnGen = $("btnGenerate");
    if(btnGen){
      btnGen.addEventListener("click", ()=>{
        if(state.saving) return;
        openReportModal();
      });
    }

    const btnPrint = $("btnPrint");
    if(btnPrint){
      btnPrint.addEventListener("click", ()=>{
        if(state.saving) return;
        doPrint();
      });
    }

    const btnPrintFromModal = $("btnPrintFromModal");
    if(btnPrintFromModal){
      btnPrintFromModal.addEventListener("click", ()=>{
        if(state.saving) return;
        doPrint();
      });
    }

    const rb = $("reportBackdrop");
    if(rb){
      rb.addEventListener("click", (e)=>{
        if(e.target === rb) closeReportModal();
      });
    }
  })();
}

  /* =========================
     ✅ Helpers Reporte
     - Generar: muestra tabla flotante (modal) con resultados
     - Imprimir: habilita Imprimir/Enviar a PDF
     - Oculta campos vacíos en reporte
     ========================= */

  function _isEmptyValue(v){
    return v == null || String(v).trim() === "";
  }

  function pruneEmptyFields(root){
    if(!root) return;

    const rowSelectors = [".kv", ".field-row", ".report-row"];
    rowSelectors.forEach(sel=>{
      root.querySelectorAll(sel).forEach(row=>{
        const valEl =
          row.querySelector(".value") ||
          row.querySelector(".v") ||
          row.querySelector("[data-value]") ||
          null;

        let val = "";
        if(valEl){
          val = (valEl.getAttribute("data-value") ?? valEl.textContent ?? "").trim();
        }else{
          const kids = Array.from(row.children || []);
          if(kids.length >= 2) val = (kids[1].textContent || "").trim();
        }

        if(_isEmptyValue(val)){
          row.remove();
        }
      });
    });

    root.querySelectorAll("table").forEach(tbl=>{
      tbl.querySelectorAll("tr").forEach(tr=>{
        const tds = tr.querySelectorAll("td");
        if(tds && tds.length >= 2){
          const val = (tds[1].textContent || "").trim();
          if(_isEmptyValue(val)) tr.remove();
        }
      });
    });

    root.querySelectorAll("li").forEach(li=>{
      const val = (li.textContent || "").trim();
      if(_isEmptyValue(val)) li.remove();
    });
  }

  function openReportModal(){
    const backdrop = $("reportBackdrop");
    const host = $("reportHost");
    if(!backdrop || !host) return;

    const header = (typeof getHeaderData === "function") ? getHeaderData() : null;
    const tipo = header?.tipo || $("tipoFormulario")?.value || "";
    if(tipo !== "clientes" && typeof ensureItemsVisibleIfNeeded === "function"){
      ensureItemsVisibleIfNeeded();
    }

    let html = "";
    if(typeof buildReport === "function"){
      const r = buildReport();
      if(typeof r === "string") html = r;
    }

    if(html){
      host.innerHTML = html;
    }else{
      const reportEl = document.getElementById("report");
      if(reportEl){
        const clone = reportEl.cloneNode(true);
        if(clone.id) clone.removeAttribute("id");
        clone.querySelectorAll("[id]").forEach(n=>n.removeAttribute("id"));
        host.innerHTML = "";
        host.appendChild(clone);
      }else{
        host.textContent = "No se pudo generar el reporte (no se encontró #report ni HTML retornado).";
      }
    }

    pruneEmptyFields(host);

    backdrop.classList.add("show");
    backdrop.setAttribute("aria-hidden", "false");
  }

  function closeReportModal(){
    const backdrop = $("reportBackdrop");
    if(!backdrop) return;
    backdrop.classList.remove("show");
    backdrop.setAttribute("aria-hidden", "true");
  }

  function doPrint(){
    const host = $("reportHost");
    const hasSomething = host && host.textContent && host.textContent.trim().length > 0;

    if(!hasSomething){
      openReportModal();
    }
    if(host) pruneEmptyFields(host);

    window.print();
  }

  $("btnSave").addEventListener("click", async ()=>{
    if(state.saving) return;

    const header = getHeaderData();
    const tipo = header.tipo;

    if(!header.no_personal || !header.periodo || !header.version){
      alert("Para Guardar, llena: No. de personal + Periodo + Versión.");
      return;
    }

    if(tipo !== "clientes") ensureItemsVisibleIfNeeded();

    const payload = {
      action: "guardar",
      tipo: tipo,
      no_personal: header.no_personal,
      nombre: header.nombre,
      posicion: header.posicion,
      departamento: header.departamento,
      periodo: header.periodo,
      version: header.version,
      fecha: header.fecha || "",
      puntaje: (tipo === "clientes") ? 0 : computeTotal(),
      ...getExtraFields()
    };

    if(tipo !== "clientes"){
      const selectedText = flattenAnswersSelectedText();
      ITEMS.forEach(sec => sec.items.forEach(it=>{
        payload[it.key] = selectedText[it.key] || "";
      }));
    }

    function _isEmpty(v){
      if(v === null || v === undefined) return true;
      if(typeof v === "string" && v.trim() === "") return true;
      return false;
    }
    function _prunePayload(obj){
      const keep = new Set(["action","tipo","no_personal","periodo","version"]);
      Object.keys(obj).forEach(k=>{
        if(keep.has(k)) return;
        const v = obj[k];
        if(typeof v === "number"){
          if(!Number.isFinite(v)) delete obj[k];
          return;
        }
        if(typeof v === "boolean") return;
        if(_isEmpty(v)) delete obj[k];
      });
      return obj;
    }

    _prunePayload(payload);

    try{
      setBusy(true);
      $("apiHint").className = "warn";
      $("apiHint").textContent = "Guardando…";

      const body = new URLSearchParams(payload).toString();

      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body
      });

      $("apiHint").className = "ok";
      $("apiHint").textContent = "Guardado enviado ✅ (verifica en Google Sheets)";
      setDirty(false);

    }catch(e){
      console.error(e);
      $("apiHint").className = "err";
      $("apiHint").textContent = "Error guardando: " + (e.message || e);
      alert("No se pudo guardar.\n\n" + (e.message || e));
    }finally{
      setBusy(false);
    }
  });

  (function bindExtraButtons(){
    const btnGen = $("btnGenerate");
    if(btnGen){
      btnGen.addEventListener("click", ()=>{
        if(state.saving) return;
        openReportModal();
      });
    }

    const btnPrint = $("btnPrint");
    if(btnPrint){
      btnPrint.addEventListener("click", ()=>{
        if(state.saving) return;
        doPrint();
      });
    }

    const btnPrintFromModal = $("btnPrintFromModal");
    if(btnPrintFromModal){
      btnPrintFromModal.addEventListener("click", ()=>{
        if(state.saving) return;
        doPrint();
      });
    }

    const rb = $("reportBackdrop");
    if(rb){
      rb.addEventListener("click", (e)=>{
        if(e.target === rb) closeReportModal();
      });
    }
  })();
}

/* ✅ CIERRES DEL DOCUMENTO (AGREGADOS) */
 /* ✅ INIT: ejecutar UI y render de ítems al cargar */
 document.addEventListener("DOMContentLoaded", async () => {
  // 1) Bindeos (event listeners)
  if(typeof bind === "function") bind();

  // 2) Aplicar UI del tipo (esto renderiza ítems y muestra campos de desempeño)
  applyTipoUI();

  // 3) Ping de API (no bloquea la UI si falla)
  try{ await apiPing(); }catch(_e){}

  // 4) Asegurar ítems visibles para auto/desempeño
  ensureItemsVisibleIfNeeded();
});

</script>
</body>
</html>
