<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluación del desempeño</title>
  <style>
    :root{
      --bg:#050a14;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.7);
      --accent:#2f6bff;
      --accent2:#7b61ff;
      --danger:#ff4d6d;
      --ok:#33d69f;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(47,107,255,.22), transparent 55%),
        radial-gradient(900px 500px at 95% 10%, rgba(123,97,255,.18), transparent 55%),
        radial-gradient(700px 700px at 30% 100%, rgba(51,214,159,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:28px 18px 70px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px 18px;
      box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:30;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      display:grid;place-items:center;
      font-weight:800;
    }
    .titlebox .h1{
      font-size:20px; font-weight:800; letter-spacing:.2px; margin:0;
    }
    .titlebox .sub{
      margin-top:2px; font-size:13px; color:var(--muted);
    }
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:9px 12px; border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12.5px;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--danger)}
    button{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      transition:.15s transform, .15s opacity, .15s background;
    }
    button:hover{transform: translateY(-1px); background:rgba(255,255,255,.12)}
    button.primary{
      border-color: rgba(47,107,255,.55);
      background: linear-gradient(135deg, rgba(47,107,255,.95), rgba(123,97,255,.75));
      box-shadow: 0 10px 30px rgba(47,107,255,.22);
    }
    button.primary:hover{background: linear-gradient(135deg, rgba(47,107,255,1), rgba(123,97,255,.85))}
    button.ghost{background:rgba(255,255,255,.06)}
    button:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      margin-top:16px;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }
    .card h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted)}
    .fields{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    .field{
      display:flex; flex-direction:column; gap:7px;
    }
    label{
      font-size:12.5px; color:var(--muted);
      display:flex; align-items:center; gap:8px;
    }
    input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:14px;
      padding:11px 12px;
      outline:none;
      transition:.15s border, .15s background;
    }
    textarea{min-height:84px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(47,107,255,.6);
      background:rgba(0,0,0,.30);
    }
    .sectionTitle{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin:18px 0 10px;
    }
    .sectionTitle h3{
      margin:0; font-size:16px;
    }
    .sectionTitle .hint{
      font-size:12.5px; color:var(--muted);
    }
    .factor{
      margin-top:12px;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:16px;
      padding:14px;
      background:rgba(0,0,0,.12);
    }
    .factor h4{
      margin:0 0 10px;
      font-size:14.5px;
      color:var(--text);
      letter-spacing:.2px;
    }
    .item{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:12px;
      padding:12px 0;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .item:first-of-type{border-top:none}
    .item .name{
      font-weight:800;
      line-height:1.25;
    }
    .item .help{
      margin-top:6px;
      font-size:12.5px;
      color:var(--muted);
    }
    .right{display:flex; flex-direction:column; gap:8px}
    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .footnote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      text-align:right;
    }
    .tiny{font-size:12px;color:var(--muted)}
    .hide{display:none !important;}

    /* ===== PRINT ===== */
    #printArea{display:none}
    @media print{
      body{background:#fff;color:#111}
      .wrap, .topbar, .card, .grid{display:none !important}
      #printArea{display:block}
      .p-page{
        font-family: Arial, Helvetica, sans-serif;
        color:#111;
        padding:18mm 15mm;
      }
      .p-head{
        display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
        margin-bottom:10px;
      }
      .p-title{
        font-size:26px; font-weight:800; margin:0;
      }
      .p-meta{
        font-size:12px; color:#333; text-align:right;
      }
      .p-sub{margin:3px 0 0; font-size:12px; color:#555}
      .p-grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:8px 14px;
        margin:14px 0 10px;
      }
      .p-row{
        border:1px solid #ddd;
        border-radius:10px;
        padding:10px 12px;
      }
      .p-row .k{font-size:11px;color:#444;margin-bottom:4px}
      .p-row .v{font-size:13px;font-weight:700}
      .p-grid3{
        display:grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap:8px 14px;
        margin-top:8px;
      }
      .p-section{
        margin-top:14px;
      }
      .p-section h2{
        font-size:14px; margin:0 0 8px; letter-spacing:.2px;
      }
      .p-table{
        width:100%;
        border-collapse:collapse;
        font-size:11.5px;
      }
      .p-table th, .p-table td{
        border:1px solid #ddd;
        padding:7px 8px;
        vertical-align:top;
      }
      .p-table th{
        background:#f5f5f5;
        text-align:left;
        font-size:11px;
      }
      .p-total{
        margin-top:10px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        border-top:2px solid #222;
        padding-top:10px;
        font-weight:800;
      }
      .p-box{
        border:1px solid #ddd;
        border-radius:10px;
        padding:10px 12px;
        margin-top:8px;
        white-space:pre-wrap;
        font-size:11.5px;
      }
      .p-footer{
        position:fixed;
        left:15mm; right:15mm; bottom:10mm;
        display:flex; justify-content:space-between; align-items:center;
        font-size:11px; color:#555;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ED</div>
        <div class="titlebox">
          <div class="h1">Formulario de evaluación del desempeño</div>
          <div class="sub">Escala 1–5 • Cálculo interno por pesos • Reporte listo para impresión</div>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="dirtyPill">
          <span class="dot ok" id="dirtyDot"></span>
          <span id="dirtyText">Sin cambios</span>
        </div>
        <button class="ghost" id="btnNew">Nuevo</button>
        <button class="primary" id="btnSave">Guardar</button>
        <button id="btnGenerate" class="primary">Generar Reporte</button>
        <button id="btnPrint" class="ghost" disabled>Imprimir / Enviar a PDF</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Datos del colaborador</h2>
        <div class="fields">
          <div class="field">
            <label for="empNo">No. de personal</label>
            <input id="empNo" placeholder="Ej: 1600" />
          </div>
          <div class="field">
            <label for="name">Nombre</label>
            <input id="name" placeholder="Ej: Carlos Paz" />
          </div>
          <div class="field">
            <label for="pos">Posición</label>
            <input id="pos" placeholder="Ej: Analista" />
          </div>

          <div class="field">
            <label for="dept">Departamento</label>
            <input id="dept" placeholder="Ej: Contabilidad" />
          </div>
          <div class="field">
            <label for="period">Periodo</label>
            <input id="period" placeholder="Ej: 2025" />
          </div>
          <div class="field">
            <label for="ver">Versión</label>
            <input id="ver" placeholder="Ej: 1" />
          </div>

          <div class="field" style="grid-column: span 2;">
            <label for="date">Fecha</label>
            <input id="date" type="date" />
          </div>
          <div class="field">
            <label class="tiny"> </label>
            <div class="tiny">Tip: “Guardar” almacena en este navegador (localStorage).</div>
          </div>
        </div>

        <div class="sectionTitle">
          <h3>Evaluación (Factores 1–5)</h3>
          <div class="hint">Selecciona una opción por cada ítem.</div>
        </div>

        <div id="formFactors"></div>

        <div class="sectionTitle">
          <h3>Campos del evaluador</h3>
          <div class="hint">Se incluirán en el reporte impreso.</div>
        </div>

        <div class="row2">
          <div class="field">
            <label for="tResultados">Resultados</label>
            <textarea id="tResultados" placeholder="Describe resultados, evidencias, logros y nivel alcanzado."></textarea>
          </div>
          <div class="field">
            <label for="tConclusiones">Conclusiones</label>
            <textarea id="tConclusiones" placeholder="Conclusiones generales del desempeño y decisiones sugeridas."></textarea>
          </div>
          <div class="field">
            <label for="tCapacitacion">Plan de capacitación</label>
            <textarea id="tCapacitacion" placeholder="Capacitaciones requeridas, temas, prioridad, plazos."></textarea>
          </div>
          <div class="field">
            <label for="tCarrera">Plan de carrera</label>
            <textarea id="tCarrera" placeholder="Próximos pasos, rol objetivo, competencias a fortalecer, ruta sugerida."></textarea>
          </div>
        </div>

        <div class="footnote">Por Soamy Lanza</div>
      </div>
    </div>
  </div>

  <!-- ===== PRINT AREA (solo se ve al imprimir) ===== -->
  <div id="printArea" aria-hidden="true">
    <div class="p-page">
      <div class="p-head">
        <div>
          <p class="p-title">Evaluación del desempeño</p>
          <p class="p-sub">Generado automáticamente desde el formulario.</p>
        </div>
        <div class="p-meta">
          <div><b>Generado:</b> <span id="pGenerated">—</span></div>
        </div>
      </div>

      <!-- FILAS en 1 sola fila, como pediste -->
      <div class="p-grid">
        <div class="p-row">
          <div class="k">No. de personal</div>
          <div class="v" id="pEmpNo">—</div>
        </div>
        <div class="p-row">
          <div class="k">Nombre</div>
          <div class="v" id="pName">—</div>
        </div>

        <div class="p-row">
          <div class="k">Posición</div>
          <div class="v" id="pPos">—</div>
        </div>
        <div class="p-row">
          <div class="k">Departamento</div>
          <div class="v" id="pDept">—</div>
        </div>
      </div>

      <div class="p-grid3">
        <div class="p-row">
          <div class="k">Periodo</div>
          <div class="v" id="pPeriod">—</div>
        </div>
        <div class="p-row">
          <div class="k">Versión</div>
          <div class="v" id="pVer">—</div>
        </div>
        <div class="p-row">
          <div class="k">Fecha</div>
          <div class="v" id="pDate">—</div>
        </div>
      </div>

      <div class="p-section">
        <h2>Respuestas por ítem</h2>
        <table class="p-table" id="pTable">
          <thead>
            <tr>
              <th style="width:36%;">Ítem</th>
              <th>Respuesta elegida</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="p-total">
          <div>Total de puntos (máx. 100)</div>
          <div id="pTotal">0.00</div>
        </div>
      </div>

      <div class="p-section">
        <h2>Resultados</h2>
        <div class="p-box" id="pResultados">—</div>
      </div>

      <div class="p-section">
        <h2>Conclusiones</h2>
        <div class="p-box" id="pConclusiones">—</div>
      </div>

      <div class="p-section">
        <h2>Plan de capacitación</h2>
        <div class="p-box" id="pCapacitacion">—</div>
      </div>

      <div class="p-section">
        <h2>Plan de carrera</h2>
        <div class="p-box" id="pCarrera">—</div>
      </div>

      <div class="p-footer">
        <div>Por Soamy Lanza</div>
        <div id="pUrl"></div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    //  Data (pesos + textos)
    // =========================
    const STORAGE_KEY = "ED_EVALUACION_DESEMPENO_v1";

    const weights = {
      "1A": 15, "1B": 10, "1C": 2.5, "1D": 2.5,
      "2A": 2.5, "2B": 5,  "2C": 10,  "2D": 2.5,
      "3A": 10,  "3B": 5,  "3C": 2.5, "3D": 2.5,
      "4A": 2.5, "4B": 2.5,"4C": 5,   "4D": 5,
      "5A": 2.5, "5B": 2.5,"5C": 10
    };

    const factors = [
      {
        title: "1. Metas, productividad y eficiencia",
        items: [
          {
            id:"1A",
            name:"A. Cumplimiento de Metas. Grado de logro",
            options:[
              "1 - No alcanza la mayoría de las metas; cumple menos del 70 % de lo establecido. La falta de avance afecta los resultados esperados.",
              "2 - Logra entre 70–89 % de las metas; presenta avances parciales o inconsistentes y requiere correcciones.",
              "3 - Alcanza el 100 % de las metas planificadas con calidad y dentro del tiempo establecido.",
              "4 - Supera el 100 % y llega hasta un 110 % de las metas; entrega resultados adicionales o mejores de lo esperado.",
              "5 - Supera más del 110 % de las metas de forma sostenida, con impacto significativo y calidad superior."
            ]
          },
          {
            id:"1B",
            name:"B. Eficiencia en el uso del tiempo, costos y recursos",
            options:[
              "1 - Usa el tiempo y los recursos con errores graves que afectan la eficiencia.",
              "2 - Muestra uso inestable del tiempo y los recursos; requiere evaluaciones y correcciones frecuentes.",
              "3 - Utiliza de manera adecuada el tiempo y los recursos, cumpliendo sin desperdicios significativos.",
              "4 - Optimiza tiempo y recursos, generando mejoras o ahorros sin afectar la calidad del trabajo.",
              "5 - Maximiza la eficiencia de forma sostenida, mejora procesos y logra resultados superiores sin comprometer la calidad."
            ]
          },
          {
            id:"1C",
            name:"C. Cumplimiento de normas de seguridad",
            options:[
              "1 - Incumple normas de seguridad y genera riesgos constantes para sí y el equipo.",
              "2 - Cumple parcialmente las normas; requiere supervisión continua para evitar incidentes.",
              "3 - Cumple todas las normas de seguridad y actúa de manera segura en su trabajo diario.",
              "4 - Se anticipa a riesgos, propone acciones preventivas y actúa con autonomía segura.",
              "5 - Promueve una cultura de seguridad; motiva a otros y contribuye a mantener ambientes sin incidentes."
            ]
          },
          {
            id:"1D",
            name:"D. Prioriza y organiza tareas adecuadamente",
            options:[
              "1 - Desorganiza las tareas; incumple plazos y afecta resultados importantes.",
              "2 - Organiza parcialmente; presenta inconsistencias en prioridades y manejo del tiempo.",
              "3 - Gestiona las tareas de forma adecuada, cumple tiempos y mantiene orden en su trabajo.",
              "4 - Organiza y prioriza con eficiencia; anticipa necesidades y mejora sus tiempos de entrega.",
              "5 - Es referente en organización; redistribuye recursos, optimiza procesos y eleva la productividad del equipo."
            ]
          }
        ]
      },
      {
        title: "2. Calidad del Trabajo",
        items: [
          {
            id:"2A",
            name:"A. Exactitud y atención al detalle",
            options:[
              "1 - Comete errores frecuentes y no identifica fallos evidentes; requiere supervisión constante para evitar errores mayores.",
              "2 - Presenta errores recurrentes por falta de revisión; la exactitud es inconsistente y requiere correcciones frecuentes.",
              "3 - Realiza su trabajo con un nivel adecuado de precisión; puede cometer errores menores que no afectan los resultados.",
              "4 - Mantiene una atención al detalle constante; comete pocos errores y revisa su trabajo de forma proactiva.",
              "5 - Su trabajo es impecable; detecta errores propios y ajenos, propone mejoras y es referente en precisión."
            ]
          },
          {
            id:"2B",
            name:"B. Cumple con estándares de calidad",
            options:[
              "1 - Menos del 70 % de los entregables cumplen los estándares; los resultados son inaceptables.",
              "2 - Entre 70–89 % de los entregables cumplen los estándares; requiere ajustes frecuentes.",
              "3 - El 100 % de los entregables cumplen los estándares establecidos.",
              "4 - Cumplimiento entre 101–110 %; entrega con calidad superior y consistente.",
              "5 - Más del 110 % de cumplimiento; supera ampliamente los estándares y produce resultados sobresalientes."
            ]
          },
          {
            id:"2C",
            name:"C. Entregas a tiempo. Cumple con plazos establecidos",
            options:[
              "1 - Menos del 70 % de las entregas se cumplen a tiempo; los retrasos afectan el área.",
              "2 - Entre 70–89 % de las entregas se realizan a tiempo; desempeño irregular.",
              "3 - El 100 % de las entregas se cumplen en los plazos pactados.",
              "4 - Cumple entre 101–110 % de los tiempos; se anticipa en algunas entregas y mantiene calidad.",
              "5 - Entrega más del 110 % a tiempo; supera plazos, mantiene calidad y mejora la eficiencia general."
            ]
          },
          {
            id:"2D",
            name:"D. Manejo de errores y mejoras",
            options:[
              "1 - No reconoce ni corrige errores; genera reincidencias graves.",
              "2 - Corrige parcialmente, con retrasos o bajo nivel de supervisión; la mejora no es constante.",
              "3 - Detecta y corrige errores básicos cuando se le solicita; cumple lo necesario.",
              "4 - Se anticipa a errores y propone soluciones preventivas que mejoran el proceso.",
              "5 - Asegura procesos libres de errores; implementa mejoras continuas y es referente en calidad."
            ]
          }
        ]
      },
      {
        title: "3. Competencias y Habilidades",
        items: [
          {
            id:"3A",
            name:"A. Conocimientos técnicos del puesto",
            options:[
              "1 - Conocimientos muy por debajo de lo esperado; no domina funciones básicas del puesto.",
              "2 - Gestiona parcialmente los conocimientos requeridos y necesita apoyo frecuente.",
              "3 - Posee el conocimiento necesario y funcional para el puesto; desempeño adecuado.",
              "4 - Aplica los conocimientos de manera confiable y constante.",
              "5 - Domina los conocimientos, aplica técnicas avanzadas y es referente técnico en el área."
            ]
          },
          {
            id:"3B",
            name:"B. Convincente respuesta técnica a clientes",
            options:[
              "1 - Respuestas incorrectas o inconsistentes que generan desconfianza.",
              "2 - Respuestas incompletas o poco claras que afectan la calidad del servicio.",
              "3 - Responde de forma adecuada y funcional, brindando confianza.",
              "4 - Respuestas claras, específicas y confiables de manera constante.",
              "5 - Respuestas sobresalientes y precisas, reconocidas como referentes por clientes y equipo."
            ]
          },
          {
            id:"3C",
            name:"C. Resolución de problemas",
            options:[
              "1 - No logra resolver problemas; afecta procesos y resultados.",
              "2 - Resuelve parcialmente los problemas, requiriendo supervisión frecuente.",
              "3 - Resuelve problemas básicos de manera satisfactoria y funcional.",
              "4 - Resuelve problemas complejos con autonomía y confiabilidad.",
              "5 - Anticipa problemas y desarrolla soluciones preventivas y estratégicas."
            ]
          },
          {
            id:"3D",
            name:"D. Iniciativa y creatividad",
            options:[
              "1 - No genera ideas ni propone mejoras.",
              "2 - Propone ideas poco útiles o de aplicación limitada.",
              "3 - Propone ideas funcionales y aplicables cuando es necesario.",
              "4 - Genera ideas prácticas que optimizan procesos y agregan valor.",
              "5 - Propone soluciones innovadoras con impacto positivo y sostenible en el área."
            ]
          }
        ]
      },
      {
        title: "4. Actitud y Valores",
        items: [
          {
            id:"4A",
            name:"A. Responsabilidad y compromiso",
            options:[
              "1 - Incumple compromisos y entrega resultados muy por debajo de lo esperado.",
              "2 - Cumple compromisos de forma irregular y requiere seguimiento constante.",
              "3 - Cumple con sus responsabilidades de manera adecuada y confiable.",
              "4 - Cumple de forma consistente, genera seguridad y aporta valor.",
              "5 - Inspira por su compromiso; es modelo de conducta para el equipo."
            ]
          },
          {
            id:"4B",
            name:"B. Puntualidad y asistencia",
            options:[
              "1 - Ausencias frecuentes e injustificadas; llegadas tardías recurrentes sin aviso y sin intención de mejora.",
              "2 - Se presenta con frecuencia tarde o sin justificación clara, afectando la operación.",
              "3 - Asiste regularmente y cumple horarios; puede presentar llegadas tarde o ausencias justificadas sin reincidencia.",
              "4 - Es puntual y mantiene asistencia confiable; respeta horarios y comunica eventualidades oportunamente.",
              "5 - Puntualidad y asistencia impecables; es referente para el equipo y se adapta a horarios especiales sin afectar el desempeño."
            ]
          },
          {
            id:"4C",
            name:"C. Trabajo en equipo y cooperación",
            options:[
              "1 - No coopera; genera conflictos y dificulta el trabajo del equipo.",
              "2 - Coopera parcialmente y de manera inestable.",
              "3 - Coopera cuando se le solicita, con resultados aceptables.",
              "4 - Colabora activamente con el equipo y aporta de forma confiable.",
              "5 - Es referente en trabajo en equipo; promueve colaboración, sinergia y apoya a otros."
            ]
          },
          {
            id:"4D",
            name:"D. Comunicación efectiva",
            options:[
              "1 - Comunicación confusa; genera malentendidos graves.",
              "2 - Comunicación incompleta o poco clara; requiere supervisión para asegurar entendimiento.",
              "3 - Comunica lo necesario de forma clara y suficiente.",
              "4 - Comunicación clara, precisa y constructiva; escucha activamente.",
              "5 - Comunicación influyente y estratégica; facilita acuerdos y motiva a otros."
            ]
          }
        ]
      },
      {
        title: "5. Desarrollo y Potencial",
        items: [
          {
            id:"5A",
            name:"A. Adaptación al cambio",
            options:[
              "1 - Se resiste activamente al cambio; afecta procesos y equipos.",
              "2 - Se adapta parcialmente, con dificultad y resultados limitados.",
              "3 - Se adapta lo necesario para mantener un desempeño adecuado.",
              "4 - Se adapta de forma autónoma y confiable a nuevas situaciones.",
              "5 - Es referente en adaptación; motiva y guía a otros en procesos de cambio."
            ]
          },
          {
            id:"5B",
            name:"B. Disposición para aprender",
            options:[
              "1 - No busca aprender; rechaza retroalimentación y capacitación.",
              "2 - Aprende solo lo obligatorio y con mínima aplicación práctica.",
              "3 - Aprende lo necesario para mantener un desempeño satisfactorio.",
              "4 - Busca aprender constantemente y aplica lo aprendido en el trabajo.",
              "5 - Se mantiene en aprendizaje continuo, comparte conocimientos y forma a otros."
            ]
          },
          {
            id:"5C",
            name:"C. Liderazgo",
            options:[
              "1 - No logra coordinar ni dirigir; genera desorden y afecta resultados.",
              "2 - Lidera de forma débil, con bajo impacto en el equipo.",
              "3 - Lidera tareas básicas con resultados adecuados y funcionales.",
              "4 - Lidera con confianza, logrando resultados consistentes y estables.",
              "5 - Inspira con visión clara; desarrolla a otros, fortalece la cohesión del equipo y se convierte en referente."
            ]
          }
        ]
      }
    ];

    // =========================
    //  Helpers
    // =========================
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function nowStamp(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      const dd = pad(d.getDate());
      const mm = pad(d.getMonth()+1);
      const yy = d.getFullYear();
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${dd}/${mm}/${yy}, ${hh}:${mi}`;
    }

    function setDirty(isDirty){
      const dot = $("#dirtyDot");
      const txt = $("#dirtyText");
      if(isDirty){
        dot.classList.remove("ok"); dot.classList.add("warn");
        txt.textContent = "Cambios sin guardar";
      }else{
        dot.classList.remove("warn"); dot.classList.add("ok");
        txt.textContent = "Sin cambios";
      }
    }

    let dirty = false;
    let lastReportReady = false;

    function markDirty(){
      if(!dirty){
        dirty = true;
        setDirty(true);
      }
    }

    function clearDirty(){
      dirty = false;
      setDirty(false);
    }

    // =========================
    //  Render Form
    // =========================
    function renderForm(){
      const host = $("#formFactors");
      host.innerHTML = "";

      factors.forEach((f) => {
        const box = document.createElement("div");
        box.className = "factor";

        const h = document.createElement("h4");
        h.textContent = f.title;
        box.appendChild(h);

        f.items.forEach((it) => {
          const row = document.createElement("div");
          row.className = "item";

          const left = document.createElement("div");
          const nm = document.createElement("div");
          nm.className = "name";
          nm.textContent = it.name;
          const help = document.createElement("div");
          help.className = "help";
          help.textContent = "Elige la descripción que mejor refleje el desempeño.";
          left.appendChild(nm);
          left.appendChild(help);

          const right = document.createElement("div");
          right.className = "right";

          const lab = document.createElement("label");
          lab.textContent = "Respuesta";
          lab.setAttribute("for", `sel_${it.id}`);

          const sel = document.createElement("select");
          sel.id = `sel_${it.id}`;
          sel.dataset.itemId = it.id;

          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = "— Seleccionar —";
          sel.appendChild(opt0);

          it.options.forEach((t, idx) => {
            const opt = document.createElement("option");
            opt.value = String(idx+1); // 1..5
            opt.textContent = t;
            sel.appendChild(opt);
          });

          sel.addEventListener("change", () => {
            markDirty();
            lastReportReady = false;
            $("#btnPrint").disabled = true;
          });

          right.appendChild(lab);
          right.appendChild(sel);

          row.appendChild(left);
          row.appendChild(right);
          box.appendChild(row);
        });

        host.appendChild(box);
      });

      // Dirty tracking on meta fields + textareas
      ["#empNo","#name","#pos","#dept","#period","#ver","#date","#tResultados","#tConclusiones","#tCapacitacion","#tCarrera"]
        .forEach((id) => {
          const el = $(id);
          el.addEventListener("input", () => {
            markDirty();
            lastReportReady = false;
            $("#btnPrint").disabled = true;
          });
          el.addEventListener("change", () => {
            markDirty();
            lastReportReady = false;
            $("#btnPrint").disabled = true;
          });
        });
    }

    // =========================
    //  State (save/load)
    // =========================
    function collectState(){
      const answers = {};
      factors.forEach(f => f.items.forEach(it => {
        const v = $(`#sel_${it.id}`).value;
        answers[it.id] = v ? Number(v) : null;
      }));

      return {
        meta:{
          empNo: $("#empNo").value.trim(),
          name: $("#name").value.trim(),
          pos: $("#pos").value.trim(),
          dept: $("#dept").value.trim(),
          period: $("#period").value.trim(),
          ver: $("#ver").value.trim(),
          date: $("#date").value // yyyy-mm-dd
        },
        notes:{
          resultados: $("#tResultados").value.trim(),
          conclusiones: $("#tConclusiones").value.trim(),
          capacitacion: $("#tCapacitacion").value.trim(),
          carrera: $("#tCarrera").value.trim()
        },
        answers
      };
    }

    function applyState(state){
      if(!state) return;
      const { meta, notes, answers } = state;

      $("#empNo").value = meta?.empNo || "";
      $("#name").value  = meta?.name  || "";
      $("#pos").value   = meta?.pos   || "";
      $("#dept").value  = meta?.dept  || "";
      $("#period").value= meta?.period|| "";
      $("#ver").value   = meta?.ver   || "";
      $("#date").value  = meta?.date  || "";

      $("#tResultados").value  = notes?.resultados || "";
      $("#tConclusiones").value= notes?.conclusiones || "";
      $("#tCapacitacion").value= notes?.capacitacion || "";
      $("#tCarrera").value     = notes?.carrera || "";

      if(answers){
        Object.keys(answers).forEach((k)=>{
          const el = $(`#sel_${k}`);
          if(el) el.value = answers[k] ? String(answers[k]) : "";
        });
      }
    }

    function handleSave(){
      const state = collectState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      clearDirty();
      lastReportReady = false;
      $("#btnPrint").disabled = true;
    }

    function loadSaved(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      try{
        const state = JSON.parse(raw);
        applyState(state);
      }catch(e){
        console.warn("No se pudo leer guardado:", e);
      }
    }

    function handleNew(){
      if(dirty){
        const ok = confirm("Hay cambios sin guardar. ¿Deseas continuar y limpiar el formulario?");
        if(!ok) return;
      }
      localStorage.removeItem(STORAGE_KEY);
      renderForm();
      // limpiar campos
      applyState({
        meta:{empNo:"",name:"",pos:"",dept:"",period:"",ver:"",date:""},
        notes:{resultados:"",conclusiones:"",capacitacion:"",carrera:""},
        answers:{}
      });
      clearDirty();
      lastReportReady = false;
      $("#btnPrint").disabled = true;
    }

    // =========================
    //  Scoring + Report build
    // =========================
    function computeTotal(state){
      let total = 0;
      for(const [id, val] of Object.entries(state.answers)){
        if(val == null) continue;
        const w = weights[id] || 0;
        total += (val/5) * w;
      }
      return Number(total.toFixed(2));
    }

    function getItemById(id){
      for(const f of factors){
        for(const it of f.items){
          if(it.id === id) return it;
        }
      }
      return null;
    }

    function fillReport(state){
      // header meta
      $("#pGenerated").textContent = nowStamp();
      $("#pUrl").textContent = location.href;

      $("#pEmpNo").textContent = state.meta.empNo || "—";
      $("#pName").textContent  = state.meta.name  || "—";
      $("#pPos").textContent   = state.meta.pos   || "—";
      $("#pDept").textContent  = state.meta.dept  || "—";
      $("#pPeriod").textContent= state.meta.period|| "—";
      $("#pVer").textContent   = state.meta.ver   || "—";

      // date format
      const d = state.meta.date;
      if(d){
        const [yy, mm, dd] = d.split("-");
        $("#pDate").textContent = `${dd}/${mm}/${yy}`;
      }else{
        $("#pDate").textContent = "—";
      }

      // table rows
      const tbody = $("#pTable tbody");
      tbody.innerHTML = "";

      // Maintain the same order as the form
      factors.forEach(f => {
        f.items.forEach(it => {
          const tr = document.createElement("tr");

          const tdItem = document.createElement("td");
          tdItem.textContent = it.name;

          const tdAns = document.createElement("td");
          const v = state.answers[it.id];
          if(v == null){
            tdAns.textContent = "—";
          }else{
            const text = it.options[v-1] || `${v}`;
            tdAns.textContent = text;
          }

          tr.appendChild(tdItem);
          tr.appendChild(tdAns);
          tbody.appendChild(tr);
        });
      });

      const total = computeTotal(state);
      $("#pTotal").textContent = total.toFixed(2);

      $("#pResultados").textContent   = state.notes.resultados  || "—";
      $("#pConclusiones").textContent = state.notes.conclusiones|| "—";
      $("#pCapacitacion").textContent = state.notes.capacitacion|| "—";
      $("#pCarrera").textContent      = state.notes.carrera     || "—";

      lastReportReady = true;
      $("#btnPrint").disabled = false;
    }

    function handleGenerate(){
      const state = collectState();
      fillReport(state);
      // imprimir directamente (para PDF)
      window.print();
    }

    function handlePrint(){
      if(!lastReportReady){
        // si aún no hay reporte, lo generamos con lo actual
        const state = collectState();
        fillReport(state);
      }
      window.print();
    }

    // =========================
    //  Init
    // =========================
    function bindButtons(){
      $("#btnNew").addEventListener("click", handleNew);
      $("#btnSave").addEventListener("click", handleSave);
      $("#btnGenerate").addEventListener("click", handleGenerate);
      $("#btnPrint").addEventListener("click", handlePrint);
    }

    (function bootstrap(){
      renderForm();
      loadSaved();
      clearDirty();
      bindButtons();
    })();
  </script>
</body>
</html>
