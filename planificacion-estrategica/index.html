<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√≥dulo | Planificaci√≥n Estrat√©gica ‚Äî Recolecci√≥n de datos</title>

  <!-- Evita 404 de favicon en GitHub Pages -->
  <link rel="icon" href="data:," />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --card:#0f203f;
      --muted:#9fb3d9;
      --text:#eaf1ff;
      --line: rgba(255,255,255,.16);
      --accent:#6aa6ff;
      --ok:#3ddc97;
      --warn:#ffd36a;
      --bad:#ff6a8b;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      font-size: 16px;
      line-height: 1.5;
      background: radial-gradient(1200px 800px at 10% 10%, rgba(106,166,255,.14), transparent 55%),
                  radial-gradient(1000px 700px at 90% 20%, rgba(61,220,151,.10), transparent 55%),
                  radial-gradient(900px 700px at 60% 90%, rgba(255,211,106,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height:100vh;
    }
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:22px 18px;
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,27,51,.95), rgba(15,27,51,.72));
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 10px 16px;
      border-bottom:1px solid var(--line);
      margin-bottom:14px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,166,255,.95), rgba(61,220,151,.85));
      box-shadow: 0 10px 30px rgba(106,166,255,.25);
      display:grid;place-items:center;
      font-weight:800;
      color:#081022;
      letter-spacing:.5px;
      user-select:none;
    }
    .brand h1{
      font-size:14px;
      margin:0;
      line-height:1.2;
    }
    .brand p{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .status{
      margin:14px 10px 10px;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.03);
    }
    .status .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      white-space:nowrap;
    }
    .progress{
      margin-top:10px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(106,166,255,.95), rgba(61,220,151,.85));
      transition: width .25s ease;
    }

    nav{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:8px;
    }
    .navbtn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:100%;
      border:1px solid transparent;
      background: transparent;
      color: var(--text);
      text-align:left;
      padding:10px 10px;
      border-radius: 12px;
      cursor:pointer;
      transition: .15s ease;
      font-size: 15px;
    }
    .navbtn small{color:var(--muted); font-size: 13px;}
    .navbtn:hover{background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.06)}
    .navbtn.active{
      background: rgba(106,166,255,.12);
      border-color: rgba(106,166,255,.30);
    }

    .side-actions{
      margin-top:auto;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .btn{
      width:100%;
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 12px;
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      transition: .15s ease;
      display:flex; align-items:center; justify-content:center; gap:10px;
      font-weight:600;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
    .btn.primary{
      border-color: rgba(106,166,255,.35);
      background: rgba(106,166,255,.16);
    }
    .btn.danger{
      border-color: rgba(255,106,139,.35);
      background: rgba(255,106,139,.12);
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.4;
      padding:0 10px 8px;
    }

    .main{
      padding:26px 26px 40px;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    .title h2{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      max-width: 70ch;
      line-height:1.55;
      font-size:15px;
    }
    .toast{
      min-width: 260px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;
    }
    .toast strong{font-size:13px}
    .toast div{font-size:12px; color:var(--muted); margin-top:4px}

    form{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      max-width: 1050px;
    }
    .section{
      border: 1px solid rgba(255,255,255,.18);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(15,32,63,.82), rgba(15,32,63,.52));
      box-shadow:
        var(--shadow),
        0 0 0 1px rgba(106,166,255,.06) inset;
      overflow:hidden;
    }
    .section header{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      user-select:none;
    }
    .section header .left{
      display:flex; flex-direction:column; gap:3px;
    }
    .section header h3{ margin:0; font-size:18px; }
    .section header span{ font-size:14px; color:var(--muted); }
    .chev{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:grid;place-items:center;
      transition:.15s ease;
      flex:0 0 auto;
    }
    .section[data-open="true"] .chev{transform: rotate(180deg)}
    .section .body{
      padding:16px;
      display:none;
    }
    .section[data-open="true"] .body{display:block}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .field{
      grid-column: span 12;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field.col-6{grid-column: span 6}
    .field.col-4{grid-column: span 4}
    .field.col-3{grid-column: span 3}
    label{
      font-size:14px;
      color: var(--muted);
    }
    input, textarea, select{
      width:100%;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      background: rgba(255,255,255,.045);
      color: var(--text);
      font-size: 16px;
      padding:12px 14px;
      outline:none;
      box-shadow: 0 0 0 1px rgba(0,0,0,.18) inset;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input:hover, textarea:hover, select:hover{
      border-color: rgba(255,255,255,.26);
      background: rgba(255,255,255,.06);
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(106,166,255,.60);
      box-shadow:
        0 0 0 3px rgba(106,166,255,.18),
        0 0 0 1px rgba(106,166,255,.25) inset;
    }
    textarea{min-height:110px; resize:vertical}
    .meta{
      font-size:12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .req::after{
      content:" *";
      color: var(--warn);
      font-weight:700;
    }
    .error{
      border-color: rgba(255,106,139,.55) !important;
      box-shadow: 0 0 0 3px rgba(255,106,139,.12) !important;
    }
    .footer{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
    }
    .footer .right{display:flex; gap:10px; flex-wrap:wrap}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      padding:2px 6px;
      border:1px solid var(--line);
      border-radius:8px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .main{padding:18px}
      .field.col-6, .field.col-4, .field.col-3{grid-column: span 12}
      .toast{display:none !important}
    }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">PE</div>
      <div>
        <h1>Planificaci√≥n Estrat√©gica</h1>
        <p>Recolecci√≥n de datos ‚Ä¢ versi√≥n inicial</p>
      </div>
    </div>

    <div class="status" aria-live="polite">
      <div class="row">
        <div>
          <div style="font-weight:700;font-size:13px;">Progreso</div>
          <div style="color:var(--muted);font-size:12px;margin-top:2px;">
            Campos completos: <span id="filledCount">0</span>/<span id="totalCount">0</span>
          </div>
        </div>
        <div class="pill" id="autosavePill">Auto-guardado: ON</div>
      </div>
      <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="progressBar"></div>
      </div>
    </div>

    <nav aria-label="Secciones">
      <button class="navbtn active" data-target="sec-empresa" type="button">
        <span>1) Datos generales<br><small>Empresa y contexto</small></span>
        <small>‚Ü©</small>
      </button>
      <button class="navbtn" data-target="sec-identidad" type="button">
        <span>2) Identidad<br><small>Misi√≥n, visi√≥n, valores</small></span>
        <small>‚Ü©</small>
      </button>
      <button class="navbtn" data-target="sec-interno" type="button">
        <span>3) An√°lisis interno<br><small>Fortalezas / debilidades</small></span>
        <small>‚Ü©</small>
      </button>
      <button class="navbtn" data-target="sec-externo" type="button">
        <span>4) An√°lisis externo<br><small>Oportunidades / amenazas</small></span>
        <small>‚Ü©</small>
      </button>
      <button class="navbtn" data-target="sec-mercado" type="button">
        <span>5) Mercado & Competencia<br><small>Cliente, canales, rivalidad</small></span>
        <small>‚Ü©</small>
      </button>
      <button class="navbtn" data-target="sec-metas" type="button">
        <span>6) Metas & Control<br><small>Logros, seguimiento</small></span>
        <small>‚Ü©</small>
      </button>
    </nav>

   <div class="hint">
  Tip r√°pido: llena primero lo ‚Äúdoloroso‚Äù (amenazas/debilidades). Lo bonito se escribe solo. üòÖ
</div>

<div class="side-actions">
  <button class="btn danger" id="btnReset" type="button">üß® Limpiar formulario</button>
  <div class="hint" style="padding-bottom:0;">
    Auto-guardado en tu navegador.
  </div>
</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title">
        <h2>Recolecci√≥n de datos</h2>
        <p>
          Completa esta ficha para levantar insumos del plan estrat√©gico.
          Todo queda guardado localmente y puedes exportarlo para integrarlo con tu pipeline en GitHub.
        </p>
       <div class="meta">
  <span>Guardado: <span class="kbd">localStorage</span></span>
  <span>Env√≠o: <span class="kbd">Google Sheets</span></span>
</div>
      </div>

      <div class="toast" id="toast">
        <strong id="toastTitle">Listo</strong>
        <div id="toastMsg">Acci√≥n completada.</div>
      </div>
    </div>

    <form id="strategyForm" novalidate>
      <!-- 1) DATOS GENERALES -->
      <section class="section" id="sec-empresa" data-open="true">
        <header role="button" tabindex="0" aria-controls="body-empresa" aria-expanded="true">
          <div class="left">
            <h3>1) Datos generales</h3>
            <span>Informaci√≥n base de la organizaci√≥n</span>
          </div>
          <div class="chev" aria-hidden="true">‚åÑ</div>
        </header>
        <div class="body" id="body-empresa">
          <div class="grid">
            <div class="field col-4">
              <label for="marcaTemporal" class="req">Marca temporal</label>
              <input id="marcaTemporal" name="marcaTemporal" type="datetime-local" required />
            </div>
            <div class="field col-4">
              <label for="periodo" class="req">Per√≠odo</label>
              <input id="periodo" name="periodo" type="text" placeholder="Ej: 2026-2028" required />
            </div>
            <div class="field col-4">
              <label for="codigo">C√≥digo</label>
              <input id="codigo" name="codigo" type="text" placeholder="Ej: PE-001" />
            </div>

            <div class="field col-6">
              <label for="nombreEmpresa" class="req">Nombre de la empresa</label>
              <input id="nombreEmpresa" name="nombreEmpresa" type="text" placeholder="Raz√≥n social / nombre comercial" required />
            </div>
            <div class="field col-6">
              <label for="sectorIndustria" class="req">Sector o industria</label>
              <input id="sectorIndustria" name="sectorIndustria" type="text" placeholder="Ej: Laboratorio / Alimentos / Servicios" required />
            </div>

            <div class="field col-6">
              <label for="productosServicios" class="req">Productos o servicios principales</label>
              <textarea id="productosServicios" name="productosServicios" placeholder="Describe lo principal que ofreces." required></textarea>
            </div>
            <div class="field col-3">
              <label for="tiempoOperacion">Tiempo de operaci√≥n</label>
              <input id="tiempoOperacion" name="tiempoOperacion" type="text" placeholder="Ej: 5 a√±os" />
            </div>
            <div class="field col-3">
              <label for="numeroEmpleados">No. de empleados</label>
              <input id="numeroEmpleados" name="numeroEmpleados" type="number" min="0" step="1" placeholder="Ej: 35" />
            </div>

            <div class="field">
              <label for="ubicacionAlcance" class="req">Ubicaci√≥n y alcance</label>
              <textarea id="ubicacionAlcance" name="ubicacionAlcance" placeholder="Pa√≠s/ciudad, cobertura (local/nacional/regional), segmentos atendidos." required></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- 2) IDENTIDAD -->
      <section class="section" id="sec-identidad" data-open="true">
        <header role="button" tabindex="0" aria-controls="body-identidad" aria-expanded="true">
          <div class="left">
            <h3>2) Identidad organizacional</h3>
            <span>Misi√≥n, visi√≥n y valores</span>
          </div>
          <div class="chev" aria-hidden="true">‚åÑ</div>
        </header>
        <div class="body" id="body-identidad">
          <div class="grid">
            <div class="field">
              <label for="mision" class="req">Misi√≥n (¬øPor qu√© existe la empresa? ¬øQu√© busca ofrecer y a qui√©n?)</label>
              <textarea id="mision" name="mision" required placeholder="Ej: Brindar an√°lisis confiables para..."></textarea>
            </div>
            <div class="field">
              <label for="vision" class="req">Visi√≥n (¬øC√≥mo te gustar√≠a que se vea tu empresa en 3 a 5 a√±os?)</label>
              <textarea id="vision" name="vision" required></textarea>
            </div>
            <div class="field">
              <label for="valores" class="req">Valores (¬øQu√© principios rigen su actuar?)</label>
              <textarea id="valores" name="valores" required placeholder="Ej: Integridad, calidad, enfoque al cliente, mejora continua..."></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) AN√ÅLISIS INTERNO -->
      <section class="section" id="sec-interno" data-open="true">
        <header role="button" tabindex="0" aria-controls="body-interno" aria-expanded="true">
          <div class="left">
            <h3>3) An√°lisis interno</h3>
            <span>Fortalezas y debilidades (RRHH, finanzas, tecnolog√≠a, procesos, innovaci√≥n, cultura)</span>
          </div>
          <div class="chev" aria-hidden="true">‚åÑ</div>
        </header>
        <div class="body" id="body-interno">
          <div class="grid">
            <div class="field col-6">
              <label for="fortalezas" class="req">Fortalezas (recursos + capacidades)</label>
              <textarea id="fortalezas" name="fortalezas" required placeholder="Incluye RRHH, financieros, tecnol√≥gicos, procesos, innovaci√≥n y cultura."></textarea>
            </div>
            <div class="field col-6">
              <label for="debilidades" class="req">Debilidades (brechas + limitantes)</label>
              <textarea id="debilidades" name="debilidades" required placeholder="Incluye RRHH, financieros, tecnol√≥gicos, procesos, innovaci√≥n y cultura."></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- 4) AN√ÅLISIS EXTERNO -->
      <section class="section" id="sec-externo" data-open="true">
        <header role="button" tabindex="0" aria-controls="body-externo" aria-expanded="true">
          <div class="left">
            <h3>4) An√°lisis externo</h3>
            <span>Oportunidades y amenazas (competencia, tendencias, PESTEL, regulaci√≥n)</span>
          </div>
          <div class="chev" aria-hidden="true">‚åÑ</div>
        </header>
        <div class="body" id="body-externo">
          <div class="grid">
            <div class="field col-6">
              <label for="oportunidades" class="req">Oportunidades</label>
              <textarea id="oportunidades" name="oportunidades" required placeholder="Competencia, tendencias de mercado, PESTEL, cambios regulatorios..."></textarea>
            </div>
            <div class="field col-6">
              <label for="amenazas" class="req">Amenazas</label>
              <textarea id="amenazas" name="amenazas" required placeholder="Competencia, tendencias, PESTEL, cambios en normativa..."></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- 5) MERCADO & COMPETENCIA -->
      <section class="section" id="sec-mercado" data-open="true">
        <header role="button" tabindex="0" aria-controls="body-mercado" aria-expanded="true">
          <div class="left">
            <h3>5) Mercado y competencia</h3>
            <span>Cliente, canales, posicionamiento, competidores, diferenciaci√≥n, benchmarking</span>
          </div>
          <div class="chev" aria-hidden="true">‚åÑ</div>
        </header>
        <div class="body" id="body-mercado">
          <div class="grid">
            <div class="field">
              <label for="publicoObjetivo" class="req">P√∫blico objetivo (buyer persona)</label>
              <textarea id="publicoObjetivo" name="publicoObjetivo" required placeholder="¬øQui√©n compra? perfil, necesidades, decisi√≥n de compra, criterios."></textarea>
            </div>

            <div class="field col-6">
              <label for="comportamientoCliente" class="req">Comportamiento del cliente</label>
              <textarea id="comportamientoCliente" name="comportamientoCliente" required placeholder="Frecuencia, motivadores, objeciones, estacionalidad, etc."></textarea>
            </div>
            <div class="field col-6">
              <label for="canalesVenta" class="req">Canales de venta y distribuci√≥n</label>
              <textarea id="canalesVenta" name="canalesVenta" required placeholder="Directo, distribuidores, online, alianzas, etc."></textarea>
            </div>

            <div class="field col-6">
              <label for="posicionamientoActual" class="req">Posicionamiento actual</label>
              <textarea id="posicionamientoActual" name="posicionamientoActual" required placeholder="¬øC√≥mo te perciben hoy? precio/calidad, rapidez, especialidad, servicio..."></textarea>
            </div>
            <div class="field col-6">
              <label for="competidoresPrincipales" class="req">¬øQui√©nes son los principales competidores?</label>
              <textarea id="competidoresPrincipales" name="competidoresPrincipales" required placeholder="Nombres, tipo, fortalezas visibles."></textarea>
            </div>

            <div class="field col-6">
              <label for="diferenciacion" class="req">¬øQu√© nos diferencia con relaci√≥n a nuestros competidores?</label>
              <textarea id="diferenciacion" name="diferenciacion" required placeholder="Propuesta de valor, ventajas, capacidades √∫nicas."></textarea>
            </div>
            <div class="field col-6">
              <label for="benchmarking">An√°lisis comparativo (Benchmarking)</label>
              <textarea id="benchmarking" name="benchmarking" placeholder="Qu√© pr√°cticas/indicadores comparas y qu√© hallazgos surgieron."></textarea>
            </div>

            <div class="field col-6">
              <label for="logros12m" class="req">Logros esperados en los pr√≥ximos 12 meses</label>
              <textarea id="logros12m" name="logros12m" required placeholder="3‚Äì7 resultados medibles, por ejemplo: ventas, calidad, productividad, certificaciones, etc."></textarea>
            </div>
            <div class="field col-6">
              <label for="logros3a5" class="req">Logros esperados en los pr√≥ximos 3 - 5 a√±os</label>
              <textarea id="logros3a5" name="logros3a5" required placeholder="Resultados estrat√©gicos: expansi√≥n, innovaci√≥n, liderazgo, sostenibilidad..."></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- 6) METAS & CONTROL -->
      <section class="section" id="sec-metas" data-open="true">
        <header role="button" tabindex="0" aria-controls="body-metas" aria-expanded="true">
          <div class="left">
            <h3>6) Metas, control y seguimiento</h3>
            <span>Gobernanza del plan: control, revisiones y contacto</span>
          </div>
          <div class="chev" aria-hidden="true">‚åÑ</div>
        </header>
        <div class="body" id="body-metas">
          <div class="grid">
            <div class="field col-6">
              <label for="sistemaControl" class="req">¬øTiene la organizaci√≥n un sistema de control o seguimiento de metas actualmente?</label>
              <select id="sistemaControl" name="sistemaControl" required>
                <option value="">Selecciona‚Ä¶</option>
                <option>S√≠</option>
                <option>No</option>
                <option>Parcial / En construcci√≥n</option>
              </select>
            </div>
            <div class="field col-6">
              <label for="frecuenciaRevision" class="req">¬øCada cu√°nto tiempo te gustar√≠a hacer revisiones del plan?</label>
              <select id="frecuenciaRevision" name="frecuenciaRevision" required>
                <option value="">Selecciona‚Ä¶</option>
                <option>Mensual</option>
                <option>Bimestral</option>
                <option>Trimestral</option>
                <option>Semestral</option>
                <option>Anual</option>
              </select>
            </div>

            <div class="field col-6">
              <label for="correo" class="req">Correo</label>
              <input id="correo" name="correo" type="email" required placeholder="nombre@empresa.com" />
            </div>

            <div class="field col-6">
              <label for="notas">Notas adicionales (opcional)</label>
              <input id="notas" name="notas" type="text" placeholder="Algo que quieras agregar antes de pasar a FODA/KPIs‚Ä¶" />
            </div>
          </div>

          <div class="footer">
            <div class="meta">
              <span id="lastSaved">√öltimo guardado: ‚Äî</span>
              <span>Tip: completa primero lo ‚Äúdoloroso‚Äù (amenazas/debilidades). Lo bonito se escribe solo.</span>
            </div>
            <div class="right">
              <button class="btn" type="button" id="btnValidate">‚úÖ Validar</button>
              <button class="btn primary" type="submit" id="btnSubmit">üíæ Guardar</button>
            </div>
          </div>
        </div>
      </section>
    </form>
  </main>
</div>

<script>
  // ============================
  // ‚úÖ CONFIG (Sheets WebApp + Sheet)
  // ============================
  const APPS_SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxR0lAIu1BMBxuAEmF5TYrYwR8Zo2KVdIBs3NMEqGj4o7q5q6i_yzMpGW7-dh7h7HDiow/exec";
// ‚úÖ Tu spreadsheet real (PlanEstrategico1)
const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1NbYSAFO8p9Vget0hmmXxZMp-Q6u0Or8UpyJkxZs6YBY/edit?usp=sharing";
// ‚úÖ Tu pesta√±a real
const ENCUESTAS_SHEET_NAME = "Encuestas";
  const STORAGE_KEY = "strategic_planning_intake_v1";

  // ============================
  // üß± Utils UI
  // ============================
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const toast = (title, msg, type="ok") => {
    const t = $("#toast");
    $("#toastTitle").textContent = title;
    $("#toastMsg").textContent = msg;
    t.style.display = "block";
    t.style.borderColor =
      type==="ok" ? "rgba(61,220,151,.35)" :
      type==="warn" ? "rgba(255,211,106,.35)" :
      "rgba(255,106,139,.35)";
    setTimeout(()=> t.style.display = "none", 2400);
  };

  const nowLocalDatetime = () => {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth()+1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  };

  const prettyNow = () => {
    const d = new Date();
    return d.toLocaleString();
  };

  // ============================
  // üß© Secciones (abrir/cerrar) + Navegaci√≥n
  // ============================
  function initSectionsAndNav(){
    $$(".section > header").forEach(h => {
      const sec = h.closest(".section");
      const toggle = () => {
        const isOpen = sec.getAttribute("data-open") === "true";
        sec.setAttribute("data-open", String(!isOpen));
        h.setAttribute("aria-expanded", String(!isOpen));
      };
      h.addEventListener("click", toggle);
      h.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
      });
    });

    $$(".navbtn").forEach(btn => {
      btn.addEventListener("click", () => {
        $$(".navbtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const id = btn.getAttribute("data-target");
        const el = document.getElementById(id);
        if (el){
          el.setAttribute("data-open", "true");
          el.scrollIntoView({ behavior:"smooth", block:"start" });
        }
      });
    });
  }

  // ============================
  // üß± Payload desde el formulario
  // (coincide con los headers de tu sheet "Empresas")
  // ============================
  function buildEmpresasPayloadFromForm() {
    const pick = (id) => (document.getElementById(id)?.value || "").trim();

    return {
      marcaTemporal: pick("marcaTemporal"),
      periodo: pick("periodo"),
      codigo: pick("codigo"),
      nombreEmpresa: pick("nombreEmpresa"),
      sectorIndustria: pick("sectorIndustria"),
      productosServicios: pick("productosServicios"),
      tiempoOperacion: pick("tiempoOperacion"),
      numeroEmpleados: pick("numeroEmpleados"),
      ubicacionAlcance: pick("ubicacionAlcance"),

      mision: pick("mision"),
      vision: pick("vision"),
      valores: pick("valores"),

      fortalezas: pick("fortalezas"),
      debilidades: pick("debilidades"),

      oportunidades: pick("oportunidades"),
      amenazas: pick("amenazas"),

      publicoObjetivo: pick("publicoObjetivo"),
      comportamientoCliente: pick("comportamientoCliente"),
      canalesVenta: pick("canalesVenta"),

      posicionamientoActual: pick("posicionamientoActual"),
      competidoresPrincipales: pick("competidoresPrincipales"),
      diferenciacion: pick("diferenciacion"),
      benchmarking: pick("benchmarking"),

      logros12m: pick("logros12m"),
      logros3a5: pick("logros3a5"),

      sistemaControl: pick("sistemaControl"),
      frecuenciaRevision: pick("frecuenciaRevision"),

      correo: pick("correo"),
      notas: pick("notas")
    };
  }

  // ============================
  // ‚úÖ Validaci√≥n (UI)
  // ============================
  function validateFormUI({ showToast=true } = {}) {
    const form = $("#strategyForm");
    const required = $$("[required]", form);

    let ok = true;
    required.forEach(el => {
      const isEmpty = !String(el.value || "").trim();
      el.classList.toggle("error", isEmpty);
      if (isEmpty) ok = false;
    });

    if (showToast) {
      if (ok) toast("Validaci√≥n OK", "Campos requeridos completos.", "ok");
      else toast("Faltan campos", "Revisa los campos marcados con borde rojo.", "warn");
    }
    return ok;
  }

  // ============================
  // üß† Auto-guardado local (localStorage)
  // ============================
  function saveToLocalStorage() {
    const data = buildEmpresasPayloadFromForm();
    const out = {
      version: 1,
      savedAt: new Date().toISOString(),
      data
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
    $("#lastSaved").textContent = `√öltimo guardado: ${prettyNow()}`;
  }

  function loadFromLocalStorage() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try{
      const obj = JSON.parse(raw);
      const d = obj?.data || {};
      Object.keys(d).forEach(k => {
        const el = document.querySelector(`[name="${k}"]`);
        if (el && typeof d[k] !== "undefined") el.value = d[k];
      });
      $("#lastSaved").textContent = `√öltimo guardado: ${prettyNow()}`;
    } catch {}
  }

  // ============================
  // üìà Progreso (campos completos)
  // ============================
  function updateProgress() {
    const form = $("#strategyForm");
    const fields = $$("input, textarea, select", form).filter(el => el.type !== "submit" && el.type !== "button");
    const total = fields.length;
    const filled = fields.filter(el => String(el.value || "").trim().length > 0).length;

    $("#filledCount").textContent = String(filled);
    $("#totalCount").textContent = String(total);

    const pct = total ? Math.round((filled/total)*100) : 0;
    $("#progressBar").style.width = `${pct}%`;
    $(".progress").setAttribute("aria-valuenow", String(pct));
  }
  // ============================
  // üß® Limpiar formulario (reset total)
  // ============================
  function clearValidationUI() {
    const form = $("#strategyForm");
    $$("[required]", form).forEach(el => el.classList.remove("error"));
  }

  function limpiarFormulario({ confirmUser=true } = {}) {
    if (confirmUser) {
      const ok = confirm("¬øSeguro que quieres limpiar el formulario? Se borrar√° lo guardado localmente (auto-guardado).");
      if (!ok) return;
    }

    const form = $("#strategyForm");

    // 1) Reset campos (respeta defaults del HTML)
    form.reset();

    // 2) Re-set marcaTemporal a ahora (porque reset lo deja vac√≠o si no hay value por defecto)
    const mt = $("#marcaTemporal");
    if (mt) mt.value = nowLocalDatetime();

    // 3) Limpia UI de validaci√≥n
    clearValidationUI();

    // 4) Borra auto-guardado local
    localStorage.removeItem(STORAGE_KEY);

    // 5) Refresca indicadores + ‚Äúhuella‚Äù nueva opcional
    updateProgress();
    $("#lastSaved").textContent = "√öltimo guardado: ‚Äî";

    // Si quieres que vuelva a quedar guardado ‚Äúvac√≠o‚Äù inmediatamente, descomenta:
    // saveToLocalStorage();

    toast("Formulario limpio", "Se borr√≥ el auto-guardado y se reiniciaron los campos.", "ok");
  }  
  // ============================
  // ‚òÅÔ∏è Guardar en Google Sheets v√≠a WebApp (SIN preflight)
  // Tabula por fila (append) en hoja: Empresas
  // ============================
  async function guardarEnGoogleSheetsEmpresas() {
  if (!APPS_SCRIPT_WEBAPP_URL) {
    return { ok:false, error:"missing_webapp_url" };
  }

  const data = buildEmpresasPayloadFromForm();

  // m√≠nimos
  if (!data.periodo || !data.nombreEmpresa) {
    return { ok:false, error:"missing_required_fields", msg:"Completa Per√≠odo y Nombre de la empresa." };
  }

  const payloadObj = { sheetName: ENCUESTAS_SHEET_NAME, data };

  // ‚úÖ Forma M√ÅS compatible para GitHub Pages ‚Üí Apps Script (sin preflight):
  // Content-Type simple: application/x-www-form-urlencoded
  // Body: payload=<json_urlencoded>
  const body = "payload=" + encodeURIComponent(JSON.stringify(payloadObj));

  try{
   const res = await fetch(APPS_SCRIPT_WEBAPP_URL, {
  method: "POST",
  mode: "cors",
  headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
  body,
  cache: "no-store",
  keepalive: true
});

const text = await res.text();
let json = null;
try { json = JSON.parse(text); } catch {}

if (!res.ok || !json?.ok) {
  return { ok:false, error:"apps_script_error", msg: json?.error || text || "Respuesta inv√°lida" };
}
return { ok:true, action:"saved", row: json.row || null };

    // No podemos leer respuesta por no-cors, pero al menos enviamos en el formato correcto
    return { ok:true, action:"sent_form_urlencoded" };

  } catch (err) {
    // Fallback: sendBeacon
    try{
      const blob = new Blob([body], { type: "application/x-www-form-urlencoded;charset=UTF-8" });
      const queued = navigator.sendBeacon(APPS_SCRIPT_WEBAPP_URL, blob);
      if (queued) return { ok:true, action:"beacon_queued" };
    } catch {}

    return { ok:false, error:"network_error", msg:String(err?.message || err) };
  }
}
  // ============================
  // üß∑ Eventos
  // ============================
  function initEvents(){
    const form = $("#strategyForm");

    // Default marcaTemporal
    const mt = $("#marcaTemporal");
    if (mt && !mt.value) mt.value = nowLocalDatetime();

    // Auto-save on input
    form.addEventListener("input", () => {
      saveToLocalStorage();
      updateProgress();
    });
    // ‚úÖ Validar
const btnValidate = $("#btnValidate");
if (btnValidate) {
  btnValidate.addEventListener("click", () => validateFormUI({ showToast:true }));
}
    // üß® Reset / Limpiar formulario
    const btnReset = $("#btnReset");
    if (btnReset) {
      btnReset.addEventListener("click", () => limpiarFormulario({ confirmUser:true }));
    }
    
    // SUBMIT: Guardar en Sheets + Exportar JSON
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const ok = validateFormUI({ showToast:true });
      if (!ok) return;

      // UX: deshabilitar bot√≥n mientras guarda
      const btn = $("#btnSubmit");
      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = "‚è≥ Guardando‚Ä¶";

      const out = await guardarEnGoogleSheetsEmpresas();

      btn.disabled = false;
      btn.textContent = old;

  if (out?.ok) {
  toast("Guardado", "Datos enviados a Google Sheets.", "ok");
  saveToLocalStorage();
} else {
        const msg =
          out?.msg ||
          (out?.error === "html_response"
            ? "El WebApp devolvi√≥ HTML (normalmente permisos/login). Revisa que el WebApp est√© desplegado con acceso 'Cualquiera' y que doPost responda JSON."
            : "No se pudo guardar. Revisa consola/Apps Script.");
        toast("Error al guardar", msg, "bad");
        console.error("guardarEnGoogleSheetsEmpresas():", out);
      }
    });
  }

    // saveToLocalStorage(); // (opcional) no guardar hasta que el usuario escriba

  // ============================
  // üöÄ Init
  // ============================
  (function init(){
    initSectionsAndNav();
    loadFromLocalStorage();
    updateProgress();
    
    initEvents();
  })();
</script>
</body>
</html>
