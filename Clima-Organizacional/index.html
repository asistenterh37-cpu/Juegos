<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Encuesta de clima organizacional</title>
  <link rel="icon" href="data:," />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --card:#0f203f;
      --text:#e8eefc;
      --muted:#9fb0d6;
      --line:rgba(255,255,255,.10);
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 40% 20%, #162447 0%, var(--bg) 55%);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.72));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      padding:16px 20px;
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
    }
    .brand{font-size:22px; font-weight:800; letter-spacing:.2px}
    .chips{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--muted);
    }
    .chip b{color:var(--text)}
    .remoteDot{
      display:inline-block; width:8px; height:8px; border-radius:99px; margin-right:6px;
      background: var(--warn);
      box-shadow: 0 0 14px rgba(245,158,11,.6);
      vertical-align:middle;
    }
    .remoteDot.ok{background:var(--ok); box-shadow:0 0 14px rgba(34,197,94,.55)}
    .nav{
      display:flex; gap:10px;
    }
    .nav button{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
    }
    .nav button.active{
      background: rgba(59,130,246,.18);
      border-color: rgba(59,130,246,.35);
    }

    .wrap{max-width:1180px; margin:22px auto; padding:0 18px 40px;}
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .panel h3{
      margin:0 0 8px;
      font-size:13px;
      letter-spacing:.5px;
      color:#b9c8ee;
      text-transform:uppercase;
    }
    .help{
      color:var(--muted);
      font-size:12px;
      margin-bottom:12px;
      line-height:1.35;
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row.one{grid-template-columns:1fr}
    label{
      font-size:12px; color:#b9c8ee;
      display:block; margin:10px 0 6px;
    }
    select, textarea, input{
      width:100%;
      background: rgba(0,0,0,.22);
      color:var(--text);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    .scale{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      border-top:1px solid var(--line);
      padding-top:12px;
    }
    .items{
      display:flex; flex-direction:column; gap:12px;
      max-height: calc(100vh - 210px);
      overflow:auto;
      padding-right:6px;
    }
    .itemCard{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding:12px;
    }
    .itemTop{display:flex; gap:12px; justify-content:space-between; align-items:flex-start}
    .itemTitle{
      font-weight:800; font-size:13px; line-height:1.25; margin:0;
    }
    .itemMeta{
      font-size:11px; color:var(--muted); margin-top:4px;
    }
    .itemRight{min-width:210px}
    .footerActions{
      margin-top:14px;
      display:flex; gap:10px; justify-content:flex-start; flex-wrap:wrap;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .btn{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.primary{
      background: rgba(34,197,94,.15);
      border-color: rgba(34,197,94,.35);
    }
    .btn.ghost{
      background: rgba(255,255,255,.04);
    }
    .status{
      font-size:12px; color:var(--muted);
      margin-top:10px;
    }
    .status b{color:var(--text)}
    .hidden{display:none !important}

    /* Resultados */
    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 720px){
      .filters{grid-template-columns:1fr}
    }
    .cards3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:14px;
    }
    @media (max-width: 900px){
      .cards3{grid-template-columns:1fr}
    }
    .kpi{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding:14px;
    }
    .kpi .k{font-size:12px; color:#b9c8ee; text-transform:uppercase; letter-spacing:.4px}
    .kpi .v{font-size:26px; font-weight:900; margin-top:6px}
    .kpi .s{font-size:12px; color:var(--muted); margin-top:4px}
    .chartWrap{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .subTitle{
      margin:0 0 8px;
      font-size:13px; font-weight:900;
      letter-spacing:.3px;
      color:#cfe0ff;
      text-transform:uppercase;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      text-align:left;
    }
    th{color:#cfe0ff; font-size:12px; text-transform:uppercase; letter-spacing:.4px}
    td{color:var(--text)}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <header class="topbar">
    <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap;">
      <div class="brand">Encuesta de clima organizacional</div>
      <div class="chips">
        <span class="chip"><b>Google Sheets</b></span>
        <span class="chip"><span id="remoteDot" class="remoteDot"></span><span id="remoteText">Remote: —</span></span>
      </div>
    </div>
    <nav class="nav">
      <button id="tabEncuesta" class="active" onclick="showTab('encuesta')">Encuesta</button>
      <button id="tabResultados" onclick="showTab('resultados')">Resultados</button>
      <button id="tabResumen" onclick="showTab('resumen')">Resumen</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- ENCUESTA -->
    <section id="viewEncuesta">
      <div class="grid">
        <aside class="panel">
          <h3>Datos demográficos</h3>
          <div class="help">
            Selecciona tus datos. Estos valores se toman del arreglo <b>DEMOGRAPHICS</b>.
          </div>

          <div id="demographicsFields"></div>

          <div class="scale">
            <div style="font-weight:900; color:#cfe0ff; margin-bottom:8px;">Escala</div>
            <div>1 = Muy en desacuerdo</div>
            <div>2 = En desacuerdo</div>
            <div>3 = Ni de acuerdo ni en desacuerdo</div>
            <div>4 = De acuerdo</div>
            <div>5 = Totalmente de acuerdo</div>
            <div style="margin-top:10px;">
              <span style="display:inline-flex; align-items:center; gap:8px;">
                <span class="remoteDot ok" style="width:10px;height:10px;"></span>
                <span>WebApp configurado (envío por POST).</span>
              </span>
            </div>
          </div>
        </aside>

        <section class="panel">
          <h3>Encuesta</h3>
          <div class="help">
            Cada ítem se define en el arreglo <b>ITEMS</b>. Responde del 1 al 5.
          </div>

          <div id="itemsContainer" class="items"></div>

          <div style="margin-top:12px;">
            <label>Comentarios (opcional)</label>
            <textarea id="comentarios" placeholder="Escribe tus comentarios..."></textarea>
          </div>

          <div class="footerActions">
            <button id="btnGuardar" class="btn primary" onclick="guardar()">Guardar</button>
            <button class="btn ghost" onclick="limpiar()">Limpiar</button>
          </div>

          <div id="saveStatus" class="status">Estado: <b>Listo</b></div>
        </section>
      </div>
    </section>

    <!-- RESULTADOS -->
    <section id="viewResultados" class="hidden">
      <div class="panel">
        <h3>Resultados</h3>
        <div class="help">
          Puedes ver resultados por: <b>General, Género, Antigüedad, Localidad, Departamento y Nivel</b>.
          Fuente: Google Sheets (hoja <b>Respuestas</b>) vía WebApp.
        </div>

        <div class="filters">
          <div>
            <label>Resultados por</label>
            <select id="groupBy" onchange="onGroupChange()"></select>
          </div>
          <div>
            <label>Variable</label>
            <select id="groupValue"></select>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" onclick="cargarResultados()">Refrescar</button>
        </div>

        <div class="cards3">
          <div class="kpi">
            <div class="k">Encuestas consideradas</div>
            <div class="v" id="kpiN">0</div>
            <div class="s muted">registros filtrados</div>
          </div>
          <div class="kpi">
            <div class="k">Promedio general</div>
            <div class="v" id="kpiAvg">—</div>
            <div class="s muted">Escala 0–100%</div>
          </div>
          <div class="kpi">
            <div class="k">Última respuesta</div>
            <div class="v" id="kpiLast">—</div>
            <div class="s muted">fecha/hora</div>
          </div>
        </div>

        <div class="chartWrap">
          <div class="subTitle">Calificación por ítem (barras)</div>
          <div class="help" id="noDataMsg">Aún no hay datos para graficar. Presiona <b>Refrescar</b> o guarda al menos una encuesta.</div>
          <canvas id="chartItems" height="110"></canvas>

          <div style="margin-top:18px;">
            <div class="subTitle">Promedios por ítem (tabla)</div>
            <div id="tableWrap" class="muted">Aún no hay datos para mostrar.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESUMEN -->
    <section id="viewResumen" class="hidden">
      <div class="panel">
        <h3>Resumen</h3>
        <div class="help">
          Resumen rápido según el filtro actual de Resultados.
        </div>

        <div class="filters">
          <div>
            <label>Resultados por</label>
            <select id="sumGroupBy" onchange="syncSummaryFilter()"></select>
          </div>
          <div>
            <label>Variable</label>
            <select id="sumGroupValue"></select>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" onclick="cargarResumen()">Refrescar</button>
        </div>

        <div id="summaryBox" style="margin-top:14px; line-height:1.5; color:var(--text);"></div>
      </div>
    </section>
  </main>

  <script>
    /***********************
     * CONFIG (EDITA AQUÍ)
     ***********************/
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxIXzVzMTpBPXz65B5O3EVe1sWPcCFnP-Q_QRc7RnOEqy6PGpe-hgft8CeTbhR6CwG7-w/exec";

    // Estructura según tus adjuntos: campos demográficos
    const DEMOGRAPHICS = [
      { key:"Genero",      label:"Género",      options:["Masculino","Femenino"] },
      { key:"Antiguedad",  label:"Antigüedad",  options:["De 0 a 5 años","De 6 a 10 años","De 11 a 20 años","Más de 20 años"] },
      { key:"Localidad",   label:"Localidad",   options:["Tegucigalpa","San Pedro Sula","La Ceiba"] },
      { key:"Departamento",label:"Departamento",options:["Contabilidad","Recursos human","Ventas","Compras"] },
      { key:"Nivel",       label:"Nivel",       options:["Operativo","Administrativo","Técnico","Jefe - Gerente"] }
    ];

    // 12 ítems (ajusta textos si quieres)
    const ITEMS = [
      { id:1,  text:"Mi jefe proporciona supervisión clara y consistente.", factor:"Liderazgo / Supervisión" },
      { id:2,  text:"La comunicación con mi jefe es abierta y efectiva.", factor:"Comunicación / Liderazgo" },
      { id:3,  text:"Los salarios en esta empresa son justos.", factor:"Compensación / Equidad salarial" },
      { id:4,  text:"Mis compañeros ayudan a crear un ambiente de trabajo positivo.", factor:"Clima laboral / Relaciones interpersonales" },
      { id:5,  text:"Mi jefe reconoce y valora mi trabajo.", factor:"Reconocimiento / Liderazgo" },
      { id:6,  text:"Mis horarios de trabajo son adecuados para mi vida personal.", factor:"Equilibrio vida-trabajo / Condiciones laborales" },
      { id:7,  text:"Mi jefe reconoce y valora mi trabajo.", factor:"Reconocimiento / Liderazgo" },
      { id:8,  text:"Siento confianza para hablar con mi jefe sobre problemas del trabajo.", factor:"Confianza / Comunicación con liderazgo" },
      { id:9,  text:"La colaboración con mis compañeros es positiva.", factor:"Trabajo en equipo / Colaboración" },
      { id:10, text:"La colaboración con mis compañeros es positiva.", factor:"Trabajo en equipo / Colaboración" },
      { id:11, text:"El plan de beneficios de mi empresa es competitivo.", factor:"Beneficios / Compensación total" },
      { id:12, text:"Los horarios de trabajo me permiten mantener un buen equilibrio laboral y personal.", factor:"Equilibrio vida-trabajo / Bienestar" }
    ];

    const SCALE_OPTIONS = [
      {v:"",  t:"Selecciona..."},
      {v:1, t:"1. Totalmente en desacuerdo"},
      {v:2, t:"2. En desacuerdo"},
      {v:3, t:"3. Ni en desacuerdo ni de acuerdo"},
      {v:4, t:"4. De acuerdo"},
      {v:5, t:"5. Totalmente de acuerdo"},
    ];

    /***********************
     * UI BUILD
     ***********************/
    const $ = (id)=>document.getElementById(id);

    function setRemote(ok, text){
      const dot = $("remoteDot");
      dot.classList.toggle("ok", !!ok);
      $("remoteText").textContent = "Remote: " + (text || (ok ? "conectado" : "sin conexión"));
    }

    function showTab(tab){
      $("viewEncuesta").classList.toggle("hidden", tab!=="encuesta");
      $("viewResultados").classList.toggle("hidden", tab!=="resultados");
      $("viewResumen").classList.toggle("hidden", tab!=="resumen");

      $("tabEncuesta").classList.toggle("active", tab==="encuesta");
      $("tabResultados").classList.toggle("active", tab==="resultados");
      $("tabResumen").classList.toggle("active", tab==="resumen");

      if(tab==="resultados") cargarResultados();
      if(tab==="resumen") cargarResumen();
    }

    function buildDemographics(){
      const wrap = document.createElement("div");
      // en el formato adjunto: 2 columnas
      const rows = [
        ["Genero","Antiguedad"],
        ["Localidad","Departamento"],
        ["Nivel"]
      ];

      rows.forEach(keys=>{
        const row = document.createElement("div");
        row.className = "row" + (keys.length===1 ? " one" : "");
        keys.forEach(k=>{
          const def = DEMOGRAPHICS.find(d=>d.key===k);
          const box = document.createElement("div");
          const lab = document.createElement("label");
          lab.textContent = def.label;
          const sel = document.createElement("select");
          sel.id = "dem_" + def.key;
          sel.innerHTML = `<option value="">Selecciona...</option>` + def.options.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
          box.appendChild(lab);
          box.appendChild(sel);
          row.appendChild(box);
        });
        wrap.appendChild(row);
      });

      $("demographicsFields").appendChild(wrap);
    }

    function buildItems(){
      const cont = $("itemsContainer");
      cont.innerHTML = "";
      ITEMS.forEach(it=>{
        const card = document.createElement("div");
        card.className = "itemCard";

        const top = document.createElement("div");
        top.className = "itemTop";

        const left = document.createElement("div");
        const title = document.createElement("p");
        title.className = "itemTitle";
        title.textContent = `${it.id}. ${it.text}`;
        const meta = document.createElement("div");
        meta.className = "itemMeta";
        meta.textContent = "Factor: " + it.factor;
        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "itemRight";
        const lab = document.createElement("label");
        lab.textContent = "Respuesta";
        const sel = document.createElement("select");
        sel.id = "item_" + it.id;
        sel.innerHTML = SCALE_OPTIONS.map(o=>`<option value="${o.v}">${escapeHtml(o.t)}</option>`).join("");
        right.appendChild(lab);
        right.appendChild(sel);

        top.appendChild(left);
        top.appendChild(right);

        card.appendChild(top);
        cont.appendChild(card);
      });
    }

    function initFilters(){
      const opts = [
        {v:"General", t:"General"},
        {v:"Genero", t:"Género"},
        {v:"Antiguedad", t:"Antigüedad"},
        {v:"Localidad", t:"Localidad"},
        {v:"Departamento", t:"Departamento"},
        {v:"Nivel", t:"Nivel"},
      ];
      $("groupBy").innerHTML = opts.map(o=>`<option value="${o.v}">${o.t}</option>`).join("");
      $("sumGroupBy").innerHTML = $("groupBy").innerHTML;

      $("groupBy").value = "General";
      $("sumGroupBy").value = "General";
      onGroupChange();
      syncSummaryFilter();
    }

    function onGroupChange(){
      const gb = $("groupBy").value;
      if(gb==="General"){
        $("groupValue").innerHTML = `<option value="">—</option>`;
        $("groupValue").disabled = true;
      }else{
        $("groupValue").disabled = false;
        // se llenará al llamar cargarOpcionesFiltro
        cargarOpcionesFiltro(gb, $("groupValue"));
      }
      // mantener resumen en sync
      $("sumGroupBy").value = gb;
      syncSummaryFilter();
    }

    function syncSummaryFilter(){
      const gb = $("sumGroupBy").value;
      if(gb==="General"){
        $("sumGroupValue").innerHTML = `<option value="">—</option>`;
        $("sumGroupValue").disabled = true;
      }else{
        $("sumGroupValue").disabled = false;
        cargarOpcionesFiltro(gb, $("sumGroupValue"));
      }
    }

    /***********************
     * VALIDACIÓN / PAYLOAD
     ***********************/
    function getPayload(){
  // Payload FLAT para que el GS lo ponga exacto en columnas sin inventar headers por texto
  const row = {};

  // Demográficos
  for(const d of DEMOGRAPHICS){
    row[d.key] = ($("dem_"+d.key).value || "").trim();
  }

  // Ítems (claves estables I1..I12)
  for(const it of ITEMS){
    row["I" + it.id] = Number($("item_" + it.id).value || 0);
  }

  // Comentarios
  row["Comentarios"] = ($("comentarios").value || "").trim();

  // opcional: versionado de esquema (útil para debugging)
  row["_schema"] = "clima_v1";

  return row;
}

function validatePayload(row){
  // Demográficos obligatorios
  for(const d of DEMOGRAPHICS){
    if(!row[d.key]) return `Falta seleccionar: ${d.label}`;
  }
  // Ítems obligatorios
  for(const it of ITEMS){
    if(!(row["I"+it.id] >= 1 && row["I"+it.id] <= 5)) return `Falta responder el ítem ${it.id}`;
  }
  return null;
}
    function limpiar(){
      for(const d of DEMOGRAPHICS){
        $("dem_"+d.key).value = "";
      }
      for(const it of ITEMS){
        $("item_"+it.id).value = "";
      }
      $("comentarios").value = "";
      setStatus("Listo");
    }

    function setStatus(msg, type="info"){
      const el = $("saveStatus");
      el.innerHTML = `Estado: <b>${escapeHtml(msg)}</b>`;
      if(type==="ok") el.style.color = "rgba(34,197,94,.9)";
      else if(type==="err") el.style.color = "rgba(239,68,68,.95)";
      else el.style.color = "var(--muted)";
    }

    /***********************
 * API CALLS (JSONP sin CORS)
 ***********************/
function jsonpRequest(params){
  return new Promise((resolve, reject)=>{
    const cbName = "__cb_" + Math.random().toString(36).slice(2);
    const q = new URLSearchParams(params || {});
    q.set("callback", cbName);

    // Evita caché del <script> (muy común en JSONP)
    q.set("_ts", String(Date.now()));

    const script = document.createElement("script");
    script.async = true;
    script.src = WEBAPP_URL + (WEBAPP_URL.includes("?") ? "&" : "?") + q.toString();

    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error("timeout"));
    }, 20000);

    function cleanup(){
      clearTimeout(timeout);
      try{ delete window[cbName]; }catch(_){}
      if(script && script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = (data)=>{
      cleanup();
      resolve(data);
    };

    script.onerror = ()=>{
      cleanup();
      reject(new Error("network_error"));
    };

    document.body.appendChild(script);
  });
}
// POST sin CORS usando iframe oculto + postMessage desde el WebApp
function postViaIframe(fields){
  return new Promise((resolve, reject)=>{
    const token = "__if_" + Math.random().toString(36).slice(2);
    const iframeName = "if_" + token;

    const iframe = document.createElement("iframe");
    iframe.name = iframeName;
    iframe.style.display = "none";

    const form = document.createElement("form");
    form.method = "POST";
    form.action = WEBAPP_URL;
    form.target = iframeName;

    // metemos token para identificar la respuesta del iframe
    const payloadFields = Object.assign({}, fields, { token });

    Object.keys(payloadFields).forEach(k=>{
      const inp = document.createElement("input");
      inp.type = "hidden";
      inp.name = k;
      inp.value = String(payloadFields[k] ?? "");
      form.appendChild(inp);
    });

    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error("timeout"));
    }, 20000);

    function cleanup(){
      clearTimeout(timeout);
      window.removeEventListener("message", onMsg);
      if(form && form.parentNode) form.parentNode.removeChild(form);
      if(iframe && iframe.parentNode) iframe.parentNode.removeChild(iframe);
    }

    function onMsg(ev){
      // opcional: puedes endurecer esto validando ev.origin
      // if(ev.origin !== "https://script.google.com") return;

      const data = ev.data;
      if(!data || data.token !== token) return;

      cleanup();
      resolve(data);
    }

    window.addEventListener("message", onMsg);

    document.body.appendChild(iframe);
    document.body.appendChild(form);

    try{
      form.submit();
    }catch(e){
      cleanup();
      reject(e);
    }
  });
}

async function ping(){
  try{
    const j = await jsonpRequest({ action:"ping" });
    if(!j || !j.ok) throw new Error(j?.error || "ping error");
    setRemote(true, j?.status || "conectado");
  }catch(e){
    setRemote(false, "sin conexión");
  }
}

async function guardar(){
  const p = getPayload();
  const err = validatePayload(p);
  if(err){
    setStatus(err, "err");
    return;
  }

  const btn = document.getElementById("btnGuardar");
  if(btn) btn.disabled = true;

  setStatus("Guardando...", "info");
  try{
    // Guardar por JSONP (GET) => evita CORS e iframe bloqueado
    const j = await jsonpRequest({
      action: "save",
      payload: JSON.stringify(p)
    });

    if(!j || !j.ok) throw new Error(j?.error || "No se pudo guardar");
    setStatus("Guardado ✅", "ok");
  }catch(e){
    setStatus("Error al guardar: " + (e.message || e), "err");
  }finally{
    if(btn) btn.disabled = false;
  }
}

async function cargarOpcionesFiltro(groupBy, selectEl){
  selectEl.innerHTML = `<option value="">Cargando...</option>`;
  try{
    const j = await jsonpRequest({ action:"unique", groupBy });
    if(!j.ok) throw new Error(j.error || "No se pudo cargar variables");
    const values = j.values || [];
    selectEl.innerHTML =
      `<option value="">Selecciona...</option>` +
      values.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
  }catch(e){
    selectEl.innerHTML = `<option value="">(error)</option>`;
  }
}

let chart;
async function cargarResultados(){
  $("noDataMsg").style.display = "block";
  $("tableWrap").innerHTML = `<div class="muted">Cargando...</div>`;

  const groupBy = $("groupBy").value;
  const groupValue = $("groupValue").disabled ? "" : ($("groupValue").value || "");

  try{
    const j = await jsonpRequest({ action:"results", groupBy, groupValue });
    if(!j.ok) throw new Error(j.error || "No se pudo cargar resultados");
    renderResults(j.data);
  }catch(e){
    $("kpiN").textContent = "0";
    $("kpiAvg").textContent = "—";
    $("kpiLast").textContent = "—";
    $("tableWrap").innerHTML = `<div class="muted">Error: ${escapeHtml(e.message || e)}</div>`;
    destroyChart();
  }
}

async function cargarResumen(){
  const groupBy = $("sumGroupBy").value;
  const groupValue = $("sumGroupValue").disabled ? "" : ($("sumGroupValue").value || "");

  $("summaryBox").innerHTML = `<div class="muted">Cargando...</div>`;
  try{
    const j = await jsonpRequest({ action:"results", groupBy, groupValue });
    if(!j.ok) throw new Error(j.error || "No se pudo cargar resumen");
    renderSummary(j.data, groupBy, groupValue);
  }catch(e){
    $("summaryBox").innerHTML = `<div class="muted">Error: ${escapeHtml(e.message || e)}</div>`;
  }
}

    function renderResults(data){
      const n = data.n || 0;
      const last = data.lastTimestamp || "";
      const items = data.items || []; // [{id,label,percent,sum,count}]
      const avg = data.avgPercent || null;

      $("kpiN").textContent = String(n);
      $("kpiLast").textContent = last ? last : "—";
      $("kpiAvg").textContent = (avg==null ? "—" : (avg + "%"));

      if(n<=0 || items.length===0){
        $("noDataMsg").style.display = "block";
        $("tableWrap").innerHTML = `<div class="muted">Aún no hay datos para mostrar.</div>`;
        destroyChart();
        return;
      }

      $("noDataMsg").style.display = "none";

      const labels = items.map(x=>`Ítem ${x.id}`);
      const values = items.map(x=>x.percent);

      renderChart(labels, values);

      // tabla
      const rows = items.map(x=>`
        <tr>
          <td><b>${x.id}</b></td>
          <td>${escapeHtml(x.label || "")}</td>
          <td><b>${x.percent}%</b></td>
          <td class="muted">${x.count}</td>
        </tr>
      `).join("");

      $("tableWrap").innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Ítem</th>
              <th>Descripción</th>
              <th>%</th>
              <th>#Resp</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function renderSummary(data, groupBy, groupValue){
      const n = data.n || 0;
      const items = (data.items || []).slice();
      if(n<=0 || items.length===0){
        $("summaryBox").innerHTML = `<div class="muted">No hay datos para el filtro seleccionado.</div>`;
        return;
      }

      items.sort((a,b)=>b.percent-a.percent);
      const top = items.slice(0,3);
      const bottom = items.slice(-3).reverse();

      const title = (groupBy==="General")
        ? "General"
        : `${pretty(groupBy)} = ${groupValue || "(sin seleccionar)"}`;

      $("summaryBox").innerHTML = `
        <div style="font-weight:900; font-size:16px; margin-bottom:8px;">Resumen (${escapeHtml(title)})</div>
        <div class="muted" style="margin-bottom:12px;">Encuestas consideradas: <b style="color:var(--text)">${n}</b></div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="kpi">
            <div class="k">Top 3 ítems</div>
            <div class="s" style="margin-top:10px;">
              ${top.map(x=>`<div>• <b>${x.percent}%</b> — Ítem ${x.id}: ${escapeHtml(x.label||"")}</div>`).join("")}
            </div>
          </div>

          <div class="kpi">
            <div class="k">Bottom 3 ítems</div>
            <div class="s" style="margin-top:10px;">
              ${bottom.map(x=>`<div>• <b>${x.percent}%</b> — Ítem ${x.id}: ${escapeHtml(x.label||"")}</div>`).join("")}
            </div>
          </div>
        </div>
      `;
    }

    function renderChart(labels, values){
      const ctx = $("chartItems").getContext("2d");
      destroyChart();

      // plugin: escribir valor encima de cada barra
      const valueLabelPlugin = {
        id: 'valueLabelPlugin',
        afterDatasetsDraw(chart){
          const {ctx} = chart;
          ctx.save();
          ctx.font = "bold 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.fillStyle = "#e8eefc";
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";

          chart.data.datasets.forEach((dataset, i)=>{
            const meta = chart.getDatasetMeta(i);
            meta.data.forEach((bar, idx)=>{
              const val = dataset.data[idx];
              const x = bar.x;
              const y = bar.y - 6;
              ctx.fillText(String(val) + "%", x, y);
            });
          });

          ctx.restore();
        }
      };

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "% por ítem",
            data: values,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 0,
              max: 100,
              ticks: { callback: (v)=> v + "%" }
            }
          },
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks:{
                label: (ctx)=> `${ctx.raw}%`
              }
            }
          }
        },
        plugins:[valueLabelPlugin]
      });
    }

    function destroyChart(){
      if(chart){ chart.destroy(); chart = null; }
    }

    /***********************
     * UTILS
     ***********************/
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function pretty(k){
      const map = {Genero:"Género", Antiguedad:"Antigüedad", Localidad:"Localidad", Departamento:"Departamento", Nivel:"Nivel"};
      return map[k] || k;
    }

    /***********************
     * INIT
     ***********************/
    buildDemographics();
    buildItems();
    initFilters();
    ping();
  </script>
</body>
</html>
