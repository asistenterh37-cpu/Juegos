<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rompecabezas Deslizante</title>
  <style>
    :root{
      --bg:#0b0f14;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:#233049;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --radius: 18px;

      /* Ajustables por JS seg√∫n tama√±o */
      --board-gap: 10px;
      --board-pad: 10px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 500px at 20% 10%, rgba(34,197,94,.18), transparent 55%),
                  radial-gradient(800px 500px at 80% 15%, rgba(245,158,11,.16), transparent 55%),
                  var(--bg);
      color: var(--text);
      overflow:hidden; /* una sola pantalla */
    }
    .app{
      height: 100svh;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      max-width: 1100px;
      margin: 0 auto;
      min-height: 0;
    }

    header{
      background: rgba(18,24,38,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex: 0 0 auto;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 240px;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .title small{ color: var(--muted); }
    .byline{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--text);
      background: rgba(11,15,20,.35);
      display:flex;
      gap:8px;
      align-items:center;
      font-size: 13px;
      white-space:nowrap;
    }
    .pill b{ font-variant-numeric: tabular-nums; }

    main{
      flex: 1 1 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      min-height: 0;
    }
    .panel{
      background: rgba(18,24,38,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 0;
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      flex: 0 0 auto;
    }
    .leftControls, .rightControls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    select, button{
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(11,15,20,.35);
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    select{ padding-right: 34px; }

    button.primary{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.14);
    }
    button.warn{
      border-color: rgba(245,158,11,.45);
      background: rgba(245,158,11,.14);
    }
    button.bad{
      border-color: rgba(239,68,68,.45);
      background: rgba(239,68,68,.12);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .hint{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      flex: 0 0 auto;
    }

    .boardWrap{
      flex: 1 1 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      min-height: 0;
    }

    /* ‚úÖ Tablero: tama√±o final lo calcula JS para que SIEMPRE quepa completo */
    .board{
      width: 300px;
      height: 300px;
      aspect-ratio: 1 / 1;
      background: rgba(11,15,20,.35);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: var(--board-pad);
      display:grid;
      gap: var(--board-gap);
      touch-action: manipulation;
    }

    .tile{
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.25);
      background: linear-gradient(180deg, rgba(229,231,235,.10), rgba(229,231,235,.03));
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      font-weight: 700;
      font-size: clamp(14px, 3.0vw, 26px);
      font-variant-numeric: tabular-nums;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .tile:hover{ border-color: rgba(229,231,235,.35); }
    .tile:active{ transform: scale(.98); }
    .tile.empty{
      background: transparent;
      border: 1px dashed rgba(148,163,184,.18);
      box-shadow:none;
    }

    .footer{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      flex: 0 0 auto;
    }
    .status{
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badge{
      border:1px solid var(--line);
      border-radius:999px;
      padding: 5px 9px;
      font-size: 12px;
      background: rgba(11,15,20,.35);
      color: var(--text);
    }
    .badge.ok{ border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.10); }
    .badge.warn{ border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.10); }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>üß© Rompecabezas Deslizante</h1>
        <small>Interactivo ‚Ä¢ 3√ó3 hasta 6√ó6 ‚Ä¢ listo para GitHub Pages</small>
        <div class="byline">Por: <b>Soamy Lanza</b></div>
      </div>
      <div class="stats">
        <div class="pill">‚è±Ô∏è Tiempo: <b id="time">00:00.0</b></div>
        <div class="pill">üë£ Movimientos: <b id="moves">0</b></div>
        <div class="pill">üìè Tama√±o: <b id="sizeLabel">4√ó4</b></div>
      </div>
    </header>

    <main>
      <section class="panel">
        <div class="controls">
          <div class="leftControls">
            <label>
              <select id="sizeSelect" aria-label="Tama√±o del tablero">
                <option value="3">3√ó3</option>
                <option value="4" selected>4√ó4</option>
                <option value="5">5√ó5</option>
                <option value="6">6√ó6</option>
              </select>
            </label>

            <button class="primary" id="newBtn">Nuevo</button>
            <button id="resetBtn" class="warn" disabled>Reiniciar</button>
            <button id="clearBtn" class="bad">Limpiar</button>
          </div>

          <div class="rightControls">
            <button id="solveBtn">Resolver</button>
            <button id="shareBtn">Compartir</button>
          </div>
        </div>

        <div class="hint">
          Tip: toca o haz clic en una ficha junto al espacio vac√≠o. En teclado: <b>WASD</b> o <b>flechas</b>.
        </div>

        <div class="boardWrap" id="boardWrap">
          <div class="board" id="board" role="grid" aria-label="Tablero del rompecabezas"></div>
        </div>

        <div class="footer">
          <div class="status" id="status">
            <span class="badge warn">En progreso</span>
            <span>‚Ä¢ Nuevo tablero generado. ¬°Dale!</span>
          </div>
          <div class="hint">
            Funciona en PC y m√≥vil ‚Ä¢ sin scroll ‚Ä¢ comparte el link por WhatsApp/redes.
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  // ---------- DOM ----------
  const boardEl = document.getElementById("board");
  const boardWrapEl = document.getElementById("boardWrap");
  const timeEl = document.getElementById("time");
  const movesEl = document.getElementById("moves");
  const sizeLabelEl = document.getElementById("sizeLabel");
  const statusEl = document.getElementById("status");

  const sizeSelect = document.getElementById("sizeSelect");
  const newBtn = document.getElementById("newBtn");
  const resetBtn = document.getElementById("resetBtn");
  const clearBtn = document.getElementById("clearBtn");
  const solveBtn = document.getElementById("solveBtn");
  const shareBtn = document.getElementById("shareBtn");

  // ---------- Estado ----------
  let N = 4;
  let tiles = [];        // 0 = vac√≠o
  let emptyIndex = 0;
  let moves = 0;

  // Guardamos "posiciones del vac√≠o" para poder deshacer 100% seguro:
  // - scrambleEmpties: [z0, z1, z2, ...] desde resuelto hasta estado inicial
  // - userEmpties:    [z_beforeMove1, z_beforeMove2, ...]
  let scrambleEmpties = [];
  let userEmpties = [];

  let initialTiles = [];

  // Timer
  let timerId = null;
  let startTime = 0;
  let elapsedMs = 0;
  let running = false;

  let solving = false;

  // ---------- Helpers ----------
  const fmtTime = (ms) => {
    const total = Math.max(0, ms);
    const minutes = Math.floor(total / 60000);
    const seconds = Math.floor((total % 60000) / 1000);
    const tenths  = Math.floor((total % 1000) / 100);
    return `${String(minutes).padStart(2,"0")}:${String(seconds).padStart(2,"0")}.${tenths}`;
  };

  const setStatus = (type, text) => {
    const cls = type === "ok" ? "badge ok" : "badge warn";
    const label = type === "ok" ? "¬°Resuelto!" : "En progreso";
    statusEl.innerHTML = `<span class="${cls}">${label}</span><span>${text}</span>`;
  };

  const indexToRC = (i) => ({ r: Math.floor(i / N), c: i % N });
  const rcToIndex = (r,c) => r * N + c;

  const isAdjacent = (a, b) => {
    const A = indexToRC(a), B = indexToRC(b);
    return (Math.abs(A.r - B.r) + Math.abs(A.c - B.c)) === 1;
  };

  const isSolved = (arr) => {
    for (let i=0; i<N*N-1; i++){
      if (arr[i] !== i+1) return false;
    }
    return arr[N*N-1] === 0;
  };

  const swap = (a, b) => {
    [tiles[a], tiles[b]] = [tiles[b], tiles[a]];
    if (tiles[a] === 0) emptyIndex = a;
    if (tiles[b] === 0) emptyIndex = b;
  };

  // Ajusta gap/padding seg√∫n N para que 6x6 quepa bonito
  const applyBoardDensity = () => {
    // M√°s grande N => menos espacio
    const gapMap = {3: 12, 4: 10, 5: 8, 6: 6};
    const padMap = {3: 12, 4: 10, 5: 9, 6: 8};
    document.documentElement.style.setProperty("--board-gap", (gapMap[N] ?? 10) + "px");
    document.documentElement.style.setProperty("--board-pad", (padMap[N] ?? 10) + "px");

    // Un pel√≠n m√°s peque√±a la tipograf√≠a en 6x6
    boardEl.style.setProperty("font-size", N >= 6 ? "12px" : "14px");
  };

  // ‚úÖ Ajuste ‚Äúque quepa completo‚Äù usando el espacio REAL del contenedor
  const fitBoard = () => {
    const wrapRect = boardWrapEl.getBoundingClientRect();
    const pad = 8; // margen de seguridad
    const size = Math.floor(Math.min(wrapRect.width, wrapRect.height) - pad);

    // l√≠mites razonables (evita que explote o quede mini)
    const finalSize = Math.max(240, Math.min(size, 620));

    boardEl.style.width = finalSize + "px";
    boardEl.style.height = finalSize + "px";
  };

  // ---------- Render ----------
  const render = () => {
    applyBoardDensity();
    fitBoard();

    boardEl.style.gridTemplateColumns = `repeat(${N}, 1fr)`;
    boardEl.style.gridTemplateRows = `repeat(${N}, 1fr)`;
    boardEl.innerHTML = "";

    for (let i=0; i<tiles.length; i++){
      const v = tiles[i];
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "tile" + (v === 0 ? " empty" : "");
      btn.setAttribute("role", "gridcell");
      btn.setAttribute("aria-label", v === 0 ? "Vac√≠o" : `Ficha ${v}`);
      btn.dataset.index = String(i);
      btn.textContent = v === 0 ? "" : String(v);
      btn.disabled = solving;
      boardEl.appendChild(btn);
    }

    movesEl.textContent = String(moves);
    sizeLabelEl.textContent = `${N}√ó${N}`;

    if (isSolved(tiles)) {
      stopTimer();
      setStatus("ok", "Nivel completado. Comparte tu tiempo üòÑ");
    } else {
      setStatus("warn", "Toca una ficha junto al vac√≠o para moverla.");
    }

    resetBtn.disabled = initialTiles.length === 0 || solving;
    // ‚úÖ Resolver habilitado si NO est√° resuelto y no est√° resolviendo
    solveBtn.disabled = isSolved(tiles) || solving;

    newBtn.disabled = solving;
    clearBtn.disabled = solving;
    sizeSelect.disabled = solving;
  };

  // ---------- Timer ----------
  const startTimer = () => {
    running = true;
    startTime = performance.now() - elapsedMs;
    if (timerId) clearInterval(timerId);
    timerId = setInterval(() => {
      elapsedMs = performance.now() - startTime;
      timeEl.textContent = fmtTime(elapsedMs);
    }, 100);
  };

  const stopTimer = () => {
    running = false;
    if (timerId){
      clearInterval(timerId);
      timerId = null;
    }
  };

  const resetTimer = () => {
    stopTimer();
    elapsedMs = 0;
    timeEl.textContent = fmtTime(elapsedMs);
  };

  // ---------- Movimientos ----------
  const doMoveIndex = (tileIndex, {recordUser=true} = {}) => {
    if (!isAdjacent(tileIndex, emptyIndex)) return false;

    const oldEmpty = emptyIndex; // guardamos vac√≠o ANTES del swap
    swap(tileIndex, emptyIndex);
    moves++;

    if (recordUser) userEmpties.push(oldEmpty);

    if (!running) startTimer();
    render();
    return true;
  };

  const moveEmpty = (dr, dc) => {
    const {r,c} = indexToRC(emptyIndex);
    const nr = r + dr, nc = c + dc;
    if (nr < 0 || nr >= N || nc < 0 || nc >= N) return false;
    const neighbor = rcToIndex(nr, nc);
    return doMoveIndex(neighbor);
  };

  // ---------- Generaci√≥n del tablero (scramble seguro) ----------
  const generateScramble = (k) => {
    // partimos de resuelto
    const arr = [];
    for (let i=1; i<N*N; i++) arr.push(i);
    arr.push(0);

    let z = arr.indexOf(0);
    const empties = [z]; // z0

    const neighbors = (idx) => {
      const {r,c} = indexToRC(idx);
      const ns = [];
      if (r>0) ns.push(rcToIndex(r-1,c));
      if (r<N-1) ns.push(rcToIndex(r+1,c));
      if (c>0) ns.push(rcToIndex(r,c-1));
      if (c<N-1) ns.push(rcToIndex(r,c+1));
      return ns;
    };

    let prev = -1;
    for (let t=0; t<k; t++){
      const ns = neighbors(z).filter(x => x !== prev);
      const pick = ns[Math.floor(Math.random()*ns.length)];
      // swap en el arreglo local arr
      [arr[pick], arr[z]] = [arr[z], arr[pick]];
      prev = z;
      z = pick;
      empties.push(z); // z1, z2...
    }

    return {arr, empties};
  };

  // ---------- Acciones ----------
  const setBoard = (arr, {saveInitial=false, setScrambleEmpties=null} = {}) => {
    tiles = arr.slice();
    emptyIndex = tiles.indexOf(0);

    moves = 0;
    userEmpties = [];
    resetTimer();

    if (saveInitial) initialTiles = tiles.slice();
    if (Array.isArray(setScrambleEmpties)) scrambleEmpties = setScrambleEmpties.slice();

    render();
  };

  const newGame = () => {
    // m√°s grande N => m√°s scramble
    const k = Math.max(100, N*N*N + 60);
    const {arr, empties} = generateScramble(k);

    setBoard(arr, {saveInitial:true, setScrambleEmpties: empties});
    setStatus("warn", "Nuevo tablero generado. ¬°Dale!");
  };

  const resetGame = () => {
    if (!initialTiles.length) return;
    // resetea al estado inicial (mismo scramble)
    setBoard(initialTiles, {saveInitial:true});
    setStatus("warn", "Reiniciado al estado inicial.");
  };

  const clearGame = () => {
    const arr = [];
    for (let i=1; i<N*N; i++) arr.push(i);
    arr.push(0);

    scrambleEmpties = [];
    setBoard(arr, {saveInitial:true});
    setStatus("ok", "Tablero resuelto (limpio).");
  };

  // ‚úÖ Resolver real: deshace user + deshace scramble
  // Usamos ‚Äúvac√≠os previos‚Äù -> siempre adyacentes, cero bugs.
  const solveAnimated = async () => {
    if (solving) return;
    if (isSolved(tiles)) return;

    solving = true;
    stopTimer();

    // 1) Deshacer movimientos del usuario: para cada oldEmpty en reversa, swap(empty, oldEmpty)
    const undoUser = userEmpties.slice().reverse();

    // 2) Deshacer scramble: empties = [z0..zk]. estado inicial tiene vac√≠o = zk
    // Para volver a resuelto: swap(zk, z{k-1}), luego swap(z{k-1}, z{k-2})...
    const undoScramble = [];
    if (scrambleEmpties && scrambleEmpties.length >= 2) {
      for (let i = scrambleEmpties.length - 1; i >= 1; i--) {
        undoScramble.push(scrambleEmpties[i - 1]);
      }
    }

    const steps = [...undoUser, ...undoScramble];
    const delay = steps.length > 200 ? 6 : 14;

    for (const targetOldEmpty of steps) {
      // Siempre adyacente si la historia est√° bien, pero por seguridad:
      if (!isAdjacent(emptyIndex, targetOldEmpty)) {
        // si algo raro pasa, nos salimos sin romper
        break;
      }
      swap(emptyIndex, targetOldEmpty);
      render();
      await new Promise(r => setTimeout(r, delay));
    }

    // final: dejamos todo limpio
    userEmpties = [];
    moves = 0;
    resetTimer();

    solving = false;
    render();
  };

  const share = async () => {
    const url = location.href;
    const text = `üß© Rompecabezas deslizante ${N}√ó${N} ‚Äî Por: Soamy Lanza. ¬øLo resuelves?`;
    try{
      if (navigator.share){
        await navigator.share({ title: document.title, text, url });
      } else {
        await navigator.clipboard.writeText(url);
        alert("Link copiado ‚úÖ\nP√©galo en WhatsApp o redes.");
      }
    } catch {
      try{
        await navigator.clipboard.writeText(url);
        alert("Link copiado ‚úÖ");
      } catch {
        prompt("Copia este link:", url);
      }
    }
  };

  // ---------- Eventos ----------
  boardEl.addEventListener("click", (e) => {
    const t = e.target.closest(".tile");
    if (!t || solving) return;
    const idx = Number(t.dataset.index);
    if (Number.isNaN(idx)) return;
    if (tiles[idx] === 0) return;
    doMoveIndex(idx);
  });

  window.addEventListener("keydown", (e) => {
    if (solving) return;
    const k = e.key.toLowerCase();
    const handled = ["arrowup","arrowdown","arrowleft","arrowright","w","a","s","d"].includes(k);
    if (!handled) return;
    e.preventDefault();

    if (k === "arrowup" || k === "w") moveEmpty(-1, 0);
    if (k === "arrowdown" || k === "s") moveEmpty( 1, 0);
    if (k === "arrowleft" || k === "a") moveEmpty( 0,-1);
    if (k === "arrowright" || k === "d") moveEmpty( 0, 1);
  }, {passive:false});

  sizeSelect.addEventListener("change", () => {
    N = Number(sizeSelect.value);
    clearGame();
    newGame();
  });

  newBtn.addEventListener("click", newGame);
  resetBtn.addEventListener("click", resetGame);
  clearBtn.addEventListener("click", clearGame);
  solveBtn.addEventListener("click", solveAnimated);
  shareBtn.addEventListener("click", share);

  // Recalcular tablero si cambia tama√±o de ventana
  window.addEventListener("resize", () => {
    fitBoard();
  });

  // ---------- Init ----------
  clearGame();
  newGame();
})();
</script>
</body>
</html>
