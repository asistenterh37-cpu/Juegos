<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Evaluaci√≥n del Desempe√±o</title>
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#121f3d;
      --text:#e8eefc; --muted:#a9b7d9; --line:rgba(255,255,255,.10);
      --accent:#4f7cff; --accent2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1a2a52; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius2: 22px; --mono: ui-monospace, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--sans);color:var(--text);min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(79,124,255,.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
        var(--bg);
    }
    header{
      position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
      background:rgba(11,18,32,.75);border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:16px 18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{
      width:34px;height:34px;border-radius:12px;display:grid;place-items:center;
      background:rgba(79,124,255,.18);border:1px solid rgba(79,124,255,.25);font-weight:800;
    }
    .sub{color:var(--muted);font-size:13px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:rgba(26,42,82,.75);border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)
    }
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    select,button,input,textarea{
      background:var(--panel);
      border:1.5px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-family:var(--sans);
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, transform .05s ease;
    }
    select{min-width:220px}
    textarea{width:100%;min-height:92px;resize:vertical}
    input{width:100%}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(79,124,255,.55);
      box-shadow: 0 0 0 3px rgba(79,124,255,.18);
    }
    button{cursor:pointer}
    .btn-ok{
      background:linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.10));
      border-color:rgba(34,197,94,.35)
    }
    .btn-blue{
      background:linear-gradient(180deg, rgba(79,124,255,.25), rgba(79,124,255,.10));
      border-color:rgba(79,124,255,.35)
    }
    .btn-ghost{background:transparent}
    .btn-warn{
      background:linear-gradient(180deg, rgba(245,158,11,.20), rgba(245,158,11,.08));
      border-color:rgba(245,158,11,.35)
    }
    button[disabled]{opacity:.45; filter:saturate(.6); cursor:not-allowed;}

    main{padding:18px}
    .grid{max-width:1180px;margin:0 auto;display:grid;gap:14px}
    .card{
      background:linear-gradient(180deg, rgba(18,31,61,.9), rgba(15,27,51,.92));
      border:1px solid var(--line);border-radius:var(--radius2);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .card-h{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center
    }
    .card-h h2{margin:0;font-size:16px}
    .card-b{padding:14px 16px}
    .status{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:12px;color:var(--muted)}
    .status .s-dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .status.ok .s-dot{background:var(--accent2)}
    .status.err .s-dot{background:var(--danger)}
    .hint{
      background:rgba(79,124,255,.10);
      border:1px dashed rgba(79,124,255,.35);
      padding:10px 12px;border-radius:14px;color:var(--muted);font-size:13px
    }
    .form-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}

    .lbl{
      font-size:12px;
      color:rgba(232,238,252,.92);
      margin-bottom:6px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    .field.boxed{
      border:1.5px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(11,18,32,.28), rgba(15,27,51,.18));
      border-radius:18px;
      padding:12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.18);
    }
    .field.boxed .lbl{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;border-radius:14px;
      background:rgba(79,124,255,.10);
      border:1px solid rgba(79,124,255,.22);
      text-transform:uppercase; letter-spacing:.08em;
      font-size:11px; color:rgba(232,238,252,.95);
    }
    .field.boxed textarea, .field.boxed input, .field.boxed select{
      background:rgba(15,27,51,.88);
      border-color:rgba(255,255,255,.16);
      border-width:1.5px;
      border-style:solid;
      border-radius:14px;
    }

    [data-phase-block]{display:none}
    [data-phase-block].show{display:block}
    .nivelWrap{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nivelWrap.hide{display:none}

    /* CUESTIONARIO */
    .factor{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      margin-bottom:14px;
      background:linear-gradient(180deg, rgba(11,18,32,.25), rgba(15,27,51,.10));
    }
    .factor-title{
      padding:14px 16px;
      font-weight:800;
      font-size:18px;
      letter-spacing:.2px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }
    .item-row{
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:center;
      padding:16px;
      border-top:1px solid rgba(255,255,255,.07);
    }
    .item-row:first-of-type{border-top:none}
    .item-left{flex:1; min-width:280px}
    .item-name{font-weight:750; font-size:15px; margin:0;}
    .item-sub{color:var(--muted); font-size:12px; margin-top:4px;}
    .item-right{min-width:420px; max-width:520px; width:44%}
    .item-right .lbl{margin-bottom:8px}
    .item-right select{width:100%}

    .sr-hidden{
      position:absolute !important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
    @media (max-width:860px){
      .col-3,.col-4,.col-6{grid-column:span 12}
      select{min-width:180px}
      .item-row{flex-direction:column; align-items:stretch}
      .item-right{min-width:100%; width:100%}
    }
  </style>
</head>

<body>
  <input id="webappUrl" class="sr-hidden" aria-hidden="true" tabindex="-1" />

  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo">ED</div>
          <div>
            Proceso de evaluaci√≥n del desempe√±o
            <div class="chips">
              <span class="chip">Empresa: <b id="chipEmpresa">No Implementado</b></span>
              <span class="chip">Versi√≥n: <b id="chipVersion">Prueba</b></span>
            </div>
          </div>
        </div>

        <div class="controls">
          <span id="apiStatus" class="status">
            <span class="s-dot"></span>
            <span id="apiStatusText">API: sin probar</span>
          </span>
          <button id="btnProbarApi" class="btn-ghost">Probar API</button>
          <button id="btnAbrirPing" class="btn-ghost">Abrir Ping</button>
          <button id="btnLimpiarEval" class="btn-warn" style="display:none">Limpiar</button>
          <button id="btnGuardar" class="btn-ok" disabled>Guardar</button>
          <button id="btnNuevo" class="btn-blue">Nuevo</button>
          <button id="btnPrint" class="btn-ghost">Imprimir / Enviar a PDF</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">

      <!-- FASE + NIVEL -->
      <section class="card" id="blockFaseNivel">
        <div class="card-h">
          <div class="controls" style="width:100%; justify-content:space-between">
            <div class="controls" style="gap:10px">
              <select id="faseSelect">
                <option value="">Seleccione fase</option>
                <option value="FORMULARIOS">Formularios</option>
                <option value="PESOS">Pesos</option>
                <option value="AUTO">Formulario de autoevaluaci√≥n</option>
                <option value="CLIENTES">Formulario de evaluaci√≥n de clientes</option>
                <option value="DESEMPENO">Formulario de evaluaci√≥n del desempe√±o</option>
                <option value="RESULTADO">Resultado evaluaci√≥n del desempe√±o</option>
                <option value="CONSOLIDADO">Informe consolidado</option>
                <option value="CAPACITACION">Informe necesidades de capacitacion</option>
                <option value="DESARROLLO">Informe plan de desarrollo</option>
              </select>

              <span class="nivelWrap" id="nivelWrap">
                <select id="nivelSelect" disabled>
                  <option>Cargando niveles‚Ä¶</option>
                </select>
              </span>
            </div>

            <div class="sub" id="faseHelp" style="max-width:520px; text-align:right">
              Selecciona una fase para desplegar el formulario.
            </div>
          </div>
        </div>
      </section>

      <!-- CLIENTES -->
      <section class="card" data-phase-block="CLIENTES" id="blockClientes">
        <div class="card-h">
          <div>
            <h2>Formulario de evaluaci√≥n de clientes</h2>
            <div class="sub">Completa todos los campos. Guardar se habilita hasta que todo est√© lleno.</div>
          </div>
          <div class="chips">
            <span class="chip mono">Hoja destino: <b>Clientes</b></span>
          </div>
        </div>

        <div class="card-b">
          <div class="hint" style="margin-bottom:12px">
            Nota: En esta fase no existe ‚ÄúNivel‚Äù. Solo se tabulan los campos del formulario en la hoja <b>Clientes</b>.
          </div>

          <div class="form-grid">
            <div class="field col-3 boxed"><div class="lbl">No. de personal</div><input id="noPersonal" placeholder="Ej: 1600" /></div>
            <div class="field col-6 boxed"><div class="lbl">Nombre</div><input id="nombre" placeholder="Ej: Carlos Paz" /></div>
            <div class="field col-3 boxed"><div class="lbl">Posici√≥n</div><input id="posicion" placeholder="Ej: Analista" /></div>

            <div class="field col-4 boxed"><div class="lbl">Departamento</div><input id="depto" placeholder="Ej: Contabilidad" /></div>
            <div class="field col-4 boxed"><div class="lbl">Periodo</div><input id="periodo" placeholder="Ej: 2025" /></div>
            <div class="field col-2 boxed"><div class="lbl">Versi√≥n</div><input id="version" placeholder="Ej: 1" /></div>
            <div class="field col-2 boxed"><div class="lbl">Fecha</div><input id="fecha" /></div>

            <div class="field col-12 boxed"><div class="lbl">Comenzar a hacer</div><textarea id="comenzarHacer" placeholder="¬øQu√© deber√≠a comenzar a hacer?"></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Parar de hacer</div><textarea id="pararHacer" placeholder="¬øQu√© deber√≠a parar de hacer?"></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Continuar haciendo</div><textarea id="continuarHacer" placeholder="¬øQu√© deber√≠a continuar haciendo?"></textarea></div>

            <div class="field col-6 boxed"><div class="lbl">Nombre del evaluador</div><input id="nombreEvaluador" placeholder="Ej: Ana L√≥pez" /></div>
          </div>

          <div class="sub" style="margin-top:10px">Estado API: <b id="apiMini">‚Äî</b></div>
        </div>
      </section>

      <!-- EVAL (AUTO / DESEMPENO) -->
      <section class="card" data-phase-block="EVAL" id="blockDatos">
        <div class="card-h">
          <div>
            <h2>Datos del colaborador</h2>
            <div class="sub">Completa la informaci√≥n y selecciona una opci√≥n (1‚Äì5) para cada √≠tem.</div>
          </div>
        </div>
        <div class="card-b">
          <div class="form-grid">
            <div class="field col-3 boxed"><div class="lbl">No. de personal</div><input id="noPersonalEval" placeholder="Ej: 1600" /></div>
            <div class="field col-6 boxed"><div class="lbl">Nombre</div><input id="nombreEval" placeholder="Ej: Carlos Paz" /></div>
            <div class="field col-3 boxed"><div class="lbl">Posici√≥n</div><input id="posicionEval" placeholder="Ej: Analista" /></div>

            <div class="field col-4 boxed"><div class="lbl">Departamento</div><input id="deptoEval" placeholder="Ej: Contabilidad" /></div>
            <div class="field col-4 boxed"><div class="lbl">Periodo</div><input id="periodoEval" placeholder="Ej: 2025" /></div>
            <div class="field col-2 boxed"><div class="lbl">Versi√≥n</div><input id="versionEval" placeholder="Ej: 1" /></div>
            <div class="field col-2 boxed"><div class="lbl">Fecha</div><input id="fechaEval" /></div>
          </div>

          <div class="sub" style="margin-top:10px">Estado API: <b id="apiMiniEval">‚Äî</b></div>
        </div>
      </section>

      <section class="card" data-phase-block="EVAL" id="blockEval">
        <div class="card-h">
          <div>
            <h2>Evaluaci√≥n (1‚Äì5)</h2>
            <div class="sub">Cada nivel muestra ‚Äún√∫mero ‚Äî descripci√≥n‚Äù seg√∫n la r√∫brica.</div>
          </div>
          <div class="chips">
            <span class="chip" id="itemsCount">Items: 0</span>
            <span class="chip" id="completeHint">Completado: 0/0</span>
          </div>
        </div>
        <div class="card-b">
          <div id="cuestionario"></div>
        </div>
      </section>

      <!-- AUTO: Comentarios -->
      <section class="card" data-phase-block="AUTO" id="blockAutoComentarios">
        <div class="card-h">
          <div>
            <h2>Comentarios del colaborador</h2>
            <div class="sub">Aplica solo en: <b>Autoevaluaci√≥n</b>.</div>
          </div>
          <div class="chips"><span class="chip mono">Campo cualitativo</span></div>
        </div>
        <div class="card-b">
          <div class="form-grid">
            <div class="field col-12 boxed">
              <div class="lbl">Comentarios del colaborador</div>
              <textarea id="comentariosColaboradorAuto" placeholder="Comentarios del colaborador..."></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- DESEMPENO: campos extra (se mantienen igual) -->
      <section class="card" data-phase-block="DESEMPENO" id="blockDesempenoExtra">
        <div class="card-h">
          <div>
            <h2>Comentarios y desarrollo</h2>
            <div class="sub">Completa los campos cualitativos de la evaluaci√≥n del desempe√±o.</div>
          </div>
          <div class="chips"><span class="chip mono">Aplica solo en: <b>Evaluaci√≥n del desempe√±o</b></span></div>
        </div>
        <div class="card-b">
          <div class="hint" style="margin-bottom:12px">
            Aqu√≠ va lo que normalmente RRHH usa para ‚Äúentender el cuento‚Äù (pero sin spoilers innecesarios üòÑ)
          </div>

          <div class="form-grid">
            <div class="field col-12 boxed"><div class="lbl">Justificaci√≥n y comentarios</div><textarea id="justificacion" placeholder="Describe evidencias / ejemplos / contexto..."></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Comentarios del colaborador</div><textarea id="comentariosColaborador" placeholder="Comentarios del colaborador..."></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Evaluaci√≥n de clientes</div><textarea id="evaluacionClientesDes" placeholder="Resumen / hallazgos..."></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Fortalezas</div><textarea id="fortalezas" placeholder="Fortalezas observadas..."></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Oportunidades de mejora</div><textarea id="oportunidadesMejora" placeholder="Oportunidades de mejora..."></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Proyecci√≥n y potencial de desarrollo</div><textarea id="proyeccionPotencial" placeholder="Proyecci√≥n / potencial..."></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Necesidades de capacitaci√≥n</div><textarea id="necesidadesCapacitacion" placeholder="Necesidades de capacitaci√≥n..."></textarea></div>
            <div class="field col-12 boxed"><div class="lbl">Comentarios del evaluador</div><textarea id="comentariosEvaluadorDes" placeholder="Comentarios del evaluador..."></textarea></div>
            <div class="field col-6 boxed"><div class="lbl">Nombre del evaluador</div><input id="nombreEvaluadorDes" placeholder="Ej: Ana L√≥pez" /></div>
          </div>
        </div>
      </section>

      <!-- OTRAS VISTAS (placeholder) -->
      <section class="card" data-phase-block="RESULTADO"><div class="card-h"><h2>Resultado evaluaci√≥n del desempe√±o</h2><div class="sub">Vista en construcci√≥n.</div></div><div class="card-b"><div class="hint">Aqu√≠ ir√° el resultado.</div></div></section>
      <section class="card" data-phase-block="CONSOLIDADO"><div class="card-h"><h2>Informe consolidado</h2><div class="sub">Vista en construcci√≥n.</div></div><div class="card-b"><div class="hint">Aqu√≠ ir√° el informe.</div></div></section>
      <section class="card" data-phase-block="CAPACITACION"><div class="card-h"><h2>Informe necesidades de capacitacion</h2><div class="sub">Vista en construcci√≥n.</div></div><div class="card-b"><div class="hint">Aqu√≠ ir√° el informe.</div></div></section>
      <section class="card" data-phase-block="DESARROLLO"><div class="card-h"><h2>Informe plan de desarrollo</h2><div class="sub">Vista en construcci√≥n.</div></div><div class="card-b"><div class="hint">Aqu√≠ ir√° el plan.</div></div></section>

    </div>
  </main>

  <script>
    /* ================= CONFIG ================= */
    const LS_KEY_URL = "ED_WEBAPP_URL";
    const DEFAULT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbysA8cPOvXZdHabpbEdVQLsTJll-qqnjybBhNJ2e0jTk-LosDYF1fbAr9IcwwK-hIUP/exec";
    const $ = id => document.getElementById(id);

    function normalizeWebAppUrl(raw){
      let v = String(raw || "").trim();
      if(!v) return DEFAULT_WEBAPP_URL;
      v = v.replace(/#.*$/, "");
      v = v.replace(/\s+/g, "");
      v = v.replace(/\/+$/, "");
      v = v.replace(/\/dev$/i, "/exec");
      if(/\/exec$/i.test(v)) return v;
      if(/script\.google\.com\/macros\/s\/[^/]+$/i.test(v)) return v + "/exec";
      const qm = v.indexOf("?");
      if(qm > -1){
        const base = v.slice(0, qm).replace(/\/+$/, "");
        const qs = v.slice(qm);
        if(/\/exec$/i.test(base)) return base + qs;
        if(/script\.google\.com\/macros\/s\/[^/]+$/i.test(base)) return base + "/exec" + qs;
      }
      return v;
    }
    function getWebAppUrl(){
      const v = normalizeWebAppUrl($("webappUrl").value);
      return v || DEFAULT_WEBAPP_URL;
    }
    function setWebAppUrl(v){
      $("webappUrl").value = normalizeWebAppUrl(v || "");
    }

    /* ================= STATE ================= */
    const state = { fase:"", nivel:null, form:null, answers:new Map(), itemKeys:[] };

    /* ================= STATUS ================= */
    function setApiStatus(mode,text){
      const el=$("apiStatus");
      el.classList.remove("ok","err");
      if(mode) el.classList.add(mode);
      $("apiStatusText").textContent=text;
      const miniClientes = $("apiMini");
      if (miniClientes) miniClientes.textContent = text.replace("API: ","");
      const miniEval = $("apiMiniEval");
      if (miniEval) miniEval.textContent = text.replace("API: ","");
    }

    /* ================= JSONP API ================= */
    function buildUrl(params, cbName){
      const base = getWebAppUrl();
      const url = new URL(base);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      url.searchParams.set("callback", cbName);
      url.searchParams.set("_", String(Date.now()));
      return url.toString();
    }
    function apiGet(params, timeoutMs=15000){
      return new Promise((resolve,reject)=>{
        const cb="cb_"+Math.random().toString(36).slice(2);
        const src = buildUrl(params, cb);
        setApiStatus("", "API: consultando‚Ä¶");
        const s=document.createElement("script");
        s.async = true;
        s.referrerPolicy = "no-referrer";
        let done=false;

        const t=setTimeout(()=>{
          if(done) return;
          done=true;
          cleanup();
          reject(new Error("Timeout. La WebApp no respondi√≥. Abre Ping para verificar el deploy."));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(t);
          try { delete window[cb]; } catch(_) { window[cb]=undefined; }
          if (s && s.parentNode) s.parentNode.removeChild(s);
        }

        window[cb]=data=>{
          if(done) return;
          done=true;
          cleanup();
          if(!data || typeof data !== "object"){
            reject(new Error("Respuesta inv√°lida. Si al abrir Ping te pide login, el deploy no es p√∫blico."));
            return;
          }
          if(data.ok!==true){
            reject(new Error(data.error || "Respuesta inv√°lida"));
            return;
          }
          setApiStatus("ok","API: conectada");
          resolve(data);
        };

        s.onerror=()=>{
          if(done) return;
          done=true;
          cleanup();
          reject(new Error("No se pudo cargar el script. Revisa: URL correcta (/exec), Deploy p√∫blico (Anyone), y desactiva bloqueadores para script.google.com."));
        };
        s.src = src;
        document.body.appendChild(s);
      });
    }

    /* ================= UTIL ================= */
    function todayLocal(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${dd}/${mm}/${yyyy}`;
    }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

    function fillNivelSelect(levels, includeAll=false){
      const sel = $("nivelSelect");
      sel.innerHTML = "";
      if(includeAll){
        const oAll = document.createElement("option");
        oAll.value = "ALL";
        oAll.textContent = "Todos";
        sel.appendChild(oAll);
      }
      levels.forEach(l=>{
        const v = String(l);
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v; // aqu√≠ viene "1 ‚Äî Operativo" si tu sheet lo trae as√≠
        sel.appendChild(o);
      });
    }
    function pickDefault(levels, includeAll){
      if(includeAll) return "ALL";
      const has1 = levels.some(x => String(x).trim() === "1" || String(x).trim().startsWith("1"));
      return has1 ? "1" : String(levels[0] ?? "1");
    }

    // ‚úÖ NIVEL: sacar (nivelNumerico) + (descripcionNivel) + (labelCompleta)
    function getNivelMeta(){
      const sel = $("nivelSelect");
      const opt = sel?.selectedOptions?.[0];
      const label = (opt?.textContent || String(sel.value || "")).trim(); // ej: "3 ‚Äî Supervisor"
      const value = String(sel.value || "").trim();

      // intenta extraer n√∫mero y descripci√≥n de "N ‚Äî Desc" o "N - Desc" o "N) Desc"
      let nivelNum = "";
      let nivelDesc = "";
      const m = label.match(/^\s*(\d+)\s*(?:[.)-]|‚Äî)\s*(.+)\s*$/);
      if(m){
        nivelNum = m[1];
        nivelDesc = m[2].trim();
      } else {
        // si solo viene "3" o "Nivel 3"
        const m2 = label.match(/(\d+)/);
        if(m2) nivelNum = String(Number(m2[1]));
        // desc queda vac√≠o
      }

      return {
        nivelValue: value,
        nivelLabel: label,
        nivelNumero: nivelNum,
        nivelDescripcion: nivelDesc
      };
    }

    /* ================= PHASE HELPERS ================= */
    function isEvalPhase(){ return state.fase === "AUTO" || state.fase === "DESEMPENO"; }
    function isClientesPhase(){ return state.fase === "CLIENTES"; }
    function isDesempenoPhase(){ return state.fase === "DESEMPENO"; }
    function isAutoPhase(){ return state.fase === "AUTO"; }

    /* ================= VALIDATION ================= */
    function getClientesRequiredFields(){
      return [
        $("noPersonal").value.trim(),
        $("nombre").value.trim(),
        $("posicion").value.trim(),
        $("depto").value.trim(),
        $("periodo").value.trim(),
        $("version").value.trim(),
        $("fecha").value.trim(),
        $("comenzarHacer").value.trim(),
        $("pararHacer").value.trim(),
        $("continuarHacer").value.trim(),
        $("nombreEvaluador").value.trim(),
      ];
    }
    function getEvalHeaderRequiredFields(){
      return [
        $("noPersonalEval").value.trim(),
        $("nombreEval").value.trim(),
        $("posicionEval").value.trim(),
        $("deptoEval").value.trim(),
        $("periodoEval").value.trim(),
        $("versionEval").value.trim(),
        $("fechaEval").value.trim(),
      ];
    }
    function getDesempenoExtraRequiredFields(){
      const ids = [
        "comentariosColaborador","evaluacionClientesDes","fortalezas","oportunidadesMejora",
        "proyeccionPotencial","necesidadesCapacitacion","justificacion","comentariosEvaluadorDes","nombreEvaluadorDes"
      ];
      return ids.map(id => String($(id)?.value || "").trim());
    }

    function isEvalComplete(){
      if(!isEvalPhase()) return false;
      if(getEvalHeaderRequiredFields().some(v => !v)) return false;
      if(isDesempenoPhase()){
        if(getDesempenoExtraRequiredFields().some(v => !v)) return false;
      }
      const total = state.itemKeys.length;
      if(total === 0) return false;
      for(const k of state.itemKeys){
        const obj = state.answers.get(k);
        if(!obj || !obj.value || !obj.label) return false;
      }
      return true;
    }
    function isClientesComplete(){
      if(!isClientesPhase()) return false;
      return !getClientesRequiredFields().some(v => !v);
    }

    function updateGuardarUIState(){
      const btnG = $("btnGuardar");
      const btnL = $("btnLimpiarEval");
      const showLimpiar = isEvalPhase() || isClientesPhase();
      btnL.style.display = showLimpiar ? "inline-block" : "none";

      if(isClientesPhase()){
        btnG.disabled = !isClientesComplete();
        return;
      }
      if(isEvalPhase()){
        const total = state.itemKeys.length;
        let done = 0;
        for(const k of state.itemKeys){
          const obj = state.answers.get(k);
          if(obj && obj.value) done++;
        }
        $("completeHint").textContent = `Completado: ${done}/${total}`;
        btnG.disabled = !isEvalComplete();
        return;
      }
      btnG.disabled = true;
    }

    /* ================= PHASE UI ================= */
    function setPhase(phase){
      state.fase = phase || "";

      document.querySelectorAll("[data-phase-block]").forEach(el=>{
        const p = el.getAttribute("data-phase-block");
        el.classList.remove("show");
        if(p === state.fase) el.classList.add("show");
      });

      document.querySelectorAll('[data-phase-block="EVAL"]').forEach(el=>{
        el.classList.toggle("show", isEvalPhase());
      });

      const nivelWrap = $("nivelWrap");
      nivelWrap.classList.toggle("hide", isClientesPhase());

      const enableNivel = (isEvalPhase() || state.fase === "FORMULARIOS" || state.fase === "PESOS");
      $("nivelSelect").disabled = !enableNivel;

      const labelByPhase = {
        "FORMULARIOS": "Formularios: Selecciona nivel (Todos / 1..10) y carga para ver la tabla.",
        "PESOS": "Pesos: Selecciona nivel (Todos / 1..10) y carga para ver la tabla.",
        "AUTO": "Autoevaluaci√≥n activa. Selecciona nivel para cargar √≠tems.",
        "DESEMPENO": "Evaluaci√≥n del desempe√±o activa. Selecciona nivel para cargar √≠tems y completa los comentarios de desarrollo.",
        "CLIENTES": "Evaluaci√≥n de clientes: completa los campos y guarda en la hoja Clientes (sin nivel).",
        "RESULTADO": "Resultados del desempe√±o.",
        "CONSOLIDADO": "Informe consolidado.",
        "CAPACITACION": "Necesidades de capacitaci√≥n.",
        "DESARROLLO": "Plan de desarrollo."
      };
      $("faseHelp").textContent = labelByPhase[state.fase] || "Selecciona una fase para desplegar el formulario.";

      const hideOpcionales = isEvalPhase() || isClientesPhase();
      $("btnNuevo").style.display = hideOpcionales ? "none" : "inline-block";
      $("btnPrint").style.display = hideOpcionales ? "none" : "inline-block";

      updateGuardarUIState();
    }

    /* ================= EVAL: RENDER FORM ================= */
    function renderCuestionario(form){
      const root = $("cuestionario");
      root.innerHTML = "";
      state.itemKeys = [];

      if(!isEvalPhase()){
        root.innerHTML = `<div class="hint">Selecciona una fase evaluable para ver el cuestionario.</div>`;
        $("itemsCount").textContent = "Items: 0";
        $("completeHint").textContent = "Completado: 0/0";
        updateGuardarUIState();
        return;
      }
      if(!form || !form.factors || !form.factors.length){
        root.innerHTML = `<div class="hint">No hay √≠tems para este nivel.</div>`;
        $("itemsCount").textContent = "Items: 0";
        $("completeHint").textContent = "Completado: 0/0";
        updateGuardarUIState();
        return;
      }

      let totalItems = 0;

      form.factors.forEach((f, idxF)=>{
        const box = document.createElement("div");
        box.className = "factor";
        box.innerHTML = `<div class="factor-title">${idxF+1}. ${escapeHtml(f.factor || "Factor")}</div>`;

        (f.items || []).forEach((it, idxI)=>{
          totalItems++;
          const key = it.key;
          state.itemKeys.push(key);

          const current = state.answers.get(key)?.value || "";
          const r = it.rubrica || {};
          const letter = String.fromCharCode(65 + (idxI % 26));

          const row = document.createElement("div");
          row.className = "item-row";
          row.innerHTML = `
            <div class="item-left">
              <div class="item-name">${letter}. ${escapeHtml(it.item || "√çtem")}</div>
              <div class="item-sub">Selecciona 1‚Äì5 seg√∫n la r√∫brica.</div>
            </div>
            <div class="item-right">
              <div class="lbl">Puntaje (1‚Äì5)</div>
              <select data-key="${escapeAttr(key)}">
                <option value="" ${current==="" ? "selected":""}>Seleccionar‚Ä¶</option>
                <option value="1" ${current==="1" ? "selected":""}>1 ‚Äî ${escapeHtml(r["1"] ?? "")}</option>
                <option value="2" ${current==="2" ? "selected":""}>2 ‚Äî ${escapeHtml(r["2"] ?? "")}</option>
                <option value="3" ${current==="3" ? "selected":""}>3 ‚Äî ${escapeHtml(r["3"] ?? "")}</option>
                <option value="4" ${current==="4" ? "selected":""}>4 ‚Äî ${escapeHtml(r["4"] ?? "")}</option>
                <option value="5" ${current==="5" ? "selected":""}>5 ‚Äî ${escapeHtml(r["5"] ?? "")}</option>
              </select>
            </div>
          `;

          const sel = row.querySelector("select");
          sel.addEventListener("change", (e)=>{
            const k = e.target.getAttribute("data-key");
            const v = e.target.value;
            if(!v){
              state.answers.delete(k);
            } else {
              const label = e.target.selectedOptions?.[0]?.textContent?.trim() || v;
              state.answers.set(k, { value: v, label });
            }
            updateGuardarUIState();
          });

          box.appendChild(row);
        });

        root.appendChild(box);
      });

      $("itemsCount").textContent = `Items: ${totalItems}`;
      updateGuardarUIState();
    }

    /* ================= LOADERS (levels + form) ================= */
    async function loadLevelsForPhase(){
      if(isEvalPhase()){
        const lv = await apiGet({action:"levels", sheet:"Formularios"});
        const levels = lv.levels || [];
        if(!levels.length) throw new Error("No se encontraron niveles en 'Formularios'.");
        fillNivelSelect(levels, false);
        const def = pickDefault(levels, false);
        $("nivelSelect").value = def;
        state.nivel = def;
        return;
      }
      if(state.fase === "FORMULARIOS"){
        const lv = await apiGet({action:"levels", sheet:"Formularios"});
        const levels = lv.levels || [];
        if(!levels.length) throw new Error("No se encontraron niveles en 'Formularios'.");
        fillNivelSelect(levels, true);
        const def = pickDefault(levels, true);
        $("nivelSelect").value = def;
        state.nivel = def;
        return;
      }
      if(state.fase === "PESOS"){
        const lv = await apiGet({action:"levels", sheet:"Pesos"});
        const levels = lv.levels || [];
        if(!levels.length) throw new Error("No se encontraron niveles en 'Pesos'.");
        fillNivelSelect(levels, true);
        const def = pickDefault(levels, true);
        $("nivelSelect").value = def;
        state.nivel = def;
        return;
      }
    }
    async function loadFormByNivel(nivel){
      const res = await apiGet({action:"form", nivel: String(nivel)});
      state.form = res.form || null;
      state.answers.clear();
      renderCuestionario(state.form);
    }

    /* ================= CLEAR ================= */
    function clearClientes(){
      ["noPersonal","nombre","posicion","depto","periodo","version"].forEach(id=>$(id).value="");
      $("comenzarHacer").value = "";
      $("pararHacer").value = "";
      $("continuarHacer").value = "";
      $("nombreEvaluador").value = "";
      $("fecha").value = todayLocal();
      updateGuardarUIState();
    }
    function clearDesempenoExtra(){
      [
        "comentariosColaborador","evaluacionClientesDes","fortalezas","oportunidadesMejora",
        "proyeccionPotencial","necesidadesCapacitacion","justificacion","comentariosEvaluadorDes","nombreEvaluadorDes"
      ].forEach(id=>{ const el = $(id); if(el) el.value = ""; });
    }
    function clearAutoExtra(){
      const el = $("comentariosColaboradorAuto");
      if(el) el.value = "";
    }
    function clearEval(){
      ["noPersonalEval","nombreEval","posicionEval","deptoEval","periodoEval","versionEval"].forEach(id=>$(id).value="");
      $("fechaEval").value = todayLocal();
      state.answers.clear();
      renderCuestionario(state.form);
      clearDesempenoExtra();
      clearAutoExtra();
      updateGuardarUIState();
    }

    /* ================= SAVE ================= */
    async function saveClientes(){
      if(!isClientesPhase()){
        alert("Para guardar Clientes, selecciona la fase Formulario de evaluaci√≥n de clientes.");
        return;
      }
      if(!isClientesComplete()){
        alert("A√∫n faltan campos. Completa todo para habilitar Guardar.");
        return;
      }

      const payload = {
        fase: "CLIENTES",
        no: $("noPersonal").value.trim(),
        nombre: $("nombre").value.trim(),
        posicion: $("posicion").value.trim(),
        depto: $("depto").value.trim(),
        periodo: $("periodo").value.trim(),
        version: $("version").value.trim(),
        fecha: $("fecha").value.trim(),
        comenzar: $("comenzarHacer").value.trim(),
        parar: $("pararHacer").value.trim(),
        continuar: $("continuarHacer").value.trim(),
        evaluador: $("nombreEvaluador").value.trim()
      };

      const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const out = await apiGet({action:"save", payload:b64});
      alert("Guardado ‚úÖ\nID: " + (out.id || "‚Äî"));
      clearClientes();
    }

    function buildCompatComentarios(){
      if(!isDesempenoPhase()) return "";
      return ($("justificacion")?.value || "").trim();
    }

    async function saveEval(){
      if(!isEvalPhase()){
        alert("Para guardar, usa Autoevaluaci√≥n o Evaluaci√≥n del desempe√±o.");
        return;
      }
      if(!isEvalComplete()){
        alert("A√∫n faltan datos / respuestas" + (isDesempenoPhase() ? " / comentarios" : "") + ". Completa todo para habilitar Guardar.");
        return;
      }

      const nm = getNivelMeta();
      const respuestasOrdenadas = state.itemKeys.map(k => (state.answers.get(k)?.label || ""));
      const comentariosAuto = isAutoPhase() ? ($("comentariosColaboradorAuto")?.value || "").trim() : "";

      const extrasDesempeno = isDesempenoPhase() ? {
        comentariosColaborador: ($("comentariosColaborador")?.value || "").trim(),
        evaluacionClientes: ($("evaluacionClientesDes")?.value || "").trim(),
        fortalezas: ($("fortalezas")?.value || "").trim(),
        oportunidadesMejora: ($("oportunidadesMejora")?.value || "").trim(),
        proyeccionPotencial: ($("proyeccionPotencial")?.value || "").trim(),
        necesidadesCapacitacion: ($("necesidadesCapacitacion")?.value || "").trim(),
        justificacion: buildCompatComentarios(),
        comentariosEvaluador: ($("comentariosEvaluadorDes")?.value || "").trim(),
        nombreEvaluador: ($("nombreEvaluadorDes")?.value || "").trim()
      } : null;

      const extrasAuto = isAutoPhase() ? { comentariosColaborador: comentariosAuto } : null;

      const payload = {
        fase: state.fase,
        nivel: String(nm.nivelNumero || nm.nivelValue || ""),
        nivelLabel: String(nm.nivelLabel || ""),
        nivelDescripcion: String(nm.nivelDescripcion || ""),

        no: $("noPersonalEval").value.trim(),
        nombre: $("nombreEval").value.trim(),
        posicion: $("posicionEval").value.trim(),
        depto: $("deptoEval").value.trim(),
        periodo: $("periodoEval").value.trim(),
        version: $("versionEval").value.trim(),
        fecha: $("fechaEval").value.trim(),

        respuestas: respuestasOrdenadas,
        comentarios: isAutoPhase() ? comentariosAuto : buildCompatComentarios(),
        extras: isDesempenoPhase() ? extrasDesempeno : (isAutoPhase() ? extrasAuto : null)
      };

      const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      const out = await apiGet({action:"save", payload:b64});
      alert("Guardado ‚úÖ\nID: " + (out.id || "‚Äî"));
      clearEval();
    }

    function doGuardar(){
      if(isClientesPhase()) return saveClientes();
      if(isEvalPhase()) return saveEval();
      alert("No hay nada que guardar en esta fase.");
    }
    function doLimpiar(){
      if(isClientesPhase()) return clearClientes();
      if(isEvalPhase()) return clearEval();
    }

    /* ================= EVENTS ================= */
    $("webappUrl").addEventListener("change", ()=>{
      const v = normalizeWebAppUrl($("webappUrl").value);
      $("webappUrl").value = v;
      localStorage.setItem(LS_KEY_URL, v);
    });

    $("btnAbrirPing").addEventListener("click", ()=>{
      const base = getWebAppUrl();
      const raw = base + (base.includes("?") ? "&" : "?") + "action=ping&_=" + Date.now();
      window.open(raw, "_blank", "noopener,noreferrer");
    });

    $("btnProbarApi").addEventListener("click", async ()=>{
      try{
        await apiGet({action:"ping"});
        setApiStatus("ok","API: conectada");
      }catch(e){
        setApiStatus("err","API: " + e.message);
      }
    });

    $("faseSelect").addEventListener("change", async (e)=>{
      const fase = e.target.value;
      setPhase(fase);
      try{
        if(isEvalPhase() || fase === "FORMULARIOS" || fase === "PESOS"){
          await loadLevelsForPhase();
        }
        if(isEvalPhase()){
          await loadFormByNivel(state.nivel);
          updateGuardarUIState();
        }
      }catch(err){
        setApiStatus("err","API: " + err.message);
      }
    });

    $("nivelSelect").addEventListener("change", async (e)=>{
      try{
        state.nivel = e.target.value;
        if(isEvalPhase()){
          await loadFormByNivel(state.nivel);
          updateGuardarUIState();
        }
      }catch(err){
        setApiStatus("err","API: " + err.message);
      }
    });

    $("btnGuardar").addEventListener("click", ()=>doGuardar().catch(err=>setApiStatus("err","API: " + err.message)));
    $("btnLimpiarEval").addEventListener("click", doLimpiar);
    $("btnNuevo").addEventListener("click", ()=>{ clearClientes(); clearEval(); });
    $("btnPrint").addEventListener("click", ()=>window.print());

    [
      "noPersonal","nombre","posicion","depto","periodo","version","fecha",
      "comenzarHacer","pararHacer","continuarHacer","nombreEvaluador"
    ].forEach(id=>{
      const el = $(id);
      if(el){ el.addEventListener("input", updateGuardarUIState); el.addEventListener("change", updateGuardarUIState); }
    });

    ["noPersonalEval","nombreEval","posicionEval","deptoEval","periodoEval","versionEval","fechaEval"].forEach(id=>{
      const el = $(id);
      if(el){ el.addEventListener("input", updateGuardarUIState); el.addEventListener("change", updateGuardarUIState); }
    });

    [
      "comentariosColaborador","evaluacionClientesDes","fortalezas","oportunidadesMejora",
      "proyeccionPotencial","necesidadesCapacitacion","justificacion","comentariosEvaluadorDes","nombreEvaluadorDes"
    ].forEach(id=>{
      const el = $(id);
      if(el){ el.addEventListener("input", updateGuardarUIState); el.addEventListener("change", updateGuardarUIState); }
    });

    ["comentariosColaboradorAuto"].forEach(id=>{
      const el = $(id);
      if(el){ el.addEventListener("input", updateGuardarUIState); el.addEventListener("change", updateGuardarUIState); }
    });

    /* ================= BOOT ================= */
    (function boot(){
      $("fecha").value = todayLocal();
      $("fechaEval").value = todayLocal();
      setPhase("");

      const saved = localStorage.getItem(LS_KEY_URL);
      setWebAppUrl(saved || DEFAULT_WEBAPP_URL);

      apiGet({action:"ping"})
        .then(()=>{
          setApiStatus("ok","API: conectada");
          $("cuestionario").innerHTML = `<div class="hint">Selecciona una fase para iniciar.</div>`;
        })
        .catch(e=>setApiStatus("err","API: "+e.message));

      updateGuardarUIState();
    })();
  </script>
</body>
</html>
