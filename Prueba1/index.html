<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Evaluaci√≥n del Desempe√±o</title>
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#121f3d;
      --text:#e8eefc; --muted:#a9b7d9; --line:rgba(255,255,255,.10);
      --accent:#4f7cff; --accent2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1a2a52; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius2: 22px;
      --mono: ui-monospace, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--sans);color:var(--text);min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(79,124,255,.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
        var(--bg);
    }
    header{
      position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
      background:rgba(11,18,32,.75);border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:16px 18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{
      width:34px;height:34px;border-radius:12px;display:grid;place-items:center;
      background:rgba(79,124,255,.18);border:1px solid rgba(79,124,255,.25);font-weight:800;
    }
    .sub{color:var(--muted);font-size:13px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:rgba(26,42,82,.75);border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)
    }
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,button,input,textarea{
      background:var(--panel);
      border:1.5px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-family:var(--sans);
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, transform .05s ease, opacity .15s ease;
    }
    /* ‚úÖ Recuadro semigrueso SOLO para los 2 selectores principales */
#faseSelect,
#nivelSelect{
  border: 3px solid rgba(147,197,253,.85); /* semigrueso */
  box-shadow: 0 0 0 3px rgba(147,197,253,.18);
  border-radius: 14px;
}

/* Hover m√°s marcado */
#faseSelect:hover,
#nivelSelect:hover{
  border-color: rgba(147,197,253,1);
}

/* Focus elegante */
#faseSelect:focus,
#nivelSelect:focus{
  border-color: rgba(79,124,255,.95);
  box-shadow: 0 0 0 4px rgba(79,124,255,.25);
}

    select{min-width:220px}
    textarea{width:100%;min-height:92px;resize:vertical}
    input{width:100%}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(79,124,255,.55);
      box-shadow: 0 0 0 3px rgba(79,124,255,.18);
    }
    button{cursor:pointer}

/* ‚úÖ BOTONES UNIFICADOS (azul claro + letra negra) */
button,
.btn-ok,
.btn-blue,
.btn-warn,
.btn-ghost{
  background: #93c5fd;            /* azul claro */
  color: #000 !important;         /* letras negras */
  border-color: #60a5fa;          /* borde azul */
  font-weight: 800;
}

/* hover/active sin cambiar el look */
button:hover:not([disabled]),
.btn-ok:hover:not([disabled]),
.btn-blue:hover:not([disabled]),
.btn-warn:hover:not([disabled]),
.btn-ghost:hover:not([disabled]){
  filter: brightness(1.04);
}

button:active:not([disabled]),
.btn-ok:active:not([disabled]),
.btn-blue:active:not([disabled]),
.btn-warn:active:not([disabled]),
.btn-ghost:active:not([disabled]){
  transform: translateY(1px);
}

/* disabled igual que antes */
button[disabled]{
  opacity:.45;
  filter:saturate(.6);
  cursor:not-allowed;
}

/* (Opcional) si quieres mantener ‚Äúpulse‚Äù, que pulse pero con azul */
.btn-pulse{
  box-shadow: 0 0 0 0 rgba(96,165,250,.45);
  animation: pulse 1.2s infinite;
}
@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(96,165,250,.35); }
  70%{ box-shadow:0 0 0 10px rgba(96,165,250,0); }
  100%{ box-shadow:0 0 0 0 rgba(96,165,250,0); }
}

    main{padding:18px}
    .grid{max-width:1180px;margin:0 auto;display:grid;gap:14px}
    .card{
      background:linear-gradient(180deg, rgba(18,31,61,.9), rgba(15,27,51,.92));
      border:1px solid var(--line);border-radius:var(--radius2);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .card-h{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center
    }
    .card-h h2{margin:0;font-size:16px}
    .card-b{padding:14px 16px}
    .status{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:12px;color:var(--muted)}
    .status .s-dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .status.ok .s-dot{background:var(--accent2)}
    .status.err .s-dot{background:var(--danger)}
    .hint{
      background:rgba(79,124,255,.10);
      border:1px dashed rgba(79,124,255,.35);
      padding:10px 12px;border-radius:14px;color:var(--muted);font-size:13px
    }
    .form-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    .lbl{
      font-size:12px; color:rgba(232,238,252,.92); margin-bottom:6px; font-weight:800; letter-spacing:.02em;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    .field.boxed{
      border:1.5px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(11,18,32,.28), rgba(15,27,51,.18));
      border-radius:18px; padding:12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.18);
    }
    .field.boxed .lbl{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;border-radius:14px;
      background:rgba(79,124,255,.10);
      border:1px solid rgba(79,124,255,.22);
      text-transform:uppercase; letter-spacing:.08em; font-size:11px;
      color:rgba(232,238,252,.95);
    }
    .field.boxed textarea, .field.boxed input, .field.boxed select{
      background:rgba(15,27,51,.88);
      border-color:rgba(255,255,255,.16);
      border-width:1.5px; border-style:solid;
      border-radius:14px;
    }
    [data-phase-block]{display:none}
    [data-phase-block].show{display:block}
    .nivelWrap{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nivelWrap.hide{display:none}

    /* CUESTIONARIO */
    .factor{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      margin-bottom:14px;
      background:linear-gradient(180deg, rgba(11,18,32,.25), rgba(15,27,51,.10));
    }
    .factor-title{
      padding:14px 16px;
      font-weight:800;
      font-size:18px;
      letter-spacing:.2px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }
    .item-row{
      display:flex; justify-content:space-between; gap:16px;
      align-items:center; padding:16px;
      border-top:1px solid rgba(255,255,255,.07);
    }
    .item-row:first-of-type{border-top:none}
    .item-left{flex:1; min-width:280px}
    .item-name{font-weight:750; font-size:15px; margin:0;}
    .item-sub{color:var(--muted); font-size:12px; margin-top:4px;}
    .item-right{min-width:420px; max-width:520px; width:44%}
    .item-right .lbl{margin-bottom:8px}
    .item-right select{width:100%}

    /* TABLE */
    .tableWrap{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:auto;
      background:rgba(11,18,32,.20);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
    }
    thead th{
      position:sticky;
      top:0;
      background:rgba(15,27,51,.95);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:12px 10px;
      text-align:left;
      font-size:12px;
      color:rgba(232,238,252,.92);
      letter-spacing:.06em;
      text-transform:uppercase;
      z-index:2;
      white-space:nowrap;
    }
   tbody td{
  padding:12px 10px;
  border-bottom:1px solid rgba(255,255,255,.06);
  vertical-align:top;
  font-size:14px; /* üëà aumentado 1 punto */
  color:rgba(232,238,252,.92);
}
    tbody tr:hover td{ background:rgba(79,124,255,.06); }
    .tdMuted{color:var(--muted); font-size:12px; margin-top:4px}
    .mono{font-family:var(--mono)}
    .sr-hidden{
      position:absolute !important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
    .pesoInput{
      width:120px;
      text-align:right;
      font-family:var(--mono);
    }

    /* ‚úÖ MODALES (RECUPERAR / IMPRIMIR / TIPOS) ‚Äî con scroll interno */
.modalBack{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;              /* ‚úÖ centra vertical */
  justify-content:center;
  padding:26px 14px;
  z-index:9999;
  backdrop-filter: blur(6px);
  overflow:auto;                   /* ‚úÖ si la pantalla es peque√±a, permite scroll del contenedor */
}
.modalBack.show{display:flex}

.modal{
  width:min(1100px, 100%);
  max-height: calc(100vh - 52px);  /* ‚úÖ nunca se sale de la pantalla */
  border:1px solid rgba(255,255,255,.12);
  border-radius:22px;
  box-shadow: 0 20px 60px rgba(0,0,0,.55);
  background:linear-gradient(180deg, rgba(18,31,61,.98), rgba(15,27,51,.98));
  display:flex;                    /* ‚úÖ permite header fijo + body con scroll */
  flex-direction:column;
  overflow:hidden;                 /* ‚úÖ recorta bordes redondos, el scroll va adentro */
}

.modal-h{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  flex: 0 0 auto;                  /* ‚úÖ no se encoge */
}
.modal-h h3{margin:0;font-size:15px}

.modal-b{
  padding:14px 16px;
  overflow:auto;                   /* ‚úÖ scroll aqu√≠ */
  flex: 1 1 auto;                  /* ‚úÖ ocupa el espacio disponible */
  min-height: 0;                   /* ‚úÖ clave para que el overflow funcione en flex */
}

/* ‚úÖ En tablas grandes dentro del modal (como TIPOS), fuerza scroll c√≥modo */
.modal .tableWrap{
  max-height: calc(100vh - 220px); /* ajusta si quieres m√°s/menos */
  overflow:auto;
}
    @media (max-width:860px){
      .col-3,.col-4,.col-6{grid-column:span 12}
      select{min-width:180px}
      .item-row{flex-direction:column; align-items:stretch}
      .item-right{min-width:100%; width:100%}
      table{min-width:840px}
    }
  @media print{

  /* Ocultar todo excepto RESULTADO */
  header,
  #blockFaseNivel,
  #blockFormularios,
  #blockPesos,
  #blockClientes,
  #blockDatos,
  #blockEval,
  #blockAutoComentarios,
  #blockDesempenoExtra,
  #recoverModalBack,
  #printModalBack {
    display: none !important;
  }

  body{
    background:#fff !important;
    color:#000 !important;
  }

  main{
    padding:0 !important;
  }

  .card{
    box-shadow:none !important;
    border:1px solid #ddd !important;
    background:#fff !important;
  }

  .hint{
    border:1px solid #ddd !important;
    background:#fff !important;
  }

  input, textarea{
    color:#000 !important;
    background:#fff !important;
    border:1px solid #bbb !important;
  }

  .tableWrap{
    border:1px solid #ddd !important;
    background:#fff !important;
  }

  thead th{
    background:#f4f4f4 !important;
    color:#000 !important;
  }
}
  </style>
</head>

<body>
  <input id="webapp" class="sr-hidden" aria-hidden="true" tabindex="-1" />

  <!-- ‚úÖ MODAL RECUPERAR -->
<div id="recoverModalBack" class="modalBack" role="dialog" aria-modal="true" aria-labelledby="recoverTitle">
  <div class="modal">
    <div class="modal-h">
      <div>
        <h3 id="recoverTitle">Registros recuperados</h3>
        <div class="modalNote" id="recoverSubtitle">‚Äî</div>
      </div>
      <div class="modalActions">
        <button id="btnRecoverClose" class="btn-ghost">Cerrar</button>
      </div>
    </div>
    <div class="modal-b">
      <div class="hint" style="margin-bottom:12px">
        Tip: selecciona el registro correcto y listo ‚Äî sin ‚Äúcopy/paste arqueol√≥gico‚Äù üòÑ
      </div>

      <div class="kpi" style="margin-bottom:10px">
        <span class="chip mono">Autoevaluaci√≥n: <b id="kpiAutoCount">0</b></span>
        <span class="chip mono">Clientes (match): <b id="kpiCliHit">0</b></span>
      </div>

      <div class="tableWrap">
        <table id="recoverTable">
          <thead>
            <tr>
              <th>Acci√≥n</th>
              <th>Fila</th>
              <th>No. personal</th>
              <th>Nombre</th>
              <th>Periodo</th>
              <th>Versi√≥n</th>
              <th>Fecha</th>
              <th>Nivel</th>
              <th>Respuestas</th>
              <th>Comentarios colaborador</th>
              <th>Evaluaci√≥n de clientes</th>
            </tr>
          </thead>
          <tbody id="recoverTbody">
            <tr><td colspan="11" class="sub">‚Äî</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- ‚úÖ MODAL IMPRIMIR (RESULTADO): PDF / TEXTO -->
<div id="printModalBack" class="modalBack" role="dialog" aria-modal="true" aria-labelledby="printTitle">
  <div class="modal">
    <div class="modal-h">
      <div>
        <h3 id="printTitle">Imprimir reporte</h3>
        <div class="modalNote">Elige <b>PDF</b> (di√°logo del navegador) o genera <b>Texto</b> para copiar.</div>
      </div>
      <div class="modalActions">
        <button id="btnPrintClose" class="btn-ghost">Cerrar</button>
      </div>
    </div>

    <div class="modal-b">
      <div class="hint" style="margin-bottom:12px">
        Tip: si el PDF sale feo, no eres t√∫: es el ‚Äúmodo impresora‚Äù haciendo lo suyo üòÑ
      </div>

      <div class="controls" style="margin-bottom:12px;justify-content:flex-start">
        <button id="btnPrintPDF" class="btn-blue">PDF</button>
        <button id="btnPrintTXT" class="btn-ghost">Generar texto</button>
        <button id="btnCopyText" class="btn-ok">Copiar texto</button>
      </div>

      <div class="field boxed">
        <div class="lbl">Texto del reporte</div>
        <textarea id="printTextArea" placeholder="Aqu√≠ aparecer√° el reporte en texto..."></textarea>
        <div class="sub" style="margin-top:6px;color:rgba(169,183,217,.9)">
          Nota: el PDF usa <code>window.print()</code>. El texto sirve para pegarlo donde quieras.
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- ‚úÖ MODAL TIPOS -->
<div id="tiposModalBack" class="modalBack" role="dialog" aria-modal="true" aria-labelledby="tiposTitle">
  <div class="modal">
    <div class="modal-h">
      <div>
        <h3 id="tiposTitle">Niveles de puesto</h3>
<div class="modalNote">Gu√≠a r√°pida de clasificaci√≥n (1‚Äì10)</div>
      </div>
      <div class="modalActions">
        <button id="btnTiposClose" class="btn-ghost">Cerrar</button>
      </div>
    </div>

    <div class="hint" style="margin-bottom:12px">
  Tip: esto evita discusiones eternas de ‚Äú¬øpero este puesto es nivel 6 o nivel 7?‚Äù üòÑ
</div>

      <div class="tableWrap">
        <table id="tiposTable">
          <thead>
            <tr>
              <th style="width:90px">Nivel</th>
              <th style="width:260px">Nombre</th>
              <th>Descripci√≥n</th>
              <th style="width:360px">Ejemplos</th>
            </tr>
          </thead>
          <tbody id="tiposTbody">
            <tr><td colspan="4" class="sub">‚Äî</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
  
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ED</div>
        <div>
          Proceso de evaluaci√≥n del desempe√±o
          <div class="chips">
            <span class="chip">Empresa: <b id="chipEmpresa">No Implementado</b></span>
            <span class="chip">Versi√≥n: <b id="chipVersion">Prueba</b></span>
          </div>
        </div>
      </div>

     <div class="controls">
  <span id="apiStatus" class="status">
    <span class="s-dot"></span>
    <span id="apiStatusText">API: sin probar</span>
  </span>

  <!-- ‚ùå Diagn√≥stico oculto (Probar API / Ping eliminados) -->

  <!-- ‚úÖ Para RESULTADO: Recuperar + Limpiar + Imprimir -->
  <button id="btnRecuperar" class="btn-blue" style="display:none">Recuperar</button>
  <button id="btnLimpiarEval" class="btn-warn" style="display:none">Limpiar</button>

  <!-- ‚úÖ Guardar aplica en CLIENTES y EVAL, no en RESULTADO -->
  <button id="btnGuardar" class="btn-ok" disabled>Guardar</button>

  <button id="btnNuevo" class="btn-blue">Nuevo</button>

  <!-- ‚úÖ Imprimir (para RESULTADO): abre men√∫ PDF / Texto -->
  <button id="btnPrint" class="btn-ghost" style="display:none">Imprimir</button>
</div>
   </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- FASE + NIVEL -->
    <section class="card" id="blockFaseNivel">
      <div class="card-h">
        <div class="controls" style="width:100%; justify-content:space-between">
          <div class="controls" style="gap:10px">
            <select id="faseSelect">
      <option value="">Seleccione fase</option>
     <option value="TIPOS">Niveles</option>
    <option value="FORMULARIOS">Formularios</option>
  <option value="PESOS">Pesos</option>
  <option value="AUTO">Formulario de autoevaluaci√≥n</option>
  <option value="CLIENTES">Formulario de evaluaci√≥n de clientes</option>
  <option value="DESEMPENO">Formulario de evaluaci√≥n del desempe√±o</option>
  <option value="RESULTADO">Resultado evaluaci√≥n del desempe√±o</option>
  <option value="CONSOLIDADO">Informe ejecutivo</option>
  <option value="CAPACITACION">Informe necesidades de capacitaci√≥n</option>
  <option value="DESARROLLO">Informe plan de desarrollo</option>
</select>

            <span class="nivelWrap" id="nivelWrap">
              <select id="nivelSelect" disabled>
                <option>Cargando niveles‚Ä¶</option>
              </select>
            </span>
          </div>

          <div class="sub" id="faseHelp" style="max-width:520px; text-align:right">
            Selecciona una fase para desplegar el formulario.
          </div>
        </div>
      </div>
    </section>

    <!-- FORMULARIOS -->
    <section class="card" data-phase-block="FORMULARIOS" id="blockFormularios">
      <div class="card-h">
        <div>
          <h2>Formularios (r√∫bricas por nivel)</h2>
          <div class="sub">Usa <b>Cargar</b> para mostrar Nivel, Factor, Item y las descripciones 1‚Äì5.</div>
        </div>
    <div class="controls">
  <button id="btnCargarForm" class="btn-blue">Cargar</button>
  <button id="btnLimpiarForm" class="btn-warn">Limpiar</button>
</div>
      </div>
      <div class="card-b">
        <div class="hint" style="margin-bottom:12px">
          Consejo r√°pido: si eliges <b>Todos</b> puede salir una tabla grandota (tu Excel interior va a sonre√≠r üòÑ).
        </div>
        <div id="formTableInfo" class="sub" style="margin-bottom:10px">‚Äî</div>
        <div class="tableWrap">
          <table id="formTable">
            <thead>
              <tr>
                <th>Nivel</th>
                <th>Factor</th>
                <th>Item</th>
                <th>1</th>
                <th>2</th>
                <th>3</th>
                <th>4</th>
                <th>5</th>
              </tr>
            </thead>
            <tbody id="formTableBody">
              <tr><td colspan="8" class="sub">Presiona <b>Cargar</b> para ver la informaci√≥n.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ‚úÖ PESOS -->
    <section class="card" data-phase-block="PESOS" id="blockPesos">
      <div class="card-h">
        <div>
          <h2>Pesos (ponderaciones)</h2>
          <div class="sub">Cambia el <b>Peso</b> y presiona <b>Guardar</b> para actualizar la hoja <b>Pesos</b>.</div>
        </div>
        <div class="controls">
          <button id="btnCargarPesos" class="btn-blue">Cargar</button>
          <button id="btnLimpiarPesos" class="btn-warn">Limpiar</button>
          <button id="btnGuardarPesos" class="btn-ok" disabled>Guardar</button>
        </div>
      </div>
      <div class="card-b">
        <div class="hint" style="margin-bottom:12px">
          Tip: ‚ÄúTodos‚Äù sirve para ajustes masivos‚Ä¶ pero √∫salo con cari√±o: el caos ama los cambios sin guardar üòÑ
        </div>
        <div id="pesosTableInfo" class="sub" style="margin-bottom:10px">‚Äî</div>

        <div class="tableWrap">
          <table id="pesosTable">
            <thead>
              <tr>
                <th>Nivel</th>
                <th>Factor</th>
                <th>Item</th>
                <th>Peso</th>
              </tr>
            </thead>
            <tbody id="pesosTableBody">
              <tr><td colspan="4" class="sub">Presiona <b>Cargar</b> para ver la informaci√≥n.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section class="card" data-phase-block="CLIENTES" id="blockClientes">
      <div class="card-h">
        <div>
          <h2>Formulario de evaluaci√≥n de clientes</h2>
          <div class="sub">Completa todos los campos. Guardar se habilita hasta que todo est√© lleno.</div>
        </div>
        <div class="chips">
          <span class="chip mono">Hoja destino: <b>Clientes</b></span>
        </div>
      </div>
      <div class="card-b">
        <div class="hint" style="margin-bottom:12px">
          Nota: En esta fase no existe ‚ÄúNivel‚Äù. Solo se tabulan los campos del formulario en la hoja <b>Clientes</b>.
        </div>

        <div class="form-grid">
          <div class="field col-3 boxed"><div class="lbl">No. de personal</div><input id="noPersonal" placeholder="Ej: 1600" /></div>
          <div class="field col-6 boxed"><div class="lbl">Nombre</div><input id="nombre" placeholder="Ej: Carlos Paz" /></div>
          <div class="field col-3 boxed"><div class="lbl">Posici√≥n</div><input id="posicion" placeholder="Ej: Analista" /></div>

          <div class="field col-4 boxed"><div class="lbl">Departamento</div><input id="depto" placeholder="Ej: Contabilidad" /></div>
          <div class="field col-4 boxed"><div class="lbl">Periodo</div><input id="periodo" placeholder="Ej: 2025" /></div>
          <div class="field col-2 boxed"><div class="lbl">Versi√≥n</div><input id="version" placeholder="Ej: 1" /></div>
          <div class="field col-2 boxed"><div class="lbl">Fecha</div><input id="fecha" /></div>

          <div class="field col-12 boxed">
            <div class="lbl">Comentarios del evaluador</div>
            <textarea id="comentariosEvaluadorClientes" placeholder="Empezar a hacer:
Continuar haciendo:
Dejar de hacer:"></textarea>
            <div class="sub" style="margin-top:6px;color:rgba(169,183,217,.9)">
              Tip: usa la gu√≠a para escribir de forma clara y accionable.
            </div>
          </div>

          <div class="field col-6 boxed"><div class="lbl">Nombre del evaluador</div><input id="nombreEvaluador" placeholder="Ej: Ana L√≥pez" /></div>
        </div>

        <div class="sub" style="margin-top:10px">Estado API: <b id="apiMini">‚Äî</b></div>
      </div>
    </section>

    <!-- EVAL (AUTO / DESEMPENO) -->
    <section class="card" id="blockDatos">
      <div class="card-h">
        <div>
          <h2>Datos del colaborador</h2>
          <div class="sub" id="datosHelp">Completa la informaci√≥n y selecciona una opci√≥n (1‚Äì5) para cada √≠tem.</div>
        </div>
        <div class="chips" id="datosChipWrap">
          <span class="chip mono" id="datosChip">Recuperar: llena <b>No personal</b> + <b>Periodo</b> + <b>Versi√≥n</b></span>
        </div>
      </div>

      <div class="card-b">
        <!-- ‚úÖ Bloque EVAL (AUTO/DESEMPENO) -->
        <div id="datosEvalWrap" class="form-grid" style="display:none">
          <div class="field col-3 boxed"><div class="lbl">No. de personal</div><input id="noPersonalEval" placeholder="Ej: 1600" /></div>
          <div class="field col-6 boxed"><div class="lbl">Nombre</div><input id="nombreEval" placeholder="Ej: Carlos Paz" /></div>
          <div class="field col-3 boxed"><div class="lbl">Posici√≥n</div><input id="posicionEval" placeholder="Ej: Analista" /></div>

          <div class="field col-4 boxed"><div class="lbl">Departamento</div><input id="deptoEval" placeholder="Ej: Contabilidad" /></div>
          <div class="field col-4 boxed"><div class="lbl">Periodo</div><input id="periodoEval" placeholder="Ej: 2025" /></div>
          <div class="field col-2 boxed"><div class="lbl">Versi√≥n</div><input id="versionEval" placeholder="Ej: 1" /></div>
          <div class="field col-2 boxed"><div class="lbl">Fecha</div><input id="fechaEval" /></div>

          <div class="sub col-12" style="margin-top:8px">Estado API: <b id="apiMiniEval">‚Äî</b></div>
        </div>

        <!-- ‚úÖ Bloque RESULTADO (solo estos 3 campos) -->
        <div id="datosResultadoWrap" class="form-grid" style="display:none">
          <div class="field col-4 boxed"><div class="lbl">No. de personal</div><input id="noPersonalRes" placeholder="Ej: 1600" /></div>
          <div class="field col-4 boxed"><div class="lbl">Periodo</div><input id="periodoRes" placeholder="Ej: 2025" /></div>
          <div class="field col-4 boxed"><div class="lbl">Versi√≥n</div><input id="versionRes" placeholder="Ej: 1" /></div>

          <div class="sub col-12" style="margin-top:8px">Estado API: <b id="apiMiniRes">‚Äî</b></div>
        </div>
      </div>
    </section>

    <section class="card" data-phase-block="EVAL" id="blockEval">
      <div class="card-h">
        <div>
          <h2>Evaluaci√≥n (1‚Äì5)</h2>
          <div class="sub">Cada nivel muestra ‚Äún√∫mero ‚Äî descripci√≥n‚Äù seg√∫n la r√∫brica.</div>
        </div>
        <div class="chips">
          <span class="chip" id="itemsCount">Items: 0</span>
          <span class="chip" id="completeHint">Completado: 0/0</span>
        </div>
      </div>
      <div class="card-b">
        <div id="cuestionario"></div>
      </div>
    </section>

    <!-- AUTO: Comentarios -->
    <section class="card" data-phase-block="AUTO" id="blockAutoComentarios">
      <div class="card-h">
        <div>
          <h2>Comentarios del colaborador</h2>
          <div class="sub">Aplica solo en: <b>Autoevaluaci√≥n</b>.</div>
        </div>
        <div class="chips"><span class="chip mono">Campo cualitativo</span></div>
      </div>
      <div class="card-b">
        <div class="form-grid">
          <div class="field col-12 boxed">
            <div class="lbl">Comentarios del colaborador</div>
            <textarea id="comentariosColaboradorAuto" placeholder="Comentarios del colaborador..."></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- DESEMPENO extras -->
    <section class="card" data-phase-block="DESEMPENO" id="blockDesempenoExtra">
      <div class="card-h">
        <div>
          <h2>Comentarios y desarrollo</h2>
          <div class="sub">En <b>Recuperar</b> se carga: formulario usado (Nivel), respuestas, comentarios del colaborador y evaluaci√≥n de clientes (SSC).</div>
        </div>
        <div class="chips"><span class="chip mono">Destino Guardar: <b>EvaluacionFinal</b></span></div>
      </div>
      <div class="card-b">
        <div class="hint" style="margin-bottom:12px">
          Aqu√≠ va lo que normalmente RRHH usa para ‚Äúentender el cuento‚Äù (sin inventar cap√≠tulos üòÑ)
        </div>

        <div class="form-grid">
          <div class="field col-12 boxed"><div class="lbl">Justificaci√≥n y comentarios</div><textarea id="justificacion" placeholder="Describe evidencias / ejemplos / contexto..."></textarea></div>

          <!-- ‚úÖ SSC (Clientes) -->
          <div class="field col-12 boxed">
            <div class="lbl">Evaluaci√≥n de clientes (SSC)</div>
            <div class="sub" style="margin-top:-2px;margin-bottom:8px">
              Se llena desde la hoja <b>Clientes</b> al Recuperar (por evaluador). Puedes editar.
            </div>
            <textarea id="evaluacionClientesDes" placeholder="Se llena al recuperar..."></textarea>
          </div>

          <div class="field col-12 boxed"><div class="lbl">Comentarios del colaborador</div><textarea id="comentariosColaborador" placeholder="Comentarios del colaborador..."></textarea></div>
          <div class="field col-12 boxed"><div class="lbl">Fortalezas</div><textarea id="fortalezas" placeholder="Fortalezas observadas..."></textarea></div>
          <div class="field col-12 boxed"><div class="lbl">Oportunidades de mejora</div><textarea id="oportunidadesMejora" placeholder="Oportunidades de mejora..."></textarea></div>
          <div class="field col-12 boxed"><div class="lbl">Proyecci√≥n y potencial de desarrollo</div><textarea id="proyeccionPotencial" placeholder="Proyecci√≥n / potencial..."></textarea></div>
          <div class="field col-12 boxed"><div class="lbl">Necesidades de capacitaci√≥n</div><textarea id="necesidadesCapacitacion" placeholder="Necesidades de capacitaci√≥n..."></textarea></div>
          <div class="field col-12 boxed"><div class="lbl">Comentarios del evaluador</div><textarea id="comentariosEvaluadorDes" placeholder="Comentarios del evaluador..."></textarea></div>
          <div class="field col-6 boxed"><div class="lbl">Nombre del evaluador</div><input id="nombreEvaluadorDes" placeholder="Ej: Ana L√≥pez" /></div>
        </div>
      </div>
    </section>

    <!-- RESULTADO -->
    <!-- RESULTADO -->
      <!-- ‚úÖ RESULTADO -->
    <section class="card" data-phase-block="RESULTADO" id="blockResultado">
      <div class="card-h">
        <div>
          <h2>Resultado evaluaci√≥n del desempe√±o</h2>
          <div class="sub">Usa <b>Recuperar</b> para cargar el reporte desde <b>EvaluacionFinal</b>.</div>
        </div>
        <div class="chips">
          <span class="chip mono">Hoja origen: <b>EvaluacionFinal</b></span>
        </div>
      </div>

      <div class="card-b">
      <!-- ‚úÖ function todayLocal(){(para PDF y texto) -->
<div class="hint" style="margin-bottom:12px">
  <div class="sub" style="margin-bottom:10px">Datos del colaborador:</div>

  <div class="form-grid">
    <!-- Fila 1 (No peque√±o, Nombre amplio, Posici√≥n mediana) -->
    <div class="field col-3 boxed">
      <div class="lbl">No. de personal</div>
      <input id="repNo" value="‚Äî" readonly />
    </div>
    <div class="field col-6 boxed">
      <div class="lbl">Nombre</div>
      <input id="repNombre" value="‚Äî" readonly />
    </div>
    <div class="field col-3 boxed">
      <div class="lbl">Posici√≥n</div>
      <input id="repPosicion" value="‚Äî" readonly />
    </div>

    <!-- Fila 2 (Depto y Periodo amplios, Version y Fecha compactos) -->
    <div class="field col-4 boxed">
      <div class="lbl">Departamento</div>
      <input id="repDepto" value="‚Äî" readonly />
    </div>
    <div class="field col-4 boxed">
      <div class="lbl">Periodo</div>
      <input id="repPeriodo" value="‚Äî" readonly />
    </div>
    <div class="field col-2 boxed">
      <div class="lbl">Versi√≥n</div>
      <input id="repVersion" value="‚Äî" readonly />
    </div>
    <div class="field col-2 boxed">
      <div class="lbl">Fecha</div>
      <input id="repFecha" value="‚Äî" readonly />
    </div>
  </div>
</div>

        <!-- Tabla: Factor / √çtem / Respuesta -->
        <div class="tableWrap" style="margin-bottom:14px">
          <table id="resultadoTable">
            <thead>
              <tr>
                <th>Factor</th>
                <th>√çtem</th>
                <th>Respuesta</th>
              </tr>
            </thead>
            <tbody id="resultadoTbody">
              <tr>
                <td colspan="3" class="sub">Usa <b>Recuperar</b> para cargar el reporte.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Puntaje final -->
        <div class="form-grid" style="margin-bottom:14px">
          <div class="field col-4 boxed">
            <div class="lbl">Puntaje final</div>
            <input id="puntajeFinal" value="‚Äî" readonly />
            <div class="sub" style="margin-top:6px;color:rgba(169,183,217,.9)">
              Calculado por Apps Script (action=<code>result</code>).
            </div>
          </div>
        </div>

        <!-- Cualitativos -->
        <div class="hint" style="margin-bottom:12px">
          Cualitativos tra√≠dos desde <b>EvaluacionFinal</b> (si est√°n vac√≠os, es que el humano no escribi√≥‚Ä¶ y la IA no inventa chismes üòÑ)
        </div>

        <div class="form-grid">
          <div class="field col-12 boxed">
            <div class="lbl">Justificaci√≥n y comentarios</div>
            <textarea id="resJustificacion" placeholder="Se llena al recuperar..." readonly></textarea>
          </div>

          <div class="field col-12 boxed">
            <div class="lbl">Evaluaci√≥n de clientes (SSC)</div>
            <textarea id="resEvalClientes" placeholder="Se llena al recuperar..." readonly></textarea>
          </div>

          <div class="field col-12 boxed">
            <div class="lbl">Comentarios del colaborador</div>
            <textarea id="resComColab" placeholder="Se llena al recuperar..." readonly></textarea>
          </div>

          <div class="field col-12 boxed">
            <div class="lbl">Fortalezas</div>
            <textarea id="resFortalezas" placeholder="Se llena al recuperar..." readonly></textarea>
          </div>

          <div class="field col-12 boxed">
            <div class="lbl">Oportunidades de mejora</div>
            <textarea id="resOportunidades" placeholder="Se llena al recuperar..." readonly></textarea>
          </div>

          <div class="field col-12 boxed">
            <div class="lbl">Proyecci√≥n y potencial de desarrollo</div>
            <textarea id="resProyeccion" placeholder="Se llena al recuperar..." readonly></textarea>
          </div>

      <div class="field col-12 boxed">
  <div class="lbl">
    Necesidades de capacitaci√≥n
    <span style="font-weight:600; text-transform:none; letter-spacing:normal;">
      (enliste los cursos separados por comas (,))
    </span>
  </div>
  <textarea id="resCapacitacion" placeholder="Se llena al recuperar..." readonly></textarea>
</div>

          <div class="field col-12 boxed">
            <div class="lbl">Comentarios del evaluador</div>
            <textarea id="resComEval" placeholder="Se llena al recuperar..." readonly></textarea>
          </div>

          <div class="field col-6 boxed">
            <div class="lbl">Nombre del evaluador</div>
            <input id="resNomEval" placeholder="Se llena al recuperar..." readonly />
          </div>
        </div>
      </div>
    </section>
    <!-- OTRAS VISTAS -->
        <!-- CONSOLIDADO (INFORME EJECUTIVO) -->
    <section class="card" data-phase-block="CONSOLIDADO" id="blockConsolidado">
      <div class="card-h">
        <div>
          <h2>Informe ejecutivo</h2>
          <div class="sub">Usa <b>Recuperar</b> para cargar el informe por <b>No. de personal</b> + <b>Periodo</b> + <b>Versi√≥n</b>.</div>
        </div>
        <div class="chips">
          <span class="chip mono">Origen: <b>EvaluacionFinal</b></span>
        </div>
      </div>
      <div class="card-b">
        <div class="hint">
          Aqu√≠ va el contenido del informe ejecutivo (resumen, hallazgos, KPIs, recomendaciones, etc.).<br/>
          Por ahora ya se muestran los campos y botones del header como pediste üòÑ
        </div>
      </div>
    </section>
    <section class="card" data-phase-block="CAPACITACION" id="blockCapacitacion">
  <div class="card-h">
    <div>
      <h2>Informe necesidades de capacitaci√≥n</h2>
      <div class="sub">Genera la tabla por <b>Periodo</b> y <b>Versi√≥n</b> desde <b>EvaluacionFinal</b>.</div>
    </div>
    <div class="controls">
      <button id="btnCapGenerar" class="btn-blue">Generar</button>
      <button id="btnCapGuardar" class="btn-ok" disabled>Guardar</button>
    </div>
 <div class="chips" style="margin-top:10px">
  <span class="chip mono">Hoja destino: <b>Plancapacitacion</b></span>
</div>
  </div>

  <div class="card-b">
    <div class="hint" style="margin-bottom:12px">
      Tip: si no aparece nada, puede ser que en EvaluacionFinal el campo venga vac√≠o‚Ä¶ o que la gente no quiera capacitarse üòÑ
    </div>

    <div class="form-grid" style="margin-bottom:12px">
      <div class="field col-6 boxed">
        <div class="lbl">Periodo</div>
        <input id="capPeriodo" placeholder="Ej: 2025" />
      </div>
      <div class="field col-6 boxed">
        <div class="lbl">Versi√≥n</div>
        <input id="capVersion" placeholder="Ej: 1" />
      </div>
      <div class="sub col-12">Estado API: <b id="apiMiniCap">‚Äî</b></div>
    </div>

    <div id="capInfo" class="sub" style="margin-bottom:10px">‚Äî</div>

    <div class="tableWrap">
      <table id="capTable">
        <thead>
          <tr>
            <th>No de personal</th>
            <th>Nombre</th>
            <th>Posici√≥n</th>
            <th>Departamento</th>
            <th>Periodo</th>
            <th>Versi√≥n</th>
            <th>Curso</th>
          </tr>
        </thead>
        <tbody id="capTbody">
          <tr><td colspan="7" class="sub">Presiona <b>Generar</b> para cargar el informe.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
    <section class="card" data-phase-block="DESARROLLO" id="blockDesarrollo">
  <div class="card-h">
    <div>
      <h2>Informe plan de desarrollo</h2>
      <div class="sub">Genera el plan por <b>No. de personal</b> + <b>Periodo</b> + <b>Versi√≥n</b>.</div>
    </div>
    <div class="controls">
      <button id="btnDevGenerar" class="btn-blue">Generar</button>
    </div>
  </div>

  <div class="card-b">
    <div class="hint" style="margin-bottom:12px">
      Se llena desde <b>EvaluacionFinal</b>: <b>Oportunidades de mejora</b> y <b>Proyecci√≥n y potencial de desarrollo</b>.
      (La magia es legal‚Ä¶ la burocracia no üòÑ)
    </div>

    <div class="form-grid" style="margin-bottom:12px">
      <div class="field col-12 boxed">
        <div class="lbl">Oportunidades de mejora (EvaluacionFinal)</div>
        <textarea id="devOportunidades" placeholder="Se llena al generar..." readonly></textarea>
      </div>

      <div class="field col-12 boxed">
        <div class="lbl">Proyecci√≥n y potencial de desarrollo (EvaluacionFinal)</div>
        <textarea id="devProyeccion" placeholder="Se llena al generar..." readonly></textarea>
      </div>
    </div>

    <!-- ‚úÖ ELIMINADO: devInfo (Mostrando: X filas | No | Periodo | Versi√≥n) -->
  </div>
</section>
  </div>
</main>
<script>
  /* ================= CONFIG ================= */
  const LS_KEY_ = "ED_WEBAPP_";
  const DEFAULT_COMENTARIOS_CLIENTES =
`Empezar a hacer:
Continuar haciendo:
Dejar de hacer:`;
  const DEFAULT_WEBAPP_ = "https://script.google.com/macros/s/AKfycbzv6Gk7kez5TO881d5S6DnQrKX5VRa49_ET7b-iasEyQ00_AdRrJpTHRa_xaeQYHC_a/exec";
  const $ = id => document.getElementById(id);

  function normalizeWebApp(raw){
    let v = String(raw || "").trim();
    if(!v) return DEFAULT_WEBAPP_;
    v = v.replace(/#.*$/, "");
    v = v.replace(/\s+/g, "");
    v = v.replace(/\/+$/, "");
    v = v.replace(/\/dev$/i, "/exec");
    if(/\/exec$/i.test(v)) return v;
    if(/script\.google\.com\/macros\/s\/[^/]+$/i.test(v)) return v + "/exec";
    const qm = v.indexOf("?");
    if(qm > -1){
      const base = v.slice(0, qm).replace(/\/+$/, "");
      const qs = v.slice(qm);
      if(/\/exec$/i.test(base)) return base + qs;
      if(/script\.google\.com\/macros\/s\/[^/]+$/i.test(base)) return base + "/exec" + qs;
    }
    return v;
  }
  function getWebApp(){
    const v = normalizeWebApp($("webapp").value);
    return v || DEFAULT_WEBAPP_;
  }
  function setWebApp(v){
    $("webapp").value = normalizeWebApp(v || "");
  }

  /* ================= STATE ================= */
    const state = {
    fase: "",
    nivel: null,
    form: null,
    answers: new Map(),
    itemKeys: [],
    lastFormItemsCount: 0,

    // ‚úÖ PESOS
    pesosItems: [],
    pesosDirty: false,

    // ‚úÖ RECOVER
    recovered: null,
    recoveredClientes: null,
    suppressAutoSyncSSC: false,

    // ‚úÖ RESULTADO
    resultadoCache: null,

    // ‚úÖ CAPACITACI√ìN
    capRows: []
  };

  /* ================= STATUS ================= */
  function setApiStatus(mode,text){
    const el=$("apiStatus");
    el.classList.remove("ok","err");
    if(mode) el.classList.add(mode);
    $("apiStatusText").textContent=text;

    const miniClientes = $("apiMini");
    if (miniClientes) miniClientes.textContent = text.replace("API: ","");
    const miniEval = $("apiMiniEval");
    if (miniEval) miniEval.textContent = text.replace("API: ","");
    const miniRes = $("apiMiniRes");
    if (miniRes) miniRes.textContent = text.replace("API: ","");
        const miniCap = $("apiMiniCap");
    if (miniCap) miniCap.textContent = text.replace("API: ","");
  }

  /* ================= JSONP API ================= */
 function build(params, cbName){
  const base = getWebApp();
  const url = new URL(base);

  Object.entries(params).forEach(([k,v]) => {
    url.searchParams.set(k, v);
  });

  url.searchParams.set("callback", cbName);
  url.searchParams.set("_", String(Date.now()));

  return url.toString();
}

  function apiGet(params, timeoutMs=15000){
    return new Promise((resolve,reject)=>{
      const cb="cb_"+Math.random().toString(36).slice(2);
      const src = build(params, cb);
      setApiStatus("", "API: consultando‚Ä¶");

      const s=document.createElement("script");
      s.async = true;
      s.referrerPolicy = "no-referrer";
      let done=false;

      const t=setTimeout(()=>{
        if(done) return;
        done=true;
        cleanup();
        reject(new Error("Timeout. La WebApp no respondi√≥. Abre Ping para verificar el deploy."));
      }, timeoutMs);

      function cleanup(){
        clearTimeout(t);
        try { delete window[cb]; } catch(_) { window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cb]=data=>{
        if(done) return;
        done=true;
        cleanup();
        if(!data || typeof data !== "object"){
          reject(new Error("Respuesta inv√°lida. Si al abrir Ping te pide login, el deploy no es p√∫blico."));
          return;
        }
        if(data.ok!==true){
          reject(new Error(data.error || "Respuesta inv√°lida"));
          return;
        }
        setApiStatus("ok","API: conectada");
        resolve(data);
      };

      s.onerror=()=>{
        if(done) return;
        done=true;
        cleanup();
        reject(new Error("No se pudo cargar el script. Revisa:  correcta (/exec), Deploy p√∫blico (Anyone), y desactiva bloqueadores para script.google.com."));
      };
      s.src = src;
      document.body.appendChild(s);
    });
  }

  /* ================= UTIL ================= */
  function todayLocal(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${dd}/${mm}/${yyyy}`;
  }
  function formatDateDMY(raw){
  const s = String(raw || "").trim();
  if(!s) return "";

  // ya viene dd/mm/yyyy o d/m/yyyy
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
    const [d,m,y] = s.split("/");
    return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")}/${y}`;
  }

  // viene yyyy-mm-dd o yyyy/mm/dd (t√≠pico de Sheets/inputs date)
  const m1 = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
  if(m1){
    const yyyy = m1[1];
    const mm = String(m1[2]).padStart(2,"0");
    const dd = String(m1[3]).padStart(2,"0");
    return `${dd}/${mm}/${yyyy}`;
  }

  // fallback: intenta parsear Date()
  const dt = new Date(s);
  if(!isNaN(dt.getTime())){
    const yyyy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,"0");
    const dd = String(dt.getDate()).padStart(2,"0");
    return `${dd}/${mm}/${yyyy}`;
  }

  // si no se puede, devuelve tal cual
  return s;
}
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  function fillNivelSelect(levels, includeAll=false){
    const sel = $("nivelSelect");
    sel.innerHTML = "";
    if(includeAll){
      const oAll = document.createElement("option");
      oAll.value = "ALL";
      oAll.textContent = "Todos";
      sel.appendChild(oAll);
    }
    levels.forEach(l=>{
      const v = String(l);
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });
  }
  function pickDefault(levels, includeAll){
    if(includeAll) return "ALL";
    const has1 = levels.some(x => String(x).trim() === "1" || String(x).trim().startsWith("1"));
    return has1
      ? String(levels.find(x => String(x).trim()==="1" || String(x).trim().startsWith("1")))
      : String(levels[0] ?? "1");
  }
  function getNivelRef(){
    const sel = $("nivelSelect");
    const opt = sel?.selectedOptions?.[0];
    const label = (opt?.textContent || String(sel.value || "")).trim();
    const value = String(sel.value || "").trim();
    return label || value;
  }
  function extractScore(v){
    const s = String(v||"").trim();
    const m = s.match(/^([1-5])\s*[\‚Äî\-]/) || s.match(/^([1-5])\b/);
    return m ? m[1] : "";
  }
  function toNum(n, def=0){
    const x = Number(String(n ?? "").replace(",", "."));
    return Number.isFinite(x) ? x : def;
  }
  function fmt2(n){
    const x = Number(n);
    if(!Number.isFinite(x)) return "‚Äî";
    return x.toFixed(2);
  }

  /* ================= PHASE HELPERS ================= */
   function isEvalPhase(){ return state.fase === "AUTO" || state.fase === "DESEMPENO"; }
  function isClientesPhase(){ return state.fase === "CLIENTES"; }
  function isDesempenoPhase(){ return state.fase === "DESEMPENO"; }
  function isAutoPhase(){ return state.fase === "AUTO"; }
  function isFormulariosPhase(){ return state.fase === "FORMULARIOS"; }
  function isPesosPhase(){ return state.fase === "PESOS"; }
  function isResultadoPhase(){ return state.fase === "RESULTADO"; }
  function isConsolidadoPhase(){ return state.fase === "CONSOLIDADO"; } // ‚úÖ NUEVO
  function isCapacitacionPhase(){ return state.fase === "CAPACITACION"; }
  function isDesarrolloPhase(){ return state.fase === "DESARROLLO"; } // ‚úÖ NUEVO
  function isTiposPhase(){ return state.fase === "TIPOS"; }
  
  /* ================= VALIDATION ================= */
  function getClientesRequiredFields(){
    return [
      $("noPersonal").value.trim(),
      $("nombre").value.trim(),
      $("posicion").value.trim(),
      $("depto").value.trim(),
      $("periodo").value.trim(),
      $("version").value.trim(),
      $("fecha").value.trim(),
      $("comentariosEvaluadorClientes").value.trim(),
      $("nombreEvaluador").value.trim(),
    ];
  }
  function getEvalHeaderRequiredFields(){
    return [
      $("noPersonalEval").value.trim(),
      $("nombreEval").value.trim(),
      $("posicionEval").value.trim(),
      $("deptoEval").value.trim(),
      $("periodoEval").value.trim(),
      $("versionEval").value.trim(),
      $("fechaEval").value.trim(),
    ];
  }
  function getDesempenoExtraRequiredFields(){
    const ids = [
      "comentariosColaborador",
      "evaluacionClientesDes",
      "fortalezas","oportunidadesMejora",
      "proyeccionPotencial","necesidadesCapacitacion",
      "justificacion","comentariosEvaluadorDes","nombreEvaluadorDes"
    ];
    return ids.map(id => String($(id)?.value || "").trim());
  }
  function isEvalComplete(){
    if(!isEvalPhase()) return false;
    if(getEvalHeaderRequiredFields().some(v => !v)) return false;
    if(isDesempenoPhase()){
      if(getDesempenoExtraRequiredFields().some(v => !v)) return false;
    } else if(isAutoPhase()){
      const c = String($("comentariosColaboradorAuto")?.value || "").trim();
      if(!c) return false;
    }
    const total = state.itemKeys.length;
    if(total === 0) return false;
    for(const k of state.itemKeys){
      const obj = state.answers.get(k);
      if(!obj || !obj.value || !obj.label) return false;
    }
    return true;
  }
  function isClientesComplete(){
    if(!isClientesPhase()) return false;
    return !getClientesRequiredFields().some(v => !v);
  }

    /* ================= UI STATE (BOTONES) ================= */
    function updateGuardarUIState(){
    const btnG = $("btnGuardar");
    const btnL = $("btnLimpiarEval");
    const btnR = $("btnRecuperar");
    const btnP = $("btnPrint");

    // ‚úÖ Limpiar se muestra en: EVAL / CLIENTES / RESULTADO / CONSOLIDADO
    const showLimpiar = isEvalPhase() || isClientesPhase() || isResultadoPhase() || isConsolidadoPhase();
    btnL.style.display = showLimpiar ? "inline-block" : "none";

    // ‚úÖ Recuperar se muestra en: DESEMPENO / RESULTADO / CONSOLIDADO
    btnR.style.display = (isDesempenoPhase() || isResultadoPhase() || isConsolidadoPhase()) ? "inline-block" : "none";

    // ‚úÖ Imprimir en: RESULTADO / CONSOLIDADO
    btnP.style.display = (isResultadoPhase() || isConsolidadoPhase()) ? "inline-block" : "none";

    // ‚úÖ Guardar (HEADER) solo debe verse en CLIENTES y EVAL
    const showGuardar = isClientesPhase() || isEvalPhase();
    btnG.style.display = showGuardar ? "inline-block" : "none";

    // si est√° oculto, igual lo dejamos deshabilitado por seguridad
    if(!showGuardar){
      btnG.disabled = true;
      return;
    }

    // ‚úÖ Guardar habilitado solo cuando corresponde
    if(isClientesPhase()){
      btnG.disabled = !isClientesComplete();
      return;
    }
    if(isEvalPhase()){
      btnG.disabled = !isEvalComplete();
      return;
    }

    btnG.disabled = true;
  }
  /* ================= PHASE UI ================= */
function setPhase(phase){
  state.fase = phase || "";

  // mostrar/ocultar bloques por fase
  document.querySelectorAll("[data-phase-block]").forEach(el=>{
    const p = el.getAttribute("data-phase-block");
    el.classList.toggle("show", p === state.fase);
  });

  // EVAL es ‚Äúvirtual‚Äù (AUTO o DESEMPENO)
  document.querySelectorAll('[data-phase-block="EVAL"]').forEach(el=>{
    el.classList.toggle("show", isEvalPhase());
  });

  // Nivel: oculto en CLIENTES/RESULTADO/CONSOLIDADO/CAPACITACION/DESARROLLO/TIPOS
  const nivelWrap = $("nivelWrap");
  if(nivelWrap){
    const hideNivel =
      isClientesPhase() || isResultadoPhase() || isConsolidadoPhase() ||
      isCapacitacionPhase() || isDesarrolloPhase() || isTiposPhase();
    nivelWrap.classList.toggle("hide", hideNivel);
  }

  // habilitar select nivel solo cuando toca
  const enableNivel = (isEvalPhase() || state.fase === "FORMULARIOS" || state.fase === "PESOS");
  if ($("nivelSelect")) $("nivelSelect").disabled = !enableNivel;

  // alternar bloque datos (EVAL vs RESULTADO/DESARROLLO/CONSOLIDADO)
  const evalWrap = $("datosEvalWrap");
  const resWrap  = $("datosResultadoWrap");
  if(evalWrap) evalWrap.style.display = isEvalPhase() ? "grid" : "none";
  if(resWrap)  resWrap.style.display  = (isResultadoPhase() || isDesarrolloPhase() || isConsolidadoPhase()) ? "grid" : "none";

  // ‚úÖ Mostrar/ocultar el bloque "Datos del colaborador" seg√∫n fase
  const blockDatos = $("blockDatos");
  if(blockDatos){
    const showDatos = isEvalPhase() || isResultadoPhase() || isDesarrolloPhase() || isConsolidadoPhase();
    blockDatos.style.display = showDatos ? "block" : "none";
  }
  
  // ayuda del bloque Datos
  const datosHelp = $("datosHelp");
  if(datosHelp){
    if(isResultadoPhase()){
      datosHelp.textContent = "Para Recuperar el resultado, llena: No personal + Periodo + Versi√≥n.";
    } else if(isDesarrolloPhase()){
      datosHelp.textContent = "Para Generar el plan de desarrollo, llena: No personal + Periodo + Versi√≥n.";
    } else if(isConsolidadoPhase()){
      datosHelp.textContent = "Para el Informe ejecutivo, llena: No personal + Periodo + Versi√≥n.";
    } else {
      datosHelp.textContent = "Completa la informaci√≥n y selecciona una opci√≥n (1‚Äì5) para cada √≠tem.";
    }
  }

  // si entro a DESARROLLO, limpio y recalculo el bot√≥n
  if(isDesarrolloPhase()){
    clearDesarrollo_();
  }
  updateDevGenerarState_();

  // ‚úÖ Bot√≥n ‚ÄúNuevo‚Äù solo donde se permite (no en Formularios/Pesos/Capacitaci√≥n/Desarrollo/Resultado/Consolidado)
  const hideNuevo =
    isEvalPhase() ||
    isClientesPhase() ||
    isResultadoPhase() ||
    isConsolidadoPhase() ||
    isFormulariosPhase() ||
    isPesosPhase() ||
    isCapacitacionPhase() ||
    isDesarrolloPhase();

  if ($("btnNuevo")) $("btnNuevo").style.display = hideNuevo ? "none" : "inline-block";

  // recalcular botones
  updateGuardarUIState();
  updatePesosSaveState();
  updateCapSaveState_();
  if(!isCapacitacionPhase() && $("btnCapGuardar")) $("btnCapGuardar").disabled = true;
}
  /* ================= EVAL: RENDER FORM ================= */
  function renderCuestionario(form){
    const root = $("cuestionario");
    root.innerHTML = "";
    state.itemKeys = [];

    if(!isEvalPhase()){
      root.innerHTML = `<div class="hint">Selecciona una fase evaluable para ver el cuestionario.</div>`;
      $("itemsCount").textContent = "Items: 0";
      $("completeHint").textContent = "Completado: 0/0";
      updateGuardarUIState();
      return;
    }
    if(!form || !form.factors || !form.factors.length){
      root.innerHTML = `<div class="hint">No hay √≠tems para este nivel.</div>`;
      $("itemsCount").textContent = "Items: 0";
      $("completeHint").textContent = "Completado: 0/0";
      updateGuardarUIState();
      return;
    }

    let totalItems = 0;
    form.factors.forEach((f, idxF)=>{
      const box = document.createElement("div");
      box.className = "factor";
      box.innerHTML = `<div class="factor-title">${idxF+1}. ${escapeHtml(f.factor || "Factor")}</div>`;

      (f.items || []).forEach((it, idxI)=>{
        totalItems++;
        const key = it.key;
        state.itemKeys.push(key);

        const current = state.answers.get(key)?.value || "";
        const r = it.rubrica || {};
        const letter = String.fromCharCode(65 + (idxI % 26));

        const row = document.createElement("div");
        row.className = "item-row";
        row.innerHTML = `
          <div class="item-left">
            <div class="item-name">${letter}. ${escapeHtml(it.item || "√çtem")}</div>
            <div class="item-sub">Selecciona 1‚Äì5 seg√∫n la r√∫brica.</div>
          </div>
          <div class="item-right">
            <div class="lbl">Puntaje (1‚Äì5)</div>
            <select data-key="${escapeAttr(key)}">
              <option value="" ${current==="" ? "selected":""}>Seleccionar‚Ä¶</option>
              <option value="1" ${current==="1" ? "selected":""}>1 ‚Äî ${escapeHtml(r["1"] ?? "")}</option>
              <option value="2" ${current==="2" ? "selected":""}>2 ‚Äî ${escapeHtml(r["2"] ?? "")}</option>
              <option value="3" ${current==="3" ? "selected":""}>3 ‚Äî ${escapeHtml(r["3"] ?? "")}</option>
              <option value="4" ${current==="4" ? "selected":""}>4 ‚Äî ${escapeHtml(r["4"] ?? "")}</option>
              <option value="5" ${current==="5" ? "selected":""}>5 ‚Äî ${escapeHtml(r["5"] ?? "")}</option>
            </select>
          </div>
        `;

        const sel = row.querySelector("select");
        sel.addEventListener("change", (e)=>{
          const k = e.target.getAttribute("data-key");
          const v = e.target.value;
          if(!v){
            state.answers.delete(k);
          } else {
            const label = e.target.selectedOptions?.[0]?.textContent?.trim() || v;
            state.answers.set(k, { value: v, label });
          }
          updateGuardarUIState();
        });

        box.appendChild(row);
      });

      root.appendChild(box);
    });

    $("itemsCount").textContent = `Items: ${totalItems}`;
    updateGuardarUIState();
  }

  /* ================= FORMULARIOS: TABLE ================= */
  function clearFormTable(){
    state.lastFormItemsCount = 0;
    $("formTableInfo").textContent = "‚Äî";
    $("formTableBody").innerHTML = `<tr><td colspan="8" class="sub">Presiona <b>Cargar</b> para ver la informaci√≥n.</td></tr>`;
  }
  function renderFormTable(items){
    const tbody = $("formTableBody");
    const count = Array.isArray(items) ? items.length : 0;
    state.lastFormItemsCount = count;

    const nivelLabel = getNivelRef();
    $("formTableInfo").textContent = `Mostrando: ${count} filas | Nivel seleccionado: ${nivelLabel}`;

    if(!count){
      tbody.innerHTML = `<tr><td colspan="8" class="sub">No hay datos para ese nivel.</td></tr>`;
      return;
    }

    tbody.innerHTML = items.map(r => {
      const n = escapeHtml(r.Nivel ?? "");
      const f = escapeHtml(r.Factor ?? "");
      const it = escapeHtml(r.Item ?? "");
      const d1 = escapeHtml(r["1"] ?? "");
      const d2 = escapeHtml(r["2"] ?? "");
      const d3 = escapeHtml(r["3"] ?? "");
      const d4 = escapeHtml(r["4"] ?? "");
      const d5 = escapeHtml(r["5"] ?? "");
      return `
        <tr>
          <td class="mono">${n}</td>
          <td>${f}</td>
          <td>${it}</td>
          <td>${d1}</td>
          <td>${d2}</td>
          <td>${d3}</td>
          <td>${d4}</td>
          <td>${d5}</td>
        </tr>
      `;
    }).join("");
  }
  async function loadFormulariosItems(){
    if(!isFormulariosPhase()){
      alert("Selecciona la fase Formularios.");
      return;
    }
    const nivel = String(state.nivel || $("nivelSelect").value || "ALL");
    const res = await apiGet({ action:"items", sheet:"Formularios", nivel });
    renderFormTable(res.items || []);
  }

  /* ================= ‚úÖ PESOS: TABLE (editable) ================= */
  function clearPesosTable(){
    state.pesosItems = [];
    state.pesosDirty = false;
    $("pesosTableInfo").textContent = "‚Äî";
    $("pesosTableBody").innerHTML = `<tr><td colspan="4" class="sub">Presiona <b>Cargar</b> para ver la informaci√≥n.</td></tr>`;
    updatePesosSaveState();
  }
  function renderPesosTable(items){
    const tbody = $("pesosTableBody");
    const arr = Array.isArray(items) ? items : [];
    state.pesosItems = arr.map(r => ({
      Nivel: r.Nivel ?? "",
      Factor: r.Factor ?? "",
      Item: r.Item ?? "",
      Peso: (r.Peso ?? "")
    }));
    state.pesosDirty = false;

    const count = state.pesosItems.length;
    $("pesosTableInfo").textContent = `Mostrando: ${count} filas | Nivel seleccionado: ${getNivelRef()}`;

    if(!count){
      tbody.innerHTML = `<tr><td colspan="4" class="sub">No hay datos para ese nivel.</td></tr>`;
      updatePesosSaveState();
      return;
    }

    tbody.innerHTML = state.pesosItems.map((r, idx) => {
      const n = escapeHtml(r.Nivel ?? "");
      const f = escapeHtml(r.Factor ?? "");
      const it = escapeHtml(r.Item ?? "");
      const p = escapeAttr(String(r.Peso ?? ""));

      return `
        <tr data-idx="${idx}">
          <td class="mono">${n}</td>
          <td>${f}</td>
          <td>${it}</td>
          <td>
            <input class="pesoInput" inputmode="decimal" placeholder="Ej: 10" value="${p}" />
            <div class="tdMuted">Edita y guarda</div>
          </td>
        </tr>
      `;
    }).join("");

    tbody.querySelectorAll("tr").forEach(tr=>{
      const idx = Number(tr.getAttribute("data-idx"));
      const input = tr.querySelector("input.pesoInput");
      if(!input) return;

      input.addEventListener("input", ()=>{
        state.pesosItems[idx].Peso = input.value;
        state.pesosDirty = true;
        updatePesosSaveState();
      });
      input.addEventListener("change", ()=>{
        state.pesosItems[idx].Peso = input.value;
        state.pesosDirty = true;
        updatePesosSaveState();
      });
    });

    updatePesosSaveState();
  }
  function updatePesosSaveState(){
    const btn = $("btnGuardarPesos");
    if(!btn) return;
    btn.disabled = !(isPesosPhase() && state.pesosDirty && state.pesosItems.length > 0);
  }
  async function loadPesosItems(){
    if(!isPesosPhase()){
      alert("Selecciona la fase Pesos.");
      return;
    }
    const nivel = String(state.nivel || $("nivelSelect").value || "ALL");
    const res = await apiGet({ action:"items", sheet:"Pesos", nivel });
    renderPesosTable(res.items || []);
  }
  async function savePesosItems(){
    if(!isPesosPhase()){
      alert("Selecciona la fase Pesos.");
      return;
    }
    if(!state.pesosDirty || !state.pesosItems.length){
      alert("No hay cambios para guardar.");
      return;
    }

    const nivel = String(state.nivel || $("nivelSelect").value || "ALL");
    const payload = {
      nivel: nivel,
      items: state.pesosItems.map(r => ({
        Nivel: String(r.Nivel ?? ""),
        Factor: String(r.Factor ?? ""),
        Item: String(r.Item ?? ""),
        Peso: String(r.Peso ?? "")
      }))
    };

    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const out = await apiGet({ action:"savePesos", payload:b64 });

    alert(`Pesos guardados ‚úÖ\nActualizados: ${out.updated ?? 0}\nNo encontrados: ${out.notFound ?? 0}`);
    state.pesosDirty = false;
    updatePesosSaveState();
    await loadPesosItems();
  }

  /* ================= LOADERS (levels + form) ================= */
  async function loadLevelsForPhase(){
    if(isEvalPhase()){
      const lv = await apiGet({action:"levels", sheet:"Formularios"});
      const levels = lv.levels || [];
      if(!levels.length) throw new Error("No se encontraron niveles en 'Formularios'.");
      fillNivelSelect(levels, false);
      const def = pickDefault(levels, false);
      $("nivelSelect").value = def;
      state.nivel = def;
      return;
    }
    if(state.fase === "FORMULARIOS"){
      const lv = await apiGet({action:"levels", sheet:"Formularios"});
      const levels = lv.levels || [];
      if(!levels.length) throw new Error("No se encontraron niveles en 'Formularios'.");
      fillNivelSelect(levels, true);
      const def = pickDefault(levels, true);
      $("nivelSelect").value = def;
      state.nivel = def;
      return;
    }
    if(state.fase === "PESOS"){
      const lv = await apiGet({action:"levels", sheet:"Pesos"});
      const levels = lv.levels || [];
      if(!levels.length) throw new Error("No se encontraron niveles en 'Pesos'.");
      fillNivelSelect(levels, true);
      const def = pickDefault(levels, true);
      $("nivelSelect").value = def;
      state.nivel = def;
      return;
    }
  }

  async function loadFormByNivel(nivel){
    const res = await apiGet({action:"form", nivel: String(nivel)});
    state.form = res.form || null;
    state.answers.clear();
    renderCuestionario(state.form);
  }

  /* ================= ‚úÖ RECUPERAR (DESEMPENO) ================= */
  function openRecoverModal(records, clientesCount){
    const back = $("recoverModalBack");
    const tbody = $("recoverTbody");

    const count = Array.isArray(records) ? records.length : 0;
    $("kpiAutoCount").textContent = String(count);
    $("kpiCliHit").textContent = String(clientesCount || 0);

    $("recoverSubtitle").textContent =
      `Encontrados: ${count} en Autoevaluacion (mismo No personal + Periodo + Versi√≥n).`;

    const sscFull = buildClientesResumen_(state.recoveredClientes || []);
    const sscPreview = String(sscFull || "").trim()
      ? (String(sscFull).slice(0,180) + (String(sscFull).length>180 ? "‚Ä¶" : ""))
      : "‚Äî";

    if(!count){
      tbody.innerHTML = `<tr><td colspan="11" class="sub">No se encontr√≥ Autoevaluaci√≥n con esos criterios.</td></tr>`;
    } else {
      tbody.innerHTML = records.map(r=>{
        const respCount = Array.isArray(r.respuestas) ? r.respuestas.length : 0;
        const respPreview =
          (r.respuestas || []).slice(0,4).join(" | ") + (respCount>4 ? ` | +${respCount-4}` : "");
        const fila = r.rowNumber ?? "‚Äî";

        return `
          <tr>
            <td>
              <button class="btn-ok pickBtn" data-pick="${escapeAttr(String(fila))}">Aplicar</button>
            </td>
            <td class="mono">${escapeHtml(fila)}</td>
            <td class="mono">${escapeHtml(r.no || "")}</td>
            <td>${escapeHtml(r.nombre || "")}</td>
            <td class="mono">${escapeHtml(r.periodo || "")}</td>
            <td class="mono">${escapeHtml(r.version || "")}</td>
            <td class="mono">${escapeHtml(r.fecha || "")}</td>
            <td>${escapeHtml(r.nivel || "")}</td>
            <td><div class="tdMuted">${escapeHtml(respPreview)}</div></td>
            <td><div class="tdMuted">${escapeHtml(String(r.comentarios||"").slice(0,120))}${String(r.comentarios||"").length>120?"‚Ä¶":""}</div></td>
            <td><div class="tdMuted">${escapeHtml(sscPreview)}</div></td>
          </tr>
        `;
      }).join("");

      tbody.querySelectorAll("button[data-pick]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const row = String(btn.getAttribute("data-pick"));
          const rec = records.find(x => String(x.rowNumber) === row) || records[0];
          await applyRecoveredRecord(rec);
          closeRecoverModal();
        });
      });
    }

    back.classList.add("show");
  }
  function closeRecoverModal(){
    $("recoverModalBack").classList.remove("show");
  }

  async function recoverSearch(){
    if(!isDesempenoPhase()){
      alert("Recuperar aplica en: Formulario de evaluaci√≥n del desempe√±o.");
      return;
    }
    const no = $("noPersonalEval").value.trim();
    const per = $("periodoEval").value.trim();
    const ver = $("versionEval").value.trim();
    if(!no || !per || !ver){
      alert("Para Recuperar, llena: No. de personal + Periodo + Versi√≥n.");
      return;
    }

    const res = await apiGet({ action:"recover", no, periodo: per, version: ver });
    const records = res.records || [];
    state.recoveredClientes = Array.isArray(res.clientes) ? res.clientes : [];
    openRecoverModal(records, state.recoveredClientes.length);
  }

  function buildClientesResumen_(clientesArr){
    const arr = Array.isArray(clientesArr) ? clientesArr : [];
    if(!arr.length) return "";

    const lines = arr.map((c, i)=>{
      const pre = String(c.evaluacionClientes || c.evaluacion_de_clientes || "").trim();
      if(pre) return `(${i+1}) ${pre}`;

      const evaluador = String(c.evaluador || "").trim() || "‚Äî";
      const comenzar  = String(c.comenzar  || "").trim() || "‚Äî";
      const parar     = String(c.parar     || "").trim() || "‚Äî";
      const continuar = String(c.continuar || "").trim() || "‚Äî";

      return `(${i+1}) Nombre del evaluador: ${evaluador} | Comenzar a hacer: ${comenzar} | Parar de hacer: ${parar} | Continuar haciendo: ${continuar}`;
    });

    return lines.join("\n").trim();
  }

  async function applyRecoveredRecord(rec){
    if(!rec) return;

    state.recovered = rec;

    $("noPersonalEval").value = rec.no || $("noPersonalEval").value;
    $("nombreEval").value = rec.nombre || "";
    $("posicionEval").value = rec.posicion || "";
    $("deptoEval").value = rec.depto || "";
    $("periodoEval").value = rec.periodo || $("periodoEval").value;
    $("versionEval").value = rec.version || $("versionEval").value;
    $("fechaEval").value = rec.fecha || $("fechaEval").value || todayLocal();

    const nivelLabel = String(rec.nivel || "").trim();
    if(nivelLabel){
      const sel = $("nivelSelect");
      const canon = (nivelLabel.match(/(\d+)/)?.[1] || "").trim();

      let foundValue = "";
      Array.from(sel.options).forEach(o=>{
        if(foundValue) return;
        if(String(o.value).trim() === nivelLabel) foundValue = o.value;
        else if(String(o.textContent).trim() === nivelLabel) foundValue = o.value;
        else {
          const oc = (String(o.value).match(/(\d+)/)?.[1] || String(o.textContent).match(/(\d+)/)?.[1] || "").trim();
          if(canon && oc === canon) foundValue = o.value;
        }
      });

      if(foundValue){
        sel.value = foundValue;
        state.nivel = foundValue;
      }
    }

    await loadFormByNivel(state.nivel || $("nivelSelect").value);

    const resp = Array.isArray(rec.respuestas) ? rec.respuestas : [];
    state.answers.clear();
    state.itemKeys.forEach((k, idx)=>{
      const label = String(resp[idx] ?? "").trim();
      const v = extractScore(label);
      if(v){
        state.answers.set(k, { value: v, label: label || v });
      }
    });
    renderCuestionario(state.form);

    $("comentariosColaborador").value = String(rec.comentarios || "").trim();

    const arr = Array.isArray(state.recoveredClientes) ? state.recoveredClientes : [];
    if(arr.length){
      $("evaluacionClientesDes").value = buildClientesResumen_(arr);
    } else {
      if(!String($("evaluacionClientesDes").value||"").trim()) $("evaluacionClientesDes").value = "";
    }

    updateGuardarUIState();
  }

  /* ================= ‚úÖ RESULTADO (RECUPERAR + CALC) ================= */
  function clearResultado(){
    if($("noPersonalRes")) $("noPersonalRes").value = "";
    if($("periodoRes")) $("periodoRes").value = "";
    if($("versionRes")) $("versionRes").value = "";
    if ($("resultadoMeta")) $("resultadoMeta").textContent = "‚Äî";
if ($("resultadoTbody")) $("resultadoTbody").innerHTML = `<tr><td colspan="3" class="sub">Usa <b>Recuperar</b> para cargar el reporte.</td></tr>`;
if ($("puntajeFinal")) $("puntajeFinal").value = "‚Äî";
if ($("printTextArea")) $("printTextArea").value = "";

    state.resultadoCache = null;
    updateGuardarUIState();
  }

  // ‚úÖ Obtiene 1 registro de EvaluacionFinal y construye el reporte:
  // - Factor/Item: desde el cuestionario del nivel usado
  // - Respuesta: selecci√≥n elegida (texto de EvaluacionFinal, ej "3 ‚Äî ...")
  // - Peso: de hoja Pesos (mismo nivel)
  // - Puntaje √≠tem: (selecci√≥n/5) * peso
  // - Puntaje final: suma de puntaje √≠tem
    // ‚úÖ RESULTADO: Recupera REPORTE completo desde Apps Script (EvaluacionFinal + Pesos + Formularios)
  // action:"result" devuelve:
  // { ok:true, header:{...}, rows:[...], puntajeFinal:"xx.xx", cualitativo:{...} }
  async function recoverResultado(){
    if(!isResultadoPhase()){
      alert("Selecciona la fase: Resultado evaluaci√≥n del desempe√±o.");
      return;
    }

    const no  = $("noPersonalRes").value.trim();
    const per = $("periodoRes").value.trim();
    const ver = $("versionRes").value.trim();

    if(!no || !per || !ver){
      alert("Para Recuperar el resultado, llena: No. de personal + Periodo + Versi√≥n.");
      return;
    }

    // ‚úÖ Llama a tu endpoint REAL
    const res = await apiGet({ action:"result", no, periodo: per, version: ver });

    const header = res.header || {};
    const rows = Array.isArray(res.rows) ? res.rows : [];
    const pf = res.puntajeFinal ?? "‚Äî";
    const cual = res.cualitativo || {};

    if(!rows.length){
      $("resultadoMeta").textContent = "No se pudo armar el reporte (sin filas).";
      $("resultadoTbody").innerHTML = `<tr><td colspan="5" class="sub">Sin datos.</td></tr>`;
      $("puntajeFinal").value = "‚Äî";
      return;
    }

    // ‚úÖ datos del colaborador (para PDF y texto)
const nombre   = String(header.nombre || "").trim();
const posicion = String(header.posicion || "").trim();
const depto    = String(header.depto || "").trim();
const fechaRaw = String(header.fecha || "").trim();
const fechaDMY = formatDateDMY(fechaRaw) || todayLocal();

if ($("repNo"))       $("repNo").value = no || "‚Äî";
if ($("repNombre"))   $("repNombre").value = nombre || "‚Äî";
if ($("repPosicion")) $("repPosicion").value = posicion || "‚Äî";

if ($("repDepto"))    $("repDepto").value = depto || "‚Äî";
if ($("repPeriodo"))  $("repPeriodo").value = per || "‚Äî";
if ($("repVersion"))  $("repVersion").value = ver || "‚Äî";
if ($("repFecha"))    $("repFecha").value = fechaDMY || "‚Äî";

    // ‚úÖ Tabla
    $("resultadoTbody").innerHTML = rows.map(r=>{
  return `
    <tr>
      <td>${escapeHtml(r.factor ?? "")}</td>
      <td>${escapeHtml(r.item ?? "")}</td>
      <td>${escapeHtml(r.respuesta ?? "‚Äî")}</td>
    </tr>
  `;
}).join("");

    // ‚úÖ Puntaje Final
    $("puntajeFinal").value = String(pf);

    // ‚úÖ Cualitativos (desde EvaluacionFinal)
    $("resJustificacion").value = String(cual.justificacion || "").trim();
    $("resEvalClientes").value  = String(cual.evaluacionClientes || "").trim();
    $("resComColab").value      = String(cual.comentariosColaborador || "").trim();
    $("resFortalezas").value    = String(cual.fortalezas || "").trim();
    $("resOportunidades").value = String(cual.oportunidadesMejora || "").trim();
    $("resProyeccion").value    = String(cual.proyeccionPotencial || "").trim();
    $("resCapacitacion").value  = String(cual.necesidadesCapacitacion || "").trim();
    $("resComEval").value       = String(cual.comentariosEvaluador || "").trim();
    $("resNomEval").value       = String(cual.nombreEvaluador || "").trim();

    // ‚úÖ Cache para imprimir (PDF/TXT)
    state.resultadoCache = {
      no, per, ver,
      header,
      rows,
      puntajeFinal: pf,
      cualitativo: cual
    };

    $("printTextArea").value = buildResultadoTexto_();
    updateGuardarUIState();
  }
  /* ================= ‚úÖ CAPACITACION (GENERAR + GUARDAR) ================= */
  function clearCapacitacion(){
    if($("capPeriodo")) $("capPeriodo").value = "";
    if($("capVersion")) $("capVersion").value = "";
    if($("capInfo")) $("capInfo").textContent = "‚Äî";
    if($("capTbody")) $("capTbody").innerHTML = `<tr><td colspan="7" class="sub">Presiona <b>Generar</b> para cargar el informe.</td></tr>`;
    state.capRows = [];
    updateCapSaveState_();
  }

  function updateCapSaveState_(){
    const btn = $("btnCapGuardar");
    if(!btn) return;
    btn.disabled = !(isCapacitacionPhase() && Array.isArray(state.capRows) && state.capRows.length > 0);
  }

    // ‚úÖ Explota cursos: "Excel, Power BI, SAP" -> ["Excel","Power BI","SAP"]
/* ================= ‚úÖ DESARROLLO (GENERAR) ================= */
/* ================= ‚úÖ DESARROLLO (GENERAR) ================= */
function clearDesarrollo_(){
  if($("devOportunidades")) $("devOportunidades").value = "";
  if($("devProyeccion")) $("devProyeccion").value = "";
  if($("devInfo")) $("devInfo").textContent = "‚Äî";
  if($("devTbody")) $("devTbody").innerHTML =
    `<tr><td colspan="5" class="sub">Presiona <b>Generar</b> para cargar el informe.</td></tr>`;
  updateDevGenerarState_();
}

function updateDevGenerarState_(){
  const btn = $("btnDevGenerar");
  if(!btn) return;

  const no  = $("noPersonalRes")?.value?.trim() || "";
  const per = $("periodoRes")?.value?.trim() || "";
  const ver = $("versionRes")?.value?.trim() || "";

  btn.disabled = !(isDesarrolloPhase() && no && per && ver);
}

function renderDesarrolloTable_(rows, no, per, ver){
  const arr = Array.isArray(rows) ? rows : [];

  if($("devInfo")){
    $("devInfo").textContent =
      `Mostrando: ${arr.length} filas | No: ${no || "‚Äî"} | Periodo: ${per || "‚Äî"} | Versi√≥n: ${ver || "‚Äî"}`;
  }

  if(!arr.length){
    $("devTbody").innerHTML = `<tr><td colspan="5" class="sub">Sin datos para ese No/Periodo/Versi√≥n.</td></tr>`;
    return;
  }

  $("devTbody").innerHTML = arr.map(r => `
    <tr>
      <td>${escapeHtml(r.area ?? "")}</td>
      <td>${escapeHtml(r.necesidad ?? "")}</td>
      <td>${escapeHtml(r.accion ?? "")}</td>
      <td class="mono">${escapeHtml(r.fechaObjetivo ?? "")}</td>
      <td>${escapeHtml(r.responsable ?? "")}</td>
    </tr>
  `).join("");
}

async function generarDesarrollo_(){
  if(!isDesarrolloPhase()){
    alert("Selecciona la fase: Informe plan de desarrollo.");
    return;
  }

  const no  = $("noPersonalRes").value.trim();
  const per = $("periodoRes").value.trim();
  const ver = $("versionRes").value.trim();

  if(!no || !per || !ver){
    alert("Para Generar, llena: No. de personal + Periodo + Versi√≥n.");
    return;
  }

  try{
    const res = await apiGet({ action:"desarrolloPlan", no, periodo: per, version: ver });

    // ‚úÖ llena textos tal cual vienen de EvaluacionFinal
    if($("devOportunidades")) $("devOportunidades").value = String(res.oportunidadesMejora || "").trim();
    if($("devProyeccion")) $("devProyeccion").value = String(res.proyeccionPotencial || "").trim();

    const rows = Array.isArray(res.rows) ? res.rows : [];
    renderDesarrolloTable_(rows, no, per, ver);
  }catch(err){
    setApiStatus("err","API: " + err.message);
  }
}

  function splitCursos_(txt){
    const s = String(txt ?? "").trim();
    if(!s) return [];
    // soporta coma, ; y saltos de l√≠nea
    return s
      .split(/[,;\n]+/g)
      .map(x => String(x).trim())
      .filter(Boolean);
  }

  function explodeCapRows_(rows){
    const arr = Array.isArray(rows) ? rows : [];
    const out = [];

    arr.forEach(r=>{
      const cursos = splitCursos_(r.curso);
      if(!cursos.length) return; // si est√° vac√≠o, no genera fila (coincide con tu tip del UI)
      cursos.forEach(c=>{
        out.push({
          ...r,
          curso: c
        });
      });
    });

    return out;
  }

  function renderCapacitacionTable_(rows, periodo, version){
    // ‚úÖ por si el backend a√∫n no explota, lo hacemos aqu√≠ tambi√©n
    const exploded = explodeCapRows_(rows);

    state.capRows = exploded;

    const count = exploded.length;
    if($("capInfo")) $("capInfo").textContent =
      `Mostrando: ${count} filas | Periodo: ${periodo || "‚Äî"} | Versi√≥n: ${version || "‚Äî"}`;

    if(!count){
      $("capTbody").innerHTML = `<tr><td colspan="7" class="sub">Sin datos para ese Periodo/Versi√≥n.</td></tr>`;
      updateCapSaveState_();
      return;
    }

    $("capTbody").innerHTML = exploded.map(r => `
      <tr>
        <td class="mono">${escapeHtml(r.no ?? "")}</td>
        <td>${escapeHtml(r.nombre ?? "")}</td>
        <td>${escapeHtml(r.posicion ?? "")}</td>
        <td>${escapeHtml(r.depto ?? "")}</td>
        <td class="mono">${escapeHtml(r.periodo ?? "")}</td>
        <td class="mono">${escapeHtml(r.version ?? "")}</td>
        <td>${escapeHtml(r.curso ?? "")}</td>
      </tr>
    `).join("");

    updateCapSaveState_();
  }

  async function generarCapacitacion_(){
    if(!isCapacitacionPhase()){
      alert("Selecciona la fase: Informe necesidades de capacitaci√≥n.");
      return;
    }
    const periodo = $("capPeriodo").value.trim();
    const version = $("capVersion").value.trim();
    if(!periodo || !version){
      alert("Para Generar, llena: Periodo + Versi√≥n.");
      return;
    }

    const res = await apiGet({ action:"capacitacionList", periodo, version });
    const rows = Array.isArray(res.rows) ? res.rows : [];
    renderCapacitacionTable_(rows, periodo, version);
  }

  async function guardarCapacitacion_(){
    if(!isCapacitacionPhase()){
      alert("Selecciona la fase: Informe necesidades de capacitaci√≥n.");
      return;
    }
    const periodo = $("capPeriodo").value.trim();
    const version = $("capVersion").value.trim();
    if(!periodo || !version){
      alert("Para Guardar, llena: Periodo + Versi√≥n.");
      return;
    }
    if(!state.capRows || !state.capRows.length){
      alert("No hay filas para guardar. Primero presiona Generar.");
      return;
    }

    const payload = {
      periodo,
      version,
      rows: state.capRows
    };

    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const out = await apiGet({ action:"capacitacionSave", payload:b64 });

    alert(`Guardado ‚úÖ\nHoja: ${out.sheet || "Plancapacitacion"}\nFilas: ${out.rows || 0}`);
  }
  
  /* ================= CLEAR ================= */
  function clearClientes(){
    ["noPersonal","nombre","posicion","depto","periodo","version"].forEach(id=>$(id).value="");
    $("comentariosEvaluadorClientes").value = DEFAULT_COMENTARIOS_CLIENTES;
    $("nombreEvaluador").value = "";
    $("fecha").value = todayLocal();
    updateGuardarUIState();
  }

  function clearDesempenoExtra(){
    [
      "comentariosColaborador","evaluacionClientesDes","fortalezas","oportunidadesMejora",
      "proyeccionPotencial","necesidadesCapacitacion","justificacion","comentariosEvaluadorDes","nombreEvaluadorDes"
    ].forEach(id=>{
      const el = $(id);
      if(el) el.value = "";
    });
    state.recovered = null;
    state.recoveredClientes = null;
  }
  function clearAutoExtra(){
    const el = $("comentariosColaboradorAuto");
    if(el) el.value = "";
  }
  function clearEval(){
    ["noPersonalEval","nombreEval","posicionEval","deptoEval","periodoEval","versionEval"].forEach(id=>$(id).value="");
    $("fechaEval").value = todayLocal();
    state.answers.clear();
    renderCuestionario(state.form);
    clearDesempenoExtra();
    clearAutoExtra();
    updateGuardarUIState();
  }

  /* ================= SAVE ================= */
  async function saveClientes(){
    if(!isClientesPhase()){
      alert("Para guardar Clientes, selecciona la fase Formulario de evaluaci√≥n de clientes.");
      return;
    }
    if(!isClientesComplete()){
      alert("A√∫n faltan campos. Completa todo para habilitar Guardar.");
      return;
    }
    const payload = {
      fase: "CLIENTES",
      no: $("noPersonal").value.trim(),
      nombre: $("nombre").value.trim(),
      posicion: $("posicion").value.trim(),
      depto: $("depto").value.trim(),
      periodo: $("periodo").value.trim(),
      version: $("version").value.trim(),
      fecha: $("fecha").value.trim(),
      comentariosEvaluador: $("comentariosEvaluadorClientes").value.trim(),
      evaluador: $("nombreEvaluador").value.trim()
    };
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const out = await apiGet({action:"save", payload:b64});
    alert("Guardado ‚úÖ\nID: " + (out.id || "‚Äî"));
    clearClientes();
  }

  function buildCompatComentarios(){
    if(!isDesempenoPhase()) return "";
    return ($("justificacion")?.value || "").trim();
  }

  async function saveEval(){
    if(!isEvalPhase()){
      alert("Para guardar, usa Autoevaluaci√≥n o Evaluaci√≥n del desempe√±o.");
      return;
    }
    if(!isEvalComplete()){
      alert("A√∫n faltan datos / respuestas" + (isDesempenoPhase() ? " / comentarios" : " / comentarios del colaborador") + ". Completa todo para habilitar Guardar.");
      return;
    }

        const nivelRef = getNivelRef();
    const RESP_MAX = 20;

    // ‚úÖ Enviamos DOS versiones:
    // - respuestas (texto "3 ‚Äî ...") para compatibilidad
    // - respuestasNum (solo 1-5) para calcular puntaje final sin ‚Äúadivinar‚Äù
    const respuestasOrdenadasRaw = state.itemKeys.map(k => (state.answers.get(k)?.label || ""));
    const respuestasNumRaw       = state.itemKeys.map(k => (state.answers.get(k)?.value || ""));

    const respuestasOrdenadas = Array.from({length: RESP_MAX}, (_, i) => String(respuestasOrdenadasRaw[i] ?? "").trim());
    const respuestasNum       = Array.from({length: RESP_MAX}, (_, i) => String(respuestasNumRaw[i] ?? "").trim());

    const comentariosAuto = isAutoPhase() ? ($("comentariosColaboradorAuto")?.value || "").trim() : "";
    const extrasDesempeno = isDesempenoPhase() ? {
      comentariosColaborador: ($("comentariosColaborador")?.value || "").trim(),
      evaluacionClientes: ($("evaluacionClientesDes")?.value || "").trim(),
      fortalezas: ($("fortalezas")?.value || "").trim(),
      oportunidadesMejora: ($("oportunidadesMejora")?.value || "").trim(),
      proyeccionPotencial: ($("proyeccionPotencial")?.value || "").trim(),
      necesidadesCapacitacion: ($("necesidadesCapacitacion")?.value || "").trim(),
      justificacion: buildCompatComentarios(),
      comentariosEvaluador: ($("comentariosEvaluadorDes")?.value || "").trim(),
      nombreEvaluador: ($("nombreEvaluadorDes")?.value || "").trim()
    } : null;

    const extrasAuto = isAutoPhase() ? { comentariosColaborador: comentariosAuto } : null;

        const payload = {
      fase: state.fase,
      nivel: nivelRef,
      no: $("noPersonalEval").value.trim(),
      nombre: $("nombreEval").value.trim(),
      posicion: $("posicionEval").value.trim(),
      depto: $("deptoEval").value.trim(),
      periodo: $("periodoEval").value.trim(),
      version: $("versionEval").value.trim(),
      fecha: $("fechaEval").value.trim(),

      // ‚úÖ Se guardan ambas:
      respuestas: respuestasOrdenadas,
      respuestasNum: respuestasNum,

      comentarios: isAutoPhase() ? comentariosAuto : buildCompatComentarios(),
      extras: isDesempenoPhase() ? extrasDesempeno : (isAutoPhase() ? extrasAuto : null)
    };

    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const out = await apiGet({action:"save", payload:b64});

    if(isDesempenoPhase()){
      alert("Guardado ‚úÖ (EvaluacionFinal)\nID: " + (out.id || "‚Äî"));
    } else {
      alert("Guardado ‚úÖ (Autoevaluacion)\nID: " + (out.id || "‚Äî"));
    }

    clearEval();
  }

  function doGuardar(){
    if(isClientesPhase()) return saveClientes();
    if(isEvalPhase()) return saveEval();
    alert("No hay nada que guardar en esta fase (usa el Guardar interno en Pesos).");
  }
  function doLimpiar(){
    if(isClientesPhase()) return clearClientes();
    if(isEvalPhase()) return clearEval();
    if(isResultadoPhase()) return clearResultado();
  }

  /* ================= IMPRESI√ìN (RESULTADO) ================= */
  function openPrintModal(){
    $("printModalBack").classList.add("show");
    if(String($("printTextArea").value||"").trim() === ""){
      $("printTextArea").value = buildResultadoTexto_();
    }
  }
  function closePrintModal(){
    $("printModalBack").classList.remove("show");
  }

function buildResultadoTexto_(){
  const no  = $("repNo")?.value?.trim() || $("noPersonalRes")?.value?.trim() || "‚Äî";
  const per = $("repPeriodo")?.value?.trim() || $("periodoRes")?.value?.trim() || "‚Äî";
  const ver = $("repVersion")?.value?.trim() || $("versionRes")?.value?.trim() || "‚Äî";
  const pf  = $("puntajeFinal")?.value || "‚Äî";

  const nombre   = $("repNombre")?.value?.trim() || "‚Äî";
  const posicion = $("repPosicion")?.value?.trim() || "‚Äî";
  const depto    = $("repDepto")?.value?.trim() || "‚Äî";
  const fecha    = $("repFecha")?.value?.trim() || "‚Äî";

  let out = `REPORTE DE EVALUACI√ìN DEL DESEMPE√ëO\n\n`;

  // ‚úÖ datos del colaborador(2 filas)
  out += `No. de personal: ${no} | Nombre: ${nombre} | Posici√≥n: ${posicion}\n`;
  out += `Departamento: ${depto} | Periodo: ${per} | Versi√≥n: ${ver} | Fecha: ${fecha}\n`;
  out += `Puntaje final: ${pf}\n\n`;

  out += `DETALLE POR √çTEM:\n`;
  const trs = Array.from($("resultadoTbody")?.querySelectorAll("tr") || []);
  trs.forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    if(tds.length === 3){
      const factor = tds[0].innerText.trim();
      const item   = tds[1].innerText.trim();
      const resp   = tds[2].innerText.trim();
      out += `- ${factor} | ${item} | Resp: ${resp}\n`;
    }
  });

  out += `\nCUALITATIVO (EVALUACIONFINAL):\n`;
  out += `Justificaci√≥n y comentarios:\n${($("resJustificacion")?.value || "").trim()}\n\n`;
  out += `Evaluaci√≥n de clientes (SSC):\n${($("resEvalClientes")?.value || "").trim()}\n\n`;
  out += `Comentarios del colaborador:\n${($("resComColab")?.value || "").trim()}\n\n`;
  out += `Fortalezas:\n${($("resFortalezas")?.value || "").trim()}\n\n`;
  out += `Oportunidades de mejora:\n${($("resOportunidades")?.value || "").trim()}\n\n`;
  out += `Proyecci√≥n y potencial de desarrollo:\n${($("resProyeccion")?.value || "").trim()}\n\n`;
  out += `Necesidades de capacitaci√≥n:\n${($("resCapacitacion")?.value || "").trim()}\n\n`;
  out += `Comentarios del evaluador:\n${($("resComEval")?.value || "").trim()}\n\n`;
  out += `Nombre del evaluador: ${($("resNomEval")?.value || "").trim()}\n`;

  return out.trim();
}

/* ================= ‚úÖ TIPOS (MODAL) ================= */
const TIPOS_DATA = [
  {
    n: 1,
    nombre: "Operativo B√°sico",
    desc: "Puestos de ejecuci√≥n directa con tareas estandarizadas y baja complejidad t√©cnica. Requieren supervisi√≥n constante y siguen instrucciones definidas. Tienen escasa autonom√≠a y bajo impacto estrat√©gico.",
    ej: "Auxiliar de limpieza, operario de producci√≥n, mensajero, auxiliar de bodega."
  },
  {
    n: 2,
    nombre: "Operativo de Apoyo",
    desc: "Puestos que brindan soporte a procesos operativos o administrativos. Ejecutan tareas bajo lineamientos definidos con autonom√≠a limitada. Su impacto es indirecto pero necesario para el funcionamiento del √°rea.",
    ej: "Auxiliar administrativo, asistente de compras, auxiliar contable, soporte b√°sico."
  },
  {
    n: 3,
    nombre: "Operativo Calificado",
    desc: "Puestos operativos con conocimientos t√©cnicos espec√≠ficos y tareas especializadas. Resuelven problemas dentro de su √°mbito t√©cnico con menor supervisi√≥n. Tienen mayor responsabilidad t√©cnica y capacidad de decisi√≥n operativa.",
    ej: "T√©cnico en mantenimiento, operador especializado, t√©cnico de redes, analista junior de laboratorio."
  },
  {
    n: 4,
    nombre: "T√©cnico / Administrativo Junior",
    desc: "Puestos con formaci√≥n t√©cnica o profesional inicial que gestionan procesos espec√≠ficos. Realizan an√°lisis b√°sicos y aplican herramientas t√©cnicas bajo lineamientos definidos. Poseen autonom√≠a moderada y participan en mejoras operativas.",
    ej: "Analista administrativo junior, contador junior, t√©cnico en RRHH, analista de datos junior."
  },
  {
    n: 5,
    nombre: "T√©cnico / Administrativo Senior",
    desc: "Puestos con dominio t√©cnico avanzado y gesti√≥n integral de procesos. Toman decisiones operativas con alto nivel de autonom√≠a. Pueden supervisar personal y asesorar t√©cnicamente a otros.",
    ej: "Analista senior financiero, coordinador t√©cnico, especialista en n√≥mina, supervisor de laboratorio."
  },
  {
    n: 6,
    nombre: "Profesional Junior",
    desc: "Puestos profesionales con formaci√≥n universitaria y responsabilidad sobre proyectos definidos. Realizan an√°lisis estructurado y proponen mejoras en su √°rea. Tienen autonom√≠a t√©cnica progresiva e impacto relevante en resultados.",
    ej: "Ingeniero junior, psic√≥logo organizacional junior, microbi√≥logo junior, analista de planificaci√≥n."
  },
  {
    n: 7,
    nombre: "Profesional Senior / Especialista",
    desc: "Puestos de alta especializaci√≥n t√©cnica o funcional. Act√∫an como referentes expertos e influyen en decisiones estrat√©gicas. Poseen elevada autonom√≠a y responsabilidad por est√°ndares t√©cnicos.",
    ej: "Especialista en DO, ingeniero senior, especialista en calidad, especialista en IA aplicada."
  },
  {
    n: 8,
    nombre: "Jefatura / Coordinaci√≥n",
    desc: "Puestos con responsabilidad directa sobre equipos y metas operativas. Asignan tareas, supervisan desempe√±o y gestionan indicadores. Impactan en resultados del √°rea y clima laboral.",
    ej: "Jefe de RRHH, coordinador de producci√≥n, jefe de laboratorio, coordinador administrativo."
  },
  {
    n: 9,
    nombre: "Subgerencia / Gerencia de √Årea",
    desc: "Puestos de liderazgo t√°ctico-estrat√©gico responsables de resultados integrales del √°rea. Gestionan presupuesto, planificaci√≥n y cumplimiento de metas. Toman decisiones de impacto medio-alto y reportan a alta direcci√≥n.",
    ej: "Gerente de RRHH, gerente de operaciones, subgerente comercial, gerente de calidad."
  },
  {
    n: 10,
    nombre: "Gerencia Funcional",
    desc: "Puestos estrat√©gicos que definen pol√≠ticas y lineamientos organizacionales. Impactan directamente en la sostenibilidad y resultados globales del negocio. Ejercen liderazgo transversal y alta toma de decisiones.",
    ej: "Director de RRHH, CFO, COO, director t√©cnico."
  }
];

function renderTiposTable_(){
  const tb = $("tiposTbody");
  if(!tb) return;

  tb.innerHTML = TIPOS_DATA.map(t => `
    <tr>
      <td class="mono">${escapeHtml(t.n)}</td>
      <td><b>${escapeHtml(t.nombre)}</b></td>
      <td>${escapeHtml(t.desc)}</td>
      <td>${escapeHtml(t.ej)}</td>
    </tr>
  `).join("");
}

function openTiposModal_(){
  renderTiposTable_();
  $("tiposModalBack")?.classList.add("show");
}

function closeTiposModal_(){
  $("tiposModalBack")?.classList.remove("show");
}
  
  /* ================= EVENTS ================= */
  $("webapp").addEventListener("change", ()=>{
    const v = normalizeWebApp($("webapp").value);
    $("webapp").value = v;
    localStorage.setItem(LS_KEY_, v);
  });

  $("btnAbrirPing")?.addEventListener("click", ()=>{
    const base = getWebApp();
    const raw = base + (base.includes("?") ? "&" : "?") + "action=ping&_=" + Date.now();
    window.open(raw, "_blank", "noopener,noreferrer");
  });

  $("btnProbarApi")?.addEventListener("click", async ()=>{
    try{
      await apiGet({action:"ping"});
      setApiStatus("ok","API: conectada");
    }catch(e){
      setApiStatus("err","API: " + e.message);
    }
  });

   // ‚úÖ CONSOLIDADO (Informe ejecutivo): de momento solo UI.
  // Si ya tienes tu endpoint, aqu√≠ conectas el action correspondiente.
  async function recoverConsolidado_(){
    alert("Informe ejecutivo: UI lista ‚úÖ\nFalta conectar el action del backend (ej: action='consolidado').");
  }

  $("btnRecuperar").addEventListener("click", ()=>{
    const fn =
      isResultadoPhase() ? recoverResultado :
      (isConsolidadoPhase() ? recoverConsolidado_ : recoverSearch);

    fn().catch(err=>setApiStatus("err","API: " + err.message));
  });

  $("btnLimpiarEval").addEventListener("click", doLimpiar);

  $("btnPrint").addEventListener("click", openPrintModal);
  $("btnPrintClose").addEventListener("click", closePrintModal);
  $("printModalBack").addEventListener("click", (e)=>{
    if(e.target === $("printModalBack")) closePrintModal();
  });

  /* ‚úÖ TIPOS MODAL EVENTS */
$("btnTiposClose")?.addEventListener("click", closeTiposModal_);
$("tiposModalBack")?.addEventListener("click", (e)=>{
  if(e.target === $("tiposModalBack")) closeTiposModal_();
});

  $("btnPrintPDF").addEventListener("click", ()=>{
    closePrintModal();
    window.print();
  });
  $("btnPrintTXT").addEventListener("click", ()=>{
    $("printTextArea").value = buildResultadoTexto_();
  });
  $("btnCopyText").addEventListener("click", async ()=>{
    const txt = $("printTextArea").value || "";
    try{
      await navigator.clipboard.writeText(txt);
      alert("Copiado ‚úÖ");
    }catch(_){
      $("printTextArea").select();
      document.execCommand("copy");
      alert("Copiado ‚úÖ");
    }
  });

  $("btnRecoverClose").addEventListener("click", closeRecoverModal);
  $("recoverModalBack").addEventListener("click", (e)=>{
    if(e.target === $("recoverModalBack")) closeRecoverModal();
  });

  $("faseSelect").addEventListener("change", async (e)=>{
    const fase = e.target.value;
    setPhase(fase);
if(fase === "TIPOS"){
      openTiposModal_();
      return; // no carga niveles ni nada m√°s
    }
  
    try{
      if(isEvalPhase() || fase === "FORMULARIOS" || fase === "PESOS"){
        await loadLevelsForPhase();
      }

      if(fase === "FORMULARIOS"){
        clearFormTable();
      }

      if(fase === "PESOS"){
        clearPesosTable();
      }

      if(isEvalPhase()){
        await loadFormByNivel(state.nivel);
        updateGuardarUIState();
      }

      // ‚úÖ al entrar a RESULTADO: no necesitamos niveles, solo UI correcta
      if(isResultadoPhase()){
        updateGuardarUIState();
      }

    }catch(err){
      setApiStatus("err","API: " + err.message);
    }
  });

  $("nivelSelect").addEventListener("change", async (e)=>{
    try{
      state.nivel = e.target.value;

      if(isEvalPhase()){
        await loadFormByNivel(state.nivel);
        updateGuardarUIState();
      }

      if(isFormulariosPhase()){
        $("formTableInfo").textContent = `Nivel cambiado a: ${getNivelRef()} (presiona Cargar)`;
      }

      if(isPesosPhase()){
        $("pesosTableInfo").textContent = `Nivel cambiado a: ${getNivelRef()} (presiona Cargar)`;
        updatePesosSaveState();
      }
    }catch(err){
      setApiStatus("err","API: " + err.message);
    }
  });

  $("btnGuardar").addEventListener("click", ()=>doGuardar().catch(err=>setApiStatus("err","API: " + err.message)));

  $("btnNuevo").addEventListener("click", ()=>{
    clearClientes();
    clearEval();
    clearResultado();
    clearFormTable();
    clearPesosTable();
  });

  // FORMULARIOS
  $("btnCargarForm").addEventListener("click", ()=>loadFormulariosItems().catch(err=>setApiStatus("err","API: " + err.message)));
  $("btnLimpiarForm").addEventListener("click", clearFormTable);

  // ‚úÖ PESOS
  $("btnCargarPesos").addEventListener("click", ()=>loadPesosItems().catch(err=>setApiStatus("err","API: " + err.message)));
  $("btnLimpiarPesos").addEventListener("click", clearPesosTable);
  $("btnGuardarPesos").addEventListener("click", ()=>savePesosItems().catch(err=>setApiStatus("err","API: " + err.message)));

  // ‚úÖ CAPACITACION
  $("btnCapGenerar")?.addEventListener("click", ()=>generarCapacitacion_().catch(err=>setApiStatus("err","API: " + err.message)));
  $("btnCapGuardar")?.addEventListener("click", ()=>guardarCapacitacion_().catch(err=>setApiStatus("err","API: " + err.message)));
  // ‚úÖ DESARROLLO
$("btnDevGenerar")?.addEventListener("click", ()=>generarDesarrollo_().catch(err=>setApiStatus("err","API: " + err.message)));

  ["capPeriodo","capVersion"].forEach(id=>{
    const el = $(id);
    if(el){
      el.addEventListener("input", updateCapSaveState_);
      el.addEventListener("change", updateCapSaveState_);
    }
  });
  
  // watchers CLIENTES
  [
    "noPersonal","nombre","posicion","depto","periodo","version","fecha",
    "comentariosEvaluadorClientes","nombreEvaluador"
  ].forEach(id=>{
    const el = $(id);
    if(el){
      el.addEventListener("input", updateGuardarUIState);
      el.addEventListener("change", updateGuardarUIState);
    }
  });

  // watchers EVAL
  ["noPersonalEval","nombreEval","posicionEval","deptoEval","periodoEval","versionEval","fechaEval"].forEach(id=>{
    const el = $(id);
    if(el){
      el.addEventListener("input", updateGuardarUIState);
      el.addEventListener("change", updateGuardarUIState);
    }
  });
  [
    "comentariosColaborador","evaluacionClientesDes","fortalezas","oportunidadesMejora",
    "proyeccionPotencial","necesidadesCapacitacion","justificacion","comentariosEvaluadorDes","nombreEvaluadorDes"
  ].forEach(id=>{
    const el = $(id);
    if(el){
      el.addEventListener("input", updateGuardarUIState);
      el.addEventListener("change", updateGuardarUIState);
    }
  });
  ["comentariosColaboradorAuto"].forEach(id=>{
    const el = $(id);
    if(el){
      el.addEventListener("input", updateGuardarUIState);
      el.addEventListener("change", updateGuardarUIState);
    }
  });
      if(isCapacitacionPhase()){
        clearCapacitacion();
        updateCapSaveState_();
      }
  
  // watchers RESULTADO
  ["noPersonalRes","periodoRes","versionRes"].forEach(id=>{
  const el = $(id);
  if(el){
    el.addEventListener("input", ()=>{
      updateGuardarUIState();
      updateDevGenerarState_(); // ‚úÖ NUEVO
    });
    el.addEventListener("change", ()=>{
      updateGuardarUIState();
      updateDevGenerarState_(); // ‚úÖ NUEVO
    });
  }
});

  /* ================= BOOT ================= */
  (function boot(){
    $("fecha").value = todayLocal();
    $("fechaEval").value = todayLocal();

    const tCli = $("comentariosEvaluadorClientes");
    if (tCli && !String(tCli.value || "").trim()) tCli.value = DEFAULT_COMENTARIOS_CLIENTES;

    setPhase("");
    clearFormTable();
    clearPesosTable();
    clearResultado();
    clearCapacitacion();

    const saved = localStorage.getItem(LS_KEY_);
    setWebApp(saved || DEFAULT_WEBAPP_);

    apiGet({action:"ping"})
      .then(()=>{
        setApiStatus("ok","API: conectada");
        $("cuestionario").innerHTML = `<div class="hint">Selecciona una fase para iniciar.</div>`;
      })
      .catch(async (e1)=>{
        setApiStatus("err","API: "+e1.message + " (reintentando con  por defecto)");

        setWebApp(DEFAULT_WEBAPP_);
        localStorage.setItem(LS_KEY_, DEFAULT_WEBAPP_);

        try{
          await apiGet({action:"ping"});
          setApiStatus("ok","API: conectada");
          $("cuestionario").innerHTML = `<div class="hint">Selecciona una fase para iniciar.</div>`;
        }catch(e2){
          setApiStatus("err","API: "+e2.message);
        }
      });

   updateGuardarUIState();
updatePesosSaveState();

updateCapSaveState_();
updateDevGenerarState_(); // ‚úÖ NUEVO
  })();
</script>
</body>
</html>

 
