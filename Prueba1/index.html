<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Evaluaci√≥n del Desempe√±o</title>
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#121f3d;
      --text:#e8eefc; --muted:#a9b7d9; --line:rgba(255,255,255,.10);
      --accent:#4f7cff; --accent2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1a2a52; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius2: 22px; --mono: ui-monospace, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--sans);color:var(--text);min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(79,124,255,.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
        var(--bg);
    }
    header{
      position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
      background:rgba(11,18,32,.75);border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:16px 18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px rgba(79,124,255,.18)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,button{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px}
    select{min-width:280px}
    button{cursor:pointer}
    .btn-ok{background:linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.10));border-color:rgba(34,197,94,.35)}
    .btn-ghost{background:transparent}
    main{padding:18px}
    .grid{max-width:1180px;margin:0 auto;display:grid;gap:14px}
    .card{
      background:linear-gradient(180deg, rgba(18,31,61,.9), rgba(15,27,51,.92));
      border:1px solid var(--line);border-radius:var(--radius2);box-shadow:var(--shadow);overflow:hidden;
    }
    .card-h{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .card-h h2{margin:0;font-size:16px}
    .sub{color:var(--muted);font-size:13px}
    .card-b{padding:14px 16px}
    .chip{background:rgba(26,42,82,.75);border:1px solid rgba(255,255,255,.10);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .status{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:12px;color:var(--muted)}
    .status .s-dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .status.ok .s-dot{background:var(--accent2)}
    .status.err .s-dot{background:var(--danger)}
    .hidden{display:none}
    .table-wrap{overflow:auto;border-radius:14px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:13px;vertical-align:top}
    th{background:rgba(15,27,51,.85);color:var(--muted);position:sticky;top:0}
    small{color:var(--muted)}
    .hint{background:rgba(79,124,255,.10);border:1px dashed rgba(79,124,255,.35);padding:10px 12px;border-radius:14px;color:var(--muted);font-size:13px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          Sistema de Evaluaci√≥n del Desempe√±o
          <div class="sub">GitHub Pages + Google Apps Script</div>
        </div>
      </div>

      <div class="controls">
        <label class="sub">Fase</label>
        <select id="fase"></select>
        <span id="apiStatus" class="status">
          <span class="s-dot"></span>
          <span id="apiStatusText">API: sin probar</span>
        </span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section id="secFormularios" class="card hidden">
      <div class="card-h">
        <div>
          <h2>Formularios</h2>
          <div class="sub">Hoja Formularios (Nivel, Factor, Item, 1..5)</div>
        </div>
        <div>
          <span class="chip" id="fCountChip">Items: 0</span>
          <select id="fNivelSelect"></select>
          <button id="btnFormCargar" class="btn-ok">Cargar</button>
          <button id="btnFormLimpiar" class="btn-ghost">Limpiar</button>
        </div>
      </div>
      <div class="card-b">
        <div class="hint">‚ÄúLimpiar‚Äù solo limpia la vista üòÖ</div><br>
        <div class="table-wrap">
          <table id="tblFormularios">
            <thead>
              <tr>
                <th>Nivel</th><th>Factor</th><th>Item</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="secPesos" class="card hidden">
      <div class="card-h">
        <div>
          <h2>Pesos</h2>
          <div class="sub">Hoja Pesos (Nivel, Factor, Item, Peso)</div>
        </div>
        <div>
          <span class="chip" id="pCountChip">Items: 0</span>
          <select id="pNivelSelect"></select>
          <button id="btnPesosCargar" class="btn-ok">Cargar</button>
          <button id="btnPesosLimpiar" class="btn-ghost">Limpiar</button>
        </div>
      </div>
      <div class="card-b">
        <div class="table-wrap">
          <table id="tblPesos">
            <thead>
              <tr><th>Nivel</th><th>Factor</th><th>Item</th><th>Peso</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="secPlaceholder" class="card hidden">
      <div class="card-h"><h2 id="phTitle"></h2></div>
      <div class="card-b"><div class="hint" id="phBody"></div></div>
    </section>
  </div>
</main>

<script>
/* ================= CONFIG ================= */
const SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzya1ivHRn_ZAEXNYeowO59G0tMbckeU3YoAUMcpOQDqDd_3qVP-IPz56q69TnNS9W0/exec";

const FASES = [
  "Formularios","Pesos",
  "Formulario de autoevaluaci√≥n",
  "Formulario de evaluaci√≥n de clientes",
  "Formulario de evaluaci√≥n del desempe√±o",
  "Resultados evaluaci√≥n del desempe√±o",
  "Informe consolidado",
  "Informe de necesidades de capacitaci√≥n",
  "Informe de plan de desarrollo"
];

const $ = id => document.getElementById(id);

/* ================= STATUS ================= */
function setApiStatus(mode,text){
  const el=$("apiStatus");
  el.classList.remove("ok","err");
  if(mode) el.classList.add(mode);
  $("apiStatusText").textContent=text;
}

/* ================= JSONP API ================= */
function buildUrl(params, cbName){
  const url = new URL(SCRIPT_WEBAPP_URL);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  url.searchParams.set("callback", cbName);
  url.searchParams.set("_", String(Date.now()));
  return url.toString();
}

function apiGet(params, timeoutMs=12000){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    const src = buildUrl(params, cb);
    setApiStatus("", "API: consultando‚Ä¶");
    const s=document.createElement("script");
    s.async = true;
    let done=false;

    const t=setTimeout(()=>{
      if(done) return;
      done=true; cleanup();
      reject(new Error("Timeout: la WebApp no respondi√≥. Revisa deploy/permisos."));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(t);
      try { delete window[cb]; } catch(_) { window[cb]=undefined; }
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb]=data=>{
      if(done) return;
      done=true; cleanup();
      if(!data || typeof data !== "object"){
        reject(new Error("Respuesta no-JSON (posible login/permiso). Deploy: Anyone."));
        return;
      }
      if(data.ok!==true){
        reject(new Error(data.error || "Respuesta inv√°lida"));
        return;
      }
      setApiStatus("ok","API: conectada");
      resolve(data);
    };

    s.onerror=()=>{
      if(done) return;
      done=true; cleanup();
      reject(new Error("No se pudo cargar el script (URL mala / deploy privado / bloqueo extensi√≥n)."));
    };

    s.src = src;
    document.body.appendChild(s);
  });
}

/* ================= UI ================= */
function showOnly(id){
  ["secFormularios","secPesos","secPlaceholder"].forEach(s => $(s).classList.add("hidden"));
  $(id).classList.remove("hidden");
}

function initFases(){
  const sel=$("fase");
  sel.innerHTML="";
  FASES.forEach(f=>{
    const o=document.createElement("option");
    o.value=o.textContent=f;
    sel.appendChild(o);
  });
  sel.value="Formularios";
  sel.onchange=()=>{
    if(sel.value==="Formularios") showOnly("secFormularios");
    else if(sel.value==="Pesos") showOnly("secPesos");
    else{
      $("phTitle").textContent=sel.value;
      $("phBody").textContent="Fase lista para implementar.";
      showOnly("secPlaceholder");
    }
  };
  showOnly("secFormularios");
}

/* ================= HELPERS ================= */
function fillLevelSelect(selectEl, levels){
  // opci√≥n ‚ÄúTodos‚Äù
  const opts = [
    `<option value="ALL">(Todos los niveles)</option>`,
    ...levels.map(n => `<option value="${String(n)}">${String(n)}</option>`)
  ];
  selectEl.innerHTML = opts.join("");
  selectEl.value = "ALL";
}

function renderFormulariosRows(items){
  const tb = $("tblFormularios").querySelector("tbody");
  tb.innerHTML="";
  items.forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.Nivel ?? ""}</td>
        <td>${r.Factor ?? ""}</td>
        <td>${r.Item ?? ""}</td>
        <td><small>${r["1"] ?? ""}</small></td>
        <td><small>${r["2"] ?? ""}</small></td>
        <td><small>${r["3"] ?? ""}</small></td>
        <td><small>${r["4"] ?? ""}</small></td>
        <td><small>${r["5"] ?? ""}</small></td>
      </tr>
    `);
  });
  $("fCountChip").textContent = `Items: ${items.length}`;
}

function renderPesosRows(items){
  const tb = $("tblPesos").querySelector("tbody");
  tb.innerHTML="";
  items.forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.Nivel ?? ""}</td>
        <td>${r.Factor ?? ""}</td>
        <td>${r.Item ?? ""}</td>
        <td>${r.Peso ?? ""}</td>
      </tr>
    `);
  });
  $("pCountChip").textContent = `Items: ${items.length}`;
}

/* ================= FORMULARIOS ================= */
async function initFormulariosLevels(){
  const lv = await apiGet({action:"levels", sheet:"Formularios"});
  fillLevelSelect($("fNivelSelect"), lv.levels || []);
}

async function loadFormularios(){
  const nivel = $("fNivelSelect").value; // "ALL" o un nivel real
  const params = {action:"items", sheet:"Formularios"};
  if (nivel && nivel !== "ALL") params.nivel = nivel;

  const it = await apiGet(params);
  renderFormulariosRows(it.items || []);
}

/* ================= PESOS ================= */
async function initPesosLevels(){
  const lv = await apiGet({action:"levels", sheet:"Pesos"});
  fillLevelSelect($("pNivelSelect"), lv.levels || []);
}

async function loadPesos(){
  const nivel = $("pNivelSelect").value;
  const params = {action:"items", sheet:"Pesos"};
  if (nivel && nivel !== "ALL") params.nivel = nivel;

  const it = await apiGet(params);
  renderPesosRows(it.items || []);
}

/* ================= EVENTS ================= */
$("btnFormCargar").onclick = () => loadFormularios().catch(e=>setApiStatus("err","API: "+e.message));
$("btnFormLimpiar").onclick = () => {
  $("tblFormularios").querySelector("tbody").innerHTML="";
  $("fCountChip").textContent="Items: 0";
};

$("btnPesosCargar").onclick = () => loadPesos().catch(e=>setApiStatus("err","API: "+e.message));
$("btnPesosLimpiar").onclick = () => {
  $("tblPesos").querySelector("tbody").innerHTML="";
  $("pCountChip").textContent="Items: 0";
};

// opcional: si cambias nivel, puedes recargar con un click (no auto, para no spamear API)
$("fNivelSelect").addEventListener("change", () => {});
$("pNivelSelect").addEventListener("change", () => {});

/* ================= BOOT ================= */
initFases();
apiGet({action:"ping"})
  .then(async ()=>{
    setApiStatus("ok","API: conectada");
    // precarga niveles
    await initFormulariosLevels();
    await initPesosLevels();
  })
  .catch(e=>setApiStatus("err","API: "+e.message));
</script>
</body>
</html>
