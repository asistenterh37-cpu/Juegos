<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Evaluaci√≥n del Desempe√±o</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#121f3d;
      --text:#e8eefc;
      --muted:#a9b7d9;
      --line:rgba(255,255,255,.10);
      --accent:#4f7cff;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --chip:#1a2a52;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(79,124,255,.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.75);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:16px 18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:700; letter-spacing:.2px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;background:var(--accent);
      box-shadow: 0 0 0 4px rgba(79,124,255,.18);
    }
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    select, button{
      background: var(--panel);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
      box-shadow: none;
    }
    select{min-width:280px}
    button{
      cursor:pointer;
      transition: transform .05s ease, border-color .2s ease;
    }
    button:hover{border-color:rgba(255,255,255,.22)}
    button:active{transform: translateY(1px)}
    .btn-primary{background: linear-gradient(180deg, rgba(79,124,255,.35), rgba(79,124,255,.15)); border-color: rgba(79,124,255,.35)}
    .btn-ghost{background: transparent}
    .btn-ok{background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.10)); border-color: rgba(34,197,94,.35)}
    .btn-warn{background: linear-gradient(180deg, rgba(245,158,11,.22), rgba(245,158,11,.08)); border-color: rgba(245,158,11,.35)}
    main{padding: 18px}
    .grid{
      max-width:1180px;margin:0 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(18,31,61,.9), rgba(15,27,51,.92));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .card-h h2{margin:0;font-size:16px}
    .sub{color:var(--muted); font-size:13px}
    .card-b{padding:14px 16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .chip{
      background: rgba(26,42,82,.75);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size:12px;
    }
    .status{
      display:flex; align-items:center; gap:8px;
      font-family:var(--mono); font-size:12px; color:var(--muted);
    }
    .status .s-dot{
      width:10px;height:10px;border-radius:999px;background: var(--warn);
      box-shadow: 0 0 0 4px rgba(245,158,11,.15);
    }
    .status.ok .s-dot{background: var(--accent2); box-shadow: 0 0 0 4px rgba(34,197,94,.15)}
    .status.err .s-dot{background: var(--danger); box-shadow: 0 0 0 4px rgba(239,68,68,.15)}
    .table-wrap{overflow:auto; border-radius: 14px; border:1px solid var(--line)}
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 900px;
      background: rgba(11,18,32,.35);
    }
    th, td{
      padding:10px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
      font-size:13px;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight:600;
      background: rgba(15,27,51,.85);
      position: sticky; top: 0;
      z-index: 5;
    }
    td small{color:var(--muted)}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .mono{font-family:var(--mono)}
    .hint{
      background: rgba(79,124,255,.10);
      border:1px dashed rgba(79,124,255,.35);
      padding:10px 12px;
      border-radius: 14px;
      color: var(--muted);
      font-size:13px;
    }
    .kpi{
      display:flex;gap:10px;flex-wrap:wrap
    }
    .kpi .box{
      flex:1;
      min-width: 220px;
      background: rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px 12px;
    }
    .box b{display:block;font-size:14px}
    .box span{color:var(--muted);font-size:12px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          Sistema de Evaluaci√≥n del Desempe√±o
          <div class="sub">Front (GitHub) + API (Google Apps Script)</div>
        </div>
      </div>

      <div class="controls">
        <label class="sub" for="fase">Fase</label>
        <select id="fase"></select>
        <span id="apiStatus" class="status"><span class="s-dot"></span><span id="apiStatusText">API: sin probar</span></span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- ============ SECCI√ìN: FORMULARIOS ============ -->
    <section id="secFormularios" class="card hidden">
      <div class="card-h">
        <div>
          <h2>Formularios</h2>
          <div class="sub">Carga desde hoja <span class="mono">Formularios</span> (Nivel, Factor, Item, 1..5)</div>
        </div>
        <div class="row">
          <span class="chip" id="fCountChip">Items: 0</span>
          <select id="fNivelSelect" title="Nivel"></select>
          <button class="btn-ok" id="btnFormCargar">Cargar</button>
          <button class="btn-ghost" id="btnFormLimpiar">Limpiar</button>
        </div>
      </div>
      <div class="card-b">
        <div class="hint">
          Tip: ‚ÄúLimpiar‚Äù aqu√≠ no borra tu Sheet üòÖ ‚Äî solo limpia la vista y el cache local del navegador.
        </div>
        <div style="height:10px"></div>
        <div class="table-wrap">
          <table id="tblFormularios">
            <thead>
              <tr>
                <th style="min-width:210px">Nivel</th>
                <th style="min-width:260px">Factor</th>
                <th style="min-width:360px">Item</th>
                <th style="min-width:260px">1</th>
                <th style="min-width:260px">2</th>
                <th style="min-width:260px">3</th>
                <th style="min-width:260px">4</th>
                <th style="min-width:260px">5</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ============ SECCI√ìN: PESOS ============ -->
    <section id="secPesos" class="card hidden">
      <div class="card-h">
        <div>
          <h2>Pesos</h2>
          <div class="sub">Carga desde hoja <span class="mono">Pesos</span> (Nivel, Factor, Item, Peso)</div>
        </div>
        <div class="row">
          <span class="chip" id="pCountChip">Items: 0</span>
          <select id="pNivelSelect" title="Nivel"></select>
          <button class="btn-ok" id="btnPesosCargar">Cargar</button>
          <button class="btn-ghost" id="btnPesosLimpiar">Limpiar</button>
        </div>
      </div>

      <div class="card-b">
        <div class="kpi">
          <div class="box">
            <b>Total peso (nivel seleccionado)</b>
            <span id="pesoTotalTxt">0</span>
          </div>
          <div class="box">
            <b>Validaci√≥n r√°pida</b>
            <span id="pesoValidTxt">‚Äî</span>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="table-wrap">
          <table id="tblPesos">
            <thead>
              <tr>
                <th style="min-width:210px">Nivel</th>
                <th style="min-width:260px">Factor</th>
                <th style="min-width:460px">Item</th>
                <th style="min-width:140px">Peso</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ============ PLACEHOLDERS PARA EL RESTO DEL MEN√ö ============ -->
    <section id="secPlaceholder" class="card hidden">
      <div class="card-h">
        <div>
          <h2 id="phTitle">Fase</h2>
          <div class="sub">Secci√≥n lista para implementar</div>
        </div>
        <span class="chip">Pr√≥ximo: aqu√≠ van formularios y resultados</span>
      </div>
      <div class="card-b">
        <div class="hint" id="phBody">
          Estructura lista. Solo falta que me digas qu√© campos tendr√° esta fase y lo conectamos.
        </div>
      </div>
    </section>

  </div>
</main>

<script>
  // =========================
  // CONFIG
  // =========================
  const SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzHhg2hZo1rY4KX_IwRs6cPF2tY1L5H8OBHUgE1aXS_Kc2n5lRCUMVCwRHYaSfhGnpf/exec";

  const FASES = [
    "Formularios",
    "Pesos",
    "Formulario de autoevaluaci√≥n",
    "Formulario de evaluaci√≥n de clientes",
    "Formulario de evaluaci√≥n del desempe√±o",
    "Resultados evaluaci√≥n del desempe√±o",
    "Informe consolidado",
    "Informe de necesidades de capacitaci√≥n",
    "Informe de plan de desarrollo"
  ];

  // Por default: "Formulario de autoevaluaci√≥n" (como pediste)
  const DEFAULT_FASE = "Formulario de autoevaluaci√≥n";

  const LS_KEYS = {
    forms: "ed_forms_cache_v1",
    pesos: "ed_pesos_cache_v1",
    apiOk: "ed_api_ok_v1"
  };

  // =========================
  // HELPERS
  // =========================
  const $ = (id) => document.getElementById(id);

  function setApiStatus(mode, text){
    const el = $("apiStatus");
    el.classList.remove("ok","err");
    if(mode) el.classList.add(mode);
    $("apiStatusText").textContent = text;
  }

  function showOnlySection(sectionId){
    ["secFormularios","secPesos","secPlaceholder"].forEach(id => $(id).classList.add("hidden"));
    $(sectionId).classList.remove("hidden");
  }

  function setPlaceholder(title, body){
    $("phTitle").textContent = title;
    $("phBody").textContent = body;
    showOnlySection("secPlaceholder");
  }

  function safeNumber(x){
    const n = Number(String(x).replace(",", "."));
    return Number.isFinite(n) ? n : 0;
  }

  // =========================
  // API (Apps Script Web App)
  // =========================
  async function apiGet(params){
    if(!SCRIPT_WEBAPP_URL || SCRIPT_WEBAPP_URL.includes("PEGAR_AQUI")){
      setApiStatus("err","API: falta URL del Web App");
      throw new Error("Falta SCRIPT_WEBAPP_URL");
    }

    const url = new URL(SCRIPT_WEBAPP_URL);
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));

    const r = await fetch(url.toString(), { method:"GET" });
    const data = await r.json();

    if(!data || data.ok !== true){
      throw new Error(data?.error || "Respuesta inv√°lida del API");
    }

    localStorage.setItem(LS_KEYS.apiOk, "1");
    setApiStatus("ok","API: conectada");
    return data;
  }

  async function testApi(){
    try{
      await apiGet({ action:"ping" });
    }catch(e){
      const hadOk = localStorage.getItem(LS_KEYS.apiOk) === "1";
      setApiStatus("err", hadOk ? "API: error (antes funcion√≥)" : "API: no conectada");
    }
  }

  // =========================
  // FORMULARIOS (UI)
  // =========================
  function setFormNivelOptions(niveles){
    const sel = $("fNivelSelect");
    sel.innerHTML = "";
    niveles.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });
    // default mostrar nivel 1 (si existe)
    if(niveles.includes("1") || niveles.includes(1)){
      sel.value = "1";
    } else if(niveles.length){
      sel.value = String(niveles[0]);
    }
  }

  function renderFormTable(items){
    const tb = $("tblFormularios").querySelector("tbody");
    tb.innerHTML = "";

    items.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.Nivel ?? ""}</td>
        <td>${row.Factor ?? ""}</td>
        <td>${row.Item ?? ""}</td>
        <td><small>${row["1"] ?? ""}</small></td>
        <td><small>${row["2"] ?? ""}</small></td>
        <td><small>${row["3"] ?? ""}</small></td>
        <td><small>${row["4"] ?? ""}</small></td>
        <td><small>${row["5"] ?? ""}</small></td>
      `;
      tb.appendChild(tr);
    });

    $("fCountChip").textContent = `Items: ${items.length}`;
  }

  function clearFormView(){
    $("tblFormularios").querySelector("tbody").innerHTML = "";
    $("fCountChip").textContent = "Items: 0";
    $("fNivelSelect").innerHTML = "";
  }

  function cacheSet(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
  function cacheGet(key){
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(_){ return null; }
  }
  function cacheDel(key){ localStorage.removeItem(key); }

  async function loadFormularios(){
    // 1) Traer niveles
    const levels = await apiGet({ action:"levels", sheet:"Formularios" });
    setFormNivelOptions(levels.levels.map(String));

    // 2) Traer items del nivel seleccionado
    const nivel = $("fNivelSelect").value;
    const res = await apiGet({ action:"items", sheet:"Formularios", nivel });
    cacheSet(LS_KEYS.forms, { levels: levels.levels, byNivel: { [nivel]: res.items } });
    renderFormTable(res.items);
  }

  async function reloadFormulariosForNivel(){
    const nivel = $("fNivelSelect").value;
    const cached = cacheGet(LS_KEYS.forms);
    if(cached?.byNivel?.[nivel]){
      renderFormTable(cached.byNivel[nivel]);
      return;
    }
    const res = await apiGet({ action:"items", sheet:"Formularios", nivel });
    const next = cached || { levels: [], byNivel: {} };
    next.byNivel[nivel] = res.items;
    cacheSet(LS_KEYS.forms, next);
    renderFormTable(res.items);
  }

  // =========================
  // PESOS (UI)
  // =========================
  function setPesoNivelOptions(niveles){
    const sel = $("pNivelSelect");
    sel.innerHTML = "";
    niveles.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });
    if(niveles.includes("1") || niveles.includes(1)){
      sel.value = "1";
    } else if(niveles.length){
      sel.value = String(niveles[0]);
    }
  }

  function renderPesosTable(items){
    const tb = $("tblPesos").querySelector("tbody");
    tb.innerHTML = "";

    let total = 0;
    items.forEach(row => {
      const peso = safeNumber(row.Peso);
      total += peso;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.Nivel ?? ""}</td>
        <td>${row.Factor ?? ""}</td>
        <td>${row.Item ?? ""}</td>
        <td class="mono">${row.Peso ?? ""}</td>
      `;
      tb.appendChild(tr);
    });

    $("pCountChip").textContent = `Items: ${items.length}`;
    $("pesoTotalTxt").textContent = String(total);

    // Validaci√≥n ligera: si ‚Äútotal ~= 100‚Äù lo marco bonito (aj√∫stalo si tu regla es otra)
    const delta = Math.abs(total - 100);
    $("pesoValidTxt").textContent =
      delta < 0.0001 ? "‚úÖ Total = 100" :
      total === 0 ? "‚Äî" :
      `‚ö†Ô∏è Total ‚â† 100 (delta ${delta.toFixed(2)})`;
  }

  function clearPesosView(){
    $("tblPesos").querySelector("tbody").innerHTML = "";
    $("pCountChip").textContent = "Items: 0";
    $("pNivelSelect").innerHTML = "";
    $("pesoTotalTxt").textContent = "0";
    $("pesoValidTxt").textContent = "‚Äî";
  }

  async function loadPesos(){
    const levels = await apiGet({ action:"levels", sheet:"Pesos" });
    setPesoNivelOptions(levels.levels.map(String));

    const nivel = $("pNivelSelect").value;
    const res = await apiGet({ action:"items", sheet:"Pesos", nivel });
    cacheSet(LS_KEYS.pesos, { levels: levels.levels, byNivel: { [nivel]: res.items } });
    renderPesosTable(res.items);
  }

  async function reloadPesosForNivel(){
    const nivel = $("pNivelSelect").value;
    const cached = cacheGet(LS_KEYS.pesos);
    if(cached?.byNivel?.[nivel]){
      renderPesosTable(cached.byNivel[nivel]);
      return;
    }
    const res = await apiGet({ action:"items", sheet:"Pesos", nivel });
    const next = cached || { levels: [], byNivel: {} };
    next.byNivel[nivel] = res.items;
    cacheSet(LS_KEYS.pesos, next);
    renderPesosTable(res.items);
  }

  // =========================
  // INIT: FASE SELECTOR
  // =========================
  function initFases(){
    const sel = $("fase");
    sel.innerHTML = "";
    FASES.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f;
      opt.textContent = f;
      sel.appendChild(opt);
    });
    sel.value = DEFAULT_FASE;

    sel.addEventListener("change", () => {
      const fase = sel.value;

      if(fase === "Formularios"){
        showOnlySection("secFormularios");
      } else if(fase === "Pesos"){
        showOnlySection("secPesos");
      } else {
        setPlaceholder(
          fase,
          "Secci√≥n lista. Conecto esta fase cuando definamos su estructura (campos, c√°lculos, reportes, etc.)."
        );
      }
    });

    // Mostrar default (Autoevaluaci√≥n) como placeholder
    setPlaceholder(DEFAULT_FASE, "Default: aqu√≠ ir√° el Formulario de autoevaluaci√≥n.");
  }

  // =========================
  // EVENTS
  // =========================
  $("btnFormCargar").addEventListener("click", async () => {
    try{ await loadFormularios(); }catch(e){ setApiStatus("err","API: " + e.message); }
  });
  $("btnFormLimpiar").addEventListener("click", () => {
    cacheDel(LS_KEYS.forms);
    clearFormView();
  });
  $("fNivelSelect").addEventListener("change", async () => {
    try{ await reloadFormulariosForNivel(); }catch(e){ setApiStatus("err","API: " + e.message); }
  });

  $("btnPesosCargar").addEventListener("click", async () => {
    try{ await loadPesos(); }catch(e){ setApiStatus("err","API: " + e.message); }
  });
  $("btnPesosLimpiar").addEventListener("click", () => {
    cacheDel(LS_KEYS.pesos);
    clearPesosView();
  });
  $("pNivelSelect").addEventListener("change", async () => {
    try{ await reloadPesosForNivel(); }catch(e){ setApiStatus("err","API: " + e.message); }
  });

  // =========================
  // BOOT
  // =========================
  initFases();
  testApi();
</script>
</body>
</html>
