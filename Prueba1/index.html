<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Evaluación del desempeño</title>
  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(15,23,42,.72);
      --panel2: rgba(2,6,23,.55);
      --stroke: rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#3b82f6;
      --brand2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 16px;
      --radius2: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 50% 20%, rgba(59,130,246,.18), transparent 60%),
        radial-gradient(900px 500px at 70% 55%, rgba(168,85,247,.12), transparent 60%),
        radial-gradient(900px 500px at 30% 55%, rgba(34,197,94,.08), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 18px 14px 60px;}
    .topbar{
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: blur(10px);
      padding: 10px 0;
    }
    .topbarInner{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background: rgba(2,6,23,.65);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    .brand{display:flex; gap:10px; align-items:center; padding-left:6px;}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--brand2);
      box-shadow: 0 0 0 6px rgba(34,197,94,.12);
    }
    .title{font-weight:700; letter-spacing:.2px; font-size: 13px; line-height:1;}
    .subtitle{font-size: 11px; color: var(--muted); margin-top:2px;}
    .nav{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;}
    .chip{
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.55);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition:.15s;
      white-space:nowrap;
    }
    .chip:hover{transform: translateY(-1px); border-color: rgba(59,130,246,.35)}
    .chip.active{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.45);}

    .card{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.55));
    }
    .cardHead h2{margin:0;font-size:14px}
    .cardHead p{margin:6px 0 0; color:var(--muted); font-size:12px}
    .cardBody{padding: 14px}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .grid4{display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px}
    @media (max-width: 780px){
      .grid2,.grid3,.grid4{grid-template-columns:1fr}
      .nav{justify-content:flex-start}
    }

    label{display:block; font-size:11px; color: var(--muted); margin: 0 0 6px}
    input, select, textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(2,6,23,.55);
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }
    textarea{min-height: 92px; resize: vertical}

    .actions{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:flex-end;
      margin-top: 12px;
    }
    .btn{
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,.75);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      cursor:pointer;
      transition:.15s;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(59,130,246,.35)}
    .btn.primary{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.45)}
    .btn.good{background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.35)}
    .btn.warn{background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.35)}
    .btn.danger{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35)}
    .hint{font-size:12px; color: var(--muted); margin-top: 10px}
    .status{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      font-size:12px;
      color: var(--muted);
    }
    .status strong{color: var(--text)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .factor{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed rgba(148,163,184,.22);
    }
    .factor h3{margin:0 0 8px; font-size:13px}
    .q{
      padding: 10px 10px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.42);
      border-radius: 12px;
      margin-bottom: 10px;
      display:grid;
      grid-template-columns: 1fr 220px;
      gap: 10px;
      align-items:center;
    }
    @media (max-width:780px){ .q{grid-template-columns:1fr} }
    .qTitle{font-size:12px; font-weight:600}
    .qMeta{font-size:11px; color: var(--muted); margin-top:4px}
    .badge{
      display:inline-flex; gap:6px; align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.6);
      font-size: 11px;
      color: var(--muted);
    }

    @media print{
      .topbar, .actions, .chip{display:none !important}
      body{background:#fff; color:#000}
      .card{box-shadow:none}
      input, select, textarea{border:1px solid #ccc; background:#fff; color:#000}
      .status{display:none}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbarInner">
        <div class="brand">
          <span class="dot" id="apiDot"></span>
          <div>
            <div class="title">Proceso de evaluación del desempeño</div>
            <div class="subtitle" id="apiSubtitle">Conectando con Apps Script…</div>
          </div>
        </div>
        <div class="nav" id="menu"></div>
      </div>
    </div>

    <div class="card" id="viewCard">
      <div class="cardHead">
        <h2 id="viewTitle">Cargando…</h2>
        <p id="viewDesc">Inicializando interfaz.</p>
      </div>
      <div class="cardBody" id="viewBody"></div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const MAX_RESP = 20;

// 1) URL por defecto (tu deploy). Si da 403, la cambias en la UI.
const DEFAULT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyuLgOmdKAr33BWxx6KfNU9Z1XReqgpTqrE73uzSaQE8ui5jjssD4afRXDRIJjUOuFu/exec";

// 2) Permite override por querystring: ?webapp=https://script.google.com/macros/s/.../exec
// 3) O guardado en localStorage con el botón “Configurar WebApp”.
function getWebAppUrl(){
  const u = new URL(location.href);
  const qs = u.searchParams.get("webapp");
  if (qs && qs.startsWith("https://script.google.com/macros/s/")) return qs;
  const saved = localStorage.getItem("WEBAPP_URL");
  if (saved && saved.startsWith("https://script.google.com/macros/s/")) return saved;
  return DEFAULT_WEBAPP_URL;
}
let SCRIPT_WEBAPP_URL = getWebAppUrl();

/** =========================
 * JSONP helper (GitHub Pages friendly)
 * - timeout vs error de red
 * - cache bust
 * ========================= */
function jsonp(url, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const qs = new URLSearchParams({ ...params, callback: cb, _ts: Date.now() });
    script.src = url + (url.includes("?") ? "&" : "?") + qs.toString();
    script.async = true;

    const timer = setTimeout(() => {
      cleanup();
      reject(new Error("Timeout JSONP (¿WebApp privado / acceso incorrecto?)"));
    }, 20000);

    function cleanup(){
      clearTimeout(timer);
      try{ delete window[cb]; }catch(_){}
      script.remove();
    }

    window[cb] = (data) => { cleanup(); resolve(data); };
    script.onerror = () => { cleanup(); reject(new Error("Error cargando JSONP (URL inválida / 403 / deploy roto)")); };

    document.body.appendChild(script);
  });
}

/** =========================
 * State
 * ========================= */
const state = { view: "forms", levels: [], form: null };

const menuItems = [
  { id:"forms", label:"Formularios y pesos" },
  { id:"autoevaluacion", label:"Formulario de autoevaluación" },
  { id:"clientes", label:"Formulario evaluación de clientes" },
  { id:"desempeno", label:"Formulario evaluación del desempeño" },
  { id:"resultados", label:"Resultados evaluación del desempeño" },
  { id:"consolidado", label:"Informe consolidado" },
  { id:"capacitacion", label:"Informe necesidades de capacitación" },
  { id:"desarrollo", label:"Informe plan de desarrollo" },
];

function setStatus(ok, msg){
  const dot = document.getElementById("apiDot");
  const sub = document.getElementById("apiSubtitle");
  dot.style.background = ok ? "var(--brand2)" : "var(--danger)";
  dot.style.boxShadow = ok ? "0 0 0 6px rgba(34,197,94,.12)" : "0 0 0 6px rgba(239,68,68,.12)";
  sub.textContent = msg;
}

function renderMenu(){
  const el = document.getElementById("menu");
  el.innerHTML = "";
  menuItems.forEach(item => {
    const b = document.createElement("button");
    b.className = "chip" + (state.view === item.id ? " active" : "");
    b.textContent = item.label;
    b.onclick = () => { state.view = item.id; renderView(); renderMenu(); };
    el.appendChild(b);
  });
}

function setView(title, desc){
  document.getElementById("viewTitle").textContent = title;
  document.getElementById("viewDesc").textContent = desc;
}

/** =========================
 * API
 * ========================= */
async function api(action, params={}){
  // Relee por si el usuario cambió URL
  SCRIPT_WEBAPP_URL = getWebAppUrl();
  const res = await jsonp(SCRIPT_WEBAPP_URL, { action, ...params });
  if (!res || res.ok !== true) throw new Error(res?.error || "Respuesta inválida del servidor");
  return res;
}

async function init(){
  renderMenu();
  await checkConnection();
  renderView();
}

async function checkConnection(){
  try{
    await api("ping");
    setStatus(true, "Apps Script conectado");
  }catch(e){
    setStatus(false, "Sin conexión a Apps Script (403 = acceso del deploy).");
  }
}

function renderView(){
  const body = document.getElementById("viewBody");
  body.innerHTML = "";

  if (state.view === "forms") return renderFormsAndWeights(body);
  if (state.view === "autoevaluacion") return renderAutoevaluacion(body);

  setView(menuItems.find(m=>m.id===state.view)?.label || "Módulo", "Módulo en preparación.");
  const box = document.createElement("div");
  box.className = "status";
  box.innerHTML = `<strong>Listo para expandir:</strong> el menú ya está cableado.`;
  body.appendChild(box);
}

async function renderFormsAndWeights(body){
  setView("Formularios y pesos", "Cargar (importa desde la pestaña Formularios) o Limpiar (borra banco de cuestionarios).");

  const grid = document.createElement("div");
  grid.className = "grid2";

  const left = document.createElement("div");
  left.innerHTML = `
    <div class="status">
      <div><strong>Acciones</strong></div>
      <div class="hint">“Cargar” arma el banco por Nivel. “Limpiar” borra el banco para recargar.</div>

      <div class="actions" style="justify-content:flex-start">
        <button class="btn good" id="btnLoad">Cargar</button>
        <button class="btn danger" id="btnClear">Limpiar</button>
        <button class="btn primary" id="btnCfg">Configurar WebApp</button>
        <button class="btn" id="btnTest">Probar conexión</button>
      </div>

      <div class="hint">
        URL actual: <span class="mono" id="urlNow"></span>
        <br>Tip: tu hoja debe llamarse exactamente <b>Formularios</b> y tener headers: Nivel, Factor, Item, Pesos, 1..5
      </div>
    </div>
  `;

  const right = document.createElement("div");
  right.innerHTML = `<div class="status" id="bankInfo"><strong>Banco:</strong> consultando…</div>`;

  grid.appendChild(left);
  grid.appendChild(right);
  body.appendChild(grid);

  document.getElementById("urlNow").textContent = getWebAppUrl();

  async function refreshInfo(){
    try{
      const info = await api("bankInfo");
      document.getElementById("bankInfo").innerHTML =
        `<strong>Banco:</strong> ${info.count} ítems en ${info.levels} niveles.<br><span class="hint">Última carga: ${escapeHtml(info.lastLoad || "—")}</span>`;
    }catch(e){
      document.getElementById("bankInfo").innerHTML =
        `<strong>Banco:</strong> no disponible.<br><span class="hint">❌ ${escapeHtml(e.message)}</span>`;
    }
  }

  document.getElementById("btnCfg").onclick = async () => {
    const cur = getWebAppUrl();
    const next = prompt("Pega aquí la URL /exec del WebApp (Apps Script):", cur);
    if (!next) return;
    localStorage.setItem("WEBAPP_URL", next.trim());
    document.getElementById("urlNow").textContent = getWebAppUrl();
    await checkConnection();
    await refreshInfo();
  };

  document.getElementById("btnTest").onclick = async () => {
    await checkConnection();
    await refreshInfo();
  };

  document.getElementById("btnLoad").onclick = async () => {
    const s = document.createElement("div");
    s.className="status";
    s.textContent = "Cargando cuestionarios…";
    body.appendChild(s);
    try{
      const r = await api("loadBank");
      s.innerHTML = `✅ <strong>Carga completada:</strong> ${r.count} ítems en ${r.levels} niveles.`;
      await refreshInfo();
    }catch(e){
      s.innerHTML = `❌ <strong>Error:</strong> ${escapeHtml(e.message)}`;
    }
  };

  document.getElementById("btnClear").onclick = async () => {
    const s = document.createElement("div");
    s.className="status";
    s.textContent = "Limpiando banco…";
    body.appendChild(s);
    try{
      await api("clearBank");
      s.innerHTML = `✅ <strong>Banco limpiado.</strong>`;
      await refreshInfo();
    }catch(e){
      s.innerHTML = `❌ <strong>Error:</strong> ${escapeHtml(e.message)}`;
    }
  };

  await refreshInfo();
}

async function renderAutoevaluacion(body){
  setView("Formulario de autoevaluación", "Selecciona Nivel, responde y guarda en la hoja Autoevaluacion.");

  const head = document.createElement("div");
  head.className = "grid2";

  const left = document.createElement("div");
  left.innerHTML = `
    <label>Formulario (Nivel)</label>
    <select id="levelSelect"><option value="1">Nivel 1</option></select>
    <div class="hint">Si no ves niveles, primero ve a “Formularios y pesos” → <b>Cargar</b>.</div>
  `;

  const right = document.createElement("div");
  const today = new Date();
  const fechaHoy = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
  right.innerHTML = `
    <div class="status">
      <strong>Acciones</strong>
      <div class="actions" style="justify-content:flex-start">
        <button class="btn warn" id="btnNew">Nuevo</button>
        <button class="btn good" id="btnSave">Guardar</button>
        <button class="btn primary" id="btnPrint">Imprimir / PDF</button>
      </div>
      <div class="hint">“Imprimir/PDF” usa el diálogo del navegador.</div>
    </div>
  `;

  head.appendChild(left);
  head.appendChild(right);
  body.appendChild(head);

  const datos = document.createElement("div");
  datos.className = "card";
  datos.style.marginTop = "12px";
  datos.innerHTML = `
    <div class="cardHead">
      <h2>Datos del colaborador</h2>
      <p>Completa la información base.</p>
    </div>
    <div class="cardBody">
      <div class="grid4">
        <div><label>No. de personal</label><input id="noPersonal" placeholder="Ej. 1000"></div>
        <div><label>Nombre</label><input id="nombre" placeholder="Ej. Carlos Paz"></div>
        <div><label>Posición</label><input id="posicion" placeholder="Ej. Asistente"></div>
        <div><label>Departamento</label><input id="depto" placeholder="Ej. Contabilidad"></div>
      </div>
      <div class="grid3" style="margin-top:10px">
        <div><label>Periodo</label><input id="periodo" placeholder="Ej. 2026"></div>
        <div><label>Versión</label><input id="version" placeholder="Ej. 1.1"></div>
        <div><label>Fecha</label><input id="fecha" value="${fechaHoy}" readonly></div>
      </div>
    </div>
  `;
  body.appendChild(datos);

  const qWrap = document.createElement("div");
  qWrap.className = "card";
  qWrap.style.marginTop = "12px";
  qWrap.innerHTML = `
    <div class="cardHead">
      <h2>Autoevaluación</h2>
      <p>Selecciona un valor por ítem.</p>
    </div>
    <div class="cardBody" id="questions"></div>
  `;
  body.appendChild(qWrap);

  const comm = document.createElement("div");
  comm.className = "card";
  comm.style.marginTop = "12px";
  comm.innerHTML = `
    <div class="cardHead">
      <h2>Comentarios del colaborador</h2>
      <p>Opcional.</p>
    </div>
    <div class="cardBody">
      <label>Comentarios</label>
      <textarea id="comentarios" placeholder="Escribe aquí…"></textarea>
    </div>
  `;
  body.appendChild(comm);

  const status = document.createElement("div");
  status.className = "status";
  status.id = "saveStatus";
  status.textContent = "Listo.";
  body.appendChild(status);

  let levels = ["1"];
  try{
    const r = await api("getLevels");
    levels = (r.levels && r.levels.length) ? r.levels : ["1"];
    state.levels = levels;
  }catch(_){}

  const levelSelect = document.getElementById("levelSelect");
  levelSelect.innerHTML = levels.map(l => `<option value="${escapeHtml(l)}">Nivel ${escapeHtml(l)}</option>`).join("");
  levelSelect.value = levels.includes("1") ? "1" : levels[0];

  async function loadForm(level){
    document.getElementById("questions").innerHTML = `<div class="status">Cargando formulario Nivel ${escapeHtml(level)}…</div>`;
    try{
      const r = await api("getForm", { level });
      state.form = r.form;
      renderQuestions(state.form);
      document.getElementById("saveStatus").textContent = `Formulario Nivel ${level} cargado.`;
    }catch(e){
      document.getElementById("questions").innerHTML =
        `<div class="status">❌ No se pudo cargar el formulario: <strong>${escapeHtml(e.message)}</strong><div class="hint">Ve a “Formularios y pesos” → Cargar.</div></div>`;
    }
  }

  function renderQuestions(form){
    const host = document.getElementById("questions");
    host.innerHTML = "";
    if (!form || !Array.isArray(form.questions) || !form.questions.length){
      host.innerHTML = `<div class="status">No hay preguntas para este nivel.</div>`;
      return;
    }

    const byFactor = new Map();
    form.questions.forEach(q => {
      const f = String(q.factor || "Sin factor");
      if (!byFactor.has(f)) byFactor.set(f, []);
      byFactor.get(f).push(q);
    });

    let respIndex = 0;

    for (const [factor, qs] of byFactor.entries()){
      const f = document.createElement("div");
      f.className = "factor";
      f.innerHTML = `<h3>${escapeHtml(factor)}</h3>`;
      qs.forEach(q => {
        respIndex++;
        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `
          <div>
            <div class="qTitle">${escapeHtml(q.item)}</div>
            <div class="qMeta">
              <span class="badge">Peso: ${escapeHtml(q.peso)}</span>
              <span class="badge">Resp${respIndex}</span>
            </div>
          </div>
          <div>
            <label>Puntuación (1–5)</label>
            <select data-resp="r${respIndex}">
              <option value="">Seleccionar…</option>
              ${(q.scale || []).map(s => `<option value="${escapeHtml(s.value)}">${escapeHtml(s.value)} — ${escapeHtml(s.label)}</option>`).join("")}
            </select>
          </div>
        `;
        f.appendChild(div);
      });
      host.appendChild(f);
    }

    if (form.questions.length > MAX_RESP){
      const warn = document.createElement("div");
      warn.className="status";
      warn.innerHTML = `⚠️ <strong>Advertencia:</strong> Este nivel tiene ${form.questions.length} ítems, pero MAX_RESP = ${MAX_RESP}. Sube MAX_RESP en HTML y Apps Script o reduce ítems.`;
      host.appendChild(warn);
    }
  }

  function clearForm(){
    ["noPersonal","nombre","posicion","depto","periodo","version","comentarios"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    document.querySelectorAll("#questions select[data-resp]").forEach(s => s.value = "");
    document.getElementById("saveStatus").textContent = "Formulario limpio (Nuevo).";
  }

  function collectParams(){
    const params = {
      level: levelSelect.value,
      noPersonal: document.getElementById("noPersonal").value.trim(),
      nombre: document.getElementById("nombre").value.trim(),
      posicion: document.getElementById("posicion").value.trim(),
      departamento: document.getElementById("depto").value.trim(),
      periodo: document.getElementById("periodo").value.trim(),
      version: document.getElementById("version").value.trim(),
      fecha: document.getElementById("fecha").value.trim(),
      comentarios: document.getElementById("comentarios").value.trim(),
    };

    const selects = document.querySelectorAll("#questions select[data-resp]");
    selects.forEach(sel => { params[sel.dataset.resp] = sel.value || ""; });

    // Rellena faltantes hasta MAX_RESP (si el nivel tiene menos ítems)
    for (let i=1;i<=MAX_RESP;i++){
      if (!(("r"+i) in params)) params["r"+i] = "";
    }
    return params;
  }

  levelSelect.onchange = () => loadForm(levelSelect.value);
  document.getElementById("btnNew").onclick = clearForm;
  document.getElementById("btnPrint").onclick = () => window.print();

  document.getElementById("btnSave").onclick = async () => {
    const p = collectParams();
    if (!p.noPersonal || !p.nombre){
      document.getElementById("saveStatus").innerHTML = `⚠️ <strong>Completa al menos:</strong> No. de personal y Nombre.`;
      return;
    }
    document.getElementById("saveStatus").textContent = "Guardando…";
    try{
      const r = await api("saveAutoeval", p);
      document.getElementById("saveStatus").innerHTML = `✅ <strong>Guardado:</strong> fila #${r.row} en Autoevaluacion.`;
    }catch(e){
      document.getElementById("saveStatus").innerHTML = `❌ <strong>Error al guardar:</strong> ${escapeHtml(e.message)}`;
    }
  };

  await loadForm(levelSelect.value);
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

init();
</script>
</body>
</html>
