<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Evaluación del Desempeño</title>
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#121f3d;
      --text:#e8eefc; --muted:#a9b7d9; --line:rgba(255,255,255,.10);
      --accent:#4f7cff; --accent2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1a2a52; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius2: 22px; --mono: ui-monospace, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--sans);color:var(--text);min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(79,124,255,.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
        var(--bg);
    }
    header{
      position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
      background:rgba(11,18,32,.75);border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:16px 18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{
      width:34px;height:34px;border-radius:12px;display:grid;place-items:center;
      background:rgba(79,124,255,.18);border:1px solid rgba(79,124,255,.25);font-weight:800;
    }
    .sub{color:var(--muted);font-size:13px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:rgba(26,42,82,.75);border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)
    }
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,button,input,textarea{
      background:var(--panel);border:1px solid var(--line);color:var(--text);
      padding:10px 12px;border-radius:12px;font-family:var(--sans)
    }
    select{min-width:220px}
    button{cursor:pointer}
    .btn-ok{
      background:linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.10));
      border-color:rgba(34,197,94,.35)
    }
    .btn-blue{
      background:linear-gradient(180deg, rgba(79,124,255,.25), rgba(79,124,255,.10));
      border-color:rgba(79,124,255,.35)
    }
    .btn-ghost{background:transparent}
    .btn-warn{
      background:linear-gradient(180deg, rgba(245,158,11,.20), rgba(245,158,11,.08));
      border-color:rgba(245,158,11,.35)
    }
    button[disabled]{ opacity:.45; filter:saturate(.6); cursor:not-allowed; }

    main{padding:18px}
    .grid{max-width:1180px;margin:0 auto;display:grid;gap:14px}
    .card{
      background:linear-gradient(180deg, rgba(18,31,61,.9), rgba(15,27,51,.92));
      border:1px solid var(--line);border-radius:var(--radius2);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .card-h{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center
    }
    .card-h h2{margin:0;font-size:16px}
    .card-b{padding:14px 16px}
    .status{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:12px;color:var(--muted)}
    .status .s-dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .status.ok .s-dot{background:var(--accent2)}
    .status.err .s-dot{background:var(--danger)}
    .hint{
      background:rgba(79,124,255,.10);border:1px dashed rgba(79,124,255,.35);
      padding:10px 12px;border-radius:14px;color:var(--muted);font-size:13px
    }
    .hint.warn{
      background:rgba(245,158,11,.10);border:1px dashed rgba(245,158,11,.35);
    }
    .form-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    .lbl{font-size:12px;color:var(--muted);margin-bottom:6px}
    .field{display:flex;flex-direction:column;gap:6px}
    input{width:100%}
    textarea{width:100%;min-height:92px;resize:vertical}

    .factor{
      border:1px solid var(--line); border-radius:18px; padding:12px;
      background:rgba(11,18,32,.35); margin-bottom:12px;
    }
    .factor-title{font-weight:800;margin:0 0 8px 0;font-size:14px}
    .item-row{
      display:grid; grid-template-columns: 1fr 240px; gap:12px;
      padding:10px 0; border-top:1px solid rgba(255,255,255,.07); align-items:center;
    }
    .item-row:first-of-type{border-top:none}
    .item-name{font-weight:600;font-size:13px}
    .item-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .item-select select{width:100%;min-width:unset}

    [data-phase-block]{display:none}
    [data-phase-block].show{display:block}

    .table-wrap{overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:16px}
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.07);vertical-align:top}
    th{position:sticky;top:0;background:rgba(15,27,51,.98);font-size:12px;color:var(--muted);text-align:left}
    td{font-size:13px}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:var(--mono);font-size:12px;color:var(--muted)}

    @media (max-width:860px){
      .col-3,.col-4,.col-6{grid-column:span 12}
      .item-row{grid-template-columns:1fr}
      select{min-width:180px}
      table{min-width:760px}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ED</div>
        <div>
          Proceso de evaluación del desempeño
          <div class="chips">
            <span class="chip">Empresa: <b id="chipEmpresa">No Implementado</b></span>
            <span class="chip">Versión: <b id="chipVersion">Prueba</b></span>
          </div>
        </div>
      </div>

      <div class="controls">
        <span id="apiStatus" class="status">
          <span class="s-dot"></span>
          <span id="apiStatusText">API: sin probar</span>
        </span>
        <button id="btnProbarApi" class="btn-ghost">Probar API</button>

        <!-- ✅ Guardar/Limpiar se activan en fases evaluables (AUTO/DESEMPENO) -->
        <button id="btnLimpiarEval" class="btn-warn" style="display:none">Limpiar</button>
        <button id="btnGuardar" class="btn-ok" disabled>Guardar</button>

        <!-- otros -->
        <button id="btnNuevo" class="btn-blue">Nuevo</button>
        <button id="btnPrint" class="btn-ghost">Imprimir / Enviar a PDF</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- CONFIG API -->
    <section class="card">
      <div class="card-h">
        <div>
          <h2>Conexión (WebApp Apps Script)</h2>
          <div class="sub">Pega aquí tu URL del deploy (<span class="mono">/exec</span>). Se guarda en este navegador.</div>
        </div>
      </div>
      <div class="card-b">
        <div class="form-grid">
          <div class="field col-12">
            <div class="lbl">URL WebApp</div>
            <input id="webappUrl" placeholder="https://script.google.com/macros/s/XXXX/exec" />
          </div>
        </div>
        <div class="hint warn" style="margin-top:10px">
          Si ves “No se pudo cargar el script”, casi siempre es porque el deploy NO está público.
          En Apps Script: <b>Deploy → Manage deployments</b> → Access: <b>Anyone</b> y Execute as: <b>Me</b>.
        </div>
      </div>
    </section>

    <!-- FASE + NIVEL -->
    <section class="card">
      <div class="card-h">
        <div>
          <h2>Fase</h2>
          <div class="sub" id="faseHelp">Selecciona una fase para desplegar el formulario.</div>
        </div>
        <div class="controls">
          <label class="sub">Fase</label>
          <select id="faseSelect">
            <option value="">Seleccione</option>
            <option value="FORMULARIOS">Formularios</option>
            <option value="PESOS">Pesos</option>
            <option value="AUTO">Formulario de autoevaluación</option>
            <option value="CLIENTES">Formulario de evaluación de clientes</option>
            <option value="DESEMPENO">Formulario de evaluación del desempeño</option>
            <option value="RESULTADO">Resultado evaluación del desempeño</option>
            <option value="CONSOLIDADO">Informe consolidado</option>
            <option value="CAPACITACION">Informe necesidades de capacitacion</option>
            <option value="DESARROLLO">Informe plan de desarrollo</option>
          </select>

          <label class="sub" style="margin-left:8px">Nivel</label>
          <select id="nivelSelect" disabled><option>Cargando niveles…</option></select>
        </div>
      </div>
      <div class="card-b">
        <div class="hint">El guardado se envía a Google Sheets (Web App de Apps Script).</div>
      </div>
    </section>

    <!-- FORMULARIOS -->
    <section class="card" data-phase-block="FORMULARIOS" id="blockFormularios">
      <div class="card-h">
        <div>
          <h2>Formularios</h2>
          <div class="sub">Selecciona Nivel (Todos/1/2/…/10) y presiona <b>Cargar</b>.</div>
        </div>
        <div class="controls">
          <button id="btnCargarFormularios" class="btn-blue">Cargar</button>
          <button id="btnLimpiarFormularios" class="btn-warn">Limpiar</button>
        </div>
      </div>
      <div class="card-b">
        <div class="chips" style="margin-bottom:10px">
          <span class="chip" id="rowsCount">Filas: 0</span>
          <span class="chip mono">Columnas: Nivel | Factor | Item | 1..5</span>
        </div>
        <div id="formHint" class="hint">Aún no has cargado datos.</div>

        <div class="table-wrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th style="width:90px">Nivel</th>
                <th style="width:220px">Factor</th>
                <th style="width:260px">Item</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
              </tr>
            </thead>
            <tbody id="tbodyFormularios">
              <tr><td colspan="8" class="muted">Sin datos.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PESOS -->
    <section class="card" data-phase-block="PESOS" id="blockPesos">
      <div class="card-h">
        <div>
          <h2>Pesos</h2>
          <div class="sub">Selecciona Nivel (Todos/1/2/…/10) y presiona <b>Cargar</b>.</div>
        </div>
        <div class="controls">
          <button id="btnCargarPesos" class="btn-blue">Cargar</button>
          <button id="btnLimpiarPesos" class="btn-warn">Limpiar</button>
        </div>
      </div>
      <div class="card-b">
        <div class="chips" style="margin-bottom:10px">
          <span class="chip" id="rowsCountPesos">Filas: 0</span>
          <span class="chip mono">Columnas: Nivel | Factor | Item | Peso</span>
        </div>
        <div id="pesosHint" class="hint">Aún no has cargado datos.</div>

        <div class="table-wrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th style="width:90px">Nivel</th>
                <th style="width:260px">Factor</th>
                <th>Item</th>
                <th style="width:140px">Peso</th>
              </tr>
            </thead>
            <tbody id="tbodyPesos">
              <tr><td colspan="4" class="muted">Sin datos.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" data-phase-block="CLIENTES">
      <div class="card-h">
        <h2>Formulario de evaluación de clientes</h2>
        <div class="sub">Vista en construcción.</div>
      </div>
      <div class="card-b"><div class="hint">Aquí irá el formulario para clientes.</div></div>
    </section>

    <!-- ✅ DESEMPENO ahora usa el mismo formulario evaluable que AUTO -->
    <!-- DATOS COLABORADOR (AUTO/DESEMPENO) -->
    <section class="card" data-phase-block="EVAL" id="blockDatos">
      <div class="card-h">
        <div>
          <h2>Datos del colaborador</h2>
          <div class="sub">Completa la información y selecciona una opción (1–5) para cada ítem.</div>
        </div>
      </div>
      <div class="card-b">
        <div class="form-grid">
          <div class="field col-3">
            <div class="lbl">No. de personal</div>
            <input id="noPersonal" placeholder="Ej: 1600" />
          </div>
          <div class="field col-6">
            <div class="lbl">Nombre</div>
            <input id="nombre" placeholder="Ej: Carlos Paz" />
          </div>
          <div class="field col-3">
            <div class="lbl">Posición</div>
            <input id="posicion" placeholder="Ej: Analista" />
          </div>
          <div class="field col-4">
            <div class="lbl">Departamento</div>
            <input id="depto" placeholder="Ej: Contabilidad" />
          </div>
          <div class="field col-4">
            <div class="lbl">Periodo</div>
            <input id="periodo" placeholder="Ej: 2025" />
          </div>
          <div class="field col-2">
            <div class="lbl">Versión</div>
            <input id="version" placeholder="Ej: 1" />
          </div>
          <div class="field col-2">
            <div class="lbl">Fecha</div>
            <input id="fecha" />
          </div>
        </div>

        <div class="sub" style="margin-top:10px">
          Estado API: <b id="apiMini">—</b>
        </div>
      </div>
    </section>

    <!-- CUESTIONARIO (AUTO/DESEMPENO) -->
    <section class="card" data-phase-block="EVAL" id="blockEval">
      <div class="card-h">
        <div>
          <h2>Evaluación (1–5)</h2>
          <div class="sub">Cada nivel muestra “número — descripción” según la rúbrica.</div>
        </div>
        <div class="chips">
          <span class="chip" id="itemsCount">Items: 0</span>
          <span class="chip" id="completeHint">Completado: 0/0</span>
        </div>
      </div>
      <div class="card-b">
        <div id="cuestionario"></div>
      </div>
    </section>

    <!-- COMENTARIOS (AUTO/DESEMPENO) -->
    <section class="card" data-phase-block="EVAL" id="blockComentarios">
      <div class="card-h">
        <div>
          <h2>Comentarios</h2>
          <div class="sub">Incluye observaciones, ejemplos, mejoras o apoyo requerido.</div>
        </div>
      </div>
      <div class="card-b">
        <textarea id="comentarios" placeholder="Comentarios..."></textarea>
      </div>
    </section>

    <section class="card" data-phase-block="RESULTADO">
      <div class="card-h">
        <h2>Resultado evaluación del desempeño</h2>
        <div class="sub">Vista en construcción.</div>
      </div>
      <div class="card-b"><div class="hint">Aquí irá el resultado (promedios, ponderaciones, etc.).</div></div>
    </section>

    <section class="card" data-phase-block="CONSOLIDADO">
      <div class="card-h">
        <h2>Informe consolidado</h2>
        <div class="sub">Vista en construcción.</div>
      </div>
      <div class="card-b"><div class="hint">Aquí irá el informe consolidado por área/empresa.</div></div>
    </section>

    <section class="card" data-phase-block="CAPACITACION">
      <div class="card-h">
        <h2>Informe necesidades de capacitacion</h2>
        <div class="sub">Vista en construcción.</div>
      </div>
      <div class="card-b"><div class="hint">Aquí irá el informe de brechas y necesidades.</div></div>
    </section>

    <section class="card" data-phase-block="DESARROLLO">
      <div class="card-h">
        <h2>Informe plan de desarrollo</h2>
        <div class="sub">Vista en construcción.</div>
      </div>
      <div class="card-b"><div class="hint">Aquí irá el plan de desarrollo individual.</div></div>
    </section>

  </div>
</main>

<script>
/* ================= CONFIG ================= */
const LS_KEY_URL = "ED_WEBAPP_URL";
const DEFAULT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyPC5yq-Bw0oT47Pv6cj_kQvbx4BU-sqDm1Vl0fG2lxuMMP7hxAyXmcLxJjnJB0xQim/exec";
const $ = id => document.getElementById(id);

function getWebAppUrl(){
  const v = ($("webappUrl").value || "").trim();
  return v || DEFAULT_WEBAPP_URL;
}
function setWebAppUrl(v){ $("webappUrl").value = v || ""; }

/* ================= STATE ================= */
const state = {
  fase: "",
  nivel: null,
  form: null,
  // answers: key -> { value:"3", label:"3 — texto..." }
  answers: new Map(),
  itemKeys: [],
};

/* ================= STATUS ================= */
function setApiStatus(mode,text){
  const el=$("apiStatus");
  el.classList.remove("ok","err");
  if(mode) el.classList.add(mode);
  $("apiStatusText").textContent=text;
  const mini = $("apiMini");
  if (mini) mini.textContent = text.replace("API: ","");
}

/* ================= JSONP API ================= */
function buildUrl(params, cbName){
  const url = new URL(getWebAppUrl());
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  url.searchParams.set("callback", cbName);
  url.searchParams.set("_", String(Date.now()));
  return url.toString();
}
function apiGet(params, timeoutMs=15000){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    const src = buildUrl(params, cb);
    setApiStatus("", "API: consultando…");

    const s=document.createElement("script");
    s.async = true;
    let done=false;

    const t=setTimeout(()=>{
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("Timeout: la WebApp no respondió. Revisa Deploy/Access/URL."));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(t);
      try { delete window[cb]; } catch(_) { window[cb]=undefined; }
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb]=data=>{
      if(done) return;
      done=true;
      cleanup();
      if(!data || typeof data !== "object"){
        reject(new Error("Respuesta no-JSON (posible login/permiso). Deploy debe ser público."));
        return;
      }
      if(data.ok!==true){
        reject(new Error(data.error || "Respuesta inválida"));
        return;
      }
      setApiStatus("ok","API: conectada");
      resolve(data);
    };

    s.onerror=()=>{
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("No se pudo cargar el script. Causa típica: deploy privado, URL incorrecta o bloqueador/extensión."));
    };

    s.src = src;
    document.body.appendChild(s);
  });
}

/* ================= UTIL ================= */
function todayLocal(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${dd}/${mm}/${yyyy}`;
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

function fillNivelSelect(levels, includeAll=false){
  const sel = $("nivelSelect");
  sel.innerHTML = "";
  if(includeAll){
    const oAll = document.createElement("option");
    oAll.value = "ALL";
    oAll.textContent = "Todos";
    sel.appendChild(oAll);
  }
  levels.forEach(l=>{
    const v = String(l);
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });
}
function pickDefault(levels, includeAll){
  if(includeAll) return "ALL";
  const has1 = levels.some(x => String(x).trim() === "1" || String(x).trim().startsWith("1"));
  return has1 ? "1" : String(levels[0] ?? "1");
}

/* ================= FASES EVALUABLES ================= */
function isEvalPhase(){
  return state.fase === "AUTO" || state.fase === "DESEMPENO";
}

/* ================= VALIDATION (EVAL) ================= */
function getEvalRequiredFields(){
  return [
    $("noPersonal").value.trim(),
    $("nombre").value.trim(),
    $("posicion").value.trim(),
    $("depto").value.trim(),
    $("periodo").value.trim(),
    $("version").value.trim(),
    $("fecha").value.trim(),
    $("comentarios").value.trim(),
  ];
}
function isEvalComplete(){
  if(!isEvalPhase()) return false;

  // datos + comentarios
  const req = getEvalRequiredFields();
  if(req.some(v => !v)) return false;

  // respuestas
  const total = state.itemKeys.length;
  if(total === 0) return false;

  for(const k of state.itemKeys){
    const obj = state.answers.get(k);
    if(!obj || !obj.value || !obj.label) return false;
  }
  return true;
}
function updateEvalUIState(){
  const btnG = $("btnGuardar");
  const total = state.itemKeys.length;

  let done = 0;
  for(const k of state.itemKeys){
    const obj = state.answers.get(k);
    if(obj && obj.value) done++;
  }
  $("completeHint").textContent = `Completado: ${done}/${total}`;

  if(!isEvalPhase()){
    btnG.disabled = true;
    $("btnLimpiarEval").style.display = "none";
    return;
  }

  $("btnLimpiarEval").style.display = "inline-block";
  btnG.disabled = !isEvalComplete();
}

/* ================= PHASE UI ================= */
function setPhase(phase){
  state.fase = phase || "";

  // Bloques normales por fase
  document.querySelectorAll("[data-phase-block]").forEach(el=>{
    const p = el.getAttribute("data-phase-block");
    el.classList.remove("show");
    if(p === state.fase) el.classList.add("show");
  });

  // Bloques EVAL (AUTO/DESEMPENO)
  document.querySelectorAll('[data-phase-block="EVAL"]').forEach(el=>{
    el.classList.toggle("show", isEvalPhase());
  });

  const enableNivel = (isEvalPhase() || state.fase === "FORMULARIOS" || state.fase === "PESOS");
  $("nivelSelect").disabled = !enableNivel;

  const labelByPhase = {
    "FORMULARIOS": "Formularios: Selecciona nivel (Todos / 1..10) y carga para ver la tabla.",
    "PESOS": "Pesos: Selecciona nivel (Todos / 1..10) y carga para ver la tabla.",
    "AUTO": "Autoevaluación activa. Selecciona nivel para cargar ítems.",
    "DESEMPENO": "Evaluación del desempeño activa. Selecciona nivel para cargar ítems.",
    "CLIENTES": "Evaluación de clientes.",
    "RESULTADO": "Resultados del desempeño.",
    "CONSOLIDADO": "Informe consolidado.",
    "CAPACITACION": "Necesidades de capacitación.",
    "DESARROLLO": "Plan de desarrollo."
  };
  $("faseHelp").textContent = labelByPhase[state.fase] || "Selecciona una fase para desplegar el formulario.";

  if(!isEvalPhase()){
    $("cuestionario").innerHTML = `<div class="hint">Selecciona una fase evaluable (Autoevaluación / Desempeño) para ver el cuestionario.</div>`;
    $("itemsCount").textContent = "Items: 0";
    $("completeHint").textContent = "Completado: 0/0";
  }

  // UX: ocultar botones opcionales en fases evaluables
  $("btnNuevo").style.display = isEvalPhase() ? "none" : "inline-block";
  $("btnPrint").style.display = isEvalPhase() ? "none" : "inline-block";

  updateEvalUIState();
}

/* ================= EVAL: RENDER FORM ================= */
function renderCuestionario(form){
  const root = $("cuestionario");
  root.innerHTML = "";
  state.itemKeys = [];

  if(!isEvalPhase()){
    root.innerHTML = `<div class="hint">Selecciona una fase evaluable para ver el cuestionario.</div>`;
    $("itemsCount").textContent = "Items: 0";
    $("completeHint").textContent = "Completado: 0/0";
    updateEvalUIState();
    return;
  }

  if(!form || !form.factors || !form.factors.length){
    root.innerHTML = `<div class="hint">No hay ítems para este nivel.</div>`;
    $("itemsCount").textContent = "Items: 0";
    $("completeHint").textContent = "Completado: 0/0";
    updateEvalUIState();
    return;
  }

  let totalItems = 0;

  form.factors.forEach((f, idxF)=>{
    const box = document.createElement("div");
    box.className = "factor";
    box.innerHTML = `<div class="factor-title">${idxF+1}. ${escapeHtml(f.factor || "Factor")}</div>`;

    (f.items || []).forEach((it)=>{
      totalItems++;
      const key = it.key;
      state.itemKeys.push(key);

      const current = state.answers.get(key)?.value || "";

      const r = it.rubrica || {};
      const r1 = String(r["1"] ?? "");
      const r2 = String(r["2"] ?? "");
      const r3 = String(r["3"] ?? "");
      const r4 = String(r["4"] ?? "");
      const r5 = String(r["5"] ?? "");

      const row = document.createElement("div");
      row.className = "item-row";
      row.innerHTML = `
        <div>
          <div class="item-name">${escapeHtml(it.item || "Ítem")}</div>
          <div class="item-sub">Selecciona 1–5 según la rúbrica.</div>
        </div>

        <div class="item-select">
          <div class="lbl">Puntaje (1–5)</div>
          <select data-key="${escapeAttr(key)}">
            <option value="" ${current==="" ? "selected":""}>Seleccione</option>
            <option value="1" ${current==="1" ? "selected":""}>1 — ${escapeHtml(r1)}</option>
            <option value="2" ${current==="2" ? "selected":""}>2 — ${escapeHtml(r2)}</option>
            <option value="3" ${current==="3" ? "selected":""}>3 — ${escapeHtml(r3)}</option>
            <option value="4" ${current==="4" ? "selected":""}>4 — ${escapeHtml(r4)}</option>
            <option value="5" ${current==="5" ? "selected":""}>5 — ${escapeHtml(r5)}</option>
          </select>
        </div>
      `;

      const sel = row.querySelector("select");
      sel.addEventListener("change", (e)=>{
        const k = e.target.getAttribute("data-key");
        const v = e.target.value;

        if(!v){
          state.answers.delete(k);
        }else{
          // ✅ Guardamos: numero + texto visible (ej: "3 — Asigna...")
          const label = e.target.selectedOptions?.[0]?.textContent?.trim() || v;
          state.answers.set(k, { value: v, label });
        }
        updateEvalUIState();
      });

      box.appendChild(row);
    });

    root.appendChild(box);
  });

  $("itemsCount").textContent = `Items: ${totalItems}`;
  updateEvalUIState();
}

/* ================= FORMULARIOS: TABLE ================= */
function clearFormulariosTable(){
  $("tbodyFormularios").innerHTML = `<tr><td colspan="8" class="muted">Sin datos.</td></tr>`;
  $("rowsCount").textContent = "Filas: 0";
  $("formHint").textContent = "Aún no has cargado datos.";
}
function renderFormulariosItems(items){
  const tb = $("tbodyFormularios");
  if(!items || !items.length){
    clearFormulariosTable();
    $("formHint").textContent = "No se encontraron filas para ese nivel.";
    return;
  }
  $("formHint").textContent = "Datos cargados desde Google Sheets.";
  $("rowsCount").textContent = `Filas: ${items.length}`;
  tb.innerHTML = items.map(r => `
    <tr>
      <td><b>${escapeHtml(r.Nivel ?? "")}</b></td>
      <td>${escapeHtml(r.Factor ?? "")}</td>
      <td>${escapeHtml(r.Item ?? "")}</td>
      <td>${escapeHtml(r["1"] ?? "")}</td>
      <td>${escapeHtml(r["2"] ?? "")}</td>
      <td>${escapeHtml(r["3"] ?? "")}</td>
      <td>${escapeHtml(r["4"] ?? "")}</td>
      <td>${escapeHtml(r["5"] ?? "")}</td>
    </tr>
  `).join("");
}
async function cargarFormularios(){
  if(state.fase !== "FORMULARIOS") return;
  const nivel = $("nivelSelect").value;
  const res = await apiGet({action:"items", sheet:"Formularios", nivel: (nivel && nivel !== "ALL") ? String(nivel) : "ALL"});
  renderFormulariosItems(res.items || []);
}

/* ================= PESOS: TABLE ================= */
function clearPesosTable(){
  $("tbodyPesos").innerHTML = `<tr><td colspan="4" class="muted">Sin datos.</td></tr>`;
  $("rowsCountPesos").textContent = "Filas: 0";
  $("pesosHint").textContent = "Aún no has cargado datos.";
}
function renderPesosItems(items){
  const tb = $("tbodyPesos");
  if(!items || !items.length){
    clearPesosTable();
    $("pesosHint").textContent = "No se encontraron filas para ese nivel.";
    return;
  }
  $("pesosHint").textContent = "Datos cargados desde Google Sheets.";
  $("rowsCountPesos").textContent = `Filas: ${items.length}`;
  tb.innerHTML = items.map(r => `
    <tr>
      <td><b>${escapeHtml(r.Nivel ?? "")}</b></td>
      <td>${escapeHtml(r.Factor ?? "")}</td>
      <td>${escapeHtml(r.Item ?? "")}</td>
      <td>${escapeHtml(r.Peso ?? "")}</td>
    </tr>
  `).join("");
}
async function cargarPesos(){
  if(state.fase !== "PESOS") return;
  const nivel = $("nivelSelect").value;
  const res = await apiGet({action:"items", sheet:"Pesos", nivel: (nivel && nivel !== "ALL") ? String(nivel) : "ALL"});
  renderPesosItems(res.items || []);
}

/* ================= LOADERS (levels + form) ================= */
async function loadLevelsForPhase(){
  if(isEvalPhase()){
    const lv = await apiGet({action:"levels", sheet:"Formularios"});
    const levels = lv.levels || [];
    if(!levels.length) throw new Error("No se encontraron niveles en 'Formularios'.");
    fillNivelSelect(levels, false);
    const def = pickDefault(levels, false);
    $("nivelSelect").value = def;
    state.nivel = def;
    return;
  }
  if(state.fase === "FORMULARIOS"){
    const lv = await apiGet({action:"levels", sheet:"Formularios"});
    const levels = lv.levels || [];
    if(!levels.length) throw new Error("No se encontraron niveles en 'Formularios'.");
    fillNivelSelect(levels, true);
    const def = pickDefault(levels, true);
    $("nivelSelect").value = def;
    state.nivel = def;
    return;
  }
  if(state.fase === "PESOS"){
    const lv = await apiGet({action:"levels", sheet:"Pesos"});
    const levels = lv.levels || [];
    if(!levels.length) throw new Error("No se encontraron niveles en 'Pesos'.");
    fillNivelSelect(levels, true);
    const def = pickDefault(levels, true);
    $("nivelSelect").value = def;
    state.nivel = def;
    return;
  }
}
async function loadFormByNivel(nivel){
  const res = await apiGet({action:"form", nivel: String(nivel)});
  state.form = res.form || null;
  state.answers.clear();
  renderCuestionario(state.form);
}

/* ================= ACTIONS ================= */
function clearEval(){
  ["noPersonal","nombre","posicion","depto","periodo","version"].forEach(id=>$(id).value="");
  $("comentarios").value = "";
  state.answers.clear();
  renderCuestionario(state.form);
  updateEvalUIState();
}

async function saveEval(){
  if(!isEvalPhase()){
    alert("Para guardar, usa Autoevaluación o Evaluación del desempeño.");
    return;
  }
  if(!isEvalComplete()){
    alert("Aún faltan datos / respuestas / comentarios. Completa todo para habilitar Guardar.");
    return;
  }

  // ✅ Guardamos en la hoja: "No — texto"
  const respuestasOrdenadas = state.itemKeys.map(k => (state.answers.get(k)?.label || ""));

  const payload = {
    fase: state.fase,             // "AUTO" o "DESEMPENO"
    nivel: String(state.nivel || ""),
    no: $("noPersonal").value.trim(),
    nombre: $("nombre").value.trim(),
    posicion: $("posicion").value.trim(),
    depto: $("depto").value.trim(),
    periodo: $("periodo").value.trim(),
    version: $("version").value.trim(),
    fecha: $("fecha").value.trim(),
    comentarios: $("comentarios").value.trim(),
    respuestas: respuestasOrdenadas
  };

  const json = JSON.stringify(payload);
  const b64 = btoa(unescape(encodeURIComponent(json)));

  const out = await apiGet({action:"save", payload:b64});

  alert("Guardado ✅\nID: " + (out.id || "—"));
  clearEval();
}

function printToPdf(){ window.print(); }

/* ================= EVENTS ================= */
$("webappUrl").addEventListener("change", ()=>{
  localStorage.setItem(LS_KEY_URL, $("webappUrl").value.trim());
});

$("btnProbarApi").addEventListener("click", async ()=>{
  try{
    await apiGet({action:"ping"});
    setApiStatus("ok","API: conectada");
  }catch(e){
    setApiStatus("err","API: " + e.message);
  }
});

$("faseSelect").addEventListener("change", async (e)=>{
  const fase = e.target.value;
  setPhase(fase);

  try{
    if(isEvalPhase() || fase === "FORMULARIOS" || fase === "PESOS"){
      await loadLevelsForPhase();
    }
    if(isEvalPhase()){
      await loadFormByNivel(state.nivel);
      updateEvalUIState();
    }
    if(fase === "FORMULARIOS") clearFormulariosTable();
    if(fase === "PESOS") clearPesosTable();
  }catch(err){
    setApiStatus("err","API: " + err.message);
  }
});

$("nivelSelect").addEventListener("change", async (e)=>{
  try{
    state.nivel = e.target.value;
    if(isEvalPhase()){
      await loadFormByNivel(state.nivel);
      updateEvalUIState();
    }
  }catch(err){
    setApiStatus("err","API: " + err.message);
  }
});

$("btnGuardar").addEventListener("click", ()=>saveEval().catch(err=>setApiStatus("err","API: " + err.message)));
$("btnLimpiarEval").addEventListener("click", clearEval);

$("btnNuevo").addEventListener("click", clearEval);
$("btnPrint").addEventListener("click", printToPdf);

$("btnCargarFormularios").addEventListener("click", ()=>cargarFormularios().catch(err=>setApiStatus("err","API: " + err.message)));
$("btnLimpiarFormularios").addEventListener("click", ()=>{
  clearFormulariosTable();
  if(state.fase === "FORMULARIOS"){
    $("nivelSelect").value = "ALL";
    state.nivel = "ALL";
  }
});

$("btnCargarPesos").addEventListener("click", ()=>cargarPesos().catch(err=>setApiStatus("err","API: " + err.message)));
$("btnLimpiarPesos").addEventListener("click", ()=>{
  clearPesosTable();
  if(state.fase === "PESOS"){
    $("nivelSelect").value = "ALL";
    state.nivel = "ALL";
  }
});

/* ✅ Validación “en vivo” */
["noPersonal","nombre","posicion","depto","periodo","version","fecha","comentarios"].forEach(id=>{
  const el = $(id);
  if(el){
    el.addEventListener("input", updateEvalUIState);
    el.addEventListener("change", updateEvalUIState);
  }
});

/* ================= BOOT ================= */
(function boot(){
  $("fecha").value = todayLocal();
  setPhase("");
  clearFormulariosTable();
  clearPesosTable();

  const saved = localStorage.getItem(LS_KEY_URL);
  setWebAppUrl(saved || DEFAULT_WEBAPP_URL);

  apiGet({action:"ping"})
    .then(()=>{
      setApiStatus("ok","API: conectada");
      $("cuestionario").innerHTML = `<div class="hint">Selecciona una fase para iniciar.</div>`;
    })
    .catch(e=>setApiStatus("err","API: "+e.message));

  updateEvalUIState();
})();
</script>
</body>
</html>
