<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Evaluaci√≥n del desempe√±o</title>
  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(15,23,42,.72);
      --panel2: rgba(2,6,23,.55);
      --stroke: rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#3b82f6;
      --brand2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 16px;
      --radius2: 12px;
      --maxw: 980px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(59,130,246,.28), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(1200px 600px at 50% 120%, rgba(245,158,11,.14), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:var(--maxw); margin:24px auto; padding:0 16px;}
    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,11,20,.92), rgba(7,11,20,.55));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .title{
      display:flex; align-items:center; gap:10px; font-weight:700;
      letter-spacing:.2px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--stroke);
      background: rgba(2,6,23,.35);
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:8px; height:8px; border-radius:50%; background:var(--brand2); box-shadow:0 0 0 3px rgba(34,197,94,.12)}
    .spacer{flex:1}
    select,input,textarea,button{
      font: inherit;
    }
    .control{
      display:flex; flex-direction:column; gap:6px;
      min-width: 240px;
    }
    label{font-size:12px; color:var(--muted)}
    select,input{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.28);
      background: rgba(2,6,23,.42);
      color: var(--text);
      outline:none;
    }
    textarea{
      width:100%;
      min-height:88px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.28);
      background: rgba(2,6,23,.42);
      color: var(--text);
      outline:none;
      resize: vertical;
    }
    .btn{
      border:1px solid rgba(148,163,184,.25);
      background: rgba(15,23,42,.55);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(15,23,42,.72)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(59,130,246,.25); border-color: rgba(59,130,246,.45)}
    .btn.good{background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35)}
    .btn.warn{background: rgba(245,158,11,.16); border-color: rgba(245,158,11,.35)}
    .btn.danger{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35)}
    .panel{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .panel-h h2{margin:0; font-size:14px; letter-spacing:.2px}
    .panel-b{padding:14px 16px;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 840px){ .grid2{grid-template-columns:1fr} .control{min-width: 200px;} }
    .muted{color:var(--muted); font-size:12px}
    .section{
      border:1px dashed rgba(148,163,184,.22);
      border-radius: 14px;
      padding:12px 12px;
      margin-top:12px;
      background: rgba(2,6,23,.25);
    }
    .factor-title{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin:0 0 10px 0;
      font-size:13px;
    }
    .item{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap:12px;
      padding:10px 10px;
      border:1px solid rgba(148,163,184,.14);
      border-radius: 14px;
      background: rgba(2,6,23,.22);
      margin-bottom:10px;
    }
    .item:last-child{margin-bottom:0}
    .item .ititle{margin:0; font-size:13px; font-weight:650}
    .item .isub{margin:4px 0 0 0; color:var(--muted); font-size:12px}
    .right label{display:block; margin-bottom:6px}
    .statusline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background: rgba(2,6,23,.35); color: var(--muted)}
    .hr{height:1px; background: var(--stroke); margin:10px 0}

    /* impresi√≥n */
    @media print{
      body{background:white; color:black}
      .topbar, .btn, .badge, .pill{display:none !important}
      .panel{box-shadow:none; border-color:#ddd; background:white}
      select, input, textarea{border:1px solid #bbb; background:white; color:black}
      .item{page-break-inside: avoid}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="row">
        <div class="title">
          <span class="pill"><span class="dot"></span> Proceso de evaluaci√≥n del desempe√±o</span>
          <span class="pill" id="envPill">Empresa: <b style="color:var(--text); font-weight:650">No implementado</b></span>
          <span class="pill" id="verPill">Versi√≥n: <b style="color:var(--text); font-weight:650">Prueba</b></span>
        </div>
        <div class="spacer"></div>

        <div class="control" style="min-width: 360px;">
          <label for="phaseSel">Fase</label>
          <select id="phaseSel">
            <option>Formularios</option>
            <option>Pesos</option>
            <option selected>Formulario de autoevaluaci√≥n</option>
            <option>Formulario de evaluaci√≥n de clientes</option>
            <option>Formulario de evaluaci√≥n del desempe√±o</option>
            <option>Resultados evaluaci√≥n del desempe√±o</option>
            <option>Informe consolidado</option>
            <option>Informe de necesidades de capacitaci√≥n</option>
            <option>Informe de plan de desarrollo</option>
          </select>
        </div>

        <button class="btn warn" id="btnNew">Nuevo</button>
        <button class="btn good" id="btnSave">Guardar</button>
        <button class="btn" id="btnPrint">Imprimir / Enviar a PDF</button>
      </div>

      <div class="statusline" style="margin-top:10px;">
        <span class="badge" id="apiStatus">API: sin configurar</span>
        <span class="badge" id="formsStatus">Formularios: ‚Äî</span>
        <span class="badge" id="weightsStatus">Pesos: ‚Äî</span>
      </div>
    </div>

    <div class="panel" id="panelMain">
      <div class="panel-h">
        <h2 id="panelTitle">Formulario de autoevaluaci√≥n</h2>
        <span class="muted" id="panelHint">Por defecto: Nivel 1</span>
      </div>
      <div class="panel-b" id="panelBody">
        <!-- Aqu√≠ se renderiza la vista -->
      </div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyqy8Vi-OHjCl9TkZY5m1WicNkdJPjBxavk-pCNhze2UzytkvdZEZvc9VZJKeJCdm9d/exec";

/** =========================
 * JSONP helper (GitHub-friendly)
 * ========================= */
function jsonpRequest(params){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const url = new URL(SCRIPT_URL);
    Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, v));
    url.searchParams.set("callback", cb);

    const script = document.createElement("script");
    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error("Tiempo de espera agotado en JSONP"));
    }, 25000);

    function cleanup(){
      clearTimeout(timeout);
      delete window[cb];
      script.remove();
    }

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    script.onerror = () => {
      cleanup();
      reject(new Error("Error cargando JSONP (revisa URL / permisos Web App)"));
    };

    script.src = url.toString();
    document.body.appendChild(script);
  });
}

const API = {
  ping: () => jsonpRequest({action:"ping"}),
  getMeta: () => jsonpRequest({action:"getMeta"}), // niveles + estados
  loadForms: () => jsonpRequest({action:"loadForms"}),
  clearForms: () => jsonpRequest({action:"clearForms"}),
  loadWeights: () => jsonpRequest({action:"loadWeights"}),
  clearWeights: () => jsonpRequest({action:"clearWeights"}),
  getQuestionnaire: (nivel) => jsonpRequest({action:"getQuestionnaire", nivel:String(nivel)}),
  saveAutoeval: (payloadObj) => jsonpRequest({action:"saveAutoeval", payload: encodeURIComponent(JSON.stringify(payloadObj))}),
};

/** =========================
 * State
 * ========================= */
const state = {
  phase: "Formulario de autoevaluaci√≥n",
  meta: null,
  currentLevel: 1,
  questionnaire: null,
  answers: new Map(), // key=itemId, value=score
};

/** =========================
 * DOM
 * ========================= */
const phaseSel = document.getElementById("phaseSel");
const panelTitle = document.getElementById("panelTitle");
const panelHint = document.getElementById("panelHint");
const panelBody = document.getElementById("panelBody");
const apiStatus = document.getElementById("apiStatus");
const formsStatus = document.getElementById("formsStatus");
const weightsStatus = document.getElementById("weightsStatus");
const btnNew = document.getElementById("btnNew");
const btnSave = document.getElementById("btnSave");
const btnPrint = document.getElementById("btnPrint");

/** =========================
 * Init
 * ========================= */
(async function init(){
  // Fase por defecto
  state.phase = phaseSel.value;

  // Botones
  btnPrint.addEventListener("click", () => window.print());
  btnNew.addEventListener("click", onNew);
  btnSave.addEventListener("click", onSave);

  phaseSel.addEventListener("change", async () => {
    state.phase = phaseSel.value;
    await renderPhase();
  });

  // Ping API
  try{
    const pong = await API.ping();
    apiStatus.textContent = "API: OK";
    apiStatus.style.borderColor = "rgba(34,197,94,.35)";
    apiStatus.style.background = "rgba(34,197,94,.16)";
    await refreshMeta();
    await renderPhase();
  }catch(err){
    apiStatus.textContent = "API: error (revisa SCRIPT_URL)";
    apiStatus.style.borderColor = "rgba(239,68,68,.35)";
    apiStatus.style.background = "rgba(239,68,68,.14)";
    panelBody.innerHTML = `<div class="muted">
      <b>Falta configurar la API.</b><br/>
      1) Publica tu Apps Script como Web App (acceso: Cualquiera).<br/>
      2) Pega la URL /exec en <code>SCRIPT_URL</code>.<br/>
      <div style="margin-top:8px;color:#fca5a5">${escapeHtml(String(err.message||err))}</div>
    </div>`;
  }
})();

async function refreshMeta(){
  const meta = await API.getMeta();
  state.meta = meta;

  formsStatus.textContent = "Formularios: " + (meta?.formsLoaded ? "cargados" : "no cargados");
  weightsStatus.textContent = "Pesos: " + (meta?.weightsLoaded ? "cargados" : "no cargados");

  if(meta?.levels?.length){
    state.currentLevel = meta.levels.includes(1) ? 1 : meta.levels[0];
  }else{
    state.currentLevel = 1;
  }
}

/** =========================
 * Render router
 * ========================= */
async function renderPhase(){
  panelTitle.textContent = state.phase;

  // botones visibles solo cuando aplica
  const phase = state.phase;
  const showActions = (phase === "Formulario de autoevaluaci√≥n");
  btnNew.style.display = showActions ? "" : "none";
  btnSave.style.display = showActions ? "" : "none";
  btnPrint.style.display = showActions ? "" : "none";

  if(phase === "Formularios"){
    panelHint.textContent = "Carga/limpieza de base de cuestionarios";
    renderLoadPanel("Formularios",
      "Cargar los datos desde la pesta√±a 'Formularios' (Nivel, Factor, Item y escala 1‚Äì5).",
      async () => { await API.loadForms(); await refreshMeta(); toast("Formularios cargados ‚úÖ"); },
      async () => { await API.clearForms(); await refreshMeta(); toast("Base de formularios limpiada üßπ"); }
    );
    return;
  }

  if(phase === "Pesos"){
    panelHint.textContent = "Carga/limpieza de pesos por √≠tem";
    renderLoadPanel("Pesos",
      "Cargar los pesos desde la hoja 'Pesos' en el mismo orden de los √≠tems.",
      async () => { await API.loadWeights(); await refreshMeta(); toast("Pesos cargados ‚úÖ"); },
      async () => { await API.clearWeights(); await refreshMeta(); toast("Base de pesos limpiada üßπ"); }
    );
    return;
  }

  if(phase === "Formulario de autoevaluaci√≥n"){
    panelHint.textContent = "Por defecto: Nivel 1";
    await renderAutoeval();
    return;
  }

  // placeholders para fases futuras
  panelHint.textContent = "M√≥dulo en construcci√≥n (estructura lista para agregar).";
  panelBody.innerHTML = `<div class="muted">
    Este m√≥dulo a√∫n no est√° implementado, pero ya est√° ‚Äúenchufado‚Äù en el men√∫.<br/>
    <div class="hr"></div>
    Tip: aqu√≠ conectar√°s consultas y reportes sin tocar la autoevaluaci√≥n.
  </div>`;
}

function renderLoadPanel(title, desc, onLoad, onClear){
  panelBody.innerHTML = `
    <div class="section">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:700">${escapeHtml(title)}</div>
          <div class="muted" style="margin-top:4px">${escapeHtml(desc)}</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="btnLoad">Cargar</button>
          <button class="btn danger" id="btnClear">Limpiar</button>
        </div>
      </div>
    </div>
    <div class="muted" style="margin-top:10px">
      Nota: ‚ÄúCargar‚Äù valida y deja disponible la base para renderizar cuestionarios; ‚ÄúLimpiar‚Äù solo limpia la base de cache (no borra tus hojas fuente).
    </div>
  `;
  document.getElementById("btnLoad").onclick = safeRun(onLoad);
  document.getElementById("btnClear").onclick = safeRun(onClear);
}

/** =========================
 * Autoevaluaci√≥n
 * ========================= */
async function renderAutoeval(){
  // UI base
  const levels = (state.meta?.levels?.length ? state.meta.levels : [1]);
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  const todayStr = `${yyyy}-${mm}-${dd}`;

  panelBody.innerHTML = `
    <div class="section">
      <div class="factor-title">
        <div><b>Datos del colaborador</b></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div class="control" style="min-width:220px">
            <label>Nivel</label>
            <select id="levelSel">
              ${levels.map(n => `<option value="${n}" ${n===state.currentLevel?"selected":""}>${n}</option>`).join("")}
            </select>
          </div>
        </div>
      </div>

      <div class="grid2">
        <div class="control"><label>No de personal</label><input id="noPersonal" placeholder="Ej: 00123"/></div>
        <div class="control"><label>Nombre</label><input id="nombre" placeholder="Nombre completo"/></div>
        <div class="control"><label>Posici√≥n</label><input id="posicion" placeholder="Puesto"/></div>
        <div class="control"><label>Departamento</label><input id="depto" placeholder="√Årea"/></div>
        <div class="control"><label>Periodo</label><input id="periodo" placeholder="Ej: 2026-Q1"/></div>
        <div class="control"><label>Versi√≥n</label><input id="version" placeholder="Ej: v1"/></div>
        <div class="control"><label>Fecha</label><input id="fecha" value="${todayStr}" readonly/></div>
      </div>
    </div>

    <div class="section" id="formSection">
      <div class="muted">Cargando cuestionario del nivel ${state.currentLevel}‚Ä¶</div>
    </div>

    <div class="section">
      <div class="factor-title">
        <div><b>Comentarios del colaborador</b></div>
        <div class="muted">Incluye observaciones, ejemplos, mejoras o apoyo requerido.</div>
      </div>
      <textarea id="comentarios" placeholder="Comentarios del colaborador..."></textarea>
    </div>
  `;

  const levelSel = document.getElementById("levelSel");
  levelSel.addEventListener("change", async () => {
    state.currentLevel = Number(levelSel.value);
    state.answers.clear();
    await loadAndRenderQuestionnaire();
  });

  await loadAndRenderQuestionnaire();
}

async function loadAndRenderQuestionnaire(){
  const formSection = document.getElementById("formSection");
  try{
    const q = await API.getQuestionnaire(state.currentLevel);
    state.questionnaire = q;
    renderQuestionnaire(formSection, q);
  }catch(err){
    formSection.innerHTML = `<div class="muted" style="color:#fca5a5">
      Error cargando el cuestionario: ${escapeHtml(String(err.message||err))}<br/>
      Tip: ve a Fase ‚ÄúFormularios‚Äù y presiona ‚ÄúCargar‚Äù.
    </div>`;
  }
}

function renderQuestionnaire(container, q){
  if(!q?.items?.length){
    container.innerHTML = `<div class="muted">No hay √≠tems para este nivel.</div>`;
    return;
  }

  // Agrupar por Factor
  const byFactor = new Map();
  for(const it of q.items){
    const factor = it.factor || "Sin factor";
    if(!byFactor.has(factor)) byFactor.set(factor, []);
    byFactor.get(factor).push(it);
  }

  let html = `
    <div class="factor-title">
      <div><b>Evaluaci√≥n (1‚Äì5)</b></div>
      <div class="muted">Selecciona una opci√≥n por √≠tem.</div>
    </div>
  `;

  for(const [factor, items] of byFactor.entries()){
    html += `<div class="section">
      <div class="factor-title">
        <div>${escapeHtml(factor)}</div>
        <div class="muted">Nivel ${q.nivel}</div>
      </div>
    `;

    items.forEach((it, idx) => {
      const itemId = it.itemId;
      const title = it.itemText;
      const opts = it.scale; // [{score, desc}]
      html += `
        <div class="item">
          <div>
            <p class="ititle">${escapeHtml(title)}</p>
            <p class="isub">Selecciona 1‚Äì5 seg√∫n la r√∫brica.</p>
          </div>
          <div class="right">
            <label>Puntaje (1‚Äì5)</label>
            <select data-itemid="${escapeHtml(itemId)}">
              <option value="">Seleccionar‚Ä¶</option>
              ${opts.map(o => `<option value="${o.score}">${o.score} ‚Äî ${escapeHtml(o.desc || "")}</option>`).join("")}
            </select>
          </div>
        </div>
      `;
    });

    html += `</div>`;
  }

  container.innerHTML = html;

  // bind selects
  container.querySelectorAll("select[data-itemid]").forEach(sel => {
    sel.addEventListener("change", () => {
      const id = sel.getAttribute("data-itemid");
      const v = sel.value ? Number(sel.value) : null;
      if(v==null) state.answers.delete(id);
      else state.answers.set(id, v);
    });
  });
}

/** =========================
 * Actions
 * ========================= */
function onNew(){
  if(state.phase !== "Formulario de autoevaluaci√≥n") return;
  // reset inputs + answers
  ["noPersonal","nombre","posicion","depto","periodo","version","comentarios"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = "";
  });
  state.answers.clear();
  // reset all selects in questionnaire
  const formSection = document.getElementById("formSection");
  if(formSection){
    formSection.querySelectorAll("select[data-itemid]").forEach(s=> s.value="");
  }
  toast("Formulario reiniciado üßº");
}

async function onSave(){
  if(state.phase !== "Formulario de autoevaluaci√≥n") return;
  if(!state.questionnaire?.items?.length){
    toast("No hay cuestionario cargado para guardar.", true);
    return;
  }

  // Validar b√°sicos
  const noPersonal = val("noPersonal");
  const nombre = val("nombre");
  const posicion = val("posicion");
  const depto = val("depto");
  const periodo = val("periodo");
  const version = val("version");
  const fecha = val("fecha");
  const comentarios = val("comentarios");

  // Validar que todos los √≠tems tengan respuesta
  const missing = state.questionnaire.items.filter(it => !state.answers.has(it.itemId));
  if(missing.length){
    toast(`Faltan ${missing.length} respuestas. Completa el formulario antes de guardar.`, true);
    return;
  }

  const payload = {
    fase: "Autoevaluacion",
    nivel: state.currentLevel,
    colaborador: { noPersonal, nombre, posicion, departamento:depto, periodo, version, fecha },
    comentarios,
    respuestas: state.questionnaire.items.map((it, i) => ({
      idx: i+1,
      itemId: it.itemId,
      factor: it.factor,
      itemText: it.itemText,
      score: state.answers.get(it.itemId)
    }))
  };

  try{
    btnSave.disabled = true;
    btnSave.textContent = "Guardando...";
    const res = await API.saveAutoeval(payload);
    if(res?.ok){
      toast(`Guardado ‚úÖ (fila ${res.row || "?"})`);
    }else{
      toast("No se pudo guardar: " + (res?.error || "desconocido"), true);
    }
  }catch(err){
    toast("Error guardando: " + (err.message||err), true);
  }finally{
    btnSave.disabled = false;
    btnSave.textContent = "Guardar";
  }
}

/** =========================
 * Utils
 * ========================= */
function val(id){ return (document.getElementById(id)?.value || "").trim(); }

function safeRun(fn){
  return async () => {
    try{ await fn(); }
    catch(err){ toast(String(err.message||err), true); }
  }
}

function toast(msg, isBad=false){
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position = "fixed";
  el.style.right = "16px";
  el.style.bottom = "16px";
  el.style.padding = "10px 12px";
  el.style.borderRadius = "12px";
  el.style.border = "1px solid rgba(148,163,184,.25)";
  el.style.background = isBad ? "rgba(239,68,68,.18)" : "rgba(34,197,94,.16)";
  el.style.color = "white";
  el.style.zIndex = 9999;
  el.style.maxWidth = "520px";
  el.style.boxShadow = "0 20px 60px rgba(0,0,0,.55)";
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 3600);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
</script>
</body>
</html>
