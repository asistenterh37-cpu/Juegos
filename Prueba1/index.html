<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Evaluaci√≥n del Desempe√±o</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#121f3d;
      --text:#e8eefc;
      --muted:#a9b7d9;
      --line:rgba(255,255,255,.10);
      --accent:#4f7cff;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --chip:#1a2a52;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(79,124,255,.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.75);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:16px 18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:700;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 4px rgba(79,124,255,.18);
    }
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    select, button{
      background: var(--panel);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
    }
    select{min-width:280px}
    button{cursor:pointer}
    .btn-ok{
      background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.10));
      border-color: rgba(34,197,94,.35)
    }
    .btn-ghost{background:transparent}
    main{padding:18px}
    .grid{max-width:1180px;margin:0 auto;display:grid;gap:14px}
    .card{
      background: linear-gradient(180deg, rgba(18,31,61,.9), rgba(15,27,51,.92));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .card-h h2{margin:0;font-size:16px}
    .sub{color:var(--muted);font-size:13px}
    .card-b{padding:14px 16px}
    .chip{
      background: rgba(26,42,82,.75);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted)
    }
    .status{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:12px}
    .status .s-dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .status.ok .s-dot{background:var(--accent2)}
    .status.err .s-dot{background:var(--danger)}
    .hidden{display:none}
    .table-wrap{overflow:auto;border-radius:14px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:13px}
    th{background:rgba(15,27,51,.85);color:var(--muted);position:sticky;top:0}
    small{color:var(--muted)}
    .hint{
      background: rgba(79,124,255,.10);
      border:1px dashed rgba(79,124,255,.35);
      padding:10px 12px;
      border-radius:14px;
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          Sistema de Evaluaci√≥n del Desempe√±o
          <div class="sub">GitHub Pages + Google Apps Script</div>
        </div>
      </div>
      <div class="controls">
        <label class="sub">Fase</label>
        <select id="fase"></select>
        <span id="apiStatus" class="status">
          <span class="s-dot"></span>
          <span id="apiStatusText">API: sin probar</span>
        </span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- FORMULARIOS -->
    <section id="secFormularios" class="card hidden">
      <div class="card-h">
        <div>
          <h2>Formularios</h2>
          <div class="sub">Hoja Formularios (Nivel, Factor, Item, 1..5)</div>
        </div>
        <div>
          <span class="chip" id="fCountChip">Items: 0</span>
          <select id="fNivelSelect"></select>
          <button id="btnFormCargar" class="btn-ok">Cargar</button>
          <button id="btnFormLimpiar" class="btn-ghost">Limpiar</button>
        </div>
      </div>
      <div class="card-b">
        <div class="hint">‚ÄúLimpiar‚Äù solo limpia la vista üòÖ</div><br>
        <div class="table-wrap">
          <table id="tblFormularios">
            <thead>
              <tr>
                <th>Nivel</th><th>Factor</th><th>Item</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PESOS -->
    <section id="secPesos" class="card hidden">
      <div class="card-h">
        <div>
          <h2>Pesos</h2>
          <div class="sub">Hoja Pesos (Nivel, Factor, Item, Peso)</div>
        </div>
        <div>
          <span class="chip" id="pCountChip">Items: 0</span>
          <select id="pNivelSelect"></select>
          <button id="btnPesosCargar" class="btn-ok">Cargar</button>
          <button id="btnPesosLimpiar" class="btn-ghost">Limpiar</button>
        </div>
      </div>
      <div class="card-b">
        <div class="table-wrap">
          <table id="tblPesos">
            <thead>
              <tr>
                <th>Nivel</th><th>Factor</th><th>Item</th><th>Peso</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PLACEHOLDER -->
    <section id="secPlaceholder" class="card hidden">
      <div class="card-h">
        <h2 id="phTitle"></h2>
      </div>
      <div class="card-b">
        <div class="hint" id="phBody"></div>
      </div>
    </section>

  </div>
</main>

<script>
/* ================= CONFIG ================= */
const SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzHhg2hZo1rY4KX_IwRs6cPF2tY1L5H8OBHUgE1aXS_Kc2n5lRCUMVCwRHYaSfhGnpf/exec";

const FASES = [
  "Formularios","Pesos",
  "Formulario de autoevaluaci√≥n",
  "Formulario de evaluaci√≥n de clientes",
  "Formulario de evaluaci√≥n del desempe√±o",
  "Resultados evaluaci√≥n del desempe√±o",
  "Informe consolidado",
  "Informe de necesidades de capacitaci√≥n",
  "Informe de plan de desarrollo"
];
const DEFAULT_FASE = "Formulario de autoevaluaci√≥n";
const LS_KEYS = { forms:"ed_forms", pesos:"ed_pesos", apiOk:"ed_api_ok" };
const $ = id => document.getElementById(id);

/* ================= STATUS ================= */
function setApiStatus(mode,text){
  const el=$("apiStatus");
  el.classList.remove("ok","err");
  if(mode) el.classList.add(mode);
  $("apiStatusText").textContent=text;
}

/* ================= JSONP API ================= */
function apiGet(params){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    const url=new URL(SCRIPT_WEBAPP_URL);
    Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
    url.searchParams.set("callback",cb);

    const s=document.createElement("script");
    window[cb]=data=>{
      delete window[cb]; s.remove();
      if(!data || data.ok!==true) reject(new Error(data?.error||"API inv√°lida"));
      else{ setApiStatus("ok","API: conectada"); resolve(data); }
    };
    s.onerror=()=>reject(new Error("No se pudo conectar"));
    s.src=url.toString();
    document.body.appendChild(s);
  });
}

/* ================= UI ================= */
function showOnly(id){
  ["secFormularios","secPesos","secPlaceholder"].forEach(s=>$(s).classList.add("hidden"));
  $(id).classList.remove("hidden");
}

function initFases(){
  const sel=$("fase");
  FASES.forEach(f=>{
    const o=document.createElement("option");
    o.value=o.textContent=f; sel.appendChild(o);
  });
  sel.value=DEFAULT_FASE;
  sel.onchange=()=>{
    if(sel.value==="Formularios") showOnly("secFormularios");
    else if(sel.value==="Pesos") showOnly("secPesos");
    else{
      $("phTitle").textContent=sel.value;
      $("phBody").textContent="Fase lista para implementar.";
      showOnly("secPlaceholder");
    }
  };
  $("phTitle").textContent=DEFAULT_FASE;
  $("phBody").textContent="Aqu√≠ ir√° el formulario de autoevaluaci√≥n.";
  showOnly("secPlaceholder");
}

/* ================= FORMULARIOS ================= */
async function loadFormularios(){
  const lv=await apiGet({action:"levels",sheet:"Formularios"});
  $("fNivelSelect").innerHTML=lv.levels.map(n=>`<option>${n}</option>`).join("");
  const nivel=$("fNivelSelect").value;
  const it=await apiGet({action:"items",sheet:"Formularios",nivel});
  const tb=$("tblFormularios").querySelector("tbody");
  tb.innerHTML="";
  it.items.forEach(r=>{
    tb.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${r.Nivel}</td><td>${r.Factor}</td><td>${r.Item}</td>
        <td><small>${r["1"]}</small></td><td><small>${r["2"]}</small></td>
        <td><small>${r["3"]}</small></td><td><small>${r["4"]}</small></td>
        <td><small>${r["5"]}</small></td>
      </tr>`);
  });
  $("fCountChip").textContent=`Items: ${it.items.length}`;
}

/* ================= PESOS ================= */
async function loadPesos(){
  const lv=await apiGet({action:"levels",sheet:"Pesos"});
  $("pNivelSelect").innerHTML=lv.levels.map(n=>`<option>${n}</option>`).join("");
  const nivel=$("pNivelSelect").value;
  const it=await apiGet({action:"items",sheet:"Pesos",nivel});
  const tb=$("tblPesos").querySelector("tbody");
  tb.innerHTML="";
  it.items.forEach(r=>{
    tb.insertAdjacentHTML("beforeend",`
      <tr><td>${r.Nivel}</td><td>${r.Factor}</td><td>${r.Item}</td><td>${r.Peso}</td></tr>`);
  });
  $("pCountChip").textContent=`Items: ${it.items.length}`;
}

/* ================= EVENTS ================= */
$("btnFormCargar").onclick=()=>loadFormularios().catch(e=>setApiStatus("err",e.message));
$("btnFormLimpiar").onclick=()=>{$("tblFormularios").querySelector("tbody").innerHTML="";};
$("btnPesosCargar").onclick=()=>loadPesos().catch(e=>setApiStatus("err",e.message));
$("btnPesosLimpiar").onclick=()=>{$("tblPesos").querySelector("tbody").innerHTML="";};

/* ================= BOOT ================= */
initFases();
apiGet({action:"ping"}).catch(()=>setApiStatus("err","API no conectada"));
</script>

</body>
</html>
