/**
 * =========================
 * CONFIG
 * =========================
 */
const SPREADSHEET_ID = "19zvT9RQWKKyneeS3WFS5Il7DLDxir3E2PrLNOg1w7lQ";
const ALLOWED_SHEETS = new Set(["Formularios", "Pesos", "Respuestas"]);

/**
 * Aliases tolerantes a variaciones de encabezados
 */
const HEADER_ALIASES = {
  nivel: ["nivel", "level", "niv"],
  factor: ["factor", "competencia", "dimension", "dimensión"],
  item: ["item", "ítem", "pregunta", "indicador", "descripcion", "descripción"],
  peso: ["peso", "ponderacion", "ponderación", "peso %", "peso(%)", "porcentaje", "%", "weight"],
  one: ["1", "01"],
  two: ["2", "02"],
  three: ["3", "03"],
  four: ["4", "04"],
  five: ["5", "05"]
};

/**
 * =========================
 * WEB APP ENTRYPOINT (JSONP)
 * =========================
 * - action=ping
 * - action=levels&sheet=Formularios|Pesos
 * - action=items&sheet=Formularios|Pesos&nivel=... (nivel opcional: si falta o ALL => TODOS)
 * - action=form&nivel=1
 * - action=save&payload=BASE64(JSON)
 */
function doGet(e) {
  const params = (e && e.parameter) ? e.parameter : {};
  const action = (params.action || "").trim();
  const callback = (params.callback || "").trim();

  try {
    if (action === "ping") {
      return jsonOut_({ ok: true, action: "ping" }, callback);
    }

    if (action === "levels") {
      const sheetName = sanitizeSheet_(params.sheet);
      const levels = getDistinctLevels_(sheetName);
      return jsonOut_({ ok: true, sheet: sheetName, levels }, callback);
    }

    if (action === "items") {
      const sheetName = sanitizeSheet_(params.sheet);

      let nivel = (params.nivel || "").toString().trim();
      if (!nivel || nivel.toUpperCase() === "ALL") nivel = "";

      const items = getItemsByNivel_(sheetName, nivel);

      // Orden amigable: nivel (num) -> factor -> item
      items.sort((a,b)=>{
        const na = Number(nivelCanon_(a.Nivel));
        const nb = Number(nivelCanon_(b.Nivel));
        const aNum = Number.isFinite(na), bNum = Number.isFinite(nb);
        if (aNum && bNum && na !== nb) return na - nb;
        if (String(a.Nivel) !== String(b.Nivel)) return String(a.Nivel).localeCompare(String(b.Nivel));
        const f = String(a.Factor).localeCompare(String(b.Factor));
        if (f !== 0) return f;
        return String(a.Item).localeCompare(String(b.Item));
      });

      return jsonOut_({ ok: true, sheet: sheetName, nivel: (nivel || "ALL"), items }, callback);
    }

    if (action === "form") {
      let nivel = (params.nivel || "").toString().trim();
      if (!nivel) nivel = "1";
      const form = buildFormByNivel_(nivel);
      return jsonOut_({ ok: true, form }, callback);
    }

    if (action === "save") {
      const b64 = (params.payload || "").toString().trim();
      if (!b64) throw new Error("Falta payload.");

      const json = Utilities.newBlob(Utilities.base64Decode(b64)).getDataAsString("UTF-8");
      const payload = JSON.parse(json);

      const id = saveResponse_(payload);
      return jsonOut_({ ok: true, id }, callback);
    }

    return jsonOut_(
      { ok: false, error: "Acción no soportada. Usa: ping | levels | items | form | save" },
      callback
    );
  } catch (err) {
    return jsonOut_({ ok: false, error: String(err && err.message ? err.message : err) }, callback);
  }
}

/**
 * =========================
 * CORE SHEET READ
 * =========================
 */
function getSheetValues_(sheetName) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(sheetName);
  if (!sh) throw new Error(`No existe la hoja: ${sheetName}`);

  const values = sh.getDataRange().getValues();
  if (!values || values.length < 2) return { headers: [], rows: [], headerIndex: {} };

  const rawHeaders = values[0].map(h => String(h ?? ""));
  const headers = rawHeaders.map(h => normalizeHeader_(h));
  const rows = values.slice(1);

  const headerIndex = buildHeaderIndex_(headers, sheetName);

  if (headerIndex.nivel == null) throw new Error(`Encabezado faltante en "${sheetName}": Nivel`);
  if (headerIndex.factor == null) throw new Error(`Encabezado faltante en "${sheetName}": Factor`);
  if (headerIndex.item == null) throw new Error(`Encabezado faltante en "${sheetName}": Item`);

  if (sheetName === "Formularios") {
    ["one","two","three","four","five"].forEach(k=>{
      if (headerIndex[k] == null) {
        const label = ({one:"1",two:"2",three:"3",four:"4",five:"5"})[k];
        throw new Error(`Encabezado faltante en "${sheetName}": ${label}`);
      }
    });
  } else if (sheetName === "Pesos") {
    if (headerIndex.peso == null) throw new Error(`Encabezado faltante en "${sheetName}": Peso/Ponderación`);
  }

  return { headers, rows, headerIndex };
}

function buildHeaderIndex_(headersNormalized, sheetName){
  const idx = {};
  idx.nivel = findIndexByAliases_(headersNormalized, HEADER_ALIASES.nivel);
  idx.factor = findIndexByAliases_(headersNormalized, HEADER_ALIASES.factor);
  idx.item  = findIndexByAliases_(headersNormalized, HEADER_ALIASES.item);

  if (sheetName === "Formularios"){
    idx.one   = findIndexByAliases_(headersNormalized, HEADER_ALIASES.one);
    idx.two   = findIndexByAliases_(headersNormalized, HEADER_ALIASES.two);
    idx.three = findIndexByAliases_(headersNormalized, HEADER_ALIASES.three);
    idx.four  = findIndexByAliases_(headersNormalized, HEADER_ALIASES.four);
    idx.five  = findIndexByAliases_(headersNormalized, HEADER_ALIASES.five);
  } else if (sheetName === "Pesos") {
    idx.peso  = findIndexByAliases_(headersNormalized, HEADER_ALIASES.peso);
  }
  return idx;
}

function findIndexByAliases_(headersNormalized, aliases){
  for (let a of aliases){
    const an = normalizeHeader_(a);
    const i = headersNormalized.indexOf(an);
    if (i >= 0) return i;
  }
  for (let a of aliases){
    const an = normalizeHeader_(a);
    const i = headersNormalized.findIndex(h => h.includes(an));
    if (i >= 0) return i;
  }
  return null;
}

/**
 * =========================
 * LEVELS + ITEMS
 * =========================
 */
function getDistinctLevels_(sheetName) {
  const { rows, headerIndex } = getSheetValues_(sheetName);
  const idxNivel = headerIndex.nivel;

  const mapCanonToLabel = new Map();
  rows.forEach(r => {
    const raw = (r[idxNivel] ?? "").toString().trim();
    if (!raw) return;
    const canon = nivelCanon_(raw);
    if (!canon) return;
    if (!mapCanonToLabel.has(canon)) mapCanonToLabel.set(canon, raw);
  });

  const arr = Array.from(mapCanonToLabel.values());
  arr.sort((a,b)=>{
    const na = Number(nivelCanon_(a)), nb = Number(nivelCanon_(b));
    const aNum = Number.isFinite(na), bNum = Number.isFinite(nb);
    if (aNum && bNum) return na - nb;
    return String(a).localeCompare(String(b));
  });

  return arr;
}

function getItemsByNivel_(sheetName, nivel) {
  const { rows, headerIndex } = getSheetValues_(sheetName);

  const targetCanon = nivel ? nivelCanon_(nivel) : "";
  const out = [];

  rows.forEach(r => {
    const rawNivel = (r[headerIndex.nivel] ?? "").toString().trim();
    if (!rawNivel) return;

    const rowCanon = nivelCanon_(rawNivel);
    if (targetCanon && rowCanon !== targetCanon) return;

    if (sheetName === "Formularios") {
      out.push({
        Nivel: r[headerIndex.nivel] ?? "",
        Factor: r[headerIndex.factor] ?? "",
        Item: r[headerIndex.item] ?? "",
        "1": r[headerIndex.one] ?? "",
        "2": r[headerIndex.two] ?? "",
        "3": r[headerIndex.three] ?? "",
        "4": r[headerIndex.four] ?? "",
        "5": r[headerIndex.five] ?? ""
      });
    } else if (sheetName === "Pesos") {
      out.push({
        Nivel: r[headerIndex.nivel] ?? "",
        Factor: r[headerIndex.factor] ?? "",
        Item: r[headerIndex.item] ?? "",
        Peso: r[headerIndex.peso] ?? ""
      });
    }
  });

  return out;
}

/**
 * =========================
 * BUILD FORM BY NIVEL (AUTO)
 * =========================
 */
function buildFormByNivel_(nivel){
  const items = getItemsByNivel_("Formularios", nivel);

  const map = new Map(); // factor -> items[]
  items.forEach(r=>{
    const factor = String(r.Factor ?? "").trim() || "Sin factor";
    const item = String(r.Item ?? "").trim() || "Sin ítem";

    const key = `${nivelCanon_(r.Nivel ?? nivel)}|${factor}|${item}`;

    const it = {
      key,
      item,
      rubrica: {
        "1": r["1"] ?? "",
        "2": r["2"] ?? "",
        "3": r["3"] ?? "",
        "4": r["4"] ?? "",
        "5": r["5"] ?? ""
      }
    };

    if(!map.has(factor)) map.set(factor, []);
    map.get(factor).push(it);
  });

  const factors = Array.from(map.entries()).map(([factor, its])=>({
    factor,
    items: its
  }));

  return {
    nivel: String(nivel),
    factors
  };
}

/**
 * =========================
 * SAVE RESPONSES
 * =========================
 */
function saveResponse_(payload){
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sh = ss.getSheetByName("Respuestas");
  if(!sh){
    sh = ss.insertSheet("Respuestas");
    sh.appendRow([
      "ID","Timestamp",
      "Fase",
      "Nivel","NoPersonal","Nombre","Posicion","Departamento","Periodo","Version","Fecha",
      "Comentarios","RespuestasJSON"
    ]);
  }

  const id = Utilities.getUuid();
  const ts = new Date();

  const row = [
    id,
    ts,
    payload.fase || "",
    payload.nivel || "",
    payload.no || "",
    payload.nombre || "",
    payload.posicion || "",
    payload.depto || "",
    payload.periodo || "",
    payload.version || "",
    payload.fecha || "",
    payload.comentarios || "",
    JSON.stringify(payload.r || [])
  ];

  sh.appendRow(row);
  return id;
}

/**
 * =========================
 * VALIDATION + NORMALIZATION
 * =========================
 */
function sanitizeSheet_(sheetName) {
  const name = (sheetName || "").toString().trim();
  if (!ALLOWED_SHEETS.has(name)) {
    throw new Error(`Hoja inválida. Usa: ${Array.from(ALLOWED_SHEETS).join(", ")}`);
  }
  return name;
}

function normalizeHeader_(h) {
  return String(h || "")
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, " ");
}

function nivelCanon_(v) {
  const s = String(v || "").trim();

  const m1 = s.match(/^(\d+)\s*[\.\-)]?/);
  if (m1 && m1[1]) return String(Number(m1[1]));

  const m2 = s.match(/(\d+)/);
  if (m2 && m2[1]) return String(Number(m2[1]));

  return s.toLowerCase();
}

/**
 * =========================
 * OUTPUT JSON / JSONP
 * =========================
 */
function jsonOut_(obj, callback) {
  obj.ts = new Date().toISOString();
  const json = JSON.stringify(obj);

  if (callback) {
    const safeCb = String(callback).replace(/[^\w$.]/g, "");
    return ContentService
      .createTextOutput(`${safeCb}(${json});`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  return ContentService
    .createTextOutput(json)
    .setMimeType(ContentService.MimeType.JSON);
}
