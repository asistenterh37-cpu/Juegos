<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Evaluación del desempeño</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#0b162d;
      --txt:#e8eefc; --muted:#9fb0d0;
      --line:rgba(255,255,255,.08);
      --brand:#3b82f6; --brand2:#60a5fa;
      --ok:#22c55e; --warn:#f59e0b;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(59,130,246,.25), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(34,197,94,.12), transparent 60%),
        var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:980px; margin:22px auto; padding:0 16px;}
    .topbar{
      position:sticky; top:10px; z-index:10;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(59,130,246,.14);
      border:1px solid rgba(59,130,246,.25);
      color:var(--txt); font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .dot.warn{background:var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.15)}
    .title{font-weight:700; font-size:13px; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; align-items:center;}
    button{
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:8px 10px;
      border-radius:999px;
      font-weight:600;
    }
    button.primary{
      border-color: rgba(59,130,246,.35);
      background: linear-gradient(180deg, rgba(59,130,246,.45), rgba(59,130,246,.25));
    }
    button.ghost{background:transparent}
    button:disabled{opacity:.5; cursor:not-allowed}
    .card{
      margin-top:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; gap:12px; align-items:center;
    }
    .card .hd h3{margin:0; font-size:13px}
    .card .bd{padding:12px 14px}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      background: rgba(11,18,32,.55);
      border:1px solid rgba(96,165,250,.35);
      color:var(--txt);
      padding:9px 10px;
      border-radius:10px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .grid{display:grid; gap:10px}
    .g2{grid-template-columns: repeat(2, minmax(0,1fr))}
    .g3{grid-template-columns: repeat(3, minmax(0,1fr))}
    .g4{grid-template-columns: repeat(4, minmax(0,1fr))}
    .row{
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:12px;
      padding:10px 0;
      border-top:1px dashed rgba(255,255,255,.08);
    }
    .row:first-child{border-top:none}
    .row .it{
      font-size:13px;
      color:var(--txt);
      line-height:1.35;
    }
    .row small{display:block; margin-top:5px; color:var(--muted); font-size:11px}
    .factor{
      margin-top:12px;
      padding:10px 12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 12px;
    }
    .factor h4{margin:0 0 6px; font-size:13px}
    .hidden{display:none}
    .toast{
      position:fixed; right:16px; bottom:16px;
      background: rgba(15,27,51,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      max-width:360px;
      display:none;
    }
    .toast.show{display:block}
    .muted{color:var(--muted); font-size:12px}
    .table{
      width:100%; border-collapse: collapse; font-size:12px;
    }
    .table th,.table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:8px 6px; vertical-align:top;
    }
    .table th{color:var(--muted); text-align:left; font-weight:700}
    @media print{
      .topbar, .no-print {display:none !important}
      body{background:white; color:black}
      .card{box-shadow:none; border-color:#ddd}
      input, select, textarea{border-color:#aaa; color:#000; background:#fff}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar no-print">
      <div class="brand">
        <div class="pill"><span class="dot" id="apiDot"></span><span id="apiLabel">API</span></div>
        <div>
          <div class="title">Proceso de evaluación del desempeño</div>
          <div class="sub" id="subLabel">Empresa: No implementado · Versión: Prueba</div>
        </div>
      </div>
      <div class="actions">
        <button class="ghost" id="btnNuevo">Nuevo</button>
        <button class="primary" id="btnGuardar">Guardar</button>
        <button class="ghost" id="btnPrint">Imprimir / Enviar PDF</button>
      </div>
    </div>

    <!-- Selector de fase -->
    <div class="card">
      <div class="hd">
        <h3>Formulario</h3>
        <div class="muted">Selecciona la fase del proceso de evaluación del desempeño</div>
      </div>
      <div class="bd">
        <div class="grid g2">
          <div>
            <label>Fase</label>
            <select id="faseSel"></select>
            <div class="muted" style="margin-top:6px">La guardada siempre se tabula en Google Sheets.</div>
          </div>
          <div>
            <label>URL API (Apps Script Web App)</label>
            <input id="apiUrlView" disabled />
            <div class="muted" style="margin-top:6px">Tip: desplegá el Web App como “Cualquiera” para pruebas.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección: Formularios -->
    <div class="card hidden" id="secFormularios">
      <div class="hd">
        <h3>Formularios</h3>
        <div class="muted">Ítems por nivel (desde configuración)</div>
      </div>
      <div class="bd">
        <div class="grid g2">
          <div>
            <label>Nivel</label>
            <select id="formNivelSel"></select>
          </div>
          <div class="muted" style="align-self:end">Vista informativa (para edición, lo ideal es mover esto luego a un “admin”).</div>
        </div>
        <div style="margin-top:10px; overflow:auto">
          <table class="table" id="formTable"></table>
        </div>
      </div>
    </div>

    <!-- Sección: Pesos -->
    <div class="card hidden" id="secPesos">
      <div class="hd">
        <h3>Pesos</h3>
        <div class="muted">Mismo orden que los ítems de Formularios · incluye Limpiar</div>
      </div>
      <div class="bd">
        <div class="grid g2">
          <div>
            <label>Nivel</label>
            <select id="pesoNivelSel"></select>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end; align-items:end" class="no-print">
            <button id="btnPesosLimpiar" class="ghost">Limpiar</button>
            <button id="btnPesosGuardar" class="primary">Guardar pesos</button>
          </div>
        </div>
        <div style="margin-top:10px; overflow:auto">
          <table class="table" id="pesoTable"></table>
        </div>
        <div class="muted" style="margin-top:8px">Sugerencia: usa pesos 1–5 o porcentajes (lo estandarizamos después).</div>
      </div>
    </div>

    <!-- Sección: Autoevaluación -->
    <div class="card" id="secAuto">
      <div class="hd">
        <h3>Formulario de autoevaluación</h3>
        <div class="muted">Por defecto: nivel 1</div>
      </div>
      <div class="bd">
        <div class="grid g2">
          <div>
            <label>Nivel</label>
            <select id="autoNivelSel"></select>
          </div>
          <div class="muted" style="align-self:end">Escala 1–5 dentro de cada selector.</div>
        </div>

        <div style="height:10px"></div>

        <div class="card" style="box-shadow:none; margin:0; background:rgba(0,0,0,.12)">
          <div class="hd">
            <h3>Datos del colaborador</h3>
            <div class="muted">Completa esta información y selecciona una opción (1–5) por ítem</div>
          </div>
          <div class="bd">
            <div class="grid g4">
              <div><label>No. de personal</label><input id="noPersonal" placeholder="Ej. 1800" /></div>
              <div><label>Nombre</label><input id="nombre" placeholder="Ej. Carlos Paz" /></div>
              <div><label>Posición</label><input id="posicion" placeholder="Ej. Analista" /></div>
              <div><label>Departamento</label><input id="depto" placeholder="Ej. Contabilidad" /></div>
            </div>
            <div class="grid g4" style="margin-top:10px">
              <div><label>Periodo</label><input id="periodo" placeholder="Ej. 2026" /></div>
              <div><label>Versión</label><input id="version" placeholder="Ej. 1" /></div>
              <div><label>Fecha</label><input id="fecha" /></div>
              <div><label>&nbsp;</label><div class="muted">Fecha calculada automáticamente (hoy).</div></div>
            </div>
          </div>
        </div>

        <div id="autoFormHost"></div>

        <div class="card" style="box-shadow:none; margin-top:12px; background:rgba(0,0,0,.12)">
          <div class="hd">
            <h3>Comentarios del colaborador</h3>
            <div class="muted">Incluye observaciones, ejemplos, mejoras o apoyo requerido</div>
          </div>
          <div class="bd">
            <textarea id="comentarios" placeholder="Comentarios del colaborador..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Placeholders resto del proceso -->
    <div class="card hidden" id="secClientes"><div class="hd"><h3>Formulario de evaluación de clientes</h3><div class="muted">Sección lista para implementar</div></div><div class="bd muted">Pendiente.</div></div>
    <div class="card hidden" id="secDesempeno"><div class="hd"><h3>Formulario de evaluación del desempeño</h3><div class="muted">Sección lista para implementar</div></div><div class="bd muted">Pendiente.</div></div>
    <div class="card hidden" id="secResultados"><div class="hd"><h3>Resultados evaluación del desempeño</h3><div class="muted">Sección lista para implementar</div></div><div class="bd muted">Pendiente.</div></div>
    <div class="card hidden" id="secConsolidado"><div class="hd"><h3>Informe consolidado</h3><div class="muted">Sección lista para implementar</div></div><div class="bd muted">Pendiente.</div></div>
    <div class="card hidden" id="secNecesidades"><div class="hd"><h3>Informe de necesidades de capacitación</h3><div class="muted">Sección lista para implementar</div></div><div class="bd muted">Pendiente.</div></div>
    <div class="card hidden" id="secPlan"><div class="hd"><h3>Informe de plan de desarrollo</h3><div class="muted">Sección lista para implementar</div></div><div class="bd muted">Pendiente.</div></div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    // 1) Cambia esto por tu URL del Web App desplegado (Apps Script).
    // Ejemplo: https://script.google.com/macros/s/AKfycbxxxxxxxxxxxxxxxx/exec
    const API_URL = "https://script.google.com/macros/s/AKfycbwDEQmzLUnO5dDIjdhlgLju8Nphgk2xEBpGSFCG76S1PD3EfU25qLQAviRsAViLytKJ/exec";

    const FASES = [
      "Formularios",
      "Pesos",
      "Formulario de autoevaluación",
      "Formulario de evaluación de clientes",
      "Formulario de evaluación del desempeño",
      "Resultados evaluación del desempeño",
      "Informe consolidado",
      "Informe de necesidades de capacitación",
      "Informe de plan de desarrollo"
    ];

    // Estado
    let CFG = null;
    let currentNivelId = 1;
    let respuestas = []; // array en orden de items (score 1..5)
    let descs = [];      // array en orden de items (texto de la escala)

    /***********************
     * Helpers UI
     ***********************/
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 3200);
    }

    function setApiStatus(ok){
      const dot = $("apiDot");
      const lbl = $("apiLabel");
      if(ok){
        dot.classList.remove("warn");
        lbl.textContent = "API conectada";
      }else{
        dot.classList.add("warn");
        lbl.textContent = "API sin conexión";
      }
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function groupBy(arr, keyFn){
      const m = new Map();
      for(const it of arr){
        const k = keyFn(it);
        if(!m.has(k)) m.set(k, []);
        m.get(k).push(it);
      }
      return m;
    }

    function optionText(score, text){
      const clean = (text||"").replace(/\s+/g," ").trim();
      const short = clean.length > 180 ? clean.slice(0,180) + "…" : clean;
      return `${score} — ${short}`;
    }

    /***********************
     * API
     ***********************/
    async function apiGet(action, params={}){
      const url = new URL(API_URL);
      url.searchParams.set("action", action);
      for(const [k,v] of Object.entries(params)) url.searchParams.set(k, v);
      const r = await fetch(url.toString(), { method:"GET" });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    }

    async function apiPost(action, payload){
      const url = new URL(API_URL);
      url.searchParams.set("action", action);
      const r = await fetch(url.toString(), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    }

    /***********************
     * Render: Fases
     ***********************/
    function setFase(fase){
      const map = {
        "Formularios": "secFormularios",
        "Pesos": "secPesos",
        "Formulario de autoevaluación": "secAuto",
        "Formulario de evaluación de clientes": "secClientes",
        "Formulario de evaluación del desempeño": "secDesempeno",
        "Resultados evaluación del desempeño": "secResultados",
        "Informe consolidado": "secConsolidado",
        "Informe de necesidades de capacitación": "secNecesidades",
        "Informe de plan de desarrollo": "secPlan"
      };
      for(const id of Object.values(map)) $(id).classList.add("hidden");
      $(map[fase]).classList.remove("hidden");
    }

    /***********************
     * Render: Formularios
     ***********************/
    function renderFormularios(nivelId){
      const items = CFG.items.filter(x=>x.nivelId===nivelId);
      const table = $("formTable");
      table.innerHTML = `
        <thead><tr>
          <th style="min-width:240px">Factor</th>
          <th>Ítem</th>
          <th style="min-width:120px">No</th>
        </tr></thead>
        <tbody>
          ${items.map(it=>`
            <tr>
              <td>${escapeHtml(it.factor)}</td>
              <td>${escapeHtml(it.item)}</td>
              <td>${it.itemNo ?? ""}</td>
            </tr>
          `).join("")}
        </tbody>
      `;
    }

    /***********************
     * Render: Pesos
     ***********************/
    async function renderPesos(nivelId){
      const data = await apiGet("getPesos", { nivelId: String(nivelId) });
      const rows = data.rows || [];
      const table = $("pesoTable");
      table.innerHTML = `
        <thead><tr>
          <th style="min-width:240px">Factor</th>
          <th>Ítem</th>
          <th style="min-width:110px">Peso</th>
        </tr></thead>
        <tbody>
          ${rows.map((r, idx)=>`
            <tr>
              <td>${escapeHtml(r.factor)}</td>
              <td>${escapeHtml(r.item)}</td>
              <td><input data-idx="${idx}" class="pesoInp" value="${r.peso ?? ""}" placeholder="Ej. 1" /></td>
            </tr>
          `).join("")}
        </tbody>
      `;
      // guardar en memoria para editar
      table.dataset.rows = JSON.stringify(rows);
    }

    async function savePesosFromUI(){
      const table = $("pesoTable");
      const rows = JSON.parse(table.dataset.rows || "[]");
      const inputs = table.querySelectorAll(".pesoInp");
      inputs.forEach(inp=>{
        const idx = Number(inp.dataset.idx);
        rows[idx].peso = inp.value;
      });
      await apiPost("savePesos", { nivelId: currentNivelId, rows });
      toast("Pesos guardados.");
    }

    async function limpiarPesosUI(){
      const table = $("pesoTable");
      const rows = JSON.parse(table.dataset.rows || "[]");
      rows.forEach(r=>r.peso="");
      table.dataset.rows = JSON.stringify(rows);
      await renderPesos(currentNivelId);
      toast("Pesos limpiados (aún no guardados).");
    }

    /***********************
     * Render: Autoevaluación
     ***********************/
    function renderAutoForm(nivelId){
      const items = CFG.items.filter(x=>x.nivelId===nivelId);
      respuestas = new Array(items.length).fill("");
      descs = new Array(items.length).fill("");

      const byFactor = groupBy(items, it=>it.factor);
      const host = $("autoFormHost");
      host.innerHTML = "";

      let globalIdx = 0;
      for(const [factor, list] of byFactor.entries()){
        const box = document.createElement("div");
        box.className = "factor";
        box.innerHTML = `<h4>${escapeHtml(factor)}</h4><div class="muted">Selecciona una opción por ítem</div>`;

        for(const it of list){
          const row = document.createElement("div");
          row.className = "row";

          const left = document.createElement("div");
          left.className = "it";
          left.innerHTML = `<strong>${escapeHtml(it.item)}</strong><small>Escala 1–5</small>`;

          const right = document.createElement("div");
          right.innerHTML = `
            <label>Puntaje (1–5)</label>
            <select data-idx="${globalIdx}">
              <option value="">Seleccionar…</option>
              ${[1,2,3,4,5].map(s=>{
                return `<option value="${s}" data-desc="${escapeAttr(it.scale[String(s)]||"")}">${escapeHtml(optionText(s, it.scale[String(s)]||""))}</option>`;
              }).join("")}
            </select>
          `;

          row.appendChild(left);
          row.appendChild(right);
          box.appendChild(row);
          globalIdx++;
        }
        host.appendChild(box);
      }

      // events
      host.querySelectorAll("select").forEach(sel=>{
        sel.addEventListener("change", (e)=>{
          const idx = Number(e.target.dataset.idx);
          const val = e.target.value;
          respuestas[idx] = val;
          const opt = e.target.selectedOptions[0];
          descs[idx] = opt ? (opt.getAttribute("data-desc") || "") : "";
        });
      });
    }

    function validateAuto(itemsLen){
      // Validación mínima: datos básicos + que no falte ningún ítem
      const req = ["noPersonal","nombre","posicion","depto","periodo","version","fecha"];
      for(const id of req){
        if(!$(id).value.trim()){
          toast("Falta completar: " + id);
          return false;
        }
      }
      for(let i=0;i<itemsLen;i++){
        if(!respuestas[i]){
          toast("Te falta responder el ítem #" + (i+1));
          return false;
        }
      }
      return true;
    }

    async function guardarAuto(){
      const items = CFG.items.filter(x=>x.nivelId===currentNivelId);
      if(!validateAuto(items.length)) return;

      const payload = {
        nivelId: currentNivelId,
        nivelLabel: (CFG.levels.find(l=>l.id===currentNivelId)?.label || ""),
        colaborador: {
          noPersonal: $("noPersonal").value.trim(),
          nombre: $("nombre").value.trim(),
          posicion: $("posicion").value.trim(),
          departamento: $("depto").value.trim(),
          periodo: $("periodo").value.trim(),
          version: $("version").value.trim(),
          fecha: $("fecha").value.trim()
        },
        respuestas,
        descripciones: descs,
        comentarios: $("comentarios").value.trim()
      };

      $("btnGuardar").disabled = true;
      try{
        await apiPost("saveAutoevaluacion", payload);
        toast("Guardado en Google Sheets ✅");
      }catch(err){
        console.error(err);
        toast("No se pudo guardar (revisa API_URL / despliegue).");
      }finally{
        $("btnGuardar").disabled = false;
      }
    }

    function nuevo(){
      // reset campos
      ["noPersonal","nombre","posicion","depto","periodo","version","comentarios"].forEach(id=>$(id).value="");
      $("fecha").value = todayISO();
      // reset selects en form
      const host = $("autoFormHost");
      host.querySelectorAll("select").forEach(s=>s.value="");
      // reset arrays
      const items = CFG.items.filter(x=>x.nivelId===currentNivelId);
      respuestas = new Array(items.length).fill("");
      descs = new Array(items.length).fill("");
      toast("Formulario limpio.");
    }

    function imprimir(){
      window.print();
    }

    /***********************
     * Safe HTML
     ***********************/
    function escapeHtml(s){
      return String(s??"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," ").replaceAll("\r"," "); }

    /***********************
     * Init
     ***********************/
    async function init(){
      $("apiUrlView").value = API_URL;
      $("fecha").value = todayISO();

      // fases
      const faseSel = $("faseSel");
      faseSel.innerHTML = FASES.map(f=>`<option value="${escapeAttr(f)}">${escapeHtml(f)}</option>`).join("");
      faseSel.value = "Formulario de autoevaluación"; // default
      setFase(faseSel.value);
      faseSel.addEventListener("change", async ()=>{
        setFase(faseSel.value);
        if(faseSel.value==="Formularios") renderFormularios(currentNivelId);
        if(faseSel.value==="Pesos") await renderPesos(currentNivelId);
      });

      // botones
      $("btnNuevo").addEventListener("click", nuevo);
      $("btnGuardar").addEventListener("click", guardarAuto);
      $("btnPrint").addEventListener("click", imprimir);
      $("btnPesosGuardar").addEventListener("click", savePesosFromUI);
      $("btnPesosLimpiar").addEventListener("click", limpiarPesosUI);

      // config
      try{
        CFG = await apiGet("getConfig");
        setApiStatus(true);
      }catch(e){
        console.error(e);
        setApiStatus(false);
        toast("No se pudo cargar configuración desde API. Revisa API_URL y despliegue.");
        return;
      }

      // niveles
      const levels = CFG.levels || [];
      const fillLevelSel = (selId)=>{
        const sel = $(selId);
        sel.innerHTML = levels.map(l=>`<option value="${l.id}">${escapeHtml(l.label)}</option>`).join("");
        sel.value = "1";
        sel.addEventListener("change", async ()=>{
          currentNivelId = Number(sel.value);
          // sincronizar selects
          ["autoNivelSel","formNivelSel","pesoNivelSel"].forEach(x=>{
            if($(x) && $(x)!==sel) $(x).value = String(currentNivelId);
          });

          renderAutoForm(currentNivelId);
          if(!$("secFormularios").classList.contains("hidden")) renderFormularios(currentNivelId);
          if(!$("secPesos").classList.contains("hidden")) await renderPesos(currentNivelId);
        });
      };

      fillLevelSel("autoNivelSel");
      fillLevelSel("formNivelSel");
      fillLevelSel("pesoNivelSel");

      currentNivelId = 1;
      renderAutoForm(1);
      renderFormularios(1);
    }

    init();
  </script>
</body>
</html>
