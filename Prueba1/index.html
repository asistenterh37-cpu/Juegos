<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Evaluaci√≥n del desempe√±o</title>
  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(15,23,42,.72);
      --panel2: rgba(2,6,23,.55);
      --stroke: rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#3b82f6;
      --brand2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 16px;
      --radius2: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 50% 20%, rgba(59,130,246,.18), transparent 60%),
        radial-gradient(900px 500px at 70% 55%, rgba(168,85,247,.12), transparent 60%),
        radial-gradient(900px 500px at 30% 55%, rgba(34,197,94,.08), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 18px 14px 60px;}
    .topbar{
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: blur(10px);
      padding: 10px 0;
    }
    .topbarInner{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background: rgba(2,6,23,.65);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    .brand{display:flex; gap:10px; align-items:center; padding-left:6px;}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--brand2);
      box-shadow: 0 0 0 6px rgba(34,197,94,.12);
    }
    .title{font-weight:700; letter-spacing:.2px; font-size: 13px; line-height:1;}
    .subtitle{font-size: 11px; color: var(--muted); margin-top:2px;}
    .nav{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;}
    .chip{
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.55);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition:.15s;
      white-space:nowrap;
    }
    .chip:hover{transform: translateY(-1px); border-color: rgba(59,130,246,.35)}
    .chip.active{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.45);}

    .card{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.55));
    }
    .cardHead h2{margin:0;font-size:14px}
    .cardHead p{margin:6px 0 0; color:var(--muted); font-size:12px}
    .cardBody{padding: 14px}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .grid4{display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px}
    @media (max-width: 780px){
      .grid2,.grid3,.grid4{grid-template-columns:1fr}
      .nav{justify-content:flex-start}
    }

    label{display:block; font-size:11px; color: var(--muted); margin: 0 0 6px}
    input, select, textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(2,6,23,.55);
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }
    textarea{min-height: 92px; resize: vertical}

    .actions{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:flex-end;
      margin-top: 12px;
    }
    .btn{
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,.75);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      cursor:pointer;
      transition:.15s;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(59,130,246,.35)}
    .btn.primary{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.45)}
    .btn.good{background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.35)}
    .btn.warn{background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.35)}
    .btn.danger{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35)}
    .hint{font-size:12px; color: var(--muted); margin-top: 10px}
    .status{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      font-size:12px;
      color: var(--muted);
    }
    .status strong{color: var(--text)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .factor{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed rgba(148,163,184,.22);
    }
    .factor h3{margin:0 0 8px; font-size:13px}
    .q{
      padding: 10px 10px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.42);
      border-radius: 12px;
      margin-bottom: 10px;
      display:grid;
      grid-template-columns: 1fr 220px;
      gap: 10px;
      align-items:center;
    }
    @media (max-width:780px){ .q{grid-template-columns:1fr} }
    .qTitle{font-size:12px; font-weight:600}
    .qMeta{font-size:11px; color: var(--muted); margin-top:4px}
    .badge{
      display:inline-flex; gap:6px; align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.6);
      font-size: 11px;
      color: var(--muted);
    }

    @media print{
      .topbar, .actions, .chip{display:none !important}
      body{background:#fff; color:#000}
      .card{box-shadow:none}
      input, select, textarea{border:1px solid #ccc; background:#fff; color:#000}
      .status{display:none}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbarInner">
        <div class="brand">
          <span class="dot" id="apiDot"></span>
          <div>
            <div class="title">Proceso de evaluaci√≥n del desempe√±o</div>
            <div class="subtitle" id="apiSubtitle">Conectando con Apps Script‚Ä¶</div>
          </div>
        </div>
        <div class="nav" id="menu"></div>
      </div>
    </div>

    <div class="card" id="viewCard">
      <div class="cardHead">
        <h2 id="viewTitle">Cargando‚Ä¶</h2>
        <p id="viewDesc">Inicializando interfaz.</p>
      </div>
      <div class="cardBody" id="viewBody"></div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const MAX_RESP = 20;

// URL por defecto (tu deploy)
const DEFAULT_WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbwIzScQY1SRk28ks5V0I97rp2LYDfm0DS7KJYJ2mF_RgVn_DlL12C9KtPmIA00e21Cm/exec";

/** Normaliza URL: acepta /exec o /dev (pero recomienda /exec) */
function normalizeWebAppUrl(raw){
  const s = String(raw || "").trim();
  if (!s) return "";

  // aceptamos tanto script.google.com como script.googleusercontent.com (a veces la gente pega esa)
  if (!/^https:\/\/script\.google\.(com|usercontent\.com)\/macros\/s\//.test(s)) return "";

  let u;
  try { u = new URL(s); } catch { return ""; }

  // limpia query/hash
  u.search = "";
  u.hash = "";

  // fuerza a terminar en /exec o /dev (preferimos exec)
  const isDev = u.pathname.endsWith("/dev");
  const isExec = u.pathname.endsWith("/exec");

  if (!isDev && !isExec){
    // por defecto: /exec
    u.pathname = u.pathname.replace(/\/+$/,"") + "/exec";
  }
  return u.toString();
}

function isDevUrl(url){
  try { return new URL(url).pathname.endsWith("/dev"); } catch { return false; }
}

// override por querystring: ?webapp=https://script.google.com/macros/s/.../exec
function getWebAppUrl(){
  const u = new URL(location.href);
  const qs = u.searchParams.get("webapp");
  const qsNorm = normalizeWebAppUrl(qs);
  if (qsNorm) return qsNorm;

  const saved = localStorage.getItem("WEBAPP_URL");
  const savedNorm = normalizeWebAppUrl(saved);
  if (savedNorm) return savedNorm;

  return normalizeWebAppUrl(DEFAULT_WEBAPP_URL);
}

let SCRIPT_WEBAPP_URL = getWebAppUrl();

/** =========================
 * JSONP helper (GitHub Pages friendly)
 * ========================= */
function jsonp(url, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const qs = new URLSearchParams({ ...params, callback: cb, _ts: Date.now() });

    script.src = url + (url.includes("?") ? "&" : "?") + qs.toString();
    script.async = true;
    script.referrerPolicy = "no-referrer";

    const timer = setTimeout(() => {
      cleanup();
      reject(new Error("Timeout JSONP. Revisa si el WebApp est√° publicado como 'Anyone' y que sea /exec."));
    }, 25000);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cb]; } catch {}
      try { script.remove(); } catch {}
    }

    window[cb] = (data) => { cleanup(); resolve(data); };
    script.onerror = () => {
      cleanup();
      reject(new Error(
        "Error cargando JSONP. Casi seguro: 403 (WebApp privada / permisos) o URL inv√°lida."
      ));
    };

    document.body.appendChild(script);
  });
}

/** =========================
 * UI helpers
 * ========================= */
const state = { view: "forms", levels: [], form: null };

const menuItems = [
  { id:"forms", label:"Formularios y pesos" },
  { id:"autoevaluacion", label:"Formulario de autoevaluaci√≥n" },
  { id:"clientes", label:"Formulario evaluaci√≥n de clientes" },
  { id:"desempeno", label:"Formulario evaluaci√≥n del desempe√±o" },
  { id:"resultados", label:"Resultados evaluaci√≥n del desempe√±o" },
  { id:"consolidado", label:"Informe consolidado" },
  { id:"capacitacion", label:"Informe necesidades de capacitaci√≥n" },
  { id:"desarrollo", label:"Informe plan de desarrollo" },
];

function setStatus(ok, msg){
  const dot = document.getElementById("apiDot");
  const sub = document.getElementById("apiSubtitle");
  dot.style.background = ok ? "var(--brand2)" : "var(--danger)";
  dot.style.boxShadow = ok ? "0 0 0 6px rgba(34,197,94,.12)" : "0 0 0 6px rgba(239,68,68,.12)";
  sub.textContent = msg;
}

function renderMenu(){
  const el = document.getElementById("menu");
  el.innerHTML = "";
  menuItems.forEach(item => {
    const b = document.createElement("button");
    b.className = "chip" + (state.view === item.id ? " active" : "");
    b.textContent = item.label;
    b.onclick = () => { state.view = item.id; renderView(); renderMenu(); };
    el.appendChild(b);
  });
}

function setView(title, desc){
  document.getElementById("viewTitle").textContent = title;
  document.getElementById("viewDesc").textContent = desc;
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** =========================
 * API
 * ========================= */
async function api(action, params={}){
  SCRIPT_WEBAPP_URL = getWebAppUrl();
  if (!SCRIPT_WEBAPP_URL) throw new Error("No hay WebApp URL v√°lida. Usa ‚ÄúConfigurar WebApp‚Äù.");

  // Aviso si te pegaron /dev
  if (isDevUrl(SCRIPT_WEBAPP_URL) && action !== "ping"){
    // no bloquea, solo avisa; /dev a veces funciona solo para ti, pero para GitHub Pages suele ser dolor
    setStatus(false, "URL parece /dev. Publica /exec para acceso correcto (deploy).");
  }

  const res = await jsonp(SCRIPT_WEBAPP_URL, { action, ...params });

  // validaci√≥n fuerte: ok debe venir true
  if (!res || res.ok !== true) {
    const msg = (res && res.error) ? res.error : "Respuesta inv√°lida del servidor";
    throw new Error(msg);
  }
  return res;
}

async function init(){
  renderMenu();
  await checkConnection();
  renderView();
}

async function checkConnection(){
  const url = getWebAppUrl();
  if (!url){
    setStatus(false, "Sin WebApp URL. Usa ‚ÄúConfigurar WebApp‚Äù.");
    return;
  }
  try{
    const r = await api("ping");
    const note = isDevUrl(url) ? " (pero es /dev‚Ä¶ ojo üòÖ)" : "";
    setStatus(true, `Apps Script conectado${note} ‚Äî ${r.ts || ""}`.trim());
  }catch(e){
    // Mensaje m√°s √∫til para el 403
    setStatus(false, "Sin conexi√≥n (si ves 403: el WebApp est√° privado o no est√° publicado como 'Anyone').");
  }
}

/** =========================
 * Views
 * ========================= */
function renderView(){
  const body = document.getElementById("viewBody");
  body.innerHTML = "";

  if (state.view === "forms") return renderFormsAndWeights(body);
  if (state.view === "autoevaluacion") return renderAutoevaluacion(body);

  setView(menuItems.find(m=>m.id===state.view)?.label || "M√≥dulo", "M√≥dulo en preparaci√≥n.");
  const box = document.createElement("div");
  box.className = "status";
  box.innerHTML = `<strong>Listo para expandir:</strong> el men√∫ ya est√° cableado.`;
  body.appendChild(box);
}

async function renderFormsAndWeights(body){
  setView("Formularios y pesos", "Cargar (importa desde la pesta√±a Formularios) o Limpiar (borra banco de cuestionarios).");

  const grid = document.createElement("div");
  grid.className = "grid2";

  const left = document.createElement("div");
  left.innerHTML = `
    <div class="status">
      <div><strong>Acciones</strong></div>
      <div class="hint">‚ÄúCargar‚Äù arma el banco por Nivel. ‚ÄúLimpiar‚Äù borra el banco para recargar.</div>

      <div class="actions" style="justify-content:flex-start">
        <button class="btn good" id="btnLoad">Cargar</button>
        <button class="btn danger" id="btnClear">Limpiar</button>
        <button class="btn primary" id="btnCfg">Configurar WebApp</button>
        <button class="btn" id="btnTest">Probar conexi√≥n</button>
        <button class="btn" id="btnOpenPing">Abrir ping</button>
      </div>

      <div class="hint">
        URL actual: <span class="mono" id="urlNow"></span>
        <div id="urlHint" class="hint"></div>
        <br>Tip: tu hoja debe llamarse exactamente <b>Formularios</b> y tener headers: Nivel, Factor, Item, Pesos, 1..5
      </div>
    </div>
  `;

  const right = document.createElement("div");
  right.innerHTML = `<div class="status" id="bankInfo"><strong>Banco:</strong> consultando‚Ä¶</div>`;

  grid.appendChild(left);
  grid.appendChild(right);
  body.appendChild(grid);

  const urlNow = getWebAppUrl() || "‚Äî";
  document.getElementById("urlNow").textContent = urlNow;

  const urlHint = document.getElementById("urlHint");
  if (urlNow !== "‚Äî" && isDevUrl(urlNow)){
    urlHint.innerHTML = `‚ö†Ô∏è Est√°s usando <b>/dev</b>. Para GitHub Pages lo correcto es <b>/exec</b> (deploy p√∫blico).`;
  } else {
    urlHint.innerHTML = "";
  }

  async function refreshInfo(){
    try{
      const info = await api("bankInfo");
      document.getElementById("bankInfo").innerHTML =
        `<strong>Banco:</strong> ${info.count} √≠tems en ${info.levels} niveles.<br><span class="hint">√öltima carga: ${escapeHtml(info.lastLoad || "‚Äî")}</span>`;
    }catch(e){
      document.getElementById("bankInfo").innerHTML =
        `<strong>Banco:</strong> no disponible.<br><span class="hint">‚ùå ${escapeHtml(e.message)}</span>`;
    }
  }

  document.getElementById("btnCfg").onclick = async () => {
    const cur = getWebAppUrl() || DEFAULT_WEBAPP_URL;
    const next = prompt("Pega aqu√≠ la URL /exec del WebApp (Apps Script):", cur);
    if (!next) return;

    const norm = normalizeWebAppUrl(next);
    if (!norm){
      alert("Esa URL no parece un WebApp v√°lido. Debe empezar con https://script.google.com/macros/s/ y terminar en /exec (o /dev).");
      return;
    }
    localStorage.setItem("WEBAPP_URL", norm);
    document.getElementById("urlNow").textContent = getWebAppUrl();
    await checkConnection();
    await refreshInfo();
  };

  document.getElementById("btnTest").onclick = async () => {
    await checkConnection();
    await refreshInfo();
  };

  document.getElementById("btnOpenPing").onclick = () => {
    const base = getWebAppUrl();
    if (!base) return alert("Configura la URL primero.");
    const u = base + (base.includes("?") ? "&" : "?") + "action=ping";
    window.open(u, "_blank", "noopener,noreferrer");
  };

  document.getElementById("btnLoad").onclick = async () => {
    const s = document.createElement("div");
    s.className="status";
    s.textContent = "Cargando cuestionarios‚Ä¶";
    body.appendChild(s);
    try{
      const r = await api("loadBank");
      s.innerHTML = `‚úÖ <strong>Carga completada:</strong> ${r.count} √≠tems en ${r.levels} niveles.`;
      await refreshInfo();
    }catch(e){
      s.innerHTML = `‚ùå <strong>Error:</strong> ${escapeHtml(e.message)}`;
    }
  };

  document.getElementById("btnClear").onclick = async () => {
    const s = document.createElement("div");
    s.className="status";
    s.textContent = "Limpiando banco‚Ä¶";
    body.appendChild(s);
    try{
      await api("clearBank");
      s.innerHTML = `‚úÖ <strong>Banco limpiado.</strong>`;
      await refreshInfo();
    }catch(e){
      s.innerHTML = `‚ùå <strong>Error:</strong> ${escapeHtml(e.message)}`;
    }
  };

  await refreshInfo();
}

async function renderAutoevaluacion(body){
  setView("Formulario de autoevaluaci√≥n", "Selecciona Nivel, responde y guarda en la hoja Autoevaluacion.");

  const head = document.createElement("div");
  head.className = "grid2";

  const left = document.createElement("div");
  left.innerHTML = `
    <label>Formulario (Nivel)</label>
    <select id="levelSelect"><option value="1">Nivel 1</option></select>
    <div class="hint">Si no ves niveles, primero ve a ‚ÄúFormularios y pesos‚Äù ‚Üí <b>Cargar</b>.</div>
  `;

  const right = document.createElement("div");
  const today = new Date();
  const fechaHoy = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
  right.innerHTML = `
    <div class="status">
      <strong>Acciones</strong>
      <div class="actions" style="justify-content:flex-start">
        <button class="btn warn" id="btnNew">Nuevo</button>
        <button class="btn good" id="btnSave">Guardar</button>
        <button class="btn primary" id="btnPrint">Imprimir / PDF</button>
      </div>
      <div class="hint">‚ÄúImprimir/PDF‚Äù usa el di√°logo del navegador.</div>
    </div>
  `;

  head.appendChild(left);
  head.appendChild(right);
  body.appendChild(head);

  const datos = document.createElement("div");
  datos.className = "card";
  datos.style.marginTop = "12px";
  datos.innerHTML = `
    <div class="cardHead">
      <h2>Datos del colaborador</h2>
      <p>Completa la informaci√≥n base.</p>
    </div>
    <div class="cardBody">
      <div class="grid4">
        <div><label>No. de personal</label><input id="noPersonal" placeholder="Ej. 1000"></div>
        <div><label>Nombre</label><input id="nombre" placeholder="Ej. Carlos Paz"></div>
        <div><label>Posici√≥n</label><input id="posicion" placeholder="Ej. Asistente"></div>
        <div><label>Departamento</label><input id="depto" placeholder="Ej. Contabilidad"></div>
      </div>
      <div class="grid3" style="margin-top:10px">
        <div><label>Periodo</label><input id="periodo" placeholder="Ej. 2026"></div>
        <div><label>Versi√≥n</label><input id="version" placeholder="Ej. 1.1"></div>
        <div><label>Fecha</label><input id="fecha" value="${fechaHoy}" readonly></div>
      </div>
    </div>
  `;
  body.appendChild(datos);

  const qWrap = document.createElement("div");
  qWrap.className = "card";
  qWrap.style.marginTop = "12px";
  qWrap.innerHTML = `
    <div class="cardHead">
      <h2>Autoevaluaci√≥n</h2>
      <p>Selecciona un valor por √≠tem.</p>
    </div>
    <div class="cardBody" id="questions"></div>
  `;
  body.appendChild(qWrap);

  const comm = document.createElement("div");
  comm.className = "card";
  comm.style.marginTop = "12px";
  comm.innerHTML = `
    <div class="cardHead">
      <h2>Comentarios del colaborador</h2>
      <p>Opcional.</p>
    </div>
    <div class="cardBody">
      <label>Comentarios</label>
      <textarea id="comentarios" placeholder="Escribe aqu√≠‚Ä¶"></textarea>
    </div>
  `;
  body.appendChild(comm);

  const status = document.createElement("div");
  status.className = "status";
  status.id = "saveStatus";
  status.textContent = "Listo.";
  body.appendChild(status);

  let levels = ["1"];
  try{
    const r = await api("getLevels");
    levels = (r.levels && r.levels.length) ? r.levels : ["1"];
    state.levels = levels;
  }catch(_){}

  const levelSelect = document.getElementById("levelSelect");
  levelSelect.innerHTML = levels.map(l => `<option value="${escapeHtml(l)}">Nivel ${escapeHtml(l)}</option>`).join("");
  levelSelect.value = levels.includes("1") ? "1" : levels[0];

  async function loadForm(level){
    document.getElementById("questions").innerHTML = `<div class="status">Cargando formulario Nivel ${escapeHtml(level)}‚Ä¶</div>`;
    try{
      const r = await api("getForm", { level });
      state.form = r.form;
      renderQuestions(state.form);
      document.getElementById("saveStatus").textContent = `Formulario Nivel ${level} cargado.`;
    }catch(e){
      document.getElementById("questions").innerHTML =
        `<div class="status">‚ùå No se pudo cargar el formulario: <strong>${escapeHtml(e.message)}</strong>
          <div class="hint">Si ves 403, el WebApp est√° privado. Si ves ‚ÄúBanco no cargado‚Äù, ve a ‚ÄúFormularios y pesos‚Äù ‚Üí Cargar.</div>
        </div>`;
    }
  }

  function renderQuestions(form){
    const host = document.getElementById("questions");
    host.innerHTML = "";
    if (!form || !Array.isArray(form.questions) || !form.questions.length){
      host.innerHTML = `<div class="status">No hay preguntas para este nivel.</div>`;
      return;
    }

    const byFactor = new Map();
    form.questions.forEach(q => {
      const f = String(q.factor || "Sin factor");
      if (!byFactor.has(f)) byFactor.set(f, []);
      byFactor.get(f).push(q);
    });

    let respIndex = 0;

    for (const [factor, qs] of byFactor.entries()){
      const f = document.createElement("div");
      f.className = "factor";
      f.innerHTML = `<h3>${escapeHtml(factor)}</h3>`;
      qs.forEach(q => {
        respIndex++;
        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `
          <div>
            <div class="qTitle">${escapeHtml(q.item)}</div>
            <div class="qMeta">
              <span class="badge">Peso: ${escapeHtml(q.peso)}</span>
              <span class="badge">Resp${respIndex}</span>
            </div>
          </div>
          <div>
            <label>Puntuaci√≥n (1‚Äì5)</label>
            <select data-resp="r${respIndex}">
              <option value="">Seleccionar‚Ä¶</option>
              ${(q.scale || []).map(s => `<option value="${escapeHtml(s.value)}">${escapeHtml(s.value)} ‚Äî ${escapeHtml(s.label)}</option>`).join("")}
            </select>
          </div>
        `;
        f.appendChild(div);
      });
      host.appendChild(f);
    }

    if (form.questions.length > MAX_RESP){
      const warn = document.createElement("div");
      warn.className="status";
      warn.innerHTML = `‚ö†Ô∏è <strong>Advertencia:</strong> Este nivel tiene ${form.questions.length} √≠tems, pero MAX_RESP = ${MAX_RESP}. Ajusta MAX_RESP (HTML y Apps Script) o reduce √≠tems.`;
      host.appendChild(warn);
    }
  }

  function clearForm(){
    ["noPersonal","nombre","posicion","depto","periodo","version","comentarios"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    document.querySelectorAll("#questions select[data-resp]").forEach(s => s.value = "");
    document.getElementById("saveStatus").textContent = "Formulario limpio (Nuevo).";
  }

  function collectParams(){
    const params = {
      level: levelSelect.value,
      noPersonal: document.getElementById("noPersonal").value.trim(),
      nombre: document.getElementById("nombre").value.trim(),
      posicion: document.getElementById("posicion").value.trim(),
      departamento: document.getElementById("depto").value.trim(),
      periodo: document.getElementById("periodo").value.trim(),
      version: document.getElementById("version").value.trim(),
      fecha: document.getElementById("fecha").value.trim(),
      comentarios: document.getElementById("comentarios").value.trim(),
    };

    const selects = document.querySelectorAll("#questions select[data-resp]");
    selects.forEach(sel => { params[sel.dataset.resp] = sel.value || ""; });

    for (let i=1;i<=MAX_RESP;i++){
      if (!(("r"+i) in params)) params["r"+i] = "";
    }
    return params;
  }

  levelSelect.onchange = () => loadForm(levelSelect.value);
  document.getElementById("btnNew").onclick = clearForm;
  document.getElementById("btnPrint").onclick = () => window.print();

  document.getElementById("btnSave").onclick = async () => {
    const p = collectParams();
    if (!p.noPersonal || !p.nombre){
      document.getElementById("saveStatus").innerHTML = `‚ö†Ô∏è <strong>Completa al menos:</strong> No. de personal y Nombre.`;
      return;
    }
    document.getElementById("saveStatus").textContent = "Guardando‚Ä¶";
    try{
      const r = await api("saveAutoeval", p);
      document.getElementById("saveStatus").innerHTML = `‚úÖ <strong>Guardado:</strong> fila #${r.row} en Autoevaluacion.`;
    }catch(e){
      document.getElementById("saveStatus").innerHTML = `‚ùå <strong>Error al guardar:</strong> ${escapeHtml(e.message)}`;
    }
  };

  await loadForm(levelSelect.value);
}

init();
</script>
</body>
</html>
