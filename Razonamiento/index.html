<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Secuencia Perdida ¬∑ Por Soamy Lanza</title>

<style>
:root{
  --bg:#0b1220; --card:#121a2b; --soft:#1a2440;
  --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --text:#e5e7eb; --muted:#9ca3af;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:radial-gradient(1200px 600px at 20% -10%, #123 0%, var(--bg) 40%);
  color:var(--text);
}
.container{max-width:1200px;margin:auto;padding:20px}
.card{
  background:linear-gradient(180deg,var(--card),#0e1526);
  border-radius:16px; padding:18px;
  box-shadow:0 20px 50px rgba(0,0,0,.35);
}
.header{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
.title{font-size:1.6rem;font-weight:700}
.subtitle{color:var(--muted)}
.badges{display:flex;gap:10px;flex-wrap:wrap}
.badge{background:#0f172a;border:1px solid #1f2937;border-radius:999px;padding:6px 12px;font-size:.85rem}

.main{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:16px}
@media(max-width:900px){.main{grid-template-columns:1fr}}

.panel{background:linear-gradient(180deg,var(--soft),#0f172a);border-radius:14px;padding:14px}
.controls select, .controls button{width:100%;margin-bottom:10px}

button, select, input{
  background:#0f172a;color:var(--text);border:1px solid #1f2937;
  border-radius:10px;padding:10px;font-size:1rem;
}
button.primary{background:#14532d;border-color:#22c55e}
button.warn{background:#3b2f12;border-color:#f59e0b}
button:active{transform:scale(.98)}

.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.stat{background:#0f172a;border-radius:10px;padding:10px;font-size:.9rem}

.sequence-card{background:linear-gradient(180deg,#0f172a,#020617);border-radius:16px;padding:18px;height:100%}
.seq{display:flex;justify-content:center;gap:12px;margin:18px 0;flex-wrap:wrap}
.num{
  min-width:64px;padding:14px 10px;border-radius:12px;
  background:#020617;border:1px solid #1f2937;font-size:1.2rem;text-align:center;
  display:flex;align-items:center;justify-content:center;
}
.missing{border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.12)}
.missing input{
  width:100%;background:transparent;border:none;outline:none;color:var(--accent);
  font-size:1.25rem;text-align:center;padding:0;
}
.missing input::placeholder{color:rgba(34,197,94,.5)}
.actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.actions button{min-width:180px}
.msg{margin-top:10px;text-align:center;color:var(--muted);min-height:22px}
.msg.ok{color:#86efac}
.msg.bad{color:#fca5a5}
.footer{margin-top:10px;font-size:.85rem;color:var(--muted);text-align:center}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div>
        <div class="title">üß† Secuencia Perdida</div>
        <div class="subtitle">Juego de razonamiento: encuentra el n√∫mero que falta</div>
        <div class="subtitle">Por <strong>Soamy Lanza</strong></div>
      </div>
      <div class="badges">
        <div class="badge">‚è±Ô∏è <span id="time">00:00</span></div>
        <div class="badge">‚úÖ Correctas: <span id="correct">0</span></div>
        <div class="badge">üìä Progreso: <span id="progress">0</span>/<span id="total">10</span></div>
      </div>
    </div>

    <div class="main">
      <!-- IZQUIERDA -->
      <div class="panel">
        <div class="controls">
          <select id="level">
            <option value="bajo">Bajo</option>
            <option value="medio">Medio</option>
            <option value="alto">Alto</option>
          </select>
          <button class="primary" id="newBtn">Nuevo</button>
          <button class="warn" id="resetBtn">Reiniciar</button>
          <button id="shareBtn">Compartir</button>
        </div>

        <div class="panel">
          <strong>Instrucciones</strong>
          <ol>
            <li>Observa la secuencia.</li>
            <li>Escribe el n√∫mero en la casilla <b>?</b>.</li>
            <li>Presiona <b>Enter</b> o <b>Comprobar</b>.</li>
            <li>Completa las <b>10</b> secuencias de la partida.</li>
          </ol>
        </div>

        <div class="stats">
          <div class="stat">‚è±Ô∏è Tiempo<br><strong id="time2">00:00</strong></div>
          <div class="stat">üéØ Intentos<br><strong id="tries">0</strong></div>
          <div class="stat">‚ùå Fallos<br><strong id="fails">0</strong></div>
          <div class="stat">üî• Racha<br><strong id="streak">0</strong></div>
        </div>

        <div class="footer">
          Una sola pantalla ¬∑ Comparte el link por WhatsApp/redes
        </div>
      </div>

      <!-- DERECHA -->
      <div class="sequence-card">
        <h3 id="seqTitle">Secuencia 1</h3>
        <div class="seq" id="sequence"></div>
        <div class="actions">
          <button class="primary" id="checkBtn">Comprobar</button>
        </div>
        <div class="msg" id="msg"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================================================
   POOLS: muchas secuencias por nivel (fuente del azar)
   null = el lugar del "?"
====================================================== */
const POOL = {
  bajo: [
    [3,6,9,null,15],[2,4,6,null,10],[5,10,15,null,25],[1,2,3,null,5],[10,20,null,40,50],
    [7,11,15,null,23],[100,90,null,70,60],[4,8,12,null,20],[9,7,5,null,1],[11,22,33,null,55],
    [6,12,null,24,30],[50,45,null,35,30],[1,4,9,null,25],[8,16,null,32,40],[5,6,7,null,9],
    [12,14,16,null,20],[30,27,24,null,18],[2,6,10,null,18],[9,18,27,null,45],[15,14,13,null,11],
    [1,3,5,null,9],[2,3,4,null,6],[10,12,14,null,18],[20,25,30,null,40],[60,50,40,null,20]
  ],
  medio: [
    [2,6,12,null,30],[1,4,10,null,28],[3,9,27,null,243],[40,20,10,null,2.5],[7,14,28,null,112],
    [2,5,11,null,29],[81,27,9,null,1],[6,7,9,null,16],[10,13,19,null,34],[1,2,4,7,null],
    [9,18,36,null,144],[100,97,91,null,70],[12,24,48,null,192],[3,6,12,null,48],[5,15,45,null,405],
    [2,8,26,null,242],[4,9,19,null,49],[50,47,41,null,20],[5,8,14,null,35],[2,3,5,9,null],
    [6,10,15,null,28],[20,18,15,null,8],[4,12,20,null,44],[3,5,9,null,21],[2,4,7,null,16]
  ],
  alto: [
    [2,6,18,null,162],[3,7,15,null,63],[1,3,7,null,31],[5,11,23,null,95],[4,12,36,null,324],
    [10,9,7,null,0],[2,7,17,null,47],[6,13,27,null,86],[9,7,4,null,-4],[8,6,3,null,-5],
    [5,25,125,null,3125],[2,6,14,null,34],[100,50,25,null,6.25],[3,12,48,null,768],[2,4,8,null,32],
    [7,10,16,null,35],[1,4,12,null,108],[6,24,96,null,1536],[4,9,16,null,36],[2,9,28,null,243],
    [30,15,7.5,null,1.875],[1,5,14,null,30],[2,10,26,null,82],[3,8,18,null,43],[9,27,81,null,729]
  ]
};

/* ======================================================
   CONFIG: cada partida tiene 10 secuencias
====================================================== */
const GAME_SIZE = 10;

/* ======================================================
   ESTADO
====================================================== */
let level = "bajo";
let game = [];          // las 10 secuencias actuales (la partida)
let idx = 0;

let correct = 0;
let tries = 0;
let fails = 0;
let streak = 0;

let timer = null;
let seconds = 0;

// Para evitar repetici√≥n consecutiva:
let lastSequenceKeyByLevel = { bajo:null, medio:null, alto:null };
let lastGameKeyByLevel = { bajo:null, medio:null, alto:null };

const seqDiv = document.getElementById("sequence");
const msgEl = document.getElementById("msg");

/* ======================================================
   UTILS
====================================================== */
function formatMMSS(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function keyOfSeq(seq){ return seq.map(v => v===null ? "?" : String(v)).join(","); }
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ======================================================
   TIMER
====================================================== */
function startTimer(){
  if(timer) return;
  timer = setInterval(()=>{
    seconds++;
    const t = formatMMSS(seconds);
    document.getElementById("time").textContent = t;
    document.getElementById("time2").textContent = t;
  }, 1000);
}
function stopTimer(){
  clearInterval(timer);
  timer = null;
}

/* ======================================================
   GENERAR PARTIDA (10 secuencias) SIN REPETIR SEGUIDO
====================================================== */
function generateGame(lvl){
  const pool = POOL[lvl].map(s => s.slice()); // copia
  if(pool.length < GAME_SIZE) throw new Error("Pool insuficiente.");

  let attempt = 0;
  while(attempt < 50){
    attempt++;

    // Mezcla y toma 10
    let candidate = shuffle(pool).slice(0, GAME_SIZE);

    // 1) Evitar que la primera secuencia sea igual a la √∫ltima jugada del nivel
    const firstKey = keyOfSeq(candidate[0]);
    if(lastSequenceKeyByLevel[lvl] && firstKey === lastSequenceKeyByLevel[lvl]){
      // simple swap con otra dentro del candidato
      if(candidate.length > 1){
        [candidate[0], candidate[1]] = [candidate[1], candidate[0]];
      }
    }

    // 2) Evitar que el set (partida) sea igual al anterior set del nivel
    const gameKey = candidate.map(keyOfSeq).join("|");
    if(lastGameKeyByLevel[lvl] && gameKey === lastGameKeyByLevel[lvl]){
      continue; // reintentar
    }

    // 3) Evitar repeticiones consecutivas dentro de la partida (por si el pool tuviera duplicados)
    let ok = true;
    for(let i=1;i<candidate.length;i++){
      if(keyOfSeq(candidate[i]) === keyOfSeq(candidate[i-1])) { ok=false; break; }
    }
    if(!ok) continue;

    // guardar keys de control
    lastGameKeyByLevel[lvl] = gameKey;
    lastSequenceKeyByLevel[lvl] = keyOfSeq(candidate[candidate.length-1]); // √∫ltima de la partida

    return candidate;
  }

  // si falla por alguna raz√≥n, igual devuelvo una mezcla
  const fallback = shuffle(pool).slice(0, GAME_SIZE);
  lastGameKeyByLevel[lvl] = fallback.map(keyOfSeq).join("|");
  lastSequenceKeyByLevel[lvl] = keyOfSeq(fallback[fallback.length-1]);
  return fallback;
}

/* ======================================================
   CALCULAR RESPUESTA (heur√≠sticas simples)
====================================================== */
function computeCorrectValue(seq){
  const pos = seq.indexOf(null);

  // si hay vecinos, intenta aritm√©tica
  if(pos>0 && pos<seq.length-1 && seq[pos-1]!=null && seq[pos+1]!=null){
    return (seq[pos-1] + seq[pos+1]) / 2;
  }

  // intenta aritm√©tica con primeros 4 conocidos
  const known = seq.filter(v => v!==null);
  if(known.length >= 4){
    const d1 = known[1]-known[0], d2 = known[2]-known[1], d3 = known[3]-known[2];
    if(Math.abs(d1-d2)<1e-9 && Math.abs(d2-d3)<1e-9){
      if(pos===0) return known[0]-d1;
      if(pos===seq.length-1) return known[known.length-1]+d1;
    }
    // geom√©trica
    if(known[0]!==0){
      const r1=known[1]/known[0], r2=known[2]/known[1], r3=known[3]/known[2];
      if(Math.abs(r1-r2)<1e-9 && Math.abs(r2-r3)<1e-9){
        if(pos===0) return known[0]/r1;
        if(pos===seq.length-1) return known[known.length-1]*r1;
      }
    }
  }
  return NaN;
}

/* ======================================================
   RENDER
====================================================== */
function render(){
  const seq = game[idx];
  seqDiv.innerHTML = "";

  seq.forEach((n)=>{
    const d = document.createElement("div");
    d.className = "num" + (n===null ? " missing" : "");
    if(n===null){
      const inp = document.createElement("input");
      inp.type="number";
      inp.inputMode="numeric";
      inp.placeholder="?";
      inp.id="missingInput";
      inp.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); check(); }
      });
      d.appendChild(inp);
    }else{
      d.textContent = n;
    }
    seqDiv.appendChild(d);
  });

  document.getElementById("seqTitle").textContent = `Secuencia ${idx+1}`;
  document.getElementById("progress").textContent = idx;
  document.getElementById("total").textContent = GAME_SIZE;

  msgEl.textContent = "";
  msgEl.className = "msg";

  setTimeout(()=>{ document.getElementById("missingInput")?.focus(); },0);
}

/* ======================================================
   CHECK
====================================================== */
function check(){
  startTimer();

  const input = document.getElementById("missingInput");
  if(!input) return;

  const raw = input.value;
  if(raw==="" || raw===null){
    msgEl.textContent = "Escribe un n√∫mero en la casilla ?";
    msgEl.className = "msg bad";
    input.focus();
    return;
  }

  const userVal = Number(raw);
  const seq = game[idx];
  const correctVal = computeCorrectValue(seq);

  tries++;
  document.getElementById("tries").textContent = tries;

  const ok = Number.isFinite(correctVal) && Math.abs(userVal - correctVal) < 1e-9;

  if(ok){
    correct++;
    streak++;
    document.getElementById("correct").textContent = correct;
    document.getElementById("streak").textContent = streak;

    msgEl.textContent = "‚úÖ Correcto. ¬°Sigue!";
    msgEl.className = "msg ok";

    idx++;
    document.getElementById("progress").textContent = idx;

    if(idx >= GAME_SIZE){
      stopTimer();
      msgEl.textContent = `üéâ Partida terminada: ${correct}/${GAME_SIZE} correctas.`;
      msgEl.className = "msg ok";
      return;
    }
    render();
  }else{
    fails++;
    streak = 0;
    document.getElementById("fails").textContent = fails;
    document.getElementById("streak").textContent = streak;

    msgEl.textContent = "‚ùå Incorrecto. Intenta otra vez.";
    msgEl.className = "msg bad";
    input.select();
    input.focus();
  }
}

/* ======================================================
   NUEVO / REINICIAR
   - Nuevo: genera nueva partida aleatoria del nivel actual
   - Reiniciar: reinicia stats y vuelve a empezar la misma partida
====================================================== */
function resetStats(keepTimer=false){
  idx=0; correct=0; tries=0; fails=0; streak=0;
  document.getElementById("correct").textContent = "0";
  document.getElementById("tries").textContent = "0";
  document.getElementById("fails").textContent = "0";
  document.getElementById("streak").textContent = "0";
  document.getElementById("progress").textContent = "0";

  if(!keepTimer){
    seconds=0; stopTimer();
    document.getElementById("time").textContent="00:00";
    document.getElementById("time2").textContent="00:00";
  }
}

function newGame(){
  // nueva partida aleatoria seg√∫n nivel
  game = generateGame(level);
  resetStats(false);
  render();
}

function restartSameGame(){
  // reinicia todo pero deja el mismo set (misma partida)
  resetStats(false);
  render();
}

/* ======================================================
   SHARE
====================================================== */
async function share(){
  const url = location.href;
  try{
    await navigator.clipboard.writeText(url);
    alert("Link copiado ‚úÖ");
  }catch{
    prompt("Copia este link:", url);
  }
}

/* ======================================================
   EVENTOS
====================================================== */
document.getElementById("checkBtn").addEventListener("click", check);
document.getElementById("newBtn").addEventListener("click", newGame);
document.getElementById("resetBtn").addEventListener("click", restartSameGame);
document.getElementById("shareBtn").addEventListener("click", share);
document.getElementById("level").addEventListener("change",(e)=>{
  level = e.target.value;
  newGame(); // al cambiar nivel, genera partida nueva
});

/* ======================================================
   INIT
====================================================== */
newGame();
</script>
</body>
</html>
