<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Secuencia Perdida ‚Ä¢ Por Soamy Lanza</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111827;
      --card2:#0f172a;
      --stroke:rgba(255,255,255,.08);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 12px 35px rgba(0,0,0,.45);
      --r:18px;

      /* Ajuste para 1 pantalla (PC y m√≥vil) */
      --vh: 1vh;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(800px 600px at 85% 20%, rgba(56,189,248,.14), transparent 55%),
        radial-gradient(700px 600px at 70% 90%, rgba(245,158,11,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden; /* sin scroll */
    }

    .app{
      height: calc(var(--vh) * 100);
      padding: clamp(10px, 2vw, 18px);
      display:flex;
      flex-direction:column;
      gap:12px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      padding: 14px 16px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      min-height: 86px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 260px;
    }
    .title h1{
      margin:0;
      font-size: clamp(18px, 2.2vw, 24px);
      line-height:1.1;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .title .sub{
      color:var(--muted);
      font-size: 13px;
    }
    .title .by{
      color: #cbd5e1;
      font-size: 13px;
    }

    .hud{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .pill{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      border-radius: 999px;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 120px;
      justify-content:space-between;
    }
    .pill span{color:var(--muted); font-size:12px}
    .pill b{font-variant-numeric: tabular-nums; font-size:14px}

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:12px;
      min-height:0;
    }

    .panel, .boardWrap{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      min-height:0;
    }

    .panel{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .controlsRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    select, button{
      font: inherit;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding: 10px 12px;
      outline:none;
      cursor:pointer;
    }
    select{min-width: 92px}
    button{
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      user-select:none;
    }
    button:active{transform: translateY(1px)}
    .btnNew{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .btnReset{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12)}
    .btnShare{width:100%; padding: 12px 14px; font-weight: 700}
    .btnShare{border-color: rgba(255,255,255,.14)}
    .btnCheck{
      width:100%;
      padding: 14px 14px;
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      font-weight: 800;
      font-size: 14px;
    }

    .card{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .card h3{
      margin:0 0 6px 0;
      font-size: 13px;
      color:#cbd5e1;
      letter-spacing:.2px;
    }
    .card p{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      line-height:1.35;
    }

    .scoreGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .scoreItem{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .scoreItem span{color: var(--muted); font-size: 12px}
    .scoreItem b{font-variant-numeric: tabular-nums}

    .status{
      border-radius: 999px;
      border: 1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.12);
      padding: 6px 10px;
      font-size: 12px;
      color:#fde68a;
      width: fit-content;
      max-width: 100%;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .footerNote{
      margin-top:auto;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      opacity:.95;
    }

    .boardWrap{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    /* Zona de tablero: la hacemos "fit" para que SIEMPRE quepa */
    .boardStage{
      flex:1;
      min-height:0;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px dashed rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(0,0,0,.10);
      overflow:hidden;
      padding: 10px;
    }

    .sequenceCard{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      border-radius: 18px;
      padding: 14px 14px;
      width: min(760px, 100%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }

    .seqTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .seqTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 220px;
    }
    .seqTitle b{font-size: 14px}
    .seqTitle span{font-size: 12px; color: var(--muted)}
    .progress{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color:#cbd5e1;
    }

    .seqLine{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }
    .token{
      min-width: 58px;
      text-align:center;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight: 800;
      font-size: 18px;
      font-variant-numeric: tabular-nums;
    }
    .token.missing{
      border-color: rgba(56,189,248,.35);
      background: rgba(56,189,248,.10);
      color:#e0f2fe;
    }

    .answerRow{
      margin-top: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    .answerRow input{
      width: 180px;
      max-width: 60vw;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font: inherit;
      font-size: 16px;
      text-align:center;
      font-variant-numeric: tabular-nums;
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
      line-height:1.35;
    }
    .result{
      margin-top: 10px;
      text-align:center;
      font-weight: 800;
      font-size: 14px;
      min-height: 18px;
    }
    .ok{color:#86efac}
    .no{color:#fca5a5}

    /* Responsive */
    @media (max-width: 900px){
      body{overflow:hidden}
      .main{grid-template-columns: 1fr; }
      .panel{order:2}
      .boardWrap{order:1}
      .top{min-height: 78px}
      .pill{min-width: 110px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="top">
      <div class="title">
        <h1>üß† Secuencia Perdida</h1>
        <div class="sub">Juego de razonamiento: encuentra el n√∫mero que falta.</div>
        <div class="by">Por: <b>Soamy Lanza</b></div>
      </div>

      <div class="hud" aria-label="Indicadores">
        <div class="pill"><span>‚è±Ô∏è Tiempo</span><b id="time">00:00.0</b></div>
        <div class="pill"><span>‚úÖ Correctas</span><b id="correct">0</b></div>
        <div class="pill"><span>üéØ Progreso</span><b id="progress">1/20</b></div>
        <div class="pill"><span>üìå Nivel</span><b id="levelLabel">Bajo</b></div>
      </div>
    </header>

    <section class="main">
      <aside class="panel">
        <div class="controlsRow">
          <select id="level">
            <option value="bajo">Bajo</option>
            <option value="medio">Medio</option>
            <option value="alto">Alto</option>
          </select>

          <button class="btnNew" id="newBtn">Nuevo</button>
          <button class="btnReset" id="resetBtn">Reiniciar</button>
          <button id="shareBtn">Compartir</button>
        </div>

        <div class="card">
          <h3>Instrucciones</h3>
          <p>
            1) Observa la secuencia y detecta el patr√≥n.<br>
            2) Escribe el n√∫mero que falta donde aparece <b>?</b>.<br>
            3) Presiona <b>Comprobar</b>. Completa <b>20</b> para tu puntaje final.
          </p>
        </div>

        <div class="scoreGrid" aria-label="Marcadores">
          <div class="scoreItem"><span>‚è±Ô∏è Tiempo</span><b id="time2">00:00.0</b></div>
          <div class="scoreItem"><span>üß© Racha</span><b id="streak">0</b></div>
          <div class="scoreItem"><span>üìù Intentos</span><b id="tries">0</b></div>
          <div class="scoreItem"><span>‚ùå Fallos</span><b id="wrong">0</b></div>
        </div>

        <div class="status" id="status">Listo. Presiona ‚ÄúNuevo‚Äù o empieza.</div>

        <div class="footerNote">
          <span>Una sola pantalla</span>
          <span>Comparte el link por WhatsApp/redes</span>
        </div>
      </aside>

      <main class="boardWrap">
        <button class="btnCheck" id="checkBtn">Comprobar</button>

        <div class="boardStage" id="stage">
          <div class="sequenceCard">
            <div class="seqTop">
              <div class="seqTitle">
                <b id="qTitle">Secuencia 1</b>
                <span id="qDesc">Detecta el patr√≥n y encuentra el valor faltante.</span>
              </div>
              <div class="progress">
                <span class="chip" id="chipType">Patr√≥n: ‚Äî</span>
                <span class="chip" id="chipDiff">Dificultad: Bajo</span>
              </div>
            </div>

            <div class="seqLine" id="seqLine" aria-label="Secuencia">
              <!-- tokens -->
            </div>

            <div class="answerRow">
              <input id="answer" inputmode="numeric" autocomplete="off" placeholder="Tu respuesta" />
            </div>

            <div class="result" id="result"></div>
            <div class="hint" id="hint">
              Tip: Si te atoras, mira diferencias entre t√©rminos, multiplicaciones o alternancias.
            </div>
          </div>
        </div>
      </main>
    </section>
  </div>

<script>
(() => {
  // ---- Viewport real (evita scroll por barras del navegador) ----
  function setVH(){
    const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight) * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  setVH();
  window.addEventListener('resize', setVH);
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', setVH);
    window.visualViewport.addEventListener('scroll', setVH);
  }

  // ---- Utilidades ----
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,'0');

  function fmtTime(ms){
    const s = ms/1000;
    const mm = Math.floor(s/60);
    const ss = Math.floor(s%60);
    const t = (s - Math.floor(s)).toFixed(1).slice(1); // .0
    return `${pad2(mm)}:${pad2(ss)}${t}`;
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function randInt(a,b){ // inclusive
    return Math.floor(Math.random()*(b-a+1))+a;
  }

  // ---- Generadores de secuencias por nivel ----
  // Devuelven: { seq: number[], missingIndex: number, answer: number, type: string }
  function genEasy(){
    const types = ['+d', '-d', 'xk', 'cuadrados', 'fibo', 'pares'];
    const pick = types[randInt(0, types.length-1)];
    let seq = [], ans = 0, miss = randInt(1,3);

    if(pick === '+d'){
      const start = randInt(1,20);
      const d = randInt(2,9);
      seq = Array.from({length:5},(_,i)=> start + i*d);
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Suma +${d}`};
    }

    if(pick === '-d'){
      const start = randInt(20,80);
      const d = randInt(2,9);
      seq = Array.from({length:5},(_,i)=> start - i*d);
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Resta -${d}`};
    }

    if(pick === 'xk'){
      const start = randInt(1,6);
      const k = randInt(2,4);
      seq = Array.from({length:5},(_,i)=> start + i*k);
      // convi√©rtelo a m√∫ltiplos suaves
      seq = seq.map(v => v*k);
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`M√∫ltiplos de ${k}`};
    }

    if(pick === 'cuadrados'){
      const start = randInt(1,4);
      seq = Array.from({length:5},(_,i)=> (start+i)**2);
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Cuadrados`};
    }

    if(pick === 'fibo'){
      let a = randInt(1,5), b = randInt(1,6);
      seq = [a,b];
      for(let i=2;i<5;i++) seq.push(seq[i-1]+seq[i-2]);
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Fibonacci`};
    }

    // pares: +2 desde un impar/par
    const start = randInt(0,1) ? randInt(2,18)*2 : randInt(1,19)*2-1;
    const d = 2;
    seq = Array.from({length:5},(_,i)=> start + i*d);
    ans = seq[miss];
    return {seq, missingIndex: miss, answer: ans, type:`Paso +2`};
  }

  function genMedium(){
    const types = ['alterno', 'arit2', 'geom', 'triangular', 'mix'];
    const pick = types[randInt(0, types.length-1)];
    let seq = [], ans = 0, miss = randInt(1,3);

    if(pick === 'alterno'){
      // a,b,a,b... con dos pasos distintos
      const a = randInt(2,20);
      const b = a + randInt(3,12);
      const da = randInt(1,6);
      const db = randInt(1,6);
      seq = [];
      let x=a, y=b;
      for(let i=0;i<5;i++){
        if(i%2===0){ seq.push(x); x += da; }
        else{ seq.push(y); y += db; }
      }
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Alterna (2 series)`};
    }

    if(pick === 'arit2'){
      // diferencias crecen: +d, +(d+1), ...
      const start = randInt(1,20);
      let d = randInt(2,6);
      seq = [start];
      for(let i=1;i<5;i++){
        seq.push(seq[i-1] + d);
        d += 1;
      }
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Diferencias crecientes`};
    }

    if(pick === 'geom'){
      const start = randInt(2,8);
      const r = [2,3][randInt(0,1)];
      seq = Array.from({length:5},(_,i)=> start * (r**i));
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Multiplica √ó${r}`};
    }

    if(pick === 'triangular'){
      // 1,3,6,10,15... (suma 1,2,3,4...)
      const base = randInt(0,6);
      seq = [];
      let v = base;
      for(let i=1;i<=5;i++){
        v += i;
        seq.push(v);
      }
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Triangulares`};
    }

    // mix: +a, +b alternando
    const start = randInt(1,25);
    const a = randInt(2,9);
    const b = randInt(2,9);
    seq = [start];
    for(let i=1;i<5;i++){
      seq.push(seq[i-1] + (i%2? a : b));
    }
    ans = seq[miss];
    return {seq, missingIndex: miss, answer: ans, type:`Suma alternada +${a}/+${b}`};
  }

  function genHard(){
    const types = ['op', 'cuadPlus', 'dobleSerie', 'powMix', 'altMulAdd'];
    const pick = types[randInt(0, types.length-1)];
    let seq = [], ans = 0, miss = randInt(1,3);

    if(pick === 'op'){
      // operaci√≥n encadenada: x2 + c, x2 + c...
      let v = randInt(2,9);
      const c = randInt(1,9);
      seq = [v];
      for(let i=1;i<5;i++){
        v = v*2 + c;
        seq.push(v);
      }
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`√ó2 + ${c}`};
    }

    if(pick === 'cuadPlus'){
      // n^2 + k
      const n0 = randInt(2,5);
      const k = randInt(3,20);
      seq = Array.from({length:5},(_,i)=> (n0+i)**2 + k);
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`n¬≤ + ${k}`};
    }

    if(pick === 'dobleSerie'){
      // suma de dos series: (a+i*d1) + (b+i*d2)
      const a = randInt(1,20), b = randInt(1,20);
      const d1 = randInt(1,6), d2 = randInt(1,6);
      seq = Array.from({length:5},(_,i)=> (a+i*d1) + (b+i*d2));
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Suma de 2 progresiones`};
    }

    if(pick === 'powMix'){
      // potencias suaves + alternancia
      const start = randInt(2,5);
      const add = randInt(1,7);
      seq = [];
      for(let i=0;i<5;i++){
        const p = start+i;
        seq.push((p*p) + (i%2===0 ? add : add*2));
      }
      ans = seq[miss];
      return {seq, missingIndex: miss, answer: ans, type:`Cuadrados + alterna`};
    }

    // alterna: *r, +c
    let v = randInt(2,12);
    const r = [2,3][randInt(0,1)];
    const c = randInt(2,10);
    seq = [v];
    for(let i=1;i<5;i++){
      v = (i%2===1) ? (v*r) : (v + c);
      seq.push(v);
    }
    ans = seq[miss];
    return {seq, missingIndex: miss, answer: ans, type:`Alterna √ó${r} / +${c}`};
  }

  function generateQuestion(level){
    if(level === 'bajo') return genEasy();
    if(level === 'medio') return genMedium();
    return genHard();
  }

  // ---- Estado del juego ----
  const state = {
    level: 'bajo',
    questions: [],
    idx: 0,
    correct: 0,
    wrong: 0,
    tries: 0,
    streak: 0,
    started: false,
    t0: 0,
    timer: null,
    running: false,
    current: null
  };

  // ---- UI refs ----
  const levelSel = $('level');
  const newBtn = $('newBtn');
  const resetBtn = $('resetBtn');
  const shareBtn = $('shareBtn');
  const checkBtn = $('checkBtn');
  const ansInp = $('answer');

  const timeEl = $('time');
  const timeEl2 = $('time2');
  const correctEl = $('correct');
  const wrongEl = $('wrong');
  const triesEl = $('tries');
  const streakEl = $('streak');
  const progressEl = $('progress');
  const levelLabel = $('levelLabel');

  const statusEl = $('status');
  const qTitle = $('qTitle');
  const chipType = $('chipType');
  const chipDiff = $('chipDiff');
  const seqLine = $('seqLine');
  const resultEl = $('result');
  const hintEl = $('hint');

  function setStatus(msg, kind='warn'){
    statusEl.textContent = msg;
    if(kind==='ok'){
      statusEl.style.borderColor = 'rgba(34,197,94,.35)';
      statusEl.style.background = 'rgba(34,197,94,.12)';
      statusEl.style.color = '#bbf7d0';
    }else if(kind==='bad'){
      statusEl.style.borderColor = 'rgba(239,68,68,.35)';
      statusEl.style.background = 'rgba(239,68,68,.12)';
      statusEl.style.color = '#fecaca';
    }else{
      statusEl.style.borderColor = 'rgba(245,158,11,.35)';
      statusEl.style.background = 'rgba(245,158,11,.12)';
      statusEl.style.color = '#fde68a';
    }
  }

  function updateHUD(){
    correctEl.textContent = state.correct;
    wrongEl.textContent = state.wrong;
    triesEl.textContent = state.tries;
    streakEl.textContent = state.streak;
    progressEl.textContent = `${state.idx+1}/20`;
    const lvlName = state.level.charAt(0).toUpperCase()+state.level.slice(1);
    levelLabel.textContent = lvlName;
    chipDiff.textContent = `Dificultad: ${lvlName}`;
  }

  function startTimer(){
    if(state.running) return;
    state.running = true;
    state.started = true;
    state.t0 = performance.now() - (state.elapsed || 0);
    state.timer = setInterval(() => {
      state.elapsed = performance.now() - state.t0;
      const t = fmtTime(state.elapsed);
      timeEl.textContent = t;
      timeEl2.textContent = t;
    }, 100);
  }

  function stopTimer(){
    state.running = false;
    if(state.timer){ clearInterval(state.timer); state.timer=null; }
  }

  function resetTimer(){
    stopTimer();
    state.elapsed = 0;
    const t = fmtTime(0);
    timeEl.textContent = t;
    timeEl2.textContent = t;
  }

  function buildSet(){
    // 20 preguntas del nivel (mezcla interna)
    const qs = [];
    for(let i=0;i<20;i++){
      qs.push(generateQuestion(state.level));
    }
    // Un toque de mezcla para que no sea mon√≥tono
    state.questions = shuffle(qs);
    state.idx = 0;
  }

  function renderQuestion(){
    state.current = state.questions[state.idx];
    const q = state.current;

    qTitle.textContent = `Secuencia ${state.idx+1}`;
    chipType.textContent = `Patr√≥n: ${q.type}`;

    // render tokens
    seqLine.innerHTML = '';
    q.seq.forEach((v,i)=>{
      const d = document.createElement('div');
      d.className = 'token' + (i===q.missingIndex ? ' missing' : '');
      d.textContent = (i===q.missingIndex) ? '?' : String(v);
      seqLine.appendChild(d);
    });

    resultEl.textContent = '';
    resultEl.className = 'result';
    ansInp.value = '';
    ansInp.focus({preventScroll:true});

    // Hint seg√∫n nivel
    if(state.level==='bajo') hintEl.textContent = 'Tip: busca sumas/restas constantes o m√∫ltiplos.';
    else if(state.level==='medio') hintEl.textContent = 'Tip: prueba alternancias (+a/+b), diferencias crecientes o multiplicaci√≥n.';
    else hintEl.textContent = 'Tip: combina reglas (√ó y +), o mira dos series intercaladas.';
    updateHUD();
  }

  function endGame(){
    stopTimer();
    const total = 20;
    const msg = `Final: ${state.correct}/${total} correctas. Tiempo: ${fmtTime(state.elapsed||0)}.`;
    setStatus(msg, state.correct>=15 ? 'ok' : (state.correct>=10 ? 'warn' : 'bad'));
    resultEl.textContent = msg;
    resultEl.className = 'result ' + (state.correct>=15 ? 'ok' : (state.correct>=10 ? '' : 'no'));
  }

  function newGame(){
    state.level = levelSel.value;
    resetTimer();

    state.correct = 0;
    state.wrong = 0;
    state.tries = 0;
    state.streak = 0;
    state.started = false;

    buildSet();
    renderQuestion();
    setStatus('Nuevo set generado. ¬°Dale!', 'warn');
  }

  function restart(){
    // Reinicia con mismas preguntas (mismo set)
    resetTimer();

    state.correct = 0;
    state.wrong = 0;
    state.tries = 0;
    state.streak = 0;
    state.started = false;
    state.idx = 0;

    renderQuestion();
    setStatus('Reiniciado (mismo set). ¬°Vamos!', 'warn');
  }

  function checkAnswer(){
    if(!state.current) return;

    const raw = ansInp.value.trim();
    if(raw === ''){
      setStatus('Escribe una respuesta antes de comprobar.', 'bad');
      return;
    }

    // Arranca cron√≥metro con la primera acci√≥n real
    startTimer();

    const val = Number(raw);
    if(!Number.isFinite(val)){
      setStatus('Tu respuesta debe ser un n√∫mero.', 'bad');
      return;
    }

    state.tries++;
    const ok = (val === state.current.answer);

    if(ok){
      state.correct++;
      state.streak++;
      resultEl.textContent = '‚úÖ Correcto. ¬°Sigue!';
      resultEl.className = 'result ok';
      setStatus('Correcto ‚úÖ', 'ok');
    }else{
      state.wrong++;
      state.streak = 0;
      resultEl.textContent = `‚ùå Incorrecto. La respuesta era ${state.current.answer}.`;
      resultEl.className = 'result no';
      setStatus('Incorrecto ‚ùå', 'bad');
    }

    updateHUD();

    // Avanzar (peque√±o delay para leer)
    setTimeout(() => {
      if(state.idx >= 19){
        endGame();
      }else{
        state.idx++;
        renderQuestion();
        setStatus('Siguiente secuencia‚Ä¶', 'warn');
      }
    }, 520);
  }

  async function share(){
    const url = location.href;
    const text = `Secuencia Perdida üß† (Por: Soamy Lanza)\n¬øCu√°ntas correctas sacas de 20?\n${url}`;
    try{
      if(navigator.share){
        await navigator.share({title: document.title, text, url});
      }else{
        await navigator.clipboard.writeText(url);
        alert('Link copiado ‚úÖ');
      }
    }catch(e){
      try{
        await navigator.clipboard.writeText(url);
        alert('Link copiado ‚úÖ');
      }catch(_){
        prompt('Copia este link:', url);
      }
    }
  }

  // ---- Eventos ----
  newBtn.addEventListener('click', newGame);
  resetBtn.addEventListener('click', restart);
  shareBtn.addEventListener('click', share);
  checkBtn.addEventListener('click', checkAnswer);

  levelSel.addEventListener('change', () => {
    // Cambiar nivel = nuevo set
    newGame();
  });

  ansInp.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      checkAnswer();
    }
  });

  // ---- Init ----
  // Autoinicio suave
  state.level = levelSel.value;
  newGame();
})();
</script>
</body>
</html>
