<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Headcount</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' rx='14' fill='%232563eb'/><circle cx='22' cy='32' r='10' fill='%23fff' opacity='.9'/><circle cx='40' cy='32' r='10' fill='%23fff' opacity='.35'/></svg>">
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0d1a30;
      --stroke:rgba(255,255,255,.10);
      --muted:rgba(232,238,252,.72);
      --text:#e8eefc;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 18% 12%, rgba(37,99,235,.25), transparent 55%),
        radial-gradient(700px 450px at 85% 18%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 95%, rgba(244,63,94,.12), transparent 60%),
        var(--bg);
      min-height:100vh;
      padding:18px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position:sticky;
      top:10px;
      z-index:5;
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .dot{
      width:12px;height:12px;border-radius:99px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.25) 35%, rgba(255,255,255,.05) 60%), #2563eb;
      box-shadow: 0 0 0 4px rgba(37,99,235,.15);
    }
    .titleWrap .title{ font-size:15px; font-weight:800; letter-spacing:.2px; line-height:1.1; }
    .titleWrap .sub{
      font-size:12px; color:var(--muted); margin-top:2px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill{ border:1px solid var(--stroke); background:rgba(255,255,255,.03); padding:4px 10px; border-radius:999px; }
    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition: transform .08s ease, border-color .2s ease, opacity .2s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.24); }
    .btn:active{ transform: translateY(0px); opacity:.9; }
    .btn.primary{ border-color: rgba(34,197,94,.35); background:linear-gradient(180deg, rgba(34,197,94,.28), rgba(34,197,94,.12)); }
    .btn.ghost{ background: rgba(255,255,255,.03); box-shadow:none; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .filtersTop{
      margin-top:14px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:nowrap;
      overflow-x:auto;
      overscroll-behavior-x: contain;
      -webkit-overflow-scrolling: touch;
    }
    .filtersTop::-webkit-scrollbar{ height:10px; }
    .filtersTop::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.25);
    }
    .filtersTop .filterBox{
      flex:0 0 auto;
      min-width: 190px;
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:8px 10px;
      background:rgba(0,0,0,.08);
    }
    .filterBox .lbl{ font-size:12px; color:var(--muted); font-weight:800; margin-bottom:6px; }
    .sel{ width:100%; appearance:none; outline:none; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:800; font-size:13px; }
    .sel option{ color:#0b1220; }
    .selWrap{ position:relative; }
    .selWrap:after{ content:"â–¾"; position:absolute; right:12px; top:50%; transform:translateY(-50%); color:rgba(232,238,252,.75); pointer-events:none; font-weight:900; }

    .grid{ margin-top:14px; display:grid; grid-template-columns: repeat(3, minmax(240px, 1fr)); gap:14px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); } }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      body{ padding:12px; }
      .filtersTop{ padding:10px; }
      .filtersTop .filterBox{ min-width: 210px; }
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .cardHeader{
      padding:12px 14px 8px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      background:rgba(0,0,0,.10);
    }
    .cardHeader .h{ font-weight:900; font-size:13px; letter-spacing:.2px; margin:0; }
    .cardHeader .hint{ font-size:12px; color:var(--muted); margin-top:4px; }
    .cardBody{ padding:10px 12px 12px 12px; min-height: 280px; }
    .chart{ width:100%; height: 260px; }
    .chart.tall{ height: 290px; }

    .nodata{
      width:100%;
      height:260px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px dashed rgba(255,255,255,.16);
      border-radius:14px;
      color:rgba(232,238,252,.75);
      background:rgba(0,0,0,.10);
      font-weight:800;
      letter-spacing:.2px;
    }
    .nodata.tall{ height:290px; }

    .kpis{ display:grid; grid-template-columns: 1fr; gap:10px; padding:12px 14px 14px 14px; }
    .kpiRow{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:14px;
      background:rgba(255,255,255,.03);
    }
    .kpiRow .k{ font-size:12px; color:var(--muted); font-weight:700;}
    .kpiRow .v{ font-size:13px; font-weight:900; }

    .status{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); font-weight:700; }
    .status .led{ width:9px;height:9px;border-radius:99px;background:var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.16); }
    .status.ok .led{ background:var(--good); box-shadow: 0 0 0 4px rgba(34,197,94,.16); }
    .status.bad .led{ background:var(--bad); box-shadow: 0 0 0 4px rgba(239,68,68,.16); }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      background:rgba(15,27,51,.95);
      border:1px solid var(--stroke);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      font-size:12px;
      color:var(--text);
      display:none;
      max-width: 360px;
      z-index:9;
    }
    .summaryWrap{ margin-top:14px; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div class="titleWrap">
        <div class="title">Dashboard Headcount</div>
        <div class="sub">
          <span class="pill" id="updatedAt">Actualizado: â€”</span>
          <span class="pill" id="rowCount">Â· Registros: â€”</span>
          <span class="pill" id="sheetName">Â· Hoja: Maestro</span>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnConfig" type="button"><span>âš™</span> Config URL</button>
      <button class="btn primary" id="btnRefresh" type="button"><span>âŸ³</span> Actualizar</button>
      <button class="btn ghost" id="btnClear" type="button"><span>âœ•</span> Limpiar filtros</button>
    </div>
  </div>

  <!-- âœ… MenÃºs por variable -->
  <div class="filtersTop" id="filtersTop" aria-label="Filtros superiores"></div>

  <div class="grid">
    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="h">GÃ©nero</div>
          <div class="hint">Click en una categorÃ­a para filtrar el resto.</div>
        </div>
      </div>
      <div class="cardBody"><div class="chart" id="c_genero"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">Estado civil</div><div class="hint">Frecuencia por categorÃ­a.</div></div>
      </div>
      <div class="cardBody"><div class="chart" id="c_estado"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">Escolaridad</div><div class="hint">Frecuencia por categorÃ­a.</div></div>
      </div>
      <div class="cardBody"><div class="chart" id="c_escolaridad"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">Departamento</div><div class="hint">Top 15 por frecuencia (si aplica).</div></div>
      </div>
      <div class="cardBody"><div class="chart tall" id="c_departamento"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">PosiciÃ³n</div><div class="hint">Top 15 por frecuencia (si aplica).</div></div>
      </div>
      <div class="cardBody"><div class="chart tall" id="c_posicion"></div></div>
    </div>

  <div class="summaryWrap">
    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="h">Resumen</div>
          <div class="hint">Los filtros viven arriba.</div>
        </div>
        <div class="status ok" id="statusBox">
          <span class="led"></span> <span id="statusText">OK</span>
        </div>
      </div>

      <div class="kpis">
        <div class="kpiRow">
          <div>
            <div class="k">Ãšltima actualizaciÃ³n</div>
            <div class="v" id="updatedAtBig">â€”</div>
          </div>
          <div style="text-align:right">
            <div class="k">Registros</div>
            <div class="v" id="rowCountBig">â€”</div>
          </div>
        </div>

        <div class="kpiRow">
          <div>
            <div class="k">Filtros activos</div>
            <div class="v" id="filtersActive">â€”</div>
          </div>
          <div style="text-align:right">
            <div class="k">Tip</div>
            <div class="v" style="font-size:12px; font-weight:800; color:var(--muted)">Scroll horizontal en filtros</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/******************************************************************
 * âœ… CONFIG
 ******************************************************************/
const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycby5LRszggFk0NEKErFARvvJIQ04gKafpGWz8dkPMsTd2XPcs0APqP2hAoXU2PgmP8A5/exec";
const GAS_URL_STORAGE_KEY = "RH_DASHBOARD_GAS_URL";
const SHEET_NAME = "Maestro";

/******************************************************************
 * âœ… FILTROS / MENÃšS POR VARIABLE
 ******************************************************************/
const FILTER_META = [
  { key:'genero',      label:'GÃ©nero',       selectId:'sel_genero',       colIndex:0 },
  { key:'estado',      label:'Estado civil', selectId:'sel_estado',       colIndex:1 },
  { key:'escolaridad', label:'Escolaridad',  selectId:'sel_escolaridad',  colIndex:2 },
  { key:'departamento',label:'Departamento', selectId:'sel_departamento', colIndex:3 },
  { key:'posicion',    label:'PosiciÃ³n',     selectId:'sel_posicion',     colIndex:4 },
  { key:'localidad',   label:'Localidad',    selectId:'sel_localidad',    colIndex:5 },
];

const MENUS = { genero:[], estado:[], escolaridad:[], departamento:[], posicion:[], localidad:[] };
const filterState = {};
FILTER_META.forEach(m => filterState[m.key] = 'Todos'); // âœ… por defecto

/******************************************************************
 * âœ… GOOGLE CHARTS
 ******************************************************************/
google.charts.load('current', { packages: ['corechart'] });

let dataTable = null;
const charts = {};
const lastChartData = {};
let latestPayload = null;
let resizeTimer = null;
let uiReady_ = false;

let domReady = false;
let chartsReady = false;

document.addEventListener('DOMContentLoaded', () => {
  domReady = true;
  renderFilterMenus_();
  hookButtons_();
  hookSelects_();
  tryBoot_();
});
google.charts.setOnLoadCallback(() => {
  chartsReady = true;
  tryBoot_();
});

function tryBoot_(){
  if (!domReady || !chartsReady) return;
  requestAnimationFrame(() => init_());
}

/******************************************************************
 * âœ… UI helpers
 ******************************************************************/
function el_(id){ return document.getElementById(id); }

function getGasUrl_(){
  return (localStorage.getItem(GAS_URL_STORAGE_KEY) || DEFAULT_GAS_URL).trim();
}
function setGasUrl_(u){
  localStorage.setItem(GAS_URL_STORAGE_KEY, u.trim());
}

function renderFilterMenus_(){
  const wrap = el_('filtersTop');
  wrap.innerHTML = FILTER_META.map(m => `
    <div class="filterBox">
      <div class="lbl">${m.label}</div>
      <div class="selWrap">
        <select class="sel" id="${m.selectId}"></select>
      </div>
    </div>
  `).join('');
}

function hookButtons_(){
  el_('btnRefresh').addEventListener('click', refreshNow_);
  el_('btnClear').addEventListener('click', clearAllFilters_);
  el_('btnConfig').addEventListener('click', configUrl_);
}

function hookSelects_(){
  FILTER_META.forEach(m => {
    el_(m.selectId).addEventListener('change', () => {
      filterState[m.key] = el_(m.selectId).value || 'Todos';
      safeRedrawAll_();
    });
  });
}

function configUrl_(){
  const current = getGasUrl_();
  const next = prompt("Pega aquÃ­ la URL del WebApp (DEBE terminar en /exec):", current);
  if (next == null) return;
  const u = next.trim();
  if (!/^https:\/\/script\.google\.com\/macros\/s\//.test(u) || !/\/exec(\?|$)/.test(u)) {
    showToast_("Esa URL no parece vÃ¡lida. Debe verse como https://script.google.com/macros/s/.../exec");
    return;
  }
  setGasUrl_(u);
  showToast_("URL guardada. Ahora sÃ­, que ruede el headcount. ðŸ˜„");
  refreshNow_();
}

function setStatus_(mode, text){
  const box = el_('statusBox');
  const t = el_('statusText');
  box.classList.remove('ok','bad');
  if (mode === 'ok') box.classList.add('ok');
  if (mode === 'bad') box.classList.add('bad');
  t.textContent = text;
}

function showToast_(msg){
  const el = el_('toast');
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(el._t);
  el._t = setTimeout(() => (el.style.display = 'none'), 4200);
}

function attachResize_(){
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => safeRedrawAll_(), 180);
  });
}

/******************************************************************
 * âœ… NormalizaciÃ³n / utilidades
 ******************************************************************/
function norm_(s){
  return String(s || '')
    .trim().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ');
}

function fixLocalidad_(v){
  const raw = String(v ?? '').trim();
  if (!raw) return '(VacÃ­o)';
  const k = norm_(raw);
  const map = {
    'tegucigaloa': 'Tegucigalpa',
    'tegus': 'Tegucigalpa',
    'tegucigalpaa': 'Tegucigalpa'
  };
  return map[k] || raw;
}

function uniqKeepOrder_(arr){
  const seen = new Set();
  const out = [];
  (arr || []).forEach(x => {
    const v = String(x ?? '').trim();
    if (!v) return;
    const k = norm_(v);
    if (seen.has(k)) return;
    seen.add(k);
    out.push(v);
  });
  return out;
}

function ensureTodos_(arr){
  const a = (arr || []).map(x => String(x).trim()).filter(Boolean);
  if (!a.length) return ['Todos'];
  const has = a.some(x => norm_(x) === 'todos');
  const rest = a.filter(x => norm_(x) !== 'todos');
  return has ? ['Todos', ...rest] : ['Todos', ...a];
}

/******************************************************************
 * âœ… Init / Data load (JSONP)
 ******************************************************************/
async function init_(){
  setStatus_('warn', 'Cargandoâ€¦');

  const GAS_WEBAPP_URL = getGasUrl_();
  if (!/^https:\/\/script\.google\.com\/macros\/s\//.test(GAS_WEBAPP_URL) || !/\/exec(\?|$)/.test(GAS_WEBAPP_URL)) {
    setStatus_('bad', 'Error');
    showToast_('URL GAS invÃ¡lida. Debe terminar en /exec (usa Config URL).');
    el_('updatedAt').textContent = 'Error: URL /exec invÃ¡lida';
    return;
  }

  try {
    await ping_(GAS_WEBAPP_URL);
  } catch (e) {
    setStatus_('bad', 'Error');
    showToast_(
      'No responde el WebApp (/exec) o no es pÃºblico. ' +
      'Revisa Deploy: "Anyone/Cualquiera". ' +
      'Detalle: ' + (e?.message || e)
    );
    el_('updatedAt').textContent = 'Error: ' + (e?.message || e);
    return;
  }

  loadData_(GAS_WEBAPP_URL, { forceRefresh:false })
    .then(payload => {
      latestPayload = payload;

      if (!payload || typeof payload !== 'object') throw new Error('Payload invÃ¡lido (no es objeto).');
      if (payload?.error) {
        setStatus_('bad', 'Error');
        showToast_('Error desde GAS: ' + payload.error);
      }

      setHeader_(payload);
      buildDataTable_(payload.rows || []);
      buildCharts_();

      // âœ… Default = "Todos"
      FILTER_META.forEach(m => filterState[m.key] = 'Todos');
      buildDropdownsFromPayload_(payload);

      uiReady_ = true;
      safeRedrawAll_();
      setStatus_('ok', 'OK');
      attachResize_();
    })
    .catch(err => {
      console.error(err);
      setStatus_('bad', 'Error');
      showToast_('No se pudo inicializar: ' + (err?.message || err));
      el_('updatedAt').textContent = 'Error: ' + (err?.message || err);
    });
}

function ping_(baseUrl){
  const url = new URL(baseUrl);
  url.searchParams.set('ping','1');
  url.searchParams.set('_ts', Date.now().toString());
  return jsonpLoad_(url.toString(), { timeoutMs: 12000 });
}

function loadData_(baseUrl, { forceRefresh }){
  const url = new URL(baseUrl);
  url.searchParams.set('sheet', SHEET_NAME);
  if (forceRefresh) url.searchParams.set('action', 'refresh');
  url.searchParams.set('_ts', Date.now().toString());
  return jsonpLoad_(url.toString(), { timeoutMs: 15000 });
}

// âœ… JSONP robusto
function jsonpLoad_(url, { timeoutMs = 12000 } = {}){
  return new Promise((resolve, reject) => {
    const cbName = 'cb_' + Math.random().toString(36).slice(2);
    const script = document.createElement('script');
    script.async = true;

    let done = false;
    let t = null;

    function cleanup_(){
      if (t) clearTimeout(t);
      try { delete window[cbName]; } catch(e) {}
      script.remove();
    }

    window[cbName] = (data) => {
      if (done) return;
      done = true;
      cleanup_();
      resolve(data);
    };

    script.onerror = () => {
      if (done) return;
      done = true;
      cleanup_();
      reject(new Error(
        'Fallo al cargar el script JSONP. ' +
        'Causas tÃ­picas: URL /exec incorrecta (404) o WebApp no pÃºblico.'
      ));
    };

    t = setTimeout(() => {
      if (done) return;
      done = true;
      cleanup_();
      reject(new Error(
        'Timeout JSONP. Muchas veces significa que GAS devolviÃ³ HTML/login en vez de JS. ' +
        'Revisa Deploy: "Who has access: Anyone/Cualquiera".'
      ));
    }, timeoutMs);

    const u = new URL(url);
    u.searchParams.set('callback', cbName);
    script.src = u.toString();
    document.head.appendChild(script);
  });
}

/******************************************************************
 * âœ… ConstrucciÃ³n de DataTable
 ******************************************************************/
function buildDataTable_(rows){
  dataTable = new google.visualization.DataTable();
  dataTable.addColumn('string', 'GÃ©nero');
  dataTable.addColumn('string', 'Estado civil');
  dataTable.addColumn('string', 'Escolaridad');
  dataTable.addColumn('string', 'Departamento');
  dataTable.addColumn('string', 'PosiciÃ³n');
  dataTable.addColumn('string', 'Localidad');

  const safeRows = (rows || []).map(r => ([
    (r?.[0] != null ? String(r[0]).trim() : '(VacÃ­o)') || '(VacÃ­o)',
    (r?.[1] != null ? String(r[1]).trim() : '(VacÃ­o)') || '(VacÃ­o)',
    (r?.[2] != null ? String(r[2]).trim() : '(VacÃ­o)') || '(VacÃ­o)',
    (r?.[3] != null ? String(r[3]).trim() : '(VacÃ­o)') || '(VacÃ­o)',
    (r?.[4] != null ? String(r[4]).trim() : '(VacÃ­o)') || '(VacÃ­o)',
    fixLocalidad_(r?.[5]),
  ]));

  if (safeRows.length) dataTable.addRows(safeRows);
}

/******************************************************************
 * âœ… Charts
 ******************************************************************/
function requireEls_(ids){
  const missing = ids.filter(id => !el_(id));
  if (missing.length) throw new Error('Faltan contenedores en HTML: ' + missing.join(', '));
}

function buildCharts_(){
  requireEls_([
    'c_genero','c_estado','c_escolaridad','c_departamento','c_posicion','c_localidad',
    'filtersActive',
    ...FILTER_META.map(m => m.selectId)
  ]);

  charts.genero       = charts.genero       || new google.visualization.PieChart(el_('c_genero'));
  charts.estado       = charts.estado       || new google.visualization.PieChart(el_('c_estado'));
  charts.escolaridad  = charts.escolaridad  || new google.visualization.PieChart(el_('c_escolaridad'));
  charts.departamento = charts.departamento || new google.visualization.BarChart(el_('c_departamento'));
  charts.posicion     = charts.posicion     || new google.visualization.BarChart(el_('c_posicion'));
  charts.localidad    = charts.localidad    || new google.visualization.PieChart(el_('c_localidad'));

  if (!buildCharts_._wired) {
    wireChartToSelect_('genero', charts.genero, 'sel_genero');
    wireChartToSelect_('estado', charts.estado, 'sel_estado');
    wireChartToSelect_('escolaridad', charts.escolaridad, 'sel_escolaridad');
    wireChartToSelect_('departamento', charts.departamento, 'sel_departamento');
    wireChartToSelect_('posicion', charts.posicion, 'sel_posicion');
    wireChartToSelect_('localidad', charts.localidad, 'sel_localidad');
    buildCharts_._wired = true;
  }
}

/******************************************************************
 * âœ… MenÃºs desde payload (hoja Filtros) con default "Todos"
 ******************************************************************/
function uniqueFromData_(colIndex){
  const set = new Set();
  if (!dataTable) return [];
  for (let r=0; r<dataTable.getNumberOfRows(); r++){
    const v = dataTable.getValue(r, colIndex);
    set.add(String(v || '(VacÃ­o)').trim() || '(VacÃ­o)');
  }
  return Array.from(set);
}

function fillSelect_(selId, items, selected){
  const sel = el_(selId);
  sel.innerHTML = '';
  const list = (items || []).map(x => String(x).trim()).filter(Boolean);

  list.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });

  // âœ… Default: "Todos"
  const target =
    (selected && list.includes(selected)) ? selected :
    (list.includes('Todos') ? 'Todos' : (list[0] || 'Todos'));
  sel.value = target;
}

function buildDropdownsFromPayload_(payload){
  const f = payload.menus || payload.filters || {};

  MENUS.genero       = ensureTodos_(f.genero || uniqueFromData_(0));
  MENUS.estado       = ensureTodos_(f.estado || f['estado civil'] || uniqueFromData_(1));
  MENUS.escolaridad  = ensureTodos_(f.escolaridad || uniqueFromData_(2));
  MENUS.departamento = ensureTodos_(f.departamento || f.depto || uniqueFromData_(3));
  MENUS.posicion     = ensureTodos_(f.posicion || f.pos || uniqueFromData_(4));

  const rawLoc = (f.localidad || f.loc || uniqueFromData_(5));
  MENUS.localidad = ensureTodos_(uniqKeepOrder_((rawLoc || []).map(x => fixLocalidad_(x))));

  // âœ… Siempre arranca en Todos
  fillSelect_('sel_genero',       MENUS.genero,       'Todos');
  fillSelect_('sel_estado',       MENUS.estado,       'Todos');
  fillSelect_('sel_escolaridad',  MENUS.escolaridad,  'Todos');
  fillSelect_('sel_departamento', MENUS.departamento, 'Todos');
  fillSelect_('sel_posicion',     MENUS.posicion,     'Todos');
  fillSelect_('sel_localidad',    MENUS.localidad,    'Todos');

  FILTER_META.forEach(m => filterState[m.key] = el_(m.selectId).value || 'Todos');
}

/******************************************************************
 * âœ… Dibujo / filtros
 ******************************************************************/
function safeRedrawAll_(){
  try { redrawAll_(); }
  catch (err){
    console.error(err);
    setStatus_('bad', 'Error');
    showToast_('FallÃ³ al dibujar: ' + (err?.message || err));
  }
}

function applySelectFiltersToDataTable_(dt){
  const rows = [];
  for (let r=0; r<dt.getNumberOfRows(); r++) rows.push(r);

  let current = rows;
  FILTER_META.forEach(m => {
    const val = (filterState[m.key] || 'Todos').trim();
    if (!val || norm_(val) === 'todos') return;
    current = current.filter(r => dt.getValue(r, m.colIndex) === val);
  });

  const view = new google.visualization.DataView(dt);
  view.setRows(current);
  return view.toDataTable();
}

function groupCountSafe_(dt, colIndex, label, isBar=false){
  if (!dt || dt.getNumberOfRows() === 0) return null;

  const grouped = google.visualization.data.group(
    dt,
    [colIndex],
    [{ column: colIndex, type:'number', aggregation: google.visualization.data.count }]
  );

  grouped.setColumnLabel(0, label);
  grouped.setColumnLabel(1, 'Total');

  if (grouped.getNumberOfRows() === 0) return null;

  const sortedRows = grouped.getSortedRows({ column: 1, desc: true });
  const topRows = isBar ? sortedRows.slice(0, 15) : sortedRows;

  const view = new google.visualization.DataView(grouped);
  view.setRows(topRows);
  return view.toDataTable();
}

function addBarAnnotations_(dt){
  if (!dt || dt.getNumberOfRows() === 0) return dt;
  const view = new google.visualization.DataView(dt);
  view.setColumns([0, 1, { calc:'stringify', sourceColumn:1, type:'string', role:'annotation' }]);
  return view.toDataTable();
}

function baseChartOptions_(title){
  return {
    title,
    backgroundColor:'transparent',
    chartArea:{ left:14, top:42, right:14, bottom:12, width:'100%', height:'78%' },
    titleTextStyle:{ color:'#e8eefc', fontSize:14, bold:true },
    legend:{ textStyle:{ color:'#e8eefc', fontSize:12 } },
    pieSliceTextStyle:{ color:'#0b1220', fontSize:12 },
    pieSliceText:'both',
    tooltip:{ text:'both', textStyle:{ color:'#0b1220' } },
    hAxis:{ textStyle:{ color:'#e8eefc' }, gridlines:{ color:'rgba(255,255,255,.10)' } },
    vAxis:{ textStyle:{ color:'#e8eefc' }, gridlines:{ color:'rgba(255,255,255,.10)' } },
    animation:{ startup:true, duration:450, easing:'out' }
  };
}

function isDrawable_(dt){
  if (!dt) return false;
  if (dt.getNumberOfColumns() < 2) return false;
  if (dt.getNumberOfRows() <= 0) return false;
  let sum = 0;
  for (let i=0; i<dt.getNumberOfRows(); i++){
    const v = Number(dt.getValue(i, 1));
    if (!isNaN(v)) sum += v;
  }
  return sum > 0;
}

function drawChartSafe_(containerId, chart, dt, options, tall=false){
  const container = el_(containerId);
  if (!container || !chart) return;

  if (!isDrawable_(dt)) {
    container.innerHTML = `<div class="nodata ${tall ? 'tall' : ''}">Sin datos para mostrar</div>`;
    return;
  }

  if (container.querySelector('.nodata')) container.innerHTML = '';
  chart.draw(dt, options);
}

function updateFiltersActive_(){
  const pretty = {
    genero:'GÃ©nero',
    estado:'Estado civil',
    escolaridad:'Escolaridad',
    departamento:'Departamento',
    posicion:'PosiciÃ³n',
    localidad:'Localidad'
  };
  const parts = [];
  Object.keys(pretty).forEach(k => {
    const v = (filterState[k] || 'Todos').trim();
    if (v && norm_(v) !== 'todos') parts.push(`${pretty[k]}: ${v}`);
  });
  el_('filtersActive').textContent = parts.length ? parts.join(' Â· ') : 'Todos';
}

function redrawAll_(){
  if (!dataTable) return;

  const filtered = applySelectFiltersToDataTable_(dataTable);

  const dtGenero = groupCountSafe_(filtered, 0, 'GÃ©nero');
  const dtEstado = groupCountSafe_(filtered, 1, 'Estado civil');
  const dtEscol  = groupCountSafe_(filtered, 2, 'Escolaridad');
  const dtLoc    = groupCountSafe_(filtered, 5, 'Localidad');

  const dtDeptoBase = groupCountSafe_(filtered, 3, 'Departamento', true);
  const dtPosBase   = groupCountSafe_(filtered, 4, 'PosiciÃ³n', true);

  const dtDepto = addBarAnnotations_(dtDeptoBase);
  const dtPos   = addBarAnnotations_(dtPosBase);

  lastChartData.genero = dtGenero;
  lastChartData.estado = dtEstado;
  lastChartData.escolaridad = dtEscol;
  lastChartData.departamento = dtDepto;
  lastChartData.posicion = dtPos;
  lastChartData.localidad = dtLoc;

  drawChartSafe_('c_genero', charts.genero, dtGenero, baseChartOptions_('GÃ©nero'));
  drawChartSafe_('c_estado', charts.estado, dtEstado, baseChartOptions_('Estado civil'));
  drawChartSafe_('c_escolaridad', charts.escolaridad, dtEscol, baseChartOptions_('Escolaridad'));
  drawChartSafe_('c_localidad', charts.localidad, dtLoc, baseChartOptions_('Localidad'));

  drawChartSafe_(
    'c_departamento',
    charts.departamento,
    dtDepto,
    Object.assign(baseChartOptions_('Departamento'), {
      legend:{ position:'none' },
      bars:'horizontal',
      chartArea:{ left:120, top:42, right:22, bottom:12, width:'100%', height:'78%' },
      annotations:{ alwaysOutside:false, textStyle:{ color:'#e8eefc', fontSize:12, bold:true } }
    }),
    true
  );

  drawChartSafe_(
    'c_posicion',
    charts.posicion,
    dtPos,
    Object.assign(baseChartOptions_('PosiciÃ³n'), {
      legend:{ position:'none' },
      bars:'horizontal',
      chartArea:{ left:160, top:42, right:22, bottom:12, width:'100%', height:'78%' },
      annotations:{ alwaysOutside:false, textStyle:{ color:'#e8eefc', fontSize:12, bold:true } }
    }),
    true
  );

  updateFiltersActive_();
}

function wireChartToSelect_(key, chart, selectId){
  google.visualization.events.addListener(chart, 'select', () => {
    if (!uiReady_) return;
    const sel = chart.getSelection();
    if (!sel || !sel.length) return;

    const row = sel[0].row;
    if (row == null) return;

    const dt = lastChartData[key];
    if (!dt || dt.getNumberOfRows() === 0) return;

    const value = dt.getValue(row, 0);
    if (!value) return;

    const select = el_(selectId);
    const current = select.value;
    select.value = (current === value) ? 'Todos' : value;

    filterState[key] = select.value;
    safeRedrawAll_();
  });
}

/******************************************************************
 * âœ… Acciones
 ******************************************************************/
function refreshNow_(){
  const btn = el_('btnRefresh');
  btn.disabled = true;
  btn.innerHTML = '<span>âŸ³</span> Actualizandoâ€¦';

  setStatus_('warn', 'Actualizandoâ€¦');
  uiReady_ = false;

  const GAS_WEBAPP_URL = getGasUrl_();

  loadData_(GAS_WEBAPP_URL, { forceRefresh:true })
    .then(payload => {
      latestPayload = payload;

      if (payload?.error) {
        setStatus_('bad', 'Error');
        showToast_('Error desde GAS: ' + payload.error);
      }

      setHeader_(payload);
      buildDataTable_(payload.rows || []);

      FILTER_META.forEach(m => filterState[m.key] = 'Todos');
      buildDropdownsFromPayload_(payload);

      uiReady_ = true;
      safeRedrawAll_();
      showToast_('Datos actualizados desde "Maestro".');
      setStatus_('ok', 'OK');
    })
    .catch(err => {
      console.error(err);
      setStatus_('bad', 'Error');
      showToast_('Error al actualizar: ' + (err?.message || err));
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = '<span>âŸ³</span> Actualizar';
    });
}

function clearAllFilters_(){
  uiReady_ = false;
  FILTER_META.forEach(m => {
    filterState[m.key] = 'Todos';
    el_(m.selectId).value = 'Todos';
  });
  uiReady_ = true;
  safeRedrawAll_();
  showToast_('Filtros limpiados.');
}

function setHeader_(payload){
  const d = new Date(payload.updatedAt);
  const text = isNaN(d.getTime()) ? String(payload.updatedAt || 'â€”') : d.toLocaleString();

  el_('updatedAt').textContent = 'Actualizado: ' + text;
  el_('updatedAtBig').textContent = text;

  const n = payload.rows?.length || 0;
  el_('rowCount').textContent = `Â· Registros: ${n}`;
  el_('rowCountBig').textContent = String(n);

  el_('sheetName').textContent = 'Â· Hoja: ' + (payload.sheetName || payload.sheet || SHEET_NAME);
}
</script>
</body>
</html>
