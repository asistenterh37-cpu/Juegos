<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Headcount</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#0d1a30;
      --stroke:rgba(255,255,255,.10);
      --muted:rgba(232,238,252,.72);
      --text:#e8eefc;
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 18% 12%, rgba(37,99,235,.25), transparent 55%),
        radial-gradient(700px 450px at 85% 18%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 95%, rgba(244,63,94,.12), transparent 60%),
        var(--bg);
      min-height:100vh;
      padding:18px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:5;
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .dot{
      width:12px;height:12px;border-radius:99px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.25) 35%, rgba(255,255,255,.05) 60%), #2563eb;
      box-shadow: 0 0 0 4px rgba(37,99,235,.15);
    }
    .titleWrap .title{ font-size:15px; font-weight:800; letter-spacing:.2px; line-height:1.1; }
    .titleWrap .sub{
      font-size:12px; color:var(--muted); margin-top:2px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill{ border:1px solid var(--stroke); background:rgba(255,255,255,.03); padding:4px 10px; border-radius:999px; }
    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition: transform .08s ease, border-color .2s ease, opacity .2s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display:flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.24); }
    .btn:active{ transform: translateY(0px); opacity:.9; }
    .btn.primary{
      border-color: rgba(34,197,94,.35);
      background:linear-gradient(180deg, rgba(34,197,94,.28), rgba(34,197,94,.12));
    }
    .btn.ghost{ background: rgba(255,255,255,.03); box-shadow:none; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: repeat(3, minmax(240px, 1fr));
      gap:14px;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); } }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      body{ padding:12px; }
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .cardHeader{
      padding:12px 14px 8px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background:rgba(0,0,0,.10);
    }
    .cardHeader .h{ font-weight:900; font-size:13px; letter-spacing:.2px; margin:0; }
    .cardHeader .hint{ font-size:12px; color:var(--muted); margin-top:4px; }
    .cardBody{ padding:10px 12px 12px 12px; min-height: 280px; }
    .chart{ width:100%; height: 260px; }
    .chart.tall{ height: 290px; }
    .nodata{
      width:100%; height:260px;
      display:flex; align-items:center; justify-content:center;
      border:1px dashed rgba(255,255,255,.16);
      border-radius:14px;
      color:rgba(232,238,252,.75);
      background:rgba(0,0,0,.10);
      font-weight:800; letter-spacing:.2px;
    }
    .nodata.tall{ height:290px; }
    .kpis{ display:grid; grid-template-columns: 1fr; gap:10px; padding:12px 14px 14px 14px; }
    .kpiRow{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:14px;
      background:rgba(255,255,255,.03);
    }
    .kpiRow .k{ font-size:12px; color:var(--muted); font-weight:700;}
    .kpiRow .v{ font-size:13px; font-weight:900; }
    .status{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); font-weight:700; }
    .status .led{ width:9px;height:9px;border-radius:99px;background:var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.16); }
    .status.ok .led{ background:var(--good); box-shadow: 0 0 0 4px rgba(34,197,94,.16); }
    .status.bad .led{ background:var(--bad); box-shadow: 0 0 0 4px rgba(239,68,68,.16); }
    details.filters{ border:1px solid var(--stroke); border-radius:14px; background:rgba(255,255,255,.03); overflow:hidden; }
    details.filters summary{
      list-style:none; cursor:pointer;
      padding:10px 12px;
      font-weight:900; font-size:13px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    details.filters summary::-webkit-details-marker{display:none}
    .filtersBody{
      padding:10px 12px 12px 12px;
      border-top:1px solid var(--stroke);
      display:grid;
      grid-template-columns: repeat(2, minmax(180px, 1fr));
      gap:10px;
    }
    .filterBox{
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:8px 10px;
      background:rgba(0,0,0,.08);
    }
    .filterBox .lbl{ font-size:12px; color:var(--muted); font-weight:800; margin-bottom:6px; }
    .sel{
      width:100%;
      appearance:none;
      outline:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      font-size:13px;
    }
    .sel option{ color:#0b1220; }
    .selWrap{ position:relative; }
    .selWrap:after{
      content:"‚ñæ";
      position:absolute; right:12px; top:50%;
      transform:translateY(-50%);
      color:rgba(232,238,252,.75);
      pointer-events:none;
      font-weight:900;
    }
    .toast{
      position:fixed;
      right:16px; bottom:16px;
      background:rgba(15,27,51,.95);
      border:1px solid var(--stroke);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      font-size:12px;
      color:var(--text);
      display:none;
      max-width: 360px;
      z-index:9;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div class="titleWrap">
        <div class="title">Dashboard Headcount</div>
        <div class="sub">
          <span class="pill" id="updatedAt">Actualizado: ‚Äî</span>
          <span class="pill" id="rowCount">¬∑ Registros: ‚Äî</span>
          <span class="pill" id="sheetName">¬∑ Hoja: Maestro</span>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnRefresh" type="button"><span>‚ü≥</span> Actualizar</button>
      <button class="btn ghost" id="btnClear" type="button"><span>‚úï</span> Limpiar filtros</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="h">G√©nero</div>
          <div class="hint">Click en una categor√≠a para filtrar el resto.</div>
        </div>
      </div>
      <div class="cardBody"><div class="chart" id="c_genero"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">Estado civil</div><div class="hint">Frecuencia por categor√≠a.</div></div>
      </div>
      <div class="cardBody"><div class="chart" id="c_estado"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">Escolaridad</div><div class="hint">Frecuencia por categor√≠a.</div></div>
      </div>
      <div class="cardBody"><div class="chart" id="c_escolaridad"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">Departamento</div><div class="hint">Top 15 por frecuencia (si aplica).</div></div>
      </div>
      <div class="cardBody"><div class="chart tall" id="c_depto"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">Posici√≥n</div><div class="hint">Top 15 por frecuencia (si aplica).</div></div>
      </div>
      <div class="cardBody"><div class="chart tall" id="c_pos"></div></div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div><div class="h">Resumen</div><div class="hint">√öltima actualizaci√≥n + filtros avanzados.</div></div>
        <div class="status ok" id="statusBox">
          <span class="led"></span> <span id="statusText">OK</span>
        </div>
      </div>

      <div class="kpis">
        <div class="kpiRow">
          <div>
            <div class="k">√öltima actualizaci√≥n</div>
            <div class="v" id="updatedAtBig">‚Äî</div>
          </div>
          <div style="text-align:right">
            <div class="k">Registros</div>
            <div class="v" id="rowCountBig">‚Äî</div>
          </div>
        </div>

        <details class="filters" open>
          <summary><span>Filtros (dropdown)</span><span style="color:var(--muted); font-weight:800;">‚ñæ</span></summary>
          <div class="filtersBody">
            <div class="filterBox">
              <div class="lbl">G√©nero</div>
              <div class="selWrap"><select class="sel" id="sel_genero"></select></div>
            </div>
            <div class="filterBox">
              <div class="lbl">Estado civil</div>
              <div class="selWrap"><select class="sel" id="sel_estado"></select></div>
            </div>
            <div class="filterBox">
              <div class="lbl">Escolaridad</div>
              <div class="selWrap"><select class="sel" id="sel_escolaridad"></select></div>
            </div>
            <div class="filterBox">
              <div class="lbl">Departamento</div>
              <div class="selWrap"><select class="sel" id="sel_depto"></select></div>
            </div>
            <div class="filterBox" style="grid-column:1/-1">
              <div class="lbl">Posici√≥n</div>
              <div class="selWrap"><select class="sel" id="sel_pos"></select></div>
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ====== CONFIG: tu Web App /exec (Apps Script) ======
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwmQo_n7R8YXF9tHofhzR7aJhy14sneu3iwIG2SDABr9tdT3eOzpi3MU_aSVMQa_yvM/exec";
    const SHEET_NAME = "Maestro";

    // Charts
    google.charts.load('current', { packages: ['corechart'] });

    // Estado global
    let dataTable = null;
    const charts = {};
    const lastChartData = {};
    let latestPayload = null;
    let resizeTimer = null;
    let uiReady_ = false;

    // filtros UI
    const filterState = { genero: 'Todos', estado: 'Todos', escolaridad: 'Todos', depto: 'Todos', pos: 'Todos' };

    // Boot seguro: DOM + Charts
    let domReady = false;
    let chartsReady = false;

    document.addEventListener('DOMContentLoaded', () => {
      domReady = true;
      hookButtons_();
      hookSelects_();
      tryBoot_();
    });

    google.charts.setOnLoadCallback(() => {
      chartsReady = true;
      tryBoot_();
    });

    function tryBoot_(){
      if (!domReady || !chartsReady) return;
      requestAnimationFrame(() => init_());
    }

    function hookButtons_(){
      document.getElementById('btnRefresh').addEventListener('click', refreshNow_);
      document.getElementById('btnClear').addEventListener('click', clearAllFilters_);
    }

    function hookSelects_(){
      el_('sel_genero').addEventListener('change', () => { filterState.genero = el_('sel_genero').value; safeRedrawAll_(); });
      el_('sel_estado').addEventListener('change', () => { filterState.estado = el_('sel_estado').value; safeRedrawAll_(); });
      el_('sel_escolaridad').addEventListener('change', () => { filterState.escolaridad = el_('sel_escolaridad').value; safeRedrawAll_(); });
      el_('sel_depto').addEventListener('change', () => { filterState.depto = el_('sel_depto').value; safeRedrawAll_(); });
      el_('sel_pos').addEventListener('change', () => { filterState.pos = el_('sel_pos').value; safeRedrawAll_(); });
    }

    function el_(id){ return document.getElementById(id); }

    function requireEls_(ids){
      const missing = ids.filter(id => !el_(id));
      if (missing.length) throw new Error('Faltan contenedores en HTML: ' + missing.join(', '));
    }

    function init_() {
      setStatus_('warn', 'Cargando‚Ä¶');
      loadData_({ forceRefresh: false })
        .then(payload => {
          latestPayload = payload;

          if (!payload || typeof payload !== 'object') throw new Error('Payload inv√°lido (no es objeto).');
          if (payload?.error) {
            setStatus_('bad', 'Error');
            showToast_('Error desde GAS: ' + payload.error);
          }

          setHeader_(payload);
          buildDataTable_(payload.rows || []);
          buildCharts_();
          buildDropdownsFromPayload_(payload);

          uiReady_ = true;
          safeRedrawAll_();
          setStatus_('ok', 'OK');
          attachResize_();
        })
        .catch(err => {
          console.error(err);
          setStatus_('bad', 'Error');
          showToast_('No se pudo inicializar: ' + (err?.message || err));
          el_('updatedAt').textContent = 'Error: ' + (err?.message || err);
        });
    }

    // ‚úÖ JSONP SIEMPRE (GitHub Pages + Apps Script)
    function loadData_({ forceRefresh }) {
      const url = new URL(GAS_WEBAPP_URL);
      url.searchParams.set('sheet', SHEET_NAME);
      if (forceRefresh) url.searchParams.set('action', 'refresh');
      url.searchParams.set('_ts', Date.now().toString());
      return jsonpLoad_(url.toString());
    }

    function jsonpLoad_(url) {
      return new Promise((resolve, reject) => {
        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        const script = document.createElement('script');

        window[cbName] = (data) => {
          cleanup_();
          resolve(data);
        };

        script.onerror = () => {
          cleanup_();
          reject(new Error('No se pudo cargar JSONP desde /exec'));
        };

        function cleanup_() {
          try { delete window[cbName]; } catch(e) {}
          script.remove();
        }

        const u = new URL(url);
        u.searchParams.set('callback', cbName);
        script.src = u.toString();
        document.head.appendChild(script);
      });
    }

    function buildDataTable_(rows) {
      dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', 'G√©nero');
      dataTable.addColumn('string', 'Estado civil');
      dataTable.addColumn('string', 'Escolaridad');
      dataTable.addColumn('string', 'Departamento');
      dataTable.addColumn('string', 'Posici√≥n');

      const safeRows = (rows || []).map(r => ([
        (r?.[0] != null ? String(r[0]).trim() : '(Vac√≠o)') || '(Vac√≠o)',
        (r?.[1] != null ? String(r[1]).trim() : '(Vac√≠o)') || '(Vac√≠o)',
        (r?.[2] != null ? String(r[2]).trim() : '(Vac√≠o)') || '(Vac√≠o)',
        (r?.[3] != null ? String(r[3]).trim() : '(Vac√≠o)') || '(Vac√≠o)',
        (r?.[4] != null ? String(r[4]).trim() : '(Vac√≠o)') || '(Vac√≠o)',
      ]));

      if (safeRows.length) dataTable.addRows(safeRows);
    }

    function buildCharts_() {
      requireEls_(['c_genero','c_estado','c_escolaridad','c_depto','c_pos','sel_genero','sel_estado','sel_escolaridad','sel_depto','sel_pos']);

      charts.genero = charts.genero || new google.visualization.PieChart(el_('c_genero'));
      charts.estado = charts.estado || new google.visualization.PieChart(el_('c_estado'));
      charts.escolaridad = charts.escolaridad || new google.visualization.PieChart(el_('c_escolaridad'));
      charts.depto = charts.depto || new google.visualization.BarChart(el_('c_depto'));
      charts.pos = charts.pos || new google.visualization.BarChart(el_('c_pos'));

      if (!buildCharts_._wired) {
        wireChartToSelect_('genero', charts.genero, 'sel_genero');
        wireChartToSelect_('estado', charts.estado, 'sel_estado');
        wireChartToSelect_('escolaridad', charts.escolaridad, 'sel_escolaridad');
        wireChartToSelect_('depto', charts.depto, 'sel_depto');
        wireChartToSelect_('pos', charts.pos, 'sel_pos');
        buildCharts_._wired = true;
      }
    }

    function buildDropdownsFromPayload_(payload){
      // payload.filters viene desde GAS (hoja "Filtros"). fallback si no viene.
      const f = payload.filters || {};
      const genero = ensureTodos_(f.genero || uniqueFromData_(0));
      const estado = ensureTodos_(f.estado || uniqueFromData_(1));
      const escolaridad = ensureTodos_(f.escolaridad || uniqueFromData_(2));
      const depto = ensureTodos_(f.departamento || f.depto || uniqueFromData_(3));
      const pos = ensureTodos_(f.posicion || f.pos || uniqueFromData_(4));

      fillSelect_('sel_genero', genero, filterState.genero);
      fillSelect_('sel_estado', estado, filterState.estado);
      fillSelect_('sel_escolaridad', escolaridad, filterState.escolaridad);
      fillSelect_('sel_depto', depto, filterState.depto);
      fillSelect_('sel_pos', pos, filterState.pos);

      // si el valor actual no existe en lista, reset a Todos
      syncStateWithSelect_('genero','sel_genero');
      syncStateWithSelect_('estado','sel_estado');
      syncStateWithSelect_('escolaridad','sel_escolaridad');
      syncStateWithSelect_('depto','sel_depto');
      syncStateWithSelect_('pos','sel_pos');
    }

    function syncStateWithSelect_(key, selId){
      const s = el_(selId);
      const v = s.value;
      filterState[key] = v || 'Todos';
    }

    function ensureTodos_(arr){
      const a = (arr || []).map(x => String(x).trim()).filter(Boolean);
      if (!a.length) return ['Todos'];
      if (!a.some(x => x.toLowerCase() === 'todos')) return ['Todos', ...a];
      const rest = a.filter(x => x.toLowerCase() !== 'todos');
      return ['Todos', ...rest];
    }

    function uniqueFromData_(colIndex){
      const set = new Set();
      if (!dataTable) return [];
      for (let r=0; r<dataTable.getNumberOfRows(); r++){
        const v = dataTable.getValue(r, colIndex);
        set.add(String(v || '(Vac√≠o)').trim() || '(Vac√≠o)');
      }
      return Array.from(set);
    }

    function fillSelect_(selId, items, selected){
      const sel = el_(selId);
      sel.innerHTML = '';
      const list = (items || []).map(x => String(x).trim()).filter(Boolean);

      list.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });

      sel.value = list.includes(selected) ? selected : (list.includes('Todos') ? 'Todos' : (list[0] || 'Todos'));
    }

    // ‚úÖ Base options (con lo que pediste)
    // - Pies: mostrar % + frecuencia (valor) dentro del slice
    // - Barras: mostrar frecuencia (anotaci√≥n) dentro de la barra al final
    function baseChartOptions_(title) {
      return {
        title,
        backgroundColor: 'transparent',
        chartArea: { left: 14, top: 42, right: 14, bottom: 12, width: '100%', height: '78%' },
        titleTextStyle: { color: '#e8eefc', fontSize: 14, bold: true },
        legend: { textStyle: { color: '#e8eefc', fontSize: 12 } },
        pieSliceTextStyle: { color: '#0b1220', fontSize: 12 },

        // üëá PIE: % + frecuencia
        pieSliceText: 'both',
        tooltip: { text: 'both', textStyle: { color: '#0b1220' } },

        hAxis: { textStyle: { color: '#e8eefc' }, gridlines: { color: 'rgba(255,255,255,.10)' } },
        vAxis: { textStyle: { color: '#e8eefc' }, gridlines: { color: 'rgba(255,255,255,.10)' } },

        animation: { startup: true, duration: 450, easing: 'out' }
      };
    }

    // ‚úÖ helper para barras con anotaci√≥n (frecuencia) ‚Äúdentro de la barra al final‚Äù
    function addBarAnnotations_(dt){
      if (!dt || dt.getNumberOfRows() === 0) return dt;
      const view = new google.visualization.DataView(dt);
      view.setColumns([
        0,
        1,
        { calc: 'stringify', sourceColumn: 1, type: 'string', role: 'annotation' }
      ]);
      return view.toDataTable();
    }

    function safeRedrawAll_() {
      try { redrawAll_(); }
      catch (err) {
        console.error(err);
        setStatus_('bad', 'Error');
        showToast_('Fall√≥ al dibujar: ' + (err?.message || err));
      }
    }

    function redrawAll_() {
      if (!dataTable) return;

      const filtered = applySelectFiltersToDataTable_(dataTable);

      const dtGenero = groupCountSafe_(filtered, 0, 'G√©nero');
      const dtEstado = groupCountSafe_(filtered, 1, 'Estado civil');
      const dtEscol = groupCountSafe_(filtered, 2, 'Escolaridad');

      // Barras (Top 15)
      const dtDeptoBase = groupCountSafe_(filtered, 3, 'Departamento', true);
      const dtPosBase = groupCountSafe_(filtered, 4, 'Posici√≥n', true);

      // üëá aqu√≠ agregamos la anotaci√≥n de frecuencia para barras
      const dtDepto = addBarAnnotations_(dtDeptoBase);
      const dtPos   = addBarAnnotations_(dtPosBase);

      lastChartData.genero = dtGenero;
      lastChartData.estado = dtEstado;
      lastChartData.escolaridad = dtEscol;
      lastChartData.depto = dtDepto;   // (ya con anotaci√≥n)
      lastChartData.pos = dtPos;       // (ya con anotaci√≥n)

      // PIE
      drawChartSafe_('c_genero', charts.genero, dtGenero, baseChartOptions_('G√©nero'));
      drawChartSafe_('c_estado', charts.estado, dtEstado, baseChartOptions_('Estado civil'));
      drawChartSafe_('c_escolaridad', charts.escolaridad, dtEscol, baseChartOptions_('Escolaridad'));

      // BAR
      drawChartSafe_(
        'c_depto',
        charts.depto,
        dtDepto,
        Object.assign(baseChartOptions_('Departamento'), {
          legend: { position: 'none' },
          bars: 'horizontal',
          chartArea: { left: 120, top: 42, right: 22, bottom: 12, width: '100%', height: '78%' },

          // üëá anotaci√≥n dentro de la barra (al final)
          annotations: {
            alwaysOutside: false,
            textStyle: { color: '#e8eefc', fontSize: 12, bold: true }
          }
        }),
        true
      );

      drawChartSafe_(
        'c_pos',
        charts.pos,
        dtPos,
        Object.assign(baseChartOptions_('Posici√≥n'), {
          legend: { position: 'none' },
          bars: 'horizontal',
          chartArea: { left: 160, top: 42, right: 22, bottom: 12, width: '100%', height: '78%' },
          annotations: {
            alwaysOutside: false,
            textStyle: { color: '#e8eefc', fontSize: 12, bold: true }
          }
        }),
        true
      );
    }

    function drawChartSafe_(containerId, chart, dt, options, tall=false){
      const container = el_(containerId);
      if (!container || !chart) return;

      if (!isDrawable_(dt)) {
        container.innerHTML = `<div class="nodata ${tall ? 'tall' : ''}">Sin datos para mostrar</div>`;
        return;
      }

      if (container.querySelector('.nodata')) container.innerHTML = '';
      chart.draw(dt, options);
    }

    function isDrawable_(dt){
      if (!dt) return false;
      if (dt.getNumberOfColumns() < 2) return false;
      if (dt.getNumberOfRows() <= 0) return false;

      let sum = 0;
      for (let i = 0; i < dt.getNumberOfRows(); i++){
        const v = Number(dt.getValue(i, 1));
        if (!isNaN(v)) sum += v;
      }
      return sum > 0;
    }

    function applySelectFiltersToDataTable_(dt) {
      const rows = [];
      for (let r = 0; r < dt.getNumberOfRows(); r++) rows.push(r);

      const rules = [
        ['genero', 0],
        ['estado', 1],
        ['escolaridad', 2],
        ['depto', 3],
        ['pos', 4],
      ];

      let current = rows;
      rules.forEach(([key, col]) => {
        const val = (filterState[key] || 'Todos').trim();
        if (!val || val.toLowerCase() === 'todos') return;
        current = current.filter(r => dt.getValue(r, col) === val);
      });

      const view = new google.visualization.DataView(dt);
      view.setRows(current);
      return view.toDataTable();
    }

    function groupCountSafe_(dt, colIndex, label, isBar = false) {
      if (!dt || dt.getNumberOfRows() === 0) return null;

      const grouped = google.visualization.data.group(
        dt,
        [colIndex],
        [{ column: colIndex, type: 'number', aggregation: google.visualization.data.count }]
      );

      grouped.setColumnLabel(0, label);
      grouped.setColumnLabel(1, 'Total');

      if (grouped.getNumberOfRows() === 0) return null;

      const sortedRows = grouped.getSortedRows({ column: 1, desc: true });
      const topRows = (isBar ? sortedRows.slice(0, 15) : sortedRows);

      const view = new google.visualization.DataView(grouped);
      view.setRows(topRows);
      return view.toDataTable();
    }

    function wireChartToSelect_(key, chart, selectId) {
      google.visualization.events.addListener(chart, 'select', () => {
        if (!uiReady_) return;

        const sel = chart.getSelection();
        if (!sel || !sel.length) return;

        const row = sel[0].row;
        if (row == null) return;

        const dt = lastChartData[key];
        if (!dt || dt.getNumberOfRows() === 0) return;

        const value = dt.getValue(row, 0);
        if (!value) return;

        const select = el_(selectId);
        const current = select.value;

        // toggle: si ya est√°, vuelve a Todos
        select.value = (current === value) ? 'Todos' : value;

        if (key === 'genero') filterState.genero = select.value;
        if (key === 'estado') filterState.estado = select.value;
        if (key === 'escolaridad') filterState.escolaridad = select.value;
        if (key === 'depto') filterState.depto = select.value;
        if (key === 'pos') filterState.pos = select.value;

        safeRedrawAll_();
      });
    }

    function refreshNow_() {
      const btn = el_('btnRefresh');
      btn.disabled = true;
      btn.innerHTML = '<span>‚ü≥</span> Actualizando‚Ä¶';

      setStatus_('warn', 'Actualizando‚Ä¶');
      uiReady_ = false;

      loadData_({ forceRefresh: true })
        .then(payload => {
          latestPayload = payload;

          if (payload?.error) {
            setStatus_('bad', 'Error');
            showToast_('Error desde GAS: ' + payload.error);
          }

          setHeader_(payload);
          buildDataTable_(payload.rows || []);
          buildDropdownsFromPayload_(payload);

          uiReady_ = true;
          safeRedrawAll_();

          showToast_('Datos actualizados desde "Maestro".');
          setStatus_('ok', 'OK');
        })
        .catch(err => {
          console.error(err);
          setStatus_('bad', 'Error');
          showToast_('Error al actualizar: ' + (err?.message || err));
        })
        .finally(() => {
          btn.disabled = false;
          btn.innerHTML = '<span>‚ü≥</span> Actualizar';
        });
    }

    function clearAllFilters_() {
      uiReady_ = false;

      filterState.genero = 'Todos';
      filterState.estado = 'Todos';
      filterState.escolaridad = 'Todos';
      filterState.depto = 'Todos';
      filterState.pos = 'Todos';

      el_('sel_genero').value = 'Todos';
      el_('sel_estado').value = 'Todos';
      el_('sel_escolaridad').value = 'Todos';
      el_('sel_depto').value = 'Todos';
      el_('sel_pos').value = 'Todos';

      uiReady_ = true;
      safeRedrawAll_();
      showToast_('Filtros limpiados.');
    }

    function setHeader_(payload){
      const d = new Date(payload.updatedAt);
      const text = isNaN(d.getTime()) ? String(payload.updatedAt || '‚Äî') : d.toLocaleString();

      el_('updatedAt').textContent = 'Actualizado: ' + text;
      el_('updatedAtBig').textContent = text;

      const n = payload.rows?.length || 0;
      el_('rowCount').textContent = `¬∑ Registros: ${n}`;
      el_('rowCountBig').textContent = String(n);

      el_('sheetName').textContent = '¬∑ Hoja: ' + (payload.sheetName || payload.sheet || SHEET_NAME);
    }

    function setStatus_(mode, text){
      const box = el_('statusBox');
      const t = el_('statusText');

      box.classList.remove('ok','bad');
      if (mode === 'ok') box.classList.add('ok');
      if (mode === 'bad') box.classList.add('bad');

      t.textContent = text;
    }

    function showToast_(msg){
      const el = el_('toast');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(el._t);
      el._t = setTimeout(() => (el.style.display = 'none'), 2800);
    }

    function attachResize_(){
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => safeRedrawAll_(), 180);
      });
    }
  </script>
</body>
</html>
