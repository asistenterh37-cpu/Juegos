<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Space Invaders ‚Äî Por Soamy Lanza</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1733; --panel2:#0b132b; --ink:#e9eefc;
      --muted:#b6c2ffcc; --line:#2b3566; --good:#06d6a0; --bad:#ff6b6b; --accent:#4cc9f0;
      --btn:#18214a; --btn2:#24306a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 50% -100px, #1b2a6b 0%, var(--bg) 55%);
      color:var(--ink); overflow-x:hidden;
    }
    .wrap{max-width:980px;margin:18px auto;padding:0 14px 18px;display:grid;gap:12px;justify-items:center}
    header{
      width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      flex-wrap:wrap;
    }
    header h1{margin:0;font-size:16px;letter-spacing:.6px;font-weight:750;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    header h1 .chip{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:#0c1431}
    header h1 .by{font-size:12px;color:var(--muted)}
    .stats{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;font-size:13px;color:var(--muted)}
    .stats b{color:var(--ink)}
    .board{width:100%;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#060a16,#050815);box-shadow:0 12px 40px rgba(0,0,0,.35);position:relative}
    canvas{display:block;width:100%;height:auto;aspect-ratio:16/10;background:#050815}
    .hudline{width:100%;display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12.5px;padding:0 2px;flex-wrap:wrap}
    .kbd{padding:2px 6px;border:1px solid var(--line);border-radius:8px;background:#0d1636;color:var(--ink);font-size:12px;margin:0 3px;white-space:nowrap}

    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background:linear-gradient(180deg,rgba(5,8,21,.78),rgba(5,8,21,.92));backdrop-filter:blur(4px)}
    .card{width:min(700px,100%);border:1px solid var(--line);border-radius:18px;background:linear-gradient(180deg,rgba(15,23,51,.95),rgba(11,19,43,.92));box-shadow:0 20px 60px rgba(0,0,0,.45);padding:16px;text-align:left}
    .card h2{margin:0 0 6px;font-size:18px}
    .card p{margin:6px 0;color:var(--muted);line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media (max-width:620px){.grid{grid-template-columns:1fr} .stats{justify-content:flex-start}}
    .btn{
      appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,var(--btn2),var(--btn));
      color:var(--ink);border-radius:14px;padding:10px 12px;font-weight:800;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;user-select:none;box-shadow:0 10px 25px rgba(0,0,0,.25)
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:linear-gradient(180deg,#101a3f,#0c1431);color:var(--muted);font-weight:750}
    .tog{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:#0c1431;color:var(--muted);font-size:13px;margin-top:10px}
    .tog input{transform:scale(1.15)}
    .small{font-size:12px;color:var(--muted);margin-top:10px}
    .pill{
      display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:#0c1431;color:var(--muted);font-size:13px
    }
    select, input[type="text"]{
      background:#070d22;color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:10px 10px;font-weight:700;outline:none;
    }
    input[type="text"]{width:100%}
    .split{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
    @media (max-width:820px){.split{grid-template-columns:1fr}}
    .hsbox{
      border:1px solid var(--line);border-radius:16px;background:#0c1431;padding:12px
    }
    .hsbox h3{margin:0 0 8px;font-size:14px}
    .hslist{display:grid;gap:6px}
    .hsitem{
      display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid rgba(43,53,102,.65);
      border-radius:12px;background:rgba(7,13,34,.65);font-size:13px;color:var(--muted)
    }
    .hsitem b{color:var(--ink)}

    .touchbar{width:100%;display:none;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-top:8px}
    .touchbtn{
      border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,rgba(36,48,106,.85),rgba(24,33,74,.85));
      padding:14px 10px;font-weight:900;text-align:center;user-select:none;touch-action:manipulation;color:var(--ink)
    }
    .touchbtn:active{transform:translateY(1px)}
    .touchhint{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
    @media (pointer: coarse), (max-width: 820px){.touchbar{display:grid}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SPACE INVADERS <span class="chip">Web + GitHub Pages</span> <span class="by">Por <b>Soamy Lanza</b></span></h1>
      <div class="stats">
        <div>Score: <b id="uiScore">0</b></div>
        <div>Lives: <b id="uiLives">3</b></div>
        <div>Level: <b id="uiLevel">1</b></div>
        <div>Dificultad: <b id="uiDiff">Normal</b></div>
        <div>Best: <b id="uiBest">0</b></div>
      </div>
    </header>

    <div class="board">
      <canvas id="game" width="960" height="600"></canvas>

      <!-- MENU OVERLAY -->
      <div class="overlay" id="overlay">
        <div class="card">
          <h2 id="overlayTitle">üöÄ Space Invaders</h2>
          <p id="overlayText">Pixel art, UFO bonus, niveles y high scores. (Y s√≠, esto corre en GitHub Pages üòÑ)</p>

          <div class="split">
            <div>
              <div class="row" style="gap:12px">
                <span class="pill">üéöÔ∏è Dificultad
                  <select id="difficulty">
                    <option value="easy">Easy</option>
                    <option value="normal" selected>Normal</option>
                    <option value="hard">Hard</option>
                  </select>
                </span>
                <span class="pill">‚úçÔ∏è Tu nombre
                  <input id="playerName" type="text" maxlength="16" placeholder="Soamy" />
                </span>
              </div>

              <div class="tog">
                <div>üîä Sonidos</div>
                <label><input id="soundToggle" type="checkbox" checked /> Activados</label>
              </div>

              <div class="grid">
                <button class="btn" id="btnStart">‚ñ∂Ô∏è Iniciar</button>
                <button class="btn secondary" id="btnHow">üéÆ Controles</button>
                <button class="btn secondary" id="btnResetScores">üßΩ Reset High Scores</button>
                <button class="btn secondary" id="btnResume" style="display:none;">‚è∏Ô∏è Reanudar</button>
              </div>

              <div class="small" id="helpBox" style="display:none;">
                <div><b>PC:</b>
                  <span class="kbd">‚Üê</span><span class="kbd">‚Üí</span> mover ¬∑
                  <span class="kbd">Espacio</span> disparar ¬∑
                  <span class="kbd">P</span> pausa ¬∑
                  <span class="kbd">R</span> reiniciar
                </div>
                <div style="margin-top:6px"><b>M√≥vil:</b> usa los botones t√°ctiles debajo del juego.</div>
              </div>

              <div class="small">Hecho con Canvas. Sin im√°genes externas. 100% vibes retro. ‚ú®</div>
            </div>

            <div class="hsbox">
              <h3>üèÖ High Scores</h3>
              <div class="hslist" id="hsList"></div>
              <div class="small" style="margin-top:10px">Tip: si pones tu nombre, quedas inmortal (en localStorage).</div>
              <div class="small">Firma: <b>Por Soamy Lanza</b></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="hudline">
      <div>
        PC: <span class="kbd">‚Üê</span><span class="kbd">‚Üí</span> mover ¬∑ <span class="kbd">Espacio</span> disparar ¬∑ <span class="kbd">P</span> pausa ¬∑ <span class="kbd">R</span> reiniciar
      </div>
      <div id="uiMsg"></div>
    </div>

    <!-- Touch controls -->
    <div class="touchbar" id="touchbar">
      <div class="touchbtn" data-act="left">‚¨ÖÔ∏è IZQ</div>
      <div class="touchbtn" data-act="right">‚û°Ô∏è DER</div>
      <div class="touchbtn" data-act="shoot">üí• DISPARO</div>
      <div class="touchbtn" data-act="pause">‚è∏Ô∏è PAUSA</div>
    </div>
    <div class="touchhint">Tip m√≥vil: mant√©n presionado IZQ/DER para moverte continuo.</div>
  </div>

<script>
(() => {
  // ---------- Canvas ----------
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  // UI
  const uiScore = document.getElementById("uiScore");
  const uiLives = document.getElementById("uiLives");
  const uiLevel = document.getElementById("uiLevel");
  const uiDiff  = document.getElementById("uiDiff");
  const uiBest  = document.getElementById("uiBest");
  const uiMsg   = document.getElementById("uiMsg");

  // Overlay/menu
  const overlay = document.getElementById("overlay");
  const overlayTitle = document.getElementById("overlayTitle");
  const overlayText  = document.getElementById("overlayText");
  const btnStart = document.getElementById("btnStart");
  const btnHow = document.getElementById("btnHow");
  const btnResetScores = document.getElementById("btnResetScores");
  const btnResume = document.getElementById("btnResume");
  const helpBox = document.getElementById("helpBox");
  const soundToggle = document.getElementById("soundToggle");
  const difficultySel = document.getElementById("difficulty");
  const nameInput = document.getElementById("playerName");
  const hsList = document.getElementById("hsList");

  // Touch
  const touchbar = document.getElementById("touchbar");

  // ---------- Helpers ----------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd = (a,b)=>a+Math.random()*(b-a);
  const rectsOverlap = (a,b)=> a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;

  // ---------- Difficulty Profiles ----------
  const DIFFS = {
    easy:   { label:"Easy",   lives:4, enemySpeed:0.90, enemyFire:1.25, bulletSpeed:0.90, ufoSpeed:0.90, shieldHp:16 },
    normal: { label:"Normal", lives:3, enemySpeed:1.00, enemyFire:1.00, bulletSpeed:1.00, ufoSpeed:1.00, shieldHp:14 },
    hard:   { label:"Hard",   lives:2, enemySpeed:1.15, enemyFire:0.78, bulletSpeed:1.08, ufoSpeed:1.10, shieldHp:12 },
  };

  // ---------- High Scores ----------
  const HS_KEY = "si_hs_v2";
  function loadHS(){
    try{
      const raw = localStorage.getItem(HS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveHS(arr){
    localStorage.setItem(HS_KEY, JSON.stringify(arr.slice(0,5)));
  }
  function renderHS(){
    const arr = loadHS();
    hsList.innerHTML = "";
    if (!arr.length){
      hsList.innerHTML = `<div class="hsitem"><span>‚Äî</span><span>Sin scores a√∫n</span></div>`;
      return;
    }
    arr.slice(0,5).forEach((it, i)=>{
      const name = (it.name || "Anon").slice(0,16);
      hsList.insertAdjacentHTML("beforeend",
        `<div class="hsitem"><span>#${i+1} <b>${escapeHtml(name)}</b></span><span><b>${it.score}</b> ¬∑ Lv ${it.level} ¬∑ ${it.diff}</span></div>`
      );
    });
  }
  function addToHS({name, score, level, diff}){
    const arr = loadHS();
    arr.push({ name, score, level, diff, t: Date.now() });
    arr.sort((a,b)=> (b.score - a.score) || (b.level - a.level) || (a.t - b.t));
    saveHS(arr);
    renderHS();
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // ---------- Simple Audio (no files needed) ----------
  let audioCtx = null;
  let soundOn = true;
  function ensureAudio(){
    if (!audioCtx){
      const AC = window.AudioContext || window.webkitAudioContext;
      if (AC) audioCtx = new AC();
    }
    if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }
  function beep(freq=440, dur=0.06, type="square", gain=0.045){
    if (!soundOn) return;
    ensureAudio();
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    g.gain.setValueAtTime(gain, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
    o.start(t); o.stop(t + dur + 0.02);
  }
  const sfx = {
    shoot: ()=>beep(760, 0.05, "square", 0.05),
    hit:   ()=>beep(220, 0.06, "sawtooth", 0.06),
    enemyShoot: ()=>beep(420, 0.05, "triangle", 0.045),
    ufo:   ()=>{ beep(880,0.06,"square",0.04); setTimeout(()=>beep(660,0.06,"square",0.04),60); },
    level: ()=>{ beep(523,0.08,"triangle",0.05); setTimeout(()=>beep(784,0.10,"triangle",0.05),90); },
    lose:  ()=>{ beep(196,0.12,"sawtooth",0.055); setTimeout(()=>beep(147,0.14,"sawtooth",0.055),130); },
    win:   ()=>{ beep(659,0.09,"triangle",0.05); setTimeout(()=>beep(784,0.10,"triangle",0.05),110); setTimeout(()=>beep(988,0.12,"triangle",0.05),240); }
  };

  // ---------- Game State ----------
  const state = {
    running: false, paused: false, gameOver: false, win:false,
    score: 0, lives: 3, level: 1,
    lastTime: 0,
    stars: [],
    shake: 0,
    diffKey: "normal",
    playerName: "Soamy",
  };

  // Starfield
  function initStars(){
    state.stars = [];
    for (let i=0;i<90;i++){
      state.stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.8+0.3, v: Math.random()*26+12 });
    }
  }
  initStars();

  // ---------- Pixel Art Sprites (drawn with Canvas) ----------
  function drawPixelSprite(x, y, scale, pixels, palette){
    // pixels: array of strings, each char = palette index or '.' for transparent
    for (let r=0;r<pixels.length;r++){
      const row = pixels[r];
      for (let c=0;c<row.length;c++){
        const ch = row[c];
        if (ch === ".") continue;
        const col = palette[ch] || "#fff";
        ctx.fillStyle = col;
        ctx.fillRect(x + c*scale, y + r*scale, scale, scale);
      }
    }
  }

  // Sprites (very simple retro)
  const SPR = {
    player: [
      "..1111..",
      ".111111.",
      "11111111",
      "11.11.11",
      "11111111",
      "..1..1..",
    ],
    enemyA: [
      "..22..",
      ".2222.",
      "222222",
      "22..22",
      ".2..2.",
    ],
    enemyB: [
      ".3333.",
      "33..33",
      "333333",
      ".3..3.",
      "3....3",
    ],
    ufo: [
      "..444444..",
      ".44444444.",
      "4444444444",
      ".44.44.44.",
      "..444444..",
    ],
    bulletP: ["5","5","5"],
    bulletE: ["6","6","6","6"],
    shield: [
      "..777777..",
      ".77777777.",
      "7777777777",
      "7777..7777",
      "777....777",
    ]
  };
  const PAL = {
    "1":"#b7ffda",
    "2":"#ff6b6b",
    "3":"#ffd166",
    "4":"#4cc9f0",
    "5":"#ffffff",
    "6":"#ff9bd2",
    "7":"#06d6a0",
  };

  // Player
  const player = {
    w: 64, h: 18,
    x: canvas.width/2 - 32,
    y: canvas.height - 54,
    speed: 420,
    cooldown: 0,
    invuln: 0,
  };

  // Bullets
  const bullets = []; // {x,y,w,h,vy,from,pxScale,spriteKey}

  function shootPlayer(){
    if (!state.running || state.paused || state.gameOver) return;
    if (player.cooldown > 0) return;
    const prof = DIFFS[state.diffKey];
    bullets.push({
      x: player.x + player.w/2 - 3,
      y: player.y - 14,
      w: 6, h: 12,
      vy: -620 * prof.bulletSpeed,
      from: "player",
      pxScale: 3,
      spriteKey: "bulletP",
    });
    player.cooldown = 0.18;
    sfx.shoot();
  }

  // Enemies (grid)
  const enemy = {
    cols: 10, rows: 5,
    w: 40, h: 28,
    padX: 16, padY: 14,
    offsetX: 140, offsetY: 110,
    dir: 1,
    baseSpeed: 48,
    drop: 22,
    shootTimer: 0.9,
  };
  let enemies = [];

  // Shields
  let shields = [];

  // UFO
  const ufo = {
    active:false,
    x:-120, y:70,
    w:78, h:26,
    vx:190,
    timer:7.0, nextMin:7.0, nextMax:14.0
  };

  function resetUFOCountdown(){
    ufo.timer = rnd(ufo.nextMin, ufo.nextMax);
    ufo.active = false;
    ufo.x = -ufo.w - 20;
  }

  function spawnShields(){
    shields = [];
    const prof = DIFFS[state.diffKey];
    const count = 4;
    const y = canvas.height - 160;
    const spacing = canvas.width/(count+1);
    for (let i=1;i<=count;i++){
      shields.push({
        x: spacing*i - 55, y,
        w: 110, h: 40,
        hp: prof.shieldHp,
        maxHp: prof.shieldHp
      });
    }
  }

  function spawnEnemies(){
    enemies = [];
    const totalW = enemy.cols*enemy.w + (enemy.cols-1)*enemy.padX;
    enemy.offsetX = (canvas.width - totalW)/2;
    for (let r=0;r<enemy.rows;r++){
      for (let c=0;c<enemy.cols;c++){
        enemies.push({
          x: enemy.offsetX + c*(enemy.w+enemy.padX),
          y: enemy.offsetY + r*(enemy.h+enemy.padY),
          w: enemy.w, h: enemy.h,
          alive:true,
          row:r,
          sprite: (r%2===0) ? "enemyA" : "enemyB"
        });
      }
    }
    enemy.dir = 1;
    const prof = DIFFS[state.diffKey];
    enemy.baseSpeed = (48 + (state.level-1)*14) * prof.enemySpeed;
    enemy.drop = (20 + Math.min(10,(state.level-1)*2));
    enemy.shootTimer = rnd(0.4, 0.9) * prof.enemyFire;
  }

  function enemyAliveList(){ return enemies.filter(e=>e.alive); }

  function enemyShoot(){
    const alive = enemyAliveList();
    if (!alive.length) return;

    const byCol = new Map();
    for (const e of alive){
      const col = Math.round((e.x - enemy.offsetX) / (enemy.w + enemy.padX));
      const cur = byCol.get(col);
      if (!cur || e.y > cur.y) byCol.set(col, e);
    }
    const candidates = Array.from(byCol.values());
    if (!candidates.length) return;

    const shooter = candidates[(Math.random()*candidates.length)|0];
    const prof = DIFFS[state.diffKey];
    bullets.push({
      x: shooter.x + shooter.w/2 - 3,
      y: shooter.y + shooter.h + 6,
      w: 6, h: 12,
      vy: (380 + (state.level-1)*22) * prof.bulletSpeed,
      from: "enemy",
      pxScale: 3,
      spriteKey: "bulletE",
    });
    sfx.enemyShoot();
  }

  function addScore(n){
    state.score += n;
    updateUI();
  }

  function updateUI(){
    uiScore.textContent = state.score;
    uiLives.textContent = state.lives;
    uiLevel.textContent = state.level;
    uiDiff.textContent = DIFFS[state.diffKey].label;
    // best from high score list top
    const hs = loadHS();
    uiBest.textContent = (hs[0]?.score ?? 0);
  }

  function showOverlay(){ overlay.style.display = "flex"; }
  function hideOverlay(){ overlay.style.display = "none"; helpBox.style.display="none"; }

  function startNewGame(){
    state.running = true;
    state.paused = false;
    state.gameOver = false;
    state.win = false;
    state.score = 0;
    state.level = 1;

    state.diffKey = difficultySel.value || "normal";
    state.playerName = (nameInput.value || "Soamy").trim().slice(0,16) || "Soamy";

    const prof = DIFFS[state.diffKey];
    state.lives = prof.lives;

    bullets.length = 0;
    player.x = canvas.width/2 - player.w/2;
    player.cooldown = 0;
    player.invuln = 0.8;

    initStars();
    spawnShields();
    spawnEnemies();
    resetUFOCountdown();

    uiMsg.textContent = "¬°A jugar! (Por Soamy Lanza)";
    updateUI();
    hideOverlay();
  }

  function nextLevel(){
    state.level += 1;
    bullets.length = 0;
    player.cooldown = 0;
    player.invuln = Math.max(player.invuln, 0.8);

    // restore a bit of shields
    for (const sh of shields){
      sh.hp = Math.min(sh.maxHp, sh.hp + 2);
    }

    spawnEnemies();
    resetUFOCountdown();
    uiMsg.textContent = `üî• Nivel ${state.level}`;
    sfx.level();
    updateUI();
  }

  function endGame(win){
    state.gameOver = true;
    state.running = false;
    state.paused = false;
    state.win = win;

    // Save to High Scores
    addToHS({
      name: state.playerName || "Soamy",
      score: state.score,
      level: state.level,
      diff: DIFFS[state.diffKey].label
    });
    updateUI();

    overlayTitle.textContent = win ? "üèÜ ¬°Ronda completada!" : "üí• Game Over";
    overlayText.textContent = win
      ? `Subiste a nivel ${state.level + 1}. ¬øList@ para m√°s velocidad?`
      : `Tu score fue ${state.score}. Firma: Por Soamy Lanza üòÑ`;

    btnStart.textContent = win ? "‚û°Ô∏è Siguiente nivel" : "üîÑ Reiniciar";
    btnStart.style.display = "flex";
    btnResume.style.display = "none";
    showOverlay();
    if (win) sfx.win(); else sfx.lose();
  }

  // ---------- Input ----------
  const keys = new Set();
  const input = { left:false, right:false };

  window.addEventListener("keydown", (e)=>{
    if (e.code === "Space") e.preventDefault();
    keys.add(e.code);
    if (e.code === "Space") shootPlayer();
    if (e.code === "KeyP"){
      if (!state.gameOver && state.running){
        state.paused = !state.paused;
        uiMsg.textContent = state.paused ? "‚è∏ Pausa" : "";
        if (state.paused){
          overlayTitle.textContent = "‚è∏ Pausa";
          overlayText.textContent = "Volviste. Toca Reanudar.";
          btnStart.style.display = "none";
          btnResume.style.display = "flex";
          showOverlay();
        } else {
          hideOverlay();
          btnStart.style.display = "flex";
        }
      }
    }
    if (e.code === "KeyR"){ if (state.gameOver) startNewGame(); }
    ensureAudio();
  });
  window.addEventListener("keyup", (e)=>keys.delete(e.code));

  function bindTouchButtons(){
    if (!touchbar) return;
    const map = {
      left:  (down)=> input.left = down,
      right: (down)=> input.right = down,
      shoot: (down)=> { if (down) shootPlayer(); },
      pause: (down)=> {
        if (!down) return;
        if (state.running && !state.gameOver){
          state.paused = !state.paused;
          uiMsg.textContent = state.paused ? "‚è∏ Pausa" : "";
          if (state.paused){
            overlayTitle.textContent = "‚è∏ Pausa";
            overlayText.textContent = "Toca Reanudar o presiona P.";
            btnStart.style.display = "none";
            btnResume.style.display = "flex";
            showOverlay();
          } else {
            hideOverlay();
            btnStart.style.display = "flex";
          }
        }
      }
    };
    function addPressHandlers(el, fn){
      const on = (ev)=>{ ev.preventDefault(); ensureAudio(); fn(true); };
      const off = (ev)=>{ ev.preventDefault(); fn(false); };
      el.addEventListener("pointerdown", on);
      el.addEventListener("pointerup", off);
      el.addEventListener("pointercancel", off);
      el.addEventListener("pointerleave", off);
    }
    touchbar.querySelectorAll(".touchbtn").forEach(btn=>{
      const act = btn.getAttribute("data-act");
      const fn = map[act];
      if (fn) addPressHandlers(btn, fn);
    });
  }
  bindTouchButtons();

  // Menu buttons
  btnStart.addEventListener("click", ()=>{
    ensureAudio();
    soundOn = !!soundToggle.checked;
    state.diffKey = difficultySel.value || "normal";

    if (!state.gameOver && !state.running){
      startNewGame();
      return;
    }
    if (state.gameOver && state.win){
      state.running = true;
      state.gameOver = false;
      state.paused = false;
      hideOverlay();
      nextLevel();
      return;
    }
    startNewGame();
  });
  btnHow.addEventListener("click", ()=>{
    ensureAudio();
    helpBox.style.display = (helpBox.style.display === "none") ? "block" : "none";
  });
  btnResetScores.addEventListener("click", ()=>{
    ensureAudio();
    localStorage.removeItem(HS_KEY);
    renderHS();
    updateUI();
    uiMsg.textContent = "High Scores reseteados.";
  });
  btnResume.addEventListener("click", ()=>{
    ensureAudio();
    soundOn = !!soundToggle.checked;
    if (state.running && !state.gameOver){
      state.paused = false;
      uiMsg.textContent = "";
      btnStart.style.display = "flex";
      btnResume.style.display = "none";
      hideOverlay();
    }
  });
  soundToggle.addEventListener("change", ()=>{ soundOn = !!soundToggle.checked; ensureAudio(); });

  canvas.addEventListener("pointerdown", ()=>{
    ensureAudio();
    if (state.running && !state.paused && !state.gameOver) shootPlayer();
  });

  // ---------- Game Logic ----------
  function loseLife(){
    state.lives -= 1;
    state.shake = 0.25;
    player.invuln = 1.2;
    updateUI();
    if (state.lives <= 0) endGame(false);
  }

  function update(dt){
    // Stars
    for (const s of state.stars){
      s.y += s.v * dt;
      if (s.y > canvas.height+10){ s.y = -10; s.x = Math.random()*canvas.width; s.v = rnd(14,44); s.r = rnd(0.4,2.2); }
    }
    if (!state.running || state.paused || state.gameOver) return;

    const left = input.left || keys.has("ArrowLeft") || keys.has("KeyA");
    const right= input.right|| keys.has("ArrowRight")|| keys.has("KeyD");
    const dir = (right?1:0) - (left?1:0);

    player.x += dir * player.speed * dt;
    player.x = clamp(player.x, 10, canvas.width - player.w - 10);

    player.cooldown = Math.max(0, player.cooldown - dt);
    player.invuln = Math.max(0, player.invuln - dt);

    // UFO spawn/move
    const prof = DIFFS[state.diffKey];
    if (!ufo.active){
      ufo.timer -= dt;
      if (ufo.timer <= 0){
        ufo.active = true;
        ufo.y = 70;
        const fromLeft = Math.random() < 0.5;
        ufo.x = fromLeft ? -ufo.w-10 : canvas.width + 10;
        ufo.vx = (fromLeft ? 1 : -1) * (190 + (state.level-1)*20) * prof.ufoSpeed;
      }
    } else {
      ufo.x += ufo.vx * dt;
      if (ufo.x < -ufo.w-60 || ufo.x > canvas.width + 60) resetUFOCountdown();
    }

    // Enemies move
    const alive = enemyAliveList();
    if (!alive.length){
      state.running = false;
      state.gameOver = true;
      state.win = true;
      endGame(true);
      return;
    }

    const aliveRatio = alive.length / (enemy.cols * enemy.rows);
    const ramp = (1 - aliveRatio) * (130 + (state.level-1)*30) * prof.enemySpeed;
    const vx = (enemy.baseSpeed + ramp) * enemy.dir;

    let minX = Infinity, maxX = -Infinity, maxY = -Infinity;
    for (const e of alive){
      e.x += vx * dt;
      minX = Math.min(minX, e.x);
      maxX = Math.max(maxX, e.x + e.w);
      maxY = Math.max(maxY, e.y + e.h);
    }
    if (minX <= 14 || maxX >= canvas.width - 14){
      enemy.dir *= -1;
      for (const e of alive) e.y += enemy.drop;
      state.shake = 0.08;
      beep(160 + state.level*10, 0.03, "square", 0.03);
    }

    if (maxY >= player.y - 6){
      endGame(false);
      return;
    }

    // Shooting
    enemy.shootTimer -= dt;
    if (enemy.shootTimer <= 0){
      // smaller timer -> more frequent. Use diff profile to make it nastier on hard
      const base = clamp(0.9 - (state.level-1)*0.06, 0.35, 0.9) * prof.enemyFire;
      enemy.shootTimer = rnd(Math.max(0.22, base-0.18), base+0.22);
      enemyShoot();
    }

    // Bullets
    for (let i = bullets.length - 1; i >= 0; i--){
      const b = bullets[i];
      b.y += b.vy * dt;

      if (b.y < -80 || b.y > canvas.height + 80){
        bullets.splice(i,1);
        continue;
      }

      // shields
      for (let s = shields.length - 1; s >= 0; s--){
        const sh = shields[s];
        if (rectsOverlap(b, sh)){
          bullets.splice(i,1);
          sh.hp -= 1;
          if (sh.hp <= 0) shields.splice(s,1);
          state.shake = 0.05;
          beep(280, 0.03, "triangle", 0.03);
          break;
        }
      }
      if (!bullets[i]) continue;

      if (b.from === "player"){
        // UFO
        if (ufo.active && rectsOverlap(b, ufo)){
          bullets.splice(i,1);
          ufo.active = false;
          resetUFOCountdown();
          const bonus = (Math.random() < 0.5) ? 100 : 150;
          addScore(bonus);
          state.shake = 0.12;
          sfx.ufo();
          continue;
        }
        // enemy
        for (const e of enemies){
          if (!e.alive) continue;
          if (rectsOverlap(b, e)){
            e.alive = false;
            bullets.splice(i,1);
            state.shake = 0.08;
            sfx.hit();
            // points based on row + difficulty + level
            const base = 10 + (enemy.rows - e.row) * 2;
            const diffMult = (state.diffKey==="easy") ? 0.95 : (state.diffKey==="hard") ? 1.15 : 1.0;
            addScore(Math.round((base + state.level*2) * diffMult));
            break;
          }
        }
      } else {
        // hits player
        if (player.invuln <= 0 && rectsOverlap(b, player)){
          bullets.splice(i,1);
          sfx.hit();
          loseLife();
          continue;
        }
      }
    }
  }

  // ---------- Drawing ----------
  function draw(){
    // shake
    let shakeX=0, shakeY=0;
    if (state.shake > 0){
      state.shake = Math.max(0, state.shake - 1/60);
      shakeX = (Math.random()*2-1) * 6 * state.shake;
      shakeY = (Math.random()*2-1) * 6 * state.shake;
    }

    ctx.save();
    ctx.translate(shakeX, shakeY);
    ctx.clearRect(-30,-30,canvas.width+60,canvas.height+60);

    // stars
    ctx.fillStyle = "#fff";
    for (const s of state.stars){
      ctx.globalAlpha = clamp((s.r/2.5), 0.2, 0.9);
      ctx.fillRect(s.x, s.y, s.r, s.r);
    }
    ctx.globalAlpha = 1;

    // top glow
    const g = ctx.createLinearGradient(0,0,0,140);
    g.addColorStop(0,"rgba(76,201,240,0.18)");
    g.addColorStop(1,"rgba(76,201,240,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,canvas.width,160);

    // UFO sprite
    if (ufo.active){
      drawPixelSprite(ufo.x, ufo.y, 2, SPR.ufo, PAL);
      // label
      ctx.globalAlpha = 0.8;
      ctx.fillStyle = "#4cc9f0";
      ctx.font = "12px system-ui, Arial";
      ctx.fillText("UFO BONUS", ufo.x, ufo.y - 6);
      ctx.globalAlpha = 1;
    }

    // Shields sprite + hp bar
    for (const sh of shields){
      const ratio = sh.hp / sh.maxHp;
      ctx.globalAlpha = 0.9;
      drawPixelSprite(sh.x+10, sh.y+6, 2, SPR.shield, PAL);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "rgba(255,255,255,0.65)";
      ctx.fillRect(sh.x, sh.y+sh.h+6, sh.w*ratio, 4);
    }

    // Player sprite (blink on invuln)
    const blink = player.invuln>0 ? (Math.floor(performance.now()/80)%2===0) : true;
    if (blink){
      // center sprite in player box
      drawPixelSprite(player.x + 14, player.y - 10, 3, SPR.player, PAL);
    }

    // Enemies sprite
    for (const e of enemies){
      if (!e.alive) continue;
      const sprite = (e.sprite==="enemyA") ? SPR.enemyA : SPR.enemyB;
      // fit by scale=3
      drawPixelSprite(e.x + 4, e.y + 4, 3, sprite, PAL);
    }

    // Bullets sprite
    for (const b of bullets){
      const spr = (b.spriteKey==="bulletP") ? SPR.bulletP : SPR.bulletE;
      drawPixelSprite(b.x, b.y, b.pxScale, spr, PAL);
    }

    // vignette
    const v = ctx.createLinearGradient(0, canvas.height-140, 0, canvas.height);
    v.addColorStop(0,"rgba(0,0,0,0)");
    v.addColorStop(1,"rgba(0,0,0,0.35)");
    ctx.fillStyle = v;
    ctx.fillRect(0, canvas.height-140, canvas.width, 140);

    // HUD text in canvas
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.font = "16px system-ui, Arial";
    ctx.fillText(`Score ${state.score} ‚Ä¢ Lives ${state.lives} ‚Ä¢ Level ${state.level} ‚Ä¢ ${DIFFS[state.diffKey].label} ‚Ä¢ Por Soamy Lanza`, 14, 26);

    if (state.paused && state.running){
      ctx.fillStyle = "rgba(255,255,255,0.95)";
      ctx.font = "28px system-ui, Arial";
      ctx.fillText("PAUSA", canvas.width/2 - 45, canvas.height/2);
      ctx.font = "16px system-ui, Arial";
      ctx.fillText("Presiona P o el bot√≥n PAUSA", canvas.width/2 - 128, canvas.height/2 + 26);
    }

    ctx.restore();
  }

  // ---------- Main Loop ----------
  function loop(t){
    const time = t/1000;
    const dt = Math.min(0.033, time - (state.lastTime||time));
    state.lastTime = time;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ---------- Init menu ----------
  renderHS();
  updateUI();
  showOverlay();
  nameInput.value = "Soamy";
  uiMsg.textContent = "Listo. Solo dale Iniciar.";

  // Auto pause if tab hidden
  document.addEventListener("visibilitychange", ()=>{
    if (document.hidden && state.running && !state.gameOver){
      state.paused = true;
      uiMsg.textContent = "‚è∏ Pausa (cambiaste de pesta√±a)";
      overlayTitle.textContent = "‚è∏ Pausa";
      overlayText.textContent = "Volviste. Toca Reanudar.";
      btnStart.style.display = "none";
      btnResume.style.display = "flex";
      showOverlay();
    }
  });
})();
</script>
</body>
</html>
