<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diagn√≥stico Organizacional - Escala Likert (20 √≠tems)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:#233049;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#60a5fa;
      --chip:#0f172a;
      --shadow: 0 12px 35px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 12px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1000px 600px at 15% -10%, rgba(34,197,94,.18), transparent 55%),
                  radial-gradient(900px 500px at 110% 10%, rgba(96,165,250,.16), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:28px 16px 12px;
      max-width:1100px;
      margin:0 auto;
    }
    .title{
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
      flex-wrap:wrap;
    }
    h1{
      margin:0 0 8px;
      font-size: clamp(20px, 2.4vw, 30px);
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      line-height:1.45;
      max-width: 900px;
    }
    .brand{
      color:var(--muted);
      font-size:13px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(15,23,42,.55);
      white-space:nowrap;
      height: fit-content;
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding: 8px 16px 32px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: rgba(18,24,38,.88);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .card .bd{
      padding:16px;
    }
    .help{
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      margin:0 0 14px;
    }
    .pillrow{
      display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 4px;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(15,23,42,.45);
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
    }
    .row{
      display:grid;
      gap:12px;
    }

    .item{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(15,23,42,.35);
      padding:12px;
    }
    .meta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .dim{
      font-size:12px;
      color:var(--muted);
      padding:4px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(18,24,38,.35);
    }
    .q{
      margin:0;
      font-size:14px;
      line-height:1.45;
    }

    .likert{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
      margin-top:10px;
    }
    @media (max-width:560px){
      .likert{ grid-template-columns: repeat(5, 1fr); }
    }
    .opt{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      background: rgba(18,24,38,.35);
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      min-height:52px;
    }
    .opt:hover{ transform: translateY(-1px); border-color: rgba(96,165,250,.45); }
    .opt input{ accent-color: var(--accent); }

    /* Likert premium: solo n√∫meros 1‚Äì5 */
    .likert-num{
      justify-content:center;
      padding:14px 10px;
      gap:0;
    }
    .likert-num input{ margin-right:8px; }
    .likert-num .num{
      width:100%;
      text-align:center;
      font-size:18px;
      font-weight:900;
      letter-spacing:.5px;
      color: var(--text);
    }

    /* Inputs premium */
    .field{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(18,24,38,.35);
      color: var(--text);
      outline:none;
    }
    .field:focus{
      border-color: rgba(96,165,250,.6);
      box-shadow: 0 0 0 3px rgba(96,165,250,.12);
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    button{
      border:1px solid transparent;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:600;
      cursor:pointer;
      background: rgba(34,197,94,.18);
      color: var(--text);
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{ transform: translateY(-1px); }
    .secondary{
      background: rgba(96,165,250,.14);
      border-color: rgba(96,165,250,.3);
    }
    .ghost{
      background: transparent;
      border-color: var(--line);
      color: var(--muted);
    }
    .danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
    }
    .status{
      margin-top:12px;
      color:var(--muted);
      font-size:13px;
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width:560px){
      .kpi{ grid-template-columns: 1fr; }
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:12px;
      background: rgba(15,23,42,.35);
    }
    .kpi .box .lbl{
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
    }
    .kpi .box .val{
      font-size:22px;
      font-weight:800;
      letter-spacing:.3px;
    }
    .barwrap{
      margin-top:10px;
      border:1px solid var(--line);
      background: rgba(15,23,42,.35);
      border-radius:999px;
      overflow:hidden;
      height:12px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(239,68,68,.85), rgba(245,158,11,.85), rgba(34,197,94,.85));
      transition: width .35s ease;
    }
    .sect{
      margin-top:14px;
      border-top:1px dashed rgba(148,163,184,.25);
      padding-top:12px;
    }
    .sect h3{
      margin:0 0 10px;
      font-size:14px;
    }
    .list{
      margin:0;
      padding-left:16px;
      color:var(--text);
      line-height:1.5;
    }
    .list li{ margin:6px 0; }
    .muted{ color:var(--muted); }
    .small{ font-size:12px; color:var(--muted); }
    .tag{
      display:inline-block;
      padding:5px 9px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background: rgba(15,23,42,.35);
      margin-right:6px;
      margin-bottom:6px;
    }
    .tag.good{ border-color: rgba(34,197,94,.45); }
    .tag.warn{ border-color: rgba(245,158,11,.45); }
    .tag.bad{ border-color: rgba(239,68,68,.45); }

    footer{
      max-width:1100px;
      margin:0 auto;
      padding: 0 16px 28px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <div>
      <h1>Instrumento Empresarial Premium ¬∑ Diagn√≥stico Organizacional (Likert 1‚Äì5)</h1>
      <p class="sub">
        Responde 20 √≠tems. Al final ver√°s puntaje total, resultados por dimensi√≥n, resumen ejecutivo,
        conclusiones y recomendaciones autom√°ticas.
      </p>
    </div>
    <div class="brand">Por: Soamy Lanza 2025.1</div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- FORM -->
    <section class="card" id="formCard">
      <div class="hd">
        <h2>Encuesta</h2>
        <span class="pill">Escala Likert (1‚Äì5)</span>
      </div>
      <div class="bd">
        <p class="help">
          Marca una opci√≥n por afirmaci√≥n. Puedes guardar tu avance y continuar despu√©s.
        </p>

        <!-- Escala arriba (una sola vez) -->
        <div class="pillrow" style="margin-top:10px;">
          <span class="pill">1 = Totalmente en desacuerdo</span>
          <span class="pill">2 = En desacuerdo</span>
          <span class="pill">3 = Neutral</span>
          <span class="pill">4 = De acuerdo</span>
          <span class="pill">5 = Totalmente de acuerdo</span>
        </div>

        <div class="pillrow">
          <span class="pill">Tiempo estimado: 3‚Äì6 min</span>
          <span class="pill">20 √≠tems ¬∑ 10 dimensiones</span>
          <span class="pill">Resultados inmediatos</span>
        </div>

        <!-- Datos del respondiente (premium) -->
        <div class="item" style="margin-top:12px; margin-bottom:12px;">
          <div class="meta">
            <span class="dim">Datos del respondiente (opcional)</span>
            <span class="small muted">√ötil para segmentar por √°rea/rol</span>
          </div>

          <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:10px;">
            <div>
              <div class="small muted">Empresa</div>
              <input id="empresa" class="field" type="text" placeholder="Ej. CBS" />
            </div>
            <div>
              <div class="small muted">√Årea / Departamento</div>
              <input id="area" class="field" type="text" placeholder="Ej. Producci√≥n" />
            </div>
            <div>
              <div class="small muted">Cargo / Rol</div>
              <input id="rol" class="field" type="text" placeholder="Ej. Supervisor" />
            </div>
            <div>
              <div class="small muted">Antig√ºedad</div>
              <select id="antiguedad" class="field">
                <option value="">Seleccionar‚Ä¶</option>
                <option>0‚Äì6 meses</option>
                <option>6‚Äì12 meses</option>
                <option>1‚Äì3 a√±os</option>
                <option>3‚Äì5 a√±os</option>
                <option>5+ a√±os</option>
              </select>
            </div>
          </div>

          <p class="small muted" style="margin-top:10px;">
            Confidencialidad: este diagn√≥stico calcula resultados en el navegador del usuario.
            (Si luego quieres guardar resultados centralizados en Google Sheets, te lo configuro.)
          </p>
        </div>

        <div class="row" id="items"></div>

        <div class="sect">
          <div class="actions">
            <button id="btnCalcular">Ver resultados</button>
            <button class="secondary" id="btnGuardar">Guardar avance</button>
            <button class="ghost" id="btnCargar">Cargar avance</button>
            <button class="danger" id="btnLimpiar">Limpiar todo</button>
          </div>
          <div class="status" id="status"></div>
        </div>
      </div>
    </section>

    <!-- RESULTS -->
    <aside class="card" id="resultsCard">
      <div class="hd">
        <h2>Resultados</h2>
        <span class="pill" id="pillEstado">Sin calcular</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box">
            <div class="lbl">Puntaje total</div>
            <div class="val" id="totalScore">‚Äî</div>
            <div class="small muted">M√°ximo: 100</div>
          </div>
          <div class="box">
            <div class="lbl">Promedio (1‚Äì5)</div>
            <div class="val" id="avgScore">‚Äî</div>
            <div class="small muted">Meta t√≠pica: ‚â• 4.0</div>
          </div>
          <div class="box">
            <div class="lbl">Cobertura</div>
            <div class="val" id="coverage">‚Äî</div>
            <div class="small muted">√çtems respondidos</div>
          </div>
        </div>

        <div class="barwrap" aria-label="Progreso">
          <div class="bar" id="bar"></div>
        </div>

        <!-- Resumen ejecutivo premium -->
        <div class="sect">
          <h3>Resumen ejecutivo</h3>
          <div id="execSummary" class="small muted"></div>
          <div id="badges" style="margin-top:10px;"></div>
        </div>

        <div class="sect">
          <h3>Resultados por dimensi√≥n</h3>
          <div id="dimResults"></div>
          <p class="small muted">Cada dimensi√≥n suma 2 √≠tems (m√°x. 10 puntos).</p>
        </div>

        <div class="sect">
          <h3>Conclusiones</h3>
          <ul class="list" id="conclusions"></ul>
        </div>

        <div class="sect">
          <h3>Recomendaciones</h3>
          <ul class="list" id="recs"></ul>
        </div>

        <div class="sect">
          <h3>Compartir / Exportar</h3>
          <p class="help">
            Puedes copiar el resumen para pegarlo en WhatsApp o imprimir/guardar en PDF.
            Tambi√©n puedes descargar JSON/CSV para Excel/Power BI.
          </p>
          <div class="actions">
            <button class="secondary" id="btnCopiar">Copiar resumen</button>
            <button class="ghost" id="btnImprimir">Imprimir / Guardar PDF</button>
            <button class="ghost" id="btnJSON">Descargar JSON</button>
            <button class="ghost" id="btnCSV">Descargar CSV</button>
          </div>
          <div class="status" id="copyStatus"></div>
        </div>

      </div>
    </aside>
  </div>
</main>

<footer>
  <div>
    <span class="muted">
      Nota: Este instrumento es diagn√≥stico y orientativo; se interpreta mejor con contexto (tipo de empresa, tama√±o, sector, etc.).
    </span>
  </div>
</footer>

<script>
  // =========================
  // DATA
  // =========================
  const DIMENSIONS = [
    { key:"estrategia", name:"Estrategia y Direcci√≥n" },
    { key:"liderazgo", name:"Gobernanza y Liderazgo" },
    { key:"estructura", name:"Estructura Organizacional" },
    { key:"procesos", name:"Procesos y Eficiencia Operativa" },
    { key:"talento", name:"Gesti√≥n del Talento Humano" },
    { key:"cultura", name:"Cultura Organizacional" },
    { key:"comunicacion", name:"Comunicaci√≥n Interna" },
    { key:"tecnologia", name:"Tecnolog√≠a y Digitalizaci√≥n" },
    { key:"finanzas", name:"Gesti√≥n Financiera y Sostenibilidad" },
    { key:"innovacion", name:"Innovaci√≥n y Adaptabilidad" }
  ];

  const ITEMS = [
    { id:1, dim:"estrategia", text:"La empresa tiene objetivos estrat√©gicos claros y bien definidos." },
    { id:2, dim:"estrategia", text:"Las decisiones operativas diarias est√°n alineadas con la estrategia organizacional." },

    { id:3, dim:"liderazgo", text:"Los l√≠deres toman decisiones oportunas y fundamentadas." },
    { id:4, dim:"liderazgo", text:"Existe claridad sobre qui√©n toma decisiones y hasta d√≥nde llega su autoridad." },

    { id:5, dim:"estructura", text:"Las funciones y responsabilidades de los puestos est√°n claramente definidas." },
    { id:6, dim:"estructura", text:"La estructura organizacional facilita el trabajo y no lo complica." },

    { id:7, dim:"procesos", text:"Los procesos clave est√°n documentados y estandarizados." },
    { id:8, dim:"procesos", text:"El trabajo se realiza con pocos reprocesos o retrabajos." },

    { id:9, dim:"talento", text:"La empresa cuenta con el personal adecuado para cumplir sus objetivos." },
    { id:10, dim:"talento", text:"El desempe√±o del personal se eval√∫a de forma clara y justa." },

    { id:11, dim:"cultura", text:"Los valores organizacionales se practican en el d√≠a a d√≠a." },
    { id:12, dim:"cultura", text:"Existe un ambiente de confianza y colaboraci√≥n entre las personas." },

    { id:13, dim:"comunicacion", text:"La informaci√≥n importante se comunica de manera clara y oportuna." },
    { id:14, dim:"comunicacion", text:"Existen canales efectivos para recibir retroalimentaci√≥n del personal." },

    { id:15, dim:"tecnologia", text:"La empresa utiliza herramientas tecnol√≥gicas adecuadas para sus procesos." },
    { id:16, dim:"tecnologia", text:"Los sistemas y herramientas est√°n bien integrados entre s√≠." },

    { id:17, dim:"finanzas", text:"Existe control y seguimiento adecuado de los recursos financieros." },
    { id:18, dim:"finanzas", text:"La empresa tiene capacidad financiera para sostener y crecer en el tiempo." },

    { id:19, dim:"innovacion", text:"La empresa promueve la mejora continua y la innovaci√≥n." },
    { id:20, dim:"innovacion", text:"La organizaci√≥n se adapta con rapidez a los cambios del entorno." }
  ];

  const LIKERT = [
    { v:1 }, { v:2 }, { v:3 }, { v:4 }, { v:5 }
  ];

  const STORAGE_KEY = "diag_org_likert_premium_v1";

  // =========================
  // RENDER
  // =========================
  const itemsEl = document.getElementById("items");
  const statusEl = document.getElementById("status");

  function dimName(key){
    return (DIMENSIONS.find(d => d.key===key)?.name) || key;
  }

  function renderItems(){
    itemsEl.innerHTML = "";
    ITEMS.forEach(it=>{
      const wrap = document.createElement("div");
      wrap.className = "item";
      wrap.innerHTML = `
        <div class="meta">
          <span class="dim">${dimName(it.dim)}</span>
          <span class="small muted">√çtem ${it.id} / 20</span>
        </div>
        <p class="q">${it.text}</p>
        <div class="likert" role="radiogroup" aria-label="Item ${it.id}">
          ${LIKERT.map(opt => `
            <label class="opt likert-num" title="${opt.v}">
              <input type="radio" name="q${it.id}" value="${opt.v}" />
              <span class="num">${opt.v}</span>
            </label>
          `).join("")}
        </div>
      `;
      itemsEl.appendChild(wrap);
    });
  }

  renderItems();

  // =========================
  // HELPERS
  // =========================
  function getMeta(){
    return {
      empresa: document.getElementById("empresa")?.value?.trim() || "",
      area: document.getElementById("area")?.value?.trim() || "",
      rol: document.getElementById("rol")?.value?.trim() || "",
      antiguedad: document.getElementById("antiguedad")?.value || "",
      fecha: new Date().toISOString()
    };
  }

  function getResponses(){
    const res = {};
    ITEMS.forEach(it=>{
      const checked = document.querySelector(`input[name="q${it.id}"]:checked`);
      res[it.id] = checked ? Number(checked.value) : null;
    });
    return res;
  }

  function setResponses(res){
    ITEMS.forEach(it=>{
      const v = res?.[it.id];
      if(!v) return;
      const el = document.querySelector(`input[name="q${it.id}"][value="${v}"]`);
      if(el) el.checked = true;
    });
  }

  function countAnswered(res){
    return Object.values(res).filter(v => v!==null).length;
  }

  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  function levelFromAvg(avg){
    if(avg >= 4.2) return { key:"alto", label:"S√≥lido", color:"good" };
    if(avg >= 3.4) return { key:"medio", label:"En desarrollo", color:"warn" };
    return { key:"bajo", label:"Cr√≠tico", color:"bad" };
  }

  function bandText(levelKey){
    if(levelKey==="alto") return "S√≥lido (alto)";
    if(levelKey==="medio") return "En desarrollo (medio)";
    return "Cr√≠tico (bajo)";
  }

  function validateAllAnswered(res){
    return ITEMS.filter(it => res[it.id] === null).map(it=>it.id);
  }

  function setStatus(msg, type="info"){
    statusEl.innerHTML = msg;
    statusEl.style.color =
      type==="bad" ? "rgba(239,68,68,.95)" :
      type==="warn" ? "rgba(245,158,11,.95)" :
      "rgba(148,163,184,.95)";
  }

  // =========================
  // SCORING + INSIGHTS
  // =========================
  function computeResults(res){
    const answered = countAnswered(res);
    const totalItems = ITEMS.length;

    const dimScores = {};
    DIMENSIONS.forEach(d=> dimScores[d.key] = { sum:0, max:10, answered:0 });

    let total = 0;
    ITEMS.forEach(it=>{
      const v = res[it.id];
      if(v!==null){
        total += v;
        dimScores[it.dim].sum += v;
        dimScores[it.dim].answered += 1;
      }
    });

    const maxTotal = totalItems * 5; // 100
    const avg = answered ? (total / answered) : 0;
    const pct = answered ? (total / (answered*5)) : 0;
    const overallLevel = levelFromAvg(avg);

    const dims = DIMENSIONS.map(d=>{
      const sc = dimScores[d.key];
      const dimAvg = sc.answered ? (sc.sum / sc.answered) : 0;
      const lvl = levelFromAvg(dimAvg);
      return {
        key:d.key, name:d.name,
        sum: sc.sum, max: sc.max,
        answered: sc.answered,
        avg: dimAvg, level: lvl
      };
    });

    const scoredDims = dims.filter(x=>x.answered>0).sort((a,b)=> b.avg - a.avg);
    const top = scoredDims.slice(0,3);
    const bottom = scoredDims.slice(-3).reverse();

    const conclusions = [];
    const recs = [];

    if(answered < totalItems){
      conclusions.push(`Cobertura incompleta: se respondieron ${answered} de ${totalItems} √≠tems. Para conclusiones m√°s firmes, completa los restantes.`);
    }

    conclusions.push(`Estado general: <b>${bandText(overallLevel.key)}</b> (promedio ${avg.toFixed(2)} / 5).`);
    if(top.length){
      conclusions.push(`Fortalezas principales: ${top.map(x=>`<b>${x.name}</b>`).join(", ")}.`);
    }
    if(bottom.length){
      conclusions.push(`Prioridades de mejora: ${bottom.map(x=>`<b>${x.name}</b>`).join(", ")}.`);
    }

    const baseRecs = {
      estrategia: [
        "Aterriza la estrategia en OKRs/KPIs trimestrales por √°rea y publ√≠calos en 1 p√°gina.",
        "Instala una rutina mensual de revisi√≥n: avances, obst√°culos y decisiones (30‚Äì60 min)."
      ],
      liderazgo: [
        "Define una matriz RACI para procesos cr√≠ticos (qui√©n decide, qui√©n ejecuta, qui√©n apoya, a qui√©n se informa).",
        "Fortalece 1:1 quincenales y decisiones basadas en datos y retroalimentaci√≥n breve."
      ],
      estructura: [
        "Actualiza descripciones de puesto y elimina duplicidades; valida con responsables de proceso.",
        "Reduce fricci√≥n: revisa tramos jer√°rquicos y tiempos de aprobaci√≥n."
      ],
      procesos: [
        "Mapea 5 procesos clave (SIPOC o flujo) e identifica cuellos de botella y retrabajos.",
        "Define est√°ndares m√≠nimos (checklists) y due√±os de proceso con indicadores."
      ],
      talento: [
        "Alinea perfil/competencias por rol y mejora selecci√≥n (pruebas + entrevista estructurada).",
        "Implementa evaluaci√≥n de desempe√±o simple (metas + conductas) y plan de desarrollo."
      ],
      cultura: [
        "Define comportamientos observables por valor y reconoce los positivos p√∫blicamente.",
        "Activa retrospectivas mensuales por equipo (qu√© mejorar/qu√© mantener)."
      ],
      comunicacion: [
        "Bolet√≠n interno semanal (5 bullets): decisiones, prioridades y avances.",
        "Canal de feedback con compromiso de respuesta en 72 horas."
      ],
      tecnologia: [
        "Inventario de herramientas: qu√© se usa, para qu√©, y qu√© se repite; simplifica.",
        "Automatiza tareas repetitivas y conecta sistemas (formularios, reportes, aprobaciones)."
      ],
      finanzas: [
        "Control presupuestario mensual: variaciones vs plan y acciones correctivas.",
        "Tablero financiero m√≠nimo: margen, liquidez, rotaci√≥n de inventario/cartera."
      ],
      innovacion: [
        "Pipeline de mejoras: idea ‚Üí prueba r√°pida ‚Üí resultado ‚Üí estandarizaci√≥n.",
        "Tiempo fijo para mejora continua (ej. 2 horas quincenales por equipo)."
      ]
    };

    if(overallLevel.key === "bajo"){
      recs.push("Enfoque de choque (30‚Äì45 d√≠as): define 3 prioridades, 1 due√±o por prioridad y seguimiento semanal.");
      recs.push("Asegura bases: objetivos del trimestre, roles de decisi√≥n claros y procesos cr√≠ticos documentados.");
    } else if(overallLevel.key === "medio"){
      recs.push("Consolida: reduce retrabajos, mejora coordinaci√≥n inter-√°reas y estandariza lo que ya funciona.");
      recs.push("Sube madurez con KPIs y rutinas: revisi√≥n mensual de desempe√±o operativo y estrat√©gico.");
    } else {
      recs.push("Mant√©n el est√°ndar: refuerza innovaci√≥n, automatizaci√≥n y desarrollo de talento para escalar sin caos.");
      recs.push("Optimiza fino: elimina aprobaciones innecesarias y acelera decisiones con datos.");
    }

    bottom.forEach(d=>{
      const picks = baseRecs[d.key] || [];
      picks.forEach(p=> recs.push(`<b>${d.name}:</b> ${p}`));
    });

    if(answered < totalItems){
      recs.unshift("Completa los √≠tems faltantes para obtener un diagn√≥stico m√°s preciso y comparable por dimensi√≥n.");
    }

    return { answered, totalItems, total, maxTotal, avg, pct, overallLevel, dims, conclusions, recs };
  }

  function renderResults(results){
    const totalScoreEl = document.getElementById("totalScore");
    const avgScoreEl = document.getElementById("avgScore");
    const coverageEl = document.getElementById("coverage");
    const dimResultsEl = document.getElementById("dimResults");
    const conclusionsEl = document.getElementById("conclusions");
    const recsEl = document.getElementById("recs");
    const barEl = document.getElementById("bar");
    const pillEstado = document.getElementById("pillEstado");

    totalScoreEl.textContent = `${results.total} / ${results.maxTotal}`;
    avgScoreEl.textContent = results.answered ? results.avg.toFixed(2) : "‚Äî";
    coverageEl.textContent = `${results.answered} / ${results.totalItems}`;

    const w = clamp(results.pct * 100, 0, 100);
    barEl.style.width = `${w}%`;

    pillEstado.textContent = results.answered ? results.overallLevel.label : "Sin calcular";
    pillEstado.className = `pill tag ${results.answered ? results.overallLevel.color : ""}`;

    dimResultsEl.innerHTML = "";
    results.dims.forEach(d=>{
      const pct = d.answered ? (d.sum / (d.answered*5)) : 0;
      const scoreText = d.answered ? `${d.sum} pts ¬∑ prom ${d.avg.toFixed(2)}/5` : "Sin respuestas";
      const tag = document.createElement("div");
      tag.className = "item";
      tag.innerHTML = `
        <div class="meta">
          <span class="dim">${d.name}</span>
          <span class="tag ${d.answered ? d.level.color : ""}">
            ${d.answered ? d.level.label : "‚Äî"}
          </span>
        </div>
        <div class="small muted">${scoreText}</div>
        <div class="barwrap" style="height:10px; margin-top:10px;">
          <div class="bar" style="width:${clamp(pct*100,0,100)}%"></div>
        </div>
      `;
      dimResultsEl.appendChild(tag);
    });

    conclusionsEl.innerHTML = results.conclusions.map(x=>`<li>${x}</li>`).join("");
    recsEl.innerHTML = results.recs.map(x=>`<li>${x}</li>`).join("");

    // Resumen ejecutivo premium
    const exec = document.getElementById("execSummary");
    const badges = document.getElementById("badges");

    const strengths = results.dims
      .filter(d=>d.answered>0)
      .sort((a,b)=> b.avg - a.avg)
      .slice(0,2)
      .map(d=>d.name);

    const priorities = results.dims
      .filter(d=>d.answered>0)
      .sort((a,b)=> a.avg - b.avg)
      .slice(0,2)
      .map(d=>d.name);

    exec.innerHTML = `
      Promedio general: <b>${results.avg.toFixed(2)}/5</b> ¬∑ Estado: <b>${results.overallLevel.label}</b><br/>
      Fortalezas: <b>${strengths.join(", ") || "‚Äî"}</b><br/>
      Prioridades: <b>${priorities.join(", ") || "‚Äî"}</b>
    `;

    badges.innerHTML = results.dims
      .filter(d=>d.answered>0)
      .map(d=>`<span class="tag ${d.level.color}">${d.name}: ${d.level.label}</span>`)
      .join(" ");

    window.__LAST_RESULTS__ = results;
    window.__LAST_META__ = getMeta();
  }

  // =========================
  // STORAGE
  // =========================
  function saveProgress(){
    const res = getResponses();
    const meta = {
      empresa: document.getElementById("empresa")?.value?.trim() || "",
      area: document.getElementById("area")?.value?.trim() || "",
      rol: document.getElementById("rol")?.value?.trim() || "",
      antiguedad: document.getElementById("antiguedad")?.value || ""
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      savedAt: new Date().toISOString(),
      meta,
      responses: res
    }));
  }

  function loadProgress(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }

  // =========================
  // ACTIONS
  // =========================
  document.getElementById("btnCalcular").addEventListener("click", ()=>{
    const res = getResponses();
    const missing = validateAllAnswered(res);

    const results = computeResults(res);
    renderResults(results);

    if(missing.length){
      setStatus(`‚ö†Ô∏è Te faltan ${missing.length} √≠tems por responder (ej.: ${missing.slice(0,6).join(", ")}${missing.length>6?"...":""}). Igual se calcularon resultados con lo respondido.`, "warn");
    } else {
      setStatus(`‚úÖ Listo. Resultados calculados con cobertura completa (20/20).`, "info");
    }

    document.getElementById("resultsCard").scrollIntoView({behavior:"smooth", block:"start"});
  });

  document.getElementById("btnGuardar").addEventListener("click", ()=>{
    saveProgress();
    setStatus("üíæ Avance guardado en este dispositivo/navegador.", "info");
  });

  document.getElementById("btnCargar").addEventListener("click", ()=>{
    const data = loadProgress();
    if(!data){
      setStatus("No hay avance guardado a√∫n.", "warn");
      return;
    }
    setResponses(data.responses || {});
    // Cargar meta
    if(data.meta){
      document.getElementById("empresa").value = data.meta.empresa || "";
      document.getElementById("area").value = data.meta.area || "";
      document.getElementById("rol").value = data.meta.rol || "";
      document.getElementById("antiguedad").value = data.meta.antiguedad || "";
    }
    setStatus(`üì• Avance cargado (guardado: ${new Date(data.savedAt).toLocaleString()}).`, "info");
  });

  document.getElementById("btnLimpiar").addEventListener("click", ()=>{
    ITEMS.forEach(it=>{
      const nodes = document.querySelectorAll(`input[name="q${it.id}"]`);
      nodes.forEach(n=> n.checked = false);
    });
    localStorage.removeItem(STORAGE_KEY);

    document.getElementById("empresa").value = "";
    document.getElementById("area").value = "";
    document.getElementById("rol").value = "";
    document.getElementById("antiguedad").value = "";

    setStatus("üßπ Respuestas limpiadas y avance eliminado.", "info");

    document.getElementById("totalScore").textContent = "‚Äî";
    document.getElementById("avgScore").textContent = "‚Äî";
    document.getElementById("coverage").textContent = "‚Äî";
    document.getElementById("dimResults").innerHTML = "";
    document.getElementById("conclusions").innerHTML = "";
    document.getElementById("recs").innerHTML = "";
    document.getElementById("execSummary").innerHTML = "";
    document.getElementById("badges").innerHTML = "";
    document.getElementById("bar").style.width = "0%";
    const pill = document.getElementById("pillEstado");
    pill.textContent = "Sin calcular";
    pill.className = "pill";

    window.__LAST_RESULTS__ = null;
    window.__LAST_META__ = null;
  });

  // =========================
  // SHARE / EXPORT
  // =========================
  function stripHtml(arr){
    return (arr || []).map(x => String(x)
      .replaceAll("<b>","").replaceAll("</b>","")
      .replaceAll("&nbsp;"," ")
    );
  }

  document.getElementById("btnCopiar").addEventListener("click", async ()=>{
    const s = document.getElementById("copyStatus");
    const r = window.__LAST_RESULTS__;
    if(!r){
      s.textContent = "Primero calcula resultados.";
      return;
    }
    const meta = window.__LAST_META__ || getMeta();

    const dimLines = r.dims
      .filter(d=>d.answered>0)
      .map(d=>`- ${d.name}: prom ${d.avg.toFixed(2)}/5 (${d.level.label})`)
      .join("\n");

    const conclPlain = stripHtml(r.conclusions).map(x=>`- ${x}`).join("\n");
    const recPlain = stripHtml(r.recs).slice(0,10).map(x=>`- ${x}`).join("\n");

    const text =
`DIAGN√ìSTICO ORGANIZACIONAL (Likert 1‚Äì5) ¬∑ PREMIUM
Por: Soamy Lanza 2025.1

Datos (opcional):
- Empresa: ${meta.empresa || "‚Äî"}
- √Årea: ${meta.area || "‚Äî"}
- Rol: ${meta.rol || "‚Äî"}
- Antig√ºedad: ${meta.antiguedad || "‚Äî"}
- Fecha: ${new Date(meta.fecha).toLocaleString()}

Resultados:
- Puntaje total: ${r.total}/${r.maxTotal}
- Promedio: ${r.avg.toFixed(2)}/5
- Cobertura: ${r.answered}/${r.totalItems}
- Estado general: ${bandText(r.overallLevel.key)}

Resultados por dimensi√≥n:
${dimLines || "- (sin datos)"}

Conclusiones:
${conclPlain || "- (sin datos)"}

Recomendaciones (top):
${recPlain || "- (sin datos)"}
`;

    try{
      await navigator.clipboard.writeText(text);
      s.textContent = "‚úÖ Resumen copiado. P√©galo en WhatsApp/redes.";
    }catch(e){
      s.textContent = "No se pudo copiar (tu navegador bloque√≥ el portapapeles). Usa Imprimir/PDF y copia desde ah√≠.";
    }
  });

  document.getElementById("btnImprimir").addEventListener("click", ()=>{
    window.print();
  });

  function downloadFile(filename, content, mime){
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  document.getElementById("btnJSON").addEventListener("click", ()=>{
    const r = window.__LAST_RESULTS__;
    const s = document.getElementById("copyStatus");
    if(!r){ s.textContent = "Primero calcula resultados."; return; }

    const meta = window.__LAST_META__ || getMeta();
    const payload = {
      meta,
      total: r.total,
      maxTotal: r.maxTotal,
      avg: Number(r.avg.toFixed(2)),
      overall: r.overallLevel.label,
      dimensiones: r.dims.map(d=>({
        dimension: d.name,
        avg: Number(d.avg.toFixed(2)),
        score: d.sum,
        max: d.max,
        nivel: d.level.label
      }))
    };

    downloadFile("diagnostico_organizacional_premium.json", JSON.stringify(payload, null, 2), "application/json");
    s.textContent = "‚úÖ JSON descargado.";
  });

  document.getElementById("btnCSV").addEventListener("click", ()=>{
    const r = window.__LAST_RESULTS__;
    const s = document.getElementById("copyStatus");
    if(!r){ s.textContent = "Primero calcula resultados."; return; }

    const meta = window.__LAST_META__ || getMeta();
    const header = ["fecha","empresa","area","rol","antiguedad","dimension","avg","score","max","nivel"];
    const rows = r.dims.map(d=>[
      meta.fecha, meta.empresa, meta.area, meta.rol, meta.antiguedad,
      d.name, d.avg.toFixed(2), d.sum, d.max, d.level.label
    ]);

    const csv = [header, ...rows]
      .map(row => row.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(","))
      .join("\n");

    downloadFile("diagnostico_organizacional_premium.csv", csv, "text/csv");
    s.textContent = "‚úÖ CSV descargado.";
  });

  // =========================
  // AUTO LOAD
  // =========================
  (function autoLoad(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if(data?.responses){
        setResponses(data.responses);
        if(data.meta){
          document.getElementById("empresa").value = data.meta.empresa || "";
          document.getElementById("area").value = data.meta.area || "";
          document.getElementById("rol").value = data.meta.rol || "";
          document.getElementById("antiguedad").value = data.meta.antiguedad || "";
        }
        setStatus(`üìå Avance detectado y pre-cargado (guardado: ${new Date(data.savedAt).toLocaleString()}).`, "info");
      }
    }catch(e){ /* ignore */ }
  })();
</script>
</body>
</html>
