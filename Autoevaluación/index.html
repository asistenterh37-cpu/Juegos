<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Autoevaluación del desempeño</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0d1730;
      --text:#e7eefc;
      --muted:#a8b3cc;
      --line:rgba(255,255,255,.08);
      --btn:#2f6bff;
      --btn2:#1d2c53;
      --danger:#ff4d6d;
      --ok:#3ddc97;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1000px 600px at 15% 10%, rgba(47,107,255,.25), transparent 60%),
                  radial-gradient(900px 650px at 85% 20%, rgba(61,220,151,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      line-height:1.35;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.65));
      border-bottom: 1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 18px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:240px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, #2f6bff, #7c4dff);
      display:grid;place-items:center;
      box-shadow: 0 12px 35px rgba(47,107,255,.35);
      font-weight:800;
    }
    .titles h1{margin:0;font-size:18px;letter-spacing:.2px}
    .titles p{margin:2px 0 0;color:var(--muted);font-size:12.5px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button{
      border:1px solid var(--line);
      background: var(--btn2);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{border-color:rgba(255,255,255,.18); background:#223462}
    button:active{transform: translateY(1px)}
    .primary{
      background: var(--btn);
      border-color: rgba(47,107,255,.55);
    }
    .primary:hover{background:#255df0}
    .ghost{
      background: transparent;
    }
    .danger{
      background: rgba(255,77,109,.14);
      border-color: rgba(255,77,109,.28);
    }
    .danger:hover{background: rgba(255,77,109,.20)}
    main .wrap{padding-top:18px; padding-bottom:42px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(15,27,51,.85), rgba(13,23,48,.85));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card .inner{padding:18px}
    .sectionTitle{
      display:flex; align-items:baseline; justify-content:space-between; gap:12px;
      margin:0 0 10px 0;
    }
    .sectionTitle h2{margin:0;font-size:16px}
    .sectionTitle span{color:var(--muted); font-size:12px}
    .fields{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
    }
    .field{
      grid-column: span 2;
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{font-size:12px;color:var(--muted)}
    input, textarea, select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(47,107,255,.55);
      box-shadow: 0 0 0 3px rgba(47,107,255,.18);
    }
    textarea{min-height:96px; resize:vertical}
    .items{
      display:flex; flex-direction:column; gap:10px;
    }
    .itemRow{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:10px;
      padding:12px;
      border-radius: var(--radius2);
      border:1px dashed rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }
    .itemRow .left{
      display:flex; flex-direction:column; gap:6px;
    }
    .itemRow .itemName{
      font-weight:760;
      letter-spacing:.1px;
    }
    .itemRow .hint{
      color:var(--muted);
      font-size:12.5px;
    }
    .itemRow .right{
      display:flex; flex-direction:column; gap:6px;
      align-items:stretch; justify-content:center;
    }
    .smallNote{color:var(--muted); font-size:12px}
    .footerNote{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(61,220,151,.18);
    }

    /* Reporte */
    #reportCard{display:none}
    #reportCard .inner{padding:20px}
    .reportHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      padding-bottom:12px;
      margin-bottom:12px;
    }
    .reportHeader h2{margin:0;font-size:18px}
    .reportHeader .meta{
      color:var(--muted);
      font-size:12.5px;
      text-align:right;
    }
    .reportGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    .kv{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .kv .k{color:var(--muted); font-size:12px}
    .kv .v{font-weight:750; margin-top:4px}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.08);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:last-child td{border-bottom:none}
    .totalBox{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(47,107,255,.10);
    }
    .totalBox .tLabel{color:var(--muted); font-size:12px}
    .totalBox .tVal{font-size:18px; font-weight:900}
    .sign{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:flex-end;
    }

    /* Print */
    @media print{
      header{display:none !important}
      body{background:#fff; color:#000}
      .card{box-shadow:none; border:1px solid #ddd; background:#fff}
      #appCard{display:none !important}
      #reportCard{display:block !important}
      table{border-color:#ddd}
      thead th{background:#f6f6f6; color:#333}
      .kv{border-color:#ddd; background:#fff}
      .totalBox{border-color:#ddd; background:#f3f7ff}
      .sign{color:#555}
      a{color:#000;text-decoration:none}
    }

    @media (max-width:860px){
      .fields{grid-template-columns: 1fr 1fr}
      .field{grid-column: span 1}
      .itemRow{grid-template-columns: 1fr}
      .reportGrid{grid-template-columns: 1fr}
      .reportHeader .meta{text-align:left}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo">AD</div>
          <div class="titles">
            <h1>Formulario de autoevaluación del desempeño</h1>
            <p>Escala 1–5 • Cálculo interno por pesos • Reporte listo para PDF</p>
          </div>
        </div>
        <div class="actions">
          <button class="danger" id="btnNew" title="Limpiar todo">Nuevo</button>
          <button class="primary" id="btnSave" title="Guardar en este navegador">Guardar</button>
          <button class="ghost" id="btnPrint" title="Imprimir o guardar como PDF">Imprimir / Enviar a PDF</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap grid">

      <!-- FORM -->
      <section class="card" id="appCard">
        <div class="inner">
          <div class="sectionTitle">
            <h2>Datos del colaborador</h2>
            <span class="badge"><span class="dot"></span><span id="saveState">Listo</span></span>
          </div>

          <div class="fields" id="metaFields">
            <div class="field">
              <label for="noPersonal">No. de personal</label>
              <input id="noPersonal" type="text" placeholder="Ej. 000123" />
            </div>
            <div class="field">
              <label for="nombre">Nombre</label>
              <input id="nombre" type="text" placeholder="Ej. Soamy Lanza" />
            </div>
            <div class="field">
              <label for="posicion">Posición</label>
              <input id="posicion" type="text" placeholder="Ej. Analista" />
            </div>
            <div class="field">
              <label for="departamento">Departamento</label>
              <input id="departamento" type="text" placeholder="Ej. RRHH" />
            </div>
            <div class="field">
              <label for="periodo">Periodo</label>
              <input id="periodo" type="text" placeholder="Ej. Q1-2026" />
            </div>
            <div class="field">
              <label for="version">Versión</label>
              <input id="version" type="text" placeholder="Ej. v1.0" />
            </div>
            <div class="field">
              <label for="fecha">Fecha</label>
              <input id="fecha" type="date" />
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="sectionTitle">
            <h2>Autoevaluación (Factores 1–5)</h2>
            <span>Selecciona una opción por cada ítem.</span>
          </div>

          <div class="items" id="formContainer"></div>

          <div style="height:12px"></div>

          <div class="sectionTitle">
            <h2>Comentarios del colaborador</h2>
            <span class="smallNote">Incluye observaciones, ejemplos, mejoras o apoyo requerido.</span>
          </div>
          <textarea id="comentarios" placeholder="Escribe aquí tus comentarios..."></textarea>

          <div class="footerNote">
            <div class="badge" title="El total máximo es 100 por la tabla de pesos">
              Total (máx. 100): <b id="totalLive">0.00</b>
            </div>
            <div class="smallNote">Tip: “Guardar” almacena en este navegador (localStorage).</div>
          </div>
        </div>
      </section>

      <!-- REPORT (solo para imprimir/PDF) -->
      <section class="card" id="reportCard">
        <div class="inner">
          <div class="reportHeader">
            <div>
              <h2>Reporte de Autoevaluación del Desempeño</h2>
              <div class="smallNote">Generado automáticamente desde el formulario.</div>
            </div>
            <div class="meta" id="reportStamp"></div>
          </div>

          <div class="reportGrid" id="reportMeta"></div>

          <table>
            <thead>
              <tr>
                <th style="width:45%">Ítem</th>
                <th>Respuesta elegida</th>
              </tr>
            </thead>
            <tbody id="reportRows"></tbody>
          </table>

          <div class="totalBox">
            <div>
              <div class="tLabel">Total de puntos</div>
              <div class="smallNote">Cálculo: (respuesta/5) × peso_del_ítem</div>
            </div>
            <div class="tVal" id="reportTotal">0.00</div>
          </div>

          <div style="height:10px"></div>
          <div class="kv">
            <div class="k">Comentarios del colaborador</div>
            <div class="v" id="reportComments" style="font-weight:600; white-space:pre-wrap"></div>
          </div>

          <div class="sign">Por Soamy Lanza</div>
        </div>
      </section>

    </div>
  </main>

  <script>
    // =========================
    // Datos (pesos + opciones)
    // =========================
    const SECTIONS = [
      {
        title: "1. Metas, productividad y eficiencia",
        items: [
          {
            id: "1A",
            name: "A. Cumplimiento de Metas. Grado de logro",
            weight: 15,
            options: {
              1: "No alcanza la mayoría de las metas; cumple menos del 70 % de lo establecido. La falta de avance afecta los resultados esperados.",
              2: "Logra entre 70–89 % de las metas; presenta avances parciales o inconsistentes y requiere correcciones.",
              3: "Alcanza el 100 % de las metas planificadas con calidad y dentro del tiempo establecido.",
              4: "Supera el 100 % y llega hasta un 110 % de las metas; entrega resultados adicionales o mejores de lo esperado.",
              5: "Supera más del 110 % de las metas de forma sostenida, con impacto significativo y calidad superior."
            }
          },
          {
            id: "1B",
            name: "B. Eficiencia en el uso del tiempo, costos y recursos",
            weight: 10,
            options: {
              1: "Usa el tiempo y los recursos con errores graves que afectan la eficiencia.",
              2: "Muestra uso inestable del tiempo y los recursos; requiere evaluaciones y correcciones frecuentes.",
              3: "Utiliza de manera adecuada el tiempo y los recursos, cumpliendo sin desperdicios significativos.",
              4: "Optimiza tiempo y recursos, generando mejoras o ahorros sin afectar la calidad del trabajo.",
              5: "Maximiza la eficiencia de forma sostenida, mejora procesos y logra resultados superiores sin comprometer la calidad."
            }
          },
          {
            id: "1C",
            name: "C. Cumplimiento de normas de seguridad",
            weight: 2.5,
            options: {
              1: "Incumple normas de seguridad y genera riesgos constantes para sí y el equipo.",
              2: "Cumple parcialmente las normas; requiere supervisión continua para evitar incidentes.",
              3: "Cumple todas las normas de seguridad y actúa de manera segura en su trabajo diario.",
              4: "Se anticipa a riesgos, propone acciones preventivas y actúa con autonomía segura.",
              5: "Promueve una cultura de seguridad; motiva a otros y contribuye a mantener ambientes sin incidentes."
            }
          },
          {
            id: "1D",
            name: "D. Prioriza y organiza tareas adecuadamente",
            weight: 2.5,
            options: {
              1: "Desorganiza las tareas; incumple plazos y afecta resultados importantes.",
              2: "Organiza parcialmente; presenta inconsistencias en prioridades y manejo del tiempo.",
              3: "Gestiona las tareas de forma adecuada, cumple tiempos y mantiene orden en su trabajo.",
              4: "Organiza y prioriza con eficiencia, anticipa necesidades y mejora sus tiempos de entrega.",
              5: "Es referente en organización; redistribuye recursos, optimiza procesos y eleva la productividad del equipo."
            }
          }
        ]
      },
      {
        title: "2. Calidad del Trabajo",
        items: [
          {
            id: "2A",
            name: "A. Exactitud y atención al detalle",
            weight: 2.5,
            options: {
              1: "Comete errores frecuentes y no identifica fallos evidentes; requiere supervisión constante para evitar errores mayores.",
              2: "Presenta errores recurrentes por falta de revisión; la exactitud es inconsistente y requiere correcciones frecuentes.",
              3: "Realiza su trabajo con un nivel adecuado de precisión; puede cometer errores menores que no afectan los resultados.",
              4: "Mantiene una atención al detalle constante; comete pocos errores y revisa su trabajo de forma proactiva.",
              5: "Su trabajo es impecable; detecta errores propios y ajenos, propone mejoras y es referente en precisión."
            }
          },
          {
            id: "2B",
            name: "B. Cumple con estándares de calidad",
            weight: 5,
            options: {
              1: "Menos del 70 % de los entregables cumplen los estándares; los resultados son inaceptables.",
              2: "Entre 70–89 % de los entregables cumplen los estándares; requiere ajustes frecuentes.",
              3: "El 100 % de los entregables cumplen los estándares establecidos.",
              4: "Cumplimiento entre 101–110 %; entrega con calidad superior y consistente.",
              5: "Más del 110 % de cumplimiento; supera ampliamente los estándares y produce resultados sobresalientes."
            }
          },
          {
            id: "2C",
            name: "C. Entregas a Tiempo. cumple con plazos establecidos",
            weight: 10,
            options: {
              1: "Menos del 70 % de las entregas se cumplen a tiempo; los retrasos afectan el área.",
              2: "Entre 70–89 % de las entregas se realizan a tiempo; desempeño irregular.",
              3: "El 100 % de las entregas se cumplen en los plazos pactados.",
              4: "Cumple entre 101–110 % de los tiempos; se anticipa en algunas entregas y mantiene calidad.",
              5: "Entrega más del 110 % a tiempo; supera plazos, mantiene calidad y mejora la eficiencia general."
            }
          },
          {
            id: "2D",
            name: "D. Manejo de errores y mejoras",
            weight: 2.5,
            options: {
              1: "No reconoce ni corrige errores; genera reincidencias graves.",
              2: "Corrige parcialmente, con retrasos o bajo nivel de supervisión; la mejora no es constante.",
              3: "Detecta y corrige errores básicos cuando se le solicita; cumple lo necesario.",
              4: "Se anticipa a errores y propone soluciones preventivas que mejoran el proceso.",
              5: "Asegura procesos libres de errores, implementa mejoras continuas y es referente en calidad."
            }
          }
        ]
      },
      {
        title: "3. Competencias y Habilidades",
        items: [
          {
            id: "3A",
            name: "A. Conocimientos técnicos del puesto",
            weight: 10,
            options: {
              1: "Conocimientos muy por debajo de lo esperado; no domina funciones básicas del puesto.",
              2: "Gestiona parcialmente los conocimientos requeridos y necesita apoyo frecuente.",
              3: "Posee el conocimiento necesario y funcional para el puesto; desempeño adecuado.",
              4: "Aplica los conocimientos de manera confiable y constante.",
              5: "Domina los conocimientos, aplica técnicas avanzadas y es referente técnico en el área."
            }
          },
          {
            id: "3B",
            name: "B. Convincente respuesta técnica a clientes",
            weight: 5,
            options: {
              1: "Respuestas incorrectas o inconsistentes que generan desconfianza.",
              2: "Respuestas incompletas o poco claras que afectan la calidad del servicio.",
              3: "Responde de forma adecuada y funcional, brindando confianza.",
              4: "Respuestas claras, específicas y confiables de manera constante.",
              5: "Respuestas sobresalientes y precisas, reconocidas como referentes por clientes y equipo."
            }
          },
          {
            id: "3C",
            name: "C. Resolución de problemas",
            weight: 2.5,
            options: {
              1: "No logra resolver problemas; afecta procesos y resultados.",
              2: "Resuelve parcialmente los problemas, requiriendo supervisión frecuente.",
              3: "Resuelve problemas básicos de manera satisfactoria y funcional.",
              4: "Resuelve problemas complejos con autonomía y confiabilidad.",
              5: "Anticipa problemas y desarrolla soluciones preventivas y estratégicas."
            }
          },
          {
            id: "3D",
            name: "D. Iniciativa y creatividad",
            weight: 2.5,
            options: {
              1: "No genera ideas ni propone mejoras.",
              2: "Propone ideas poco útiles o de aplicación limitada.",
              3: "Propone ideas funcionales y aplicables cuando es necesario.",
              4: "Genera ideas prácticas que optimizan procesos y agregan valor.",
              5: "Propone soluciones innovadoras con impacto positivo y sostenible en el área."
            }
          }
        ]
      },
      {
        title: "4. Actitud y Valores",
        items: [
          {
            id: "4A",
            name: "A. Responsabilidad y compromiso",
            weight: 2.5,
            options: {
              1: "Incumple compromisos y entrega resultados muy por debajo de lo esperado.",
              2: "Cumple compromisos de forma irregular y requiere seguimiento constante.",
              3: "Cumple con sus responsabilidades de manera adecuada y confiable.",
              4: "Cumple de forma consistente, genera seguridad y aporta valor.",
              5: "Inspira por su compromiso; es modelo de conducta para el equipo."
            }
          },
          {
            id: "4B",
            name: "B. Puntualidad y asistencia",
            weight: 2.5,
            options: {
              1: "Ausencias frecuentes e injustificadas; llegadas tardías recurrentes sin aviso y sin intención de mejora.",
              2: "Se presenta con frecuencia tarde o sin justificación clara, afectando la operación.",
              3: "Asiste regularmente y cumple horarios; puede presentar llegadas tarde o ausencias justificadas sin reincidencia.",
              4: "Es puntual y mantiene asistencia confiable; respeta horarios y comunica eventualidades oportunamente.",
              5: "Puntualidad y asistencia impecables; es referente para el equipo y se adapta a horarios especiales sin afectar el desempeño."
            }
          },
          {
            id: "4C",
            name: "C. Trabajo en equipo y cooperación",
            weight: 5,
            options: {
              1: "No coopera; genera conflictos y dificulta el trabajo del equipo.",
              2: "Coopera parcialmente y de manera inestable.",
              3: "Coopera cuando se le solicita, con resultados aceptables.",
              4: "Colabora activamente con el equipo y aporta de forma confiable.",
              5: "Es referente en trabajo en equipo; promueve colaboración, sinergia y apoya a otros."
            }
          },
          {
            id: "4D",
            name: "D. Comunicación efectiva",
            weight: 5,
            options: {
              1: "Comunicación confusa; genera malentendidos graves.",
              2: "Comunicación incompleta o poco clara; requiere supervisión para asegurar entendimiento.",
              3: "Comunica lo necesario de forma clara y suficiente.",
              4: "Comunicación clara, precisa y constructiva; escucha activamente.",
              5: "Comunicación influyente y estratégica; facilita acuerdos y motiva a otros."
            }
          }
        ]
      },
      {
        title: "5. Desarrollo y Potencial",
        items: [
          {
            id: "5A",
            name: "A. Adaptación al cambio",
            weight: 2.5,
            options: {
              1: "Se resiste activamente al cambio; afecta procesos y equipos.",
              2: "Se adapta parcialmente, con dificultad y resultados limitados.",
              3: "Se adapta lo necesario para mantener un desempeño adecuado.",
              4: "Se adapta de forma autónoma y confiable a nuevas situaciones.",
              5: "Es referente en adaptación; motiva y guía a otros en procesos de cambio."
            }
          },
          {
            id: "5B",
            name: "B. Disposición para aprender",
            weight: 2.5,
            options: {
              1: "No busca aprender; rechaza retroalimentación y capacitación.",
              2: "Aprende solo lo obligatorio y con mínima aplicación práctica.",
              3: "Aprende lo necesario para mantener un desempeño satisfactorio.",
              4: "Busca aprender constantemente y aplica lo aprendido en el trabajo.",
              5: "Se mantiene en aprendizaje continuo, comparte conocimientos y forma a otros."
            }
          },
          {
            id: "5C",
            name: "C. Liderazgo",
            weight: 10,
            options: {
              1: "No logra coordinar ni dirigir; genera desorden y afecta resultados.",
              2: "Lidera de forma débil, con bajo impacto en el equipo.",
              3: "Lidera tareas básicas con resultados adecuados y funcionales.",
              4: "Lidera con confianza, logrando resultados consistentes y estables.",
              5: "Inspira con visión clara; desarrolla a otros, fortalece la cohesión del equipo y se convierte en referente."
            }
          }
        ]
      }
    ];

    const STORAGE_KEY = "autoevaluacion_desempeno_v1";

    // =========================
    // Helpers
    // =========================
    const $ = (sel) => document.querySelector(sel);
    const fmt2 = (n) => (Math.round(n*100)/100).toFixed(2);

    function nowStamp(){
      const d = new Date();
      return d.toLocaleString("es-HN", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    // =========================
    // Render Form
    // =========================
    function optionLabel(score, text){
      // En el combo: "1 - <texto>"
      return `${score} - ${text}`;
    }

    function buildSelect(item){
      const sel = document.createElement("select");
      sel.setAttribute("data-item-id", item.id);

      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = "— Seleccionar —";
      sel.appendChild(ph);

      for (let v=1; v<=5; v++){
        const opt = document.createElement("option");
        opt.value = String(v);
        opt.textContent = optionLabel(v, item.options[v]);
        sel.appendChild(opt);
      }

      sel.addEventListener("change", () => {
        computeTotals();
        markDirty();
      });

      return sel;
    }

    function renderForm(){
      const container = $("#formContainer");
      container.innerHTML = "";

      SECTIONS.forEach(section => {
        const block = document.createElement("div");
        block.className = "card";
        block.style.boxShadow = "none";
        block.style.border = "1px solid rgba(255,255,255,.06)";
        block.style.background = "rgba(255,255,255,.02)";

        const inner = document.createElement("div");
        inner.className = "inner";

        const title = document.createElement("div");
        title.className = "sectionTitle";
        title.innerHTML = `<h2>${section.title}</h2><span></span>`;
        inner.appendChild(title);

        const itemsWrap = document.createElement("div");
        itemsWrap.className = "items";

        section.items.forEach(item => {
          const row = document.createElement("div");
          row.className = "itemRow";

          const left = document.createElement("div");
          left.className = "left";
          left.innerHTML = `
            <div class="itemName">${item.name}</div>
            <div class="hint">Elige la descripción que mejor refleje tu desempeño.</div>
          `;

          const right = document.createElement("div");
          right.className = "right";

          const label = document.createElement("label");
          label.style.color = "var(--muted)";
          label.style.fontSize = "12px";
          label.textContent = "Respuesta";

          const sel = buildSelect(item);
          right.appendChild(label);
          right.appendChild(sel);

          row.appendChild(left);
          row.appendChild(right);
          itemsWrap.appendChild(row);
        });

        inner.appendChild(itemsWrap);
        block.appendChild(inner);
        container.appendChild(block);
      });
    }

    // =========================
    // Cálculo
    // =========================
    function getSelectedValue(itemId){
      const el = document.querySelector(`select[data-item-id="${itemId}"]`);
      if (!el) return null;
      const v = el.value;
      if (!v) return null;
      const num = Number(v);
      return Number.isFinite(num) ? num : null;
    }

    function computeItemPoints(item){
      const v = getSelectedValue(item.id);
      if (!v) return 0;
      // (respuesta/5) * peso
      return (v/5) * item.weight;
    }

    function computeTotals(){
      let total = 0;
      SECTIONS.forEach(s => s.items.forEach(it => total += computeItemPoints(it)));
      $("#totalLive").textContent = fmt2(total);
      return total;
    }

    // =========================
    // Reporte
    // =========================
    function buildMetaKV(key, value){
      const div = document.createElement("div");
      div.className = "kv";
      div.innerHTML = `<div class="k">${key}</div><div class="v">${value || "—"}</div>`;
      return div;
    }

    function selectedText(item){
      const v = getSelectedValue(item.id);
      if (!v) return "—";
      return optionLabel(v, item.options[v]);
    }

    function renderReport(){
      // header stamp
      $("#reportStamp").textContent = `Generado: ${nowStamp()}`;

      // meta
      const meta = {
        "No. de personal": $("#noPersonal").value.trim(),
        "Nombre": $("#nombre").value.trim(),
        "Posición": $("#posicion").value.trim(),
        "Departamento": $("#departamento").value.trim(),
        "Periodo": $("#periodo").value.trim(),
        "Versión": $("#version").value.trim(),
        "Fecha": $("#fecha").value ? $("#fecha").value : ""
      };
      const reportMeta = $("#reportMeta");
      reportMeta.innerHTML = "";
      Object.entries(meta).forEach(([k,v]) => reportMeta.appendChild(buildMetaKV(k, v)));

      // rows
      const tbody = $("#reportRows");
      tbody.innerHTML = "";
      SECTIONS.forEach(section => {
        section.items.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${item.name}</b></td>
            <td>${escapeHtml(selectedText(item))}</td>
          `;
          tbody.appendChild(tr);
        });
      });

      // total & comments
      const total = computeTotals();
      $("#reportTotal").textContent = fmt2(total);
      $("#reportComments").textContent = $("#comentarios").value.trim() || "—";
    }

    // escape to prevent injecting HTML via input (simple)
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // Guardar / Cargar
    // =========================
    let dirty = false;
    function markDirty(){
      dirty = true;
      $("#saveState").textContent = "Cambios sin guardar";
      $(".dot").style.background = "var(--danger)";
      $(".dot").style.boxShadow = "0 0 0 3px rgba(255,77,109,.18)";
    }
    function markSaved(){
      dirty = false;
      $("#saveState").textContent = "Guardado";
      $(".dot").style.background = "var(--ok)";
      $(".dot").style.boxShadow = "0 0 0 3px rgba(61,220,151,.18)";
      // vuelve a “Listo” a los segundos (porque sí, dramatismo mínimo)
      setTimeout(() => {
        if (!dirty) $("#saveState").textContent = "Listo";
      }, 1200);
    }

    function collectState(){
      const meta = {
        noPersonal: $("#noPersonal").value,
        nombre: $("#nombre").value,
        posicion: $("#posicion").value,
        departamento: $("#departamento").value,
        periodo: $("#periodo").value,
        version: $("#version").value,
        fecha: $("#fecha").value,
        comentarios: $("#comentarios").value
      };

      const answers = {};
      SECTIONS.forEach(s => s.items.forEach(it => {
        answers[it.id] = getSelectedValue(it.id) ?? "";
      }));

      return { meta, answers, savedAt: Date.now() };
    }

    function applyState(state){
      if (!state) return;
      const m = state.meta || {};
      $("#noPersonal").value = m.noPersonal || "";
      $("#nombre").value = m.nombre || "";
      $("#posicion").value = m.posicion || "";
      $("#departamento").value = m.departamento || "";
      $("#periodo").value = m.periodo || "";
      $("#version").value = m.version || "";
      $("#fecha").value = m.fecha || "";
      $("#comentarios").value = m.comentarios || "";

      const answers = state.answers || {};
      SECTIONS.forEach(s => s.items.forEach(it => {
        const sel = document.querySelector(`select[data-item-id="${it.id}"]`);
        if (sel){
          const v = answers[it.id];
          sel.value = (v === null || v === undefined) ? "" : String(v);
        }
      }));

      computeTotals();
    }

    function save(){
      const state = collectState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      markSaved();
    }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try{
        const state = JSON.parse(raw);
        applyState(state);
      }catch(e){
        console.warn("No se pudo cargar el estado:", e);
      }
    }

    function clearAll(){
      // reset meta
      $("#noPersonal").value = "";
      $("#nombre").value = "";
      $("#posicion").value = "";
      $("#departamento").value = "";
      $("#periodo").value = "";
      $("#version").value = "";
      $("#fecha").value = "";
      $("#comentarios").value = "";

      // reset selects
      document.querySelectorAll("select[data-item-id]").forEach(sel => sel.value = "");

      computeTotals();
      markDirty();
    }

    // =========================
    // Imprimir
    // =========================
    function handlePrint(){
      // prepara reporte y lo muestra solo para impresión
      renderReport();
      $("#reportCard").style.display = "block";
      // imprime (CSS @media print se encarga de mostrar solo reporte)
      window.print();
      // vuelve a ocultar el reporte en pantalla
      $("#reportCard").style.display = "none";
    }

    // =========================
    // Eventos
    // =========================
    function bindMetaListeners(){
      ["#noPersonal","#nombre","#posicion","#departamento","#periodo","#version","#fecha","#comentarios"].forEach(id=>{
        const el = $(id);
        el.addEventListener("input", () => { computeTotals(); markDirty(); });
        el.addEventListener("change", () => { computeTotals(); markDirty(); });
      });
    }

    function init(){
      renderForm();
      bindMetaListeners();
      load();
      computeTotals();

      $("#btnNew").addEventListener("click", () => {
        // sin confirmaciones dramáticas: solo limpiar
        clearAll();
      });
      $("#btnSave").addEventListener("click", save);
      $("#btnPrint").addEventListener("click", handlePrint);
    }

    init();
  </script>
</body>
</html>
