<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root { --bg:#0b1220; --panel:#0f1b33; --muted:#93a4c7; --text:#e8eefc; --stroke:rgba(255,255,255,.12); }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{ margin:0; background: radial-gradient(900px 500px at 20% 0%, rgba(37,99,235,.22), transparent 60%),
                        radial-gradient(700px 420px at 90% 20%, rgba(16,185,129,.18), transparent 60%),
                        var(--bg);
          color:var(--text); }
    .wrap{ padding:14px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px; border:1px solid var(--stroke); border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      margin-bottom:12px;
    }
    .title{ font-weight:700; letter-spacing:.2px; }
    .meta{ font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center; }
    .dot{ width:8px; height:8px; border-radius:50%; background:#22c55e; box-shadow: 0 0 0 4px rgba(34,197,94,.15); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:12px;
      height: calc(100vh - 96px);
    }
    .panel{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px;
      overflow:hidden;
      min-height:0;
    }
    .filters{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    .filters .panel{ padding:10px; }
    .panel h3{ margin:0 0 8px; font-size:13px; color:var(--muted); font-weight:650; }

    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap:12px;
      height:100%;
    }
    .span2{ grid-column: 1 / span 2; }
    .chartBox{ height:100%; }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; }
    .small{ font-size:11px; color:var(--muted); }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; height:auto; }
      .charts{ height:auto; }
      body{ overflow:auto; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Dashboard RH · Headcount</div>
      <div class="meta">
        <span class="dot"></span>
        <span id="updatedAt">Actualizando…</span>
        <span class="small" id="rowCount"></span>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>Filtros (selecciona y todo se recalcula)</h3>
        <div class="filters">
          <div class="panel"><div id="f_genero"></div></div>
          <div class="panel"><div id="f_estado"></div></div>
          <div class="panel"><div id="f_escolaridad"></div></div>
          <div class="panel"><div id="f_depto"></div></div>
          <div class="panel" style="grid-column: 1 / span 2;"><div id="f_pos"></div></div>
        </div>
        <div class="hint">Tip: también puedes hacer clic en una barra/porción para filtrar el resto.</div>
      </div>

      <div class="charts">
        <div class="panel chartBox"><div id="c_genero" style="width:100%;height:100%"></div></div>
        <div class="panel chartBox"><div id="c_estado" style="width:100%;height:100%"></div></div>
        <div class="panel chartBox"><div id="c_escolaridad" style="width:100%;height:100%"></div></div>
        <div class="panel chartBox"><div id="c_depto" style="width:100%;height:100%"></div></div>
        <div class="panel chartBox span2"><div id="c_pos" style="width:100%;height:100%"></div></div>
      </div>
    </div>
  </div>

  <script>
    google.charts.load('current', {'packages':['corechart','controls']});

    let dashboard, dataTable;
    let controls = {};
    let charts = {};

    google.charts.setOnLoadCallback(() => {
      google.script.run
        .withSuccessHandler(payload => {
          document.getElementById('updatedAt').textContent =
            'Actualizado: ' + new Date(payload.updatedAt).toLocaleString();
          document.getElementById('rowCount').textContent =
            payload.rows.length ? `· Registros: ${payload.rows.length}` : '· Sin datos';

          buildDataTable(payload.rows);
          drawDashboard();
        })
        .withFailureHandler(err => {
          document.getElementById('updatedAt').textContent = 'Error: ' + (err?.message || err);
        })
        .getDashboardData();
    });

    function buildDataTable(rows) {
      dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', 'Género');
      dataTable.addColumn('string', 'Estado civil');
      dataTable.addColumn('string', 'Escolaridad');
      dataTable.addColumn('string', 'Departamento');
      dataTable.addColumn('string', 'Posición');

      dataTable.addRows(rows);
    }

    function drawDashboard() {
      dashboard = new google.visualization.Dashboard(document.body);

      // Controls (dropdown)
      controls.genero = new google.visualization.ControlWrapper({
        controlType: 'CategoryFilter',
        containerId: 'f_genero',
        options: {
          filterColumnLabel: 'Género',
          ui: { label: 'Género', allowTyping: false, allowMultiple: false, caption: 'Todos' }
        }
      });

      controls.estado = new google.visualization.ControlWrapper({
        controlType: 'CategoryFilter',
        containerId: 'f_estado',
        options: {
          filterColumnLabel: 'Estado civil',
          ui: { label: 'Estado civil', allowTyping: false, allowMultiple: false, caption: 'Todos' }
        }
      });

      controls.escolaridad = new google.visualization.ControlWrapper({
        controlType: 'CategoryFilter',
        containerId: 'f_escolaridad',
        options: {
          filterColumnLabel: 'Escolaridad',
          ui: { label: 'Escolaridad', allowTyping: false, allowMultiple: false, caption: 'Todos' }
        }
      });

      controls.depto = new google.visualization.ControlWrapper({
        controlType: 'CategoryFilter',
        containerId: 'f_depto',
        options: {
          filterColumnLabel: 'Departamento',
          ui: { label: 'Departamento', allowTyping: false, allowMultiple: false, caption: 'Todos' }
        }
      });

      controls.pos = new google.visualization.ControlWrapper({
        controlType: 'CategoryFilter',
        containerId: 'f_pos',
        options: {
          filterColumnLabel: 'Posición',
          ui: { label: 'Posición', allowTyping: true, allowMultiple: false, caption: 'Todos' }
        }
      });

      // Charts
      charts.genero = new google.visualization.ChartWrapper({
        chartType: 'PieChart',
        containerId: 'c_genero',
        options: baseChartOptions_('Género')
      });

      charts.estado = new google.visualization.ChartWrapper({
        chartType: 'PieChart',
        containerId: 'c_estado',
        options: baseChartOptions_('Estado civil')
      });

      charts.escolaridad = new google.visualization.ChartWrapper({
        chartType: 'PieChart',
        containerId: 'c_escolaridad',
        options: baseChartOptions_('Escolaridad')
      });

      charts.depto = new google.visualization.ChartWrapper({
        chartType: 'BarChart',
        containerId: 'c_depto',
        options: Object.assign(baseChartOptions_('Departamento'), {
          legend: { position: 'none' },
          bars: 'horizontal'
        })
      });

      charts.pos = new google.visualization.ChartWrapper({
        chartType: 'BarChart',
        containerId: 'c_pos',
        options: Object.assign(baseChartOptions_('Posición'), {
          legend: { position: 'none' },
          bars: 'horizontal'
        })
      });

      // Bind: cualquier filtro afecta a todos los gráficos
      const allControls = [controls.genero, controls.estado, controls.escolaridad, controls.depto, controls.pos];
      const allCharts = [charts.genero, charts.estado, charts.escolaridad, charts.depto, charts.pos];

      dashboard.bind(allControls, allCharts);

      // Cada chart usa un view por columna (conteo)
      charts.genero.setView({ columns: [0] });
      charts.estado.setView({ columns: [1] });
      charts.escolaridad.setView({ columns: [2] });
      charts.depto.setView({ columns: [3] });
      charts.pos.setView({ columns: [4] });

      // Redibuja con agregación (conteo) usando DataView + group
      // (Dashboard no agrupa solo; esto lo hacemos con data transform para cada gráfico)
      google.visualization.events.addListener(dashboard, 'ready', attachClickFilters_);

      // Draw
      dashboard.draw(dataTable);

      // Reemplaza datasource de charts por versiones "agrupadas" en cada redraw
      google.visualization.events.addListener(dashboard, 'statechange', redrawGroupedCharts_);
      redrawGroupedCharts_();
    }

    function baseChartOptions_(title) {
      return {
        title,
        backgroundColor: 'transparent',
        chartArea: { left: 10, top: 35, right: 10, bottom: 10, width: '100%', height: '80%' },
        titleTextStyle: { color: '#e8eefc', fontSize: 14, bold: true },
        legend: { textStyle: { color: '#e8eefc', fontSize: 12 } },
        pieSliceTextStyle: { color: '#0b1220', fontSize: 12 },
        hAxis: { textStyle: { color: '#e8eefc' }, gridlines: { color: 'rgba(255,255,255,.10)' } },
        vAxis: { textStyle: { color: '#e8eefc' }, gridlines: { color: 'rgba(255,255,255,.10)' } },
        tooltip: { textStyle: { color: '#0b1220' } }
      };
    }

    function redrawGroupedCharts_() {
      // dataset filtrado por controles (dashboard aplica filters a la DataTable base internamente),
      // pero para agrupar, usamos el estado actual de los controles sobre la tabla completa:
      const filtered = applyControlFiltersToDataTable_(dataTable);

      // crea tablas agrupadas
      charts.genero.setDataTable(groupCount_(filtered, 0, 'Género'));
      charts.estado.setDataTable(groupCount_(filtered, 1, 'Estado civil'));
      charts.escolaridad.setDataTable(groupCount_(filtered, 2, 'Escolaridad'));
      charts.depto.setDataTable(groupCount_(filtered, 3, 'Departamento', true));
      charts.pos.setDataTable(groupCount_(filtered, 4, 'Posición', true));

      charts.genero.draw();
      charts.estado.draw();
      charts.escolaridad.draw();
      charts.depto.draw();
      charts.pos.draw();
    }

    function applyControlFiltersToDataTable_(dt) {
      // Aplica manualmente el estado de los controles (1 selección por control)
      let view = new google.visualization.DataView(dt);
      let rows = [];
      for (let r = 0; r < dt.getNumberOfRows(); r++) rows.push(r);

      const filters = [
        [controls.genero, 0],
        [controls.estado, 1],
        [controls.escolaridad, 2],
        [controls.depto, 3],
        [controls.pos, 4],
      ];

      // filtra filas según cada control
      let current = rows;
      filters.forEach(([ctrl, col]) => {
        const state = ctrl.getState();
        const val = state?.selectedValues?.[0];
        if (!val) return;
        current = current.filter(r => dt.getValue(r, col) === val);
      });

      view.setRows(current);
      return view.toDataTable();
    }

    function groupCount_(dt, colIndex, label, isBar=false) {
      // dt puede ser DataTable filtrada
      const grouped = google.visualization.data.group(
        dt,
        [colIndex],
        [{ column: colIndex, type: 'number', aggregation: google.visualization.data.count }]
      );

      grouped.setColumnLabel(0, label);
      grouped.setColumnLabel(1, 'Total');

      // Ordena desc por total
      const view = new google.visualization.DataView(grouped);
      view.setRows(grouped.getSortedRows({ column: 1, desc: true }));

      // Para barras: limita a top 15 para que no se vuelva una “Biblia en horizontal”
      if (isBar && grouped.getNumberOfRows() > 15) {
        view.setRows(view.getViewRows().slice(0, 15));
      }
      return view.toDataTable();
    }

    function attachClickFilters_() {
      // Al hacer clic en un chart, fijamos el valor en su control correspondiente
      wireChartToControl_(charts.genero, controls.genero);
      wireChartToControl_(charts.estado, controls.estado);
      wireChartToControl_(charts.escolaridad, controls.escolaridad);
      wireChartToControl_(charts.depto, controls.depto);
      wireChartToControl_(charts.pos, controls.pos);
    }

    function wireChartToControl_(chartWrapper, controlWrapper) {
      const chart = chartWrapper.getChart();
      if (!chart) return;

      google.visualization.events.addListener(chart, 'select', () => {
        const sel = chart.getSelection();
        if (!sel || !sel.length) return;

        const dt = chartWrapper.getDataTable();
        const row = sel[0].row;
        if (row == null) return;

        const value = dt.getValue(row, 0);
        controlWrapper.setState({ selectedValues: [value] });
        controlWrapper.draw();

        // Redibuja agrupado
        redrawGroupedCharts_();
      });
    }
  </script>
</body>
</html>

