<script>
  // ====== CONFIG: tu Web App /exec (Apps Script) ======
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxClX3eA4oaBxNfpfP9669HynD_4aouCYMLmAsWOqkVtwFZGGY1IAtRZgYRxXQKTTaC/exec";

  google.charts.load('current', { packages: ['corechart', 'controls'] });

  let dataTable;
  const controls = {};
  const charts = {};

  google.charts.setOnLoadCallback(init_);

  function init_() {
    loadData_()
      .then(payload => {
        document.getElementById('updatedAt').textContent =
          'Actualizado: ' + new Date(payload.updatedAt).toLocaleString();

        document.getElementById('rowCount').textContent =
          payload.rows?.length ? `· Registros: ${payload.rows.length}` : '· Sin datos';

        buildDataTable_(payload.rows || []);
        buildControlsAndCharts_();
        redrawAll_();
      })
      .catch(err => {
        document.getElementById('updatedAt').textContent =
          'Error: ' + (err?.message || err);
      });
  }

  // ---------- DATA LOADER: fetch + fallback JSONP ----------
  function loadData_() {
    return fetch(GAS_WEBAPP_URL, { method: 'GET' })
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .catch(() => jsonpLoad_(GAS_WEBAPP_URL)); // fallback anti-CORS
  }

  function jsonpLoad_(url) {
    return new Promise((resolve, reject) => {
      const cbName = 'cb_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');

      window[cbName] = (data) => {
        cleanup_();
        resolve(data);
      };

      script.onerror = () => {
        cleanup_();
        reject(new Error('No se pudo cargar JSONP desde /exec'));
      };

      function cleanup_() {
        delete window[cbName];
        script.remove();
      }

      const sep = url.includes('?') ? '&' : '?';
      script.src = url + sep + 'callback=' + cbName;
      document.head.appendChild(script);
    });
  }

  // ---------- BUILD DATATABLE ----------
  function buildDataTable_(rows) {
    dataTable = new google.visualization.DataTable();
    dataTable.addColumn('string', 'Género');
    dataTable.addColumn('string', 'Estado civil');
    dataTable.addColumn('string', 'Escolaridad');
    dataTable.addColumn('string', 'Departamento');
    dataTable.addColumn('string', 'Posición');
    dataTable.addRows(rows);
  }

  // ---------- CONTROLS + CHARTS ----------
  function buildControlsAndCharts_() {
    // Controls
    controls.genero = new google.visualization.ControlWrapper({
      controlType: 'CategoryFilter',
      containerId: 'f_genero',
      options: { filterColumnLabel: 'Género', ui: { label: 'Género', allowTyping: false, allowMultiple: false, caption: 'Todos' } }
    });

    controls.estado = new google.visualization.ControlWrapper({
      controlType: 'CategoryFilter',
      containerId: 'f_estado',
      options: { filterColumnLabel: 'Estado civil', ui: { label: 'Estado civil', allowTyping: false, allowMultiple: false, caption: 'Todos' } }
    });

    controls.escolaridad = new google.visualization.ControlWrapper({
      controlType: 'CategoryFilter',
      containerId: 'f_escolaridad',
      options: { filterColumnLabel: 'Escolaridad', ui: { label: 'Escolaridad', allowTyping: false, allowMultiple: false, caption: 'Todos' } }
    });

    controls.depto = new google.visualization.ControlWrapper({
      controlType: 'CategoryFilter',
      containerId: 'f_depto',
      options: { filterColumnLabel: 'Departamento', ui: { label: 'Departamento', allowTyping: false, allowMultiple: false, caption: 'Todos' } }
    });

    controls.pos = new google.visualization.ControlWrapper({
      controlType: 'CategoryFilter',
      containerId: 'f_pos',
      options: { filterColumnLabel: 'Posición', ui: { label: 'Posición', allowTyping: true, allowMultiple: false, caption: 'Todos' } }
    });

    // Draw controls ONCE with the base table
    Object.values(controls).forEach(c => c.draw(dataTable));

    // When any control changes -> redraw
    Object.values(controls).forEach(c => {
      google.visualization.events.addListener(c, 'statechange', redrawAll_);
    });

    // Charts
    charts.genero = new google.visualization.PieChart(document.getElementById('c_genero'));
    charts.estado = new google.visualization.PieChart(document.getElementById('c_estado'));
    charts.escolaridad = new google.visualization.PieChart(document.getElementById('c_escolaridad'));
    charts.depto = new google.visualization.BarChart(document.getElementById('c_depto'));
    charts.pos = new google.visualization.BarChart(document.getElementById('c_pos'));

    // Click-to-filter (chart -> control)
    wireChartToControl_(charts.genero, 0, controls.genero);
    wireChartToControl_(charts.estado, 0, controls.estado);
    wireChartToControl_(charts.escolaridad, 0, controls.escolaridad);
    wireChartToControl_(charts.depto, 0, controls.depto);
    wireChartToControl_(charts.pos, 0, controls.pos);
  }

  function baseChartOptions_(title) {
    return {
      title,
      backgroundColor: 'transparent',
      chartArea: { left: 10, top: 35, right: 10, bottom: 10, width: '100%', height: '80%' },
      titleTextStyle: { color: '#e8eefc', fontSize: 14, bold: true },
      legend: { textStyle: { color: '#e8eefc', fontSize: 12 } },
      pieSliceTextStyle: { color: '#0b1220', fontSize: 12 },
      hAxis: { textStyle: { color: '#e8eefc' }, gridlines: { color: 'rgba(255,255,255,.10)' } },
      vAxis: { textStyle: { color: '#e8eefc' }, gridlines: { color: 'rgba(255,255,255,.10)' } },
      tooltip: { textStyle: { color: '#0b1220' } }
    };
  }

  // ---------- REDRAW ----------
  function redrawAll_() {
    const filtered = applyControlFiltersToDataTable_(dataTable);

    const dtGenero = groupCount_(filtered, 0, 'Género');
    const dtEstado = groupCount_(filtered, 1, 'Estado civil');
    const dtEscol = groupCount_(filtered, 2, 'Escolaridad');
    const dtDepto = groupCount_(filtered, 3, 'Departamento', true);
    const dtPos = groupCount_(filtered, 4, 'Posición', true);

    charts.genero.draw(dtGenero, baseChartOptions_('Género'));
    charts.estado.draw(dtEstado, baseChartOptions_('Estado civil'));
    charts.escolaridad.draw(dtEscol, baseChartOptions_('Escolaridad'));

    charts.depto.draw(
      dtDepto,
      Object.assign(baseChartOptions_('Departamento'), { legend: { position: 'none' }, bars: 'horizontal' })
    );

    charts.pos.draw(
      dtPos,
      Object.assign(baseChartOptions_('Posición'), { legend: { position: 'none' }, bars: 'horizontal' })
    );
  }

  function applyControlFiltersToDataTable_(dt) {
    let rows = [];
    for (let r = 0; r < dt.getNumberOfRows(); r++) rows.push(r);

    const filters = [
      [controls.genero, 0],
      [controls.estado, 1],
      [controls.escolaridad, 2],
      [controls.depto, 3],
      [controls.pos, 4],
    ];

    let current = rows;
    filters.forEach(([ctrl, col]) => {
      const state = ctrl.getState();
      const val = state?.selectedValues?.[0];
      if (!val) return;
      current = current.filter(r => dt.getValue(r, col) === val);
    });

    const view = new google.visualization.DataView(dt);
    view.setRows(current);
    return view.toDataTable();
  }

  function groupCount_(dt, colIndex, label, isBar = false) {
    const grouped = google.visualization.data.group(
      dt,
      [colIndex],
      [{ column: colIndex, type: 'number', aggregation: google.visualization.data.count }]
    );

    grouped.setColumnLabel(0, label);
    grouped.setColumnLabel(1, 'Total');

    const view = new google.visualization.DataView(grouped);
    view.setRows(grouped.getSortedRows({ column: 1, desc: true }));

    if (isBar && grouped.getNumberOfRows() > 15) {
      view.setRows(view.getViewRows().slice(0, 15));
    }
    return view.toDataTable();
  }

  function wireChartToControl_(chart, categoryColIndex, controlWrapper) {
    google.visualization.events.addListener(chart, 'select', () => {
      const sel = chart.getSelection();
      if (!sel || !sel.length) return;

      const row = sel[0].row;
      if (row == null) return;

      // chart.getDataTable() existe en corechart
      const dt = chart.getDataTable();
      const value = dt.getValue(row, categoryColIndex);

      controlWrapper.setState({ selectedValues: [value] });
      controlWrapper.draw();
      redrawAll_();
    });
  }
</script>
