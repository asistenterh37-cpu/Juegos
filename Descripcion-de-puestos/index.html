<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Formulario - Descripción de Puesto</title>
  <meta name="description" content="Formulario de descripción de puesto para usar en GitHub Pages" />
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --card:#0f203f;
      --text:#e8eefc;
      --muted:#9fb0d6;
      --line:rgba(255,255,255,.12);
      --accent:#22c55e;
      --danger:#ef4444;
      --radius:18px;

      /* ✅ NUEVO: azul para Rol 360 */
      --rolBlue:#2563eb;     /* blue-600 */
      --rolBlue2:#1d4ed8;    /* blue-700 */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 15% 10%, #12244a 0%, var(--bg) 55%);
      color:var(--text);
      padding:24px;
    }
    .wrap{ max-width:980px; margin:0 auto; }

    header{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:16px; margin-bottom:18px;
    }
    h1{ font-size:22px; margin:0 0 6px 0; letter-spacing:.2px; }
    .sub{ color:var(--muted); margin:0; font-size:14px; line-height:1.35; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card-inner{ padding:18px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }

    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction:column; }
    }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px; }
    input, textarea{
      width:100%;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:12px;
      color:var(--text);
      padding:10px 12px;
      outline:none;
      transition: border-color .15s ease, transform .05s ease;
    }
    textarea{ min-height:84px; resize:vertical; }
    input:focus, textarea:focus{ border-color: rgba(34,197,94,.55); }
    .span-2{ grid-column: 1 / -1; }
    .section-title{
      margin:16px 0 10px 0;
      font-size:14px;
      letter-spacing:.2px;
      color: var(--text);
    }
    .hr{ height:1px; background: var(--line); margin:14px 0; }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      padding:14px 18px; border-top:1px solid var(--line); background: rgba(0,0,0,.18);
    }
    button{
      border:0; border-radius: 999px; padding:10px 14px; font-weight:600; cursor:pointer;
      color: var(--text); background: rgba(255,255,255,.10); border: 1px solid var(--line);
      transition: transform .06s ease, filter .12s ease;
    }
    button:hover{ filter: brightness(1.1); }
    button:active{ transform: translateY(1px); }
    .primary{ background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.45); }
    .danger{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.40); }

    .note{
      display:flex; gap:10px; align-items:center; color: var(--muted);
      font-size:12px; margin-top:10px; flex-wrap: wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.06);
      font-size:12px; color: var(--muted);
    }
    .status{ font-size:12px; color: var(--muted); margin-right:auto; }
    .error{ color: #ffd1d1; font-size:12px; margin-top:6px; display:none; }
    .error.show{ display:block; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .link{
      color: #b9ccff; text-decoration: none;
      border-bottom: 1px dashed rgba(185,204,255,.45);
    }
    .link:hover{ filter: brightness(1.15); }
    .disabled{ opacity: .65; pointer-events: none; }

    /* ✅ NUEVO: contenedor derecha arriba (fecha + Rol 360) */
    .header-right{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ✅ NUEVO: botón Rol 360 en cuadro azul */
    .rol360{
      position:relative;
      border:1px solid rgba(37,99,235,.55);
      background: linear-gradient(180deg, rgba(37,99,235,.35), rgba(29,78,216,.18));
      color: var(--text);
      border-radius: 12px;
      padding: 6px 10px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .rol360:hover{ filter: brightness(1.08); }
    .rol360:active{ transform: translateY(1px); }

    .rol360 .caret{
      font-size:12px;
      opacity:.9;
      transform: translateY(-1px);
    }

    /* ✅ NUEVO: dropdown */
    .rol360-panel{
      position:absolute;
      right:0;
      top: calc(100% + 8px);
      width: 320px;
      max-width: calc(100vw - 48px);
      background: rgba(10,18,35,.92);
      border:1px solid rgba(37,99,235,.45);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      display:none;
      z-index: 999;
      backdrop-filter: blur(10px);
    }
    .rol360-panel.show{ display:block; }

    .rol360-title{
      font-size:12px;
      color: #cfe0ff;
      margin: 0 0 8px 0;
      font-weight:800;
      letter-spacing:.2px;
    }
    .rol360-list{
      margin:0;
      padding-left: 18px;
      color: var(--text);
      font-size:12px;
      line-height:1.45;
    }
    .rol360-list li{ margin: 4px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Formulario de Descripción de Puesto</h1>
        <p class="sub">Enliste las funciones de su puesto, consignado Qué hace, Cómo lo hace y Para qué lo hace y los reportes por los que es responsable</p>
        <div class="note">
          <span class="pill">Autoguardado: <b id="autosaveState">OFF</b></span>
          <span class="pill">Salida: <span class="mono">JSON</span></span>
          <span class="pill">Destino:
            <a class="link" id="sheetLink" href="#" target="_blank" rel="noreferrer">Google Sheet</a>
          </span>
        </div>
      </div>

      <!-- ✅ MODIFICADO: lado derecho (Rol 360 + Hoy) -->
      <div class="header-right">
        <!-- ✅ NUEVO: Rol 360 -->
        <div class="rol360" id="rol360Btn" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
          Rol 360 <span class="caret">▾</span>

          <div class="rol360-panel" id="rol360Panel" role="dialog" aria-label="Información Rol 360">
            <div class="rol360-title">Esta descripción le procesará:</div>
            <ul class="rol360-list">
              <li>Identificación de la posición</li>
              <li>Objetivos</li>
              <li>Funciones</li>
              <li>Procesos clave</li>
              <li>Perfil</li>
              <li>Tipologia</li>
              <li>Entrevista por competencias</li>
              <li>Plan de inducción</li>
              <li>Plan de capacitación</li>
              <li>KPIs</li>
              <li>Oportunidades de automatización</li>
            </ul>
          </div>
        </div>

        <div class="pill mono" id="now"></div>
      </div>
    </header>

    <div class="card">
      <form id="jobForm" class="card-inner" novalidate>
        <div class="grid">
          <div>
            <label for="titular">Nombre del titular</label>
            <input id="titular" name="titular" type="text" placeholder="Ej. Valentina Pérez" required />
            <div class="error" data-err="titular">Este campo es obligatorio.</div>
          </div>

          <div>
            <label for="puesto">Nombre del puesto</label>
            <input id="puesto" name="puesto" type="text" placeholder="Ej. Analista de Calidad" required />
            <div class="error" data-err="puesto">Este campo es obligatorio.</div>
          </div>

          <!-- ✅ NUEVO: Departamento (después del nombre del puesto) -->
          <div>
            <label for="departamento">Departamento</label>
            <input id="departamento" name="departamento" type="text" placeholder="Ej. Contabilidad" required />
            <div class="error" data-err="departamento">Este campo es obligatorio.</div>
          </div>

          <div>
            <label for="puestoSuperior">Nombre del puesto superior</label>
            <input id="puestoSuperior" name="puestoSuperior" type="text" placeholder="Ej. Jefatura de Operaciones" />
          </div>

          <div>
            <label for="subordinados">Puestos subordinados</label>
            <input id="subordinados" name="subordinados" type="text" placeholder="Ej. Auxiliar 1, Auxiliar 2 (o 'N/A')" />
          </div>

          <div>
            <label for="fecha">Fecha</label>
            <input id="fecha" name="fecha" type="date" required />
            <div class="error" data-err="fecha">Selecciona una fecha válida.</div>
          </div>

          <div>
            <label for="mail">Mail</label>
            <input id="mail" name="mail" type="email" placeholder="ejemplo@correo.com" required />
            <div class="error" data-err="mail">Ingresa un correo válido.</div>
          </div>

          <div class="span-2">
            <div class="hr"></div>
            <div class="section-title">Funciones del puesto (1–20)</div>
            <div id="funcionesWrap" class="grid"></div>
          </div>

          <div class="span-2">
            <div class="hr"></div>
            <div class="section-title">Reportes</div>
            <div class="note" style="margin:0 0 10px 0;">
              <span>Enliste cada uno de los reportes que genera su puesto y la forma como los obtiene.</span>
            </div>
            <div id="reportesWrap" class="grid"></div>
          </div>
        </div>

        <div class="note">
          <span>Tip: si algo no aplica, déjalo vacío. El JSON final solo incluye lo que tenga texto.</span>
        </div>
      </form>

      <div class="actions">
        <div class="status" id="status">Listo.</div>
        <button type="button" class="primary" id="btnSave">Guardar</button>
        <button type="button" class="danger" id="btnClear">Limpiar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1yVZzdYv7BOxOIVI9tGMtGp4a3AvrrXlYggm-CgAZ9bA/edit?usp=sharing";
    const SHEET_ID = "1yVZzdYv7BOxOIVI9tGMtGp4a3AvrrXlYggm-CgAZ9bA";
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw3YHtQAzQ7Z5f6ew4sKEzu9RJUY-9mbdPWXKBvMlI8ieEr4bLPoDFjQL0Rprfj02R-/exec";

    // ====== Helpers ======
    const $ = (sel, el=document) => el.querySelector(sel);
    const pad2 = (n) => String(n).padStart(2, "0");
    const safeTrim = (v) => (v ?? "").toString().trim();

    // ✅ Subo versión para no mezclar borradores anteriores sin "departamento"
    const STORAGE_KEY = "job_description_form_v2";

    // ====== UI init ======
    const now = new Date();
    $("#now").textContent = `Hoy: ${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
    $("#sheetLink").href = SHEET_URL;

    // ✅ NUEVO: Rol 360 toggle (click + teclado + click afuera)
    const rolBtn = $("#rol360Btn");
    const rolPanel = $("#rol360Panel");

    function closeRol360(){
      rolPanel.classList.remove("show");
      rolBtn.setAttribute("aria-expanded", "false");
    }
    function toggleRol360(){
      const willOpen = !rolPanel.classList.contains("show");
      if(willOpen){
        rolPanel.classList.add("show");
        rolBtn.setAttribute("aria-expanded", "true");
      }else{
        closeRol360();
      }
    }

    rolBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleRol360();
    });

    rolBtn.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleRol360();
      }
      if(e.key === "Escape"){
        closeRol360();
      }
    });

    document.addEventListener("click", (e) => {
      // cerrar si se hace click fuera
      if(!rolBtn.contains(e.target)){
        closeRol360();
      }
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeRol360();
    });

    // Build 20 function inputs
    const funcionesWrap = $("#funcionesWrap");
    for(let i=1; i<=20; i++){
      const box = document.createElement("div");
      box.innerHTML = `
        <label for="funcion${i}">Función ${i}</label>
        <textarea id="funcion${i}" name="funcion${i}" placeholder="Describe la función ${i}..."></textarea>
      `;
      funcionesWrap.appendChild(box);
    }

    // Build 10 report inputs
    const reportesWrap = $("#reportesWrap");
    for(let i=1; i<=10; i++){
      const box = document.createElement("div");
      box.innerHTML = `
        <label for="reporte${i}">Reporte ${i}</label>
        <textarea id="reporte${i}" name="reporte${i}" placeholder="Ej. Reporte de ___ / Cómo lo obtengo: ___"></textarea>
      `;
      reportesWrap.appendChild(box);
    }

    // Default date today
    $("#fecha").valueAsDate = new Date();

    // ====== Data model ======
    function collectData(){
      const data = {
        meta: {
          sheetId: SHEET_ID,
          sheetName: "Respuestas",
          timestampISO: new Date().toISOString(),
          createdAtISO: new Date().toISOString(),
          userAgent: navigator.userAgent
        },
        titular: safeTrim($("#titular").value),
        puesto: safeTrim($("#puesto").value),
        // ✅ NUEVO
        departamento: safeTrim($("#departamento").value),

        puestoSuperior: safeTrim($("#puestoSuperior").value),
        subordinados: safeTrim($("#subordinados").value),
        fecha: $("#fecha").value,
        mail: safeTrim($("#mail").value),
        funciones: [],
        reportes: []
      };

      for(let i=1; i<=20; i++){
        const v = safeTrim(document.querySelector(`#funcion${i}`).value);
        if(v) data.funciones.push({ n: i, texto: v });
      }

      for(let i=1; i<=10; i++){
        const v = safeTrim(document.querySelector(`#reporte${i}`).value);
        if(v) data.reportes.push({ n: i, texto: v });
      }

      return data;
    }

    function setData(data){
      $("#titular").value = data?.titular ?? "";
      $("#puesto").value = data?.puesto ?? "";
      // ✅ NUEVO
      $("#departamento").value = data?.departamento ?? "";

      $("#puestoSuperior").value = data?.puestoSuperior ?? "";
      $("#subordinados").value = data?.subordinados ?? "";
      $("#fecha").value = data?.fecha ?? $("#fecha").value;
      $("#mail").value = data?.mail ?? "";

      for(let i=1; i<=20; i++){
        const item = (data?.funciones ?? []).find(f => f.n === i);
        document.querySelector(`#funcion${i}`).value = item?.texto ?? "";
      }
      for(let i=1; i<=10; i++){
        const item = (data?.reportes ?? []).find(r => r.n === i);
        document.querySelector(`#reporte${i}`).value = item?.texto ?? "";
      }
    }

    // ====== Validation ======
    function showError(fieldName, show){
      const el = document.querySelector(`.error[data-err="${fieldName}"]`);
      if(!el) return;
      el.classList.toggle("show", !!show);
    }

    function validate(){
      let ok = true;
      const titular = safeTrim($("#titular").value);
      const puesto = safeTrim($("#puesto").value);
      const departamento = safeTrim($("#departamento").value);
      const fecha = $("#fecha").value;
      const mail = safeTrim($("#mail").value);

      showError("titular", !titular);
      showError("puesto", !puesto);
      // ✅ NUEVO
      showError("departamento", !departamento);

      const dateOk = /^\d{4}-\d{2}-\d{2}$/.test(fecha);
      showError("fecha", !dateOk);

      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mail);
      showError("mail", !emailOk);

      if(!titular || !puesto || !departamento || !dateOk || !emailOk) ok = false;
      return ok;
    }

    // ====== Storage ======
    function saveDraft(){
      const data = collectData();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      $("#status").textContent = "Guardado ✅ (borrador en el navegador).";
    }

    function loadDraft(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      try{
        const data = JSON.parse(raw);
        setData(data);
        $("#status").textContent = "Borrador cargado.";
        return true;
      }catch(e){
        return false;
      }
    }

    function clearDraft(){
      localStorage.removeItem(STORAGE_KEY);
      $("#status").textContent = "Borrador eliminado.";
    }

    function clearForm(){
      $("#jobForm").reset();
      $("#fecha").valueAsDate = new Date();
      for(let i=1; i<=20; i++) document.querySelector(`#funcion${i}`).value = "";
      for(let i=1; i<=10; i++) document.querySelector(`#reporte${i}`).value = "";
      clearDraft();
      $("#status").textContent = "Formulario limpio.";
    }

    // ====== Google Sheet submit (Apps Script Web App) ======
    async function sendToSheet(payload){
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return { ok: true };
    }

    function setSavingUI(isSaving){
      $("#btnSave").classList.toggle("disabled", isSaving);
      $("#btnSave").disabled = isSaving;
      $("#btnClear").disabled = isSaving;
    }

    // ====== Actions ======
    $("#btnSave").addEventListener("click", async () => {
      if(!validate()){
        $("#status").textContent = "Revisa los campos marcados antes de guardar.";
        return;
      }

      const payload = collectData();
      saveDraft();

      try{
        setSavingUI(true);
        $("#status").textContent = "Enviando a Google Sheets…";
        await sendToSheet(payload);
        $("#status").textContent = "Enviado ✅ (registrado en la hoja Respuestas).";
        console.log("Enviado:", payload);
      }catch(err){
        console.error(err);
        $("#status").textContent = `No se pudo enviar a Sheets: ${err.message}`;
      }finally{
        setSavingUI(false);
      }
    });

    $("#btnClear").addEventListener("click", clearForm);

    loadDraft();
  </script>
</body>
</html>
